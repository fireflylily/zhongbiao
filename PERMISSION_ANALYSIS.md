# ğŸ” å½“å‰æƒé™è®¾ç½®åˆ†ææŠ¥å‘Š

## ğŸ“Š æ€»ä½“æƒ…å†µ

**æ£€æŸ¥æ—¶é—´**: 2025-11-17
**æ£€æŸ¥èŒƒå›´**: ç”¨æˆ·è®¤è¯ã€æƒé™æ§åˆ¶ã€æ•°æ®éš”ç¦»

---

## 1ï¸âƒ£ ç”¨æˆ·è®¤è¯ç³»ç»Ÿ

### âœ… å·²å®ç°çš„åŠŸèƒ½

#### è®¤è¯è“å›¾ (`auth_bp.py`)
- âœ… **ç™»å½•åŠŸèƒ½**: `/api/auth/login` (POST)
  - ç”¨æˆ·å/å¯†ç éªŒè¯
  - Sessionç®¡ç†
  - è¿”å›ç”¨æˆ·ä¿¡æ¯å’Œtoken

- âœ… **ç™»å‡ºåŠŸèƒ½**: `/api/auth/logout` (POST)
  - æ¸…é™¤session

- âœ… **TokenéªŒè¯**: `/api/auth/verify-token` (GET)
  - éªŒè¯ç™»å½•çŠ¶æ€
  - è¿”å›ç”¨æˆ·ä¿¡æ¯

#### ç™»å½•è£…é¥°å™¨ (`web/middleware/auth.py`)
```python
@login_required  # ä»…æ£€æŸ¥æ˜¯å¦ç™»å½•,ä¸æ£€æŸ¥æƒé™
```

### âš ï¸ å½“å‰çš„é™åˆ¶

#### ç¡¬ç¼–ç çš„è®¤è¯
```python
# auth_bp.py ç¬¬83è¡Œ
if username == 'admin' and password == 'admin123':
    session['logged_in'] = True
    session['username'] = username  # âš ï¸ åªå­˜ç”¨æˆ·å,ä¸å­˜user_id
```

**é—®é¢˜**:
- âŒ åªæ”¯æŒadminè´¦å·ç¡¬ç¼–ç 
- âŒ ä¸æŸ¥è¯¢æ•°æ®åº“çš„usersè¡¨
- âŒ Sessionä¸­æ²¡æœ‰å­˜å‚¨user_id
- âŒ Sessionä¸­æ²¡æœ‰å­˜å‚¨roleä¿¡æ¯

---

## 2ï¸âƒ£ è§’è‰²æƒé™ç³»ç»Ÿ

### âœ… æ•°æ®åº“å·²å®šä¹‰

#### è§’è‰²è¡¨ (`user_roles`)
| è§’è‰²ID | è§’è‰²åç§° | ä¸Šä¼  | åˆ é™¤ | ä¿®æ”¹éšç§ | ç®¡ç†ç”¨æˆ· | éšç§çº§åˆ« |
|--------|---------|------|------|---------|---------|---------|
| 1 | æ™®é€šç”¨æˆ· | âŒ | âŒ | âŒ | âŒ | 1 |
| 2 | å†…éƒ¨å‘˜å·¥ | âœ… | âŒ | âŒ | âŒ | 2 |
| 3 | é¡¹ç›®ç»ç† | âœ… | âœ… | âœ… | âŒ | 3 |
| 4 | é«˜çº§ç®¡ç† | âœ… | âœ… | âœ… | âœ… | 4 |

#### ç”¨æˆ·è¡¨ (`users`)
| ç”¨æˆ·å | è§’è‰²ID | è§’è‰²åç§° |
|--------|--------|---------|
| admin | 4 | é«˜çº§ç®¡ç† |
| chenyy | 2 | å†…éƒ¨å‘˜å·¥ |
| zhangsan | 2 | å†…éƒ¨å‘˜å·¥ |
| huangjf | 2 | å†…éƒ¨å‘˜å·¥ |
| lvhe | 2 | å†…éƒ¨å‘˜å·¥ |

### âŒ æœªå®ç°çš„åŠŸèƒ½

**APIä¸­å®Œå…¨æœªä½¿ç”¨è§’è‰²æƒé™**:
- âŒ æ²¡æœ‰æƒé™æ£€æŸ¥è£…é¥°å™¨
- âŒ ä¸Šä¼ /åˆ é™¤/ä¿®æ”¹ç­‰æ“ä½œä¸æ£€æŸ¥æƒé™
- âŒ éšç§çº§åˆ«ä¸æ£€æŸ¥ç”¨æˆ·è§’è‰²
- âŒ APIè¿”å›çš„æ•°æ®ä¸æ ¹æ®éšç§çº§åˆ«è¿‡æ»¤

---

## 3ï¸âƒ£ æ•°æ®éš”ç¦»(åˆ›å»ºè€…è¿‡æ»¤)

### âœ… æ•°æ®åº“å­—æ®µå·²å­˜åœ¨

| è¡¨å | created_by | created_by_user_id | è¯´æ˜ |
|------|-----------|-------------------|------|
| companies | âŒ | âŒ | **æ— åˆ›å»ºè€…å­—æ®µ** |
| case_studies | âœ… | âœ… | æœ‰ä¸¤ä¸ªåˆ›å»ºè€…å­—æ®µ |
| resumes | âœ… | âœ… | æœ‰ä¸¤ä¸ªåˆ›å»ºè€…å­—æ®µ |
| tender_projects | âœ… | âœ… | æœ‰ä¸¤ä¸ªåˆ›å»ºè€…å­—æ®µ |

**å­—æ®µç±»å‹**:
- `created_by`: VARCHAR - å­˜ç”¨æˆ·å
- `created_by_user_id`: INTEGER - å­˜ç”¨æˆ·ID

### âŒ APIæœªä½¿ç”¨åˆ›å»ºè€…è¿‡æ»¤

æ£€æŸ¥ç»“æœ:
- âŒ **å…¬å¸åº“API** (`api_companies_bp.py`): æ— ä»»ä½•åˆ›å»ºè€…ç›¸å…³ä»£ç 
- âŒ **æ¡ˆä¾‹åº“API**: æ— åˆ›å»ºè€…è¿‡æ»¤
- âŒ **ç®€å†åº“API**: æ— åˆ›å»ºè€…è¿‡æ»¤
- âŒ **é¡¹ç›®ç®¡ç†API**: æ— åˆ›å»ºè€…è¿‡æ»¤

**æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°æ‰€æœ‰æ•°æ®!**

---

## 4ï¸âƒ£ å…·ä½“é—®é¢˜ç¤ºä¾‹

### é—®é¢˜1: ç™»å½•åSessionä¸å®Œæ•´
```python
# å½“å‰å®ç° (auth_bp.py)
session['logged_in'] = True
session['username'] = username  # âš ï¸ åªæœ‰ç”¨æˆ·å

# åº”è¯¥å­˜å‚¨:
session['logged_in'] = True
session['user_id'] = user.user_id      # âœ… ç”¨æˆ·ID
session['username'] = user.username
session['role_id'] = user.role_id      # âœ… è§’è‰²ID
session['role_name'] = user.role_name  # âœ… è§’è‰²åç§°
```

### é—®é¢˜2: å…¬å¸åˆ—è¡¨APIæ— æƒé™è¿‡æ»¤
```python
# å½“å‰å®ç° (api_companies_bp.py ç¬¬38è¡Œ)
@api_companies_bp.route('/companies')
def list_companies():
    companies = kb_manager.get_companies()  # âš ï¸ è¿”å›æ‰€æœ‰å…¬å¸
    return jsonify({'success': True, 'data': companies})

# åº”è¯¥å®ç°:
@api_companies_bp.route('/companies')
def list_companies():
    user_id = session.get('user_id')
    role_id = session.get('role_id')

    # å¦‚æœæ˜¯æ™®é€šç”¨æˆ·,åªè¿”å›è‡ªå·±åˆ›å»ºçš„
    if role_id in [1, 2]:  # æ™®é€šç”¨æˆ·ã€å†…éƒ¨å‘˜å·¥
        companies = kb_manager.get_companies(created_by_user_id=user_id)
    else:  # é¡¹ç›®ç»ç†ã€é«˜çº§ç®¡ç†
        companies = kb_manager.get_companies()  # è¿”å›æ‰€æœ‰

    return jsonify({'success': True, 'data': companies})
```

### é—®é¢˜3: Companiesè¡¨ç¼ºå°‘åˆ›å»ºè€…å­—æ®µ
```sql
-- å½“å‰è¡¨ç»“æ„
CREATE TABLE companies (
    company_id INTEGER PRIMARY KEY,
    company_name VARCHAR(255) NOT NULL,
    -- ... å…¶ä»–å­—æ®µ
    created_at TIMESTAMP,
    updated_at TIMESTAMP
    -- âŒ æ²¡æœ‰ created_by_user_id
);

-- éœ€è¦æ·»åŠ :
ALTER TABLE companies ADD COLUMN created_by_user_id INTEGER REFERENCES users(user_id);
```

---

## 5ï¸âƒ£ éšç§çº§åˆ«ç³»ç»Ÿ

### âœ… å®šä¹‰äº†4çº§éšç§
1. **çº§åˆ«1 - å…¬å¼€** ğŸŒ: æ‰€æœ‰äººå¯è§
2. **çº§åˆ«2 - å†…éƒ¨** ğŸ¢: å†…éƒ¨å‘˜å·¥åŠä»¥ä¸Š
3. **çº§åˆ«3 - æœºå¯†** ğŸ”’: é¡¹ç›®ç»ç†åŠä»¥ä¸Š
4. **çº§åˆ«4 - ç»å¯†** ğŸš«: ä»…é«˜çº§ç®¡ç†

### âŒ å®Œå…¨æœªå®ç°éšç§çº§åˆ«æ£€æŸ¥

ç¤ºä¾‹:
- æ–‡æ¡£åº“æœ‰ `privacy_classification` å­—æ®µ
- å…¬å¸æœ‰ `security_level` å­—æ®µ
- **ä½†APIå®Œå…¨ä¸æ£€æŸ¥ç”¨æˆ·çš„ `privacy_level_access`**

---

## 6ï¸âƒ£ å‰ç«¯æƒé™æ§åˆ¶

### Vueå‰ç«¯ (`Sidebar.vue`)

#### âœ… å·²å®ç°çš„å‰ç«¯æƒé™
```javascript
// ç¬¬214-217è¡Œ: ABTestèœå•ä»…adminå¯è§
if (userStore.username === 'admin') {
  categories.push({ key: 'abtest', label: 'ABæµ‹è¯•', icon: 'bi-bug' })
}

// ç¬¬236-239è¡Œ: è¿‡æ»¤ABTestèœå•é¡¹
if (item.meta?.category === 'abtest' && userStore.username !== 'admin') {
  return false
}
```

#### âŒ é—®é¢˜
- åªæ£€æŸ¥ `username === 'admin'`,ä¸æ£€æŸ¥role
- å…¶ä»–åŠŸèƒ½æ²¡æœ‰å‰ç«¯æƒé™æ§åˆ¶
- å‰ç«¯æ§åˆ¶å®¹æ˜“è¢«ç»•è¿‡(éœ€è¦åç«¯æƒé™)

---

## 7ï¸âƒ£ æ€»ç»“

### âœ… å·²å®ç°çš„åŠŸèƒ½
1. âœ… ç”¨æˆ·è¡¨å’Œè§’è‰²è¡¨è®¾è®¡å®Œæ•´
2. âœ… åŸºç¡€ç™»å½•/ç™»å‡ºåŠŸèƒ½
3. âœ… Sessionç®¡ç†
4. âœ… éƒ¨åˆ†è¡¨æœ‰åˆ›å»ºè€…å­—æ®µ(æ¡ˆä¾‹ã€ç®€å†ã€é¡¹ç›®)
5. âœ… å‰ç«¯ABTestèœå•æƒé™æ§åˆ¶

### âŒ ç¼ºå¤±çš„æ ¸å¿ƒåŠŸèƒ½
1. âŒ **ç”¨æˆ·è®¤è¯ä¸æŸ¥è¯¢æ•°æ®åº“** - åªæ”¯æŒç¡¬ç¼–ç admin
2. âŒ **Sessionä¸å­˜å‚¨user_idå’Œrole** - æ— æ³•è¿›è¡Œæƒé™åˆ¤æ–­
3. âŒ **æ‰€æœ‰APIæ— æƒé™æ£€æŸ¥** - ä»»ä½•äººéƒ½èƒ½è®¿é—®æ‰€æœ‰æ•°æ®
4. âŒ **æ— æ•°æ®éš”ç¦»** - æ‰€æœ‰ç”¨æˆ·çœ‹åˆ°æ‰€æœ‰æ•°æ®
5. âŒ **éšç§çº§åˆ«æœªç”Ÿæ•ˆ** - å®šä¹‰äº†ä½†ä¸æ£€æŸ¥
6. âŒ **Companiesè¡¨æ— åˆ›å»ºè€…å­—æ®µ** - æ— æ³•å®ç°æ•°æ®éš”ç¦»

---

## 8ï¸âƒ£ ç»“è®º

### å½“å‰çŠ¶æ€: âš ï¸ **æƒé™ç³»ç»Ÿæ¡†æ¶å­˜åœ¨,ä½†æœªå®é™…ç”Ÿæ•ˆ**

**æ•°æ®åº“è®¾è®¡**: â­â­â­â­â­ (5/5)
- è§’è‰²æƒé™è¡¨è®¾è®¡å®Œæ•´
- éƒ¨åˆ†è¡¨æœ‰åˆ›å»ºè€…å­—æ®µ

**åç«¯å®ç°**: â­â˜†â˜†â˜†â˜† (1/5)
- åªæœ‰åŸºç¡€ç™»å½•,æ— æƒé™æ§åˆ¶
- APIå®Œå…¨å¼€æ”¾,æ— è¿‡æ»¤

**å‰ç«¯å®ç°**: â­â­â˜†â˜†â˜† (2/5)
- ä»…ABTestèœå•æœ‰ç®€å•æ§åˆ¶
- å¯è¢«è½»æ˜“ç»•è¿‡

**æ•´ä½“è¯„åˆ†**: â­â­â˜†â˜†â˜† (2/5)

### å…³äº"æ™®é€šç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±åˆ›å»ºçš„æ•°æ®"

**å›ç­”**: âŒ **å½“å‰å®Œå…¨æ²¡æœ‰å®ç°è¿™ä¸ªåŠŸèƒ½**

ç°çŠ¶:
- è™½ç„¶éƒ¨åˆ†è¡¨æœ‰ `created_by_user_id` å­—æ®µ
- ä½†**æ‰€æœ‰APIéƒ½ä¸æ£€æŸ¥è¿™ä¸ªå­—æ®µ**
- **æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°æ‰€æœ‰æ•°æ®**
- æ²¡æœ‰ä»»ä½•æ•°æ®éš”ç¦»æœºåˆ¶

---

## 9ï¸âƒ£ å®ç°å»ºè®®

å¦‚éœ€å®ç°å®Œæ•´çš„æƒé™æ§åˆ¶,å»ºè®®æŒ‰ä»¥ä¸‹é¡ºåº:

### ç¬¬ä¸€é˜¶æ®µ: ä¿®å¤è®¤è¯ç³»ç»Ÿ
1. ä¿®æ”¹ç™»å½•é€»è¾‘,æŸ¥è¯¢usersè¡¨
2. Sessionå­˜å‚¨å®Œæ•´ç”¨æˆ·ä¿¡æ¯(user_id, role_id)
3. å®ç°è·å–å½“å‰ç”¨æˆ·çš„è¾…åŠ©å‡½æ•°

### ç¬¬äºŒé˜¶æ®µ: æ·»åŠ åˆ›å»ºè€…å­—æ®µ
1. Companiesè¡¨æ·»åŠ  `created_by_user_id`
2. åˆ›å»ºæ•°æ®è¿ç§»è„šæœ¬
3. ä¿®æ”¹åˆ›å»ºAPI,è®°å½•åˆ›å»ºè€…

### ç¬¬ä¸‰é˜¶æ®µ: APIæƒé™æ§åˆ¶
1. åˆ›å»ºæƒé™æ£€æŸ¥è£…é¥°å™¨
2. åº”ç”¨åˆ°æ‰€æœ‰API
3. å®ç°æ•°æ®è¿‡æ»¤é€»è¾‘

### ç¬¬å››é˜¶æ®µ: éšç§çº§åˆ«å®ç°
1. APIæ£€æŸ¥ç”¨æˆ·çš„ `privacy_level_access`
2. è¿‡æ»¤é«˜çº§åˆ«æ•°æ®
3. æ“ä½œæƒé™æ£€æŸ¥

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-17
**æ£€æŸ¥å·¥å…·**: Claude Code
**æ•°æ®åº“**: SQLite (knowledge_base.db)
