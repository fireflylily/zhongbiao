<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompanySelector ä¸ GlobalState é›†æˆæµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .state-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .search-loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">CompanySelector ä¸ GlobalState é›†æˆæµ‹è¯•</h1>

        <!-- æµ‹è¯•1: é»˜è®¤å¯ç”¨åŒæ­¥ -->
        <div class="test-section">
            <h3>æµ‹è¯• 1: é»˜è®¤å¯ç”¨è‡ªåŠ¨åŒæ­¥ (syncGlobalState: true)</h3>
            <div id="selector1" data-company-selector></div>
            <div class="mt-3">
                <button class="btn btn-warning btn-sm" onclick="clearSelector1()">æ¸…ç©ºé€‰æ‹©</button>
            </div>
        </div>

        <!-- æµ‹è¯•2: ç¦ç”¨åŒæ­¥ -->
        <div class="test-section">
            <h3>æµ‹è¯• 2: ç¦ç”¨è‡ªåŠ¨åŒæ­¥ (syncGlobalState: false)</h3>
            <div id="selector2"></div>
            <div class="mt-3">
                <button class="btn btn-warning btn-sm" onclick="clearSelector2()">æ¸…ç©ºé€‰æ‹©</button>
            </div>
        </div>

        <!-- å…¨å±€çŠ¶æ€æ˜¾ç¤º -->
        <div class="test-section">
            <h3>å…¨å±€çŠ¶æ€ç›‘æ§</h3>
            <div class="state-display" id="stateDisplay">
ç­‰å¾…çŠ¶æ€æ›´æ–°...
            </div>
            <div class="mt-3">
                <button class="btn btn-info btn-sm" onclick="window.globalState.debug()">
                    <i class="bi bi-bug"></i> è°ƒè¯•å…¨å±€çŠ¶æ€
                </button>
                <button class="btn btn-danger btn-sm" onclick="window.globalState.clearAll()">
                    <i class="bi bi-trash"></i> æ¸…ç©ºå…¨å±€çŠ¶æ€
                </button>
            </div>
        </div>

        <!-- æ§åˆ¶å°æ—¥å¿— -->
        <div class="test-section">
            <h3>æ§åˆ¶å°æ—¥å¿—</h3>
            <div class="state-display" id="consoleLog">
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- åŠ è½½å…¨å±€çŠ¶æ€ç®¡ç†å™¨ -->
    <script src="ai_tender_system/web/static/js/core/global-state-manager.js"></script>

    <!-- åŠ è½½æ¨¡æ€æ¡†ç®¡ç†å™¨ -->
    <script src="ai_tender_system/web/static/js/components/modal-manager.js"></script>

    <!-- åŠ è½½å…¬å¸é€‰æ‹©å™¨ -->
    <script src="ai_tender_system/web/static/js/components/company-selector.js"></script>

    <script>
        // æ¨¡æ‹ŸAPIå®¢æˆ·ç«¯
        window.apiClient = {
            company: {
                async getCompanies() {
                    // æ¨¡æ‹Ÿå»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return {
                        companies: [
                            {
                                id: 1,
                                name: 'æµ‹è¯•å…¬å¸A',
                                unified_social_credit_code: '91110000XXXXXXXXXX',
                                contact_person: 'å¼ ä¸‰',
                                contact_phone: '13800138000',
                                address: 'åŒ—äº¬å¸‚æœé˜³åŒºæµ‹è¯•è·¯123å·'
                            },
                            {
                                id: 2,
                                name: 'æµ‹è¯•å…¬å¸B',
                                unified_social_credit_code: '91110000YYYYYYYYYY',
                                contact_person: 'æå››',
                                contact_phone: '13900139000',
                                address: 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºæµ‹è¯•è¡—456å·'
                            },
                            {
                                id: 3,
                                name: 'æµ‹è¯•å…¬å¸C',
                                unified_social_credit_code: '91110000ZZZZZZZZZZ',
                                contact_person: 'ç‹äº”',
                                contact_phone: '13700137000',
                                address: 'æ·±åœ³å¸‚å—å±±åŒºæµ‹è¯•å¤§é“789å·'
                            }
                        ]
                    };
                },
                async createCompany(data) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    return {
                        company: {
                            id: Date.now(),
                            ...data
                        }
                    };
                }
            }
        };

        // æ¨¡æ‹Ÿé€šçŸ¥ç³»ç»Ÿ
        window.notifications = {
            success(message) {
                console.log('âœ… æˆåŠŸ:', message);
                alert('âœ… ' + message);
            },
            error(message) {
                console.error('âŒ é”™è¯¯:', message);
                alert('âŒ ' + message);
            }
        };

        // åˆå§‹åŒ–é€‰æ‹©å™¨
        let selector1, selector2;

        // æµ‹è¯•1: å¯ç”¨åŒæ­¥ï¼ˆé»˜è®¤ï¼‰
        const element1 = document.getElementById('selector1');
        selector1 = new CompanySelectorComponent(element1, {
            syncGlobalState: true  // æ˜¾å¼å¯ç”¨ï¼ˆé»˜è®¤ä¹Ÿæ˜¯trueï¼‰
        });

        // æµ‹è¯•2: ç¦ç”¨åŒæ­¥
        const element2 = document.getElementById('selector2');
        selector2 = new CompanySelectorComponent(element2, {
            syncGlobalState: false  // ç¦ç”¨åŒæ­¥
        });

        // ç›‘å¬å…¨å±€çŠ¶æ€å˜åŒ–
        window.globalState.subscribe('company', (data) => {
            updateStateDisplay();
            console.log('ğŸ”” å…¨å±€çŠ¶æ€å˜åŒ– - å…¬å¸:', data);
        });

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStateDisplay() {
            const state = window.globalState.getSnapshot();
            const display = document.getElementById('stateDisplay');
            display.textContent = JSON.stringify(state, null, 2);
        }

        // æ¸…ç©ºé€‰æ‹©å™¨1
        function clearSelector1() {
            selector1.clear();
        }

        // æ¸…ç©ºé€‰æ‹©å™¨2
        function clearSelector2() {
            selector2.clear();
        }

        // åˆå§‹åŒ–æ˜¾ç¤º
        updateStateDisplay();

        // æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬
        element1.addEventListener('companySelected', (e) => {
            console.log('ğŸ“¢ é€‰æ‹©å™¨1è§¦å‘äº‹ä»¶:', e.detail.company.name);
        });

        element2.addEventListener('companySelected', (e) => {
            console.log('ğŸ“¢ é€‰æ‹©å™¨2è§¦å‘äº‹ä»¶:', e.detail.company.name);
        });

        // æ§åˆ¶å°æ‹¦æˆªï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
        const consoleLogDiv = document.getElementById('consoleLog');
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            consoleLogDiv.textContent = message + '\n' + consoleLogDiv.textContent;
        };
    </script>
</body>
</html>
