<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CompanySelector 与 GlobalState 集成测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
        }
        .state-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .search-loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">CompanySelector 与 GlobalState 集成测试</h1>

        <!-- 测试1: 默认启用同步 -->
        <div class="test-section">
            <h3>测试 1: 默认启用自动同步 (syncGlobalState: true)</h3>
            <div id="selector1" data-company-selector></div>
            <div class="mt-3">
                <button class="btn btn-warning btn-sm" onclick="clearSelector1()">清空选择</button>
            </div>
        </div>

        <!-- 测试2: 禁用同步 -->
        <div class="test-section">
            <h3>测试 2: 禁用自动同步 (syncGlobalState: false)</h3>
            <div id="selector2"></div>
            <div class="mt-3">
                <button class="btn btn-warning btn-sm" onclick="clearSelector2()">清空选择</button>
            </div>
        </div>

        <!-- 全局状态显示 -->
        <div class="test-section">
            <h3>全局状态监控</h3>
            <div class="state-display" id="stateDisplay">
等待状态更新...
            </div>
            <div class="mt-3">
                <button class="btn btn-info btn-sm" onclick="window.globalState.debug()">
                    <i class="bi bi-bug"></i> 调试全局状态
                </button>
                <button class="btn btn-danger btn-sm" onclick="window.globalState.clearAll()">
                    <i class="bi bi-trash"></i> 清空全局状态
                </button>
            </div>
        </div>

        <!-- 控制台日志 -->
        <div class="test-section">
            <h3>控制台日志</h3>
            <div class="state-display" id="consoleLog">
打开浏览器控制台查看详细日志
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 加载全局状态管理器 -->
    <script src="ai_tender_system/web/static/js/core/global-state-manager.js"></script>

    <!-- 加载模态框管理器 -->
    <script src="ai_tender_system/web/static/js/components/modal-manager.js"></script>

    <!-- 加载公司选择器 -->
    <script src="ai_tender_system/web/static/js/components/company-selector.js"></script>

    <script>
        // 模拟API客户端
        window.apiClient = {
            company: {
                async getCompanies() {
                    // 模拟延迟
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return {
                        companies: [
                            {
                                id: 1,
                                name: '测试公司A',
                                unified_social_credit_code: '91110000XXXXXXXXXX',
                                contact_person: '张三',
                                contact_phone: '13800138000',
                                address: '北京市朝阳区测试路123号'
                            },
                            {
                                id: 2,
                                name: '测试公司B',
                                unified_social_credit_code: '91110000YYYYYYYYYY',
                                contact_person: '李四',
                                contact_phone: '13900139000',
                                address: '上海市浦东新区测试街456号'
                            },
                            {
                                id: 3,
                                name: '测试公司C',
                                unified_social_credit_code: '91110000ZZZZZZZZZZ',
                                contact_person: '王五',
                                contact_phone: '13700137000',
                                address: '深圳市南山区测试大道789号'
                            }
                        ]
                    };
                },
                async createCompany(data) {
                    await new Promise(resolve => setTimeout(resolve, 300));
                    return {
                        company: {
                            id: Date.now(),
                            ...data
                        }
                    };
                }
            }
        };

        // 模拟通知系统
        window.notifications = {
            success(message) {
                console.log('✅ 成功:', message);
                alert('✅ ' + message);
            },
            error(message) {
                console.error('❌ 错误:', message);
                alert('❌ ' + message);
            }
        };

        // 初始化选择器
        let selector1, selector2;

        // 测试1: 启用同步（默认）
        const element1 = document.getElementById('selector1');
        selector1 = new CompanySelectorComponent(element1, {
            syncGlobalState: true  // 显式启用（默认也是true）
        });

        // 测试2: 禁用同步
        const element2 = document.getElementById('selector2');
        selector2 = new CompanySelectorComponent(element2, {
            syncGlobalState: false  // 禁用同步
        });

        // 监听全局状态变化
        window.globalState.subscribe('company', (data) => {
            updateStateDisplay();
            console.log('🔔 全局状态变化 - 公司:', data);
        });

        // 更新状态显示
        function updateStateDisplay() {
            const state = window.globalState.getSnapshot();
            const display = document.getElementById('stateDisplay');
            display.textContent = JSON.stringify(state, null, 2);
        }

        // 清空选择器1
        function clearSelector1() {
            selector1.clear();
        }

        // 清空选择器2
        function clearSelector2() {
            selector2.clear();
        }

        // 初始化显示
        updateStateDisplay();

        // 添加自定义事件监听
        element1.addEventListener('companySelected', (e) => {
            console.log('📢 选择器1触发事件:', e.detail.company.name);
        });

        element2.addEventListener('companySelected', (e) => {
            console.log('📢 选择器2触发事件:', e.detail.company.name);
        });

        // 控制台拦截（用于显示）
        const consoleLogDiv = document.getElementById('consoleLog');
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            consoleLogDiv.textContent = message + '\n' + consoleLogDiv.textContent;
        };
    </script>
</body>
</html>
