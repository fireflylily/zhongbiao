# 商务应答处理器 - 括号后缀保留流程

## 完整处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      1. 文档输入                                 │
│                                                                 │
│  原始Word文档:                                                   │
│  "供应商名称（加盖公章）：______"                                 │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│              2. SmartDocumentFiller.fill_document()             │
│                                                                 │
│  - 标准化数据键名                                                │
│  - 初始化统计信息                                                │
│  - 遍历所有段落                                                  │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│              3. _process_paragraph() - 处理段落                  │
│                                                                 │
│  当前段落: "供应商名称（加盖公章）：______"                        │
│                                                                 │
│  按优先级尝试匹配模式:                                            │
│  ✗ combo (组合字段)                                              │
│  ✗ bracket (括号占位符)                                          │
│  ✗ date (日期格式)                                               │
│  ✓ colon (冒号填空) ← 匹配成功！                                  │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│        4. PatternMatcher._match_colon_pattern() - 模式匹配       │
│                                                                 │
│  正则匹配: r'([^：:\n]{2,20})[:：]\s*([_\s]{3,}|$)'              │
│                                                                 │
│  提取结果:                                                       │
│  ┌────────────────────────────────────────────┐                │
│  │ original_field_name = "供应商名称（加盖公章）" │ ← 保存原始名  │
│  └────────────────────────────────────────────┘                │
│  ┌────────────────────────────────────────────┐                │
│  │ clean_field_name = "供应商名称"             │ ← 清理后的名    │
│  └────────────────────────────────────────────┘                │
│                                                                 │
│  返回匹配字典:                                                   │
│  {                                                              │
│    'full_match': '供应商名称（加盖公章）：______',                │
│    'field': '供应商名称',           ← 用于数据匹配               │
│    'original_field': '供应商名称（加盖公章）',  ← 用于文本替换    │
│    'start': 0,                                                  │
│    'end': 18                                                    │
│  }                                                              │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│          5. ContentFiller.fill_colon_field() - 填充内容          │
│                                                                 │
│  Step 1: 提取字段名                                              │
│  ┌──────────────────────────────────────────┐                  │
│  │ field_name = '供应商名称'     ← 清理后     │                  │
│  │ original_field_name = '供应商名称（加盖公章）' ← 原始         │
│  └──────────────────────────────────────────┘                  │
│                                                                 │
│  Step 2: 识别标准字段名                                          │
│  ┌──────────────────────────────────────────┐                  │
│  │ FieldRecognizer.recognize_field()        │                  │
│  │ Input:  '供应商名称'                      │                  │
│  │ Output: 'companyName'                    │                  │
│  └──────────────────────────────────────────┘                  │
│                                                                 │
│  Step 3: 获取数据值                                              │
│  ┌──────────────────────────────────────────┐                  │
│  │ data['companyName'] = '某某科技有限公司'  │                  │
│  └──────────────────────────────────────────┘                  │
│                                                                 │
│  Step 4: 构建替换文本（关键！使用原始字段名）                      │
│  ┌──────────────────────────────────────────┐                  │
│  │ replacement =                            │                  │
│  │   original_field_name + colon + value    │                  │
│  │ = "供应商名称（加盖公章）：某某科技有限公司" │                  │
│  └──────────────────────────────────────────┘                  │
│                                                                 │
│  Step 5: 使用run精确替换（保留格式）                              │
│  WordDocumentUtils.apply_replacement_to_runs()                 │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      6. 输出结果                                 │
│                                                                 │
│  最终Word文档:                                                   │
│  "供应商名称（加盖公章）：某某科技有限公司"                        │
│                                                                 │
│  日志输出:                                                       │
│  "✅ 冒号字段填充: 供应商名称（加盖公章） → 某某科技有限公司"       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 关键设计点

### 1️⃣ **双字段名策略**

```python
# 在 _match_colon_pattern() 中
original_field_name = "供应商名称（加盖公章）"  # 保留括号 → 用于替换
clean_field_name = "供应商名称"              # 删除括号 → 用于匹配数据

matches.append({
    'field': clean_field_name,           # 数据查找用
    'original_field': original_field_name  # 文本替换用
})
```

### 2️⃣ **分离匹配与替换**

| 阶段 | 使用字段名 | 目的 |
|------|-----------|------|
| **字段识别** | `clean_field_name` = `"供应商名称"` | 在 `field_variants` 中查找匹配 |
| **数据获取** | `std_field` = `"companyName"` | 在 `data` 字典中获取值 |
| **文本替换** | `original_field_name` = `"供应商名称（加盖公章）"` | 保持原文档格式 |

### 3️⃣ **向后兼容**

```python
# 兼容旧代码（没有 original_field 的情况）
original_field_name = match.get('original_field', field_name)
```

---

## 对比：修改前 vs 修改后

### ❌ 修改前（错误）

```
输入:  "供应商名称（加盖公章）：______"
                ↓
识别:  field_name = "供应商名称"  （括号被删除）
                ↓
替换:  "供应商名称：某某科技有限公司"  （括号丢失！）
```

### ✅ 修改后（正确）

```
输入:  "供应商名称（加盖公章）：______"
                ↓
识别:  clean_field = "供应商名称"        （用于数据匹配）
      original_field = "供应商名称（加盖公章）"  （用于文本替换）
                ↓
替换:  "供应商名称（加盖公章）：某某科技有限公司"  （括号保留！）
```

---

## 代码对照

### 模式匹配阶段

```python
# smart_filler.py: 第369-385行
for match in re.finditer(pattern, text):
    original_field_name = match.group(1).strip()  # "供应商名称（加盖公章）"

    # 清理括号用于数据匹配
    clean_field_name = re.sub(r'[（(][^）)]*[）)]', '', original_field_name).strip()  # "供应商名称"

    matches.append({
        'field': clean_field_name,           # ← 数据匹配用
        'original_field': original_field_name  # ← 文本替换用（新增）
    })
```

### 填充阶段

```python
# smart_filler.py: 第584-611行
for match in reversed(matches):
    field_name = match['field']  # "供应商名称"
    original_field_name = match.get('original_field', field_name)  # "供应商名称（加盖公章）"

    std_field = self.field_recognizer.recognize_field(field_name)  # "companyName"

    if std_field in data:
        value = data[std_field]  # "某某科技有限公司"

        # ✨ 关键：使用原始字段名（包含括号）
        replacement = f"{original_field_name}{colon}{value}"
        # → "供应商名称（加盖公章）：某某科技有限公司"
```

---

## 支持的括号后缀类型

| 后缀类型 | 示例 | 处理结果 |
|---------|------|---------|
| **盖章类** | `供应商名称（加盖公章）` | ✅ 完整保留 |
| **盖章类** | `供应商名称（盖章）` | ✅ 完整保留 |
| **签字类** | `法人代表（签字）` | ✅ 完整保留 |
| **签名类** | `法人代表（签名）` | ✅ 完整保留 |
| **无括号** | `供应商名称` | ✅ 正常填充 |

---

## 测试验证

```bash
# 测试结果（所有测试通过）
✓ 保留括号1: 供应商名称（加盖公章）：测试科技有限公司
✓ 无括号:   供应商名称：测试科技有限公司
✓ 保留括号2: 公司名称（盖章）：测试科技有限公司

🎉 所有测试通过！括号后缀保留功能正常工作。
```
