<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç« èŠ‚è§£æå™¨A/Bæµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .parser-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        .parser-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .parser-card.selected {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .metric-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.875rem;
            margin: 4px;
        }
        .winner-badge {
            background-color: #198754;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .chapter-tree {
            border-left: 2px solid #e0e0e0;
            padding-left: 20px;
            margin-top: 10px;
        }
        .chapter-item {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .chapter-item.level-1 { background: #e7f3ff; }
        .chapter-item.level-2 { background: #f0f8ff; margin-left: 20px; }
        .chapter-item.level-3 { background: #f8f8f8; margin-left: 40px; }
        .auto-selected { border-left: 3px solid #28a745; }
        .skip-recommended { border-left: 3px solid #dc3545; }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h2><i class="bi bi-lightning-charge"></i> ç« èŠ‚è§£æå™¨A/Bæµ‹è¯•å¹³å°</h2>
                <p class="text-muted">ä¸Šä¼ æ‹›æ ‡æ–‡æ¡£,å¯¹æ¯”ä¸åŒè§£æå™¨çš„æ•ˆæœ</p>
            </div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title"><i class="bi bi-cloud-upload"></i> ä¸Šä¼ æ–‡æ¡£</h5>
                        <input type="file" class="form-control" id="fileInput" accept=".docx,.doc">
                        <small class="text-muted">æ”¯æŒ.docxå’Œ.docæ ¼å¼</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- è§£æå™¨é€‰æ‹©åŒº -->
        <div class="row mt-4">
            <div class="col-12">
                <h5><i class="bi bi-gear"></i> é€‰æ‹©è¦æµ‹è¯•çš„è§£æå™¨</h5>
            </div>
            <div id="parserCards" class="row mt-2">
                <!-- åŠ¨æ€åŠ è½½è§£æå™¨å¡ç‰‡ -->
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="row mt-4">
            <div class="col-12">
                <button class="btn btn-primary btn-lg me-2" id="compareBtn">
                    <i class="bi bi-play-circle"></i> å¼€å§‹å¯¹æ¯”æµ‹è¯•
                </button>
                <button class="btn btn-secondary btn-lg" id="clearBtn">
                    <i class="bi bi-x-circle"></i> æ¸…ç©ºç»“æœ
                </button>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒº -->
        <div id="resultsContainer" class="row mt-4" style="display: none;">
            <!-- å¯¹æ¯”æ±‡æ€» -->
            <div class="col-12 mb-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-trophy"></i> å¯¹æ¯”ç»“æœæ±‡æ€»</h5>
                    </div>
                    <div class="card-body">
                        <div id="comparisonSummary"></div>
                    </div>
                </div>
            </div>

            <!-- è¯¦ç»†ç»“æœ -->
            <div id="detailResults" class="row">
                <!-- åŠ¨æ€åŠ è½½å„è§£æå™¨ç»“æœ -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let availableParsers = [];
        let selectedParsers = [];

        // é¡µé¢åŠ è½½æ—¶è·å–å¯ç”¨è§£æå™¨
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAvailableParsers();
        });

        // åŠ è½½å¯ç”¨è§£æå™¨
        async function loadAvailableParsers() {
            try {
                const response = await fetch('/abtest/api/parsers');
                const data = await response.json();

                if (data.success) {
                    availableParsers = data.parsers;
                    renderParserCards();
                } else {
                    alert('åŠ è½½è§£æå™¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åŠ è½½è§£æå™¨å¤±è´¥:', error);
                alert('åŠ è½½è§£æå™¨å¤±è´¥: ' + error.message);
            }
        }

        // æ¸²æŸ“è§£æå™¨å¡ç‰‡
        function renderParserCards() {
            const container = document.getElementById('parserCards');
            container.innerHTML = '';

            availableParsers.forEach(parser => {
                const card = document.createElement('div');
                card.className = 'col-md-6 mb-3';
                card.innerHTML = `
                    <div class="parser-card ${parser.available ? '' : 'opacity-50'}"
                         data-parser="${parser.name}"
                         onclick="toggleParser('${parser.name}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6>
                                <input type="checkbox"
                                       id="parser_${parser.name}"
                                       ${parser.available ? '' : 'disabled'}>
                                ${parser.display_name}
                            </h6>
                            ${parser.available ? '<span class="badge bg-success">å¯ç”¨</span>' : '<span class="badge bg-secondary">ä¸å¯ç”¨</span>'}
                        </div>
                        <p class="text-muted small mt-2">${parser.description.replace(/\n/g, '<br>')}</p>
                        <div class="mt-2">
                            ${parser.requires_api ? '<span class="metric-badge bg-warning text-dark">éœ€è¦API</span>' : '<span class="metric-badge bg-success text-white">å…è´¹</span>'}
                            ${parser.cost_per_page > 0 ? `<span class="metric-badge bg-info text-white">çº¦${parser.cost_per_page}å…ƒ/é¡µ</span>` : ''}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // åˆ‡æ¢è§£æå™¨é€‰æ‹©
        function toggleParser(parserName) {
            const checkbox = document.getElementById(`parser_${parserName}`);
            if (checkbox.disabled) return;

            checkbox.checked = !checkbox.checked;

            const card = document.querySelector(`[data-parser="${parserName}"]`);
            card.classList.toggle('selected');

            if (checkbox.checked) {
                selectedParsers.push(parserName);
            } else {
                selectedParsers = selectedParsers.filter(p => p !== parserName);
            }
        }

        // å¼€å§‹å¯¹æ¯”æµ‹è¯•
        document.getElementById('compareBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('fileInput');

            if (!fileInput.files[0]) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡æ¡£');
                return;
            }

            if (selectedParsers.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè§£æå™¨');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('parsers', selectedParsers.join(','));

            const btn = document.getElementById('compareBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>è§£æä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch('/abtest/api/parse-compare', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    displayResults(data.results, data.comparison);
                } else {
                    alert('è§£æå¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('è§£æå¤±è´¥:', error);
                alert('è§£æå¤±è´¥: ' + error.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results, comparison) {
            document.getElementById('resultsContainer').style.display = 'block';

            // æ˜¾ç¤ºæ±‡æ€»
            const summaryHtml = `
                <div class="row">
                    <div class="col-md-3">
                        <h6><i class="bi bi-speedometer2"></i> æœ€å¿«</h6>
                        <p class="h4">${comparison.fastest || 'æ— '}</p>
                    </div>
                    <div class="col-md-3">
                        <h6><i class="bi bi-list-check"></i> ç« èŠ‚æœ€å¤š</h6>
                        <p class="h4">${comparison.most_chapters || 'æ— '}</p>
                    </div>
                    <div class="col-md-3">
                        <h6><i class="bi bi-shield-check"></i> ç½®ä¿¡åº¦æœ€é«˜</h6>
                        <p class="h4">${comparison.highest_confidence || 'æ— '}</p>
                    </div>
                    <div class="col-md-3">
                        <h6><i class="bi bi-piggy-bank"></i> æˆæœ¬æœ€ä½</h6>
                        <p class="h4">${comparison.lowest_cost || 'æ— '}</p>
                    </div>
                </div>
            `;
            document.getElementById('comparisonSummary').innerHTML = summaryHtml;

            // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
            const detailContainer = document.getElementById('detailResults');
            detailContainer.innerHTML = '';

            for (const [parserName, result] of Object.entries(results)) {
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-4';
                col.innerHTML = renderParserResult(parserName, result, comparison);
                detailContainer.appendChild(col);
            }

            // æ»šåŠ¨åˆ°ç»“æœåŒº
            document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // æ¸²æŸ“å•ä¸ªè§£æå™¨ç»“æœ
        function renderParserResult(parserName, result, comparison) {
            const parser = availableParsers.find(p => p.name === parserName);
            const displayName = parser ? parser.display_name : parserName;

            if (!result.success) {
                return `
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5>${displayName} <span class="badge bg-light text-danger">å¤±è´¥</span></h5>
                        </div>
                        <div class="card-body">
                            <p class="text-danger">${result.error}</p>
                        </div>
                    </div>
                `;
            }

            const metrics = result.metrics || {};
            const isWinner = (type) => comparison[type] === parserName;

            return `
                <div class="card">
                    <div class="card-header">
                        <h5>
                            ${displayName}
                            ${isWinner('fastest') ? '<span class="winner-badge">âš¡æœ€å¿«</span>' : ''}
                            ${isWinner('most_chapters') ? '<span class="winner-badge">ğŸ“‹æœ€å¤š</span>' : ''}
                            ${isWinner('highest_confidence') ? '<span class="winner-badge">âœ“æœ€å‡†</span>' : ''}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <small class="text-muted">è€—æ—¶</small>
                                <div class="h6">${metrics.parse_time?.toFixed(2) || 'N/A'}ç§’</div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">ç« èŠ‚æ•°</small>
                                <div class="h6">${metrics.chapters_found || 0}ä¸ª</div>
                            </div>
                            <div class="col-6 mt-2">
                                <small class="text-muted">ç½®ä¿¡åº¦</small>
                                <div class="h6">${metrics.confidence_score?.toFixed(1) || 0}åˆ†</div>
                            </div>
                            <div class="col-6 mt-2">
                                <small class="text-muted">æˆæœ¬</small>
                                <div class="h6">${metrics.api_cost > 0 ? `Â¥${metrics.api_cost?.toFixed(4)}` : 'å…è´¹'}</div>
                            </div>
                        </div>

                        <hr>

                        <h6>ç« èŠ‚ç»“æ„</h6>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${renderChapterTree(result.chapters || [])}
                        </div>
                    </div>
                </div>
            `;
        }

        // æ¸²æŸ“ç« èŠ‚æ ‘
        function renderChapterTree(chapters) {
            if (!chapters || chapters.length === 0) {
                return '<p class="text-muted">æœªè¯†åˆ«åˆ°ç« èŠ‚</p>';
            }

            let html = '<div class="chapter-tree">';
            chapters.forEach(chapter => {
                html += renderChapter(chapter);
            });
            html += '</div>';
            return html;
        }

        function renderChapter(chapter) {
            const classes = [
                'chapter-item',
                `level-${chapter.level || 1}`,
                chapter.auto_selected ? 'auto-selected' : '',
                chapter.skip_recommended ? 'skip-recommended' : ''
            ].join(' ');

            let html = `
                <div class="${classes}">
                    <strong>${chapter.title}</strong>
                    ${chapter.auto_selected ? '<span class="badge bg-success ms-2">æ¨è</span>' : ''}
                    ${chapter.skip_recommended ? '<span class="badge bg-danger ms-2">è·³è¿‡</span>' : ''}
            `;

            if (chapter.children && chapter.children.length > 0) {
                html += '<div class="ms-3">';
                chapter.children.forEach(child => {
                    html += renderChapter(child);
                });
                html += '</div>';
            }

            html += '</div>';
            return html;
        }

        // æ¸…ç©ºç»“æœ
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('resultsContainer').style.display = 'none';
            document.getElementById('fileInput').value = '';
            selectedParsers = [];
            document.querySelectorAll('.parser-card').forEach(card => {
                card.classList.remove('selected');
                const checkbox = card.querySelector('input[type="checkbox"]');
                if (checkbox) checkbox.checked = false;
            });
        });
    </script>
</body>
</html>
