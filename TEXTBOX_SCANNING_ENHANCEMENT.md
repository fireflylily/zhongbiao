# 文本框扫描功能 - 增强实施报告

## 📋 项目概述

为`DocumentScanner`增加文本框（textbox）扫描功能，解决"法定代表人/负责人的合法有效身份证明扫描件粘贴处"等文本框内容未被识别的问题。

## 🎯 问题背景

### 用户反馈
用户发现文档中存在文本"法定代表人/负责人的合法有效身份证明扫描件粘贴处"，但系统没有扫描到。

### 问题根源
经过调查发现：
- ✅ **文本确实存在** - 位于商务应答模板中
- ❌ **位置特殊** - 不在段落（paragraph）中，而在**文本框（textbox）**中
- ❌ **未被扫描** - `DocumentScanner`只扫描`doc.paragraphs`，不扫描文本框

### 文档结构
```
段落#165: "附：法定代表人/负责人的合法有效身份证明扫描件(如提供...国徽面及人像面)"
段落#166: [空段落，但包含2个文本框]
  ├─ 文本框#0: "法定代表人/负责人的合法有效身份证明扫描件粘贴处"  ⭐ 未被扫描
  └─ 文本框#1: "法定代表人/负责人的合法有效身份证明扫描件粘贴处"  ⭐ 未被扫描

段落#198: [空段落，但包含2个文本框]
  ├─ 文本框#0: "委托代理人的合法有效身份证明扫描件粘贴处"  ⭐ 未被扫描
  └─ 文本框#1: "委托代理人的合法有效身份证明扫描件粘贴处"  ⭐ 未被扫描
```

## 🔧 解决方案

### 技术方案

1. **新增`_scan_textboxes()`方法**
   - 遍历所有段落的XML元素
   - 查找`w:txbxContent`（文本框内容）
   - 提取文本框中的文本
   - 应用质量评分系统

2. **整合到扫描流程**
   - 在段落扫描后、表格扫描前增加文本框扫描
   - 将文本框候选合并到候选字典
   - 统一评分排序，公平竞争

3. **复用质量评分系统**
   - 文本框内容使用`_classify_paragraph()`评分
   - "粘贴处"触发通用质量检测（+15分）
   - 与段落候选统一排序

## 📊 实施效果

### 扫描结果

**文本框扫描**:
- ✅ 找到6个文本框
- ✅ 其中4个身份证相关文本框（2个法人+2个委托代理人）
- ✅ 所有文本框都被正确识别和评分

### 法人身份证候选对比

| 排名 | 来源 | 文本 | 分类 | 基础分 | 奖励分 | 总分 | 选择 |
|------|------|------|------|--------|--------|------|------|
| #1 | 段落#165 | 附：...国徽面及人像面 | strong_attach | 100 | 40 | **140** | ✅ |
| #2 | 段落#166(文本框) | ...粘贴处 | strong_attach | 100 | 25 | **125** | - |
| #3 | 段落#166(文本框) | ...粘贴处 | strong_attach | 100 | 25 | **125** | - |
| #4 | 段落#153 | ★法定代表人/负责人身份证明 | neutral | 50 | 0 | **50** | - |
| #5 | 段落#155 | 法定代表人/负责人身份证明 | neutral | 50 | 0 | **50** | - |

### 评分详情

**段落#165** (140分) - 胜出：
- 基础分：100 (strong_attach)
- 身份证专业术语（国徽面+人像面）：+20分
- 插入指示词（扫描件）：+10分
- 操作指引（需同时提供）：+5分
- 格式说明（如提供）：+5分

**段落#166文本框** (125分) - 高质量但略逊：
- 基础分：100 (strong_attach)
- 强位置信号（粘贴处）：+15分
- 插入指示词（扫描件）：+10分

### 选择逻辑

系统正确选择了段落#165，原因：
1. ✅ 更高总分（140 vs 125）
2. ✅ 包含专业术语（国徽面、人像面）提供更丰富的插入指导
3. ✅ 包含操作指引（需同时提供）和格式说明

## 🛠️ 技术实现

### 1. 新增`_scan_textboxes()`方法

```python
def _scan_textboxes(self, doc: Document) -> Dict[str, list]:
    """
    扫描文档中的文本框，查找插入点

    文本框通常用于占位符，如"法定代表人身份证扫描件粘贴处"
    这些文本框是非常明确的插入位置指示
    """
    from docx.oxml.ns import qn

    candidates = {}
    textbox_count = 0

    # 遍历所有段落，查找包含文本框的段落
    for para_idx, paragraph in enumerate(doc.paragraphs):
        para_elem = paragraph._element

        # 查找文本框 (w:txbxContent)
        textboxes = para_elem.findall('.//w:txbxContent', namespaces={
            'w': 'http://schemas.openxmlformats.org/wordprocessingml/2006/main'
        })

        if not textboxes:
            continue

        # 提取文本框内容
        for tb_idx, textbox in enumerate(textboxes):
            # 提取文本框中的所有文本
            tb_text_elements = textbox.findall('.//w:t', namespaces={
                'w': 'http://schemas.openxmlformats.org/wordprocessingml/2006/main'
            })
            text = ''.join([t.text for t in tb_text_elements if t.text])
            text = text.strip()

            if not text:
                continue

            textbox_count += 1

            # 使用质量评分系统评估文本框
            category, bonus = self._classify_paragraph(text, para_idx, len(doc.paragraphs), '')

            # 识别并分类文本框...
            # (身份证、营业执照、授权书等)

    return candidates
```

### 2. 整合到扫描流程

```python
def scan_insert_points(self, doc: Document, image_config: Dict[str, Any] = None):
    # ... 段落扫描 ...

    # ===== 扫描文本框中的插入点（特殊处理）=====
    self.logger.info(f"📦 开始扫描文本框...")
    textbox_candidates = self._scan_textboxes(doc)

    # 将文本框候选合并到candidates字典
    for img_type, textbox_list in textbox_candidates.items():
        for textbox_candidate in textbox_list:
            candidates.setdefault(img_type, []).append(textbox_candidate)

    # ===== 扫描表格 =====
    # ...
```

### 3. 候选类型标记

文本框候选在候选字典中标记为`'type': 'textbox'`：

```python
candidates.setdefault('legal_id', []).append({
    'type': 'textbox',            # 标记为文本框
    'index': para_idx,            # 包含文本框的段落索引
    'paragraph': paragraph,       # 段落对象（用于定位）
    'category': category,         # 分类
    'bonus_score': bonus,         # 奖励分
    'text': text[:60]            # 文本内容
})
```

## ✅ 测试验证

### 测试文件
- `test_textbox_scanning.py` - 完整的文本框扫描测试

### 测试结果
```
✅ 文本框扫描功能测试通过！
   ✓ 成功识别了6个文本框
   ✓ 其中4个身份证相关文本框
   ✓ 文本框正确应用质量评分系统
   ✓ 文本框与段落候选统一排序
   ✓ 最佳候选选择正确
```

### 实际文档测试
在商务应答模板上的测试结果：
- ✅ 扫描到6个文本框
- ✅ 识别了4个身份证文本框（2法人+2委托代理人）
- ✅ 评分正确（strong_attach+25分）
- ✅ 与段落候选公平竞争
- ✅ 最终选择正确

## 📈 影响范围

### 受益场景
1. **文本框占位符** - 识别"粘贴处"、"张贴处"等明确位置指示
2. **身份证插入** - 识别文本框中的身份证要求
3. **营业执照插入** - 识别文本框中的营业执照要求
4. **授权书插入** - 识别文本框中的授权书要求
5. **其他资质** - 通用支持所有文本框类型的资质要求

### 向后兼容性
- ✅ 不影响现有段落扫描逻辑
- ✅ 不影响现有表格扫描逻辑
- ✅ 文本框作为新候选类型，与其他类型公平竞争
- ✅ 日志输出清晰区分（📦 文本框）

## 🎓 核心优势

1. **完整覆盖** - 扫描段落、文本框、表格三种位置
2. **统一评分** - 所有候选使用相同的质量评分系统
3. **公平竞争** - 按总分排序，自动选择最佳位置
4. **智能识别** - 复用通用质量检测逻辑（粘贴处+15分）
5. **日志友好** - 清晰显示文本框来源和评分

## 📝 修改文件清单

| 文件 | 修改内容 | 行数 | 状态 |
|------|---------|------|------|
| `document_scanner.py` | 新增`_scan_textboxes()`方法 | +125行 | ✅ 完成 |
| `document_scanner.py` | 整合文本框扫描到主流程 | +8行 | ✅ 完成 |
| `test_textbox_scanning.py` | 文本框扫描测试 | 新增 | ✅ 完成 |
| `TEXTBOX_SCANNING_ENHANCEMENT.md` | 技术文档 | 新增 | ✅ 完成 |

## 🚀 未来扩展

可以考虑的进一步优化：
1. 支持更多类型的形状（shape）和文本容器
2. 支持图片中的OCR文本识别
3. 支持页眉页脚中的特殊标记
4. 支持批注中的插入指示

## 📌 总结

本次增强成功解决了文本框内容未被扫描的问题：
- ✅ 识别到6个文本框（包括您提到的"粘贴处"文本）
- ✅ 正确应用质量评分系统（粘贴处+15分 + 扫描件+10分 = 125分）
- ✅ 与段落候选统一排序（段落#165 140分 > 文本框 125分）
- ✅ 最佳候选选择正确（段落#165凭借专业术语胜出）
- ✅ 完全向后兼容，不影响现有功能
- ✅ 测试全部通过

### 为什么段落#165仍然是最佳选择？

虽然文本框包含明确的"粘贴处"标记（125分），但段落#165因为包含了：
- 专业术语（国徽面+人像面）：+20分
- 更详细的操作指引和格式说明：+10分
- **总分更高（140 vs 125）**

这是合理的，因为段落#165提供了更丰富的插入指导信息，帮助用户了解需要提供哪些具体内容（国徽面、人像面等）。

---

**实施日期**: 2025-12-02
**实施人员**: Claude Code
**测试状态**: ✅ 通过（文本框扫描 + 质量评分）
**部署状态**: ✅ 就绪
**版本**: v3.0 (增加文本框扫描支持)
