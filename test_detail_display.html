<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>详细要求显示测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h3 class="mb-4">详细要求展开/收起功能测试</h3>

        <div class="alert alert-info">
            <strong>测试说明:</strong> 这个页面测试长文本的展开/收起功能
        </div>

        <div id="testContent" class="mt-4">
            <!-- 测试内容将在这里动态生成 -->
        </div>
    </div>

    <!-- 引入formatDetailTextWithToggle和toggleDetailText函数 -->
    <script>
        /**
         * 格式化detail文本，对于长文本添加展开/收起功能
         */
        function formatDetailTextWithToggle(text, maxLength = 150) {
            if (!text) return '';

            // HTML转义
            const escapeHtml = (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            };

            const escapedText = escapeHtml(text);

            // 如果文本长度小于等于最大长度，直接返回
            if (text.length <= maxLength) {
                return escapedText;
            }

            // 生成唯一ID
            const uniqueId = 'detail_' + Math.random().toString(36).substr(2, 9);

            // 智能截断：优先在句号、分号等强分隔符处截断
            let shortText = text.substring(0, maxLength);

            // 定义标点符号优先级（从高到低）
            const punctuations = [
                { char: '。', priority: 5 },   // 句号 - 最高优先级
                { char: '；', priority: 4 },   // 中文分号
                { char: ';', priority: 4 },    // 英文分号
                { char: '！', priority: 4 },   // 感叹号
                { char: '？', priority: 4 },   // 问号
                { char: '，', priority: 3 },   // 中文逗号
                { char: ',', priority: 3 },    // 英文逗号
                { char: '、', priority: 2 },   // 顿号
                { char: '）', priority: 2 },   // 右括号
                { char: ')', priority: 2 }     // 英文右括号
            ];

            // 查找所有标点符号的位置
            let bestCutPoint = -1;
            let bestPriority = 0;

            for (const punct of punctuations) {
                const pos = shortText.lastIndexOf(punct.char);
                // 如果找到标点，且在合理范围内（至少显示50%的内容）
                if (pos > maxLength * 0.5 && punct.priority > bestPriority) {
                    bestCutPoint = pos;
                    bestPriority = punct.priority;
                }
            }

            // 如果找到了合适的截断点，在标点符号之后截断
            if (bestCutPoint > 0) {
                shortText = text.substring(0, bestCutPoint + 1);
            }

            const escapedShortText = escapeHtml(shortText);

            return `
                <span id="${uniqueId}_short">
                    ${escapedShortText}...
                    <a href="#" class="text-primary ms-1 small" onclick="toggleDetailText('${uniqueId}', event)" style="text-decoration:none;">
                        <i class="bi bi-chevron-down"></i> 展开
                    </a>
                </span>
                <span id="${uniqueId}_full" style="display:none;">
                    ${escapedText}
                    <a href="#" class="text-primary ms-1 small" onclick="toggleDetailText('${uniqueId}', event)" style="text-decoration:none;">
                        <i class="bi bi-chevron-up"></i> 收起
                    </a>
                </span>
            `;
        }

        /**
         * 切换detail文本的展开/收起状态
         */
        function toggleDetailText(id, event) {
            event.preventDefault();
            const shortEl = document.getElementById(id + '_short');
            const fullEl = document.getElementById(id + '_full');

            if (!shortEl || !fullEl) {
                console.error('[toggleDetailText] 找不到元素:', id);
                return;
            }

            if (shortEl.style.display === 'none') {
                // 收起
                shortEl.style.display = '';
                fullEl.style.display = 'none';
            } else {
                // 展开
                shortEl.style.display = 'none';
                fullEl.style.display = '';
            }
        }

        // 测试数据
        const testRequirements = [
            {
                title: "财务要求（长文本）",
                detail: "单位除外）； 供应商具有良好的商业信誉和健全的财务会计制度（供应商提供近1年的经第三方机构审计的财务审计报告（每份报告应至少包含1）审计报告正文，2）资产负债表，3）利润表或收入费用表（事业单位提供）4）现金流量表（事业单位免提供）5）所有者权益变动表（事业单位免提供）、6）财务报表附注等，上述6项完整内容齐全）（提供加盖公章的复印件）；（事业单位提供加盖公章的财务报表复印件）"
            },
            {
                title: "缴纳社保（长文本）",
                detail: "的良好记录。提供以下资料：①供应商提供谈判截止日前6个月任意1个月的增值税缴纳证明文件；②供应商企业社保直接缴纳人数不得低于10人（含）（须近一年在本公司（含分公司）直接缴纳且连续缴费月数大于等于12个月）"
            },
            {
                title: "短文本测试",
                detail: "供应商须提供有效营业执照"
            }
        ];

        // 渲染测试内容
        function renderTestContent() {
            const container = document.getElementById('testContent');
            let html = '';

            testRequirements.forEach((req, index) => {
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">测试 ${index + 1}: ${req.title}</h6>
                            <div class="mt-2">
                                <strong>原始长度:</strong> ${req.detail.length} 字符
                            </div>
                            <div class="mt-2">
                                <strong>显示效果:</strong><br>
                                <div class="p-2 bg-light rounded mt-1">
                                    ${formatDetailTextWithToggle(req.detail, 150)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 页面加载时渲染
        document.addEventListener('DOMContentLoaded', renderTestContent);
    </script>
</body>
</html>
