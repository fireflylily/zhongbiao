# å…¬å¸çŠ¶æ€ç®¡ç†é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ¯ é—®é¢˜æè¿°
åœ¨å…¬å¸ç®¡ç†é¡µé¢ï¼Œç”¨æˆ·ä»å·¦ä¾§å¯¼èˆªé€‰æ‹©å…¬å¸åï¼Œåˆ‡æ¢åˆ°èµ„è´¨ç®¡ç†é€‰é¡¹å¡å¹¶ä¿å­˜èµ„è´¨æ—¶ï¼Œä¼šæç¤º"éœ€è¦å…ˆè®¾ç½®å…¬å¸ä¿¡æ¯"ã€‚

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ
1. **çŠ¶æ€ä¸åŒæ­¥**: å…¬å¸é€‰æ‹©çŠ¶æ€åœ¨ `StateManager` ä¸­ï¼Œä½†èµ„è´¨ä¿å­˜å‡½æ•°åªæ£€æŸ¥å±€éƒ¨å˜é‡ `currentCompanyId`
2. **çŠ¶æ€ä¸¢å¤±**: é¡µé¢åˆ·æ–°æˆ–é€‰é¡¹å¡åˆ‡æ¢æ—¶ï¼Œå±€éƒ¨çŠ¶æ€å¯èƒ½ä¸¢å¤±è€Œå…¨å±€çŠ¶æ€ä¿æŒ
3. **ä¼˜å…ˆçº§é”™è¯¯**: æ²¡æœ‰ä¼˜å…ˆä½¿ç”¨å…¨å±€çŠ¶æ€ç®¡ç†å™¨ä¸­çš„çŠ¶æ€

## âœ… ä¿®å¤æ–¹æ¡ˆå®æ–½

### 1. çŠ¶æ€åˆå§‹åŒ–ä¼˜åŒ–
**æ–‡ä»¶**: `webé¡µé¢/js/company_selection.js:88-98`
**ä¿®æ”¹å†…å®¹**: å¢åŠ è¯¦ç»†çš„çŠ¶æ€åˆå§‹åŒ–æ—¥å¿—å’Œé”™è¯¯å¤„ç†

```javascript
// ä»çŠ¶æ€ç®¡ç†å™¨æ¢å¤å…¬å¸ID - ç»Ÿä¸€çŠ¶æ€ç®¡ç†
const savedCompanyId = StateManager.getCompanyId();
console.log('[å…¬å¸çŠ¶æ€] é¡µé¢åˆå§‹åŒ–ï¼Œä»StateManagerè·å–å…¬å¸ID:', savedCompanyId);

if (savedCompanyId) {
    currentCompanyId = savedCompanyId;
    console.log('[å…¬å¸çŠ¶æ€] è®¾ç½®æœ¬åœ°currentCompanyId:', currentCompanyId);
    loadCompanyInfo(savedCompanyId);
} else {
    console.log('[å…¬å¸çŠ¶æ€] æœªæ‰¾åˆ°å·²ä¿å­˜çš„å…¬å¸ID');
}
```

### 2. èµ„è´¨ä¿å­˜é€»è¾‘é‡æ„
**æ–‡ä»¶**: `webé¡µé¢/js/company_selection.js:553-575`
**ä¿®æ”¹å†…å®¹**: ä¼˜å…ˆä½¿ç”¨StateManagerçŠ¶æ€ï¼Œå®ç°çŠ¶æ€åŒæ­¥

```javascript
function saveAllQualifications() {
    // ä¼˜å…ˆä»StateManagerè·å–å…¬å¸IDï¼Œç¡®ä¿çŠ¶æ€ä¸€è‡´æ€§
    const stateCompanyId = StateManager.getCompanyId();
    const effectiveCompanyId = stateCompanyId || currentCompanyId;
    
    console.log('[èµ„è´¨ä¿å­˜] çŠ¶æ€æ£€æŸ¥:', {
        stateCompanyId,
        currentCompanyId,
        effectiveCompanyId
    });
    
    if (!effectiveCompanyId) {
        console.log('[èµ„è´¨ä¿å­˜] é”™è¯¯ï¼šæœªæ‰¾åˆ°æœ‰æ•ˆçš„å…¬å¸ID');
        showCompanyMessage('è¯·å…ˆé€‰æ‹©å…¬å¸ä¿¡æ¯', 'error');
        return;
    }
    
    // åŒæ­¥çŠ¶æ€ï¼šç¡®ä¿æœ¬åœ°å˜é‡ä¸StateManagerä¸€è‡´
    if (effectiveCompanyId !== currentCompanyId) {
        console.log('[èµ„è´¨ä¿å­˜] åŒæ­¥æœ¬åœ°å…¬å¸çŠ¶æ€:', effectiveCompanyId);
        currentCompanyId = effectiveCompanyId;
    }
}
```

### 3. å…¬å¸é€‰æ‹©åŒæ­¥æœºåˆ¶
**æ–‡ä»¶**: `webé¡µé¢/js/company_selection.js:130-147`
**ä¿®æ”¹å†…å®¹**: ç«‹å³åŒæ­¥çŠ¶æ€åˆ°StateManager

```javascript
function handleCompanySelection(event) {
    if (isLoadingCompany) return;
    
    const companyId = event.target.value;
    console.log('[å…¬å¸é€‰æ‹©] ç”¨æˆ·é€‰æ‹©å…¬å¸ID:', companyId);
    
    if (companyId) {
        // ç«‹å³åŒæ­¥çŠ¶æ€åˆ°StateManager
        StateManager.setCompanyId(companyId);
        console.log('[å…¬å¸é€‰æ‹©] å·²åŒæ­¥çŠ¶æ€åˆ°StateManager:', companyId);
        loadCompanyInfo(companyId);
    } else {
        // æ¸…ç©ºæ—¶ä¹Ÿè¦æ¸…ç†StateManagerä¸­çš„çŠ¶æ€
        StateManager.setCompanyId('');
        console.log('[å…¬å¸é€‰æ‹©] å·²æ¸…ç©ºStateManagerä¸­çš„å…¬å¸çŠ¶æ€');
        clearCompanyForm();
    }
}
```

### 4. çŠ¶æ€éªŒè¯å‡½æ•°
**æ–‡ä»¶**: `webé¡µé¢/js/company_selection.js:55-73`
**ä¿®æ”¹å†…å®¹**: æ·»åŠ çŠ¶æ€ä¸€è‡´æ€§éªŒè¯æœºåˆ¶

```javascript
// çŠ¶æ€ä¸€è‡´æ€§éªŒè¯å‡½æ•°
function validateCompanyState() {
    const stateCompanyId = StateManager.getCompanyId();
    const localCompanyId = currentCompanyId;
    
    if (stateCompanyId !== localCompanyId) {
        console.warn('[çŠ¶æ€éªŒè¯] çŠ¶æ€ä¸ä¸€è‡´:', {
            stateCompanyId,
            localCompanyId,
            action: 'åŒæ­¥åˆ°StateManagerçŠ¶æ€'
        });
        
        // ä»¥StateManagerä¸ºå‡†
        currentCompanyId = stateCompanyId;
        return stateCompanyId;
    }
    
    return stateCompanyId;
}
```

## ğŸ›¡ï¸ ä¿®å¤ç‰¹ç‚¹

### âœ… éµå¾ªæœ€å°å½±å“åŸåˆ™
- åªä¿®æ”¹å…¬å¸çŠ¶æ€ç®¡ç†é€»è¾‘
- ä¸å½±å“å…¶ä»–åŠŸèƒ½æ¨¡å—
- ä¿æŒç°æœ‰APIæ¥å£ä¸å˜
- ä¸æ¶‰åŠæ ¸å¿ƒä¾èµ–ç»„ä»¶

### âœ… å‘åå…¼å®¹æ€§
- ä¿æŒç°æœ‰çŠ¶æ€é”®åä¸å˜
- ä¸ç ´åç°æœ‰çŠ¶æ€ç®¡ç†æœºåˆ¶
- åªæ˜¯å¢å¼ºçŠ¶æ€åŒæ­¥çš„å¯é æ€§
- æ”¯æŒæ¸è¿›å¼å‡çº§

### âœ… è°ƒè¯•å‹å¥½
- æ·»åŠ è¯¦ç»†çš„console.logæ—¥å¿—
- çŠ¶æ€å˜åŒ–å…¨ç¨‹å¯è¿½è¸ª
- ä¾¿äºé—®é¢˜å®šä½å’Œæ’æŸ¥

## ğŸ§ª éªŒè¯æ–¹æ¡ˆ

### æµ‹è¯•åœºæ™¯
1. **ä¸»æµç¨‹æµ‹è¯•**: å¯¼èˆª â†’ é€‰æ‹©å…¬å¸ â†’ åˆ‡æ¢èµ„è´¨ç®¡ç† â†’ ä¿å­˜èµ„è´¨ âœ…
2. **é¡µé¢åˆ·æ–°æµ‹è¯•**: çŠ¶æ€ä¿æŒéªŒè¯ âœ…  
3. **çŠ¶æ€åŒæ­¥æµ‹è¯•**: å¤šé€‰é¡¹å¡ä¸€è‡´æ€§éªŒè¯ âœ…
4. **è¾¹ç•Œæµ‹è¯•**: æ— çŠ¶æ€ã€çŠ¶æ€ä¸ä¸€è‡´ç­‰æƒ…å†µ âœ…

### éªŒè¯å·¥å…·
åˆ›å»ºäº† `test-company-state.html` æµ‹è¯•é¡µé¢ï¼ŒåŒ…å«ï¼š
- StateManageråŸºç¡€åŠŸèƒ½æµ‹è¯•
- çŠ¶æ€åŒæ­¥æœºåˆ¶æµ‹è¯•  
- èµ„è´¨ä¿å­˜é€»è¾‘æµ‹è¯•
- å¤šç§è¾¹ç•Œåœºæ™¯æ¨¡æ‹Ÿ

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ğŸ¯ è§£å†³çš„é—®é¢˜
- âœ… èµ„è´¨ä¿å­˜ä¸å†æç¤º"éœ€è¦å…ˆè®¾ç½®å…¬å¸ä¿¡æ¯"
- âœ… å…¬å¸çŠ¶æ€åœ¨é¡µé¢åˆ·æ–°åæ­£ç¡®ä¿æŒ
- âœ… é€‰é¡¹å¡åˆ‡æ¢æ—¶çŠ¶æ€ä¿æŒä¸€è‡´
- âœ… çŠ¶æ€ç®¡ç†æ›´åŠ å¯é å’Œå¯è¿½è¸ª

### ğŸ”§ æŠ€æœ¯æ”¹è¿›
- âœ… ç»Ÿä¸€äº†çŠ¶æ€ç®¡ç†å…¥å£
- âœ… å¢å¼ºäº†çŠ¶æ€åŒæ­¥æœºåˆ¶
- âœ… æå‡äº†ä»£ç å¯ç»´æŠ¤æ€§
- âœ… æ”¹å–„äº†è°ƒè¯•ä½“éªŒ

## ğŸ“ åç»­å»ºè®®

### çŸ­æœŸä¼˜åŒ–
1. åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ä»¥ç§»é™¤è¯¦ç»†çš„console.logæ—¥å¿—
2. å¯ä»¥è€ƒè™‘æ·»åŠ çŠ¶æ€å˜æ›´çš„ç”¨æˆ·æç¤º

### é•¿æœŸä¼˜åŒ–  
1. è€ƒè™‘å®ç°æ›´å®Œæ•´çš„çŠ¶æ€ç®¡ç†æ¨¡å¼ï¼ˆå¦‚Redux-likeæ¶æ„ï¼‰
2. æ·»åŠ çŠ¶æ€æŒä¹…åŒ–çš„è‡ªåŠ¨æ¢å¤æœºåˆ¶
3. å®ç°è·¨é¡µé¢çš„çŠ¶æ€å˜æ›´é€šçŸ¥

## ğŸš€ éƒ¨ç½²è¯´æ˜

### å½±å“èŒƒå›´
- **æ–‡ä»¶**: `webé¡µé¢/js/company_selection.js`
- **åŠŸèƒ½**: å…¬å¸ç®¡ç†é¡µé¢çš„çŠ¶æ€åŒæ­¥
- **å…¼å®¹æ€§**: å®Œå…¨å‘åå…¼å®¹

### éƒ¨ç½²æ­¥éª¤
1. æ›¿æ¢ä¿®æ”¹åçš„ `company_selection.js` æ–‡ä»¶
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ç¡®ä¿åŠ è½½æ–°ç‰ˆæœ¬
3. éªŒè¯å…¬å¸é€‰æ‹©å’Œèµ„è´¨ä¿å­˜åŠŸèƒ½
4. ç›‘æ§consoleæ—¥å¿—ç¡®ä¿çŠ¶æ€åŒæ­¥æ­£å¸¸

### å›æ»šæ–¹æ¡ˆ
å¦‚æœ‰é—®é¢˜å¯ç«‹å³å›æ»šåˆ°ä¿®æ”¹å‰ç‰ˆæœ¬ï¼Œå½±å“èŒƒå›´å±€é™åœ¨å…¬å¸ç®¡ç†é¡µé¢ã€‚

---

**ä¿®å¤éµå¾ª**: bug-fix-guide.md çš„æœ€å°å½±å“åŸåˆ™å’Œæœ€ä½³å®è·µ  
**çŠ¶æ€**: å·²å®Œæˆæµ‹è¯•éªŒè¯ âœ…  
**æ—¥æœŸ**: 2025-09-12