name: Deploy to Aliyun Server

on:
  push:
    branches:
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # ç¬¬1æ­¥: è¿è¡Œæµ‹è¯•
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y antiword

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-prod.txt
          pip install -r requirements-dev.txt

      - name: Run unit tests
        run: |
          echo "å¼€å§‹è¿è¡Œå•å…ƒæµ‹è¯•..."
          pytest tests/unit/ -v --tb=short --maxfail=10
        continue-on-error: true
        # å…è®¸æµ‹è¯•éƒ¨åˆ†å¤±è´¥,ä½†ä¼šè­¦å‘Š

      - name: Run critical tests
        run: |
          echo "è¿è¡Œå…³é”®æµ‹è¯•..."
          pytest tests/unit/common/ -v --tb=short --maxfail=5
        # å…³é”®å•å…ƒæµ‹è¯•å¿…é¡»é€šè¿‡ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰

      - name: Test Summary
        if: always()
        run: |
          echo "## æµ‹è¯•ç»“æœ âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æµ‹è¯•å·²å®Œæˆ,ç»§ç»­éƒ¨ç½²æµç¨‹" >> $GITHUB_STEP_SUMMARY

  # ç¬¬2æ­¥: æ„å»ºå‰ç«¯
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 1

      - name: Build Summary
        run: |
          echo "## å‰ç«¯æ„å»º âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "å‰ç«¯æ„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY

  # ç¬¬3æ­¥: éƒ¨ç½²åˆ°é˜¿é‡Œäº‘
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [test, build-frontend]  # å¿…é¡»ç­‰å¾…æµ‹è¯•å’Œæ„å»ºå®Œæˆ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºå›æ»š

      - name: Download frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ai_tender_system/web/static/dist/

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALIYUN_HOST }} >> ~/.ssh/known_hosts

      - name: Sync frontend build to server
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_USERNAME }}
          DEPLOY_PORT: ${{ secrets.ALIYUN_PORT }}
        run: |
          echo "ä¸Šä¼ å‰ç«¯æ„å»ºæ–‡ä»¶..."
          rsync -avz -e "ssh -p ${DEPLOY_PORT}" \
            ai_tender_system/web/static/dist/ \
            ${DEPLOY_USER}@${DEPLOY_HOST}:/var/www/ai-tender-system/ai_tender_system/web/static/dist/

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_USERNAME }}
          DEPLOY_PORT: ${{ secrets.ALIYUN_PORT }}
        run: |
          ssh -p ${DEPLOY_PORT} ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

            echo "=========================================="
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

            # åˆ‡æ¢åˆ°åº”ç”¨ç›®å½•
            cd /var/www/ai-tender-system

            # ä¿å­˜å½“å‰commitç”¨äºå›æ»š
            git rev-parse HEAD > .last_deploy_commit

            # æ‹‰å–æœ€æ–°ä»£ç 
            git fetch origin master
            git reset --hard origin/master

            # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
            source venv/bin/activate

            # å®‰è£…/æ›´æ–°ä¾èµ–
            pip install -r requirements.txt --quiet

            # è¿è¡Œæ•°æ®åº“è¿ç§»(å¦‚æœæœ‰)
            # python -m ai_tender_system.database.migrate

            # é‡å¯æœåŠ¡
            sudo supervisorctl restart ai-tender-system

            # é‡è½½ Nginx (å¦‚æœå‰ç«¯æœ‰æ›´æ–°)
            sudo systemctl reload nginx

            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
          ENDSSH

      - name: Verify deployment
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_USERNAME }}
          DEPLOY_PORT: ${{ secrets.ALIYUN_PORT }}
        run: |
          echo "éªŒè¯åº”ç”¨å¥åº·çŠ¶æ€..."

          # ç­‰å¾…5ç§’è®©æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 5

          # é€šè¿‡SSHæ£€æŸ¥æœåŠ¡çŠ¶æ€
          ssh -p ${DEPLOY_PORT} ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            # æ£€æŸ¥SupervisorçŠ¶æ€
            if sudo supervisorctl status ai-tender-system | grep -q RUNNING; then
              echo "âœ… åº”ç”¨æœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âŒ åº”ç”¨æœåŠ¡æœªè¿è¡Œ"
              sudo supervisorctl status ai-tender-system
              exit 1
            fi

            # æ£€æŸ¥HTTPå“åº”
            if curl -f -s -o /dev/null http://localhost:8110/api/health; then
              echo "âœ… HTTPå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ HTTPå¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi
          ENDSSH

          echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸï¼"

      - name: Notify on success
        if: success()
        run: |
          echo "::notice::ğŸ‰ éƒ¨ç½²æˆåŠŸï¼åº”ç”¨å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨ä¿®å¤ã€‚"

      - name: Rollback on failure
        if: failure()
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_USERNAME }}
          DEPLOY_PORT: ${{ secrets.ALIYUN_PORT }}
        run: |
          echo "âš ï¸  éƒ¨ç½²å¤±è´¥ï¼Œå°è¯•å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."

          ssh -p ${DEPLOY_PORT} ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            cd /var/www/ai-tender-system

            # å›æ»šåˆ°ä¸Šä¸€ä¸ªcommit
            if [ -f .last_deploy_commit ]; then
              LAST_COMMIT=$(cat .last_deploy_commit)
              echo "å›æ»šåˆ°: $LAST_COMMIT"
              git reset --hard $LAST_COMMIT

              # é‡å¯æœåŠ¡
              sudo supervisorctl restart ai-tender-system

              echo "âœ… å›æ»šå®Œæˆ"
            else
              echo "âš ï¸  æœªæ‰¾åˆ°å›æ»šä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
            fi
          ENDSSH

  # ç¬¬4æ­¥: éƒ¨ç½²åé€šçŸ¥
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: [test, build-frontend, deploy]
    if: always()  # æ— è®ºéƒ¨ç½²æˆåŠŸæˆ–å¤±è´¥éƒ½å‘é€é€šçŸ¥

    steps:
      - name: Get deployment result
        id: result
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "status=âœ… éƒ¨ç½²æˆåŠŸ" >> $GITHUB_OUTPUT
            echo "color=#00ff00" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_OUTPUT
            echo "color=#ff0000" >> $GITHUB_OUTPUT
          fi

      - name: Print summary
        run: |
          echo "## ğŸš€ éƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.result.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### éƒ¨ç½²è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æµç¨‹çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å‰ç«¯æ„å»º: ${{ needs.build-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½²: ${{ needs.deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è®¿é—®åœ°å€: https://toubiao.succtech.com" >> $GITHUB_STEP_SUMMARY

      # å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é’‰é’‰/ä¼ä¸šå¾®ä¿¡webhooké€šçŸ¥
      # - name: Send DingTalk notification
      #   if: always()
      #   run: |
      #     curl -X POST "https://oapi.dingtalk.com/robot/send?access_token=${{ secrets.DINGTALK_TOKEN }}" \
      #       -H 'Content-Type: application/json' \
      #       -d '{
      #         "msgtype": "markdown",
      #         "markdown": {
      #           "title": "éƒ¨ç½²é€šçŸ¥",
      #           "text": "### ${{ steps.result.outputs.status }}\n\n- åˆ†æ”¯: ${{ github.ref_name }}\n- æäº¤: ${{ github.sha }}\n- æäº¤è€…: ${{ github.actor }}"
      #         }
      #       }'
