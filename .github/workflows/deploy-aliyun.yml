name: Deploy to Aliyun Server

on:
  push:
    branches:
      - master
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘éƒ¨ç½²

# é˜²æ­¢å¹¶å‘éƒ¨ç½²
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºå›æ»š

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.ALIYUN_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_USERNAME }}
          DEPLOY_PORT: ${{ secrets.ALIYUN_PORT }}
        run: |
          ssh -p ${DEPLOY_PORT} ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

            echo "=========================================="
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

            # åˆ‡æ¢åˆ°åº”ç”¨ç›®å½•
            cd /var/www/ai-tender-system

            # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
            bash scripts/deploy.sh

            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
          ENDSSH

      - name: Verify deployment
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_USERNAME }}
          DEPLOY_PORT: ${{ secrets.ALIYUN_PORT }}
        run: |
          echo "éªŒè¯åº”ç”¨å¥åº·çŠ¶æ€..."

          # ç­‰å¾…3ç§’è®©æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 3

          # é€šè¿‡SSHæ£€æŸ¥æœåŠ¡çŠ¶æ€
          ssh -p ${DEPLOY_PORT} ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            # æ£€æŸ¥Gunicornè¿›ç¨‹
            if sudo supervisorctl status ai-tender-system | grep -q RUNNING; then
              echo "âœ… GunicornæœåŠ¡è¿è¡Œæ­£å¸¸"
            else
              echo "âŒ GunicornæœåŠ¡æœªè¿è¡Œ"
              sudo supervisorctl status ai-tender-system
              exit 1
            fi

            # æ£€æŸ¥HTTPå“åº”
            if curl -f -s -o /dev/null http://localhost:8000; then
              echo "âœ… HTTPå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ HTTPå¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi
          ENDSSH

          echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸï¼"

      - name: Notify on success
        if: success()
        run: |
          echo "::notice::ğŸ‰ éƒ¨ç½²æˆåŠŸï¼åº”ç”¨å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—å¹¶æ‰‹åŠ¨ä¿®å¤ã€‚"

      - name: Rollback on failure
        if: failure()
        env:
          DEPLOY_HOST: ${{ secrets.ALIYUN_HOST }}
          DEPLOY_USER: ${{ secrets.ALIYUN_USERNAME }}
          DEPLOY_PORT: ${{ secrets.ALIYUN_PORT }}
        run: |
          echo "âš ï¸  éƒ¨ç½²å¤±è´¥ï¼Œå°è¯•å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬..."

          ssh -p ${DEPLOY_PORT} ${DEPLOY_USER}@${DEPLOY_HOST} << 'ENDSSH'
            cd /var/www/ai-tender-system

            # å›æ»šåˆ°ä¸Šä¸€ä¸ªcommit
            if [ -f .last_deploy_commit ]; then
              LAST_COMMIT=$(cat .last_deploy_commit)
              echo "å›æ»šåˆ°: $LAST_COMMIT"
              git reset --hard $LAST_COMMIT

              # é‡å¯æœåŠ¡
              sudo supervisorctl restart ai-tender-system

              echo "âœ… å›æ»šå®Œæˆ"
            else
              echo "âš ï¸  æœªæ‰¾åˆ°å›æ»šä¿¡æ¯ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
            fi
          ENDSSH

  # å¯é€‰ï¼šéƒ¨ç½²åé€šçŸ¥ï¼ˆå¯é›†æˆé’‰é’‰ã€ä¼ä¸šå¾®ä¿¡ç­‰ï¼‰
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: deploy
    if: always()  # æ— è®ºéƒ¨ç½²æˆåŠŸæˆ–å¤±è´¥éƒ½å‘é€é€šçŸ¥

    steps:
      - name: Get deployment result
        id: result
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "status=âœ… éƒ¨ç½²æˆåŠŸ" >> $GITHUB_OUTPUT
            echo "color=#00ff00" >> $GITHUB_OUTPUT
          else
            echo "status=âŒ éƒ¨ç½²å¤±è´¥" >> $GITHUB_OUTPUT
            echo "color=#ff0000" >> $GITHUB_OUTPUT
          fi

      - name: Print summary
        run: |
          echo "## éƒ¨ç½²ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.result.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY

      # å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é’‰é’‰/ä¼ä¸šå¾®ä¿¡webhooké€šçŸ¥
      # - name: Send DingTalk notification
      #   if: always()
      #   run: |
      #     curl -X POST "https://oapi.dingtalk.com/robot/send?access_token=${{ secrets.DINGTALK_TOKEN }}" \
      #       -H 'Content-Type: application/json' \
      #       -d '{
      #         "msgtype": "markdown",
      #         "markdown": {
      #           "title": "éƒ¨ç½²é€šçŸ¥",
      #           "text": "### ${{ steps.result.outputs.status }}\n\n- åˆ†æ”¯: ${{ github.ref_name }}\n- æäº¤: ${{ github.sha }}\n- æäº¤è€…: ${{ github.actor }}"
      #         }
      #       }'
