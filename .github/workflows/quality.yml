name: ä»£ç è´¨é‡æ£€æŸ¥

on:
  push:
    branches: [ master, develop, main ]
  pull_request:
    branches: [ master, develop, main ]

# é˜²æ­¢å¹¶å‘æ‰§è¡Œ
concurrency:
  group: quality-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Python ä»£ç è´¨é‡æ£€æŸ¥
  python-quality:
    name: Python ä»£ç è´¨é‡
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: ä»£ç æ ¼å¼æ£€æŸ¥ (Black)
        run: |
          black --check ai_tender_system/ tests/ || echo "::warning::ä»£ç æ ¼å¼ä¸ç¬¦åˆ Black æ ‡å‡†"
        continue-on-error: true

      - name: Import æŽ’åºæ£€æŸ¥ (isort)
        run: |
          isort --check-only ai_tender_system/ tests/ || echo "::warning::Import æŽ’åºä¸ç¬¦åˆæ ‡å‡†"
        continue-on-error: true

      - name: ä»£ç é£Žæ ¼æ£€æŸ¥ (Flake8)
        run: |
          flake8 ai_tender_system/ tests/ --max-line-length=120 --extend-ignore=E203,E501,W503 || echo "::warning::ä»£ç é£Žæ ¼å­˜åœ¨é—®é¢˜"
        continue-on-error: true

      - name: ç±»åž‹æ£€æŸ¥ (MyPy)
        run: |
          mypy ai_tender_system/ --ignore-missing-imports --no-strict-optional || echo "::warning::ç±»åž‹æ£€æŸ¥å‘çŽ°é—®é¢˜"
        continue-on-error: true

      - name: ç”Ÿæˆè´¨é‡æŠ¥å‘Š
        if: always()
        run: |
          echo "## Python ä»£ç è´¨é‡æ£€æŸ¥ ðŸ”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **æ³¨æ„**: è´¨é‡æ£€æŸ¥å¤±è´¥ä¸ä¼šé˜»æ­¢éƒ¨ç½²,ä½†å»ºè®®å°½å¿«ä¿®å¤ã€‚" >> $GITHUB_STEP_SUMMARY

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ¼æ´žæ‰«æ
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£… Safety
        run: |
          pip install safety

      - name: æ£€æŸ¥ä¾èµ–æ¼æ´ž
        run: |
          safety check --file=requirements.txt --json || echo "::warning::å‘çŽ°ä¾èµ–åŒ…å®‰å…¨æ¼æ´ž"
        continue-on-error: true

      - name: æ£€æŸ¥å·²çŸ¥å®‰å…¨é—®é¢˜ (Bandit)
        run: |
          pip install bandit
          bandit -r ai_tender_system/ -f json -o bandit-report.json || echo "::warning::å‘çŽ°æ½œåœ¨å®‰å…¨é—®é¢˜"
        continue-on-error: true

      - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json

      - name: ç”Ÿæˆå®‰å…¨æŠ¥å‘Šæ‘˜è¦
        if: always()
        run: |
          echo "## å®‰å…¨æ‰«æç»“æžœ ðŸ”" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… å®‰å…¨æ‰«æå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "è¯¦ç»†æŠ¥å‘Šè¯·æŸ¥çœ‹ Artifacts ä¸­çš„ security-reports" >> $GITHUB_STEP_SUMMARY

  # ä¾èµ–ç‰ˆæœ¬æ£€æŸ¥
  dependency-check:
    name: ä¾èµ–ç‰ˆæœ¬æ£€æŸ¥
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: æ£€æŸ¥è¿‡æœŸä¾èµ–
        run: |
          pip install pip-check
          pip install -r requirements.txt
          pip-check || echo "::warning::å­˜åœ¨è¿‡æœŸçš„ä¾èµ–åŒ…"
        continue-on-error: true

      - name: ç”Ÿæˆä¾èµ–æŠ¥å‘Š
        if: always()
        run: |
          pip list --format=json > dependencies.json
          echo "## ä¾èµ–åŒ…ç‰ˆæœ¬ ðŸ“¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä¾èµ–åŒ…åˆ—è¡¨å·²ç”Ÿæˆ" >> $GITHUB_STEP_SUMMARY

      - name: ä¸Šä¼ ä¾èµ–æŠ¥å‘Š
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-report
          path: dependencies.json

  # è´¨é‡æ€»ç»“
  quality-summary:
    name: è´¨é‡æ£€æŸ¥æ€»ç»“
    runs-on: ubuntu-latest
    needs: [python-quality, security-scan, dependency-check]
    if: always()

    steps:
      - name: ç”Ÿæˆæ€»ç»“
        run: |
          echo "## ðŸŽ¨ ä»£ç è´¨é‡æ£€æŸ¥æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ£€æŸ¥ç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "- Python ä»£ç è´¨é‡: ${{ needs.python-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å®‰å…¨æ‰«æ: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ä¾èµ–æ£€æŸ¥: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **æç¤º**: ä»£ç è´¨é‡é—®é¢˜ä¸ä¼šé˜»æ­¢éƒ¨ç½²,ä½†å»ºè®®æŒç»­æ”¹è¿›!" >> $GITHUB_STEP_SUMMARY
