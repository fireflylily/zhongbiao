name: è‡ªåŠ¨åŒ–æµ‹è¯•

on:
  push:
    branches: [ master, develop, main ]
  pull_request:
    branches: [ master, develop, main ]

# é˜²æ­¢å¹¶å‘æ‰§è¡ŒåŒä¸€åˆ†æ”¯çš„æµ‹è¯•
concurrency:
  group: test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # åç«¯ Python æµ‹è¯•
  backend-test:
    name: Python åç«¯æµ‹è¯•
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ['3.11']

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y antiword

      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          pytest tests/unit/ -v --tb=short --cov=ai_tender_system --cov-report=xml --cov-report=term
        continue-on-error: true
        # å…è®¸æµ‹è¯•å¤±è´¥,ä½†ä¼šæ ‡è®°ä¸ºè­¦å‘Š

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: |
          pytest tests/ -m "not slow" -v --tb=short --cov=ai_tender_system --cov-append --cov-report=xml --cov-report=term
        continue-on-error: true

      - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Šæ‘˜è¦
        if: always()
        run: |
          echo "## æµ‹è¯•ç»“æœæ‘˜è¦ ğŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Python åç«¯æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- Python ç‰ˆæœ¬: ${{ matrix.python-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- æµ‹è¯•å®Œæˆæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pytest tests/ --co -q | tail -1 >> $GITHUB_STEP_SUMMARY || echo "æµ‹è¯•ç»Ÿè®¡è·å–å¤±è´¥" >> $GITHUB_STEP_SUMMARY

  # å‰ç«¯æµ‹è¯• (å¦‚æœæœ‰çš„è¯)
  frontend-test:
    name: Vue å‰ç«¯æµ‹è¯•
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: è¿è¡Œ Lint æ£€æŸ¥
        run: npm run lint --if-present
        continue-on-error: true

      - name: è¿è¡Œå‰ç«¯æµ‹è¯•
        run: npm test --if-present
        continue-on-error: true

      - name: æ„å»ºå‰ç«¯
        run: npm run build
        env:
          NODE_ENV: production

      - name: ç”Ÿæˆå‰ç«¯æµ‹è¯•æŠ¥å‘Š
        if: always()
        run: |
          echo "### å‰ç«¯æ„å»ºæµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js ç‰ˆæœ¬: 18" >> $GITHUB_STEP_SUMMARY
          echo "- æ„å»ºçŠ¶æ€: âœ… æˆåŠŸ" >> $GITHUB_STEP_SUMMARY

  # æµ‹è¯•ç»“æœæ±‡æ€»
  test-summary:
    name: æµ‹è¯•ç»“æœæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    if: always()

    steps:
      - name: ç”Ÿæˆæµ‹è¯•æ€»ç»“
        run: |
          echo "## ğŸ¯ CI/CD æµ‹è¯•æ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… æ‰€æœ‰æµ‹è¯•å·²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æµ‹è¯•çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          echo "- åç«¯æµ‹è¯•: ${{ needs.backend-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- å‰ç«¯æµ‹è¯•: ${{ needs.frontend-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ **æç¤º**: å³ä½¿éƒ¨åˆ†æµ‹è¯•å¤±è´¥,ä¹Ÿä¼šç»§ç»­æ‰§è¡Œã€‚è¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—äº†è§£é—®é¢˜ã€‚" >> $GITHUB_STEP_SUMMARY

      - name: æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡å¤±è´¥
        if: needs.backend-test.result == 'failure' || needs.frontend-test.result == 'failure'
        run: |
          echo "::warning::éƒ¨åˆ†æµ‹è¯•å¤±è´¥,ä½†ä¸ä¼šé˜»æ­¢åç»­æµç¨‹ã€‚è¯·å°½å¿«ä¿®å¤!"
