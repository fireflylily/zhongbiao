# 技术方案生成流程图

## 整体流程概览

```mermaid
flowchart TD
    Start([用户发起技术方案生成]) --> Input[输入参数收集]
    Input --> |项目ID, AI模型, 方案模式| LoadProject[加载项目信息]
    LoadProject --> LoadTechFile[加载技术需求文件]
    LoadTechFile --> CheckFile{文件存在?}
    CheckFile -->|否| Error1[返回错误: 未找到技术需求文件]
    CheckFile -->|是| ExtractText[提取文件文本内容]

    ExtractText --> Step1[Step 1: 需求分析]
    Step1 --> |调用 analyze_requirements prompt| AI1[AI分析需求文档]
    AI1 --> Parse1[解析JSON结果]
    Parse1 --> Categories[生成需求分类列表]

    Categories --> Step2[Step 2: 大纲生成]
    Step2 --> |调用 generate_outline prompt| AI2[AI生成应答大纲]
    AI2 --> Parse2[解析JSON结果]
    Parse2 --> Outline[生成章节结构]

    Outline --> Step3[Step 3: 内容填充]
    Step3 --> LoopChapters{遍历所有章节}
    LoopChapters -->|下一章节| FillChapter[填充章节内容]
    FillChapter --> |SSE流式输出| StreamContent[实时推送内容到前端]
    StreamContent --> LoopChapters
    LoopChapters -->|完成| Step4[Step 4: 文档生成]

    Step4 --> GenerateDocx[生成DOCX文档]
    GenerateDocx --> SaveFile[保存文件到服务器]
    SaveFile --> SaveDB[保存记录到数据库]
    SaveDB --> End([返回生成结果])

    Error1 --> End

    style Start fill:#e1f5e1
    style End fill:#ffe1e1
    style Step1 fill:#e3f2fd
    style Step2 fill:#f3e5f5
    style Step3 fill:#fff3e0
    style Step4 fill:#fce4ec
    style AI1 fill:#ffeb3b
    style AI2 fill:#ffeb3b
```

## 详细步骤说明

### 📋 Step 0: 参数准备

```
输入参数:
├── project_id: 52                    # 项目ID
├── ai_model: shihuang-gpt4o-mini     # AI模型选择
├── solution_mode: advanced            # 方案模式 (standard/advanced)
└── stream: true                       # 是否使用SSE流式输出

加载项目信息:
├── 项目名称
├── 招标单位
├── 企业ID (company_id)
└── 技术需求文件路径
```

### 🔍 Step 1: 需求分析 (analyze_requirements)

```mermaid
flowchart LR
    A[技术需求文档] --> B[提取文本内容]
    B --> C[调用 AI 分析]
    C --> D{识别需求分类}

    D --> E1[数据服务需求<br/>★高优先级<br/>15项需求]
    D --> E2[性能与可用性<br/>★高优先级<br/>8项需求]
    D --> E3[数据安全<br/>▲需证明<br/>6项需求]

    E1 --> F[提取关键词]
    E2 --> F
    E3 --> F

    F --> G[生成分析结果JSON]

    style A fill:#bbdefb
    style G fill:#c8e6c9
```

**输出结果示例:**
```json
{
  "document_summary": {
    "total_requirements": 50,
    "mandatory_count": 30,
    "complexity_level": "high"
  },
  "requirement_categories": [
    {
      "category": "数据服务需求",
      "priority": "high",
      "keywords": ["三要素验证", "在网状态", "归属地查询"],
      "key_points": [
        "运营商三要素验证（★高优先级）",
        "在网时长与状态查询（▲需提供测试报告）",
        "号码归属地实时查询"
      ]
    }
  ]
}
```

### 📝 Step 2: 大纲生成 (generate_outline)

```mermaid
flowchart TD
    A[需求分析结果] --> B{遍历需求分类}

    B --> C1[分类1: 数据服务需求]
    B --> C2[分类2: 性能与可用性]
    B --> C3[分类3: 数据安全]

    C1 --> D1[一、数据服务需求<br/>├─ 运营商三要素验证<br/>├─ 在网时长与状态查询<br/>└─ 号码归属地实时查询]

    C2 --> D2[二、性能与可用性<br/>├─ 支持1000并发请求<br/>├─ 接口响应时间≤500ms<br/>└─ 系统可用性≥99.9%]

    C3 --> D3[三、数据安全<br/>├─ 数据加密传输<br/>├─ 访问权限控制<br/>└─ 日志审计]

    D1 --> E[生成完整大纲JSON]
    D2 --> E
    D3 --> E

    style A fill:#fff9c4
    style E fill:#c8e6c9
```

**章节编号规则:**
- 1级标题: 一、二、三、四、五...
- 2级标题: (一)、(二)、(三)、(四)、(五)...
- 3级标题: 1、2、3、4、5...

**输出结果示例:**
```json
{
  "outline_title": "XX项目技术方案应答大纲",
  "total_chapters": 3,
  "chapters": [
    {
      "level": 1,
      "title": "数据服务需求",
      "subsections": [
        {
          "level": 2,
          "title": "运营商三要素验证",
          "evidence_needed": ["运营商合作协议", "接口测试报告"]
        }
      ]
    }
  ]
}
```

### ✍️ Step 3: 内容填充 (SSE流式生成)

```mermaid
sequenceDiagram
    participant Frontend as 前端
    participant Backend as 后端API
    participant AI as AI模型
    participant Stream as SSE流

    Frontend->>Backend: POST /generate (项目ID=52)
    Backend->>Backend: 加载大纲结构
    Backend->>Stream: 建立SSE连接

    loop 遍历每个章节
        Backend->>AI: 生成章节内容
        AI-->>Backend: 流式返回文本
        Backend->>Stream: data: {"type": "content", "text": "..."}
        Stream-->>Frontend: 实时显示内容
    end

    Backend->>Stream: data: {"type": "complete"}
    Stream-->>Frontend: 生成完成
```

**流式输出事件类型:**
```javascript
// 1. 开始事件
data: {"type": "start", "message": "开始生成技术方案..."}

// 2. 进度事件
data: {"type": "progress", "current": 1, "total": 15, "section": "一、数据服务需求"}

// 3. 内容事件 (实时推送)
data: {"type": "content", "text": "本系统支持运营商三要素验证功能..."}

// 4. 章节完成事件
data: {"type": "section_complete", "section": "（一）运营商三要素验证"}

// 5. 完成事件
data: {"type": "complete", "output_files": {"docx": "path/to/file.docx"}}
```

### 📄 Step 4: 文档生成与保存

```mermaid
flowchart TD
    A[完整内容文本] --> B[创建DOCX文档]
    B --> C[设置文档样式]
    C --> D{遍历章节}

    D --> E1[1级标题<br/>黑体三号<br/>段前1行段后0.5行]
    D --> E2[2级标题<br/>黑体小三号<br/>段前0.5行]
    D --> E3[3级标题<br/>黑体四号]
    D --> E4[正文<br/>宋体小四<br/>行距1.5倍]

    E1 --> F[生成DOCX文件]
    E2 --> F
    E3 --> F
    E4 --> F

    F --> G[保存到uploads目录]
    G --> H[生成文件下载URL]
    H --> I[保存记录到数据库]
    I --> J[返回结果给前端]

    style A fill:#fff9c4
    style F fill:#c8e6c9
    style J fill:#bbdefb
```

**文件存储结构:**
```
ai_tender_system/data/uploads/
└── technical_proposals/
    └── 2025/
        └── 12/
            └── 52/                              # 项目ID
                ├── tech_proposal_20251218_203045.docx
                ├── tech_proposal_20251218_203045.md
                └── outline_20251218_203045.json
```

## 🔑 关键数据结构

### 1. 项目信息
```python
{
    "project_id": 52,
    "project_name": "XX运营商数据服务平台",
    "bidding_unit": "某通信公司",
    "company_id": 1,
    "technical_file_path": "/path/to/tech_requirements.docx"
}
```

### 2. 需求分析结果
```python
{
    "document_summary": {
        "total_requirements": 50,
        "mandatory_count": 30,
        "optional_count": 15,
        "scoring_items": 5,
        "complexity_level": "high"
    },
    "requirement_categories": [
        {
            "category": "数据服务需求",
            "category_code": "data_service",
            "priority": "high",
            "requirements_count": 15,
            "keywords": ["三要素验证", "在网状态"],
            "key_points": [
                "运营商三要素验证（★高优先级）",
                "在网时长与状态查询（▲需提供测试报告）"
            ]
        }
    ]
}
```

### 3. 大纲结构
```python
{
    "outline_title": "XX项目技术方案应答大纲",
    "total_chapters": 4,
    "estimated_pages": 55,
    "chapters": [
        {
            "chapter_number": "1",
            "level": 1,
            "title": "数据服务需求",
            "priority": "high",
            "subsections": [
                {
                    "chapter_number": "1.1",
                    "level": 2,
                    "title": "运营商三要素验证",
                    "evidence_needed": ["运营商合作协议"],
                    "estimated_pages": 5
                }
            ]
        }
    ]
}
```

## 📊 性能指标

| 指标 | 标准模式 | 高级模式 |
|------|---------|---------|
| **需求分析** | 30-60秒 | 60-90秒 |
| **大纲生成** | 20-40秒 | 40-60秒 |
| **内容填充** | 3-5分钟 | 5-8分钟 |
| **总耗时** | 4-7分钟 | 7-10分钟 |
| **生成页数** | 30-50页 | 50-80页 |

## 🎯 关键特性

### 1. 动态需求分类 ✨
- ❌ 不再使用固定的5分类（功能性、非功能性、技术、实施、服务）
- ✅ 基于文档内容动态识别3-8个分类
- ✅ 使用行业特定术语（如"运营商数据服务"、"信创国产化"）

### 2. 灵活章节结构 📚
- ❌ 不再强制"总体设计 → 需求应答 → 技术指标 → 实施 → 服务"
- ✅ 根据需求分类动态生成章节
- ✅ 1级章节 = 需求分类名称
- ✅ 2级章节 = 具体需求点

### 3. 流式实时输出 ⚡
- ✅ SSE (Server-Sent Events) 技术
- ✅ 实时显示生成进度
- ✅ 内容逐字推送到前端
- ✅ 用户体验更好

### 4. 多模式支持 🎛️
- **standard**: 快速生成，内容简洁
- **advanced**: 深度分析，内容详尽

### 5. 智能文档匹配 🔍
- 自动从知识库匹配相关产品文档
- 推荐引用章节和截图
- 提供证明材料清单

## 🔄 错误处理流程

```mermaid
flowchart TD
    A[开始生成] --> B{检查技术文件}
    B -->|不存在| E1[错误: 技术需求文件未上传]
    B -->|存在| C{提取文本}
    C -->|失败| E2[错误: 文件格式不支持或损坏]
    C -->|成功| D{AI调用}
    D -->|超时| E3[错误: AI服务超时，请重试]
    D -->|JSON解析失败| E4[错误: AI返回格式异常]
    D -->|成功| F[继续下一步]

    E1 --> End[返回错误信息]
    E2 --> End
    E3 --> End
    E4 --> End
    F --> G[生成成功]

    style E1 fill:#ffcdd2
    style E2 fill:#ffcdd2
    style E3 fill:#ffcdd2
    style E4 fill:#ffcdd2
    style G fill:#c8e6c9
```

## 📱 前端交互流程

```mermaid
sequenceDiagram
    participant User as 用户
    participant Vue as Vue前端
    participant API as 后端API
    participant DB as 数据库

    User->>Vue: 点击"生成技术方案"
    Vue->>Vue: 显示确认对话框
    User->>Vue: 选择AI模型和方案模式
    Vue->>API: POST /api/outline/generate
    API->>DB: 查询项目信息
    DB-->>API: 返回项目数据
    API->>API: 建立SSE连接

    loop 生成过程
        API-->>Vue: SSE事件流
        Vue->>Vue: 更新进度条
        Vue->>Vue: 显示生成内容
    end

    API-->>Vue: 生成完成事件
    Vue->>Vue: 显示下载按钮
    User->>Vue: 点击下载
    Vue->>API: GET /uploads/file.docx
    API-->>User: 下载DOCX文件
```

## 🛠️ 技术栈

| 层次 | 技术 | 用途 |
|------|------|------|
| **前端** | Vue 3 + TypeScript | 用户界面 |
| **前端通信** | EventSource API | SSE接收 |
| **后端** | Python Flask | API服务 |
| **AI模型** | shihuang-gpt4o-mini | 内容生成 |
| **文档生成** | python-docx | DOCX创建 |
| **文本提取** | python-docx, PyPDF2 | 文件解析 |
| **数据库** | SQLite | 数据存储 |
| **提示词** | JSON配置文件 | 模板管理 |

---

**生成时间**: 2025-12-18
**版本**: 2.0.0
**文件位置**: `/Users/lvhe/Downloads/zhongbiao/zhongbiao/技术方案生成流程图.md`
