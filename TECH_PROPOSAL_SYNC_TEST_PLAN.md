# 技术方案同步到HITL项目测试计划

## 📅 测试日期
2025-10-11

## 🎯 测试目标
验证技术方案生成完成后，能够成功同步到HITL投标项目的"应答完成文件"标签页，并与商务应答的同步机制保持一致。

## 📝 测试前提条件

### 环境准备
1. ✅ 后端API已实现: `POST /api/tender-processing/sync-tech-proposal/<task_id>`
2. ✅ 前端调用代码已完善: `proposal-generator.js` 的 `syncToHitl()` 方法
3. ✅ HITL页面加载逻辑已配置: `loadFileInfo('completed', taskId)`
4. ✅ UI提示文案已更新

### 测试数据准备
1. 创建一个HITL投标项目（或使用现有项目）
2. 准备技术需求文档（.docx格式）
3. 准备产品文件（.docx格式）
4. 记录HITL任务ID: `_________________`

---

## 🧪 测试用例

### 测试用例1: 从HITL页面跳转到技术方案生成
**前置条件**: 已在HITL页面保存技术需求章节

**步骤**:
1. 在HITL页面，进入"技术需求"标签页
2. 确认已保存技术需求文件
3. 点击"技术方案编写"快捷按钮
4. 验证跳转到首页技术方案标签页
5. 验证技术需求文件信息自动加载

**预期结果**:
- ✅ URL包含正确的参数（hitl_task_id, technical_file_name等）
- ✅ 技术需求文件信息正确显示
- ✅ "生成技术方案"按钮可用（需上传产品文件）

**实际结果**: `_________________`

---

### 测试用例2: 生成技术方案并同步到HITL
**前置条件**: 已从HITL跳转到技术方案页面，并加载了技术需求文件

**步骤**:
1. 上传产品文件
2. 配置输出前缀（可选）
3. 点击"生成技术方案"按钮
4. 等待生成完成
5. 验证生成结果显示
6. 验证"同步到投标项目"按钮出现
7. 点击"同步到投标项目"按钮
8. 确认同步对话框
9. 等待同步完成

**预期结果**:
- ✅ 技术方案生成成功
- ✅ "同步到投标项目"按钮显示在下载区域
- ✅ 点击同步按钮后显示确认对话框
- ✅ 同步成功后按钮显示"已同步"状态
- ✅ 显示成功通知消息

**实际结果**: `_________________`

**生成的文件路径**: `_________________`

---

### 测试用例3: 在HITL页面查看同步的文件
**前置条件**: 已成功同步技术方案到HITL项目

**步骤**:
1. 返回HITL投标项目页面（或刷新）
2. 选择对应的项目（如果需要）
3. 进入"应答文件格式"标签页
4. 滚动到"应答完成文件"区域
5. 验证文件信息显示

**预期结果**:
- ✅ "应答完成文件"区域显示同步的技术方案文件
- ✅ 文件名包含"技术方案"标识
- ✅ 文件大小正确显示
- ✅ 保存时间正确显示
- ✅ "预览"和"下载"按钮可用
- ✅ 文件来源标识为"tech_proposal"

**实际结果**: `_________________`

**数据库验证（可选）**:
```sql
SELECT step1_data FROM tender_hitl_tasks WHERE hitl_task_id = '<task_id>';
```
检查 `step1_data['completed_response_file']` 字段是否包含:
- `source: "tech_proposal"`
- `filename: "技术方案_*_应答完成.docx"`
- `file_path`: 正确的目标路径
- `file_size`: 正确的文件大小
- `saved_at`: 正确的时间戳

---

### 测试用例4: 文件预览功能
**前置条件**: HITL页面已显示应答完成文件

**步骤**:
1. 点击"预览"按钮
2. 等待预览模态框加载
3. 验证文档内容显示

**预期结果**:
- ✅ 预览模态框正确打开
- ✅ 文档内容正确渲染（使用docx-preview）
- ✅ 文档格式保持原样（字体、样式等）

**实际结果**: `_________________`

---

### 测试用例5: 文件下载功能
**前置条件**: HITL页面已显示应答完成文件

**步骤**:
1. 点击"下载"按钮
2. 验证文件下载
3. 在本地打开下载的文件
4. 验证文件内容完整性

**预期结果**:
- ✅ 文件成功下载
- ✅ 文件名格式正确
- ✅ 文件可以正常打开（使用Word或WPS）
- ✅ 文件内容与原技术方案一致

**实际结果**: `_________________`

---

### 测试用例6: 多次同步（覆盖）
**前置条件**: 已同步过一次技术方案

**步骤**:
1. 重新生成一个技术方案（修改部分内容或重新生成）
2. 再次点击"同步到投标项目"按钮
3. 确认覆盖提示
4. 同步完成后返回HITL页面
5. 验证文件信息更新

**预期结果**:
- ✅ 允许多次同步
- ✅ 新文件覆盖旧文件
- ✅ HITL页面显示最新的文件信息
- ✅ 文件时间戳更新

**实际结果**: `_________________`

---

### 测试用例7: 商务应答与技术方案共存
**前置条件**: 已分别完成商务应答和技术方案生成

**步骤**:
1. 先同步商务应答文件到HITL项目
2. 验证HITL页面显示商务应答文件
3. 再同步技术方案文件到同一HITL项目
4. 验证文件是否被覆盖
5. 检查数据库中的 `source` 字段

**预期结果**:
- ✅ 后同步的文件会覆盖先同步的文件
- ✅ `source` 字段正确标识文件来源
- ✅ 两种来源的文件可以独立同步

**实际结果**: `_________________`

**设计建议**: 如果需要同时保留两种文件，可以考虑:
- 使用数组存储多个文件: `completed_response_files: []`
- 或者使用不同的字段名: `completed_business_response` 和 `completed_tech_proposal`

---

## 🐛 边界条件测试

### 边界用例1: 无效的HITL任务ID
**步骤**: 手动构造一个不存在的任务ID并尝试同步

**预期结果**:
- ✅ 后端返回404错误
- ✅ 前端显示错误提示
- ✅ 按钮恢复可用状态

**实际结果**: `_________________`

---

### 边界用例2: 源文件不存在
**步骤**:
1. 删除已生成的技术方案文件
2. 尝试同步该文件

**预期结果**:
- ✅ 后端返回404错误
- ✅ 前端显示"源文件不存在"错误

**实际结果**: `_________________`

---

### 边界用例3: 未从HITL跳转（无task_id）
**步骤**: 直接在技术方案页面生成文件（不是从HITL跳转）

**预期结果**:
- ✅ "同步到投标项目"按钮不显示
- ✅ 只显示常规的下载按钮

**实际结果**: `_________________`

---

### 边界用例4: 数据库写入失败
**步骤**: （需要模拟数据库锁定或权限问题）

**预期结果**:
- ✅ 后端返回500错误
- ✅ 前端显示错误提示
- ✅ 日志记录详细错误信息

**实际结果**: `_________________`

---

## ✅ 验收检查表

### 功能完整性
- [ ] 技术方案生成后显示同步按钮
- [ ] 同步按钮正确调用API
- [ ] 文件成功复制到目标目录
- [ ] 数据库正确更新
- [ ] HITL页面正确显示文件信息
- [ ] 预览功能正常工作
- [ ] 下载功能正常工作

### 数据一致性
- [ ] `step1_data['completed_response_file']` 结构正确
- [ ] `source` 字段为 `"tech_proposal"`
- [ ] 文件路径、大小、时间戳准确
- [ ] 支持多次同步（覆盖）

### 用户体验
- [ ] 按钮状态反馈清晰（加载中、成功、失败）
- [ ] 错误提示友好明确
- [ ] 空状态提示包含技术方案说明
- [ ] 页面跳转流畅

### 代码质量
- [ ] 后端API有适当的错误处理
- [ ] 前端有完善的异常捕获
- [ ] 日志记录充分
- [ ] 代码风格与现有代码一致

---

## 📊 测试结果总结

### 成功率
- 通过用例数: `_____ / 11`
- 失败用例数: `_____`
- 阻塞问题数: `_____`

### 发现的问题
1. `_________________`
2. `_________________`
3. `_________________`

### 改进建议
1. `_________________`
2. `_________________`
3. `_________________`

### 测试结论
- [ ] ✅ 通过测试，功能正常
- [ ] ⚠️ 部分通过，有小问题需修复
- [ ] ❌ 未通过，有重大问题需解决

---

## 📝 测试执行记录

### 测试人员
姓名: `_________________`

### 测试时间
开始时间: `_________________`
结束时间: `_________________`

### 测试环境
- 操作系统: `_________________`
- 浏览器: `_________________`
- Python版本: `_________________`
- Flask端口: `_________________`

### 签名确认
`_________________`

---

## 🔗 相关文档链接

- 后端API实现: [app.py:3009-3120](ai_tender_system/web/app.py#L3009-L3120)
- 前端同步函数: [proposal-generator.js:768-835](ai_tender_system/web/static/js/pages/index/proposal-generator.js#L768-L835)
- HITL加载逻辑: [tender_processing_hitl.html:1153-1159](ai_tender_system/web/templates/tender_processing_hitl.html#L1153-L1159)
- 配置对象: [tender-processing-step3-enhanced.js:1508-1520](ai_tender_system/web/static/js/pages/tender-processing-step3-enhanced.js#L1508-L1520)
