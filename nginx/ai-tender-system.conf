# AI智能标书生成平台 - Nginx配置
# 部署位置: /etc/nginx/sites-available/ai-tender-system
#
# 使用方法:
#   1. sudo cp nginx/ai-tender-system.conf /etc/nginx/sites-available/
#   2. sudo ln -sf /etc/nginx/sites-available/ai-tender-system /etc/nginx/sites-enabled/
#   3. sudo nginx -t
#   4. sudo systemctl reload nginx

server {
    listen 80;
    server_name 8.140.21.235;

    # 访问日志
    access_log /var/log/nginx/ai-tender-system-access.log;
    error_log /var/log/nginx/ai-tender-system-error.log;

    # 最大上传文件大小 (标书文档可能较大)
    client_max_body_size 100M;

    # ==================== Vue 前端应用 (根路径) ====================
    location / {
        root /var/www/ai-tender-system/ai_tender_system/web;

        # Vue Router的History模式支持
        # 尝试查找文件，如果不存在则返回index.html，让Vue Router处理路由
        try_files /static/dist$uri /static/dist$uri/ /static/dist/index.html;

        # 静态资源缓存优化
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            root /var/www/ai-tender-system/ai_tender_system/web;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # HTML文件不缓存
        location ~* \.html$ {
            root /var/www/ai-tender-system/ai_tender_system/web;
            expires -1;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }
    }

    # ==================== Flask API (后端接口) ====================
    location /api {
        proxy_pass http://localhost:8110;
        proxy_http_version 1.1;

        # 请求头转发
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket支持(如果需要)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 超时设置(标书处理可能耗时较长)
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;

        # 禁用缓存
        proxy_buffering off;
    }

    # ==================== 静态文件直接访问 (兼容) ====================
    # 允许直接访问 /static/dist/ 路径
    location /static/dist/ {
        alias /var/www/ai-tender-system/ai_tender_system/web/static/dist/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ==================== 旧版Flask前端 (兼容,可选) ====================
    # 如果需要保留旧版Flask模板页面,取消注释以下配置
    # location /old {
    #     proxy_pass http://localhost:8110;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    # }

    # ==================== 健康检查 ====================
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ==================== 错误页面 ====================
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;

    location = /404.html {
        root /var/www/ai-tender-system/ai_tender_system/web/static/dist;
        internal;
    }

    location = /50x.html {
        root /var/www/ai-tender-system/ai_tender_system/web/static/dist;
        internal;
    }

    # ==================== 安全配置 ====================
    # 隐藏Nginx版本号
    server_tokens off;

    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# ==================== HTTPS配置 (可选,推荐生产环境使用) ====================
# 如果有SSL证书,取消注释以下配置
# server {
#     listen 443 ssl http2;
#     server_name 8.140.21.235;
#
#     ssl_certificate /etc/nginx/ssl/ai-tender-system.crt;
#     ssl_certificate_key /etc/nginx/ssl/ai-tender-system.key;
#
#     # SSL安全配置
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     # 其他配置与HTTP相同...
# }
#
# # HTTP自动跳转HTTPS
# server {
#     listen 80;
#     server_name 8.140.21.235;
#     return 301 https://$server_name$request_uri;
# }
