# 标书智能处理 HITL 流程使用指南

## 概述

本系统采用**三步人工确认（HITL）流程**，确保标书处理结果的100%准确性：

1. **步骤1：章节选择** - 排除无关内容（如合同条款）
2. **步骤2：AI筛选复核** - 复核被AI过滤的文本块
3. **步骤3：要求提取编辑** - 编辑和完善最终要求

---

## 访问路径

**新版 HITL 流程页面**：`http://localhost:8080/tender_processing_hitl`

---

## 步骤1：章节选择

### 功能说明
通过解析 Word 文档的目录结构，让用户选择需要处理的章节，避免处理无关内容。

### 操作流程

1. **上传文档**
   - 输入项目ID（如：1）
   - 选择标书文档（支持 .docx、.doc）
   - 点击"解析文档结构"

2. **查看章节树**
   - ✅ 绿色：系统自动推荐选中（包含技术、商务等关键词）
   - ❌ 红色：系统推荐跳过（合同条款、格式要求等）
   - ⚪ 白色：默认状态，由用户决定

3. **章节操作**
   - **预览**：点击"预览"按钮查看章节前5行内容
   - **搜索**：使用搜索框快速定位章节
   - **批量操作**：
     - "全选" - 选中所有未禁用的章节
     - "全不选" - 取消所有选择
     - "仅选技术章节" - 快速选择包含"技术"的章节
     - "排除合同条款" - 快速排除包含"合同"的章节

4. **确认选择**
   - 查看统计信息（已选章节数、字数、预估成本）
   - 点击"确认选择并继续"进入步骤2

### 关键数据

| 统计项 | 说明 |
|--------|------|
| 总章节数 | 文档中识别到的所有章节 |
| 已选择 | 当前选中的章节数量 |
| 选中字数 | 选中章节的总字数 |
| 预估成本 | 基于字数估算的处理成本（假设1000字=$0.002）|

---

## 步骤2：AI筛选复核

### 功能说明
AI 对文本块进行初步筛选，过滤描述性文本，用户复核低置信度的结果。

### 操作流程

1. **查看筛选结果**
   - 系统显示所有被AI标记为"非要求"的文本块
   - 每个块显示：
     - 置信度百分比
     - AI判断理由
     - 原文内容（截断至300字）

2. **过滤器切换**
   - **全部**：显示所有被过滤的块
   - **高置信度**：AI确信是非要求的块（置信度≥70%）
   - **低置信度**：需要重点复核的块（置信度<70%）

3. **恢复误判**
   - **单个恢复**：点击文本块右上角的"恢复"按钮
   - **批量恢复**：
     1. 勾选多个文本块
     2. 点击"恢复选中的 (N)"按钮
   - 已恢复的块会标记为绿色背景，并显示"已恢复"徽章

4. **确认并继续**
   - 点击"确认并继续步骤3"进入要求编辑阶段

### 提示

- 🔍 **低置信度块需重点关注**：这些可能包含隐藏的要求
- ⚠️ **表格内容容易误判**：建议查看表格类型的文本块
- ✅ **高置信度块可信任**：通常可以放心跳过

---

## 步骤3：要求提取与编辑

### 功能说明
以可编辑表格形式展示提取的要求，支持在线编辑、新增、删除。

### 表格字段

| 字段 | 类型 | 说明 |
|------|------|------|
| ID | 只读 | 要求的唯一标识符 |
| 类型 | 下拉选择 | 强制性 / 可选 / 加分项 |
| 分类 | 下拉选择 | 资质 / 技术 / 商务 / 服务 |
| 子分类 | 文本输入 | 如：ISO证书、性能指标等 |
| 详细描述 | 多行文本 | 要求的具体内容 |
| 优先级 | 下拉选择 | 高 / 中 / 低 |
| 操作 | 按钮 | 删除按钮 |

### 操作流程

1. **查看提取结果**
   - 系统显示AI提取的所有要求
   - 查看统计信息（总要求数、强制性数量、加分项数量）

2. **类型过滤**
   - 点击顶部按钮：全部 / 强制性 / 加分项 / 可选
   - 快速定位特定类型的要求

3. **编辑要求**
   - **修改字段**：直接点击下拉框或输入框修改
   - **修改提示**：修改后的字段会显示黄色背景
   - **实时记录**：所有修改会自动记录到待保存列表

4. **新增要求**
   - 点击"新增要求"按钮
   - 在表格顶部插入一行空白记录
   - 填写所有必要字段

5. **删除要求**
   - 点击行末的"删除"按钮
   - 确认删除操作

6. **保存并完成**
   - 页面顶部按钮会显示"有 N 项未保存的修改"（黄色警告）
   - 点击"保存并完成"提交所有修改
   - 保存成功后显示完成消息

7. **导出结果**
   - **导出Excel**：点击"导出Excel"下载当前数据
   - **导出最终结果**：完成后点击"导出最终结果"

---

## 技术架构

### 后端 API

| 端点 | 方法 | 功能 |
|------|------|------|
| `/api/tender-processing/parse-structure` | POST | 解析文档结构 |
| `/api/tender-processing/select-chapters` | POST | 提交章节选择 |
| `/api/tender-processing/filtered-blocks/<task_id>` | GET | 获取被过滤的块 |
| `/api/tender-processing/restore-blocks` | POST | 恢复误判的块 |
| `/api/tender-processing/requirements/<id>` | PATCH | 编辑单个要求 |
| `/api/tender-processing/requirements/batch` | POST | 批量操作要求 |
| `/api/tender-processing/export/<project_id>` | GET | 导出Excel |

### 前端模块

| 文件 | 功能 |
|------|------|
| `tender-processing-step1.js` | 章节选择管理器 |
| `tender-processing-step2.js` | 筛选复核管理器 |
| `tender-processing-step3.js` | 要求编辑管理器 |
| `tender-processing-hitl.css` | HITL流程专用样式 |
| `tender_processing_hitl.html` | 主页面模板 |

### 数据库表

| 表名 | 用途 |
|------|------|
| `tender_document_chapters` | 存储章节信息和选择状态 |
| `tender_filter_review` | 存储筛选复核记录 |
| `tender_requirements_draft` | 存储要求编辑草稿 |
| `tender_hitl_tasks` | 跨步骤状态追踪 |
| `tender_user_actions` | 用户操作审计日志 |

---

## 常见问题

### Q1: 章节树为空怎么办？
**A**: 检查文档是否使用了标准的标题样式（Heading 1/2/3）。如果文档没有使用样式，系统可能无法识别章节结构。

### Q2: 为什么某些章节无法选择？
**A**: 被标记为"推荐跳过"的章节（如合同条款）会自动禁用复选框。如需选择，可以修改后端黑名单配置。

### Q3: 如何调整自动推荐的规则？
**A**: 修改 `structure_parser.py` 中的 `WHITELIST_KEYWORDS` 和 `BLACKLIST_KEYWORDS`。

### Q4: 步骤2的置信度是如何计算的？
**A**: 置信度由AI模型输出，表示其对"这段文本不是要求"的确信程度。≥70%为高置信度。

### Q5: 如何撤销已保存的修改？
**A**: 当前版本不支持撤销已保存的修改。建议在保存前仔细检查，或使用Excel导出后进行备份。

---

## 最佳实践

### 📋 步骤1建议
- ✅ 优先排除：合同条款、文件格式要求、附件模板
- ✅ 重点关注：技术要求、商务要求、评分标准
- ✅ 利用搜索：快速定位关键章节

### 🔍 步骤2建议
- ✅ 重点复核低置信度块（可能包含隐藏要求）
- ✅ 检查表格内容（容易误判）
- ✅ 对于高置信度块，可快速浏览确认

### ✏️ 步骤3建议
- ✅ 先按类型过滤，逐类检查
- ✅ 统一术语（如"投标人"vs"供应商"）
- ✅ 补充遗漏的隐含要求
- ✅ 定期保存，避免丢失数据
- ✅ 导出Excel作为备份

---

## 系统性能

| 指标 | 预期值 |
|------|--------|
| 文档解析速度 | ~5秒 / 100页 |
| 章节识别准确率 | >95% |
| AI筛选过滤率 | 70-85% |
| 要求提取准确率 | >90% |
| 成本估算 | $0.002 / 1000字 |

---

## 更新日志

### v1.0.0 (2025-10-02)
- ✨ 初始版本发布
- ✨ 完整的三步HITL流程
- ✨ 文档结构自动解析
- ✨ AI筛选复核机制
- ✨ 可编辑表格界面
- ✨ Excel导出功能

---

## 技术支持

如遇问题，请检查：
1. 浏览器控制台（F12）的错误信息
2. 后端日志：`ai_tender_system/data/logs/web_app.log`
3. 数据库状态：检查表是否正确创建

**反馈渠道**：提交 GitHub Issue
