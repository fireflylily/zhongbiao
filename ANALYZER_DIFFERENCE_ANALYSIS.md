# 智能分析器使用差异分析报告

## 问题

为什么方法2（大纲级别识别）和方法3（精确匹配）对同一文档的字数统计差异很大？

**哈银消金文档**：
- 方法2: 33,744字
- 方法3: 21,218字
- **差异: +12,526字 (+59%)**

## 调查结论

### 是否使用相同的智能分析器？

**✅ 是的**，两个方法都使用完全相同的智能分析器：

- **方法2** (line 386-387): `analyzer.analyze_toc_hierarchy_contextual(toc_like_items)`
- **方法3** (line 1669-1670): `analyzer.analyze_toc_hierarchy_contextual(toc_items)`

### 那为什么结果不同？

**❌ 输入数据不同！**

虽然使用的是同一个分析器方法，但传入的数据完全不同：

#### 方法2的输入（71个条目）

```
1. [Level 1] 目录
2. [Level 1] 第一部分 招标公告
3. [Level 2] 项目名称：
4. [Level 2] 招标编号：
5. [Level 2] GXTC-C-251590031
...
14. [Level 1] 第二部分 投标人须知前附表及投标人须知
15. [Level 2] 投标人须知前附表
16. [Level 2] 投标人须知
17. [Level 2] 一、说  明
18. [Level 3] 招标人及合格的投标人
...
49. [Level 1] 评标办法                    👈 关键：没有"第三部分"前缀
50. [Level 1] 第四部分 合同主要条款及格式
...
```

**来源**: 从文档中提取所有带有Outline Level或Heading样式的段落

#### 方法3的输入（6个条目）

```
1. [Level 1] 第一部分 招标公告
2. [Level 1] 第二部分 投标人须知前附表及投标人须知
3. [Level 1] 第三部分 评标办法              👈 关键：有完整"第三部分"前缀
4. [Level 1] 第四部分 合同主要条款及格式
5. [Level 1] 第五部分 采购需求书
6. [Level 1] 第六部分 附  件
```

**来源**: 从文档的"目录"部分解析出来的TOC条目

## 智能分析器的行为

### 对方法2的71个条目

智能分析器看到：
- 有"第X部分"格式的1级章节
- 也有很多没有"第X部分"格式的1级、2级、3级标题
- 其中包括一个单独的"评标办法"（Level 1）

**分析器的判断**：
```
⚠️  '评标办法' (Level 1) -> 降级为 Level 3
```

原因：
1. 前面有"第二部分 投标人须知前附表及投标人须知"（Level 1）
2. 后面有"第四部分 合同主要条款及格式"（Level 1）
3. 中间插入一个没有"第X部分"格式的"评标办法"
4. 分析器认为这是"第二部分"的一个子章节，降级为3级

### 对方法3的6个条目

智能分析器看到：
- 6个条目都是"第X部分"格式
- 都是Level 1
- 命名规范、层级统一

**分析器的判断**：
```
✅ 所有条目保持 Level 1（无修正）
```

## 导致的字数差异

### 方法2的段落范围

```
第二部分 投标人须知前附表及投标人须知
├─ 段落 104 - 258  (因为"评标办法"被降级为3级，成为其子章节)
│  └─ 包含了"评标办法"的内容
└─ 字数: 更多

评标办法 (3级)
└─ 段落 259 - 266 (作为"第二部分"的子章节)
```

### 方法3的段落范围

```
第二部分 投标人须知前附表及投标人须知
└─ 段落 104 - 258  (在"第三部分"之前结束)
    字数: 较少

第三部分 评标办法 (1级)
└─ 段落 259 - 266 (独立的一级章节)
```

## 验证

运行 `debug_analyzer_input.py` 和 `test_analyzer_output.py` 可以验证：

```bash
python3 debug_analyzer_input.py
python3 test_analyzer_output.py
```

输出显示：
- 方法2: '评标办法' 被分析器从Level 1降级为Level 3
- 方法3: '第三部分 评标办法' 保持Level 1

## 根本原因

**段落259的问题**：

```python
# 文档中的实际情况
段落259: "评标办法"
样式: Heading 1
Outline Level: None (未设置)
```

这个段落：
- **在目录中**: 显示为"第三部分 评标办法"（完整前缀）
- **在正文中**: 只显示为"评标办法"（没有前缀）

所以：
- 方法2提取正文标题时，只能提取到"评标办法"（4个字）
- 方法3解析目录时，提取到"第三部分 评标办法"（8个字，包含部分标记）

智能分析器基于上下文判断：
- 看到"评标办法"（没有"第X部分"）→ 不确定是否为顶级章节 → 降级
- 看到"第三部分 评标办法"（有"第X部分"）→ 明确是顶级章节 → 保持1级

## 总结

| 项目 | 方法2 | 方法3 |
|------|-------|-------|
| **分析器** | `analyze_toc_hierarchy_contextual()` | `analyze_toc_hierarchy_contextual()` |
| **是否相同** | ✅ 相同 | ✅ 相同 |
| **输入来源** | 正文中所有标题段落 | 目录中的TOC条目 |
| **输入条目数** | 71个 | 6个 |
| **"评标办法"标题** | "评标办法"（无前缀） | "第三部分 评标办法"（有前缀） |
| **分析器输出层级** | 3级（降级） | 1级（保持） |
| **第二部分段落范围** | 104-258（包含评标） | 104-258（不包含评标） |
| **总字数** | 33,744字 | 21,218字 |

**结论**: 虽然使用相同的智能分析器，但因为输入数据不同（正文标题 vs 目录条目），导致分析器对"评标办法"的层级判断不同，进而导致段落范围和字数统计的差异。
