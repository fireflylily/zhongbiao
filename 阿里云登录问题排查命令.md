# é˜¿é‡Œäº‘ç”Ÿäº§ç¯å¢ƒé—®é¢˜æ’æŸ¥å‘½ä»¤

## ğŸ“‹ æ¡ˆä¾‹é™„ä»¶API 400é”™è¯¯æ’æŸ¥

### é—®é¢˜æè¿°
å‰ç«¯è¯·æ±‚ `/api/case_library/cases/23/attachments` è¿”å› 400 é”™è¯¯ã€‚

---

## 1ï¸âƒ£ æŸ¥çœ‹åº”ç”¨æ—¥å¿—ï¼ˆæœ€é‡è¦ï¼ï¼‰

### æ–¹æ³•ä¸€ï¼šæŸ¥çœ‹æ¡ˆä¾‹åº“ç›¸å…³æ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹ä¸»åº”ç”¨æ—¥å¿—
tail -f /var/www/ai-tender-system/ai_tender_system/data/logs/ai_tender_system.log | grep -E "case_library|é™„ä»¶"

# æŸ¥çœ‹æœ€è¿‘çš„æ¡ˆä¾‹åº“é”™è¯¯
grep -i "case_library\|attachment\|æ¡ˆä¾‹\|é™„ä»¶" /var/www/ai-tender-system/ai_tender_system/data/logs/ai_tender_system.log | tail -n 50
```

### æ–¹æ³•äºŒï¼šæŸ¥çœ‹Supervisoræ—¥å¿—
```bash
# æŸ¥çœ‹supervisorçš„åº”ç”¨é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/supervisor/ai-tender-system-stderr.log

# æŸ¥çœ‹supervisorçš„åº”ç”¨è¾“å‡ºæ—¥å¿—
sudo tail -f /var/log/supervisor/ai-tender-system-stdout.log
```

### æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯ï¼ˆä¸€æ¬¡æ€§æŸ¥çœ‹ï¼Œä¸å®æ—¶ï¼‰
```bash
# æŸ¥çœ‹æœ€å100è¡Œä¸»æ—¥å¿—
tail -n 100 /var/www/ai-tender-system/ai_tender_system/data/logs/ai_tender_system.log

# æœç´¢åŒ…å«"é”™è¯¯"çš„æ—¥å¿—è¡Œ
grep -i "error\|é”™è¯¯\|å¤±è´¥" /var/www/ai-tender-system/ai_tender_system/data/logs/ai_tender_system.log | tail -n 50
```

---

## 2ï¸âƒ£ è¿è¡Œè¯Šæ–­è„šæœ¬

```bash
# ä¸Šä¼ è¯Šæ–­è„šæœ¬åˆ°æœåŠ¡å™¨ (å…ˆåœ¨æœ¬åœ°æ‰§è¡Œ)
scp diagnose_case_23.py root@ä½ çš„æœåŠ¡å™¨IP:/var/www/ai-tender-system/

# SSHç™»å½•åˆ°æœåŠ¡å™¨
ssh root@ä½ çš„æœåŠ¡å™¨IP

# è¿è¡Œè¯Šæ–­è„šæœ¬
cd /var/www/ai-tender-system
source venv/bin/activate
python3 diagnose_case_23.py
deactivate
```

## 3ï¸âƒ£ æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶

```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db

# æ£€æŸ¥æ¡ˆä¾‹ID 23æ˜¯å¦å­˜åœ¨
sqlite3 /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db "SELECT * FROM case_studies WHERE case_id = 23;"

# æ£€æŸ¥æ¡ˆä¾‹23çš„é™„ä»¶
sqlite3 /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db "SELECT * FROM case_attachments WHERE case_id = 23;"

# æ£€æŸ¥è¡¨ç»“æ„ï¼ˆç¡®è®¤converted_imagesç­‰å­—æ®µæ˜¯å¦å­˜åœ¨ï¼‰
sqlite3 /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db "PRAGMA table_info(case_attachments);"
```

**é¢„æœŸè¾“å‡ºï¼š**
- æ•°æ®åº“æ–‡ä»¶åº”è¯¥å­˜åœ¨ä¸”å¤§å° > 0
- æ¡ˆä¾‹ID 23åº”è¯¥å­˜åœ¨
- åº”è¯¥èƒ½æŸ¥è¯¢åˆ°é™„ä»¶æ•°æ®ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰
- case_attachmentsè¡¨åº”è¯¥åŒ…å« converted_images, conversion_info ç­‰å­—æ®µ

---

## 4ï¸âƒ£ æµ‹è¯•APIç«¯ç‚¹

```bash
# ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šæµ‹è¯•è·å–é™„ä»¶åˆ—è¡¨çš„API
curl -X GET "http://localhost:8000/api/case_library/cases/23/attachments" \
  -H "Content-Type: application/json" \
  -v

# å¦‚æœéœ€è¦è®¤è¯tokenï¼Œä»æµè§ˆå™¨è·å–tokenåä½¿ç”¨
curl -X GET "http://localhost:8000/api/case_library/cases/23/attachments" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -v
```

**é¢„æœŸæˆåŠŸè¾“å‡ºï¼š**
```json
{
  "success": true,
  "data": [...]
}
```

**å¦‚æœè¿”å›400é”™è¯¯ï¼ŒæŸ¥çœ‹å“åº”ä½“ä¸­çš„é”™è¯¯ä¿¡æ¯**

---

## 6ï¸âƒ£ å¯èƒ½çš„é—®é¢˜åŸå› å’Œè§£å†³æ–¹æ¡ˆ

### åŸå› 1: æ•°æ®åº“å­—æ®µç¼ºå¤±
å¦‚æœæ•°æ®åº“ç¼ºå°‘ `converted_images` ç­‰æ–°å­—æ®µï¼Œå¯èƒ½å¯¼è‡´æŸ¥è¯¢å¤±è´¥ã€‚

**è§£å†³æ–¹æ¡ˆ**: è¿è¡Œæ•°æ®åº“è¿ç§»
```bash
cd /var/www/ai-tender-system
sqlite3 ai_tender_system/data/knowledge_base.db < ai_tender_system/database/migrate_case_attachments_add_conversion_fields.sql
```

### åŸå› 2: æƒé™é—®é¢˜
Flaskåº”ç”¨å¯èƒ½æ²¡æœ‰æƒé™è®¿é—®æ•°æ®åº“æ–‡ä»¶ã€‚

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥æ–‡ä»¶æƒé™
```bash
ls -la /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db
# ç¡®ä¿Flaskè¿›ç¨‹ç”¨æˆ·æœ‰è¯»å†™æƒé™
sudo chown www-data:www-data /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db
sudo chmod 664 /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db
```

### åŸå› 3: è·¯ç”±æ³¨å†Œé—®é¢˜
APIè“å›¾å¯èƒ½æ²¡æœ‰æ­£ç¡®æ³¨å†Œåˆ°Flaskåº”ç”¨ã€‚

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥ `app.py` ä¸­æ˜¯å¦æ­£ç¡®æ³¨å†Œäº†è“å›¾
```bash
grep "case_library" /var/www/ai-tender-system/ai_tender_system/web/app.py
```
åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š
```python
from modules.case_library.api import case_library_api
app.register_blueprint(case_library_api.get_blueprint())
```

### åŸå› 4: URLæ ¼å¼é—®é¢˜
é”™è¯¯ä¿¡æ¯æ˜¾ç¤º `/api/case_library/cases/23/attachments:1`ï¼Œæœ«å°¾çš„ `:1` å¯èƒ½æ˜¯é—®é¢˜æ‰€åœ¨ã€‚

**è§£å†³æ–¹æ¡ˆ**: æ£€æŸ¥å‰ç«¯æ„é€ çš„URLæ˜¯å¦æ­£ç¡®ï¼ŒæŸ¥çœ‹æµè§ˆå™¨Networkæ ‡ç­¾

---

## 7ï¸âƒ£ æ£€æŸ¥Nginxé…ç½®å’Œæ—¥å¿—ï¼ˆå¦‚æœæœ‰ï¼‰

```bash
# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/error.log

# æŸ¥çœ‹Nginxè®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/access.log

# æµ‹è¯•Nginxé…ç½®
sudo nginx -t
```

---

## ğŸš¨ ç´§æ€¥ä¿®å¤æ­¥éª¤

### å¦‚æœæ˜¯æ•°æ®åº“å­—æ®µç¼ºå¤±ï¼š
```bash
# 1. è¿è¡Œè¿ç§»è„šæœ¬
cd /var/www/ai-tender-system
sqlite3 ai_tender_system/data/knowledge_base.db < ai_tender_system/database/migrate_case_attachments_add_conversion_fields.sql

# 2. éªŒè¯å­—æ®µæ˜¯å¦æ·»åŠ æˆåŠŸ
sqlite3 ai_tender_system/data/knowledge_base.db "PRAGMA table_info(case_attachments);"

# 3. é‡å¯åº”ç”¨
sudo supervisorctl restart ai-tender-system

# 4. æµ‹è¯•API
curl -X GET "http://localhost:8000/api/case_library/cases/23/attachments"
```

### å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼š
```bash
# ä¿®å¤æ•°æ®åº“æ–‡ä»¶æƒé™
sudo chown www-data:www-data /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db
sudo chmod 664 /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db

# é‡å¯æœåŠ¡
sudo supervisorctl restart ai-tender-system
```

### å¦‚æœæ˜¯è·¯ç”±æœªæ³¨å†Œï¼š
æ£€æŸ¥å¹¶ä¿®æ”¹ `/var/www/ai-tender-system/ai_tender_system/web/app.py`ï¼Œç¡®ä¿åŒ…å«ï¼š
```python
from modules.case_library.api import case_library_api
app.register_blueprint(case_library_api.get_blueprint())
```

ç„¶åé‡å¯æœåŠ¡ï¼š
```bash
sudo supervisorctl restart ai-tender-system
```

---

## ğŸ“Š ä¸€é”®è¯Šæ–­è„šæœ¬

åˆ›å»ºå¹¶è¿è¡Œä»¥ä¸‹è¯Šæ–­è„šæœ¬ï¼š

```bash
# åˆ›å»ºè¯Šæ–­è„šæœ¬
cat > /tmp/diagnose.sh << 'EOF'
#!/bin/bash
echo "======================================"
echo "ğŸ” AIæ ‡ä¹¦ç³»ç»Ÿç™»å½•é—®é¢˜è¯Šæ–­"
echo "======================================"
echo ""

echo "1ï¸âƒ£ æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶..."
if [ -f /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db ]; then
    echo "âœ“ æ•°æ®åº“æ–‡ä»¶å­˜åœ¨"
    ls -lh /var/www/ai-tender-system/ai_tender_system/data/knowledge_base.db
else
    echo "âœ— æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼"
fi
echo ""

echo "2ï¸âƒ£ æ£€æŸ¥bcrypt..."
cd /var/www/ai-tender-system
source venv/bin/activate
if python3 -c "import bcrypt" 2>/dev/null; then
    echo "âœ“ bcryptå·²å®‰è£…"
    python3 -c "import bcrypt; print('   ç‰ˆæœ¬:', bcrypt.__version__)"
else
    echo "âœ— bcryptæœªå®‰è£…ï¼"
fi
deactivate
echo ""

echo "3ï¸âƒ£ æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
sudo supervisorctl status ai-tender-system
echo ""

echo "4ï¸âƒ£ æŸ¥çœ‹æœ€è¿‘çš„é”™è¯¯æ—¥å¿—..."
echo "--- Webè®¤è¯æ—¥å¿—ï¼ˆæœ€å20è¡Œï¼‰---"
tail -n 20 /var/www/ai-tender-system/ai_tender_system/data/logs/web.auth.log 2>/dev/null || echo "æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
echo ""

echo "5ï¸âƒ£ æµ‹è¯•ç™»å½•æ¥å£..."
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}' \
  -s | python3 -m json.tool 2>/dev/null || echo "æ¥å£æµ‹è¯•å¤±è´¥"
echo ""

echo "======================================"
echo "è¯Šæ–­å®Œæˆï¼"
echo "======================================"
EOF

# è¿è¡Œè¯Šæ–­
bash /tmp/diagnose.sh
```

---

## ğŸ’¡ æŸ¥çœ‹æ—¥å¿—çš„æœ€ä½³å®è·µ

### å®æ—¶ç›‘æ§ç™»å½•å°è¯•
æ‰“å¼€ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œè¿è¡Œï¼š
```bash
tail -f /var/www/ai-tender-system/ai_tender_system/data/logs/web.auth.log
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­å°è¯•ç™»å½•ï¼Œä½ ä¼šå®æ—¶çœ‹åˆ°ï¼š
- "å¼€å§‹å¤„ç†ç”¨æˆ· admin çš„ç™»å½•è¯·æ±‚"
- "æ•°æ®åº“è·¯å¾„: ..."
- "æ•°æ®åº“è¿æ¥æˆåŠŸ"
- "æ•°æ®åº“æŸ¥è¯¢å®Œæˆï¼Œæ‰¾åˆ°ç”¨æˆ·: True/False"
- å¦‚æœæœ‰é”™è¯¯ï¼Œä¼šçœ‹åˆ°å®Œæ•´çš„é”™è¯¯å †æ ˆ

---

## ğŸ“ éœ€è¦æä¾›çš„ä¿¡æ¯

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **è¯Šæ–­è„šæœ¬çš„å®Œæ•´è¾“å‡º**
2. **Webè®¤è¯æ—¥å¿—çš„æœ€å50è¡Œ**ï¼š
   ```bash
   tail -n 50 /var/www/ai-tender-system/ai_tender_system/data/logs/web.auth.log
   ```
3. **Supervisoré”™è¯¯æ—¥å¿—**ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š
   ```bash
   sudo tail -n 50 /var/log/supervisor/ai-tender-system-stderr.log
   ```

---

## âœ… éƒ¨ç½²åå¿…åšæ£€æŸ¥

æ¯æ¬¡éƒ¨ç½²åï¼Œè¯·è¿è¡Œï¼š
```bash
# 1. é‡å¯æœåŠ¡
sudo supervisorctl restart ai-tender-system

# 2. æ£€æŸ¥çŠ¶æ€
sudo supervisorctl status ai-tender-system

# 3. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
tail -n 100 /var/www/ai-tender-system/ai_tender_system/data/logs/ai_tender_system.log

# 4. æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://localhost:8000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username": "admin", "password": "admin123"}'
```

---

## ğŸ”§ å¸¸è§é—®é¢˜å¿«é€Ÿä¿®å¤

| é—®é¢˜ç—‡çŠ¶ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| 500é”™è¯¯ + "database file not exist" | æ•°æ®åº“æ–‡ä»¶ç¼ºå¤± | ä¸Šä¼ æ•°æ®åº“æ–‡ä»¶ï¼ˆè§æ­¥éª¤6ï¼‰ |
| 500é”™è¯¯ + "ModuleNotFoundError: No module named 'bcrypt'" | bcryptæœªå®‰è£… | `pip install bcrypt` å¹¶é‡å¯ |
| 502é”™è¯¯ | åº”ç”¨æœªå¯åŠ¨ | `sudo supervisorctl restart ai-tender-system` |
| 401é”™è¯¯ | å¯†ç é”™è¯¯ | ç¡®è®¤ä½¿ç”¨ `admin123` ä½œä¸ºå¯†ç  |
| æ— å“åº” | Nginxæˆ–é˜²ç«å¢™é—®é¢˜ | æ£€æŸ¥Nginxé…ç½®å’Œé˜²ç«å¢™è§„åˆ™ |

---

**ç¥æ’æŸ¥é¡ºåˆ©ï¼** ğŸ‰
