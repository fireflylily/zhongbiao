#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è®¾ç½®æµ‹è¯•æ•°æ®ï¼šåˆ›å»ºæ–‡æ¡£å¹¶å‘é‡åŒ–
ç”¨äºæµ‹è¯•AIæ™ºèƒ½æœç´¢åŠŸèƒ½
"""

import asyncio
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®è·¯å¾„
project_root = Path(__file__).parent / "ai_tender_system"
sys.path.insert(0, str(project_root))

from modules.vector_engine.chroma_adapter import ChromaVectorStore
from modules.vector_engine.simple_embedding import SimpleEmbeddingService


async def setup_test_documents():
    """åˆ›å»ºæµ‹è¯•æ–‡æ¡£å¹¶å‘é‡åŒ–"""
    print("=" * 70)
    print(" " * 20 + "è®¾ç½®AIæœç´¢æµ‹è¯•æ•°æ®")
    print("=" * 70)

    # 1. åˆå§‹åŒ–ç»„ä»¶
    print("\nã€æ­¥éª¤1ã€‘åˆå§‹åŒ–å‘é‡å¼•æ“...")
    vector_store = ChromaVectorStore(dimension=100)
    await vector_store.initialize()

    embedding_service = SimpleEmbeddingService(dimension=100)
    await embedding_service.initialize()
    print("âœ… åˆå§‹åŒ–å®Œæˆ")

    # 2. å‡†å¤‡æµ‹è¯•æ–‡æ¡£ï¼ˆæ¨¡æ‹ŸçœŸå®ä¸šåŠ¡åœºæ™¯ï¼‰
    print("\nã€æ­¥éª¤2ã€‘å‡†å¤‡æµ‹è¯•æ–‡æ¡£...")
    test_docs = [
        {
            "id": "doc_unicom_5g_core",
            "content": """ä¸­å›½è”é€š5Gæ ¸å¿ƒç½‘äº§å“ä»‹ç»

äº§å“æ¦‚è¿°ï¼š
ä¸­å›½è”é€š5Gæ ¸å¿ƒç½‘äº§å“é‡‡ç”¨äº‘åŸç”Ÿæ¶æ„è®¾è®¡ï¼ŒåŸºäºNFVï¼ˆç½‘ç»œåŠŸèƒ½è™šæ‹ŸåŒ–ï¼‰å’ŒSDNï¼ˆè½¯ä»¶å®šä¹‰ç½‘ç»œï¼‰æŠ€æœ¯ï¼Œ
å®ç°ç½‘ç»œåŠŸèƒ½çš„çµæ´»éƒ¨ç½²å’ŒåŠ¨æ€ç¼–æ’ã€‚æ”¯æŒeMBBã€uRLLCã€mMTCä¸‰å¤§5Gåº”ç”¨åœºæ™¯ã€‚

æŠ€æœ¯ç‰¹ç‚¹ï¼š
1. æœåŠ¡åŒ–æ¶æ„ï¼ˆSBAï¼‰ï¼šé‡‡ç”¨å¾®æœåŠ¡æ¶æ„ï¼Œå„ç½‘å…ƒé—´é€šè¿‡HTTP/2åè®®é€šä¿¡
2. ç½‘ç»œåˆ‡ç‰‡ï¼šæ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»å’Œå·®å¼‚åŒ–æœåŠ¡è´¨é‡ä¿è¯
3. è¾¹ç¼˜è®¡ç®—ï¼šMECï¼ˆç§»åŠ¨è¾¹ç¼˜è®¡ç®—ï¼‰èƒ½åŠ›ï¼Œé™ä½æ—¶å»¶è‡³10msä»¥å†…
4. é«˜å¯é æ€§ï¼š99.999%å¯ç”¨æ€§ï¼Œæ”¯æŒåŒæ´»/å¤šæ´»éƒ¨ç½²

å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼š
- ç”¨æˆ·å®¹é‡ï¼šå•å¥—ç³»ç»Ÿæ”¯æŒ5000ä¸‡ç”¨æˆ·
- ä¼šè¯å®¹é‡ï¼šæ¯ç§’å¤„ç†10ä¸‡æ¬¡ä¼šè¯å»ºç«‹
- æ—¶å»¶ï¼šç«¯åˆ°ç«¯æ—¶å»¶<20ms
- ååé‡ï¼šå•èŠ‚ç‚¹ååé‡è¾¾100Gbps

åº”ç”¨åœºæ™¯ï¼š
æ™ºæ…§åŸå¸‚ã€å·¥ä¸šäº’è”ç½‘ã€è½¦è”ç½‘ã€è¿œç¨‹åŒ»ç–—ã€é«˜æ¸…è§†é¢‘ä¼ è¾“ç­‰ã€‚""",
            "metadata": {
                "company_id": 1,
                "product_id": 1,
                "doc_id": 100,
                "document_type": "äº§å“ä»‹ç»",
                "document_name": "5Gæ ¸å¿ƒç½‘äº§å“æ‰‹å†Œ",
                "product_name": "5Gæ ¸å¿ƒç½‘äº§å“"
            }
        },
        {
            "id": "doc_unicom_cloud_platform",
            "content": """ä¸­å›½è”é€šäº‘è®¡ç®—å¹³å°æŠ€æœ¯æ¶æ„

å¹³å°ç®€ä»‹ï¼š
è”é€šäº‘è®¡ç®—å¹³å°æ˜¯é¢å‘æ”¿ä¼å®¢æˆ·çš„å…¬æœ‰äº‘æœåŠ¡å¹³å°ï¼Œæä¾›IaaSã€PaaSã€SaaSå…¨æ ˆäº‘æœåŠ¡ã€‚
å¹³å°é‡‡ç”¨OpenStack+Kubernetesæ··åˆæ¶æ„ï¼Œæ”¯æŒè™šæ‹Ÿæœºå’Œå®¹å™¨ä¸¤ç§èµ„æºäº¤ä»˜æ¨¡å¼ã€‚

æ ¸å¿ƒç»„ä»¶ï¼š
1. è®¡ç®—èµ„æºæ± ï¼šé‡‡ç”¨KVMè™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œæ”¯æŒx86å’ŒARMæ¶æ„
2. å­˜å‚¨èµ„æºæ± ï¼šåˆ†å¸ƒå¼å—å­˜å‚¨ï¼ˆCephï¼‰+ å¯¹è±¡å­˜å‚¨ï¼ˆS3å…¼å®¹ï¼‰
3. ç½‘ç»œèµ„æºæ± ï¼šSDNç½‘ç»œï¼Œæ”¯æŒVPCã€ä¸“çº¿ã€VPNå¤šç§æ¥å…¥æ–¹å¼
4. æ•°æ®åº“æœåŠ¡ï¼šMySQLã€PostgreSQLã€Redisã€MongoDBç­‰

å®‰å…¨ä¿éšœï¼š
- ç‰©ç†éš”ç¦»ï¼šç§Ÿæˆ·é—´ç½‘ç»œç‰©ç†éš”ç¦»
- æ•°æ®åŠ å¯†ï¼šé™æ€åŠ å¯†å’Œä¼ è¾“åŠ å¯†
- ç­‰ä¿åˆè§„ï¼šé€šè¿‡ç­‰ä¿ä¸‰çº§è®¤è¯
- å®‰å…¨é˜²æŠ¤ï¼šDDoSé˜²æŠ¤ã€Webåº”ç”¨é˜²ç«å¢™ã€å…¥ä¾µæ£€æµ‹ç³»ç»Ÿ

èµ„æºè§„æ¨¡ï¼š
å…¨å›½31ä¸ªçœå¸‚éƒ¨ç½²ï¼Œæ€»è®¡ç®—èƒ½åŠ›100ä¸‡æ ¸vCPUï¼Œå­˜å‚¨å®¹é‡50PBã€‚""",
            "metadata": {
                "company_id": 1,
                "product_id": 2,
                "doc_id": 101,
                "document_type": "æŠ€æœ¯æ–‡æ¡£",
                "document_name": "äº‘è®¡ç®—å¹³å°æŠ€æœ¯ç™½çš®ä¹¦",
                "product_name": "äº‘è®¡ç®—å¹³å°"
            }
        },
        {
            "id": "doc_zhzj_riskcontrol",
            "content": """æ™ºæ…§è¶³è¿¹æç›¾é£æ§å¹³å°äº§å“è¯´æ˜

äº§å“å®šä½ï¼š
æç›¾é£æ§å¹³å°æ˜¯ä¸€æ¬¾åŸºäºå¤§æ•°æ®å’Œäººå·¥æ™ºèƒ½æŠ€æœ¯çš„æ™ºèƒ½é£é™©æ§åˆ¶ç³»ç»Ÿï¼Œ
ä¸“æ³¨äºé‡‘èã€ç”µå•†ã€ç¤¾äº¤ç­‰é¢†åŸŸçš„æ¬ºè¯ˆæ£€æµ‹å’Œé£é™©é˜²æ§ã€‚

æ ¸å¿ƒç®—æ³•ï¼š
1. æ·±åº¦å­¦ä¹ ç¥ç»ç½‘ç»œï¼šLSTM/GRUç”¨äºåºåˆ—è¡Œä¸ºåˆ†æ
2. éšæœºæ£®æ—ç®—æ³•ï¼šå¤šç»´ç‰¹å¾èåˆå†³ç­–
3. XGBoostæ¢¯åº¦æå‡ï¼šé«˜ç²¾åº¦é£é™©è¯„åˆ†
4. å›¾ç¥ç»ç½‘ç»œï¼šç¤¾äº¤ç½‘ç»œå…³ç³»æŒ–æ˜
5. å¼‚å¸¸æ£€æµ‹ç®—æ³•ï¼šIsolation Forestã€LOF

å®æ—¶ç›‘æ§èƒ½åŠ›ï¼š
- å¹¶å‘å¤„ç†ï¼šæ”¯æŒ100ä¸‡TPSé«˜å¹¶å‘
- å“åº”æ—¶é—´ï¼šå¹³å‡30msï¼ŒP99<50ms
- å‡†ç¡®ç‡ï¼šæ¬ºè¯ˆè¯†åˆ«å‡†ç¡®ç‡>99.5%
- è¯¯æŠ¥ç‡ï¼š<0.1%

åº”ç”¨åœºæ™¯ï¼š
1. é‡‘èåæ¬ºè¯ˆï¼šä¿¡ç”¨å¡ç›—åˆ·ã€è´·æ¬¾æ¬ºè¯ˆã€æ´—é’±ç›‘æµ‹
2. ç”µå•†é£æ§ï¼šåˆ·å•æ£€æµ‹ã€æ¶æ„é€€è´§ã€è´¦å·ç›—ç”¨
3. å†…å®¹å®‰å…¨ï¼šåƒåœ¾ä¿¡æ¯è¿‡æ»¤ã€æ¶æ„è´¦å·è¯†åˆ«

å®¢æˆ·æ¡ˆä¾‹ï¼š
å·²ä¸º120+é‡‘èæœºæ„å’Œç”µå•†å¹³å°æä¾›æœåŠ¡ï¼Œç´¯è®¡å¤„ç†äº¤æ˜“é‡è¶…100äº¿ç¬”ï¼Œ
è¯†åˆ«æ¬ºè¯ˆäº¤æ˜“1000ä¸‡+ç¬”ï¼ŒæŒ½å›å®¢æˆ·æŸå¤±è¶…50äº¿å…ƒã€‚""",
            "metadata": {
                "company_id": 8,
                "product_id": 22,
                "doc_id": 102,
                "document_type": "äº§å“æ‰‹å†Œ",
                "document_name": "æç›¾é£æ§å¹³å°äº§å“æ‰‹å†Œ",
                "product_name": "æç›¾é£æ§å¹³å°"
            }
        },
        {
            "id": "doc_unicom_qualification",
            "content": """ä¸­å›½è”é€šä¼ä¸šèµ„è´¨è¯æ˜æ–‡ä»¶

ä¼ä¸šåŸºæœ¬ä¿¡æ¯ï¼š
ä¼ä¸šåç§°ï¼šä¸­å›½è”åˆç½‘ç»œé€šä¿¡é›†å›¢æœ‰é™å…¬å¸
ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ï¼š91110000710939135P
æ³¨å†Œèµ„æœ¬ï¼š22539208.432769ä¸‡å…ƒäººæ°‘å¸
æ³•å®šä»£è¡¨äººï¼šé™ˆå¿ å²³
æˆç«‹æ—¥æœŸï¼š2000å¹´4æœˆ21æ—¥
æ³¨å†Œåœ°å€ï¼šåŒ—äº¬å¸‚è¥¿åŸåŒºé‡‘èå¤§è¡—21å·

èµ„è´¨è¯ä¹¦ï¼š
1. è¥ä¸šæ‰§ç…§ï¼šç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç è¯
2. ç”µä¿¡ä¸šåŠ¡ç»è¥è®¸å¯è¯ï¼šA2.B1.B2å…¨ä¸šåŠ¡ç‰Œç…§
3. ISO9001è´¨é‡ç®¡ç†ä½“ç³»è®¤è¯
4. ISO27001ä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³»è®¤è¯
5. ISO20000 ITæœåŠ¡ç®¡ç†ä½“ç³»è®¤è¯
6. CMMI5çº§è½¯ä»¶èƒ½åŠ›æˆç†Ÿåº¦è®¤è¯
7. ä¿¡æ¯ç³»ç»Ÿé›†æˆåŠæœåŠ¡èµ„è´¨ï¼ˆä¸€çº§ï¼‰
8. é«˜æ–°æŠ€æœ¯ä¼ä¸šè¯ä¹¦
9. AAAçº§ä¿¡ç”¨ä¼ä¸š

çŸ¥è¯†äº§æƒï¼š
ç´¯è®¡ç”³è¯·ä¸“åˆ©8000+é¡¹ï¼Œå…¶ä¸­å‘æ˜ä¸“åˆ©6000+é¡¹
è½¯ä»¶è‘—ä½œæƒ2000+é¡¹
å‚ä¸åˆ¶å®šå›½é™…æ ‡å‡†100+é¡¹ï¼Œå›½å®¶æ ‡å‡†200+é¡¹""",
            "metadata": {
                "company_id": 1,
                "product_id": None,
                "doc_id": 103,
                "document_type": "ä¼ä¸šèµ„è´¨",
                "document_name": "ä¼ä¸šèµ„è´¨è¯æ˜",
                "company_name": "ä¸­å›½è”é€š"
            }
        },
        {
            "id": "doc_zhzj_case_bank",
            "content": """æç›¾é£æ§å¹³å°é“¶è¡Œä¸šåº”ç”¨æ¡ˆä¾‹

å®¢æˆ·èƒŒæ™¯ï¼š
æŸå›½æœ‰å¤§å‹å•†ä¸šé“¶è¡Œï¼Œä¿¡ç”¨å¡ç”¨æˆ·2000ä¸‡+ï¼Œæ—¥äº¤æ˜“é‡500ä¸‡ç¬”ï¼Œ
é¢ä¸´ä¿¡ç”¨å¡ç›—åˆ·ã€å¥—ç°ã€å…»å¡ç­‰å¤šç§æ¬ºè¯ˆé£é™©ã€‚

è§£å†³æ–¹æ¡ˆï¼š
1. å®æ—¶é£é™©ç›‘æ§ï¼š
   - éƒ¨ç½²å®æ—¶è§„åˆ™å¼•æ“ï¼Œæ¯«ç§’çº§äº¤æ˜“å†³ç­–
   - æ¥å…¥é“¶è”ã€ç½‘è”ç­‰æ”¯ä»˜æ¸…ç®—ç³»ç»Ÿ
   - 7x24å°æ—¶ä¸é—´æ–­ç›‘æ§

2. æ™ºèƒ½é£é™©æ¨¡å‹ï¼š
   - æ„å»º20+ç»´åº¦ç‰¹å¾ä½“ç³»ï¼ˆç”¨æˆ·ç”»åƒã€è®¾å¤‡æŒ‡çº¹ã€è¡Œä¸ºåºåˆ—ï¼‰
   - è®­ç»ƒæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œè¯†åˆ«éšè”½æ¬ºè¯ˆæ¨¡å¼
   - æ¯æ—¥æ¨¡å‹æ›´æ–°ï¼Œå¿«é€Ÿå“åº”æ–°å‹æ¬ºè¯ˆæ‰‹æ®µ

3. å¤šå±‚é˜²å¾¡ä½“ç³»ï¼š
   - äº‹å‰ï¼šé£é™©è¯„ä¼°ï¼Œé«˜é£é™©ç”¨æˆ·é™é¢æ§åˆ¶
   - äº‹ä¸­ï¼šå®æ—¶æ‹¦æˆªï¼Œå¯ç–‘äº¤æ˜“çŸ­ä¿¡éªŒè¯
   - äº‹åï¼šæ¡ˆä»¶è°ƒæŸ¥ï¼Œé»‘åå•ç®¡ç†

å®æ–½æ•ˆæœï¼š
- æ¬ºè¯ˆäº¤æ˜“æ‹¦æˆªç‡æå‡40%
- è¯¯æŠ¥ç‡ä¸‹é™60%
- æŒ½å›æŸå¤±è¶…5000ä¸‡å…ƒ/å¹´
- å®¢æˆ·æŠ•è¯‰ç‡ä¸‹é™30%
- é£æ§å®¡æ ¸æ•ˆç‡æå‡3å€""",
            "metadata": {
                "company_id": 8,
                "product_id": 22,
                "doc_id": 104,
                "document_type": "å®¢æˆ·æ¡ˆä¾‹",
                "document_name": "é“¶è¡Œä¸šåº”ç”¨æ¡ˆä¾‹",
                "product_name": "æç›¾é£æ§å¹³å°"
            }
        }
    ]

    print(f"âœ… å‡†å¤‡äº† {len(test_docs)} ä¸ªä¸šåŠ¡æ–‡æ¡£")
    for i, doc in enumerate(test_docs, 1):
        print(f"   {i}. {doc['metadata']['document_name']}")

    # 3. å‘é‡åŒ–å¹¶å­˜å‚¨
    print("\nã€æ­¥éª¤3ã€‘å‘é‡åŒ–å¹¶å­˜å‚¨åˆ°Chroma...")
    for i, doc in enumerate(test_docs, 1):
        # ç”Ÿæˆå‘é‡
        result = await embedding_service.embed_texts([doc["content"]])
        vector = result.vectors[0]

        # å­˜å‚¨åˆ°Chroma
        await vector_store.add_document(
            doc_id=doc["id"],
            content=doc["content"],
            vector=vector,
            metadata=doc["metadata"]
        )
        print(f"  âœ“ [{i}/{len(test_docs)}] {doc['id']} å‘é‡åŒ–å®Œæˆ")

    # 4. éªŒè¯
    stats = vector_store.get_stats()
    print(f"\nâœ… æµ‹è¯•æ•°æ®è®¾ç½®å®Œæˆ!")
    print(f"   - æ€»æ–‡æ¡£æ•°: {stats['total_documents']}")
    print(f"   - æŒä¹…åŒ–ç›®å½•: {stats['persist_directory']}")

    print("\n" + "=" * 70)
    print("âœ¨ æµ‹è¯•æ•°æ®å·²å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•AIæœç´¢åŠŸèƒ½äº†ï¼")
    print("=" * 70)
    print("\nğŸ’¡ æµ‹è¯•å»ºè®®ï¼š")
    print("   1. è®¿é—®: http://localhost:8110/knowledge_base")
    print("   2. ç‚¹å‡»å·¥å…·æ çš„ AIæœç´¢ æŒ‰é’® (â­å›¾æ ‡)")
    print("   3. å°è¯•æœç´¢ï¼š")
    print("      - '5Gæ ¸å¿ƒç½‘çš„æ€§èƒ½æŒ‡æ ‡'")
    print("      - 'äº‘è®¡ç®—å¹³å°çš„å®‰å…¨ä¿éšœ'")
    print("      - 'é£æ§ç³»ç»Ÿçš„ç®—æ³•æœ‰å“ªäº›'")
    print("      - 'ä¸­å›½è”é€šæœ‰å“ªäº›èµ„è´¨è¯ä¹¦'")
    print("      - 'é“¶è¡Œé£æ§æ¡ˆä¾‹æ•ˆæœ'")


if __name__ == "__main__":
    try:
        asyncio.run(setup_test_documents())
    except KeyboardInterrupt:
        print("\n\nâš ï¸  æ“ä½œè¢«ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\n\nâŒ è®¾ç½®å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()