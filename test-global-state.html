<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalStateManager åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .output {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status.success {
            background: #4CAF50;
            color: white;
        }
        .status.info {
            background: #2196F3;
            color: white;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª GlobalStateManager åŠŸèƒ½æµ‹è¯•</h1>

    <!-- åŸºç¡€çŠ¶æ€æ˜¾ç¤º -->
    <div class="container">
        <h2>ğŸ“Š å½“å‰çŠ¶æ€å¿«ç…§</h2>
        <button onclick="showSnapshot()">ğŸ” æŸ¥çœ‹å®Œæ•´çŠ¶æ€</button>
        <button onclick="window.globalState.debug()">ğŸ› æ§åˆ¶å°è°ƒè¯•</button>
        <div id="snapshot" class="output"></div>
    </div>

    <!-- å…¬å¸ç®¡ç†æµ‹è¯• -->
    <div class="container">
        <h2>ğŸ¢ å…¬å¸ç®¡ç†æµ‹è¯•</h2>
        <div>
            <input type="text" id="companyId" placeholder="å…¬å¸ID" value="COMP001">
            <input type="text" id="companyName" placeholder="å…¬å¸åç§°" value="æµ‹è¯•å…¬å¸">
            <button onclick="testSetCompany()">è®¾ç½®å…¬å¸</button>
            <button onclick="testGetCompany()">è·å–å…¬å¸</button>
            <button onclick="window.globalState.clearCompany()">æ¸…ç©ºå…¬å¸</button>
        </div>
        <div id="companyOutput" class="output"></div>
    </div>

    <!-- é¡¹ç›®ç®¡ç†æµ‹è¯• -->
    <div class="container">
        <h2>ğŸ“ é¡¹ç›®ç®¡ç†æµ‹è¯•</h2>
        <div>
            <input type="text" id="projectId" placeholder="é¡¹ç›®ID" value="PROJ001">
            <input type="text" id="projectName" placeholder="é¡¹ç›®åç§°" value="æµ‹è¯•é¡¹ç›®">
            <button onclick="testSetProject()">è®¾ç½®é¡¹ç›®</button>
            <button onclick="testGetProject()">è·å–é¡¹ç›®</button>
            <button onclick="window.globalState.clearProject()">æ¸…ç©ºé¡¹ç›®</button>
        </div>
        <div id="projectOutput" class="output"></div>
    </div>

    <!-- æ–‡ä»¶ç®¡ç†æµ‹è¯• -->
    <div class="container">
        <h2>ğŸ“„ æ–‡ä»¶ç®¡ç†æµ‹è¯•</h2>
        <div>
            <select id="fileType">
                <option value="originalTender">åŸå§‹æ‹›æ ‡æ–‡ä»¶</option>
                <option value="technical">æŠ€æœ¯éœ€æ±‚æ–‡ä»¶</option>
                <option value="business">å•†åŠ¡åº”ç­”æ–‡ä»¶</option>
                <option value="pointToPoint">ç‚¹å¯¹ç‚¹åº”ç­”æ–‡ä»¶</option>
                <option value="techProposal">æŠ€æœ¯æ–¹æ¡ˆæ–‡ä»¶</option>
            </select>
            <input type="text" id="fileName" placeholder="æ–‡ä»¶å" value="test.docx">
            <button onclick="testSetFile()">è®¾ç½®æ–‡ä»¶</button>
            <button onclick="testGetFile()">è·å–æ–‡ä»¶</button>
            <button onclick="testClearFile()">æ¸…ç©ºæ–‡ä»¶</button>
        </div>
        <div id="fileOutput" class="output"></div>
    </div>

    <!-- AIæ¨¡å‹ç®¡ç†æµ‹è¯• -->
    <div class="container">
        <h2>ğŸ¤– AIæ¨¡å‹ç®¡ç†æµ‹è¯•</h2>
        <div>
            <button onclick="testSetModels()">è®¾ç½®æ¨¡å‹åˆ—è¡¨</button>
            <button onclick="testGetModels()">è·å–æ¨¡å‹åˆ—è¡¨</button>
            <select id="modelSelect">
                <option value="unicom-yuanjing">è”é€šå…ƒæ™¯</option>
                <option value="gpt-4">GPT-4</option>
                <option value="claude-3">Claude 3</option>
            </select>
            <button onclick="testSetSelectedModel()">é€‰æ‹©æ¨¡å‹</button>
            <button onclick="testGetSelectedModel()">è·å–é€‰ä¸­æ¨¡å‹</button>
        </div>
        <div id="aiOutput" class="output"></div>
    </div>

    <!-- è®¢é˜…æµ‹è¯• -->
    <div class="container">
        <h2>ğŸ‘‚ è®¢é˜…/é€šçŸ¥æµ‹è¯•</h2>
        <div>
            <button onclick="testSubscribeCompany()">è®¢é˜…å…¬å¸å˜åŒ–</button>
            <button onclick="testSubscribeFiles()">è®¢é˜…æ–‡ä»¶å˜åŒ–</button>
            <button onclick="testSubscribeAI()">è®¢é˜…AIå˜åŒ–</button>
            <button class="danger" onclick="testUnsubscribe()">å–æ¶ˆæ‰€æœ‰è®¢é˜…</button>
        </div>
        <div id="subscribeOutput" class="output">è®¢é˜…æ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
    </div>

    <!-- æ‰¹é‡æ“ä½œæµ‹è¯• -->
    <div class="container">
        <h2>âš¡ æ‰¹é‡æ“ä½œæµ‹è¯•</h2>
        <div>
            <button onclick="testSetBulk()">æ‰¹é‡è®¾ç½®ï¼ˆæ¨¡æ‹ŸHITLè·³è½¬ï¼‰</button>
            <button class="danger" onclick="window.globalState.clearAll()">æ¸…ç©ºæ‰€æœ‰çŠ¶æ€</button>
        </div>
        <div id="bulkOutput" class="output"></div>
    </div>

    <!-- å…¼å®¹å±‚æµ‹è¯• -->
    <div class="container">
        <h2>ğŸ”„ å…¼å®¹å±‚æµ‹è¯•ï¼ˆæ—§APIï¼‰</h2>
        <div>
            <button onclick="testLegacyAPI()">æµ‹è¯•æ—§APIï¼ˆåº”æœ‰è­¦å‘Šï¼‰</button>
        </div>
        <div id="legacyOutput" class="output"></div>
    </div>

    <!-- åŠ è½½ GlobalStateManager -->
    <script src="ai_tender_system/web/static/js/core/global-state-manager.js"></script>

    <!-- æµ‹è¯•è„šæœ¬ -->
    <script>
        let unsubscribeFunctions = [];

        // æ˜¾ç¤ºçŠ¶æ€å¿«ç…§
        function showSnapshot() {
            const snapshot = window.globalState.getSnapshot();
            document.getElementById('snapshot').textContent = JSON.stringify(snapshot, null, 2);
        }

        // å…¬å¸æµ‹è¯•
        function testSetCompany() {
            const id = document.getElementById('companyId').value;
            const name = document.getElementById('companyName').value;
            window.globalState.setCompany(id, name);
            document.getElementById('companyOutput').textContent = `âœ… å·²è®¾ç½®å…¬å¸: ID=${id}, Name=${name}`;
        }

        function testGetCompany() {
            const company = window.globalState.getCompany();
            document.getElementById('companyOutput').textContent =
                `ğŸ“Œ å½“å‰å…¬å¸:\n${JSON.stringify(company, null, 2)}`;
        }

        // é¡¹ç›®æµ‹è¯•
        function testSetProject() {
            const id = document.getElementById('projectId').value;
            const name = document.getElementById('projectName').value;
            window.globalState.setProject(id, name);
            document.getElementById('projectOutput').textContent = `âœ… å·²è®¾ç½®é¡¹ç›®: ID=${id}, Name=${name}`;
        }

        function testGetProject() {
            const project = window.globalState.getProject();
            document.getElementById('projectOutput').textContent =
                `ğŸ“Œ å½“å‰é¡¹ç›®:\n${JSON.stringify(project, null, 2)}`;
        }

        // æ–‡ä»¶æµ‹è¯•
        function testSetFile() {
            const fileType = document.getElementById('fileType').value;
            const fileName = document.getElementById('fileName').value;
            window.globalState.setFile(fileType, {
                fileName: fileName,
                filePath: `/uploads/${fileName}`,
                fileUrl: `/download/${fileName}`,
                fileSize: 1024000
            });
            document.getElementById('fileOutput').textContent = `âœ… å·²è®¾ç½® ${fileType} æ–‡ä»¶`;
        }

        function testGetFile() {
            const fileType = document.getElementById('fileType').value;
            const file = window.globalState.getFile(fileType);
            document.getElementById('fileOutput').textContent =
                `ğŸ“Œ ${fileType} æ–‡ä»¶ä¿¡æ¯:\n${JSON.stringify(file, null, 2)}`;
        }

        function testClearFile() {
            const fileType = document.getElementById('fileType').value;
            window.globalState.clearFile(fileType);
            document.getElementById('fileOutput').textContent = `âœ… å·²æ¸…ç©º ${fileType} æ–‡ä»¶`;
        }

        // AIæ¨¡å‹æµ‹è¯•
        function testSetModels() {
            const models = [
                { name: 'unicom-yuanjing', display_name: 'è”é€šå…ƒæ™¯', status: 'available' },
                { name: 'gpt-4', display_name: 'GPT-4', status: 'available' },
                { name: 'claude-3', display_name: 'Claude 3', status: 'no_api_key' }
            ];
            window.globalState.setAvailableModels(models);
            document.getElementById('aiOutput').textContent = `âœ… å·²è®¾ç½® ${models.length} ä¸ªAIæ¨¡å‹`;
        }

        function testGetModels() {
            const models = window.globalState.getAvailableModels();
            document.getElementById('aiOutput').textContent =
                `ğŸ“Œ å¯ç”¨æ¨¡å‹åˆ—è¡¨:\n${JSON.stringify(models, null, 2)}`;
        }

        function testSetSelectedModel() {
            const model = document.getElementById('modelSelect').value;
            window.globalState.setSelectedModel(model);
            document.getElementById('aiOutput').textContent = `âœ… å·²é€‰æ‹©æ¨¡å‹: ${model}`;
        }

        function testGetSelectedModel() {
            const model = window.globalState.getSelectedModel();
            document.getElementById('aiOutput').textContent = `ğŸ“Œ å½“å‰é€‰ä¸­æ¨¡å‹: ${model}`;
        }

        // è®¢é˜…æµ‹è¯•
        function testSubscribeCompany() {
            const unsubscribe = window.globalState.subscribe('company', (data) => {
                const output = document.getElementById('subscribeOutput');
                output.textContent += `\nğŸ”” [company] ${new Date().toLocaleTimeString()}: ${JSON.stringify(data)}`;
                output.scrollTop = output.scrollHeight;
            });
            unsubscribeFunctions.push(unsubscribe);
            document.getElementById('subscribeOutput').textContent += '\nâœ… å·²è®¢é˜… company å˜åŒ–';
        }

        function testSubscribeFiles() {
            const unsubscribe = window.globalState.subscribe('files', (data) => {
                const output = document.getElementById('subscribeOutput');
                output.textContent += `\nğŸ”” [files] ${new Date().toLocaleTimeString()}: type=${data.type}, data=${JSON.stringify(data.data)}`;
                output.scrollTop = output.scrollHeight;
            });
            unsubscribeFunctions.push(unsubscribe);
            document.getElementById('subscribeOutput').textContent += '\nâœ… å·²è®¢é˜… files å˜åŒ–';
        }

        function testSubscribeAI() {
            const unsubscribe = window.globalState.subscribe('ai', (data) => {
                const output = document.getElementById('subscribeOutput');
                output.textContent += `\nğŸ”” [ai] ${new Date().toLocaleTimeString()}: type=${data.type}, data=${JSON.stringify(data.data)}`;
                output.scrollTop = output.scrollHeight;
            });
            unsubscribeFunctions.push(unsubscribe);
            document.getElementById('subscribeOutput').textContent += '\nâœ… å·²è®¢é˜… ai å˜åŒ–';
        }

        function testUnsubscribe() {
            unsubscribeFunctions.forEach(fn => fn());
            unsubscribeFunctions = [];
            document.getElementById('subscribeOutput').textContent = 'âœ… å·²å–æ¶ˆæ‰€æœ‰è®¢é˜…';
        }

        // æ‰¹é‡æ“ä½œæµ‹è¯•
        function testSetBulk() {
            window.globalState.setBulk({
                company: { id: 'BULK_COMP', name: 'æ‰¹é‡è®¾ç½®å…¬å¸' },
                project: { id: 'BULK_PROJ', name: 'æ‰¹é‡è®¾ç½®é¡¹ç›®' },
                files: {
                    technical: {
                        fileName: 'technical_bulk.docx',
                        filePath: '/uploads/technical_bulk.docx',
                        fileUrl: '/download/technical_bulk.docx',
                        fileSize: 2048000
                    },
                    business: {
                        fileName: 'business_bulk.docx',
                        filePath: '/uploads/business_bulk.docx',
                        fileUrl: '/download/business_bulk.docx',
                        fileSize: 1536000
                    }
                },
                hitlTaskId: 'TASK_12345'
            });
            document.getElementById('bulkOutput').textContent = 'âœ… æ‰¹é‡è®¾ç½®å®Œæˆï¼æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—æˆ–çŠ¶æ€å¿«ç…§';
        }

        // å…¼å®¹å±‚æµ‹è¯•
        function testLegacyAPI() {
            const output = document.getElementById('legacyOutput');
            output.textContent = 'æµ‹è¯•æ—§APIï¼ˆæŸ¥çœ‹æ§åˆ¶å°åº”æœ‰è­¦å‘Šï¼‰:\n\n';

            // æµ‹è¯•æ—§çš„ companyId å±æ€§
            window.projectDataBridge.companyId = 'OLD_COMP';
            output.textContent += `âœ… projectDataBridge.companyId = 'OLD_COMP'\n`;
            output.textContent += `   è¯»å–: ${window.projectDataBridge.companyId}\n\n`;

            // æµ‹è¯•æ—§çš„ setTechnicalFile æ–¹æ³•
            window.projectDataBridge.setTechnicalFile('TASK_999', 'old_tech.docx', 1024, '/download/old_tech.docx');
            output.textContent += `âœ… projectDataBridge.setTechnicalFile()\n`;
            const techFile = window.projectDataBridge.getTechnicalFile();
            output.textContent += `   è¯»å–: ${JSON.stringify(techFile, null, 2)}\n\n`;

            // æµ‹è¯•æ—§çš„ setModels æ–¹æ³•
            window.projectDataBridge.setModels([{name: 'old-model', display_name: 'æ—§æ¨¡å‹'}]);
            output.textContent += `âœ… projectDataBridge.setModels()\n`;
            output.textContent += `   è¯»å–: ${JSON.stringify(window.projectDataBridge.getModels(), null, 2)}\n\n`;

            output.textContent += 'âš ï¸ æ‰€æœ‰æ“ä½œåº”åœ¨æ§åˆ¶å°æ˜¾ç¤ºåºŸå¼ƒè­¦å‘Š';
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            console.log('âœ… æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            console.log('âœ… GlobalStateManager å·²åˆå§‹åŒ–:', !!window.globalState);
            console.log('âœ… å…¼å®¹å±‚å·²åˆ›å»º:', !!window.projectDataBridge);

            // è‡ªåŠ¨è®¢é˜…æ‰€æœ‰å˜åŒ–
            testSubscribeCompany();
            testSubscribeFiles();
            testSubscribeAI();

            showSnapshot();
        });
    </script>
</body>
</html>
