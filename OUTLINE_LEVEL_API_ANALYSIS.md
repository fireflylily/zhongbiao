# 微软大纲级别API分析报告

## 📊 哈银消金文档的大纲级别统计

**文档**: 招标文件-哈银消金.docx
**总段落数**: 667个

### 微软官方API (`<w:outlineLvl>`) 返回值分布

| 大纲级别 | 段落数 | 占比 | 说明 |
|---------|--------|------|------|
| **Level None** | **486个** | **72.9%** | ⚠️ **未设置大纲级别** |
| Level 1 | 25个 | 3.7% | 二级标题 |
| Level 2 | 30个 | 4.5% | 三级标题 |

---

## 🎯 关键发现

### ⚠️ 所有"第X部分"章节的大纲级别都是 **None**！

| 段落 | 标题 | 大纲级别 | 样式 | 问题 |
|------|------|----------|------|------|
| 38 | 第一部分 招标公告 | **None** ⚠️ | Heading 1 | 未设置大纲级别 |
| 104 | 第二部分 投标人须知... | **None** ⚠️ | Heading 1 | 未设置大纲级别 |
| 259 | 评标办法 | **None** ⚠️ | Heading 1 | 未设置大纲级别 |
| 267 | 第四部分 合同主要条款... | **None** ⚠️ | Heading 1 | 未设置大纲级别 |
| 379 | 第五部分 采购需求书 | **None** ⚠️ | Heading 1 | 未设置大纲级别 |
| 427 | 第六部分 附件 | **None** ⚠️ | Heading 1 | 未设置大纲级别 |

### ✅ 只有内部小标题有大纲级别

| 段落 | 标题 | 大纲级别 | 样式 | 位置 |
|------|------|----------|------|------|
| 205 | 五、开标与评标 | **1** ✅ | Normal | 第二部分内 |
| 109 | 招标人及合格的投标人 | **2** ✅ | Normal | 第二部分内 |
| 114 | 费用 | **2** ✅ | Normal | 第二部分内 |

---

## 💡 这意味着什么？

### 1. 文档作者的编辑习惯

**顶级章节**（第X部分）:
- ❌ **没有设置大纲级别** (`<w:outlineLvl>` = None)
- ✅ **只设置了样式** (Heading 1)
- 💡 **推测**: 作者直接应用 "Heading 1" 样式，而没有使用大纲视图

**内部小标题**:
- ✅ **设置了大纲级别** (Level 1, Level 2)
- ✅ **样式为 Normal**
- 💡 **推测**: 作者使用了多级列表或手动设置大纲级别

### 2. 为什么微软API优先级高？

**理论上**:
```
微软 <w:outlineLvl> API > 样式检测
```

**原因**:
- `<w:outlineLvl>` 是Word的语义标记，用于导航窗格和大纲视图
- 样式只是视觉呈现
- 大纲级别更准确表达文档结构

**但在这个文档中**:
```
所有顶级章节的 <w:outlineLvl> = None ❌
只能依靠样式检测 (Heading 1) ✅
```

---

## 🔍 当前代码的处理逻辑

### 检测优先级（structure_parser.py line 691-750）

```python
# 优先级1: 检查大纲级别 (微软官方API)
pPr = paragraph._element.pPr
if pPr is not None:
    outlineLvl = pPr.outlineLvl
    if outlineLvl is not None:
        outline_level_val = int(outlineLvl.val)
        if outline_level_val <= 8:
            is_heading = True
            level = outline_level_val + 1
            detection_method = f"大纲级别{outline_level_val}"

# 优先级2: 检查样式 (备用方案)
if not is_heading:
    style_name = paragraph.style.name
    if style_name.startswith('Heading '):
        is_heading = True
        level = int(match.group(1))
        detection_method = f"样式{style_name}"
```

### 实际执行结果

| 段落 | 检测方式 | Level | 说明 |
|------|----------|-------|------|
| 38 | 样式 Heading 1 | 1 | 大纲级别=None，走备用方案 |
| 104 | 样式 Heading 1 | 1 | 大纲级别=None，走备用方案 |
| 205 | 大纲级别1 | 2 | 微软API检测 ✅ |
| 259 | 样式 Heading 1 | 1 | 大纲级别=None，走备用方案 |
| 267 | 样式 Heading 1 | 1 | 大纲级别=None，走备用方案 |

**所以**:
- ✅ 6个顶级章节**全部通过样式检测**识别
- ✅ 25个 Level 1 小标题通过微软API识别
- ✅ 30个 Level 2 小标题通过微软API识别

---

## ❓ 为什么"评标办法"在树中消失了？

### 检测阶段 ✅ 成功

```
段落 38:  样式 Heading 1 → Level 1 "第一部分 招标公告"
段落 104: 样式 Heading 1 → Level 1 "第二部分 投标人须知..."
段落 205: 大纲级别1    → Level 2 "五、开标与评标"
段落 259: 样式 Heading 1 → Level 1 "评标办法"  ← 被识别了！
段落 267: 样式 Heading 1 → Level 1 "第四部分 合同主要条款..."
```

### 树形构建阶段 ❌ 问题

**扁平列表**（检测结果）:
```
Level 1: 第二部分 (104)
Level 2: 五、开标与评标 (205)
Level 1: 评标办法 (259)       ← 应该结束第二部分，开始新章节
Level 1: 第四部分 (267)
```

**树形结构**（构建结果）:
```
第二部分 (104, Level 1)
  └─ 五、开标与评标 (205, Level 2)
      └─ ... (子节点)

??? 评标办法去哪了？ ← 被忽略或合并了

第四部分 (267, Level 1)
```

### 可能的原因

**_build_chapter_tree_outline 的逻辑问题**:

1. **遇到相同Level的连续标题**:
   ```
   Level 1 "第二部分" (104)
   Level 2 "五、开标与评标" (205)
   Level 1 "评标办法" (259)  ← 应该是新的顶级章节
   Level 1 "第四部分" (267)
   ```

2. **可能的错误判断**:
   - 算法可能认为 259 是 205 的延续
   - 或者 259 因为标题太短（4字）被误判

3. **检查边界计算**:
   - 第二部分的 `para_end_idx` 可能被错误计算为 266
   - 导致包含了段落 259

---

## 📋 Level 1 大纲级别的段落示例

**微软API返回 Level 1 的段落**:

```
段落  41: 项目名称：
段落  43: 招标编号：
段落  44: GXTC-C-251590031
段落  45: 项目情况：
段落  54: 合格投标人的基本资质要求（须同时满足）：
```

**这些都是元数据字段，不是真正的章节标题！**

### 为什么会有这些？

**推测**: 文档模板使用了多级列表
- 项目名称、招标编号等字段被设置为 Level 1
- 这是Word模板的常见做法

### 代码的过滤逻辑 ✅ 正确

```python
# Line 705-711: 过滤封面元数据
if para_idx < 30 and outline_level_val == 0:
    metadata_keywords = ['项目编号', '招标人', '代理机构', '联系人', ...]
    if any(kw in text for kw in metadata_keywords):
        should_skip = True
```

**这些元数据段落被正确过滤掉了** ✅

---

## 🎯 结论

### 1. 微软大纲级别API的准确性

**在这个文档中**:
- ❌ **不准确** - 所有顶级章节都没有设置大纲级别
- ✅ **部分准确** - 内部小标题有正确的大纲级别
- 💡 **取决于文档作者** - 如果作者不使用大纲视图，这个API就没用

### 2. 样式检测的必要性

**在这个文档中**:
- ✅ **必须依赖** - 所有"第X部分"都只能通过 Heading 1 样式检测
- ✅ **作为备用方案是正确的**

### 3. 真正的问题

**不是检测问题**（检测阶段工作正常）:
- ✅ 微软API检测了 Level 1/2 小标题
- ✅ 样式检测了所有 Heading 1 顶级章节
- ✅ 段落 259 被正确识别为 Level 1 标题

**是树形构建问题**:
- ❌ `_build_chapter_tree_outline` 在处理连续的 Level 1 标题时有bug
- ❌ 段落 259 "评标办法" 被跳过或错误合并

---

## 🛠️ 方案B的必要性

### 需要修复的不是检测，而是树形构建

**当前情况**:
```python
# 检测阶段 ✅ 工作正常
chapters = [
    ChapterNode(id=0, level=1, title="第一部分", para_idx=38),
    ChapterNode(id=1, level=1, title="第二部分", para_idx=104),
    ChapterNode(id=2, level=2, title="五、开标与评标", para_idx=205),
    ChapterNode(id=3, level=1, title="评标办法", para_idx=259),  ← 被检测到了
    ChapterNode(id=4, level=1, title="第四部分", para_idx=267),
]

# 树形构建阶段 ❌ 有问题
tree = _build_chapter_tree_outline(chapters)
# 结果: 段落 259 不见了
```

**方案B需要做的**:
1. 找到 `_build_chapter_tree_outline` 方法中的bug
2. 修复连续 Level 1 章节的处理逻辑
3. 确保所有检测到的章节都正确加入树

---

## 📊 数据验证

### 如果微软API准确，应该看到

**期望**:
```
Level 0 (一级标题): 第一部分、第二部分、第三部分...
Level 1 (二级标题): 五、开标与评标...
Level 2 (三级标题): 招标人及合格的投标人...
```

**实际**:
```
Level None: 第一部分、第二部分、第四部分、第五部分、第六部分、评标办法
Level 1: 五、开标与评标（二级标题）
Level 2: 招标人及合格的投标人（三级标题）
```

**说明**: 文档的大纲级别设置是混乱的，不能完全依赖微软API。

---

**报告生成时间**: 2025-12-22
**关键发现**: 所有顶级章节的微软大纲级别都是None
**结论**: 必须依赖样式检测作为备用方案
**问题根源**: 树形构建逻辑，而非检测逻辑
