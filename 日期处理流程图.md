# 日期字段处理流程 - "____年____月____日"

## 完整处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      1. 文档输入 - 日期字段                       │
│                                                                 │
│  示例1: "日期：____年____月____日"                               │
│  示例2: "____年____月____日"                                     │
│  示例3: "日期：    年    月    日"                               │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│              2. SmartDocumentFiller.fill_document()             │
│                                                                 │
│  - 遍历所有段落                                                  │
│  - 按优先级匹配模式: combo → bracket → date → colon             │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│       3. PatternMatcher._match_date_pattern() - 日期模式匹配      │
│                                                                 │
│  正则表达式（按顺序尝试）:                                        │
│  ┌────────────────────────────────────────────────────┐        │
│  │ 1. r'日期\s*[:：]?\s*[_\s]*年[_\s]*月[_\s]*日'      │        │
│  │    匹配: "日期：____年____月____日"                 │        │
│  │    匹配: "日期____年____月____日"                   │        │
│  │    匹配: "日期：    年    月    日"                 │        │
│  └────────────────────────────────────────────────────┘        │
│  ┌────────────────────────────────────────────────────┐        │
│  │ 2. r'[_\s]*年[_\s]*月[_\s]*日'  (更宽松)            │        │
│  │    匹配: "____年____月____日"                       │        │
│  │    匹配: "    年    月    日"                       │        │
│  └────────────────────────────────────────────────────┘        │
│                                                                 │
│  返回匹配信息:                                                   │
│  {                                                              │
│    'full_match': '日期：____年____月____日',                     │
│    'field': 'date',                                             │
│    'start': 0,                                                  │
│    'end': 14                                                    │
│  }                                                              │
│                                                                 │
│  注意：只返回第一个匹配（return matches）                         │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│         4. ContentFiller.fill_date_field() - 填充日期            │
│                                                                 │
│  Step 1: 检查数据                                                │
│  ┌──────────────────────────────────────────┐                  │
│  │ if 'date' not in data:                   │                  │
│  │     return False  # 没有日期数据          │                  │
│  └──────────────────────────────────────────┘                  │
│                                                                 │
│  Step 2: 格式化日期 (_format_date)                              │
│  ┌──────────────────────────────────────────┐                  │
│  │ Input:  data['date'] = "2025-10-20"      │                  │
│  │ Output: "2025年10月20日"                  │                  │
│  └──────────────────────────────────────────┘                  │
│                                                                 │
│  Step 3: 智能检测前缀（是否有"日期："）                           │
│  ┌──────────────────────────────────────────┐                  │
│  │ 向前查找10个字符:                         │                  │
│  │ prefix_text = full_text[start-10:start]  │                  │
│  └──────────────────────────────────────────┘                  │
│                                                                 │
│  Step 4: 根据前缀情况选择替换策略                                 │
│  ┌──────────────────────────────────────────┐                  │
│  │ 情况A: 有"日期："                         │                  │
│  │   找到冒号位置，从冒号后替换               │                  │
│  │   结果: "日期：2025年10月20日"            │                  │
│  ├──────────────────────────────────────────┤                  │
│  │ 情况B: 只有"日期"无冒号                   │                  │
│  │   从"日期"开始全部替换                    │                  │
│  │   结果: "日期：2025年10月20日"            │                  │
│  ├──────────────────────────────────────────┤                  │
│  │ 情况C: 无"日期"前缀                       │                  │
│  │   直接替换整个匹配部分                    │                  │
│  │   结果: "2025年10月20日"                  │                  │
│  └──────────────────────────────────────────┘                  │
│                                                                 │
│  Step 5: run精确替换（保留格式）                                  │
│  WordDocumentUtils.apply_replacement_to_runs()                 │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                   5. _format_date() - 日期格式化                 │
│                                                                 │
│  支持的输入格式:                                                 │
│  ┌────────────────────────────────────────────────┐            │
│  │ 1. "2025-10-20"  → "2025年10月20日"            │            │
│  │ 2. "2025/10/20"  → "2025年10月20日"            │            │
│  │ 3. "2025.10.20"  → "2025年10月20日"            │            │
│  │ 4. "2025年10月20日" → "2025年10月20日"(保持)   │            │
│  └────────────────────────────────────────────────┘            │
│                                                                 │
│  处理步骤:                                                       │
│  1. 移除所有空格: re.sub(r'\s+', '', date_str)                  │
│  2. 尝试匹配常见格式（YYYY-MM-DD, YYYY/MM/DD, YYYY.MM.DD）      │
│  3. 如果已是中文格式，直接返回                                    │
│  4. 如果都不匹配，返回原字符串                                    │
└─────────────────────────┬───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                      6. 输出结果                                 │
│                                                                 │
│  原始: "日期：____年____月____日"                                │
│  结果: "日期：2025年10月20日"                                    │
│                                                                 │
│  日志: "✅ 日期填充: 2025年10月20日"                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心代码解析

### 1️⃣ 日期模式匹配 (第389-408行)

```python
def _match_date_pattern(self, text: str) -> List[Dict]:
    """匹配日期格式：____年____月____日"""
    patterns = [
        r'日期\s*[:：]?\s*[_\s]*年[_\s]*月[_\s]*日',  # 带"日期"前缀
        r'[_\s]*年[_\s]*月[_\s]*日',                 # 无前缀，更宽松
    ]

    matches = []
    for pattern in patterns:
        for match in re.finditer(pattern, text):
            matches.append({
                'full_match': match.group(0),
                'field': 'date',
                'start': match.start(),
                'end': match.end()
            })
            return matches  # ⚠️ 只返回第一个匹配

    return matches
```

**匹配示例：**
```
"日期：____年____月____日"  → ✅ 匹配（模式1）
"日期____年____月____日"    → ✅ 匹配（模式1）
"    年    月    日"        → ✅ 匹配（模式2）
"____年____月____日"        → ✅ 匹配（模式2）
```

---

### 2️⃣ 日期填充逻辑 (第615-672行)

```python
def fill_date_field(self, paragraph, text, matches, data):
    """填充日期字段"""
    if not matches or 'date' not in data:
        return False

    # 1. 格式化日期
    date_value = str(data['date'])
    formatted_date = self._format_date(date_value)  # "2025-10-20" → "2025年10月20日"

    match = matches[0]

    # 2. 检查前面10个字符，看是否有"日期："
    prefix_start = max(0, match['start'] - 10)
    prefix_text = full_text[prefix_start:match['start']]

    # 3. 根据前缀选择替换策略
    if '日期' in prefix_text:
        # 情况A: 有"日期："前缀
        date_label_pos = full_text.rfind('日期', 0, match['start'])
        colon_pos = full_text.find('：', date_label_pos, match['start'])

        if colon_pos != -1:
            # 从冒号后开始替换
            replacement_match = {
                'start': colon_pos + 1,
                'end': match['end']
            }
            success = apply_replacement(..., formatted_date)  # "2025年10月20日"
        else:
            # 从"日期"开始替换，添加冒号
            replacement_match = {
                'start': date_label_pos,
                'end': match['end']
            }
            success = apply_replacement(..., f"日期：{formatted_date}")
    else:
        # 情况B: 无前缀，直接替换
        success = apply_replacement(..., formatted_date)
```

---

### 3️⃣ 日期格式化 (第674-692行)

```python
def _format_date(self, date_str: str) -> str:
    """格式化日期"""
    # 1. 移除空格
    date_str = re.sub(r'\s+', '', date_str)

    # 2. 尝试匹配常见格式
    patterns = [
        (r'(\d{4})-(\d{1,2})-(\d{1,2})', r'\1年\2月\3日'),  # 2025-10-20
        (r'(\d{4})/(\d{1,2})/(\d{1,2})', r'\1年\2月\3日'),  # 2025/10/20
        (r'(\d{4})\.(\d{1,2})\.(\d{1,2})', r'\1年\2月\3日'), # 2025.10.20
    ]

    for pattern, replacement in patterns:
        if re.match(pattern, date_str):
            return re.sub(pattern, replacement, date_str)

    # 3. 已经是中文格式，直接返回
    if '年' in date_str and '月' in date_str:
        return date_str

    # 4. 都不匹配，返回原字符串
    return date_str
```

**格式转换示例：**
```python
"2025-10-20"     → "2025年10月20日"
"2025/10/20"     → "2025年10月20日"
"2025.10.20"     → "2025年10月20日"
"2025年10月20日"  → "2025年10月20日"  # 保持不变
" 2025 - 10 - 20 " → "2025年10月20日"  # 自动去空格
```

---

## 三种替换场景详解

### 场景A: 有"日期："前缀 + 有冒号

```
输入:  "日期：____年____月____日"
        ↓
检测:  找到"日期"，找到冒号（位置5）
        ↓
替换:  从冒号后（位置6）到结尾
        ↓
输出:  "日期：2025年10月20日"
```

### 场景B: 有"日期"前缀 + 无冒号

```
输入:  "日期____年____月____日"
        ↓
检测:  找到"日期"（位置0），未找到冒号
        ↓
替换:  从"日期"开始到结尾，添加冒号
        ↓
输出:  "日期：2025年10月20日"
```

### 场景C: 无"日期"前缀

```
输入:  "____年____月____日"
        ↓
检测:  未找到"日期"
        ↓
替换:  直接替换整个匹配部分
        ↓
输出:  "2025年10月20日"
```

---

## 与 colon 模式的冲突处理

在 `_process_paragraph()` 中有特殊处理（第140-148行）：

```python
# date模式特殊处理：避免与colon冲突
if pattern_type == 'colon' and 'date' in filled_patterns:
    # 如果date已经填充，跳过colon中的日期字段
    colon_has_date = any('日期' in m['field'] for m in patterns['colon'])
    if colon_has_date:
        self.logger.debug("跳过colon模式中的日期字段（已由date模式处理）")
        patterns['colon'] = [m for m in patterns['colon'] if '日期' not in m['field']]
```

**优先级：** `date` 模式优先于 `colon` 模式

---

## 支持的日期格式总结

| 输入格式 | 输出格式 | 说明 |
|---------|---------|------|
| `2025-10-20` | `2025年10月20日` | ISO格式（最常用） |
| `2025/10/20` | `2025年10月20日` | 斜杠分隔 |
| `2025.10.20` | `2025年10月20日` | 点分隔 |
| `2025年10月20日` | `2025年10月20日` | 已是中文格式，保持不变 |
| `2025-1-5` | `2025年1月5日` | 支持单位数月/日 |

---

## 示例测试

```python
# 测试用例
test_cases = [
    ("日期：____年____月____日", "日期：2025年10月20日"),
    ("日期____年____月____日", "日期：2025年10月20日"),
    ("____年____月____日", "2025年10月20日"),
    ("    年    月    日", "2025年10月20日"),
]

# 数据
data = {'date': '2025-10-20'}

# 所有测试都会正确处理 ✅
```

---

## 关键特性

1. ✅ **智能前缀检测** - 自动识别是否有"日期："
2. ✅ **格式自动转换** - 支持多种日期输入格式
3. ✅ **保留文档格式** - 使用run精确替换
4. ✅ **冲突避免** - 与colon模式互斥，优先date模式
5. ✅ **只填充一次** - 每段落只处理第一个日期匹配
