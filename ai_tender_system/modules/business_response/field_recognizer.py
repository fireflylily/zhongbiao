#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å­—æ®µè¯†åˆ«å™¨ - è¯†åˆ«å­—æ®µåç§°å¹¶æ˜ å°„åˆ°æ•°æ®

åŠŸèƒ½ï¼š
1. ç»´æŠ¤å­—æ®µå˜ä½“åº“ï¼šç»Ÿä¸€æ˜ å°„
2. è¯†åˆ«å­—æ®µåç§°ï¼Œè¿”å›æ ‡å‡†å­—æ®µå
3. æ”¯æŒç»„åˆå­—æ®µè¯†åˆ«

ä½œè€…ï¼šAI Tender System
ç‰ˆæœ¬ï¼š2.0
æ—¥æœŸï¼š2025-10-19
"""

import re
from typing import List, Optional


class FieldRecognizer:
    """å­—æ®µè¯†åˆ«å™¨ - è¯†åˆ«å­—æ®µåç§°å¹¶æ˜ å°„åˆ°æ•°æ®"""

    def __init__(self):
        # å­—æ®µå˜ä½“åº“ï¼šç»Ÿä¸€æ˜ å°„
        self.field_variants = {
            # ä¾›åº”å•†åç§°
            'companyName': [
                'ä¾›åº”å•†', 'ä¾›åº”å•†åç§°', 'ä¾›åº”å•†å…¨ç§°',  # æ·»åŠ "ä¾›åº”å•†"ç®€å†™
                'æŠ•æ ‡äºº', 'æŠ•æ ‡äººåç§°', 'æŠ•æ ‡äººå…¨ç§°',  # æ·»åŠ "æŠ•æ ‡äºº"ç®€å†™
                'å…¬å¸åç§°', 'å•ä½åç§°', 'åº”ç­”äººåç§°', 'ä¼ä¸šåç§°',
                'å“åº”äºº', 'å“åº”äººåç§°', 'å“åº”äººå…¨ç§°',  # æ·»åŠ "å“åº”äºº"ç®€å†™
                'å“åº”æ–¹', 'å“åº”æ–¹åç§°', 'å“åº”æ–¹å…¨ç§°',   # æ·»åŠ "å“åº”æ–¹"å˜ä½“
                'ç›–å•ä½å…¬ç« ', 'ç›–å•ä½ç« ',  # ç›–ç« ç›¸å…³çš„å•ä½åç§°
                'æŠ•æ ‡äººå•ä½åç§°', 'æŠ•æ ‡å•ä½çš„åç§°',  # æŠ•æ ‡å•ä½çš„å„ç§è¡¨è¿°
                'æ‰€æœ‰æˆå‘˜å•ä½åç§°', 'æŸæˆå‘˜å•ä½åç§°',  # è”åˆä½“æˆå‘˜å•ä½
                'å«åˆ†å…¬å¸', 'æœ¬å…¬å¸',  # å…¬å¸ç›¸å…³è¡¨è¿°
            ],

            # é¡¹ç›®ä¿¡æ¯
            'projectName': ['é¡¹ç›®åç§°', 'é‡‡è´­é¡¹ç›®åç§°', 'æ‹›æ ‡é¡¹ç›®åç§°'],
            'projectNumber': ['é¡¹ç›®ç¼–å·', 'é‡‡è´­ç¼–å·', 'æ‹›æ ‡ç¼–å·', 'é¡¹ç›®å·', 'ç¼–å·'],

            # é‡‡è´­æ–¹ä¿¡æ¯
            'purchaserName': ['é‡‡è´­äºº', 'é‡‡è´­äººåç§°', 'æ‹›æ ‡äºº', 'æ‹›æ ‡äººåç§°', 'ç”²æ–¹', 'ç”²æ–¹åç§°'],

            # è”ç³»æ–¹å¼
            'address': ['åœ°å€', 'æ³¨å†Œåœ°å€', 'åŠå…¬åœ°å€', 'è”ç³»åœ°å€', 'é€šè®¯åœ°å€', 'ä¾›åº”å•†åœ°å€', 'å…¬å¸åœ°å€'],
            'phone': ['ç”µè¯', 'è”ç³»ç”µè¯', 'å›ºå®šç”µè¯', 'ç”µè¯å·ç '],
            'email': ['ç”µå­é‚®ä»¶', 'ç”µå­é‚®ç®±', 'é‚®ç®±', 'email', 'Email', 'E-mail', 'E-Mail', 'ç”µå­å‡½ä»¶'],
            'fax': ['ä¼ çœŸ', 'ä¼ çœŸå·ç ', 'ä¼ çœŸå·'],
            'postalCode': ['é‚®ç¼–', 'é‚®æ”¿ç¼–ç ', 'é‚®ç '],

            # äººå‘˜ä¿¡æ¯
            'legalRepresentative': [
                'æ³•å®šä»£è¡¨äºº', 'æ³•äººä»£è¡¨', 'æ³•äºº', 'æ³•äººå§“å',
                'æ³•å®šä»£è¡¨äººå§“å', 'æ³•å®šä»£è¡¨äººåç§°', 'è´Ÿè´£äºº', 'è´Ÿè´£äººå§“å',
                'æˆ–å•ä½è´Ÿè´£äºº',  # "æˆ–å•ä½è´Ÿè´£äºº"ä¹Ÿæ˜¯æ³•äººä»£è¡¨çš„å˜ä½“
                'æ³•å®šä»£è¡¨äºº/è´Ÿè´£äººæˆ–è€…å…¶å§”æ‰˜ä»£ç†äºº',  # å¤æ‚çš„ç»„åˆè¡¨è¿°(æ‹¬å·ä¼šè¢«ç§»é™¤)
            ],
            'legalRepresentativePosition': ['æ³•äººèŒä½', 'æ³•å®šä»£è¡¨äººèŒä½', 'æ³•äººèŒåŠ¡'],
            'legalRepresentativeGender': ['æ€§åˆ«', 'æ³•äººæ€§åˆ«', 'æ³•å®šä»£è¡¨äººæ€§åˆ«'],
            'legalRepresentativeAge': ['å¹´é¾„', 'æ³•äººå¹´é¾„', 'æ³•å®šä»£è¡¨äººå¹´é¾„'],

            # è¢«æˆæƒäººä¿¡æ¯ï¼ˆæ‰©å±•å˜ä½“ï¼‰
            'representativeName': [
                'ä¾›åº”å•†è¢«æˆæƒäººå§“å', 'è¢«æˆæƒäººå§“å', 'æˆæƒäººå§“å',
                'ä¾›åº”å•†ä»£è¡¨', 'ä¾›åº”å•†ä»£è¡¨å§“å', 'ä»£è¡¨å§“å', 'ä»£è¡¨äºº',
                'ç­¾å­—äººå§“å', 'ç­¾å­—äºº',  # æ–°å¢ï¼šç­¾å­—äºº
                'å…¨æƒä»£è¡¨å§“å', 'å…¨æƒä»£è¡¨',  # æ–°å¢ï¼šå…¨æƒä»£è¡¨
                'æˆæƒä»£è¡¨', 'æˆæƒä»£è¡¨å§“å',  # æ–°å¢ï¼šæˆæƒä»£è¡¨
                'è¢«æˆæƒä»£è¡¨', 'è¢«æˆæƒä»£è¡¨å§“å'  # æ–°å¢ï¼šè¢«æˆæƒä»£è¡¨
            ],
            'representativeTitle': [
                'èŒåŠ¡', 'èŒç§°', 'èŒåŠ¡èŒç§°', 'èŒä½',
                'ç­¾å­—äººèŒåŠ¡', 'ç­¾å­—äººèŒç§°',  # æ–°å¢ï¼šç­¾å­—äººèŒåŠ¡/èŒç§°
                'å…¨æƒä»£è¡¨èŒåŠ¡', 'å…¨æƒä»£è¡¨èŒç§°',  # æ–°å¢ï¼šå…¨æƒä»£è¡¨èŒåŠ¡/èŒç§°
                'ä»£è¡¨èŒåŠ¡', 'ä»£è¡¨èŒç§°',  # æ–°å¢ï¼šä»£è¡¨èŒåŠ¡/èŒç§°
                'è¢«æˆæƒäººèŒåŠ¡', 'è¢«æˆæƒäººèŒç§°'  # æ–°å¢ï¼šè¢«æˆæƒäººèŒåŠ¡/èŒç§°
            ],
            'authorizedPersonId': ['è¢«æˆæƒäººèº«ä»½è¯', 'æˆæƒäººèº«ä»½è¯', 'èº«ä»½è¯å·', 'èº«ä»½è¯å·ç ', 'è¢«æˆæƒäººèº«ä»½è¯å·', 'æˆæƒäººèº«ä»½è¯å·'],

            # å…¬å¸åŸºæœ¬ä¿¡æ¯
            'establishDate': [
                'æˆç«‹æ—¶é—´', 'æˆç«‹æ—¥æœŸ', 'æ³¨å†Œæ—¥æœŸ', 'æ³¨å†Œæ—¶é—´',
                'æˆç«‹å’Œæˆ–æ³¨å†Œæ—¥æœŸ', 'æˆç«‹å’Œ/æˆ–æ³¨å†Œæ—¥æœŸ'  # æ–°å¢ï¼šå¤„ç†ç‰¹æ®Šæ ¼å¼
            ],
            'businessScope': ['ç»è¥èŒƒå›´', 'ä¸šåŠ¡èŒƒå›´', 'ç»è¥å†…å®¹'],
            'registeredCapital': ['æ³¨å†Œèµ„æœ¬', 'æ³¨å†Œèµ„é‡‘', 'å®æ”¶èµ„æœ¬'],
            'socialCreditCode': ['ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ', 'ç¤¾ä¼šä¿¡ç”¨ä»£ç ', 'ä¿¡ç”¨ä»£ç '],
            'companyType': ['å…¬å¸ç±»å‹', 'ä¼ä¸šç±»å‹', 'ç»„ç»‡å½¢å¼', 'å•ä½æ€§è´¨', 'ä¼ä¸šæ€§è´¨'],
            'businessTerm': ['ç»è¥æœŸé™', 'è¥ä¸šæœŸé™', 'ç»è¥å¹´é™'],

            # æ—¥æœŸ
            'date': [
                'æ—¥æœŸ', 'date',
                'ç­¾å­—æ—¥æœŸ', 'ç­¾ç½²æ—¥æœŸ', 'è½æ¬¾æ—¥æœŸ'  # æ–°å¢ï¼šå¤„ç†å„ç§ç­¾ç½²æ—¥æœŸæ ¼å¼
            ],

            # è‚¡æƒç»“æ„å­—æ®µï¼ˆ2025-10-30æ·»åŠ ï¼Œ2025-11-09å¢å¼ºï¼‰
            'actual_controller': [
                'å®é™…æ§åˆ¶äºº', 'å®é™…æ§åˆ¶äººå§“å', 'å®é™…æ§åˆ¶äººåç§°',
                'å®æ§äºº', 'å®æ§äººå§“å'
            ],
            'controlling_shareholder': [
                'æ§è‚¡è‚¡ä¸œ', 'æ§è‚¡è‚¡ä¸œåç§°', 'æ§è‚¡è‚¡ä¸œåŠå‡ºèµ„æ¯”ä¾‹',
                'ç¬¬ä¸€å¤§è‚¡ä¸œ', 'æœ€å¤§è‚¡ä¸œ',
                'ä¾›åº”å•†çš„æ§è‚¡è‚¡ä¸œ/æŠ•èµ„äººåç§°åŠå‡ºèµ„æ¯”ä¾‹',  # ğŸ†• æ”¯æŒé•¿å­—æ®µå
                'ä¾›åº”å•†çš„æ§è‚¡è‚¡ä¸œ'  # æ”¯æŒéƒ¨åˆ†åŒ¹é…
            ],
            'shareholders_info': [
                'è‚¡ä¸œ', 'è‚¡ä¸œä¿¡æ¯', 'è‚¡ä¸œåç§°', 'æŠ•èµ„äººä¿¡æ¯',
                'è‚¡ä¸œåŠå‡ºèµ„æ¯”ä¾‹', 'æŠ•èµ„äººåç§°åŠå‡ºèµ„æ¯”ä¾‹',
                'ä¾›åº”å•†çš„æ§è‚¡è‚¡ä¸œ', 'ä¾›åº”å•†çš„éæ§è‚¡è‚¡ä¸œ',
                'ä¾›åº”å•†çš„éæ§è‚¡è‚¡ä¸œ/æŠ•èµ„äººåç§°åŠå‡ºèµ„æ¯”ä¾‹',  # ğŸ†• æ”¯æŒé•¿å­—æ®µå
                'è‚¡æƒç»“æ„'
            ],

            # ç®¡ç†å…³ç³»å­—æ®µï¼ˆ2025-10-30æ·»åŠ ï¼‰
            'managing_unit_name': [
                'ç®¡ç†å…³ç³»å•ä½', 'ç®¡ç†å…³ç³»å•ä½åç§°',
                'ä¸‹å±å•ä½', 'ä¸‹çº§å•ä½', 'åˆ†æ”¯æœºæ„'
            ],
            'managed_unit_name': [
                'è¢«ç®¡ç†å…³ç³»å•ä½', 'è¢«ç®¡ç†å…³ç³»å•ä½åç§°',
                'ä¸Šçº§å•ä½', 'ä¸»ç®¡å•ä½', 'éš¶å±å•ä½'
            ],
        }

        # åå‘æ˜ å°„ï¼šä»å˜ä½“åˆ°æ ‡å‡†å­—æ®µå
        self.reverse_map = {}
        for standard_name, variants in self.field_variants.items():
            for variant in variants:
                self.reverse_map[variant.lower()] = standard_name

    def recognize_field(self, field_text: str, enable_logging=False) -> Optional[str]:
        """
        è¯†åˆ«å­—æ®µåç§°ï¼Œè¿”å›æ ‡å‡†å­—æ®µå

        Args:
            field_text: åŸå§‹å­—æ®µæ–‡æœ¬
            enable_logging: æ˜¯å¦å¯ç”¨è¯¦ç»†æ—¥å¿—ï¼ˆç”¨äºè¯Šæ–­ï¼‰

        Returns:
            æ ‡å‡†å­—æ®µåï¼Œå¦‚ 'companyName', 'projectName' ç­‰
        """
        original_field_text = field_text

        # âœ… å…³é”®æ£€æŸ¥ï¼šå¦‚æœåŸå§‹å­—æ®µåŒ…å«ç­¾å­—/ç›–ç« ç›¸å…³å…³é”®è¯ï¼Œé€šå¸¸éœ€è¦è·³è¿‡
        # æ ¹æ®è§„åˆ™ï¼š"æ³•å®šä»£è¡¨äººï¼Œæˆæƒä»£è¡¨äººï¼Œåé¢å¸¦æœ‰"ç­¾å­—"å­—æ ·çš„ï¼Œä¸éœ€è¦åšå¡«ç©ºè§„åˆ™æˆ–æ›¿æ¢æ ¼å¼"
        signature_keywords = ['ç­¾å­—', 'ç­¾å', 'ç­¾ç« ', 'ç›–ç« å¤„']  # æ³¨æ„ï¼šä¸åŒ…æ‹¬å•ç‹¬çš„"ç›–ç« "ï¼Œå› ä¸ºæœ‰äº›å­—æ®µå¦‚"å•ä½åç§°ï¼ˆç›–ç« ï¼‰"éœ€è¦å¡«å……

        # ç‰¹æ®Šå¤„ç†ï¼šå¯¹äºä»¥ä¸‹å…³é”®äººå‘˜å­—æ®µï¼Œå¦‚æœåŒ…å«ç­¾å­—ç›¸å…³è¯ï¼Œåˆ™è·³è¿‡
        person_fields = ['æ³•å®šä»£è¡¨äºº', 'æ³•äººä»£è¡¨', 'æ³•äºº', 'æˆæƒä»£è¡¨', 'æˆæƒäºº', 'è¢«æˆæƒäºº', 'ä»£è¡¨äºº', 'è´Ÿè´£äºº']

        # æ£€æŸ¥æ˜¯å¦åŒ…å«ç­¾å­—ç›¸å…³å…³é”®è¯
        has_signature_keyword = any(keyword in original_field_text for keyword in signature_keywords)

        # ç‰¹æ®Šæ£€æŸ¥ï¼š"ï¼ˆç­¾å­—æˆ–ç›–ç« ï¼‰"è¿™ç§æ ¼å¼ä¹Ÿè¦è·³è¿‡
        if 'ç­¾å­—æˆ–ç›–ç« ' in original_field_text or 'ç­¾å­—åŠç›–ç« ' in original_field_text or 'ç­¾å­—å¹¶ç›–ç« ' in original_field_text:
            has_signature_keyword = True

        # æ£€æŸ¥æ˜¯å¦æ˜¯äººå‘˜å­—æ®µ
        is_person_field = any(field in original_field_text for field in person_fields)

        # å¦‚æœæ˜¯ç­¾å­—/ç›–ç« ç›¸å…³çš„äººå‘˜å­—æ®µï¼Œè¿”å›Noneè¡¨ç¤ºè·³è¿‡
        if has_signature_keyword and is_person_field:
            if enable_logging:
                from common import get_module_logger
                logger = get_module_logger("field_recognizer")
                logger.info(f"âš ï¸  è·³è¿‡ç­¾å­—/ç›–ç« å­—æ®µ: '{original_field_text}'")
            return None

        field_text = field_text.strip().lower()

        # ç§»é™¤å¸¸è§åç¼€
        field_text = re.sub(r'ï¼ˆ[^ï¼‰]*ï¼‰', '', field_text)  # ç§»é™¤æ‹¬å·
        field_text = field_text.replace('ï¼ˆç›–ç« ï¼‰', '').replace('ï¼ˆå…¬ç« ï¼‰', '')
        field_text = field_text.replace('ï¼ˆç­¾å­—ï¼‰', '').replace('ï¼ˆç­¾åï¼‰', '')
        field_text = field_text.strip()

        # âœ… å…³é”®ä¿®å¤ï¼šç§»é™¤å­—æ®µåä¸­çš„æ‰€æœ‰ç©ºæ ¼
        # å¤„ç†å¦‚"æ—¥      æœŸ"ï¼ˆæ—¥å’ŒæœŸä¹‹é—´æœ‰å¤šä¸ªç©ºæ ¼ï¼‰çš„æƒ…å†µ
        field_text = re.sub(r'\s+', '', field_text)

        # æŸ¥æ‰¾åŒ¹é…
        std_field = self.reverse_map.get(field_text)

        # âœ… è¯Šæ–­æ—¥å¿—ï¼šç‰¹åˆ«å…³æ³¨"å“åº”äººåç§°"ç›¸å…³å­—æ®µ
        if enable_logging or 'å“åº”' in original_field_text or 'åº”ç­”' in original_field_text:
            if std_field:
                # æ‰¾åˆ°åŒ¹é… - è¾“å‡ºinfoæ—¥å¿—
                pass  # ç”±ContentFillerè¾“å‡ºæˆåŠŸæ—¥å¿—
            else:
                # æœªæ‰¾åˆ°åŒ¹é… - è¾“å‡ºwarningæ—¥å¿—
                from common import get_module_logger
                logger = get_module_logger("field_recognizer")
                logger.warning(f"âš ï¸  å­—æ®µè¯†åˆ«å¤±è´¥: '{original_field_text}' â†’ (æ¸…ç†å) '{field_text}' â†’ æœªåŒ¹é…")

        return std_field

    def recognize_combo_fields(self, fields: List[str]) -> List[Optional[str]]:
        """è¯†åˆ«ç»„åˆå­—æ®µ"""
        return [self.recognize_field(f) for f in fields]
