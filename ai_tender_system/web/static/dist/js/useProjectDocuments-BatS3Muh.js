import{t as e}from"./tender-Bln5F12J.js";import{u as l}from"./project-CKYizDOQ.js";import{E as t}from"./index.js";import{am as s,an as a}from"./editor-Bn74SR7L.js";function o(){const o=l(),i=s([]),n=s(!1),r=s(null),p=s({tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null}),u=a(()=>i.value.find(e=>e.id===o.projectId)),c=a(()=>i.value.length>0),d=a(()=>null!==p.value.tenderFile),h=a(()=>null!==p.value.templateFile),_=a(()=>null!==p.value.technicalFile),v=async(l,s)=>{if(m(),(null==s?void 0:s.onClear)&&s.onClear(),l){try{const t=await e.getProject(l);t.data&&o.setCurrentProject(t.data)}catch(a){t.error("获取项目详情失败")}await f(l,s)}else o.clearCurrentProject()},f=async(l,s)=>{var a,o,i,u,c,d,h,_,v;n.value=!0;try{const n=(await e.getProject(l)).data;if(!n)return void t.warning("未找到项目数据");const r=n.step1_data,f={tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null};if(null==r?void 0:r.file_path){const e=(null==(a=(r.file_name||r.file_path.split("/").pop()||"招标文档").split(".").pop())?void 0:a.toLowerCase())||"doc";["doc","docx"].includes(e);f.tenderFile={name:r.file_name||"招标文档",url:r.file_path,status:"success",uid:Date.now()+Math.random(),size:r.file_size||0}}if(null==r?void 0:r.response_file_path){const e=r.response_file_path.split("/").pop()||"应答模板",l=(null==(o=e.split(".").pop())?void 0:o.toLowerCase())||"doc";["doc","docx"].includes(l);f.templateFile={name:e,url:r.response_file_path,status:"success",uid:Date.now()+Math.random()+1,size:0}}if(null==r?void 0:r.technical_file_path){const e=r.technical_file_path.split("/").pop()||"技术需求文档",l=(null==(i=e.split(".").pop())?void 0:i.toLowerCase())||"doc";["doc","docx"].includes(l);f.technicalFile={name:e,url:r.technical_file_path,status:"success",uid:Date.now()+Math.random()+2,size:0}}if(null==r?void 0:r.business_response_file){const e=r.business_response_file,t=(null==(c=((null==(u=e.file_path)?void 0:u.split("/").pop())||"商务应答文件").split(".").pop())?void 0:c.toLowerCase())||"docx",s=["doc","docx"].includes(t);f.businessResponseFile={success:!0,outputFile:e.file_path,downloadUrl:F(e.file_path),previewUrl:s?`/api/business-response/preview/${l}`:void 0,stats:e.stats||{},message:"该项目已有商务应答文件",isHistory:!0,generated_at:e.generated_at||r.updated_at}}if(null==r?void 0:r.technical_point_to_point_file){const e=r.technical_point_to_point_file,t=(null==(h=((null==(d=e.file_path)?void 0:d.split("/").pop())||"点对点应答文件").split(".").pop())?void 0:h.toLowerCase())||"docx",s=["doc","docx"].includes(t);f.p2pResponseFile={success:!0,outputFile:e.file_path,downloadUrl:F(e.file_path),previewUrl:s?`/api/point-to-point/preview/${l}`:void 0,stats:e.stats||{},message:"该项目已有点对点应答文件",isHistory:!0,generated_at:e.generated_at||r.updated_at}}if(null==r?void 0:r.technical_proposal_file){const e=r.technical_proposal_file,t=(null==(v=((null==(_=e.file_path)?void 0:_.split("/").pop())||"技术方案文件").split(".").pop())?void 0:v.toLowerCase())||"docx",s=["doc","docx"].includes(t);f.techProposalFile={success:!0,outputFile:e.file_path,downloadUrl:F(e.file_path),previewUrl:s?`/api/tech-proposal/preview/${l}`:void 0,stats:e.stats||{},message:"该项目已有技术方案文件",isHistory:!0,generated_at:e.generated_at||r.updated_at}}p.value=f,(null==s?void 0:s.onDocumentsLoaded)&&s.onDocumentsLoaded(f)}catch(f){r.value="加载项目文档失败",t.error(r.value)}finally{n.value=!1}},m=()=>{p.value={tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null}},F=e=>{if(e.startsWith("/api/"))return e.includes("?")?`${e}&download=true`:`${e}?download=true`;let l=e;const t="/Users/lvhe/Downloads/zhongbiao/zhongbiao/";return l.startsWith(t)&&(l=l.substring(42)),l.startsWith("ai_tender_system/data/")?l=l.substring(22):l.startsWith("data/")&&(l=l.substring(5)),`/api/files/serve/${l}?download=true`};return{projects:i,loading:n,error:r,currentDocuments:p,selectedProject:u,hasProjects:c,hasTenderFile:d,hasTemplateFile:h,hasTechnicalFile:_,loadProjects:async l=>{var s;n.value=!0,r.value=null;try{const a=await e.getProjects({page:1,page_size:100,...l});i.value=(null==(s=a.data)?void 0:s.items)||[],0===i.value.length&&t.warning("暂无项目数据")}catch(a){r.value="加载项目列表失败",t.error(r.value)}finally{n.value=!1}},handleProjectChange:v,loadProjectDocuments:f,clearDocuments:m,restoreProjectFromStore:async e=>o.projectId?(await v(o.projectId,e),o.projectId):null,filePathToUploadFile:(e,l)=>({name:l||e.split("/").pop()||"文件",url:e,status:"success",uid:Date.now()+Math.random(),size:0}),getDownloadUrl:F}}export{o as u};
