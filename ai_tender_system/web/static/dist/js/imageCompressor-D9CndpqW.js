const u={license:{maxWidth:1500,quality:.8,mimeType:"image/jpeg"},qualification:{maxWidth:1200,quality:.75,mimeType:"image/jpeg"},id_card:{maxWidth:1e3,quality:.7,mimeType:"image/jpeg"},seal:{maxWidth:800,quality:.85,mimeType:"image/jpeg"},photo:{maxWidth:800,quality:.75,mimeType:"image/jpeg"},default:{maxWidth:1200,quality:.75,mimeType:"image/jpeg"}},m={minFileSize:300*1024,minWidth:1200,minHeight:1200,pngToJpegSize:100*1024,minSavingRatio:.1};function y(e){return new Promise((r,t)=>{const o=new FileReader;o.onload=i=>{var n;const a=new Image;a.onload=()=>r(a),a.onerror=()=>t(new Error("图片加载失败")),a.src=(n=i.target)==null?void 0:n.result},o.onerror=()=>t(new Error("文件读取失败")),o.readAsDataURL(e)})}function I(e,r){const{size:t,type:o}=e,{width:i,height:a}=r;return t<100*1024?(console.log("[ImageCompressor] 文件<100KB，跳过压缩"),!1):t>m.minFileSize?(console.log("[ImageCompressor] 文件大小超过阈值，需要压缩"),!0):i>m.minWidth||a>m.minHeight?(console.log("[ImageCompressor] 图片尺寸过大，需要压缩"),!0):o==="image/png"&&t>m.pngToJpegSize?(console.log("[ImageCompressor] PNG图片>100KB，转JPEG可节省空间"),!0):(console.log("[ImageCompressor] 图片符合要求，不需要压缩"),!1)}async function C(e,r=u.default){try{const t=await y(e);if(console.log(`[ImageCompressor] 原始图片: ${t.width}x${t.height}, ${d(e.size)}`),!I(e,t))return e;let{width:o,height:i}=t;const a=r.maxWidth||1200,n=r.maxHeight||a;if(o>a||i>n){const g=Math.min(a/o,n/i);o=Math.round(o*g),i=Math.round(i*g)}const s=document.createElement("canvas");s.width=o,s.height=i;const l=s.getContext("2d");l.fillStyle="#FFFFFF",l.fillRect(0,0,o,i),l.drawImage(t,0,0,o,i);const x=await new Promise((g,w)=>{s.toBlob(h=>{h?g(h):w(new Error("Canvas转Blob失败"))},r.mimeType||"image/jpeg",r.quality||.75)}),p=new File([x],e.name.replace(/\.(png|jpg|jpeg|gif|bmp)$/i,".jpg"),{type:r.mimeType||"image/jpeg",lastModified:Date.now()}),c=(e.size-p.size)/e.size;return c<m.minSavingRatio?(console.log(`[ImageCompressor] 压缩效果不明显（节省${(c*100).toFixed(1)}%），使用原图`),e):(console.log(`[ImageCompressor] ✅ 压缩成功: ${t.width}x${t.height} → ${o}x${i}, ${d(e.size)} → ${d(p.size)} (节省${(c*100).toFixed(1)}%)`),p)}catch(t){return console.error("[ImageCompressor] 压缩失败:",t),e}}async function F(e,r="default"){if(!e.type.startsWith("image/"))return console.warn("[ImageCompressor] 不是图片文件，跳过压缩"),e;const t=u[r]||u.default;return C(e,t)}function d(e){return e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:`${(e/1024/1024).toFixed(2)} MB`}export{F as s};
