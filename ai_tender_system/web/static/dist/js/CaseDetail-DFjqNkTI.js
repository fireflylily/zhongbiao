import{Q as ke,d as we,I as Ue,G as Ee,f as Ie,q as xe,o as Re,i as De,g as Ae,h as Fe,aq as ze,z as Be,a as Q,D as $e,p as W,$ as Te,at as Ye,a0 as Ne,b as qe,R as Le,a8 as Me,as as Se,aD as Ge,ay as Pe,ar as Oe,F as je}from"./element-plus-IkZgpaz4.js";import{bT as X,bt as c,bA as Je,bG as H,bU as C,bV as i,c8 as e,c0 as t,c7 as j,cC as J,b$ as E,c5 as u,bY as d,bv as g,c4 as Qe,c6 as k,c3 as L,gd as We,gi as Xe}from"./vendor-CdA3MjAt.js";import{L as K}from"./Loading-CmykbBZp.js";/* empty css                                                                          */import"./umo-editor-BmhDOXHm.js";/* empty css                                                                        */import{a as Z,_ as ee}from"./index.js";import{a as He,f as Ke,k as A}from"./formatters-D7k9w9WL.js";import{E as Ze}from"./Empty-BNVBwC0L.js";import{s as ea}from"./imageCompressor-D9CndpqW.js";import{c as aa}from"./company-B1QhkZBS.js";import"./onnxruntime-DkHy2lK3.js";import"./mermaid-e-fO57px.js";import"./echarts-Cqw1j_Z-.js";const ta={class:"case-basic-info-tab"},la={class:"card-header"},oa={key:2,class:"attachments-grid"},na={class:"attachment-header"},sa={class:"attachment-body"},ra=["title"],ua={class:"file-info"},da={class:"file-size"},ca={class:"file-date"},ia={key:0,class:"file-desc"},pa={class:"attachment-actions"},_a=X({__name:"CaseBasicInfoTab",props:{caseId:{},caseData:{}},emits:["update"],setup(M,{emit:Y}){const I=M,b=Y,{success:w,error:p}=Z(),f=c(),x=c(!1),B=c([]),n=c({company_id:null,case_title:"",case_number:"",customer_name:"",product_category:"",industry:"金融",contract_type:"合同",final_customer_name:"",contract_amount:"",contract_start_date:"",contract_end_date:"",party_a_contact_name:"",party_a_contact_phone:"",party_a_contact_email:""}),v={company_id:[{required:!0,message:"请选择所属企业",trigger:"change"}],case_title:[{required:!0,message:"请输入案例标题",trigger:"blur"}],customer_name:[{required:!0,message:"请输入客户名称",trigger:"blur"}],contract_type:[{required:!0,message:"请选择合同类型",trigger:"change"}]},R=c(!1),F=c([]),V=c(!1),N=c(!1),$=c(),ae=c(),T=c([]),_=c({attachment_type:"contract",description:"",file:null}),te={attachment_type:[{required:!0,message:"请选择附件类型",trigger:"change"}]};Je(()=>I.caseData,l=>{l&&(n.value={company_id:l.company_id||null,case_title:l.case_title||"",case_number:l.case_number||"",customer_name:l.customer_name||"",product_category:l.product_category||"",industry:l.industry||"金融",contract_type:l.contract_type||"合同",final_customer_name:l.final_customer_name||"",contract_amount:l.contract_amount||"",contract_start_date:l.contract_start_date||"",contract_end_date:l.contract_end_date||"",party_a_contact_name:l.party_a_contact_name||"",party_a_contact_phone:l.party_a_contact_phone||"",party_a_contact_email:l.party_a_contact_email||""})},{immediate:!0,deep:!0});const le=async()=>{try{const l=await aa.getCompanies();l.success&&l.data&&(B.value=l.data)}catch(l){console.error("加载企业列表失败:",l)}},oe=async()=>{f.value&&await f.value.validate(async l=>{if(l){x.value=!0;try{const a=await A.updateCase(I.caseId,n.value);a.success?(w("保存成功","案例信息已更新"),b("update")):p("保存失败",a.error||"未知错误")}catch(a){console.error("保存案例信息失败:",a),p("保存失败",a instanceof Error?a.message:"未知错误")}finally{x.value=!1}}})},ne=()=>{var l;(l=f.value)==null||l.resetFields()},se=l=>{switch(l){case"contract":return je;case"acceptance":return Oe;case"testimony":return Pe;case"photo":return Ge;default:return Se}},re=l=>{switch(l){case"contract":return"#409eff";case"acceptance":return"#67c23a";case"testimony":return"#e6a23c";case"photo":return"#f56c6c";default:return"#909399"}},ue=l=>{switch(l){case"contract":return"primary";case"acceptance":return"success";case"testimony":return"warning";case"photo":return"danger";default:return"info"}},de=l=>{switch(l){case"contract":return"合同文件";case"acceptance":return"验收证明";case"testimony":return"客户证明";case"photo":return"项目照片";default:return"其他材料"}},q=async()=>{R.value=!0;try{const l=await A.getCaseAttachments(I.caseId);l.success&&l.data&&(F.value=l.data)}catch(l){console.error("加载附件列表失败:",l),p("加载失败",l instanceof Error?l.message:"未知错误")}finally{R.value=!1}},ce=l=>{if(l.raw){if(l.raw.size>20971520){p("文件过大","文件大小不能超过20MB"),T.value=[],_.value.file=null;return}_.value.file=l.raw}},ie=()=>{_.value.file=null},pe=()=>{V.value=!0},_e=async()=>{$.value&&await $.value.validate(async l=>{if(l){if(!_.value.file){p("请选择文件","请先选择要上传的文件");return}N.value=!0;try{let a=_.value.file;if(a.type.startsWith("image/")){const D=_.value.attachment_type==="photo"?"photo":"default";a=await ea(a,D),console.log("[CaseBasicInfo] 图片已压缩")}const s=await A.uploadCaseAttachment(I.caseId,a,_.value.attachment_type,_.value.description||void 0);s.success?(w("上传成功","附件已上传"),V.value=!1,await q(),b("update")):p("上传失败",s.error||"未知错误")}catch(a){console.error("上传附件失败:",a),p("上传失败",a instanceof Error?a.message:"未知错误")}finally{N.value=!1}}})},me=()=>{var l;T.value=[],_.value={attachment_type:"contract",description:"",file:null},(l=$.value)==null||l.resetFields()},fe=l=>{const a=A.downloadCaseAttachment(l.attachment_id);window.open(a,"_blank")},ve=async l=>{try{if(!confirm(`确定要删除附件 "${l.original_filename}" 吗？`))return;const a=await A.deleteCaseAttachment(l.attachment_id);a.success?(w("删除成功","附件已删除"),await q(),b("update")):p("删除失败",a.error||"未知错误")}catch(a){console.error("删除附件失败:",a),p("删除失败",a instanceof Error?a.message:"未知错误")}};return H(()=>{le(),q()}),(l,a)=>{const s=Re,D=xe,r=Ie,m=Ee,h=Ue,y=De,S=Fe,ye=Ae,G=ze,ge=Be,U=Q,P=we,O=ke,z=$e,be=W,Ve=Le,he=qe;return i(),C("div",ta,[e(O,{style:{"margin-bottom":"20px"}},{header:t(()=>[...a[19]||(a[19]=[d("span",null,"案例基本信息",-1)])]),default:t(()=>[e(P,{ref_key:"formRef",ref:f,model:n.value,rules:v,"label-width":"140px"},{default:t(()=>[e(h,{gutter:20},{default:t(()=>[e(m,{span:12},{default:t(()=>[e(r,{label:"所属企业",prop:"company_id"},{default:t(()=>[e(D,{modelValue:n.value.company_id,"onUpdate:modelValue":a[0]||(a[0]=o=>n.value.company_id=o),placeholder:"请选择企业",filterable:"",style:{width:"100%"}},{default:t(()=>[(i(!0),C(j,null,J(B.value,o=>(i(),E(s,{key:o.company_id,label:o.company_name,value:o.company_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(h,{gutter:20},{default:t(()=>[e(m,{span:12},{default:t(()=>[e(r,{label:"案例标题",prop:"case_title"},{default:t(()=>[e(y,{modelValue:n.value.case_title,"onUpdate:modelValue":a[1]||(a[1]=o=>n.value.case_title=o),placeholder:"请输入案例标题/合同名称"},null,8,["modelValue"])]),_:1})]),_:1}),e(m,{span:12},{default:t(()=>[e(r,{label:"案例编号",prop:"case_number"},{default:t(()=>[e(y,{modelValue:n.value.case_number,"onUpdate:modelValue":a[2]||(a[2]=o=>n.value.case_number=o),placeholder:"请输入案例编号（可选）"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(h,{gutter:20},{default:t(()=>[e(m,{span:12},{default:t(()=>[e(r,{label:"客户名称",prop:"customer_name"},{default:t(()=>[e(y,{modelValue:n.value.customer_name,"onUpdate:modelValue":a[3]||(a[3]=o=>n.value.customer_name=o),placeholder:"请输入甲方客户名称"},null,8,["modelValue"])]),_:1})]),_:1}),e(m,{span:12},{default:t(()=>[e(r,{label:"产品分类",prop:"product_category"},{default:t(()=>[e(D,{modelValue:n.value.product_category,"onUpdate:modelValue":a[4]||(a[4]=o=>n.value.product_category=o),placeholder:"请选择产品分类",clearable:"",style:{width:"100%"}},{default:t(()=>[e(s,{label:"风控产品",value:"风控产品"}),e(s,{label:"实修",value:"实修"}),e(s,{label:"免密",value:"免密"}),e(s,{label:"风控位置",value:"风控位置"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(h,{gutter:20},{default:t(()=>[e(m,{span:12},{default:t(()=>[e(r,{label:"所属行业",prop:"industry"},{default:t(()=>[e(D,{modelValue:n.value.industry,"onUpdate:modelValue":a[5]||(a[5]=o=>n.value.industry=o),placeholder:"请选择行业",clearable:"",style:{width:"100%"}},{default:t(()=>[e(s,{label:"科技",value:"科技"}),e(s,{label:"制造业",value:"制造业"}),e(s,{label:"金融",value:"金融"}),e(s,{label:"教育",value:"教育"}),e(s,{label:"医疗",value:"医疗"}),e(s,{label:"建筑",value:"建筑"}),e(s,{label:"其他",value:"其他"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(m,{span:12},{default:t(()=>[e(r,{label:"合同类型",prop:"contract_type"},{default:t(()=>[e(ye,{modelValue:n.value.contract_type,"onUpdate:modelValue":a[6]||(a[6]=o=>n.value.contract_type=o)},{default:t(()=>[e(S,{label:"合同"},{default:t(()=>[...a[20]||(a[20]=[u("合同",-1)])]),_:1}),e(S,{label:"订单"},{default:t(()=>[...a[21]||(a[21]=[u("订单",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(h,{gutter:20},{default:t(()=>[e(m,{span:12},{default:t(()=>[e(r,{label:"合同金额",prop:"contract_amount"},{default:t(()=>[e(y,{modelValue:n.value.contract_amount,"onUpdate:modelValue":a[7]||(a[7]=o=>n.value.contract_amount=o),placeholder:"如：100万元、百万级"},{append:t(()=>[...a[22]||(a[22]=[u("元",-1)])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(h,{gutter:20},{default:t(()=>[e(m,{span:12},{default:t(()=>[e(r,{label:"最终客户",prop:"final_customer_name"},{default:t(()=>[e(y,{modelValue:n.value.final_customer_name,"onUpdate:modelValue":a[8]||(a[8]=o=>n.value.final_customer_name=o),placeholder:"订单类型时填写最终客户",disabled:n.value.contract_type!=="订单"},null,8,["modelValue","disabled"])]),_:1})]),_:1}),e(m,{span:12},{default:t(()=>[e(r,{label:"合同开始日期",prop:"contract_start_date"},{default:t(()=>[e(G,{modelValue:n.value.contract_start_date,"onUpdate:modelValue":a[9]||(a[9]=o=>n.value.contract_start_date=o),type:"date",placeholder:"选择开始日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(h,{gutter:20},{default:t(()=>[e(m,{span:12},{default:t(()=>[e(r,{label:"合同结束日期",prop:"contract_end_date"},{default:t(()=>[e(G,{modelValue:n.value.contract_end_date,"onUpdate:modelValue":a[10]||(a[10]=o=>n.value.contract_end_date=o),type:"date",placeholder:"选择结束日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(ge,{"content-position":"left"},{default:t(()=>[...a[23]||(a[23]=[u("客户联系方式",-1)])]),_:1}),e(h,{gutter:20},{default:t(()=>[e(m,{span:8},{default:t(()=>[e(r,{label:"联系人姓名",prop:"party_a_contact_name"},{default:t(()=>[e(y,{modelValue:n.value.party_a_contact_name,"onUpdate:modelValue":a[11]||(a[11]=o=>n.value.party_a_contact_name=o),placeholder:"联系人"},null,8,["modelValue"])]),_:1})]),_:1}),e(m,{span:8},{default:t(()=>[e(r,{label:"联系电话",prop:"party_a_contact_phone"},{default:t(()=>[e(y,{modelValue:n.value.party_a_contact_phone,"onUpdate:modelValue":a[12]||(a[12]=o=>n.value.party_a_contact_phone=o),placeholder:"联系电话"},null,8,["modelValue"])]),_:1})]),_:1}),e(m,{span:8},{default:t(()=>[e(r,{label:"联系邮箱",prop:"party_a_contact_email"},{default:t(()=>[e(y,{modelValue:n.value.party_a_contact_email,"onUpdate:modelValue":a[13]||(a[13]=o=>n.value.party_a_contact_email=o),placeholder:"邮箱地址"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(r,null,{default:t(()=>[e(U,{type:"primary",loading:x.value,onClick:oe},{default:t(()=>[...a[24]||(a[24]=[u(" 保存 ",-1)])]),_:1},8,["loading"]),e(U,{onClick:ne},{default:t(()=>[...a[25]||(a[25]=[u("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),e(O,null,{header:t(()=>[d("div",la,[a[27]||(a[27]=d("span",null,"案例附件",-1)),e(U,{type:"primary",size:"small",onClick:pe},{default:t(()=>[e(z,null,{default:t(()=>[e(g(Ne))]),_:1}),a[26]||(a[26]=u(" 上传附件 ",-1))]),_:1})])]),default:t(()=>[R.value?(i(),E(g(K),{key:0,text:"加载附件中..."})):F.value.length?(i(),C("div",oa,[(i(!0),C(j,null,J(F.value,o=>(i(),C("div",{key:o.attachment_id,class:"attachment-card"},[d("div",na,[e(z,{size:32,color:re(o.attachment_type)},{default:t(()=>[(i(),E(Qe(se(o.attachment_type))))]),_:2},1032,["color"]),e(be,{type:ue(o.attachment_type),size:"small"},{default:t(()=>[u(k(de(o.attachment_type)),1)]),_:2},1032,["type"])]),d("div",sa,[d("div",{class:"file-name",title:o.original_filename},k(o.original_filename),9,ra),d("div",ua,[d("span",da,k(g(He)(o.file_size)),1),d("span",ca,k(g(Ke)(o.uploaded_at,"date")),1)]),o.attachment_description?(i(),C("div",ia,k(o.attachment_description),1)):L("",!0)]),d("div",pa,[e(U,{size:"small",onClick:Ce=>fe(o)},{default:t(()=>[e(z,null,{default:t(()=>[e(g(Te))]),_:1}),a[28]||(a[28]=u(" 下载 ",-1))]),_:1},8,["onClick"]),e(U,{size:"small",type:"danger",onClick:Ce=>ve(o)},{default:t(()=>[e(z,null,{default:t(()=>[e(g(Ye))]),_:1}),a[29]||(a[29]=u(" 删除 ",-1))]),_:1},8,["onClick"])])]))),128))])):(i(),E(g(Ze),{key:1,type:"no-data",description:"暂无附件"}))]),_:1}),e(he,{modelValue:V.value,"onUpdate:modelValue":a[18]||(a[18]=o=>V.value=o),title:"上传案例附件",width:"500px",onClose:me},{footer:t(()=>[e(U,{onClick:a[17]||(a[17]=o=>V.value=!1)},{default:t(()=>[...a[32]||(a[32]=[u("取消",-1)])]),_:1}),e(U,{type:"primary",loading:N.value,onClick:_e},{default:t(()=>[...a[33]||(a[33]=[u(" 确定上传 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[e(P,{ref_key:"uploadFormRef",ref:$,model:_.value,rules:te,"label-width":"120px"},{default:t(()=>[e(r,{label:"附件类型",prop:"attachment_type"},{default:t(()=>[e(D,{modelValue:_.value.attachment_type,"onUpdate:modelValue":a[14]||(a[14]=o=>_.value.attachment_type=o),placeholder:"请选择附件类型",style:{width:"100%"}},{default:t(()=>[e(s,{label:"合同文件",value:"contract"}),e(s,{label:"验收证明",value:"acceptance"}),e(s,{label:"客户证明",value:"testimony"}),e(s,{label:"项目照片",value:"photo"}),e(s,{label:"其他材料",value:"other"})]),_:1},8,["modelValue"])]),_:1}),e(r,{label:"附件说明",prop:"description"},{default:t(()=>[e(y,{modelValue:_.value.description,"onUpdate:modelValue":a[15]||(a[15]=o=>_.value.description=o),type:"textarea",rows:2,placeholder:"请简要说明附件内容（可选）"},null,8,["modelValue"])]),_:1}),e(r,{label:"选择文件",prop:"file"},{default:t(()=>[e(Ve,{ref_key:"uploadRef",ref:ae,"file-list":T.value,"onUpdate:fileList":a[16]||(a[16]=o=>T.value=o),"auto-upload":!1,limit:1,"on-change":ce,"on-remove":ie,accept:".pdf,.doc,.docx,.jpg,.jpeg,.png",drag:""},{tip:t(()=>[...a[30]||(a[30]=[d("div",{class:"el-upload__tip"}," 支持PDF、DOC、DOCX、JPG、PNG格式，文件大小不超过20MB ",-1)])]),default:t(()=>[e(z,{class:"el-icon--upload"},{default:t(()=>[e(g(Me))]),_:1}),a[31]||(a[31]=d("div",{class:"el-upload__text"},[u(" 拖拽文件到这里 或 "),d("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),ma=ee(_a,[["__scopeId","data-v-e9280fb1"]]),fa={class:"case-detail"},va={class:"detail-header"},ya={class:"header-title"},ga={key:1,class:"detail-content"},ba=X({__name:"CaseDetail",setup(M){const Y=We(),I=Xe(),{error:b}=Z(),w=c(!1),p=c(0),f=c({}),x=async()=>{w.value=!0;try{const v=await A.getCase(p.value);v.success&&v.data?f.value=v.data:(b("加载失败","无法获取案例信息"),n())}catch(v){console.error("加载案例数据失败:",v),b("加载失败",v instanceof Error?v.message:"未知错误"),n()}finally{w.value=!1}},B=async()=>{await x()},n=()=>{I.push("/knowledge/case-library")};return H(()=>{const v=Y.params.id;if(v){if(p.value=parseInt(v,10),isNaN(p.value)){b("参数错误","无效的案例ID"),n();return}x()}else b("参数错误","缺少案例ID"),n()}),(v,R)=>{const F=Q,V=W;return i(),C("div",fa,[d("div",va,[e(F,{onClick:n,icon:"ArrowLeft"},{default:t(()=>[...R[0]||(R[0]=[u("返回列表",-1)])]),_:1}),d("div",ya,[d("h2",null,k(f.value.case_title||"案例详情"),1),f.value.contract_type?(i(),E(V,{key:0,type:f.value.contract_type==="合同"?"primary":"success"},{default:t(()=>[u(k(f.value.contract_type),1)]),_:1},8,["type"])):L("",!0),f.value.product_category?(i(),E(V,{key:1,type:"primary"},{default:t(()=>[u(k(f.value.product_category),1)]),_:1})):L("",!0)])]),w.value?(i(),E(g(K),{key:0,text:"加载案例信息中..."})):(i(),C("div",ga,[e(ma,{"case-id":p.value,"case-data":f.value,onUpdate:B},null,8,["case-id","case-data"])]))])}}}),Ba=ee(ba,[["__scopeId","data-v-ea362180"]]);export{Ba as default};
