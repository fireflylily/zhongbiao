import{_ as e}from"./_plugin-vue_export-helper-BZqs1yfm.js";/* empty css                             */import{E as a}from"./el-link-BuPnVljO.js";import{E as t}from"./el-statistic-DCfNmxCT.js";import"./el-alert-CXP7XODY.js";/* empty css                */import{E as l,a as s}from"./el-form-item-B_TvUsZB.js";import{E as n,a as o}from"./el-col-DR3qk7qZ.js";/* empty css                 *//* empty css               */import{E as r,a as i}from"./el-select-bIavA1Zf.js";import"./el-scrollbar-CxZt4BCk.js";/* empty css                   */import{aZ as u,r as d,b as c,a_ as p,d as m,a$ as v,b0 as f,ah as g,w as _,ai as b,g as h,aj as y,a9 as x,ac as w,b1 as j,W as k,y as C,b2 as V,aa as I,an as $,b3 as E,b4 as A,x as F,A as B,B as L,o as P,c as U,a0 as z,e as S,D,aA as T,L as N,F as R,a6 as M,aB as H,E as O,k as W,l as q,t as Z,b5 as G,b6 as Q,b7 as X}from"./index.js";import{r as Y}from"./DocumentPreview.vue_vue_type_style_index_0_scoped_c8a3e4c1_lang-CvTZjc9R.js";/* empty css                 */import{S as J}from"./SSEStreamViewer-BJRR3Exz.js";import{D as K}from"./DocumentUploader-BqXA_oX2.js";import{E as ee}from"./index-TEIk0rR2.js";import{E as ae}from"./index--8zZ-JUF.js";import{t as te}from"./tender-OU9NbYj0.js";import{u as le}from"./project-CBLXNrR9.js";import{E as se}from"./index-ELBiC1Q4.js";import{E as ne}from"./index-DzZX4pf4.js";import{E as oe,a as re}from"./index-Co1ZqTs4.js";import"./castArray-pal66jBx.js";import"./_baseClone-DZAH0W8r.js";import"./index-_IbxD8AI.js";import"./strings-DTuDRpJG.js";import"./index-IN6Zpv5z.js";import"./refs-Cw5r5QN8.js";const ie={async processBusinessResponse(e){const a=new FormData;return a.append("company_id",e.company_id.toString()),a.append("project_name",e.project_name),e.tender_no&&a.append("tender_no",e.tender_no),e.date_text&&a.append("date_text",e.date_text),a.append("hitl_file_path",e.hitl_file_path),a.append("use_mcp",!1!==e.use_mcp?"true":"false"),u.post("/process-business-response",a,{headers:{"Content-Type":"multipart/form-data"}})}};function ue(e,a){let t;const l=d(!1),s=c({...e,originalPosition:"",originalOverflow:"",visible:!1});function n(){var e,a;null==(a=null==(e=u.$el)?void 0:e.parentNode)||a.removeChild(u.$el)}function o(){if(!l.value)return;const e=s.parent;l.value=!1,e.vLoadingAddClassList=void 0,function(){const e=s.parent,a=u.ns;if(!e.vLoadingAddClassList){let t=e.getAttribute("loading-number");t=Number.parseInt(t)-1,t?e.setAttribute("loading-number",t.toString()):(w(e,a.bm("parent","relative")),e.removeAttribute("loading-number")),w(e,a.bm("parent","hidden"))}n(),i.unmount()}()}const r=m({name:"ElLoading",setup(e,{expose:a}){const{ns:t,zIndex:l}=f("loading");return a({ns:t,zIndex:l}),()=>{const e=s.spinner||s.svg,a=g("svg",{class:"circular",viewBox:s.svgViewBox?s.svgViewBox:"0 0 50 50",...e?{innerHTML:e}:{}},[g("circle",{class:"path",cx:"25",cy:"25",r:"20",fill:"none"})]),l=s.text?g("p",{class:t.b("text")},[s.text]):void 0;return g(x,{name:t.b("fade"),onAfterLeave:o},{default:_(()=>[b(h("div",{style:{backgroundColor:s.background||""},class:[t.b("mask"),s.customClass,s.fullscreen?"is-fullscreen":""]},[g("div",{class:t.b("spinner")},[a,l])]),[[y,s.visible]])])})}}}),i=p(r);Object.assign(i._context,null!=a?a:{});const u=i.mount(document.createElement("div"));return{...v(s),setText:function(e){s.text=e},removeElLoadingChild:n,close:function(){var a;e.beforeClose&&!e.beforeClose()||(l.value=!0,clearTimeout(t),t=setTimeout(o,400),s.visible=!1,null==(a=e.closed)||a.call(e))},handleAfterLeave:o,vm:u,get $el(){return u.$el}}}let de;const ce=function(e={},a){if(!j)return;const t=pe(e);if(t.fullscreen&&de)return de;const l=ue({...t,closed:()=>{var e;null==(e=t.closed)||e.call(t),t.fullscreen&&(de=void 0)}},null!=a?a:ce._context);me(t,t.parent,l),ve(t,t.parent,l),t.parent.vLoadingAddClassList=()=>ve(t,t.parent,l);let s=t.parent.getAttribute("loading-number");return s=s?`${Number.parseInt(s)+1}`:"1",t.parent.setAttribute("loading-number",s),t.parent.appendChild(l.$el),k(()=>l.visible.value=t.visible),t.fullscreen&&(de=l),l},pe=e=>{var a,t,l,s;let n;return n=C(e.target)?null!=(a=document.querySelector(e.target))?a:document.body:e.target||document.body,{parent:n===document.body||e.body?document.body:n,background:e.background||"",svg:e.svg||"",svgViewBox:e.svgViewBox||"",spinner:e.spinner||!1,text:e.text||"",fullscreen:n===document.body&&(null==(t=e.fullscreen)||t),lock:null!=(l=e.lock)&&l,customClass:e.customClass||"",visible:null==(s=e.visible)||s,beforeClose:e.beforeClose,closed:e.closed,target:n}},me=async(e,a,t)=>{const{nextZIndex:l}=t.vm.zIndex||t.vm._.exposed.zIndex,s={};if(e.fullscreen)t.originalPosition.value=V(document.body,"position"),t.originalOverflow.value=V(document.body,"overflow"),s.zIndex=l();else if(e.parent===document.body){t.originalPosition.value=V(document.body,"position"),await k();for(const a of["top","left"]){const t="top"===a?"scrollTop":"scrollLeft";s[a]=e.target.getBoundingClientRect()[a]+document.body[t]+document.documentElement[t]-Number.parseInt(V(document.body,`margin-${a}`),10)+"px"}for(const a of["height","width"])s[a]=`${e.target.getBoundingClientRect()[a]}px`}else t.originalPosition.value=V(a,"position");for(const[n,o]of Object.entries(s))t.$el.style[n]=o},ve=(e,a,t)=>{const l=t.vm.ns||t.vm._.exposed.ns;["absolute","fixed","sticky"].includes(t.originalPosition.value)?w(a,l.bm("parent","relative")):I(a,l.bm("parent","relative")),e.fullscreen&&e.lock?I(a,l.bm("parent","hidden")):w(a,l.bm("parent","hidden"))};ce._context=null;const fe=Symbol("ElLoading"),ge=e=>`element-loading-${A(e)}`,_e=(e,a)=>{var t,l,s,n;const o=a.instance,r=e=>$(a.value)?a.value[e]:void 0,i=a=>(e=>{const a=C(e)&&(null==o?void 0:o[e])||e;return d(a)})(r(a)||e.getAttribute(ge(a))),u=null!=(t=r("fullscreen"))?t:a.modifiers.fullscreen,c={text:i("text"),svg:i("svg"),svgViewBox:i("svgViewBox"),spinner:i("spinner"),background:i("background"),customClass:i("customClass"),fullscreen:u,target:null!=(l=r("target"))?l:u?void 0:e,body:null!=(s=r("body"))?s:a.modifiers.body,lock:null!=(n=r("lock"))?n:a.modifiers.lock},p=ce(c);p._context=be._context,e[fe]={options:c,instance:p}},be={mounted(e,a){a.value&&_e(e,a)},updated(e,a){const t=e[fe];if(!a.value)return null==t||t.instance.close(),void(e[fe]=null);t?((e,a)=>{for(const t of Object.keys(e))E(e[t])&&(e[t].value=a[t])})(t.options,$(a.value)?a.value:{text:e.getAttribute(ge("text")),svg:e.getAttribute(ge("svg")),svgViewBox:e.getAttribute(ge("svgViewBox")),spinner:e.getAttribute(ge("spinner")),background:e.getAttribute(ge("background")),customClass:e.getAttribute(ge("customClass"))}):_e(e,a)},unmounted(e){var a;null==(a=e[fe])||a.instance.close(),e[fe]=null},_context:null},he={"element-loading-text":"正在加载文档...",class:"preview-container"},ye=e(m({__name:"DocumentPreview",props:{modelValue:{type:Boolean,default:!1},fileUrl:{default:""},fileName:{default:"文档预览"}},emits:["update:modelValue"],setup(e,{emit:a}){const t=e,l=a,s=d(!1),n=d(""),o=d(null),r=F({get:()=>t.modelValue,set:e=>l("update:modelValue",e)}),i=F(()=>`文档预览 - ${t.fileName||"未命名文档"}`),u=()=>{r.value=!1};return B(()=>t.modelValue,async e=>{e&&t.fileUrl?(await k(),(async()=>{if(t.fileUrl){s.value=!0,n.value="";try{const e=await fetch(t.fileUrl);if(!e.ok)throw new Error(`HTTP错误: ${e.status}`);const a=await e.arrayBuffer();if(await k(),!o.value)throw new Error("预览容器未找到");o.value.innerHTML="",await Y(a,o.value,void 0,{className:"docx-preview",inWrapper:!0,ignoreWidth:!1,ignoreHeight:!1,ignoreFonts:!1,breakPages:!0,ignoreLastRenderedPageBreak:!0,experimental:!0,trimXmlDeclaration:!0})}catch(e){n.value=`文档预览失败: ${e.message||"未知错误"}`,T.error("文档预览失败，请检查文件是否正确或尝试下载后查看")}finally{s.value=!1}}else n.value="文档地址不能为空"})()):(n.value="",o.value&&(o.value.innerHTML=""))}),(e,a)=>{const t=ae,l=ee,d=be;return P(),L(l,{modelValue:r.value,"onUpdate:modelValue":a[0]||(a[0]=e=>r.value=e),title:i.value,width:"80%","before-close":u,"destroy-on-close":""},{default:_(()=>[b((P(),U("div",he,[n.value?(P(),L(t,{key:0,type:"error",title:n.value,closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}},null,8,["title"])):z("",!0),S("div",{ref_key:"previewContentRef",ref:o,class:"preview-content",style:D({display:n.value?"none":"block"})},null,4)])),[[d,s.value]])]),_:1},8,["modelValue","title"])}}}),[["__scopeId","data-v-c8a3e4c1"]]),xe={class:"business-response"},we={class:"upload-item"},je={class:"upload-item"},ke={class:"generation-controls"},Ce={class:"card-header"},Ve={class:"card-header"},Ie={class:"header-actions"},$e={class:"result-content"},Ee={class:"stats-section"},Ae={class:"file-info-section"},Fe=e(m({__name:"Response",setup(e){const u=le(),c=d({projectId:null,tenderFiles:[],templateFiles:[]}),p=d([]),m=F(()=>p.value.find(e=>e.id===c.value.projectId)),v=F(()=>c.value.projectId&&c.value.templateFiles.length>0),f=d(!1),g=d(0),b=d(""),y=d(null),x=d(!1),w=async()=>{if(y.value=null,b.value="",c.value.projectId){const e=p.value.find(e=>e.id===c.value.projectId);e&&u.setCurrentProject(e),await j(c.value.projectId)}},j=async e=>{try{const a=(await te.getProject(e)).data;if(c.value.tenderFiles=[],c.value.templateFiles=[],!a)return;let t=0,l=!1;if(a.step1_data&&a.step1_data.file_path){const e=a.step1_data;c.value.tenderFiles.push({name:e.file_name||e.original_filename||"招标文档",url:e.file_path,status:"success",uid:Date.now()+Math.random(),size:e.file_size}),t++,l=!0}if(!l&&a.tender_document_path&&(c.value.tenderFiles.push({name:a.original_filename||"招标文档",url:a.tender_document_path,status:"success",uid:Date.now()+Math.random()}),t++),a.step1_data){const e=a.step1_data;e.response_file_path&&(c.value.templateFiles.push({name:e.response_filename||"商务应答模板",url:e.response_file_path,status:"success",uid:Date.now()+Math.random(),size:e.response_file_size}),t++)}t>0&&T.success(`已加载 ${t} 个文件`)}catch(a){c.value.tenderFiles=[],c.value.templateFiles=[]}},k=()=>{T.success("招标文档上传成功")},C=()=>{T.success("商务应答模板上传成功")},V=async()=>{var e;if(c.value.projectId)if(0!==c.value.templateFiles.length){f.value=!0,g.value=0,b.value="",y.value=null;try{b.value="正在加载项目信息...\n";const a=(await te.getProject(c.value.projectId)).data,t=null==(e=a.step1_data)?void 0:e.response_file_path;if(!t)throw new Error("未找到商务应答模板文件路径，请先在标书管理中上传模板");b.value+="正在处理商务应答文档...\n",g.value=30;const l=await ie.processBusinessResponse({company_id:a.company_id,project_name:a.project_name,tender_no:a.project_number||"",date_text:a.bidding_time||"",hitl_file_path:t,use_mcp:!0});if(g.value=80,b.value+="处理完成，正在生成结果...\n",!l.data.success)throw new Error(l.data.message||"处理失败");g.value=100,b.value+=l.data.message+"\n",y.value={success:!0,outputFile:l.data.output_file,downloadUrl:l.data.download_url,stats:l.data.stats||{},message:l.data.message},T.success("商务应答生成完成！")}catch(a){b.value+=`\n❌ 错误: ${a.message}\n`,T.error(a.message||"生成失败，请重试")}finally{f.value=!1,g.value<100&&(g.value=0)}}else T.warning("请先上传商务应答模板");else T.warning("请先选择项目")},I=()=>{f.value=!1,T.info("已停止生成")},$=()=>{y.value?y.value.downloadUrl?x.value=!0:T.warning("文档地址无效"):T.warning("暂无文档可预览")},E=()=>{var e;if(y.value)try{const a=y.value.downloadUrl,t=`商务应答-${(null==(e=m.value)?void 0:e.project_name)||"文档"}-${Date.now()}.docx`,l=document.createElement("a");l.href=a,l.download=t,l.target="_blank",document.body.appendChild(l),l.click(),document.body.removeChild(l),T.success("Word文档下载成功")}catch(a){T.error("文档下载失败，请重试")}else T.warning("暂无文档可下载")};return N(async()=>{await(async()=>{var e;try{const a=await te.getProjects({page:1,page_size:100});p.value=(null==(e=a.data)?void 0:e.items)||[]}catch(a){T.error("加载项目列表失败")}})(),u.currentProject&&u.currentProject.id&&(c.value.projectId=u.currentProject.id,await w())}),(e,u)=>{var d,j;const A=i,F=r,B=s,D=o,T=O,N=n,Y=l,ee=se,te=q,le=ne,ie=ae,ue=t,de=oe,ce=a,pe=re;return P(),U("div",xe,[h(ee,{class:"project-section",shadow:"never"},{header:_(()=>[...u[4]||(u[4]=[S("div",{class:"card-header"},[S("span",null,"Step 1: 选择项目")],-1)])]),default:_(()=>[h(Y,{model:c.value,"label-width":"100px"},{default:_(()=>[h(N,{gutter:20},{default:_(()=>[h(D,{span:12},{default:_(()=>[h(B,{label:"项目"},{default:_(()=>[h(F,{modelValue:c.value.projectId,"onUpdate:modelValue":u[0]||(u[0]=e=>c.value.projectId=e),placeholder:"请选择项目",filterable:"",onChange:w,style:{width:"100%"}},{default:_(()=>[(P(!0),U(M,null,H(p.value,e=>(P(),L(A,{key:e.id,label:`${e.project_name} (${e.project_number||"-"})`,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),h(D,{span:12},{default:_(()=>[h(B,{label:"公司"},{default:_(()=>{var e;return[h(T,{value:(null==(e=m.value)?void 0:e.company_name)||"-",disabled:""},null,8,["value"])]}),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),c.value.projectId?(P(),L(ee,{key:0,class:"upload-section",shadow:"never"},{header:_(()=>[...u[5]||(u[5]=[S("div",{class:"card-header"},[S("span",null,"Step 2: 上传相关文档")],-1)])]),default:_(()=>[h(N,{gutter:20},{default:_(()=>[h(D,{span:12},{default:_(()=>[S("div",we,[u[6]||(u[6]=S("h4",null,[W("商务应答模板 "),S("span",{class:"required"},"*")],-1)),h(R(K),{modelValue:c.value.templateFiles,"onUpdate:modelValue":u[1]||(u[1]=e=>c.value.templateFiles=e),"upload-url":`/api/tender-projects/${c.value.projectId}/upload-template`,accept:".doc,.docx",limit:1,"max-size":20,drag:"","tip-text":"必须上传商务应答模板，用于生成应答文档",onSuccess:C},null,8,["modelValue","upload-url"])])]),_:1}),h(D,{span:12},{default:_(()=>[S("div",je,[u[7]||(u[7]=S("h4",null,"招标文档（可选）",-1)),h(R(K),{modelValue:c.value.tenderFiles,"onUpdate:modelValue":u[2]||(u[2]=e=>c.value.tenderFiles=e),"upload-url":`/api/tender-projects/${c.value.projectId}/upload-tender`,accept:".pdf,.doc,.docx",limit:5,"max-size":50,drag:"","tip-text":"可选上传招标文档作为参考，支持PDF、Word格式，最大50MB",onSuccess:k},null,8,["modelValue","upload-url"])])]),_:1})]),_:1}),S("div",ke,[h(te,{type:"primary",size:"large",disabled:!v.value,loading:f.value,onClick:V},{default:_(()=>[...u[8]||(u[8]=[W(" 开始生成商务应答 ",-1)])]),_:1},8,["disabled","loading"])])]),_:1})):z("",!0),f.value?(P(),L(ee,{key:1,class:"generation-output",shadow:"never"},{header:_(()=>[S("div",Ce,[u[9]||(u[9]=S("span",null,"AI正在生成商务应答...",-1)),h(le,{percentage:g.value,status:100===g.value?"success":void 0,style:{width:"300px"}},null,8,["percentage","status"])])]),default:_(()=>[h(R(J),{content:b.value,"is-streaming":f.value,onStop:I,onRegenerate:V},null,8,["content","is-streaming"])]),_:1})):z("",!0),y.value?(P(),L(ee,{key:2,class:"result-section",shadow:"never"},{header:_(()=>[S("div",Ve,[u[13]||(u[13]=S("span",null,"生成结果",-1)),S("div",Ie,[h(te,{type:"primary",icon:R(G),onClick:$},{default:_(()=>[...u[10]||(u[10]=[W(" 预览文档 ",-1)])]),_:1},8,["icon"]),h(te,{type:"success",icon:R(Q),onClick:E},{default:_(()=>[...u[11]||(u[11]=[W(" 下载Word文档 ",-1)])]),_:1},8,["icon"]),h(te,{type:"primary",icon:R(X),onClick:V},{default:_(()=>[...u[12]||(u[12]=[W(" 重新生成 ",-1)])]),_:1},8,["icon"])])])]),default:_(()=>[S("div",$e,[h(ie,{type:"success",title:y.value.message,closable:!1,"show-icon":"",style:{"margin-bottom":"20px"}},null,8,["title"]),S("div",Ee,[u[18]||(u[18]=S("h4",null,"处理统计",-1)),h(N,{gutter:20},{default:_(()=>[h(D,{span:6},{default:_(()=>[h(ue,{title:"文本替换",value:y.value.stats.total_replacements||0},{suffix:_(()=>[...u[14]||(u[14]=[W("处",-1)])]),_:1},8,["value"])]),_:1}),h(D,{span:6},{default:_(()=>[h(ue,{title:"表格处理",value:y.value.stats.tables_processed||0},{suffix:_(()=>[...u[15]||(u[15]=[W("个",-1)])]),_:1},8,["value"])]),_:1}),h(D,{span:6},{default:_(()=>[h(ue,{title:"单元格填充",value:y.value.stats.cells_filled||0},{suffix:_(()=>[...u[16]||(u[16]=[W("个",-1)])]),_:1},8,["value"])]),_:1}),h(D,{span:6},{default:_(()=>[h(ue,{title:"图片插入",value:y.value.stats.images_inserted||0},{suffix:_(()=>[...u[17]||(u[17]=[W("张",-1)])]),_:1},8,["value"])]),_:1})]),_:1})]),S("div",Ae,[u[20]||(u[20]=S("h4",null,"生成文件",-1)),h(pe,{column:2,border:""},{default:_(()=>[h(de,{label:"文件路径"},{default:_(()=>[W(Z(y.value.outputFile),1)]),_:1}),h(de,{label:"下载地址"},{default:_(()=>[h(ce,{href:y.value.downloadUrl,type:"primary"},{default:_(()=>[...u[19]||(u[19]=[W(" 点击下载 ",-1)])]),_:1},8,["href"])]),_:1})]),_:1})])])]),_:1})):z("",!0),h(R(ye),{modelValue:x.value,"onUpdate:modelValue":u[3]||(u[3]=e=>x.value=e),"file-url":null==(d=y.value)?void 0:d.downloadUrl,"file-name":`商务应答-${(null==(j=m.value)?void 0:j.project_name)||"文档"}.docx`},null,8,["modelValue","file-url","file-name"])])}}}),[["__scopeId","data-v-bbcc4abe"]]);export{Fe as default};
