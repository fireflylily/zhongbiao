import{E as e,l as a,g as t,z as l,q as o,A as n,B as i,C as s,D as u,F as r,G as c,H as d,n as m,I as v,_ as f}from"./index.js";/* empty css                                                                          *//* empty css                                                                        *//* empty css                     *//* empty css               */import{aq as p,am as y,an as _,aI as h,aV as g,aW as w,aw as b,as as C,aA as S,av as k,ar as x,aR as T,at as z,au as I,aS as N,ay as O,aK as j,aX as E,aY as R,aQ as U,aO as A,aL as L,aM as M}from"./editor-BksuvsBo.js";import{E as B}from"./index-CVN4vWqy.js";import{E as P,a as V,b as H}from"./index-4AJA-Lo_.js";import{E as F}from"./index-D3Fm_fS5.js";const D={class:"editor-header"},W={class:"header-left"},q={class:"header-actions"},$={class:"editor-body"},Q={key:0,class:"outline-sidebar"},G={class:"outline-header"},J={class:"outline-list"},K=["onClick"],X={class:"outline-text"},Y={class:"outline-footer"},Z={class:"editor-main"},ee={key:0,class:"streaming-indicator"},ae={key:0,class:"smart-hint-bubble"},te={class:"hint-title"},le={class:"hint-content"},oe=f(p({__name:"RichTextEditor",props:{modelValue:{},title:{default:"æ–‡æ¡£ç¼–è¾‘"},height:{default:600},readonly:{type:Boolean,default:!1},streaming:{type:Boolean,default:!1},showOutline:{type:Boolean,default:!0},companyId:{},projectName:{}},emits:["update:modelValue","save","preview","export","ready"],setup(f,{expose:p,emit:oe}){const ne=f,ie=oe,se=y(null),ue=y(ne.modelValue),re=y(!1),ce=y(!1),de=y(!1),me=_(()=>ne.streaming),ve=_(()=>!!ue.value&&"<p></p>"!==ue.value),fe=y(!1),pe=_(()=>({toolbar:{defaultMode:"ribbon"},page:{layouts:["page","web"],defaultMargin:{left:3.18,right:3.18,top:2.54,bottom:2.54},defaultOrientation:"portrait",defaultBackground:"#ffffff",showBreakMarks:!0,showLineNumber:!1,showToc:!1,watermark:{type:"compact",alpha:.2,fontColor:"#000",fontSize:16,fontFamily:"SimSun",fontWeight:"normal",text:""}},document:{enableSpellcheck:!1,readOnly:ne.readonly},file:{maxSize:10485760,allowedMimeTypes:["image/jpeg","image/png","image/gif","image/webp"]},onFileUpload:async e=>new Promise((a,t)=>{const l=new FileReader;l.onload=e=>{var t;const l=null==(t=e.target)?void 0:t.result;a({id:`img-${Date.now()}`,url:l})},l.onerror=()=>t(new Error("è¯»å–å¤±è´¥")),l.readAsDataURL(e)}),onFileDelete:e=>!0,ai:{assistant:{enabled:!0,commands:[{label:{en_US:"Auto Fill",zh_CN:"æ™ºèƒ½å¡«å†™"},value:{en_US:"auto_fill",zh_CN:"auto_fill"}},{label:{en_US:"Generate Table",zh_CN:"ç”Ÿæˆè¡¨æ ¼"},value:{en_US:"generate_table",zh_CN:"generate_table"}},{label:{en_US:"Rewrite",zh_CN:"é‡å†™"},value:{en_US:"rewrite",zh_CN:"rewrite"}},{label:{en_US:"Expansion",zh_CN:"æ‰©å†™"},value:{en_US:"expand",zh_CN:"expand"}},{label:{en_US:"Summarize",zh_CN:"æ€»ç»“"},value:{en_US:"summarize",zh_CN:"summarize"}},{label:{en_US:"Polish",zh_CN:"æ¶¦è‰²"},value:{en_US:"polish",zh_CN:"polish"}},{label:{en_US:"Translate",zh_CN:"ç¿»è¯‘"},value:{en_US:"translate",zh_CN:"translate"}}],onMessage:async(a,t)=>{try{const{command:t,lang:l,input:o,output:n}=a,i=await fetch("/api/editor/ai-assistant",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:t,input:o,output:n,lang:l,company_id:ne.companyId||1,project_name:ne.projectName||""})});if(!i.ok)throw new Error("AI è¯·æ±‚å¤±è´¥");const s=await i.json();return s.success?s.content:(e.error(s.error||"AI ç”Ÿæˆå¤±è´¥"),o)}catch(l){return e.error("AI åŠ©æ‰‹è°ƒç”¨å¤±è´¥: "+l.message),a.input}}}}})),ye=y([]),_e=y(!1),he=y(""),ge=y(!1),we=y(!1),be=y(!1),Ce=y("");let Se=null;_(()=>de.value?"calc(100vh - 120px)":"number"==typeof ne.height?`${ne.height}px`:ne.height),h(()=>ne.modelValue,e=>{e&&e!==ue.value&&(ue.value=e,re.value=!1,se.value&&ze(e))}),h(me,e=>{se.value&&"function"==typeof se.value.setReadOnly&&se.value.setReadOnly(e||ne.readonly)});const ke=()=>{setTimeout(()=>{xe()},300),ne.modelValue&&setTimeout(()=>{ze(ne.modelValue)},100),(ne.readonly||ne.streaming)&&se.value&&"function"==typeof se.value.setReadOnly&&se.value.setReadOnly(!0),ie("ready"),setTimeout(()=>{je()},800)},xe=()=>{if(se.value)try{"function"==typeof se.value.setLayout&&(se.value.setLayout("page"),fe.value=!1,setTimeout(()=>{const e=document.querySelector(".umo-editor-container");e&&(e.classList.add("umo-page-mode"),e.classList.remove("umo-continuous-mode"))},500))}catch(e){}},Te=()=>{if(se.value)try{const e=se.value.getHTML();e!==ue.value&&(ue.value=e,re.value=!0,ie("update:modelValue",e),Oe(),Se&&clearTimeout(Se),Se=window.setTimeout(()=>{const a=document.createElement("div");a.innerHTML=e;const t=a.textContent||a.innerText||"";Le(t)},1e3))}catch(e){}},ze=e=>{if(se.value)try{Pe(),"function"==typeof se.value.setContent&&(se.value.setContent(e),setTimeout(()=>{Pe()},100))}catch(a){if("QuotaExceededError"===a.name){Pe();try{se.value.setContent(e)}catch(t){}}}},Ie=()=>{var e;try{const a=null==(e=se.value)?void 0:e.getEditor();if(a&&a.view){const{dom:e}=a.view;e.scrollTop=e.scrollHeight}}catch(a){}};let Ne=null;const Oe=()=>{Ne&&clearTimeout(Ne),Ne=window.setTimeout(()=>{je()},500)},je=async()=>{if(se.value&&ne.showOutline){ge.value=!0;try{const e=se.value.getHTML();if(!e||"<p></p>"===e)return void(ye.value=[]);const a=new DOMParser,t=a.parseFromString(e,"text/html").querySelectorAll("h1, h2, h3, h4, h5, h6");ye.value=Array.from(t).map((e,a)=>({id:e.id||`heading-${a}`,level:parseInt(e.tagName[1]),textContent:e.textContent.trim(),dom:null})),ye.value.forEach((e,a)=>{})}catch(e){ye.value=[]}finally{ge.value=!1}}},Ee=async()=>{if(re.value&&!me.value){ce.value=!0;try{ie("save",ue.value),await M(),re.value=!1}catch(a){e.error("ä¿å­˜å¤±è´¥")}finally{ce.value=!1}}},Re=()=>{de.value=!de.value,de.value?document.body.style.overflow="hidden":document.body.style.overflow=""},Ue=async a=>{try{const t=Be();let l="";if(t&&t.state){const{from:e,to:a}=t.state.selection;l=t.state.doc.textBetween(e,a," ")}if(!l.trim()){l=(await v.prompt('è¯·ç²˜è´´æˆ–è¾“å…¥æ‹›æ ‡æ–‡ä»¶ä¸­çš„æ‰¿è¯ºä¹¦è¦æ±‚ï¼ˆåŒ…å«"æ ¼å¼è‡ªæ‹Ÿ"ç­‰å…³é”®ä¿¡æ¯ï¼‰',"ç”Ÿæˆæ‰¿è¯ºä¹¦",{confirmButtonText:"ç”Ÿæˆ",cancelButtonText:"å–æ¶ˆ",inputType:"textarea",inputPlaceholder:"ä¾‹å¦‚ï¼šæ ¼å¼è‡ªæ‹Ÿï¼Œå¿…é¡»åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š\nå…·æœ‰ç‹¬ç«‹æ‰¿æ‹…æ°‘äº‹è´£ä»»çš„èƒ½åŠ›..."})).value}if(!l.trim())return void e.warning("è¯·è¾“å…¥æ‰¿è¯ºä¹¦è¦æ±‚å†…å®¹");await Me(a,l)}catch(t){"cancel"!==t&&e.error("æ“ä½œå¤±è´¥: "+t.message)}},Ae=async()=>{if(Ce.value){be.value=!0,we.value=!1;try{let e="commitment_general";Ce.value.includes("è¿æ³•è®°å½•")||Ce.value.includes("ä¸‰å¹´å†…")?e="commitment_no_violation":(Ce.value.includes("ä¿å¯†")||Ce.value.includes("ç¬¬ä¸‰æ–¹"))&&(e="commitment_confidential"),await Me(e,Ce.value)}catch(a){e.error("ç”Ÿæˆå¤±è´¥: "+a.message)}finally{be.value=!1}}else e.warning("æœªæ£€æµ‹åˆ°æœ‰æ•ˆå†…å®¹")},Le=e=>{const a=[/æ ¼å¼è‡ªæ‹Ÿ.*æ‰¿è¯º/i,/ä¹¦é¢å£°æ˜.*æ ¼å¼è‡ªæ‹Ÿ/i,/æ‰¿è¯ºå‡½.*æ ¼å¼è‡ªæ‹Ÿ/i,/ä¸‰å¹´å†….*é‡å¤§è¿æ³•è®°å½•/i,/ä¿å¯†.*æ‰¿è¯º/i,/æ ¼å¼è‡ªæ‹Ÿ.*å¿…é¡»åŒ…å«/i],t=e.slice(-200);for(const l of a)if(l.test(t))return Ce.value=t,we.value=!0,!0;return!1},Me=async(a,t)=>{if(t.trim()){se.value&&"function"==typeof se.value.setReadOnly&&se.value.setReadOnly(!0);try{const l=await fetch("/api/editor/ai-assistant",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({command:a,input:t,output:"html",lang:"zh-CN",company_id:ne.companyId||1,project_name:ne.projectName||""})});if(!l.ok)throw new Error("AI è¯·æ±‚å¤±è´¥");const o=await l.json();if(!o.success)throw new Error(o.error||"AI ç”Ÿæˆå¤±è´¥");if(se.value){const a=se.value.getHTML()+"\n"+o.content;se.value.setContent(a),re.value=!0,e.success("æ‰¿è¯ºä¹¦å·²ç”Ÿæˆï¼")}}catch(l){e.error("AI åŠ©æ‰‹è°ƒç”¨å¤±è´¥: "+l.message)}finally{se.value&&"function"==typeof se.value.setReadOnly&&se.value.setReadOnly(ne.readonly||ne.streaming)}}else e.warning("è¯·é€‰ä¸­æˆ–è¾“å…¥è¦å¤„ç†çš„æ–‡æœ¬")},Be=()=>{var e,a;return null==(a=null==(e=se.value)?void 0:e.getEditor)?void 0:a.call(e)};p({getContent:()=>{try{if(se.value&&"function"==typeof se.value.getHTML)return se.value.getHTML()}catch(e){}return ue.value},setContent:e=>{ue.value=e,ze(e),re.value=!1,setTimeout(()=>{je()},300)},appendContent:e=>{if(se.value)try{const a=se.value.getHTML()+e;se.value.setContent(a),ue.value=a,M(()=>{Ie()}),Oe()}catch(a){}else ue.value+=e},clear:()=>{ue.value="",ze(""),ye.value=[],re.value=!1},refreshOutline:je,setStreaming:e=>{},getEditor:Be,insertPageBreak:()=>{try{let e=Be();return e&&e.__v_isRef&&(e=e.value),!!(e&&e.commands&&e.commands.setPageBreak)&&(e.commands.setPageBreak(),!0)}catch(e){return!1}}});const Pe=()=>{try{const e=Object.keys(localStorage);for(const a of e)a.startsWith("umo-editor:")&&localStorage.removeItem(a)}catch(e){}},Ve=localStorage.setItem;let He=!1;return g(()=>{localStorage.setItem=function(e,a){if(!e.startsWith("umo-editor:"))return Ve.call(localStorage,e,a);He||(He=!0)},Pe()}),w(()=>{de.value&&(document.body.style.overflow=""),Ne&&clearTimeout(Ne),Se&&clearTimeout(Se),localStorage.setItem=Ve,Pe()}),(e,v)=>{const p=t,y=B,_=o,h=V,g=P,w=H,M=F,oe=m;return C(),b("div",{class:S(["rich-text-editor",{fullscreen:de.value,streaming:me.value}])},[k("div",D,[k("div",W,[k("h3",null,"âœï¸ "+T(f.title),1),me.value?(C(),x(y,{key:0,type:"primary",effect:"plain"},{default:z(()=>[I(p,{class:"is-loading"},{default:z(()=>[I(O(a))]),_:1}),v[5]||(v[5]=N(" AIç”Ÿæˆä¸­... ",-1))]),_:1})):re.value?(C(),x(y,{key:1,type:"warning"},{default:z(()=>[...v[6]||(v[6]=[N("æœ‰æœªä¿å­˜çš„ä¿®æ”¹",-1)])]),_:1})):(C(),x(y,{key:2,type:"success"},{default:z(()=>[...v[7]||(v[7]=[N("å·²ä¿å­˜",-1)])]),_:1}))]),k("div",q,[I(_,{onClick:Re,size:"small"},{default:z(()=>[I(p,null,{default:z(()=>[I(O(l))]),_:1}),N(" "+T(de.value?"é€€å‡ºå…¨å±":"å…¨å±ç¼–è¾‘"),1)]),_:1}),I(w,{onCommand:Ue,trigger:"click"},{dropdown:z(()=>[I(g,null,{default:z(()=>[I(h,{command:"commitment_general"},{default:z(()=>[...v[9]||(v[9]=[N(" ğŸ“ ç”Ÿæˆèµ„æ ¼æ‰¿è¯ºä¹¦ ",-1)])]),_:1}),I(h,{command:"commitment_no_violation"},{default:z(()=>[...v[10]||(v[10]=[N(" ğŸ“‹ ç”Ÿæˆæ— è¿æ³•è®°å½•å£°æ˜ ",-1)])]),_:1}),I(h,{command:"commitment_confidential"},{default:z(()=>[...v[11]||(v[11]=[N(" ğŸ”’ ç”Ÿæˆä¿å¯†æ‰¿è¯ºä¹¦ ",-1)])]),_:1}),I(h,{divided:"",command:"auto_fill"},{default:z(()=>[...v[12]||(v[12]=[N(" âœ¨ æ™ºèƒ½å¡«å†™ ",-1)])]),_:1})]),_:1})]),default:z(()=>[I(_,{type:"warning",size:"small"},{default:z(()=>[I(p,null,{default:z(()=>[I(O(n))]),_:1}),v[8]||(v[8]=N(" æ ‡ä¹¦å·¥å…· ",-1)),I(p,{class:"el-icon--right"},{default:z(()=>[I(O(i))]),_:1})]),_:1})]),_:1}),I(_,{type:"primary",onClick:v[0]||(v[0]=e=>ie("preview")),size:"small",disabled:!ve.value||me.value},{default:z(()=>[I(p,null,{default:z(()=>[I(O(s))]),_:1}),v[13]||(v[13]=N(" é¢„è§ˆWord ",-1))]),_:1},8,["disabled"]),I(_,{type:"success",onClick:v[1]||(v[1]=e=>ie("export")),size:"small",disabled:!ve.value||me.value},{default:z(()=>[I(p,null,{default:z(()=>[I(O(u))]),_:1}),v[14]||(v[14]=N(" å¯¼å‡ºWord ",-1))]),_:1},8,["disabled"]),I(_,{type:"primary",loading:ce.value,disabled:!ve.value||me.value,onClick:Ee,size:"small"},{default:z(()=>[...v[15]||(v[15]=[N(" ä¿å­˜ ",-1)])]),_:1},8,["loading","disabled"])])]),k("div",$,[f.showOutline&&!_e.value?(C(),b("div",Q,[k("div",G,[v[16]||(v[16]=k("h4",null,"ğŸ“‘ ç›®å½•",-1)),I(_,{text:"",size:"small",onClick:je,loading:ge.value},{default:z(()=>[I(p,null,{default:z(()=>[I(O(r))]),_:1})]),_:1},8,["loading"])]),k("div",J,[(C(!0),b(E,null,R(ye.value,(e,a)=>(C(),b("div",{key:e.id||a,class:S(["outline-item",`level-${e.level}`,{active:he.value===e.id}]),onClick:a=>(e=>{if(e)try{if(e.dom&&"function"==typeof e.dom.scrollIntoView)return e.dom.scrollIntoView({behavior:"smooth",block:"start"}),void(he.value=e.id);if(e.id){const a=document.getElementById(e.id);if(a)return a.scrollIntoView({behavior:"smooth",block:"start"}),void(he.value=e.id)}}catch(a){}})(e)},[k("span",X,T(e.textContent),1)],10,K))),128)),0!==ye.value.length||me.value?j("",!0):(C(),x(M,{key:0,description:"æš‚æ— æ ‡é¢˜","image-size":60}))]),k("div",Y,[I(_,{text:"",size:"small",onClick:v[2]||(v[2]=e=>_e.value=!0)},{default:z(()=>[I(p,null,{default:z(()=>[I(O(c))]),_:1}),v[17]||(v[17]=N(" æŠ˜å ç›®å½• ",-1))]),_:1})])])):j("",!0),f.showOutline&&_e.value?(C(),b("div",{key:1,class:"outline-toggle",onClick:v[3]||(v[3]=e=>_e.value=!1)},[I(p,null,{default:z(()=>[I(O(d))]),_:1}),v[18]||(v[18]=k("span",{class:"toggle-text"},"å±•å¼€ç›®å½•",-1))])):j("",!0),k("div",Z,[me.value?(C(),b("div",ee,[I(p,{class:"is-loading"},{default:z(()=>[I(O(a))]),_:1}),v[19]||(v[19]=k("span",null,"AI æ­£åœ¨ç”Ÿæˆå†…å®¹ï¼Œè¯·ç¨å€™...",-1))])):j("",!0),I(U,{name:"el-fade-in"},{default:z(()=>[we.value?(C(),b("div",ae,[I(oe,{type:"info",closable:!0,onClose:v[4]||(v[4]=e=>we.value=!1)},{title:z(()=>[k("div",te,[I(p,null,{default:z(()=>[I(O(n))]),_:1}),v[20]||(v[20]=k("span",null,"ğŸ’¡ æ£€æµ‹åˆ°æ‰¿è¯ºä¹¦è¦æ±‚",-1))])]),default:z(()=>[k("div",le,[v[22]||(v[22]=k("p",null,'ç³»ç»Ÿè¯†åˆ«åˆ°æ‚¨è¾“å…¥çš„å†…å®¹åŒ…å«"æ ¼å¼è‡ªæ‹Ÿ"ç­‰æ‰¿è¯ºä¹¦å…³é”®è¯',-1)),I(_,{type:"primary",size:"small",onClick:Ae,loading:be.value},{default:z(()=>[...v[21]||(v[21]=[N(" ä¸€é”®ç”Ÿæˆæ‰¿è¯ºä¹¦ ",-1)])]),_:1},8,["loading"])])]),_:1})])):j("",!0)]),_:1}),I(O(L),A({ref_key:"umoEditorRef",ref:se},pe.value,{onChanged:Te,onCreated:ke}),null,16)])])],2)}}}),[["__scopeId","data-v-05673e68"]]);export{oe as R};
