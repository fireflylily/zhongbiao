import{M as e,d as a,G as t,D as l,e as o,p as c,n as u,h as n,f as r,g as s,a1 as d,y as _,a as i,C as p,o as m,b as f,N as v}from"./vendor-element-plus-CEQaQHNc.js";import{d as y,r as h,w as g,b,P as V,M as w,c as k,N as C,F as U,V as j,L as D,H as x,O as I,I as M,_ as z,R as E,Q as Y,b4 as F,b7 as P}from"./vendor-vue-DnBj6vzG.js";import{L as q}from"./Loading-fOFG7xAl.js";/* empty css                                                                          */import{er as A,dD as B,es as L,eu as N,eI as O,eQ as R,eM as G,eH as H,dB as Q}from"./vendor-other-CxXkF0Pk.js";import"./vendor-editor-CGvuleas.js";/* empty css                                                                        */import"./vendor-dayjs-CeOjnJlt.js";import{a as J,_ as T}from"./index.js";import{a as W,f as X,k as $}from"./formatters-D-henrcx.js";import{E as K}from"./Empty-BzPBqxja.js";import{s as S}from"./imageCompressor-CTkRt5bg.js";import{c as Z}from"./company-DX6fQVXW.js";import"./vendor-echarts-C00rBISf.js";import"./vendor-axios-BG7aBJwU.js";const ee={class:"case-basic-info-tab"},ae={class:"card-header"},te={key:2,class:"attachments-grid"},le={class:"attachment-header"},oe={class:"attachment-body"},ce=["title"],ue={class:"file-info"},ne={class:"file-size"},re={class:"file-date"},se={key:0,class:"file-desc"},de={class:"attachment-actions"},_e=T(y({__name:"CaseBasicInfoTab",props:{caseId:{},caseData:{}},emits:["update"],setup(y,{emit:F}){const P=y,T=F,{success:_e,error:ie}=J(),pe=h(),me=h(!1),fe=h([]),ve=h({company_id:null,case_title:"",case_number:"",customer_name:"",product_category:"",industry:"金融",contract_type:"合同",final_customer_name:"",contract_amount:"",contract_start_date:"",contract_end_date:"",party_a_contact_name:"",party_a_contact_phone:"",party_a_contact_email:""}),ye={company_id:[{required:!0,message:"请选择所属企业",trigger:"change"}],case_title:[{required:!0,message:"请输入案例标题",trigger:"blur"}],customer_name:[{required:!0,message:"请输入客户名称",trigger:"blur"}],contract_type:[{required:!0,message:"请选择合同类型",trigger:"change"}]},he=h(!1),ge=h([]),be=h(!1),Ve=h(!1),we=h(),ke=h(),Ce=h([]),Ue=h({attachment_type:"contract",description:"",file:null}),je={attachment_type:[{required:!0,message:"请选择附件类型",trigger:"change"}]};g(()=>P.caseData,e=>{e&&(ve.value={company_id:e.company_id||null,case_title:e.case_title||"",case_number:e.case_number||"",customer_name:e.customer_name||"",product_category:e.product_category||"",industry:e.industry||"金融",contract_type:e.contract_type||"合同",final_customer_name:e.final_customer_name||"",contract_amount:e.contract_amount||"",contract_start_date:e.contract_start_date||"",contract_end_date:e.contract_end_date||"",party_a_contact_name:e.party_a_contact_name||"",party_a_contact_phone:e.party_a_contact_phone||"",party_a_contact_email:e.party_a_contact_email||""})},{immediate:!0,deep:!0});const De=async()=>{pe.value&&await pe.value.validate(async e=>{if(e){me.value=!0;try{const e=await $.updateCase(P.caseId,ve.value);e.success?(_e("保存成功","案例信息已更新"),T("update")):ie("保存失败",e.error||"未知错误")}catch(a){ie("保存失败",a instanceof Error?a.message:"未知错误")}finally{me.value=!1}}})},xe=()=>{var e;null==(e=pe.value)||e.resetFields()},Ie=e=>{switch(e){case"contract":return Q;case"acceptance":return H;case"testimony":return G;case"photo":return R;default:return O}},Me=e=>{switch(e){case"contract":return"#409eff";case"acceptance":return"#67c23a";case"testimony":return"#e6a23c";case"photo":return"#f56c6c";default:return"#909399"}},ze=e=>{switch(e){case"contract":return"primary";case"acceptance":return"success";case"testimony":return"warning";case"photo":return"danger";default:return"info"}},Ee=e=>{switch(e){case"contract":return"合同文件";case"acceptance":return"验收证明";case"testimony":return"客户证明";case"photo":return"项目照片";default:return"其他材料"}},Ye=async()=>{he.value=!0;try{const e=await $.getCaseAttachments(P.caseId);e.success&&e.data&&(ge.value=e.data)}catch(e){ie("加载失败",e instanceof Error?e.message:"未知错误")}finally{he.value=!1}},Fe=e=>{if(e.raw){const a=20971520;if(e.raw.size>a)return ie("文件过大","文件大小不能超过20MB"),Ce.value=[],void(Ue.value.file=null);Ue.value.file=e.raw}},Pe=()=>{Ue.value.file=null},qe=()=>{be.value=!0},Ae=async()=>{we.value&&await we.value.validate(async e=>{if(e)if(Ue.value.file){Ve.value=!0;try{let e=Ue.value.file;if(e.type.startsWith("image/")){const a="photo"===Ue.value.attachment_type?"photo":"default";e=await S(e,a)}const a=await $.uploadCaseAttachment(P.caseId,e,Ue.value.attachment_type,Ue.value.description||void 0);a.success?(_e("上传成功","附件已上传"),be.value=!1,await Ye(),T("update")):ie("上传失败",a.error||"未知错误")}catch(a){ie("上传失败",a instanceof Error?a.message:"未知错误")}finally{Ve.value=!1}}else ie("请选择文件","请先选择要上传的文件")})},Be=()=>{var e;Ce.value=[],Ue.value={attachment_type:"contract",description:"",file:null},null==(e=we.value)||e.resetFields()};return b(()=>{(async()=>{try{const e=await Z.getCompanies();e.success&&e.data&&(fe.value=e.data)}catch(e){}})(),Ye()}),(y,h)=>{const g=u,b=c,F=o,P=l,O=t,R=n,G=s,H=r,Q=d,J=_,S=i,Z=a,Le=e,Ne=p,Oe=m,Re=v,Ge=f;return w(),V("div",ee,[k(Le,{style:{"margin-bottom":"20px"}},{header:C(()=>[...h[19]||(h[19]=[I("span",null,"案例基本信息",-1)])]),default:C(()=>[k(Z,{ref_key:"formRef",ref:pe,model:ve.value,rules:ye,"label-width":"140px"},{default:C(()=>[k(O,{gutter:20},{default:C(()=>[k(P,{span:12},{default:C(()=>[k(F,{label:"所属企业",prop:"company_id"},{default:C(()=>[k(b,{modelValue:ve.value.company_id,"onUpdate:modelValue":h[0]||(h[0]=e=>ve.value.company_id=e),placeholder:"请选择企业",filterable:"",style:{width:"100%"}},{default:C(()=>[(w(!0),V(U,null,j(fe.value,e=>(w(),D(g,{key:e.company_id,label:e.company_name,value:e.company_id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),k(O,{gutter:20},{default:C(()=>[k(P,{span:12},{default:C(()=>[k(F,{label:"案例标题",prop:"case_title"},{default:C(()=>[k(R,{modelValue:ve.value.case_title,"onUpdate:modelValue":h[1]||(h[1]=e=>ve.value.case_title=e),placeholder:"请输入案例标题/合同名称"},null,8,["modelValue"])]),_:1})]),_:1}),k(P,{span:12},{default:C(()=>[k(F,{label:"案例编号",prop:"case_number"},{default:C(()=>[k(R,{modelValue:ve.value.case_number,"onUpdate:modelValue":h[2]||(h[2]=e=>ve.value.case_number=e),placeholder:"请输入案例编号（可选）"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),k(O,{gutter:20},{default:C(()=>[k(P,{span:12},{default:C(()=>[k(F,{label:"客户名称",prop:"customer_name"},{default:C(()=>[k(R,{modelValue:ve.value.customer_name,"onUpdate:modelValue":h[3]||(h[3]=e=>ve.value.customer_name=e),placeholder:"请输入甲方客户名称"},null,8,["modelValue"])]),_:1})]),_:1}),k(P,{span:12},{default:C(()=>[k(F,{label:"产品分类",prop:"product_category"},{default:C(()=>[k(b,{modelValue:ve.value.product_category,"onUpdate:modelValue":h[4]||(h[4]=e=>ve.value.product_category=e),placeholder:"请选择产品分类",clearable:"",style:{width:"100%"}},{default:C(()=>[k(g,{label:"风控产品",value:"风控产品"}),k(g,{label:"实修",value:"实修"}),k(g,{label:"免密",value:"免密"}),k(g,{label:"风控位置",value:"风控位置"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),k(O,{gutter:20},{default:C(()=>[k(P,{span:12},{default:C(()=>[k(F,{label:"所属行业",prop:"industry"},{default:C(()=>[k(b,{modelValue:ve.value.industry,"onUpdate:modelValue":h[5]||(h[5]=e=>ve.value.industry=e),placeholder:"请选择行业",clearable:"",style:{width:"100%"}},{default:C(()=>[k(g,{label:"科技",value:"科技"}),k(g,{label:"制造业",value:"制造业"}),k(g,{label:"金融",value:"金融"}),k(g,{label:"教育",value:"教育"}),k(g,{label:"医疗",value:"医疗"}),k(g,{label:"建筑",value:"建筑"}),k(g,{label:"其他",value:"其他"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),k(P,{span:12},{default:C(()=>[k(F,{label:"合同类型",prop:"contract_type"},{default:C(()=>[k(H,{modelValue:ve.value.contract_type,"onUpdate:modelValue":h[6]||(h[6]=e=>ve.value.contract_type=e)},{default:C(()=>[k(G,{label:"合同"},{default:C(()=>[...h[20]||(h[20]=[x("合同",-1)])]),_:1}),k(G,{label:"订单"},{default:C(()=>[...h[21]||(h[21]=[x("订单",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),k(O,{gutter:20},{default:C(()=>[k(P,{span:12},{default:C(()=>[k(F,{label:"合同金额",prop:"contract_amount"},{default:C(()=>[k(R,{modelValue:ve.value.contract_amount,"onUpdate:modelValue":h[7]||(h[7]=e=>ve.value.contract_amount=e),placeholder:"如：100万元、百万级"},{append:C(()=>[...h[22]||(h[22]=[x("元",-1)])]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),k(O,{gutter:20},{default:C(()=>[k(P,{span:12},{default:C(()=>[k(F,{label:"最终客户",prop:"final_customer_name"},{default:C(()=>[k(R,{modelValue:ve.value.final_customer_name,"onUpdate:modelValue":h[8]||(h[8]=e=>ve.value.final_customer_name=e),placeholder:"订单类型时填写最终客户",disabled:"订单"!==ve.value.contract_type},null,8,["modelValue","disabled"])]),_:1})]),_:1}),k(P,{span:12},{default:C(()=>[k(F,{label:"合同开始日期",prop:"contract_start_date"},{default:C(()=>[k(Q,{modelValue:ve.value.contract_start_date,"onUpdate:modelValue":h[9]||(h[9]=e=>ve.value.contract_start_date=e),type:"date",placeholder:"选择开始日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),k(O,{gutter:20},{default:C(()=>[k(P,{span:12},{default:C(()=>[k(F,{label:"合同结束日期",prop:"contract_end_date"},{default:C(()=>[k(Q,{modelValue:ve.value.contract_end_date,"onUpdate:modelValue":h[10]||(h[10]=e=>ve.value.contract_end_date=e),type:"date",placeholder:"选择结束日期","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),k(J,{"content-position":"left"},{default:C(()=>[...h[23]||(h[23]=[x("客户联系方式",-1)])]),_:1}),k(O,{gutter:20},{default:C(()=>[k(P,{span:8},{default:C(()=>[k(F,{label:"联系人姓名",prop:"party_a_contact_name"},{default:C(()=>[k(R,{modelValue:ve.value.party_a_contact_name,"onUpdate:modelValue":h[11]||(h[11]=e=>ve.value.party_a_contact_name=e),placeholder:"联系人"},null,8,["modelValue"])]),_:1})]),_:1}),k(P,{span:8},{default:C(()=>[k(F,{label:"联系电话",prop:"party_a_contact_phone"},{default:C(()=>[k(R,{modelValue:ve.value.party_a_contact_phone,"onUpdate:modelValue":h[12]||(h[12]=e=>ve.value.party_a_contact_phone=e),placeholder:"联系电话"},null,8,["modelValue"])]),_:1})]),_:1}),k(P,{span:8},{default:C(()=>[k(F,{label:"联系邮箱",prop:"party_a_contact_email"},{default:C(()=>[k(R,{modelValue:ve.value.party_a_contact_email,"onUpdate:modelValue":h[13]||(h[13]=e=>ve.value.party_a_contact_email=e),placeholder:"邮箱地址"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),k(F,null,{default:C(()=>[k(S,{type:"primary",loading:me.value,onClick:De},{default:C(()=>[...h[24]||(h[24]=[x(" 保存 ",-1)])]),_:1},8,["loading"]),k(S,{onClick:xe},{default:C(()=>[...h[25]||(h[25]=[x("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),k(Le,null,{header:C(()=>[I("div",ae,[h[27]||(h[27]=I("span",null,"案例附件",-1)),k(S,{type:"primary",size:"small",onClick:qe},{default:C(()=>[k(Ne,null,{default:C(()=>[k(M(L))]),_:1}),h[26]||(h[26]=x(" 上传附件 ",-1))]),_:1})])]),default:C(()=>[he.value?(w(),D(M(q),{key:0,text:"加载附件中..."})):ge.value.length?(w(),V("div",te,[(w(!0),V(U,null,j(ge.value,e=>(w(),V("div",{key:e.attachment_id,class:"attachment-card"},[I("div",le,[k(Ne,{size:32,color:Me(e.attachment_type)},{default:C(()=>[(w(),D(z(Ie(e.attachment_type))))]),_:2},1032,["color"]),k(Oe,{type:ze(e.attachment_type),size:"small"},{default:C(()=>[x(E(Ee(e.attachment_type)),1)]),_:2},1032,["type"])]),I("div",oe,[I("div",{class:"file-name",title:e.original_filename},E(e.original_filename),9,ce),I("div",ue,[I("span",ne,E(M(W)(e.file_size)),1),I("span",re,E(M(X)(e.uploaded_at,"date")),1)]),e.attachment_description?(w(),V("div",se,E(e.attachment_description),1)):Y("",!0)]),I("div",de,[k(S,{size:"small",onClick:a=>(e=>{const a=$.downloadCaseAttachment(e.attachment_id);window.open(a,"_blank")})(e)},{default:C(()=>[k(Ne,null,{default:C(()=>[k(M(A))]),_:1}),h[28]||(h[28]=x(" 下载 ",-1))]),_:1},8,["onClick"]),k(S,{size:"small",type:"danger",onClick:a=>(async e=>{try{if(!confirm(`确定要删除附件 "${e.original_filename}" 吗？`))return;const a=await $.deleteCaseAttachment(e.attachment_id);a.success?(_e("删除成功","附件已删除"),await Ye(),T("update")):ie("删除失败",a.error||"未知错误")}catch(a){ie("删除失败",a instanceof Error?a.message:"未知错误")}})(e)},{default:C(()=>[k(Ne,null,{default:C(()=>[k(M(B))]),_:1}),h[29]||(h[29]=x(" 删除 ",-1))]),_:1},8,["onClick"])])]))),128))])):(w(),D(M(K),{key:1,type:"no-data",description:"暂无附件"}))]),_:1}),k(Ge,{modelValue:be.value,"onUpdate:modelValue":h[18]||(h[18]=e=>be.value=e),title:"上传案例附件",width:"500px",onClose:Be},{footer:C(()=>[k(S,{onClick:h[17]||(h[17]=e=>be.value=!1)},{default:C(()=>[...h[32]||(h[32]=[x("取消",-1)])]),_:1}),k(S,{type:"primary",loading:Ve.value,onClick:Ae},{default:C(()=>[...h[33]||(h[33]=[x(" 确定上传 ",-1)])]),_:1},8,["loading"])]),default:C(()=>[k(Z,{ref_key:"uploadFormRef",ref:we,model:Ue.value,rules:je,"label-width":"120px"},{default:C(()=>[k(F,{label:"附件类型",prop:"attachment_type"},{default:C(()=>[k(b,{modelValue:Ue.value.attachment_type,"onUpdate:modelValue":h[14]||(h[14]=e=>Ue.value.attachment_type=e),placeholder:"请选择附件类型",style:{width:"100%"}},{default:C(()=>[k(g,{label:"合同文件",value:"contract"}),k(g,{label:"验收证明",value:"acceptance"}),k(g,{label:"客户证明",value:"testimony"}),k(g,{label:"项目照片",value:"photo"}),k(g,{label:"其他材料",value:"other"})]),_:1},8,["modelValue"])]),_:1}),k(F,{label:"附件说明",prop:"description"},{default:C(()=>[k(R,{modelValue:Ue.value.description,"onUpdate:modelValue":h[15]||(h[15]=e=>Ue.value.description=e),type:"textarea",rows:2,placeholder:"请简要说明附件内容（可选）"},null,8,["modelValue"])]),_:1}),k(F,{label:"选择文件",prop:"file"},{default:C(()=>[k(Re,{ref_key:"uploadRef",ref:ke,"file-list":Ce.value,"onUpdate:fileList":h[16]||(h[16]=e=>Ce.value=e),"auto-upload":!1,limit:1,"on-change":Fe,"on-remove":Pe,accept:".pdf,.doc,.docx,.jpg,.jpeg,.png",drag:""},{tip:C(()=>[...h[30]||(h[30]=[I("div",{class:"el-upload__tip"}," 支持PDF、DOC、DOCX、JPG、PNG格式，文件大小不超过20MB ",-1)])]),default:C(()=>[k(Ne,{class:"el-icon--upload"},{default:C(()=>[k(M(N))]),_:1}),h[31]||(h[31]=I("div",{class:"el-upload__text"},[x(" 拖拽文件到这里 或 "),I("em",null,"点击上传")],-1))]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),[["__scopeId","data-v-e9280fb1"]]),ie={class:"case-detail"},pe={class:"detail-header"},me={class:"header-title"},fe={key:1,class:"detail-content"},ve=T(y({__name:"CaseDetail",setup(e){const a=F(),t=P(),{error:l}=J(),o=h(!1),c=h(0),u=h({}),n=async()=>{o.value=!0;try{const e=await $.getCase(c.value);e.success&&e.data?u.value=e.data:(l("加载失败","无法获取案例信息"),s())}catch(e){l("加载失败",e instanceof Error?e.message:"未知错误"),s()}finally{o.value=!1}},r=async()=>{await n()},s=()=>{t.push("/knowledge/case-library")};return b(()=>{const e=a.params.id;if(e){if(c.value=parseInt(e,10),isNaN(c.value))return l("参数错误","无效的案例ID"),void s();n()}else l("参数错误","缺少案例ID"),s()}),(e,a)=>{const t=i,l=m;return w(),V("div",ie,[I("div",pe,[k(t,{onClick:s,icon:"ArrowLeft"},{default:C(()=>[...a[0]||(a[0]=[x("返回列表",-1)])]),_:1}),I("div",me,[I("h2",null,E(u.value.case_title||"案例详情"),1),u.value.contract_type?(w(),D(l,{key:0,type:"合同"===u.value.contract_type?"primary":"success"},{default:C(()=>[x(E(u.value.contract_type),1)]),_:1},8,["type"])):Y("",!0),u.value.product_category?(w(),D(l,{key:1,type:"primary"},{default:C(()=>[x(E(u.value.product_category),1)]),_:1})):Y("",!0)])]),o.value?(w(),D(M(q),{key:0,text:"加载案例信息中..."})):(w(),V("div",fe,[k(_e,{"case-id":c.value,"case-data":u.value,onUpdate:r},null,8,["case-id","case-data"])]))])}}}),[["__scopeId","data-v-ea362180"]]);export{ve as default};
