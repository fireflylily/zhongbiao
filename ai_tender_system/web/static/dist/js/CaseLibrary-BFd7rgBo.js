import{M as a,O as e,e as t,v as l,ak as s,al as o,R as r,P as c,Q as i,U as d,d as n,ag as u,ah as p,_}from"./index.js";/* empty css                             *//* empty css                    *//* empty css                     *//* empty css               */import{E as m,a as v}from"./el-select-CEg_eSdx.js";/* empty css                */import{L as y}from"./Loading-CEvPa6xQ.js";import{E as f}from"./Empty-CGgUzHTC.js";/* empty css                */import{C as b}from"./Card-LFFlZQNZ.js";/* empty css                                                        *//* empty css                                                                          */import{am as w,an as h,ao as g,aX as j,au as x,ar as C,aw as k,ax as E,as as V,ay as z,aC as $,aq as L,aD as T}from"./editor-DtHwR8yc.js";/* empty css                   *//* empty css                */import{k as F,f as U}from"./formatters-B5qX4Bdv.js";import{c as I}from"./company-CHa0NuIL.js";import{E as D}from"./index-DYtF0M78.js";import{E as P,a as q}from"./index-2X3NYXDr.js";import{E as H}from"./index-BkIdrdH2.js";import"./index-BCSTGAKU.js";import"./strings-BND1Cqg8.js";import"./index-CzeRX9sj.js";import"./toNumber-D7Yc6kTN.js";import"./_baseFindIndex-BTqrMG7V.js";import"./_baseIteratee-ByQT0QPi.js";import"./index-B1D0B4Gf.js";import"./flatMap-BdIFri63.js";import"./map-l56HRvAj.js";import"./_baseEach-Dq22CNAR.js";import"./index-DL_Xf39J.js";import"./raf-BZHcGSIv.js";const M={class:"case-library"},O={class:"stats-bar"},Q={class:"stat-content"},R={class:"stat-icon"},A={class:"stat-info"},G={class:"stat-value"},N={class:"stat-content"},X={class:"stat-icon"},Z={class:"stat-info"},B={class:"stat-value"},J={class:"stat-content"},K={class:"stat-icon"},S={class:"stat-info"},W={class:"stat-value"},Y={class:"filter-section"},aa={key:1,style:{color:"#909399"}},ea=_(w({__name:"CaseLibrary",setup(_){const w=a(),{success:ea,error:ta}=e(),la=h(!1),sa=h(!1),oa=h([]),ra=h([]),ca=h(),ia=h({keyword:"",productCategory:"",industry:"",contractType:""}),da=g(()=>{let a=[...oa.value];if(ia.value.keyword){const e=ia.value.keyword.toLowerCase();a=a.filter(a=>{var t,l,s;return(null==(t=a.case_title)?void 0:t.toLowerCase().includes(e))||(null==(l=a.customer_name)?void 0:l.toLowerCase().includes(e))||(null==(s=a.case_number)?void 0:s.toLowerCase().includes(e))})}return ia.value.productCategory&&(a=a.filter(a=>a.product_category===ia.value.productCategory)),ia.value.industry&&(a=a.filter(a=>a.industry===ia.value.industry)),ia.value.contractType&&(a=a.filter(a=>a.contract_type===ia.value.contractType)),a}),na=g(()=>oa.value.filter(a=>"合同"===a.contract_type).length),ua=g(()=>{let a=0;return oa.value.forEach(e=>{if(e.contract_amount){const t=e.contract_amount.match(/[\d.]+/);if(t){const l=parseFloat(t[0]);e.contract_amount.includes("万")?a+=1e4*l:e.contract_amount.includes("亿")?a+=1e8*l:a+=l}}}),a>=1e8?`${(a/1e8).toFixed(2)}亿`:a>=1e4?`${(a/1e4).toFixed(2)}万`:a.toFixed(2)}),pa=async()=>{la.value=!0;try{const a=await F.getCases({company_id:ca.value});a.success&&a.data&&(oa.value=a.data.map(a=>({...a,contract_start_date:a.contract_start_date?U(a.contract_start_date,"date"):"-",contract_end_date:a.contract_end_date?U(a.contract_end_date,"date"):"-",created_at:a.created_at?U(a.created_at):"-"})))}catch(a){ta("加载失败",a instanceof Error?a.message:"未知错误")}finally{la.value=!1}},_a=()=>{},ma=()=>{ia.value.keyword="",ia.value.productCategory="",ia.value.industry="",ia.value.contractType=""},va=async()=>{var a;if(0!==ra.value.length){sa.value=!0;try{const e=ca.value||(null==(a=ra.value[0])?void 0:a.company_id),t=await F.createCase({company_id:e,case_title:"新建案例",customer_name:"待完善",industry:"金融",contract_type:"合同"});t.success&&t.data?(ea("创建成功","正在跳转到编辑页面..."),w.push(`/knowledge/case/${t.data.case_id}`)):ta("创建失败",t.error||"未知错误")}catch(e){ta("创建失败",e instanceof Error?e.message:"未知错误")}finally{sa.value=!1}}else ta("无法创建","请先添加企业信息")};return j(async()=>{await(async()=>{try{const a=await I.getCompanies();a.success&&a.data&&(ra.value=a.data,ra.value.length>0&&!ca.value&&(ca.value=ra.value[0].company_id,await pa()))}catch(a){}})()}),(a,e)=>{const _=t,h=D,g=n,j=i,U=c,I=v,ra=m,ca=r,ya=q,fa=H,ba=P;return C(),x("div",M,[k("div",O,[E(h,{class:"stat-card"},{default:V(()=>[k("div",Q,[k("div",R,[E(_,{size:32,color:"#409eff"},{default:V(()=>[E(z(l))]),_:1})]),k("div",A,[e[4]||(e[4]=k("div",{class:"stat-label"},"总案例数",-1)),k("div",G,$(oa.value.length),1)])])]),_:1}),E(h,{class:"stat-card"},{default:V(()=>[k("div",N,[k("div",X,[E(_,{size:32,color:"#67c23a"},{default:V(()=>[E(z(s))]),_:1})]),k("div",Z,[e[5]||(e[5]=k("div",{class:"stat-label"},"合同案例",-1)),k("div",B,$(na.value),1)])])]),_:1}),E(h,{class:"stat-card"},{default:V(()=>[k("div",J,[k("div",K,[E(_,{size:32,color:"#e6a23c"},{default:V(()=>[E(z(o))]),_:1})]),k("div",S,[e[6]||(e[6]=k("div",{class:"stat-label"},"合同总额",-1)),k("div",W,$(ua.value),1)])])]),_:1})]),E(z(b),{title:"案例列表"},{actions:V(()=>[E(g,{type:"primary",loading:sa.value,onClick:va},{default:V(()=>[E(_,null,{default:V(()=>[E(z(p))]),_:1}),e[7]||(e[7]=T(" 新建案例 ",-1))]),_:1},8,["loading"])]),default:V(()=>[k("div",Y,[E(ca,{inline:!0,model:ia.value},{default:V(()=>[E(U,{label:"搜索"},{default:V(()=>[E(j,{modelValue:ia.value.keyword,"onUpdate:modelValue":e[0]||(e[0]=a=>ia.value.keyword=a),placeholder:"搜索案例标题、客户名称...",clearable:"",style:{width:"300px"},onInput:_a},{prefix:V(()=>[E(_,null,{default:V(()=>[E(z(d))]),_:1})]),_:1},8,["modelValue"])]),_:1}),E(U,{label:"产品分类"},{default:V(()=>[E(ra,{modelValue:ia.value.productCategory,"onUpdate:modelValue":e[1]||(e[1]=a=>ia.value.productCategory=a),placeholder:"全部产品",clearable:"",style:{width:"130px"},onChange:_a},{default:V(()=>[E(I,{label:"全部产品",value:""}),E(I,{label:"风控产品",value:"风控产品"}),E(I,{label:"实修",value:"实修"}),E(I,{label:"免密",value:"免密"}),E(I,{label:"风控位置",value:"风控位置"})]),_:1},8,["modelValue"])]),_:1}),E(U,{label:"行业"},{default:V(()=>[E(ra,{modelValue:ia.value.industry,"onUpdate:modelValue":e[2]||(e[2]=a=>ia.value.industry=a),placeholder:"全部行业",clearable:"",style:{width:"120px"},onChange:_a},{default:V(()=>[E(I,{label:"全部行业",value:""}),E(I,{label:"科技",value:"科技"}),E(I,{label:"制造业",value:"制造业"}),E(I,{label:"金融",value:"金融"}),E(I,{label:"教育",value:"教育"}),E(I,{label:"医疗",value:"医疗"}),E(I,{label:"建筑",value:"建筑"}),E(I,{label:"其他",value:"其他"})]),_:1},8,["modelValue"])]),_:1}),E(U,{label:"合同类型"},{default:V(()=>[E(ra,{modelValue:ia.value.contractType,"onUpdate:modelValue":e[3]||(e[3]=a=>ia.value.contractType=a),placeholder:"全部类型",clearable:"",style:{width:"120px"},onChange:_a},{default:V(()=>[E(I,{label:"全部类型",value:""}),E(I,{label:"合同",value:"合同"}),E(I,{label:"订单",value:"订单"})]),_:1},8,["modelValue"])]),_:1}),E(U,null,{default:V(()=>[E(g,{onClick:ma},{default:V(()=>[E(_,null,{default:V(()=>[E(z(u))]),_:1}),e[8]||(e[8]=T(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),la.value?(C(),L(z(y),{key:0,text:"加载中..."})):da.value.length?(C(),L(ba,{key:2,data:da.value,stripe:"",style:{width:"100%"}},{default:V(()=>[E(ya,{prop:"case_id",label:"ID",width:"70",fixed:""}),E(ya,{prop:"case_title",label:"案例标题","min-width":"200",fixed:"","show-overflow-tooltip":""}),E(ya,{prop:"customer_name",label:"客户名称",width:"180","show-overflow-tooltip":""}),E(ya,{prop:"product_category",label:"产品分类",width:"110",align:"center"},{default:V(({row:a})=>[a.product_category?(C(),L(fa,{key:0,type:"primary",size:"small"},{default:V(()=>[T($(a.product_category),1)]),_:2},1024)):(C(),x("span",aa,"-"))]),_:1}),E(ya,{prop:"industry",label:"所属行业",width:"100"}),E(ya,{prop:"contract_type",label:"合同类型",width:"100",align:"center"},{default:V(({row:a})=>[E(fa,{type:"合同"===a.contract_type?"primary":"success",size:"small"},{default:V(()=>[T($(a.contract_type),1)]),_:2},1032,["type"])]),_:1}),E(ya,{prop:"contract_amount",label:"合同金额",width:"120",align:"right"}),E(ya,{prop:"contract_start_date",label:"合同开始日期",width:"120"}),E(ya,{prop:"contract_end_date",label:"合同结束日期",width:"120"}),E(ya,{prop:"created_at",label:"创建时间",width:"160","show-overflow-tooltip":""}),E(ya,{label:"操作",width:"220",fixed:"right"},{default:V(({row:a})=>[E(g,{text:"",type:"primary",size:"small",onClick:e=>(a=>{w.push(`/knowledge/case/${a.case_id}`)})(a)},{default:V(()=>[...e[9]||(e[9]=[T(" 查看详情 ",-1)])]),_:1},8,["onClick"]),E(g,{text:"",type:"warning",size:"small",onClick:e=>(a=>{w.push(`/knowledge/case/${a.case_id}`)})(a)},{default:V(()=>[...e[10]||(e[10]=[T(" 编辑 ",-1)])]),_:1},8,["onClick"]),E(g,{text:"",type:"danger",size:"small",onClick:e=>(async a=>{try{if(!confirm(`确定要删除案例 "${a.case_title}" 吗？此操作不可恢复。`))return;const e=await F.deleteCase(a.case_id);e.success?(ea("删除成功",`已删除案例: ${a.case_title}`),await pa()):ta("删除失败",e.error||"未知错误")}catch(e){ta("删除失败",e instanceof Error?e.message:"未知错误")}})(a)},{default:V(()=>[...e[11]||(e[11]=[T(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])):(C(),L(z(f),{key:1,type:"no-data",description:"暂无案例数据"}))]),_:1})])}}}),[["__scopeId","data-v-b804739c"]]);export{ea as default};
