import{t as e}from"./tender-lE9zOws1.js";import{u as l}from"./project-BvI9efyp.js";import{r as s,x as t,aA as a,d as i,B as o,a0 as n,o as r,w as c,e as u,g as p,H as d,F as f,aF as _,c as h,t as v,k as m,C as F,l as g,ba as w}from"./index.js";import{_ as y}from"./_plugin-vue_export-helper-BZqs1yfm.js";/* empty css                 *//* empty css               */import{a as j}from"./helpers-De3g06u1.js";import{E as b}from"./index-CNz3qB3a.js";import{E as x}from"./strings-DBU9TC1F.js";import"./HistoryFilesPanel.vue_vue_type_style_index_0_scoped_8037c805_lang-DZHVYQUE.js";function P(){const i=l(),o=s([]),n=s(!1),r=s(null),c=s({tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null}),u=t(()=>o.value.find(e=>e.id===i.projectId)),p=t(()=>o.value.length>0),d=t(()=>null!==c.value.tenderFile),f=t(()=>null!==c.value.templateFile),_=t(()=>null!==c.value.technicalFile),h=async(l,s)=>{if(m(),(null==s?void 0:s.onClear)&&s.onClear(),l){try{const s=await e.getProject(l);s.data&&i.setCurrentProject(s.data)}catch(t){a.error("获取项目详情失败")}await v(l,s)}else i.clearCurrentProject()},v=async(l,s)=>{var t,i,o,u,p,d,f,_,h;n.value=!0;try{const n=(await e.getProject(l)).data;if(!n)return void a.warning("未找到项目数据");const r=n.step1_data,v={tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null};if(null==r?void 0:r.file_path){const e=(null==(t=(r.file_name||r.file_path.split("/").pop()||"招标文档").split(".").pop())?void 0:t.toLowerCase())||"doc";["doc","docx"].includes(e);v.tenderFile={name:r.file_name||"招标文档",url:r.file_path,status:"success",uid:Date.now()+Math.random(),size:r.file_size||0}}if(null==r?void 0:r.response_file_path){const e=r.response_file_path.split("/").pop()||"应答模板",l=(null==(i=e.split(".").pop())?void 0:i.toLowerCase())||"doc";["doc","docx"].includes(l);v.templateFile={name:e,url:r.response_file_path,status:"success",uid:Date.now()+Math.random()+1,size:0}}if(null==r?void 0:r.technical_file_path){const e=r.technical_file_path.split("/").pop()||"技术需求文档",l=(null==(o=e.split(".").pop())?void 0:o.toLowerCase())||"doc";["doc","docx"].includes(l);v.technicalFile={name:e,url:r.technical_file_path,status:"success",uid:Date.now()+Math.random()+2,size:0}}if(null==r?void 0:r.business_response_file){const e=r.business_response_file,s=(null==(p=((null==(u=e.file_path)?void 0:u.split("/").pop())||"商务应答文件").split(".").pop())?void 0:p.toLowerCase())||"docx",t=["doc","docx"].includes(s);v.businessResponseFile={success:!0,outputFile:e.file_path,downloadUrl:F(e.file_path),previewUrl:t?`/api/business-response/preview/${l}`:void 0,stats:e.stats||{},message:"该项目已有商务应答文件",isHistory:!0,generated_at:e.generated_at||r.updated_at}}if(null==r?void 0:r.technical_point_to_point_file){const e=r.technical_point_to_point_file,s=(null==(f=((null==(d=e.file_path)?void 0:d.split("/").pop())||"点对点应答文件").split(".").pop())?void 0:f.toLowerCase())||"docx",t=["doc","docx"].includes(s);v.p2pResponseFile={success:!0,outputFile:e.file_path,downloadUrl:F(e.file_path),previewUrl:t?`/api/point-to-point/preview/${l}`:void 0,stats:e.stats||{},message:"该项目已有点对点应答文件",isHistory:!0,generated_at:e.generated_at||r.updated_at}}if(null==r?void 0:r.technical_proposal_file){const e=r.technical_proposal_file,s=(null==(h=((null==(_=e.file_path)?void 0:_.split("/").pop())||"技术方案文件").split(".").pop())?void 0:h.toLowerCase())||"docx",t=["doc","docx"].includes(s);v.techProposalFile={success:!0,outputFile:e.file_path,downloadUrl:F(e.file_path),previewUrl:t?`/api/tech-proposal/preview/${l}`:void 0,stats:e.stats||{},message:"该项目已有技术方案文件",isHistory:!0,generated_at:e.generated_at||r.updated_at}}c.value=v,(null==s?void 0:s.onDocumentsLoaded)&&s.onDocumentsLoaded(v)}catch(v){r.value="加载项目文档失败",a.error(r.value)}finally{n.value=!1}},m=()=>{c.value={tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null}},F=e=>{if(e.startsWith("/api/"))return e.includes("?")?`${e}&download=true`:`${e}?download=true`;let l=e;const s="/Users/lvhe/Downloads/zhongbiao/zhongbiao/";return l.startsWith(s)&&(l=l.substring(42)),l.startsWith("ai_tender_system/data/")?l=l.substring(22):l.startsWith("data/")&&(l=l.substring(5)),`/api/files/serve/${l}?download=true`};return{projects:o,loading:n,error:r,currentDocuments:c,selectedProject:u,hasProjects:p,hasTenderFile:d,hasTemplateFile:f,hasTechnicalFile:_,loadProjects:async l=>{var s;n.value=!0,r.value=null;try{const t=await e.getProjects({page:1,page_size:100,...l});o.value=(null==(s=t.data)?void 0:s.items)||[],0===o.value.length&&a.warning("暂无项目数据")}catch(t){r.value="加载项目列表失败",a.error(r.value)}finally{n.value=!1}},handleProjectChange:h,loadProjectDocuments:v,clearDocuments:m,restoreProjectFromStore:async e=>i.projectId?(await h(i.projectId,e),i.projectId):null,filePathToUploadFile:(e,l)=>({name:l||e.split("/").pop()||"文件",url:e,status:"success",uid:Date.now()+Math.random(),size:0}),getDownloadUrl:F}}function C(e={}){const{onFileLoaded:l,onFileCancelled:i,onSyncSuccess:o}=e,n=s(!1),r=s(null),c=s(!1),u=s(!1),p=t(()=>!!r.value),d=e=>({technicalFile:"技术需求文件",tenderFile:"招标文档",templateFile:"应答模板",businessResponseFile:"商务应答文件",p2pResponseFile:"点对点应答文件",techProposalFile:"技术方案文件"}[e]||"文件");return{useHitlFile:n,hitlFileInfo:r,hasHitlFile:p,syncing:c,synced:u,loadFromHITL:(e,s="technicalFile")=>{const t=e[s];return t?(r.value={filename:t.filename||t.name||"未知文件",file_path:t.file_path||t.url||"",file_size:t.file_size||t.size,file_url:t.file_url||t.url},n.value=!0,u.value=!1,a.success({message:`已加载HITL${d(s)}: ${r.value.filename}`,duration:3e3}),l&&l(r.value),!0):(a.warning(`当前项目没有${d(s)}`),!1)},cancelHitlFile:()=>{n.value=!1,r.value=null,u.value=!1,a.info("已取消使用HITL文件"),i&&i()},syncToHitl:async(e,l,s)=>{if(!e)return a.error("项目ID无效"),!1;if(!l)return a.error("文件路径无效"),!1;c.value=!0;try{const t=await fetch(`/api/tender-processing/sync-file/${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({file_path:l,file_type:s})}),i=t.headers.get("content-type");if(!(null==i?void 0:i.includes("application/json"))){await t.text();throw new Error(`服务器返回异常响应 (${t.status}): ${t.statusText}。可能是后端配置问题，请联系管理员。`)}const n=await t.json();if(n.success||t.ok)return u.value=!0,a.success({message:n.message||"已成功同步到投标项目",duration:3e3}),o&&await o(),!0;throw new Error(n.error||n.message||"同步失败")}catch(t){let e="同步到项目失败";return t.message?e=t.message:"TypeError"===t.name&&(e="网络请求失败，请检查网络连接"),a.error({message:e,duration:5e3}),!1}finally{c.value=!1}},resetSyncStatus:()=>{u.value=!1}}}const I={class:"alert-content"},T={class:"file-info"},z={class:"file-details"},H={class:"file-label"},D={class:"file-name"},L={key:0,class:"file-size"},$={class:"alert-actions"},R=y(i({__name:"HitlFileAlert",props:{fileInfo:{},type:{default:"success"},label:{default:"使用HITL文件:"},showCancel:{type:Boolean,default:!0},cancelText:{default:"取消使用"},showTag:{type:Boolean,default:!0}},emits:["cancel"],setup(e,{emit:l}){const s=l,t=()=>{s("cancel")};return(l,s)=>{const a=d,i=x,y=g,P=b;return e.fileInfo?(r(),o(P,{key:0,type:e.type,closable:!1,class:"hitl-file-alert"},{title:c(()=>[u("div",I,[u("div",T,[p(a,{class:"file-icon"},{default:c(()=>[p(f(_))]),_:1}),u("div",z,[u("span",H,v(e.label),1),u("span",D,v(e.fileInfo.filename),1),e.fileInfo.file_size?(r(),h("span",L," ("+v(f(j)(e.fileInfo.file_size))+") ",1)):n("",!0),e.showTag?(r(),o(i,{key:1,type:"success",size:"small",class:"hitl-tag"},{default:c(()=>[...s[0]||(s[0]=[m(" 已从投标项目加载 ",-1)])]),_:1})):n("",!0)])]),u("div",$,[F(l.$slots,"actions",{},()=>[e.showCancel?(r(),o(y,{key:0,type:"text",size:"small",onClick:t},{default:c(()=>[p(a,null,{default:c(()=>[p(f(w))]),_:1}),m(" "+v(e.cancelText),1)]),_:1})):n("",!0)],!0)])])]),_:3},8,["type"])):n("",!0)}}}),[["__scopeId","data-v-1a132715"]]);export{R as H,C as a,P as u};
