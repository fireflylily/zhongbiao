import{t as g}from"./tender-2TSD_jRl.js";import{u as A}from"./project-C4LB9E9r.js";import{k as h}from"./element-plus-IkZgpaz4.js";import{bt as F,bu as _}from"./vendor-CdA3MjAt.js";function J(){const a=A(),u=F([]),d=F(!1),c=F(null),p=F({tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null}),R=_(()=>u.value.find(s=>s.id===a.projectId)),E=_(()=>u.value.length>0),N=_(()=>p.value.tenderFile!==null),b=_(()=>p.value.templateFile!==null),M=_(()=>p.value.technicalFile!==null),S=async s=>{var t;d.value=!0,c.value=null;try{const n=await g.getProjects({page:1,page_size:100,...s});u.value=((t=n.data)==null?void 0:t.items)||[],u.value.length===0&&h.warning("æš‚æ— é¡¹ç›®æ•°æ®")}catch(n){c.value="åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥",h.error(c.value),console.error("Load projects error:",n)}finally{d.value=!1}},w=async(s,t)=>{if(j(),t!=null&&t.onClear&&t.onClear(),s){try{const n=await g.getProject(s);n.data&&a.setCurrentProject(n.data)}catch(n){console.error("èŽ·å–é¡¹ç›®è¯¦æƒ…å¤±è´¥:",n),h.error("èŽ·å–é¡¹ç›®è¯¦æƒ…å¤±è´¥")}await v(s,t)}else a.clearCurrentProject()},v=async(s,t)=>{var n,x,$,P,y,W,C,L,U;d.value=!0;try{const D=(await g.getProject(s)).data;if(!D){h.warning("æœªæ‰¾åˆ°é¡¹ç›®æ•°æ®");return}const e=D.step1_data,r={tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null};if(e!=null&&e.file_path){const o=e.file_name||e.file_path.split("/").pop()||"æ‹›æ ‡æ–‡æ¡£",l=((n=o.split(".").pop())==null?void 0:n.toLowerCase())||"doc",i=["doc","docx"].includes(l);r.tenderFile={name:e.file_name||"æ‹›æ ‡æ–‡æ¡£",url:e.file_path,status:"success",uid:Date.now()+Math.random(),size:e.file_size||0},console.log(`âœ… æ‹›æ ‡æ–‡æ¡£: ${o} (${i?"Word":l})`)}if(e!=null&&e.response_file_path){const o=e.response_file_path.split("/").pop()||"åº”ç­”æ¨¡æ¿",l=((x=o.split(".").pop())==null?void 0:x.toLowerCase())||"doc",i=["doc","docx"].includes(l);r.templateFile={name:o,url:e.response_file_path,status:"success",uid:Date.now()+Math.random()+1,size:0},console.log(`âœ… åº”ç­”æ¨¡æ¿: ${o} (${i?"Word":l})`)}if(e!=null&&e.technical_file_path){const o=e.technical_file_path.split("/").pop()||"æŠ€æœ¯éœ€æ±‚æ–‡æ¡£",l=(($=o.split(".").pop())==null?void 0:$.toLowerCase())||"doc",i=["doc","docx"].includes(l);r.technicalFile={name:o,url:e.technical_file_path,status:"success",uid:Date.now()+Math.random()+2,size:0},console.log(`âœ… æŠ€æœ¯éœ€æ±‚æ–‡æ¡£: ${o} (${i?"Word":l})`)}if(e!=null&&e.business_response_file){const o=e.business_response_file,l=((P=o.file_path)==null?void 0:P.split("/").pop())||"å•†åŠ¡åº”ç­”æ–‡ä»¶",i=((y=l.split(".").pop())==null?void 0:y.toLowerCase())||"docx",f=["doc","docx"].includes(i);r.businessResponseFile={success:!0,outputFile:o.file_path,downloadUrl:m(o.file_path),previewUrl:f?`/api/business-response/preview/${s}`:void 0,stats:o.stats||{},message:"è¯¥é¡¹ç›®å·²æœ‰å•†åŠ¡åº”ç­”æ–‡ä»¶",isHistory:!0,generated_at:o.generated_at||e.updated_at},console.log(`âœ… åŽ†å²å•†åŠ¡åº”ç­”: ${l}`)}if(e!=null&&e.technical_point_to_point_file){const o=e.technical_point_to_point_file,l=((W=o.file_path)==null?void 0:W.split("/").pop())||"ç‚¹å¯¹ç‚¹åº”ç­”æ–‡ä»¶",i=((C=l.split(".").pop())==null?void 0:C.toLowerCase())||"docx",f=["doc","docx"].includes(i);r.p2pResponseFile={success:!0,outputFile:o.file_path,downloadUrl:m(o.file_path),previewUrl:f?`/api/point-to-point/preview/${s}`:void 0,stats:o.stats||{},message:"è¯¥é¡¹ç›®å·²æœ‰ç‚¹å¯¹ç‚¹åº”ç­”æ–‡ä»¶",isHistory:!0,generated_at:o.generated_at||e.updated_at},console.log(`âœ… åŽ†å²ç‚¹å¯¹ç‚¹åº”ç­”: ${l}`)}if(e!=null&&e.technical_proposal_file){const o=e.technical_proposal_file,l=((L=o.file_path)==null?void 0:L.split("/").pop())||"æŠ€æœ¯æ–¹æ¡ˆæ–‡ä»¶",i=((U=l.split(".").pop())==null?void 0:U.toLowerCase())||"docx",f=["doc","docx"].includes(i);r.techProposalFile={success:!0,outputFile:o.file_path,downloadUrl:m(o.file_path),previewUrl:f?`/api/tech-proposal/preview/${s}`:void 0,stats:o.stats||{},message:"è¯¥é¡¹ç›®å·²æœ‰æŠ€æœ¯æ–¹æ¡ˆæ–‡ä»¶",isHistory:!0,generated_at:o.generated_at||e.updated_at},console.log(`âœ… åŽ†å²æŠ€æœ¯æ–¹æ¡ˆ: ${l}`)}p.value=r,t!=null&&t.onDocumentsLoaded&&t.onDocumentsLoaded(r)}catch(z){c.value="åŠ è½½é¡¹ç›®æ–‡æ¡£å¤±è´¥",h.error(c.value),console.error("Load project documents error:",z)}finally{d.value=!1}},j=()=>{p.value={tenderFile:null,templateFile:null,technicalFile:null,businessResponseFile:null,p2pResponseFile:null,techProposalFile:null}},T=async s=>a.projectId?(console.log(`ðŸ”„ ä»ŽStoreæ¢å¤é¡¹ç›®: ${a.projectId}`),await w(a.projectId,s),a.projectId):null,H=(s,t)=>({name:t||s.split("/").pop()||"æ–‡ä»¶",url:s,status:"success",uid:Date.now()+Math.random(),size:0}),m=s=>{if(s.startsWith("/api/"))return s.includes("?")?`${s}&download=true`:`${s}?download=true`;let t=s;const n="/Users/lvhe/Downloads/zhongbiao/zhongbiao/";return t.startsWith(n)&&(t=t.substring(n.length)),t.startsWith("ai_tender_system/data/")?t=t.substring(22):t.startsWith("data/")&&(t=t.substring(5)),`/api/files/serve/${t}?download=true`};return{projects:u,loading:d,error:c,currentDocuments:p,selectedProject:R,hasProjects:E,hasTenderFile:N,hasTemplateFile:b,hasTechnicalFile:M,loadProjects:S,handleProjectChange:w,loadProjectDocuments:v,clearDocuments:j,restoreProjectFromStore:T,filePathToUploadFile:H,getDownloadUrl:m}}export{J as u};
