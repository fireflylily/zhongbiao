import{k as a,e,z as s,d as t,E as l,F as i,i as n,G as c,q as o}from"./index.js";/* empty css                   */import{E as r}from"./el-pagination-CQGtFIJ_.js";/* empty css               */import"./el-select-CldpbmUv.js";/* empty css                     *//* empty css                    *//* empty css                    *//* empty css                         *//* empty css                */import{E as u}from"./index-CzCnSpIZ.js";import{E as d}from"./strings-BjAjE6k-.js";import{E as p}from"./index-CzbDvFem.js";import{E as m}from"./index-BgAfl9sI.js";import{a as v,E as f}from"./index-CUA8F766.js";import{E as g,a as _}from"./index-IU_h0TRZ.js";import{v as y}from"./directive-CBGghap-.js";import{am as k,an as w,bt as h,aW as b,bF as x,au as j,ar as z,ax as C,aq as $,av as E,as as D,aw as F,ay as S,aD as B,aC as I,az as M,aA as V,aB as O,at as P}from"./editor-Dt4gYtYt.js";import"./index-CcWeoNg9.js";import"./toNumber-D5oObipZ.js";import"./_baseIteratee-BnEJjc-Z.js";import"./cloneDeep-syPWYH98.js";import"./index-GOKzZPhn.js";import"./flatMap-B-HSJstM.js";import"./map-7mKJdJp1.js";import"./_baseEach-BT2EtZBY.js";import"./index-zLnbxgQE.js";import"./raf-BZHcGSIv.js";const R="/response-check";const U={class:"response-check"},q={key:0,class:"selected-file"},A={class:"card-header"},G={class:"progress-content"},L={class:"file-info"},N={class:"current-step"},K={key:0,class:"error-message"},Q={class:"card-header"},W={class:"header-actions"},X={class:"statistics"},Y={class:"stat-item total"},H={class:"stat-value"},J={class:"stat-item pass"},T={class:"stat-value"},Z={class:"stat-item fail"},aa={class:"stat-value"},ea={class:"stat-item unknown"},sa={class:"stat-value"},ta={class:"check-details"},la={class:"category-header"},ia={class:"category-icon"},na={class:"category-name"},ca={class:"category-stats"},oa={class:"check-items"},ra={class:"item-status"},ua={key:0,class:"status-icon pass"},da={key:1,class:"status-icon fail"},pa={key:2,class:"status-icon unknown"},ma={class:"item-content"},va={class:"item-name"},fa={key:0,class:"item-detail"},ga={key:1,class:"item-location"},_a={key:2,class:"item-suggestion"},ya={class:"card-header"},ka={key:0},wa={key:1},ha={class:"pagination"},ba=o(k({__name:"ResponseCheck",setup(o){const k=w(),ba=w(null),xa=w(!1),ja=w(null);let za=null;const Ca=w(null),$a=w([]),Ea=w([]),Da=w(!1),Fa=h({page:1,pageSize:10,total:0});function Sa(a){a.raw&&(ba.value=a.raw)}function Ba(){n.warning("只能上传一个文件")}function Ia(a){return!(a.size>52428800)||(n.error("文件大小不能超过 50MB"),!1)}function Ma(){var a;ba.value=null,null==(a=k.value)||a.clearFiles()}async function Va(){if(ba.value){xa.value=!0,Ca.value=null,ja.value=null;try{const s=await async function(e){const s=new FormData;return s.append("file",e),s.append("filename",e.name),a.upload(`${R}/upload`,s,a=>{})}(ba.value);s.success&&s.data?(n.success("检查任务已创建"),ja.value={task_id:s.data.task_id,file_name:ba.value.name,status:"pending",progress:0,current_step:"准备中...",current_category:"",error_message:"",categories:[],statistics:{total_items:0,pass_count:0,fail_count:0,unknown_count:0}},e=s.data.task_id,Oa(),za=window.setInterval(async()=>{try{const s=await async function(e){return a.get(`${R}/status/${e}`)}(e);s.success&&s.data&&(ja.value=s.data,"completed"!==s.data.status&&"failed"!==s.data.status||(Oa(),"completed"===s.data.status&&(await Pa(e),Ua())))}catch(s){}},2e3),Ma()):n.error(s.message||"创建任务失败")}catch(s){n.error(s.message||"上传失败")}finally{xa.value=!1}var e}}function Oa(){za&&(clearInterval(za),za=null)}async function Pa(e){try{const s=await async function(e){return a.get(`${R}/result/${e}`)}(e);s.success&&s.data&&(Ca.value=s.data,$a.value=s.data.categories.filter(a=>a.fail_count>0||a.unknown_count>0).map(a=>a.category_id))}catch(s){n.error("加载结果失败")}}async function Ra(){if(Ca.value)try{const e=`${Ca.value.file_name.replace(/\.[^.]+$/,"")}_自检报告.xlsx`;await async function(e,s){return a.download(`${R}/export/${e}`,s)}(Ca.value.task_id,e),n.success("导出成功")}catch(e){n.error("导出失败")}}async function Ua(){Da.value=!0;try{const e=await async function(e=1,s=10){return a.get(`${R}/history`,{page:e,page_size:s})}(Fa.page,Fa.pageSize);e.success&&e.data&&(Ea.value=e.data.tasks,Fa.total=e.data.total)}catch(e){}finally{Da.value=!1}}async function qa(e){try{await c.confirm("确定要删除这条检查记录吗？","提示",{type:"warning"});const s=await async function(e){return a.delete(`${R}/${e}`)}(e);s.success?(n.success("删除成功"),Ua()):n.error(s.message||"删除失败")}catch(s){}}function Aa(a){if(!a)return"-";return new Date(a).toLocaleString("zh-CN")}function Ga(a){return{pending:"info",parsing:"warning",checking:"warning",completed:"success",failed:"danger"}[a]||"info"}function La(a){return{pending:"等待中",parsing:"解析中",checking:"检查中",completed:"已完成",failed:"失败"}[a]||a}return b(()=>{Ua()}),x(()=>{Oa()}),(a,n)=>{const c=e,o=u,w=d,h=t,b=p,x=m,R=l,za=f,Oa=v,Na=_,Ka=g,Qa=r,Wa=y;return z(),j("div",U,[C(b,{class:"upload-card",shadow:"never"},{header:D(()=>[...n[3]||(n[3]=[F("div",{class:"card-header"},[F("span",null,"上传应答文件")],-1)])]),default:D(()=>[C(o,{ref_key:"uploadRef",ref:k,class:"upload-dragger",drag:"","auto-upload":!1,limit:1,"on-change":Sa,"on-exceed":Ba,"before-upload":Ia,accept:".pdf,.doc,.docx"},{tip:D(()=>[...n[4]||(n[4]=[F("div",{class:"el-upload__tip"}," 支持 PDF、DOC、DOCX 格式，文件大小不超过 50MB ",-1)])]),default:D(()=>[C(c,{class:"el-icon--upload"},{default:D(()=>[C(S(s))]),_:1}),n[5]||(n[5]=F("div",{class:"el-upload__text"},[B(" 将文件拖到此处，或"),F("em",null,"点击上传")],-1))]),_:1},512),ba.value?(z(),j("div",q,[C(w,{type:"info",size:"large",closable:"",onClose:Ma},{default:D(()=>{return[n[6]||(n[6]=F("i",{class:"bi bi-file-earmark-text"},null,-1)),B(" "+I(ba.value.name)+" ("+I((a=ba.value.size,a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB"))+") ",1)];var a}),_:1}),C(h,{type:"primary",loading:xa.value,disabled:!ba.value,onClick:Va},{default:D(()=>[...n[7]||(n[7]=[B(" 开始检查 ",-1)])]),_:1},8,["loading","disabled"])])):E("",!0)]),_:1}),ja.value?(z(),$(b,{key:0,class:"progress-card",shadow:"never"},{header:D(()=>[F("div",A,[n[8]||(n[8]=F("span",null,"检查进度",-1)),C(w,{type:Ga(ja.value.status)},{default:D(()=>[B(I(La(ja.value.status)),1)]),_:1},8,["type"])])]),default:D(()=>[F("div",G,[F("div",L,[n[9]||(n[9]=F("i",{class:"bi bi-file-earmark-pdf"},null,-1)),F("span",null,I(ja.value.file_name),1)]),C(x,{percentage:ja.value.progress,status:"failed"===ja.value.status?"exception":"completed"===ja.value.status?"success":void 0,"stroke-width":20},null,8,["percentage","status"]),F("div",N,I(ja.value.current_step||"准备中..."),1),ja.value.error_message?(z(),j("div",K,[C(R,{title:ja.value.error_message,type:"error",closable:!1},null,8,["title"])])):E("",!0)])]),_:1})):E("",!0),Ca.value?(z(),$(b,{key:1,class:"result-card",shadow:"never"},{header:D(()=>[F("div",Q,[n[11]||(n[11]=F("span",null,"检查结果",-1)),F("div",W,[C(h,{type:"primary",icon:S(i),onClick:Ra},{default:D(()=>[...n[10]||(n[10]=[B(" 导出Excel报告 ",-1)])]),_:1},8,["icon"])])])]),default:D(()=>[F("div",X,[F("div",Y,[F("div",H,I(Ca.value.statistics.total_items),1),n[12]||(n[12]=F("div",{class:"stat-label"},"总检查项",-1))]),F("div",J,[F("div",T,I(Ca.value.statistics.pass_count),1),n[13]||(n[13]=F("div",{class:"stat-label"},"符合",-1))]),F("div",Z,[F("div",aa,I(Ca.value.statistics.fail_count),1),n[14]||(n[14]=F("div",{class:"stat-label"},"不符合",-1))]),F("div",ea,[F("div",sa,I(Ca.value.statistics.unknown_count),1),n[15]||(n[15]=F("div",{class:"stat-label"},"无法判断",-1))])]),F("div",ta,[C(Oa,{modelValue:$a.value,"onUpdate:modelValue":n[0]||(n[0]=a=>$a.value=a)},{default:D(()=>[(z(!0),j(M,null,V(Ca.value.categories,a=>(z(),$(za,{key:a.category_id,name:a.category_id},{title:D(()=>[F("div",la,[F("span",ia,I(a.status_icon),1),F("span",na,I(a.category_name),1),F("span",ca,[C(w,{type:"success",size:"small"},{default:D(()=>[B(I(a.pass_count),1)]),_:2},1024),a.fail_count>0?(z(),$(w,{key:0,type:"danger",size:"small"},{default:D(()=>[B(I(a.fail_count),1)]),_:2},1024)):E("",!0),a.unknown_count>0?(z(),$(w,{key:1,type:"warning",size:"small"},{default:D(()=>[B(I(a.unknown_count),1)]),_:2},1024)):E("",!0)])])]),default:D(()=>[F("div",oa,[(z(!0),j(M,null,V(a.items,a=>{return z(),j("div",{key:a.item_id,class:O(["check-item",(e=a.status,"符合"===e?"item-pass":"不符合"===e?"item-fail":"item-unknown")])},[F("div",ra,["符合"===a.status?(z(),j("span",ua,"✓")):"不符合"===a.status?(z(),j("span",da,"✗")):(z(),j("span",pa,"?"))]),F("div",ma,[F("div",va,I(a.name),1),a.detail?(z(),j("div",fa,I(a.detail),1)):E("",!0),a.location?(z(),j("div",ga,[n[16]||(n[16]=F("i",{class:"bi bi-geo-alt"},null,-1)),B(" "+I(a.location),1)])):E("",!0),a.suggestion?(z(),j("div",_a,[n[17]||(n[17]=F("i",{class:"bi bi-lightbulb"},null,-1)),B(" "+I(a.suggestion),1)])):E("",!0)])],2);var e}),128))])]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])])]),_:1})):E("",!0),C(b,{class:"history-card",shadow:"never"},{header:D(()=>[F("div",ya,[n[19]||(n[19]=F("span",null,"历史检查记录",-1)),C(h,{text:"",type:"primary",onClick:Ua},{default:D(()=>[...n[18]||(n[18]=[F("i",{class:"bi bi-arrow-clockwise"},null,-1),B(" 刷新 ",-1)])]),_:1})])]),default:D(()=>[P((z(),$(Ka,{data:Ea.value,"empty-text":"暂无检查记录"},{default:D(()=>[C(Na,{prop:"original_filename",label:"文件名","min-width":"200","show-overflow-tooltip":""}),C(Na,{prop:"created_at",label:"检查时间",width:"180"},{default:D(({row:a})=>[B(I(Aa(a.created_at)),1)]),_:1}),C(Na,{prop:"status",label:"状态",width:"100"},{default:D(({row:a})=>[C(w,{type:Ga(a.status),size:"small"},{default:D(()=>[B(I(La(a.status)),1)]),_:2},1032,["type"])]),_:1}),C(Na,{label:"结果",width:"150"},{default:D(({row:a})=>["completed"===a.status?(z(),j("span",ka,I(a.pass_count)+"/"+I(a.total_items)+" 符合 ",1)):(z(),j("span",wa,"-"))]),_:1}),C(Na,{label:"操作",width:"150",fixed:"right"},{default:D(({row:a})=>["completed"===a.status?(z(),$(h,{key:0,type:"primary",size:"small",text:"",onClick:e=>async function(a){ja.value=null,await Pa(a)}(a.task_id)},{default:D(()=>[...n[20]||(n[20]=[B(" 查看 ",-1)])]),_:1},8,["onClick"])):E("",!0),C(h,{type:"danger",size:"small",text:"",onClick:e=>qa(a.task_id)},{default:D(()=>[...n[21]||(n[21]=[B(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[Wa,Da.value]]),F("div",ha,[C(Qa,{"current-page":Fa.page,"onUpdate:currentPage":n[1]||(n[1]=a=>Fa.page=a),"page-size":Fa.pageSize,"onUpdate:pageSize":n[2]||(n[2]=a=>Fa.pageSize=a),total:Fa.total,"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next",onSizeChange:Ua,onCurrentChange:Ua},null,8,["current-page","page-size","total"])])]),_:1})])}}}),[["__scopeId","data-v-8623849f"]]);export{ba as default};
