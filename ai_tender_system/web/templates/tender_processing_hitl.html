<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# <meta name="csrf-token" content="{{ csrf_token() }}"> CSRF暂时禁用 #}
    <title>标书智能处理 - HITL流程 - AI标书系统</title>

    <!-- Bootstrap CSS -->
    <link href="/static/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="/static/vendor/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- 自定义样式 -->
    <link rel="stylesheet" href="/static/css/tender-processing-hitl.css">

    <!-- 步骤3增强版样式 -->
    <link rel="stylesheet" href="/static/css/tender-processing-step3-enhanced.css">

    <style>
        body {
            background-color: #f5f5f5;
            padding-top: 70px;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }

        /* 空白状态样式 */
        .empty-state {
            text-align: center;
            padding: 120px 40px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            min-height: 450px;
        }

        .empty-state i {
            display: block;
            opacity: 0.4;
            margin-bottom: 20px;
        }

        .empty-state h5 {
            margin: 15px 0 10px 0;
            font-weight: 600;
            color: #6c757d;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.95rem;
            color: #adb5bd;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-file-earmark-text me-2"></i>AI标书系统
            </a>
            <div class="d-flex align-items-center">
                <a href="/" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-house"></i> 首页
                </a>
                <a href="/knowledge_base" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-database"></i> 知识库
                </a>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container-fluid" style="max-width: 1400px;">
        <!-- 页面标题 -->
        <div class="section-card">
            <h2>
                <i class="bi bi-magic text-primary me-2"></i>标书智能处理 - 人工确认流程
            </h2>
            <p class="text-muted mb-0">
                两步智能处理：<strong>章节选择</strong> → <strong>信息提取与编辑</strong>
            </p>
        </div>

        <!-- 项目和模型配置区域 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-gear"></i> 配置信息
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- 项目选择 -->
                            <div class="col-md-4">
                                <label for="hitlProjectSelect" class="form-label">
                                    <i class="bi bi-folder2"></i> 关联项目 <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <select class="form-select" id="hitlProjectSelect">
                                        <option value="" selected>新建项目</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshHitlProjectsBtn" title="刷新项目列表">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">选择现有项目或创建新项目</small>
                                    <div id="hitlProjectInfo" class="text-primary small" style="display: none;">
                                        <i class="bi bi-info-circle"></i> <span id="hitlProjectName"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- 公司选择 -->
                            <div class="col-md-4">
                                <label for="hitlCompanySelect" class="form-label">
                                    <i class="bi bi-building"></i> 应答公司 <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <select class="form-select" id="hitlCompanySelect" required>
                                        <option value="">请选择公司...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="window.location.href='/knowledge_base?action=company_management';" title="管理公司">
                                        <i class="bi bi-building"></i>
                                    </button>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">当前：</small>
                                    <span id="hitlSelectedCompanyName" class="text-muted">未选择</span>
                                </div>
                            </div>

                            <!-- AI模型选择 -->
                            <div class="col-md-4">
                                <label for="hitlAiModel" class="form-label">
                                    <i class="bi bi-cpu"></i> AI模型 <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <select class="form-select" id="hitlAiModel" onchange="onHitlModelChange()">
                                        <optgroup label="OpenAI（推荐）">
                                            <option value="gpt-4o-mini">GPT-4O Mini ✓</option>
                                            <option value="gpt-4o">GPT-4O</option>
                                        </optgroup>
                                        <optgroup label="联通元景">
                                            <option value="yuanjing-deepseek-v3">DeepSeek-V3（智能提取） ✓</option>
                                            <option value="yuanjing-pro">元景专业版</option>
                                        </optgroup>
                                    </select>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshHitlModels()" title="刷新模型列表">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <!-- 模型状态显示 -->
                                <div class="mt-1" id="hitlModelStatus" style="display: none;">
                                    <small class="d-flex align-items-center">
                                        <span id="hitlModelStatusIcon" class="me-1"></span>
                                        <span id="hitlModelStatusText"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 步骤指示器 -->
        <div class="step-indicator">
            <div class="step active" id="stepIndicator1">
                <div class="step-number">1</div>
                <div class="step-label">章节选择</div>
            </div>
            <!-- 步骤2已隐藏 -->
            <div class="step" id="stepIndicator3">
                <div class="step-number">2</div>
                <div class="step-label">信息提取与编辑</div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- 上传文件区域 -->
        <!-- ==================== -->
        <div id="uploadSection" class="section-card">
            <h4 class="section-title">
                <i class="bi bi-upload me-2"></i>上传标书文档
            </h4>

            <div class="row">
                <div class="col-12">
                    <label for="tenderDocFile" class="form-label">标书文档 <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="tenderDocFile" accept=".docx,.doc">
                    <small class="text-muted">支持 .docx 和 .doc 格式</small>
                </div>
            </div>

            <div class="mt-3">
                <button class="btn btn-primary" id="parseStructureBtn">
                    <i class="bi bi-file-earmark-code me-2"></i>解析文档结构
                </button>
            </div>
        </div>

        <!-- ==================== -->
        <!-- 步骤1：章节选择 -->
        <!-- ==================== -->
        <div id="chapterSelectionSection" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-list-nested me-2"></i>步骤1：选择需要处理的章节
            </h4>

            <!-- 统计信息 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">总章节数</div>
                    <div class="stat-value" id="statTotalChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">已选择</div>
                    <div class="stat-value text-success" id="statSelectedChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">选中字数</div>
                    <div class="stat-value text-info" id="statSelectedWords">0</div>
                </div>
            </div>

            <!-- 批量操作 -->
            <div class="batch-operations">
                <button class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                    <i class="bi bi-check-all"></i> 全选
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="unselectAllBtn">
                    <i class="bi bi-x"></i> 全不选
                </button>
                <button class="btn btn-sm btn-outline-success" id="selectTechBtn">
                    <i class="bi bi-cpu"></i> 仅选技术章节
                </button>
                <button class="btn btn-sm btn-outline-danger" id="excludeContractBtn">
                    <i class="bi bi-file-x"></i> 排除合同条款
                </button>
            </div>

            <div class="row">
                <!-- 左侧：章节树 -->
                <div class="col-md-8">
                    <div class="chapter-search mb-3">
                        <input type="text"
                               class="form-control"
                               id="chapterSearch"
                               placeholder="🔍 搜索章节...">
                    </div>

                    <div class="chapter-tree-container" id="chapterTreeContainer">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-folder2-open" style="font-size: 3rem;"></i>
                            <p class="mt-3">等待文档解析...</p>
                        </div>
                    </div>
                </div>

                <!-- 右侧：预览区 -->
                <div class="col-md-4">
                    <h6 class="mb-3">章节预览</h6>
                    <div id="chapterPreview">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-eye" style="font-size: 3rem;"></i>
                            <p class="mt-3">点击"预览"按钮查看章节内容</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 确认按钮 -->
            <div class="mt-4 text-center">
                <button class="btn btn-primary btn-lg me-3" id="exportSelectedChaptersBtn" disabled>
                    <i class="bi bi-download me-2"></i>导出选中章节
                </button>
                <button class="btn btn-info btn-lg me-3" id="saveAsResponseFileBtn" disabled>
                    <i class="bi bi-file-earmark-arrow-down me-2"></i>另存为应答文件
                </button>
                <button class="btn btn-success btn-lg" id="confirmSelectionBtn">
                    <i class="bi bi-check-circle me-2"></i>确认选择并继续
                </button>
            </div>

            <!-- 完成消息 -->
            <div id="step1CompleteMessage" style="display: none;"></div>
        </div>

        <!-- ==================== -->
        <!-- 步骤2：章节要求预览 -->
        <!-- ==================== -->
        <div id="step2Section" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-list-check me-2"></i>步骤2：章节要求预览
            </h4>

            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                AI已从选中的章节中提取要求。您可以查看每个章节的要求数量，取消不需要的章节。
            </div>

            <!-- 统计信息 -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-label">总章节数</div>
                    <div class="stat-value" id="statTotalChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">已选章节</div>
                    <div class="stat-value text-success" id="statSelectedChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">提取要求数</div>
                    <div class="stat-value text-primary" id="statTotalRequirementsStep2">0</div>
                </div>
            </div>

            <!-- 章节列表 -->
            <div id="chapterRequirementsContainer" style="max-height: 600px; overflow-y: auto;">
                <div class="text-center text-muted py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">正在加载章节数据...</p>
                </div>
            </div>

            <!-- 确认继续按钮 -->
            <div class="mt-4 text-center">
                <button class="btn btn-success btn-lg" id="confirmStep2Btn">
                    <i class="bi bi-arrow-right me-2"></i>确认并继续步骤3
                </button>
            </div>
        </div>

        <!-- ==================== -->
        <!-- 步骤3：信息提取与编辑 -->
        <!-- ==================== -->
        <div id="step3Section" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-clipboard-data me-2"></i>步骤3：信息提取与编辑
            </h4>

            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                在此步骤中，您可以查看和编辑<strong>基本信息</strong>、<strong>资格要求</strong>、<strong>评分办法</strong>、<strong>技术需求</strong>和<strong>商务应答</strong>。AI已自动提取这些信息，您可以根据需要修正。
            </div>

            <!-- Tab导航 -->
            <ul class="nav nav-tabs mb-4" id="step3Tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basicInfoPanel" type="button" role="tab">
                        <i class="bi bi-info-circle me-2"></i>基本信息
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="eligibility-tab" data-bs-toggle="tab" data-bs-target="#eligibilityPanel" type="button" role="tab">
                        <i class="bi bi-person-check me-2"></i>资格要求
                        <span class="badge bg-success ms-1" id="eligBadge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="scoring-tab" data-bs-toggle="tab" data-bs-target="#scoringPanel" type="button" role="tab">
                        <i class="bi bi-graph-up me-2"></i>评分办法
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="document-format-tab" data-bs-toggle="tab" data-bs-target="#documentFormatPanel" type="button" role="tab">
                        <i class="bi bi-file-earmark-text me-2"></i>商务应答
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technicalPanel" type="button" role="tab">
                        <i class="bi bi-gear me-2"></i>技术需求
                    </button>
                </li>
            </ul>

            <!-- Tab内容 -->
            <div class="tab-content" id="step3TabContent">
                <!-- ==================== -->
                <!-- Tab 1: 基本信息 -->
                <!-- ==================== -->
                <div class="tab-pane fade show active" id="basicInfoPanel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>项目基本信息</h5>
                        <button class="btn btn-sm btn-outline-primary" id="extractBasicInfoBtn">
                            <i class="bi bi-magic me-2"></i>AI提取基本信息
                        </button>
                    </div>

                    <div id="basicInfoLoading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3 text-muted">正在提取基本信息...</p>
                    </div>

                    <form id="basicInfoForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="projectName" class="form-label">项目名称</label>
                                <input type="text" class="form-control" id="projectName" name="project_name">
                            </div>
                            <div class="col-md-6">
                                <label for="projectNumber" class="form-label">项目编号</label>
                                <input type="text" class="form-control" id="projectNumber" name="project_number">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderParty" class="form-label">招标人</label>
                                <input type="text" class="form-control" id="tenderParty" name="tender_party">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderAgent" class="form-label">招标代理</label>
                                <input type="text" class="form-control" id="tenderAgent" name="tender_agent">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderMethod" class="form-label">投标方式</label>
                                <input type="text" class="form-control" id="tenderMethod" name="tender_method">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderLocation" class="form-label">投标地点</label>
                                <input type="text" class="form-control" id="tenderLocation" name="tender_location">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderDeadline" class="form-label">投标时间</label>
                                <input type="text" class="form-control" id="tenderDeadline" name="tender_deadline">
                            </div>
                            <div class="col-md-6">
                                <label for="winnerCount" class="form-label">中标人数量</label>
                                <input type="text" class="form-control" id="winnerCount" name="winner_count">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- ==================== -->
                <!-- Tab 2: 资格要求 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="eligibilityPanel" role="tabpanel">
                    <!-- AI提取按钮区域 -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">资格要求</h5>
                        <button class="btn btn-primary" id="extractRequirementsBtn">
                            <i class="fas fa-magic me-2"></i>AI提取资格要求
                        </button>
                    </div>

                    <!-- 提取进度提示 -->
                    <div id="requirementsExtractionProgress" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                            <div>
                                <strong>AI正在提取要求...</strong>
                                <p class="mb-0 small">这可能需要40-60秒，请耐心等待</p>
                            </div>
                        </div>
                    </div>

                    <!-- 空状态提示 -->
                    <div id="eligibilityEmptyState" class="alert alert-light border text-center py-5">
                        <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">尚未提取供应商资格要求</h5>
                        <p class="text-muted mb-3">点击上方的"AI提取资格要求"按钮开始智能提取</p>
                        <p class="small text-muted mb-0">
                            提取范围：您在步骤1中选中的章节<br>
                            提取内容：营业执照、财务、纳税、社保、电信许可证、ISO认证等19条供应商资格要求
                        </p>
                    </div>

                    <!-- 19条资格要求清单容器 -->
                    <div id="eligibilityChecklistContainer" style="display: none;">
                        <!-- 统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0"><span id="eligFoundCount">0</span> 条</h2>
                                        <div class="small">已找到</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0"><span id="eligNotFoundCount">0</span> 条</h2>
                                        <div class="small">未找到</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 清单显示区域 -->
                        <div id="eligibilityChecklistItems">
                            <!-- 这里将由JavaScript动态生成19条清单 -->
                        </div>
                    </div>

                    <!-- 要求表格容器 -->
                    <div id="requirementsTableContainer" style="display: none;">
                        <!-- 统计信息 -->
                        <div class="stats-grid mb-4">
                            <div class="stat-card">
                                <div class="stat-label">总要求数</div>
                                <div class="stat-value" id="statTotalRequirements">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">强制性</div>
                                <div class="stat-value text-danger" id="statMandatory">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">加分项</div>
                                <div class="stat-value text-warning" id="statScoring">0</div>
                            </div>
                        </div>

                        <!-- 操作栏 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary active" data-type-filter="all">
                                全部
                            </button>
                            <button class="btn btn-outline-danger" data-type-filter="mandatory">
                                强制性
                            </button>
                            <button class="btn btn-outline-warning" data-type-filter="scoring">
                                加分项
                            </button>
                            <button class="btn btn-outline-info" data-type-filter="optional">
                                可选
                            </button>
                        </div>

                        <div>
                            <button class="btn btn-sm btn-primary" id="addRequirementBtn">
                                <i class="bi bi-plus-circle"></i> 新增要求
                            </button>
                            <button class="btn btn-sm btn-success" id="exportExcelBtn">
                                <i class="bi bi-file-excel"></i> 导出Excel
                            </button>
                        </div>
                    </div>

                    <!-- 可编辑表格 -->
                    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="table table-bordered table-hover editable-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th style="width: 120px;">类型</th>
                                    <th style="width: 100px;">分类</th>
                                    <th style="width: 120px;">子分类</th>
                                    <th style="min-width: 300px;">详细描述</th>
                                    <th style="width: 100px;">优先级</th>
                                    <th style="width: 80px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="requirementsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-3">正在加载...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

                <!-- ==================== -->
                <!-- Tab 4: 评分办法 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="scoringPanel" role="tabpanel">
                    <div class="empty-state">
                        <i class="bi bi-clipboard2-data fs-1 text-muted"></i>
                        <h5 class="text-muted">评分办法</h5>
                        <p class="text-muted">内容待填充</p>
                    </div>
                </div>

                <!-- ==================== -->
                <!-- Tab 5: 技术需求 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="technicalPanel" role="tabpanel">
                    <!-- 已保存的技术需求显示区域 -->
                    <div id="technicalFileContent" style="min-height: 200px; padding: 20px;">
                        <div class="empty-state" id="noTechnicalFileMessage">
                            <i class="bi bi-gear fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">技术需求</h5>
                            <p class="text-muted">尚未保存技术需求章节</p>
                            <p class="text-muted small">点击下方按钮从章节目录中选择技术需求相关章节</p>
                            <button class="btn btn-primary mt-3" id="selectChaptersForTechnicalBtn">
                                <i class="bi bi-list-nested me-2"></i>从章节目录选择
                            </button>
                        </div>
                    </div>

                    <!-- 章节选择区域（默认隐藏） -->
                    <div id="technicalChapterSelectionArea" style="display: none; margin-top: 20px;">
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-list-nested me-2"></i>选择技术需求相关章节
                                    </h6>
                                    <button class="btn btn-sm btn-outline-secondary" id="hideTechnicalChapterSelectionBtn">
                                        <i class="bi bi-x"></i> 取消
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- 统计信息 -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body text-center py-2">
                                                <small class="text-muted">总章节数</small>
                                                <h5 class="mb-0" id="technicalStatTotalChapters">0</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center py-2">
                                                <small>已选择</small>
                                                <h5 class="mb-0" id="technicalStatSelectedChapters">0</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center py-2">
                                                <small>选中字数</small>
                                                <h5 class="mb-0" id="technicalStatSelectedWords">0</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 批量操作 -->
                                <div class="mb-3">
                                    <button class="btn btn-sm btn-outline-primary" id="technicalSelectAllBtn">
                                        <i class="bi bi-check-all"></i> 全选
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="technicalUnselectAllBtn">
                                        <i class="bi bi-x"></i> 全不选
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" id="technicalSelectTechBtn">
                                        <i class="bi bi-cpu"></i> 仅选技术章节
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" id="technicalExcludeContractBtn">
                                        <i class="bi bi-file-x"></i> 排除合同条款
                                    </button>
                                </div>

                                <!-- 章节树容器 -->
                                <div id="technicalChapterTreeContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; background: #f8f9fa;">
                                    <div class="text-center text-muted py-5">
                                        <i class="bi bi-folder2-open" style="font-size: 3rem;"></i>
                                        <p class="mt-3">正在加载章节...</p>
                                    </div>
                                </div>

                                <!-- 确认按钮 -->
                                <div class="mt-3 text-end">
                                    <button class="btn btn-secondary me-2" id="cancelTechnicalSelectionBtn">取消</button>
                                    <button class="btn btn-success" id="confirmTechnicalSaveBtn">
                                        <i class="bi bi-check-circle me-2"></i>确认保存技术需求章节
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 技术需求快捷操作区域 -->
                    <div class="mt-4" id="technicalQuickActions" style="display: none;">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="bi bi-lightning-charge me-2"></i>快捷操作
                                </h6>
                            </div>
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <i class="bi bi-info-circle me-2"></i>
                                    已保存技术需求章节，您可以使用以下功能对技术需求进行处理：
                                </p>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-primary w-100" id="goToPointToPointBtn" onclick="goToPointToPoint()">
                                            <i class="bi bi-chat-dots me-2"></i>点对点应答
                                            <p class="small mb-0 mt-1 text-muted">针对具体技术问题进行详细应答</p>
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button class="btn btn-outline-success w-100" id="goToTechProposalBtn" onclick="goToTechProposal()">
                                            <i class="bi bi-file-earmark-code me-2"></i>技术方案编写
                                            <p class="small mb-0 mt-1 text-muted">生成完整的技术方案文档</p>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 点对点应答完成文件区域 -->
                    <div style="margin-top: 30px; padding: 20px; border-top: 2px solid #e9ecef;">
                        <h5 class="mb-3">
                            <i class="bi bi-chat-dots me-2 text-primary"></i>点对点应答完成文件
                        </h5>
                        <div id="pointToPointResponseContent" style="min-height: 150px;">
                            <div class="empty-state" id="noPointToPointResponseMessage">
                                <i class="bi bi-chat-dots fs-1 text-muted mb-3"></i>
                                <p class="text-muted">尚未生成点对点应答文件</p>
                                <p class="text-muted small">
                                    在<strong>点对点应答</strong>页面完成处理后，点击"同步到投标项目"按钮，文件将显示在这里
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- 技术方案完成文件区域 -->
                    <div style="margin-top: 30px; padding: 20px; border-top: 2px solid #e9ecef;">
                        <h5 class="mb-3">
                            <i class="bi bi-file-earmark-code me-2 text-success"></i>技术方案完成文件
                        </h5>
                        <div id="techProposalResponseContent" style="min-height: 150px;">
                            <div class="empty-state" id="noTechProposalResponseMessage">
                                <i class="bi bi-file-earmark-code fs-1 text-muted mb-3"></i>
                                <p class="text-muted">尚未生成技术方案文件</p>
                                <p class="text-muted small">
                                    在<strong>技术方案生成</strong>页面完成后，点击"同步到投标项目"按钮，文件将显示在这里
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ==================== -->
                <!-- Tab 6: 商务应答 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="documentFormatPanel" role="tabpanel">
                    <!-- 已保存的应答文件显示区域 -->
                    <div id="responseFileContent" style="min-height: 200px; padding: 20px;">
                        <div class="empty-state" id="noResponseFileMessage">
                            <i class="bi bi-file-earmark-text fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">商务应答</h5>
                            <p class="text-muted">尚未保存应答文件模板</p>
                            <p class="text-muted small">请在步骤1中选择章节后，点击"另存为应答文件"按钮</p>
                            <button class="btn btn-primary mt-3" id="selectChaptersForResponseFileBtn">
                                <i class="bi bi-list-nested me-2"></i>从章节目录选择
                            </button>
                        </div>
                    </div>

                    <!-- 章节选择区域（默认隐藏） -->
                    <div id="inlineChapterSelectionArea" style="display: none; margin-top: 20px;">
                        <div class="card">
                            <div class="card-header bg-light">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-list-nested me-2"></i>选择章节作为商务应答
                                    </h6>
                                    <button class="btn btn-sm btn-outline-secondary" id="hideChapterSelectionBtn">
                                        <i class="bi bi-x"></i> 取消
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- 统计信息 -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body text-center py-2">
                                                <small class="text-muted">总章节数</small>
                                                <h5 class="mb-0" id="inlineStatTotalChapters">0</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center py-2">
                                                <small>已选择</small>
                                                <h5 class="mb-0" id="inlineStatSelectedChapters">0</h5>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center py-2">
                                                <small>选中字数</small>
                                                <h5 class="mb-0" id="inlineStatSelectedWords">0</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 批量操作 -->
                                <div class="mb-3">
                                    <button class="btn btn-sm btn-outline-primary" id="inlineSelectAllBtn">
                                        <i class="bi bi-check-all"></i> 全选
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="inlineUnselectAllBtn">
                                        <i class="bi bi-x"></i> 全不选
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" id="inlineSelectTechBtn">
                                        <i class="bi bi-cpu"></i> 仅选技术章节
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" id="inlineExcludeContractBtn">
                                        <i class="bi bi-file-x"></i> 排除合同条款
                                    </button>
                                </div>

                                <!-- 章节树容器 -->
                                <div id="inlineChapterTreeContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; background: #f8f9fa;">
                                    <div class="text-center text-muted py-5">
                                        <i class="bi bi-folder2-open" style="font-size: 3rem;"></i>
                                        <p class="mt-3">正在加载章节...</p>
                                    </div>
                                </div>

                                <!-- 确认按钮 -->
                                <div class="mt-3 text-end">
                                    <button class="btn btn-secondary me-2" id="cancelInlineSelectionBtn">取消</button>
                                    <button class="btn btn-success" id="confirmInlineSaveResponseFileBtn">
                                        <i class="bi bi-check-circle me-2"></i>确认保存为应答文件
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 商务应答完成文件区域（放在商务应答下方） -->
                    <div style="margin-top: 30px; padding: 20px; border-top: 2px solid #e9ecef;">
                        <h5 class="mb-3">
                            <i class="bi bi-briefcase-fill me-2 text-info"></i>商务应答完成文件
                        </h5>
                        <div id="businessResponseContent" style="min-height: 150px;">
                            <div class="empty-state" id="noBusinessResponseMessage">
                                <i class="bi bi-briefcase-fill fs-1 text-muted mb-3"></i>
                                <p class="text-muted">尚未生成商务应答完成文件</p>
                                <p class="text-muted small">
                                    在<strong>商务应答</strong>页面完成处理后，点击"同步到投标项目"按钮，文件将显示在这里
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统一保存按钮 -->
            <div class="mt-4 text-center">
                <button class="btn btn-success btn-lg" id="saveAndCompleteBtn">
                    <i class="bi bi-check-circle me-2"></i>保存并完成
                </button>
            </div>

            <!-- 完成消息 -->
            <div id="step3CompleteMessage" style="display: none;"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- 步骤3增强版脚本（包含基本信息、资质要求、详细要求） - 必须先加载，因为步骤1需要调用proceedToStep3函数 -->
    <script src="/static/js/pages/tender-processing-step3-enhanced.js?v=1760001321"></script>

    <!-- 步骤1脚本 -->
    <script src="/static/js/pages/tender-processing-step1.js"></script>

    <!-- 步骤2脚本 -->
    <script src="/static/js/pages/tender-processing-step2.js"></script>

    <!-- HITL配置管理器 -->
    <script>
        // HITL页面的模型和公司管理
        const HITLConfigManager = {
            currentCompanyId: null,
            currentModel: 'yuanjing-deepseek-v3',
            currentProjectId: null,        // 当前项目ID（用于创建/更新判断）
            selectedProjectId: null,        // 项目选择器的值

            // 初始化
            init() {
                console.log('[HITLConfigManager] 初始化配置管理器');

                // 加载公司列表
                this.loadCompanies();

                // 加载模型列表
                this.loadModels();

                // 加载项目列表（显示所有项目）
                this.loadProjects();

                // 绑定事件
                this.bindEvents();
            },

            // 加载公司列表
            async loadCompanies() {
                try {
                    const response = await fetch('/api/companies');
                    const data = await response.json();

                    if (data.success && data.data) {
                        const select = document.getElementById('hitlCompanySelect');
                        const nameSpan = document.getElementById('hitlSelectedCompanyName');

                        select.innerHTML = '<option value="">请选择公司...</option>';

                        data.data.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.company_id;
                            option.textContent = company.company_name;
                            select.appendChild(option);
                        });

                        console.log(`[HITLConfigManager] 加载了 ${data.data.length} 个公司`);
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] 加载公司列表失败:', error);
                }
            },

            // 加载模型列表
            async loadModels() {
                try {
                    const response = await fetch('/api/models');
                    const data = await response.json();

                    if (data.success && data.models) {
                        this.updateModelSelect(data.models);
                        console.log(`[HITLConfigManager] 加载了 ${data.count} 个AI模型`);
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] 加载模型列表失败:', error);
                }
            },

            // 加载项目列表
            async loadProjects() {
                try {
                    console.log('[HITLConfigManager] 开始加载项目列表...');
                    const url = this.currentCompanyId
                        ? `/api/tender-projects?company_id=${this.currentCompanyId}`
                        : '/api/tender-projects';

                    const response = await fetch(url);
                    const data = await response.json();

                    const select = document.getElementById('hitlProjectSelect');
                    select.innerHTML = '<option value="">新建项目</option>';

                    if (data.success && data.data && data.data.length > 0) {
                        data.data.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project.project_id;
                            const projectNumber = project.project_number || '无编号';
                            const status = project.status || 'draft';
                            option.textContent = `${project.project_name} (${projectNumber}) [${status}]`;
                            select.appendChild(option);
                        });

                        console.log(`[HITLConfigManager] 成功加载 ${data.data.length} 个项目`);
                    } else {
                        console.log('[HITLConfigManager] 没有找到项目数据');
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] 加载项目列表失败:', error);
                }
            },

            // 加载并显示项目详情
            async loadProjectDetails(projectId) {
                try {
                    console.log('[HITLConfigManager] 开始加载项目详情:', projectId);
                    const response = await fetch(`/api/tender-projects/${projectId}`);
                    const data = await response.json();

                    if (data.success && data.data) {
                        const project = data.data;

                        // 【新增】先设置公司选择器
                        if (project.company_id) {
                            const companySelect = document.getElementById('hitlCompanySelect');
                            const companyNameSpan = document.getElementById('hitlSelectedCompanyName');

                            if (companySelect) {
                                companySelect.value = project.company_id;
                                this.currentCompanyId = project.company_id;

                                // 更新公司名称显示
                                if (companyNameSpan) {
                                    const selectedOption = companySelect.options[companySelect.selectedIndex];
                                    if (selectedOption) {
                                        companyNameSpan.textContent = selectedOption.text;
                                        companyNameSpan.className = 'text-primary fw-bold';
                                    }
                                }

                                console.log('[HITLConfigManager] 已设置公司:', project.company_id);
                            }
                        }

                        // 填充基本信息表单
                        if (document.getElementById('projectName')) {
                            document.getElementById('projectName').value = project.project_name || '';
                        }
                        if (document.getElementById('projectNumber')) {
                            document.getElementById('projectNumber').value = project.project_number || '';
                        }
                        if (document.getElementById('tenderParty')) {
                            document.getElementById('tenderParty').value = project.tenderer || '';
                        }
                        if (document.getElementById('tenderAgent')) {
                            document.getElementById('tenderAgent').value = project.agency || '';
                        }
                        if (document.getElementById('tenderMethod')) {
                            document.getElementById('tenderMethod').value = project.bidding_method || '';
                        }
                        if (document.getElementById('tenderLocation')) {
                            document.getElementById('tenderLocation').value = project.bidding_location || '';
                        }
                        if (document.getElementById('tenderDeadline')) {
                            document.getElementById('tenderDeadline').value = project.bidding_time || '';
                        }
                        if (document.getElementById('winnerCount')) {
                            document.getElementById('winnerCount').value = project.winner_count || '';
                        }

                        // 显示项目信息提示
                        const projectInfo = document.getElementById('hitlProjectInfo');
                        const projectName = document.getElementById('hitlProjectName');
                        if (projectInfo && projectName) {
                            projectName.textContent = `已加载: ${project.project_name}`;
                            projectInfo.style.display = 'block';
                        }

                        // 保存项目和公司信息到全局变量（供快捷跳转使用）
                        window.currentProjectName = project.project_name || '';
                        window.currentCompanyId = project.company_id || '';

                        // 从公司选择器获取公司名称
                        let companyName = '';
                        const companySelect = document.getElementById('hitlCompanySelect');
                        if (companySelect && companySelect.value) {
                            const selectedOption = companySelect.options[companySelect.selectedIndex];
                            if (selectedOption) {
                                companyName = selectedOption.text;
                            }
                        }
                        window.currentCompanyName = companyName;

                        console.log('[HITLConfigManager] 已保存全局变量:', {
                            projectName: window.currentProjectName,
                            companyId: window.currentCompanyId,
                            companyName: window.currentCompanyName
                        });

                        console.log('[HITLConfigManager] 项目基本信息已加载:', project);

                        // 【新增】查找并加载该项目最新的HITL任务数据
                        await this.findAndLoadHitlTaskData(projectId);

                        return project;
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] 加载项目详情失败:', error);
                    return null;
                }
            },

            // 【新增】查找并加载HITL任务数据
            async findAndLoadHitlTaskData(projectId) {
                try {
                    console.log('[HITLConfigManager] 查找项目的HITL任务:', projectId);

                    const response = await fetch(`/api/tender-processing/hitl-tasks?project_id=${projectId}&latest=true`);
                    const data = await response.json();

                    if (data.success && data.task) {
                        const hitlTask = data.task;
                        console.log('[HITLConfigManager] 找到HITL任务:', hitlTask.hitl_task_id);

                        // 保存当前任务ID（供其他函数使用）
                        window.currentTaskId = hitlTask.hitl_task_id;
                        window.currentHitlTaskId = hitlTask.hitl_task_id;

                        // 【新增】显示原标书文件信息
                        if (hitlTask.step1_data) {
                            try {
                                const step1Data = typeof hitlTask.step1_data === 'string'
                                    ? JSON.parse(hitlTask.step1_data)
                                    : hitlTask.step1_data;

                                if (step1Data.file_path && step1Data.file_name) {
                                    console.log('[HITLConfigManager] 找到原标书文件:', step1Data.file_name);
                                    this.displayUploadedFile(step1Data.file_name, step1Data.file_path);
                                }
                            } catch (parseError) {
                                console.error('[HITLConfigManager] 解析step1_data失败:', parseError);
                            }
                        }

                        // 【修改】主动加载所有Tab的数据
                        console.log('[HITLConfigManager] 开始加载所有Tab数据...');
                        console.log('[HITLConfigManager] loadFileInfo是否已定义:', typeof loadFileInfo);

                        // 1. 加载商务应答
                        if (typeof loadFileInfo === 'function') {
                            console.log('[HITLConfigManager] 加载应答文件信息...');
                            await loadFileInfo('response', hitlTask.hitl_task_id);
                        } else {
                            console.error('[HITLConfigManager] loadFileInfo函数未定义，无法加载应答文件');
                        }

                        // 2. 加载技术需求文件
                        if (typeof loadFileInfo === 'function') {
                            console.log('[HITLConfigManager] 加载技术需求文件...');
                            await loadFileInfo('technical', hitlTask.hitl_task_id);
                        } else {
                            console.error('[HITLConfigManager] loadFileInfo函数未定义，无法加载技术需求文件');
                        }

                        // 2.5. 加载点对点应答完成文件
                        if (typeof loadFileInfo === 'function') {
                            console.log('[HITLConfigManager] 加载点对点应答文件...');
                            await loadFileInfo('point_to_point', hitlTask.hitl_task_id);
                        } else {
                            console.error('[HITLConfigManager] loadFileInfo函数未定义，无法加载点对点应答文件');
                        }

                        // 2.6. 加载技术方案完成文件
                        if (typeof loadFileInfo === 'function') {
                            console.log('[HITLConfigManager] 加载技术方案文件...');
                            await loadFileInfo('tech_proposal', hitlTask.hitl_task_id);
                        } else {
                            console.error('[HITLConfigManager] loadFileInfo函数未定义，无法加载技术方案文件');
                        }

                        // 2.7. 加载商务应答完成文件
                        if (typeof loadFileInfo === 'function') {
                            console.log('[HITLConfigManager] 加载商务应答文件...');
                            await loadFileInfo('business_response', hitlTask.hitl_task_id);
                        } else {
                            console.error('[HITLConfigManager] loadFileInfo函数未定义，无法加载商务应答文件');
                        }

                        // 3. 加载资格要求（qualifications）
                        if (typeof loadRequirements === 'function') {
                            console.log('[HITLConfigManager] 加载资格要求...');
                            await loadRequirements(hitlTask.hitl_task_id, projectId);
                        }

                        // 4. 加载筛选后的段落
                        if (typeof loadFilteredChunksData === 'function') {
                            console.log('[HITLConfigManager] 加载筛选段落...');
                            await loadFilteredChunksData(hitlTask.hitl_task_id);
                        }

                        console.log('[HITLConfigManager] HITL任务数据加载完成');
                    } else {
                        console.log('[HITLConfigManager] 该项目没有HITL任务');
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] 加载HITL任务数据失败:', error);
                }
            },

            // 【新增】显示已上传的文件
            displayUploadedFile(fileName, filePath) {
                console.log('[HITLConfigManager] 显示已上传文件:', fileName);

                // 查找文件上传区域的元素
                const uploadSection = document.querySelector('.file-upload-section');
                const fileInput = document.getElementById('hitlFileInput');

                if (uploadSection) {
                    // 创建文件显示元素
                    let fileDisplay = uploadSection.querySelector('.uploaded-file-display');

                    if (!fileDisplay) {
                        fileDisplay = document.createElement('div');
                        fileDisplay.className = 'uploaded-file-display alert alert-success d-flex align-items-center justify-content-between';
                        fileDisplay.innerHTML = `
                            <div class="d-flex align-items-center">
                                <i class="bi bi-file-earmark-text-fill me-2"></i>
                                <span class="file-name"></span>
                            </div>
                            <span class="badge bg-success">已上传</span>
                        `;

                        // 插入到文件输入框之后
                        if (fileInput && fileInput.parentNode) {
                            fileInput.parentNode.insertBefore(fileDisplay, fileInput.nextSibling);
                        } else {
                            uploadSection.appendChild(fileDisplay);
                        }
                    }

                    // 更新文件名
                    const fileNameSpan = fileDisplay.querySelector('.file-name');
                    if (fileNameSpan) {
                        fileNameSpan.textContent = fileName;
                    }

                    fileDisplay.style.display = 'flex';

                    // 隐藏文件输入框（因为已经有文件了）
                    if (fileInput) {
                        fileInput.style.display = 'none';
                    }

                    console.log('[HITLConfigManager] 文件显示已更新');
                }
            },

            // 更新模型选择器
            updateModelSelect(models) {
                const select = document.getElementById('hitlAiModel');
                if (!select) return;

                const currentValue = select.value;

                // 保持现有选项但更新状态
                Array.from(select.options).forEach(option => {
                    const model = models.find(m => m.name === option.value);
                    if (model) {
                        const baseText = option.textContent.replace(' ✓', '').replace(' (未配置)', '');
                        if (model.status === 'available') {
                            option.textContent = baseText + ' ✓';
                            option.disabled = false;
                        } else if (model.status === 'no_api_key') {
                            option.textContent = baseText + ' (未配置)';
                            option.disabled = true;
                        }
                    }
                });

                // 恢复选择
                if (currentValue) {
                    select.value = currentValue;
                }

                this.updateModelStatus();
            },

            // 更新模型状态显示
            updateModelStatus() {
                const select = document.getElementById('hitlAiModel');
                const statusDiv = document.getElementById('hitlModelStatus');
                const icon = document.getElementById('hitlModelStatusIcon');
                const text = document.getElementById('hitlModelStatusText');

                if (!select || !statusDiv) return;

                const selectedValue = select.value;

                if (selectedValue) {
                    statusDiv.style.display = 'block';
                    icon.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
                    text.textContent = '模型可用';
                    text.className = 'text-success';
                } else {
                    statusDiv.style.display = 'none';
                }
            },

            // 绑定事件
            bindEvents() {
                // 公司选择变化
                const companySelect = document.getElementById('hitlCompanySelect');
                if (companySelect) {
                    companySelect.addEventListener('change', (e) => {
                        this.currentCompanyId = e.target.value;
                        const nameSpan = document.getElementById('hitlSelectedCompanyName');
                        const selectedText = e.target.options[e.target.selectedIndex].text;
                        nameSpan.textContent = e.target.value ? selectedText : '未选择';
                        nameSpan.className = e.target.value ? 'text-primary fw-bold' : 'text-muted';

                        console.log(`[HITLConfigManager] 选择公司: ${selectedText} (ID: ${e.target.value})`);

                        // 重新加载项目列表
                        if (this.currentCompanyId) {
                            this.loadProjects();
                        }
                    });
                }

                // 模型选择变化
                const modelSelect = document.getElementById('hitlAiModel');
                if (modelSelect) {
                    modelSelect.addEventListener('change', (e) => {
                        this.currentModel = e.target.value;
                        this.updateModelStatus();
                        console.log(`[HITLConfigManager] 选择模型: ${e.target.value}`);
                    });
                }

                // 项目选择变化
                const projectSelect = document.getElementById('hitlProjectSelect');
                if (projectSelect) {
                    projectSelect.addEventListener('change', async (e) => {
                        this.selectedProjectId = e.target.value || null;
                        this.currentProjectId = this.selectedProjectId;

                        console.log(`[HITLConfigManager] 项目选择变更: ${this.selectedProjectId}`);

                        if (this.selectedProjectId) {
                            // 加载项目详情
                            await this.loadProjectDetails(this.selectedProjectId);

                            // 【新增】自动跳转到步骤3，让用户可以看到加载的数据
                            this.navigateToStep3();
                        } else {
                            // 选择"新建项目",清空表单
                            const projectInfo = document.getElementById('hitlProjectInfo');
                            if (projectInfo) projectInfo.style.display = 'none';

                            // 清空基本信息表单
                            ['projectName', 'projectNumber', 'tenderParty', 'tenderAgent',
                             'tenderMethod', 'tenderLocation', 'tenderDeadline', 'winnerCount'].forEach(id => {
                                const el = document.getElementById(id);
                                if (el) el.value = '';
                            });
                        }
                    });
                    console.log('[HITLConfigManager] 项目选择器事件已绑定');
                }

                // 刷新项目按钮
                const refreshBtn = document.getElementById('refreshHitlProjectsBtn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        console.log('[HITLConfigManager] 刷新项目列表');
                        this.loadProjects();
                    });
                    console.log('[HITLConfigManager] 刷新按钮事件已绑定');
                }
            },

            // 获取当前配置（供其他模块使用）
            getConfig() {
                return {
                    companyId: this.currentCompanyId,
                    model: this.currentModel,
                    projectId: this.currentProjectId  // 使用当前项目ID而非表单输入
                };
            },

            // 【新增】导航到步骤3
            navigateToStep3() {
                console.log('[HITLConfigManager] 导航到步骤3');

                // 隐藏步骤1和步骤2
                const step1Section = document.getElementById('chapterSelectionSection');
                const step2Section = document.getElementById('step2Section');
                const step3Section = document.getElementById('step3Section');

                if (step1Section) step1Section.style.display = 'none';
                if (step2Section) step2Section.style.display = 'none';
                if (step3Section) {
                    step3Section.style.display = 'block';
                    console.log('[HITLConfigManager] 已显示步骤3');
                }

                // 滚动到页面顶部，让用户看到步骤3
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        };

        // 全局函数（供HTML调用）
        function onHitlModelChange() {
            HITLConfigManager.updateModelStatus();
        }

        function refreshHitlModels() {
            HITLConfigManager.loadModels();
        }

        /**
         * 初始化模型选择器
         * - 从localStorage读取上次选择的模型
         * - 如果没有，默认选择 yuanjing-deepseek-v3（更适合智能提取）
         * - 保存用户选择到localStorage
         */
        function initModelSelector() {
            const modelSelect = document.getElementById('hitlAiModel');
            if (!modelSelect) {
                console.warn('[initModelSelector] 未找到模型选择器');
                return;
            }

            // 从localStorage读取上次选择
            const STORAGE_KEY = 'hitl_selected_model';
            let savedModel = localStorage.getItem(STORAGE_KEY);

            // 如果没有保存的选择，使用智能默认值（DeepSeek-V3更适合提取任务）
            if (!savedModel) {
                savedModel = 'yuanjing-deepseek-v3';
                console.log('[initModelSelector] 首次使用，默认选择:', savedModel);
            } else {
                console.log('[initModelSelector] 恢复上次选择:', savedModel);
            }

            // 设置选中状态
            modelSelect.value = savedModel;

            // 监听变化，保存到localStorage
            modelSelect.addEventListener('change', function() {
                const selectedModel = this.value;
                localStorage.setItem(STORAGE_KEY, selectedModel);
                console.log('[initModelSelector] 模型已更改并保存:', selectedModel);
            });

            // 触发一次change事件，更新模型状态显示
            if (typeof onHitlModelChange === 'function') {
                onHitlModelChange();
            }
        }

        // 页面加载时初始化（使用已存在的DOMContentLoaded事件）
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[HITL] 初始化配置管理器');
            HITLConfigManager.init();

            // 初始化AI模型选择器
            initModelSelector();

            // Tab数据已在选择项目时自动加载，无需监听tab切换事件
        });

        /**
         * 跳转到点对点应答页面
         * 支持两种模式:
         * 1. 如果在首页(有 projectDataBridge),使用 Tab 切换 + 全局状态传递
         * 2. 如果在独立 HITL 页面,使用 URL 参数跳转(向后兼容)
         */
        async function goToPointToPoint() {
            // 获取当前项目和公司信息
            const projectName = window.currentProjectName || '';
            const companyId = window.currentCompanyId || '';
            const companyName = window.currentCompanyName || '';
            const hitlTaskId = window.currentHitlTaskId || '';

            console.log('[goToPointToPoint] 跳转参数:', { projectName, companyId, companyName, hitlTaskId });

            // 检测是否在首页环境(有 projectDataBridge)
            const isInIndexPage = typeof window.projectDataBridge !== 'undefined';

            if (isInIndexPage) {
                // 模式 1: Tab 切换模式 (首页内)
                console.log('[goToPointToPoint] 使用 Tab 切换模式');

                // 设置全局状态
                window.projectDataBridge.setCompanyProject(companyId, companyName, null, projectName);
                window.projectDataBridge.hitlTaskId = hitlTaskId;

                // 获取技术需求文件信息
                if (hitlTaskId) {
                    try {
                        const response = await fetch(`/api/tender-processing/technical-file-info/${hitlTaskId}`);
                        const data = await response.json();

                        if (data.success && data.has_file) {
                            // 设置到全局状态
                            window.projectDataBridge.setTechnicalFile(
                                hitlTaskId,
                                data.filename,
                                data.file_size,
                                data.download_url
                            );
                            console.log('[goToPointToPoint] 技术需求文件信息已设置到全局状态');
                        }
                    } catch (error) {
                        console.error('[goToPointToPoint] 获取技术需求文件信息失败:', error);
                    }
                }

                // 切换到点对点应答 Tab
                const pointToPointTab = document.querySelector('[data-bs-target="#point-to-point"]');
                if (pointToPointTab) {
                    const tab = new bootstrap.Tab(pointToPointTab);
                    tab.show();

                    // 触发自定义事件通知点对点组件加载数据
                    window.dispatchEvent(new CustomEvent('loadPointToPoint', {
                        detail: {
                            fromHITL: true,
                            taskId: hitlTaskId
                        }
                    }));

                    console.log('[goToPointToPoint] 已切换到点对点应答 Tab');
                } else {
                    console.error('[goToPointToPoint] 未找到点对点应答 Tab');
                }
            } else {
                // 模式 2: URL 参数跳转模式 (独立 HITL 页面)
                console.log('[goToPointToPoint] 使用 URL 参数跳转模式');

                // 构建URL参数
                const params = new URLSearchParams();
                if (projectName) params.append('project_name', projectName);
                if (companyId) params.append('company_id', companyId);
                if (companyName) params.append('company_name', companyName);
                if (hitlTaskId) params.append('hitl_task_id', hitlTaskId);

                // 获取技术需求文件信息
                if (hitlTaskId) {
                    try {
                        const response = await fetch(`/api/tender-processing/technical-file-info/${hitlTaskId}`);
                        const data = await response.json();

                        if (data.success && data.has_file) {
                            // 将技术需求文件信息添加到URL参数
                            params.append('technical_file_name', data.filename);
                            params.append('technical_file_size', data.file_size);
                            params.append('technical_file_url', data.download_url);
                            console.log('[goToPointToPoint] 已获取技术需求文件信息:', data);
                        }
                    } catch (error) {
                        console.error('[goToPointToPoint] 获取技术需求文件信息失败:', error);
                    }
                }

                // 跳转到首页的点对点应答标签页
                window.location.href = `/?${params.toString()}#point-to-point`;
            }
        }

        /**
         * 跳转到技术方案编写页面
         * 支持两种模式:
         * 1. 如果在首页(有 projectDataBridge),使用 Tab 切换 + 全局状态传递
         * 2. 如果在独立 HITL 页面,使用 URL 参数跳转(向后兼容)
         */
        async function goToTechProposal() {
            // 获取当前项目和公司信息
            const projectName = window.currentProjectName || '';
            const companyId = window.currentCompanyId || '';
            const companyName = window.currentCompanyName || '';
            const hitlTaskId = window.currentHitlTaskId || '';

            console.log('[goToTechProposal] 跳转参数:', { projectName, companyId, companyName, hitlTaskId });

            // 检测是否在首页环境(有 projectDataBridge)
            const isInIndexPage = typeof window.projectDataBridge !== 'undefined';

            if (isInIndexPage) {
                // 模式 1: Tab 切换模式 (首页内)
                console.log('[goToTechProposal] 使用 Tab 切换模式');

                // 设置全局状态
                window.projectDataBridge.setCompanyProject(companyId, companyName, null, projectName);
                window.projectDataBridge.hitlTaskId = hitlTaskId;

                // 获取技术需求文件信息
                if (hitlTaskId) {
                    try {
                        const response = await fetch(`/api/tender-processing/technical-file-info/${hitlTaskId}`);
                        const data = await response.json();

                        if (data.success && data.has_file) {
                            // 设置到全局状态
                            window.projectDataBridge.setTechnicalFile(
                                hitlTaskId,
                                data.filename,
                                data.file_size,
                                data.download_url
                            );
                            console.log('[goToTechProposal] 技术需求文件信息已设置到全局状态');
                        }
                    } catch (error) {
                        console.error('[goToTechProposal] 获取技术需求文件信息失败:', error);
                    }
                }

                // 切换到技术方案 Tab
                const techProposalTab = document.querySelector('[data-bs-target="#tech-proposal"]');
                if (techProposalTab) {
                    const tab = new bootstrap.Tab(techProposalTab);
                    tab.show();

                    // 触发自定义事件通知技术方案组件加载数据
                    window.dispatchEvent(new CustomEvent('loadTechnicalProposal', {
                        detail: {
                            fromHITL: true,
                            taskId: hitlTaskId
                        }
                    }));

                    console.log('[goToTechProposal] 已切换到技术方案 Tab');
                } else {
                    console.error('[goToTechProposal] 未找到技术方案 Tab');
                }
            } else {
                // 模式 2: URL 参数跳转模式 (独立 HITL 页面)
                console.log('[goToTechProposal] 使用 URL 参数跳转模式');

                // 构建URL参数
                const params = new URLSearchParams();
                if (projectName) params.append('project_name', projectName);
                if (companyId) params.append('company_id', companyId);
                if (companyName) params.append('company_name', companyName);
                if (hitlTaskId) params.append('hitl_task_id', hitlTaskId);

                // 获取技术需求文件信息
                if (hitlTaskId) {
                    try {
                        const response = await fetch(`/api/tender-processing/technical-file-info/${hitlTaskId}`);
                        const data = await response.json();

                        if (data.success && data.has_file) {
                            // 将技术需求文件信息添加到URL参数
                            params.append('technical_file_name', data.filename);
                            params.append('technical_file_size', data.file_size);
                            params.append('technical_file_url', data.download_url);
                            console.log('[goToTechProposal] 已获取技术需求文件信息:', data);
                        }
                    } catch (error) {
                        console.error('[goToTechProposal] 获取技术需求文件信息失败:', error);
                    }
                }

                // 跳转到首页的技术方案生成标签页
                window.location.href = `/?${params.toString()}#tech-proposal`;
            }
        }
    </script>

    <!-- JSZip - docx-preview依赖 -->
    <script src="/static/vendor/jszip/jszip.min.js"></script>
    <!-- Docx-Preview - Word文档预览（保留原始格式） -->
    <script src="/static/vendor/docx-preview/docx-preview.min.js"></script>

    <!-- 文档预览模态框 -->
    <div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentPreviewModalLabel">
                        <i class="bi bi-eye"></i> 文档预览
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="documentPreviewContent" style="min-height: 500px; padding: 20px; background: white;">
                        <!-- 预览内容将在这里显示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 章节选择模态框（用于商务应答） -->
    <div class="modal fade" id="chapterSelectionModal" tabindex="-1" aria-labelledby="chapterSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chapterSelectionModalLabel">
                        <i class="bi bi-list-nested me-2"></i>选择章节作为商务应答
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 统计信息 -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body text-center py-2">
                                    <small class="text-muted">总章节数</small>
                                    <h5 class="mb-0" id="modalStatTotalChapters">0</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center py-2">
                                    <small>已选择</small>
                                    <h5 class="mb-0" id="modalStatSelectedChapters">0</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center py-2">
                                    <small>选中字数</small>
                                    <h5 class="mb-0" id="modalStatSelectedWords">0</h5>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 批量操作 -->
                    <div class="mb-3">
                        <button class="btn btn-sm btn-outline-primary" id="modalSelectAllBtn">
                            <i class="bi bi-check-all"></i> 全选
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="modalUnselectAllBtn">
                            <i class="bi bi-x"></i> 全不选
                        </button>
                        <button class="btn btn-sm btn-outline-success" id="modalSelectTechBtn">
                            <i class="bi bi-cpu"></i> 仅选技术章节
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="modalExcludeContractBtn">
                            <i class="bi bi-file-x"></i> 排除合同条款
                        </button>
                    </div>

                    <!-- 章节树容器 -->
                    <div id="modalChapterTreeContainer" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; background: #f8f9fa;">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-folder2-open" style="font-size: 3rem;"></i>
                            <p class="mt-3">正在加载章节...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="confirmSaveResponseFileBtn">
                        <i class="bi bi-check-circle me-2"></i>确认保存为应答文件
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
