<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ‡ä¹¦æ™ºèƒ½å¤„ç† - HITLæµç¨‹ - AIæ ‡ä¹¦ç³»ç»Ÿ</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/tender-processing-hitl.css">

    <!-- æ­¥éª¤3å¢å¼ºç‰ˆæ ·å¼ -->
    <link rel="stylesheet" href="/static/css/tender-processing-step3-enhanced.css">

    <style>
        body {
            background-color: #f5f5f5;
            padding-top: 70px;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }

        /* ç©ºç™½çŠ¶æ€æ ·å¼ */
        .empty-state {
            text-align: center;
            padding: 120px 40px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            min-height: 450px;
        }

        .empty-state i {
            display: block;
            opacity: 0.4;
            margin-bottom: 20px;
        }

        .empty-state h5 {
            margin: 15px 0 10px 0;
            font-weight: 600;
            color: #6c757d;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.95rem;
            color: #adb5bd;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-file-earmark-text me-2"></i>AIæ ‡ä¹¦ç³»ç»Ÿ
            </a>
            <div class="d-flex align-items-center">
                <a href="/" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-house"></i> é¦–é¡µ
                </a>
                <a href="/knowledge_base" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-database"></i> çŸ¥è¯†åº“
                </a>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="container-fluid" style="max-width: 1400px;">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="section-card">
            <h2>
                <i class="bi bi-magic text-primary me-2"></i>æ ‡ä¹¦æ™ºèƒ½å¤„ç† - äººå·¥ç¡®è®¤æµç¨‹
            </h2>
            <p class="text-muted mb-0">
                ä¸¤æ­¥æ™ºèƒ½å¤„ç†ï¼š<strong>ç« èŠ‚é€‰æ‹©</strong> â†’ <strong>ä¿¡æ¯æå–ä¸ç¼–è¾‘</strong>
            </p>
        </div>

        <!-- é¡¹ç›®å’Œæ¨¡å‹é…ç½®åŒºåŸŸ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-gear"></i> é…ç½®ä¿¡æ¯
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- é¡¹ç›®IDè¾“å…¥ -->
                            <div class="col-md-4">
                                <label for="projectId" class="form-label">
                                    <i class="bi bi-folder2"></i> é¡¹ç›®ID <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="projectId" placeholder="è¾“å…¥é¡¹ç›®ID" value="1">
                                <small class="text-muted">ç”¨äºå…³è”æ­¤æ¬¡å¤„ç†ä»»åŠ¡</small>
                            </div>

                            <!-- å…¬å¸é€‰æ‹© -->
                            <div class="col-md-4">
                                <label for="hitlCompanySelect" class="form-label">
                                    <i class="bi bi-building"></i> åº”ç­”å…¬å¸ <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <select class="form-select" id="hitlCompanySelect" required>
                                        <option value="">è¯·é€‰æ‹©å…¬å¸...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="window.location.href='/knowledge_base?action=company_management';" title="ç®¡ç†å…¬å¸">
                                        <i class="bi bi-building"></i>
                                    </button>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">å½“å‰ï¼š</small>
                                    <span id="hitlSelectedCompanyName" class="text-muted">æœªé€‰æ‹©</span>
                                </div>
                            </div>

                            <!-- AIæ¨¡å‹é€‰æ‹© -->
                            <div class="col-md-4">
                                <label for="hitlAiModel" class="form-label">
                                    <i class="bi bi-cpu"></i> AIæ¨¡å‹ <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <select class="form-select" id="hitlAiModel" onchange="onHitlModelChange()">
                                        <optgroup label="OpenAIï¼ˆæ¨èï¼‰">
                                            <option value="gpt-4o-mini">GPT-4O Mini âœ“</option>
                                            <option value="gpt-4o">GPT-4O</option>
                                        </optgroup>
                                        <optgroup label="è”é€šå…ƒæ™¯">
                                            <option value="yuanjing-deepseek-v3">DeepSeek-V3ï¼ˆæ™ºèƒ½æå–ï¼‰ âœ“</option>
                                            <option value="yuanjing-pro">å…ƒæ™¯ä¸“ä¸šç‰ˆ</option>
                                        </optgroup>
                                    </select>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshHitlModels()" title="åˆ·æ–°æ¨¡å‹åˆ—è¡¨">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <!-- æ¨¡å‹çŠ¶æ€æ˜¾ç¤º -->
                                <div class="mt-1" id="hitlModelStatus" style="display: none;">
                                    <small class="d-flex align-items-center">
                                        <span id="hitlModelStatusIcon" class="me-1"></span>
                                        <span id="hitlModelStatusText"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="step-indicator">
            <div class="step active" id="stepIndicator1">
                <div class="step-number">1</div>
                <div class="step-label">ç« èŠ‚é€‰æ‹©</div>
            </div>
            <!-- æ­¥éª¤2å·²éšè— -->
            <div class="step" id="stepIndicator3">
                <div class="step-number">2</div>
                <div class="step-label">ä¿¡æ¯æå–ä¸ç¼–è¾‘</div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- ä¸Šä¼ æ–‡ä»¶åŒºåŸŸ -->
        <!-- ==================== -->
        <div id="uploadSection" class="section-card">
            <h4 class="section-title">
                <i class="bi bi-upload me-2"></i>ä¸Šä¼ æ ‡ä¹¦æ–‡æ¡£
            </h4>

            <div class="row">
                <div class="col-12">
                    <label for="tenderDocFile" class="form-label">æ ‡ä¹¦æ–‡æ¡£ <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="tenderDocFile" accept=".docx,.doc">
                    <small class="text-muted">æ”¯æŒ .docx å’Œ .doc æ ¼å¼</small>
                </div>
            </div>

            <div class="mt-3">
                <button class="btn btn-primary" id="parseStructureBtn">
                    <i class="bi bi-file-earmark-code me-2"></i>è§£ææ–‡æ¡£ç»“æ„
                </button>
            </div>
        </div>

        <!-- ==================== -->
        <!-- æ­¥éª¤1ï¼šç« èŠ‚é€‰æ‹© -->
        <!-- ==================== -->
        <div id="chapterSelectionSection" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-list-nested me-2"></i>æ­¥éª¤1ï¼šé€‰æ‹©éœ€è¦å¤„ç†çš„ç« èŠ‚
            </h4>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">æ€»ç« èŠ‚æ•°</div>
                    <div class="stat-value" id="statTotalChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å·²é€‰æ‹©</div>
                    <div class="stat-value text-success" id="statSelectedChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">é€‰ä¸­å­—æ•°</div>
                    <div class="stat-value text-info" id="statSelectedWords">0</div>
                </div>
            </div>

            <!-- æ‰¹é‡æ“ä½œ -->
            <div class="batch-operations">
                <button class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                    <i class="bi bi-check-all"></i> å…¨é€‰
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="unselectAllBtn">
                    <i class="bi bi-x"></i> å…¨ä¸é€‰
                </button>
                <button class="btn btn-sm btn-outline-success" id="selectTechBtn">
                    <i class="bi bi-cpu"></i> ä»…é€‰æŠ€æœ¯ç« èŠ‚
                </button>
                <button class="btn btn-sm btn-outline-danger" id="excludeContractBtn">
                    <i class="bi bi-file-x"></i> æ’é™¤åˆåŒæ¡æ¬¾
                </button>
            </div>

            <div class="row">
                <!-- å·¦ä¾§ï¼šç« èŠ‚æ ‘ -->
                <div class="col-md-8">
                    <div class="chapter-search mb-3">
                        <input type="text"
                               class="form-control"
                               id="chapterSearch"
                               placeholder="ğŸ” æœç´¢ç« èŠ‚...">
                    </div>

                    <div class="chapter-tree-container" id="chapterTreeContainer">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-folder2-open" style="font-size: 3rem;"></i>
                            <p class="mt-3">ç­‰å¾…æ–‡æ¡£è§£æ...</p>
                        </div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šé¢„è§ˆåŒº -->
                <div class="col-md-4">
                    <h6 class="mb-3">ç« èŠ‚é¢„è§ˆ</h6>
                    <div id="chapterPreview">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-eye" style="font-size: 3rem;"></i>
                            <p class="mt-3">ç‚¹å‡»"é¢„è§ˆ"æŒ‰é’®æŸ¥çœ‹ç« èŠ‚å†…å®¹</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¡®è®¤æŒ‰é’® -->
            <div class="mt-4 text-center">
                <button class="btn btn-primary btn-lg me-3" id="exportSelectedChaptersBtn" disabled>
                    <i class="bi bi-download me-2"></i>å¯¼å‡ºé€‰ä¸­ç« èŠ‚
                </button>
                <button class="btn btn-info btn-lg me-3" id="saveAsResponseFileBtn" disabled>
                    <i class="bi bi-file-earmark-arrow-down me-2"></i>å¦å­˜ä¸ºåº”ç­”æ–‡ä»¶
                </button>
                <button class="btn btn-success btn-lg" id="confirmSelectionBtn">
                    <i class="bi bi-check-circle me-2"></i>ç¡®è®¤é€‰æ‹©å¹¶ç»§ç»­
                </button>
            </div>

            <!-- å®Œæˆæ¶ˆæ¯ -->
            <div id="step1CompleteMessage" style="display: none;"></div>
        </div>

        <!-- ==================== -->
        <!-- æ­¥éª¤2ï¼šç« èŠ‚è¦æ±‚é¢„è§ˆ -->
        <!-- ==================== -->
        <div id="step2Section" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-list-check me-2"></i>æ­¥éª¤2ï¼šç« èŠ‚è¦æ±‚é¢„è§ˆ
            </h4>

            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                AIå·²ä»é€‰ä¸­çš„ç« èŠ‚ä¸­æå–è¦æ±‚ã€‚æ‚¨å¯ä»¥æŸ¥çœ‹æ¯ä¸ªç« èŠ‚çš„è¦æ±‚æ•°é‡ï¼Œå–æ¶ˆä¸éœ€è¦çš„ç« èŠ‚ã€‚
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-label">æ€»ç« èŠ‚æ•°</div>
                    <div class="stat-value" id="statTotalChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">å·²é€‰ç« èŠ‚</div>
                    <div class="stat-value text-success" id="statSelectedChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">æå–è¦æ±‚æ•°</div>
                    <div class="stat-value text-primary" id="statTotalRequirementsStep2">0</div>
                </div>
            </div>

            <!-- ç« èŠ‚åˆ—è¡¨ -->
            <div id="chapterRequirementsContainer" style="max-height: 600px; overflow-y: auto;">
                <div class="text-center text-muted py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">æ­£åœ¨åŠ è½½ç« èŠ‚æ•°æ®...</p>
                </div>
            </div>

            <!-- ç¡®è®¤ç»§ç»­æŒ‰é’® -->
            <div class="mt-4 text-center">
                <button class="btn btn-success btn-lg" id="confirmStep2Btn">
                    <i class="bi bi-arrow-right me-2"></i>ç¡®è®¤å¹¶ç»§ç»­æ­¥éª¤3
                </button>
            </div>
        </div>

        <!-- ==================== -->
        <!-- æ­¥éª¤3ï¼šç»¼åˆä¿¡æ¯æå–ä¸ç¼–è¾‘ -->
        <!-- ==================== -->
        <div id="step3Section" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-clipboard-data me-2"></i>æ­¥éª¤3ï¼šä¿¡æ¯æå–ä¸ç¼–è¾‘
            </h4>

            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹å’Œç¼–è¾‘<strong>åŸºæœ¬ä¿¡æ¯</strong>ã€<strong>èµ„è´¨è¦æ±‚</strong>ã€<strong>èµ„æ ¼è¦æ±‚</strong>ã€<strong>è¯„åˆ†åŠæ³•</strong>ã€<strong>æŠ€æœ¯éœ€æ±‚</strong>å’Œ<strong>åº”ç­”æ–‡ä»¶æ ¼å¼</strong>ã€‚AIå·²è‡ªåŠ¨æå–è¿™äº›ä¿¡æ¯ï¼Œæ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ­£ã€‚
            </div>

            <!-- Tabå¯¼èˆª -->
            <ul class="nav nav-tabs mb-4" id="step3Tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basicInfoPanel" type="button" role="tab">
                        <i class="bi bi-info-circle me-2"></i>åŸºæœ¬ä¿¡æ¯
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="qualifications-tab" data-bs-toggle="tab" data-bs-target="#qualificationsPanel" type="button" role="tab">
                        <i class="bi bi-award me-2"></i>èµ„è´¨è¦æ±‚
                        <span class="badge bg-primary ms-1" id="qualBadge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="eligibility-tab" data-bs-toggle="tab" data-bs-target="#eligibilityPanel" type="button" role="tab">
                        <i class="bi bi-person-check me-2"></i>èµ„æ ¼è¦æ±‚
                        <span class="badge bg-success ms-1" id="eligBadge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="scoring-tab" data-bs-toggle="tab" data-bs-target="#scoringPanel" type="button" role="tab">
                        <i class="bi bi-graph-up me-2"></i>è¯„åˆ†åŠæ³•
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technicalPanel" type="button" role="tab">
                        <i class="bi bi-gear me-2"></i>æŠ€æœ¯éœ€æ±‚
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="document-format-tab" data-bs-toggle="tab" data-bs-target="#documentFormatPanel" type="button" role="tab">
                        <i class="bi bi-file-earmark-text me-2"></i>åº”ç­”æ–‡ä»¶æ ¼å¼
                    </button>
                </li>
            </ul>

            <!-- Tabå†…å®¹ -->
            <div class="tab-content" id="step3TabContent">
                <!-- ==================== -->
                <!-- Tab 1: åŸºæœ¬ä¿¡æ¯ -->
                <!-- ==================== -->
                <div class="tab-pane fade show active" id="basicInfoPanel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>é¡¹ç›®åŸºæœ¬ä¿¡æ¯</h5>
                        <button class="btn btn-sm btn-outline-primary" id="extractBasicInfoBtn">
                            <i class="bi bi-magic me-2"></i>AIæå–åŸºæœ¬ä¿¡æ¯
                        </button>
                    </div>

                    <div id="basicInfoLoading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3 text-muted">æ­£åœ¨æå–åŸºæœ¬ä¿¡æ¯...</p>
                    </div>

                    <form id="basicInfoForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="projectName" class="form-label">é¡¹ç›®åç§°</label>
                                <input type="text" class="form-control" id="projectName" name="project_name">
                            </div>
                            <div class="col-md-6">
                                <label for="projectNumber" class="form-label">é¡¹ç›®ç¼–å·</label>
                                <input type="text" class="form-control" id="projectNumber" name="project_number">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderParty" class="form-label">æ‹›æ ‡äºº</label>
                                <input type="text" class="form-control" id="tenderParty" name="tender_party">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderAgent" class="form-label">æ‹›æ ‡ä»£ç†</label>
                                <input type="text" class="form-control" id="tenderAgent" name="tender_agent">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderMethod" class="form-label">æŠ•æ ‡æ–¹å¼</label>
                                <input type="text" class="form-control" id="tenderMethod" name="tender_method">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderLocation" class="form-label">æŠ•æ ‡åœ°ç‚¹</label>
                                <input type="text" class="form-control" id="tenderLocation" name="tender_location">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderDeadline" class="form-label">æŠ•æ ‡æ—¶é—´</label>
                                <input type="text" class="form-control" id="tenderDeadline" name="tender_deadline">
                            </div>
                            <div class="col-md-6">
                                <label for="winnerCount" class="form-label">ä¸­æ ‡äººæ•°é‡</label>
                                <input type="text" class="form-control" id="winnerCount" name="winner_count">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- ==================== -->
                <!-- Tab 2: èµ„è´¨è¦æ±‚ -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="qualificationsPanel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>èµ„è´¨è¦æ±‚åŒ¹é…</h5>
                        <button class="btn btn-sm btn-outline-success" id="extractQualificationsBtn">
                            <i class="bi bi-magic me-2"></i>AIæå–èµ„è´¨è¦æ±‚
                        </button>
                    </div>

                    <div id="qualificationsLoading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="mt-3 text-muted">æ­£åœ¨æå–èµ„è´¨è¦æ±‚...</p>
                    </div>

                    <!-- èµ„è´¨åŒ¹é…æ±‡æ€» -->
                    <div class="stats-grid mb-4" id="qualificationSummary" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-label">è¦æ±‚æ€»æ•°</div>
                            <div class="stat-value" id="qualRequiredCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">å·²ä¸Šä¼ </div>
                            <div class="stat-value text-success" id="qualUploadedCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">ç¼ºå¤±</div>
                            <div class="stat-value text-danger" id="qualMissingCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">åŒ¹é…åº¦</div>
                            <div class="stat-value text-primary" id="qualMatchRate">0%</div>
                        </div>
                    </div>

                    <!-- èµ„è´¨è¯¦ç»†åˆ—è¡¨ -->
                    <div id="qualificationsContainer">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-award" style="font-size: 3rem;"></i>
                            <p class="mt-3">ç‚¹å‡»"AIæå–èµ„è´¨è¦æ±‚"æŒ‰é’®å¼€å§‹æå–</p>
                        </div>
                    </div>
                </div>

                <!-- ==================== -->
                <!-- Tab 3: èµ„æ ¼è¦æ±‚ -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="eligibilityPanel" role="tabpanel">
                    <!-- AIæå–æŒ‰é’®åŒºåŸŸ -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">èµ„æ ¼è¦æ±‚</h5>
                        <button class="btn btn-primary" id="extractRequirementsBtn">
                            <i class="fas fa-magic me-2"></i>AIæå–èµ„æ ¼è¦æ±‚
                        </button>
                    </div>

                    <!-- æå–è¿›åº¦æç¤º -->
                    <div id="requirementsExtractionProgress" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                            <div>
                                <strong>AIæ­£åœ¨æå–è¦æ±‚...</strong>
                                <p class="mb-0 small">è¿™å¯èƒ½éœ€è¦40-60ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…</p>
                            </div>
                        </div>
                    </div>

                    <!-- ç©ºçŠ¶æ€æç¤º -->
                    <div id="eligibilityEmptyState" class="alert alert-light border text-center py-5">
                        <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">å°šæœªæå–ä¾›åº”å•†èµ„æ ¼è¦æ±‚</h5>
                        <p class="text-muted mb-3">ç‚¹å‡»ä¸Šæ–¹çš„"AIæå–èµ„æ ¼è¦æ±‚"æŒ‰é’®å¼€å§‹æ™ºèƒ½æå–</p>
                        <p class="small text-muted mb-0">
                            æå–èŒƒå›´ï¼šæ‚¨åœ¨æ­¥éª¤1ä¸­é€‰ä¸­çš„ç« èŠ‚<br>
                            æå–å†…å®¹ï¼šè¥ä¸šæ‰§ç…§ã€è´¢åŠ¡ã€çº³ç¨ã€ç¤¾ä¿ç­‰13æ¡ä¾›åº”å•†èµ„æ ¼è¦æ±‚
                        </p>
                    </div>

                    <!-- 13æ¡èµ„æ ¼è¦æ±‚æ¸…å•å®¹å™¨ -->
                    <div id="eligibilityChecklistContainer" style="display: none;">
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0"><span id="eligFoundCount">0</span> æ¡</h2>
                                        <div class="small">å·²æ‰¾åˆ°</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0"><span id="eligNotFoundCount">13</span> æ¡</h2>
                                        <div class="small">æœªæ‰¾åˆ°</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ¸…å•æ˜¾ç¤ºåŒºåŸŸ -->
                        <div id="eligibilityChecklistItems">
                            <!-- è¿™é‡Œå°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ13æ¡æ¸…å• -->
                        </div>
                    </div>

                    <!-- è¦æ±‚è¡¨æ ¼å®¹å™¨ -->
                    <div id="requirementsTableContainer" style="display: none;">
                        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                        <div class="stats-grid mb-4">
                            <div class="stat-card">
                                <div class="stat-label">æ€»è¦æ±‚æ•°</div>
                                <div class="stat-value" id="statTotalRequirements">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">å¼ºåˆ¶æ€§</div>
                                <div class="stat-value text-danger" id="statMandatory">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">åŠ åˆ†é¡¹</div>
                                <div class="stat-value text-warning" id="statScoring">0</div>
                            </div>
                        </div>

                        <!-- æ“ä½œæ  -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary active" data-type-filter="all">
                                å…¨éƒ¨
                            </button>
                            <button class="btn btn-outline-danger" data-type-filter="mandatory">
                                å¼ºåˆ¶æ€§
                            </button>
                            <button class="btn btn-outline-warning" data-type-filter="scoring">
                                åŠ åˆ†é¡¹
                            </button>
                            <button class="btn btn-outline-info" data-type-filter="optional">
                                å¯é€‰
                            </button>
                        </div>

                        <div>
                            <button class="btn btn-sm btn-primary" id="addRequirementBtn">
                                <i class="bi bi-plus-circle"></i> æ–°å¢è¦æ±‚
                            </button>
                            <button class="btn btn-sm btn-success" id="exportExcelBtn">
                                <i class="bi bi-file-excel"></i> å¯¼å‡ºExcel
                            </button>
                        </div>
                    </div>

                    <!-- å¯ç¼–è¾‘è¡¨æ ¼ -->
                    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="table table-bordered table-hover editable-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th style="width: 120px;">ç±»å‹</th>
                                    <th style="width: 100px;">åˆ†ç±»</th>
                                    <th style="width: 120px;">å­åˆ†ç±»</th>
                                    <th style="min-width: 300px;">è¯¦ç»†æè¿°</th>
                                    <th style="width: 100px;">ä¼˜å…ˆçº§</th>
                                    <th style="width: 80px;">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="requirementsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-3">æ­£åœ¨åŠ è½½...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

                <!-- ==================== -->
                <!-- Tab 4: è¯„åˆ†åŠæ³• -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="scoringPanel" role="tabpanel">
                    <div class="empty-state">
                        <i class="bi bi-clipboard2-data fs-1 text-muted"></i>
                        <h5 class="text-muted">è¯„åˆ†åŠæ³•</h5>
                        <p class="text-muted">å†…å®¹å¾…å¡«å……</p>
                    </div>
                </div>

                <!-- ==================== -->
                <!-- Tab 5: æŠ€æœ¯éœ€æ±‚ -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="technicalPanel" role="tabpanel">
                    <div class="empty-state">
                        <i class="bi bi-gear fs-1 text-muted"></i>
                        <h5 class="text-muted">æŠ€æœ¯éœ€æ±‚</h5>
                        <p class="text-muted">å†…å®¹å¾…å¡«å……</p>
                    </div>
                </div>

                <!-- ==================== -->
                <!-- Tab 6: åº”ç­”æ–‡ä»¶æ ¼å¼ -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="documentFormatPanel" role="tabpanel">
                    <div id="responseFileContent" style="min-height: 200px; padding: 20px;">
                        <div class="empty-state" id="noResponseFileMessage">
                            <i class="bi bi-file-earmark-text fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">åº”ç­”æ–‡ä»¶æ ¼å¼</h5>
                            <p class="text-muted">å°šæœªä¿å­˜åº”ç­”æ–‡ä»¶æ¨¡æ¿</p>
                            <p class="text-muted small">è¯·åœ¨æ­¥éª¤1ä¸­é€‰æ‹©ç« èŠ‚åï¼Œç‚¹å‡»"å¦å­˜ä¸ºåº”ç­”æ–‡ä»¶"æŒ‰é’®</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿä¸€ä¿å­˜æŒ‰é’® -->
            <div class="mt-4 text-center">
                <button class="btn btn-success btn-lg" id="saveAndCompleteBtn">
                    <i class="bi bi-check-circle me-2"></i>ä¿å­˜å¹¶å®Œæˆ
                </button>
            </div>

            <!-- å®Œæˆæ¶ˆæ¯ -->
            <div id="step3CompleteMessage" style="display: none;"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- æ­¥éª¤3å¢å¼ºç‰ˆè„šæœ¬ï¼ˆåŒ…å«åŸºæœ¬ä¿¡æ¯ã€èµ„è´¨è¦æ±‚ã€è¯¦ç»†è¦æ±‚ï¼‰ - å¿…é¡»å…ˆåŠ è½½ï¼Œå› ä¸ºæ­¥éª¤1éœ€è¦è°ƒç”¨proceedToStep3å‡½æ•° -->
    <script src="/static/js/pages/tender-processing-step3-enhanced.js?v=20251008a"></script>

    <!-- æ­¥éª¤1è„šæœ¬ -->
    <script src="/static/js/pages/tender-processing-step1.js"></script>

    <!-- æ­¥éª¤2è„šæœ¬ -->
    <script src="/static/js/pages/tender-processing-step2.js"></script>

    <!-- HITLé…ç½®ç®¡ç†å™¨ -->
    <script>
        // HITLé¡µé¢çš„æ¨¡å‹å’Œå…¬å¸ç®¡ç†
        const HITLConfigManager = {
            currentCompanyId: null,
            currentModel: 'yuanjing-deepseek-v3',

            // åˆå§‹åŒ–
            init() {
                console.log('[HITLConfigManager] åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨');

                // åŠ è½½å…¬å¸åˆ—è¡¨
                this.loadCompanies();

                // åŠ è½½æ¨¡å‹åˆ—è¡¨
                this.loadModels();

                // ç»‘å®šäº‹ä»¶
                this.bindEvents();
            },

            // åŠ è½½å…¬å¸åˆ—è¡¨
            async loadCompanies() {
                try {
                    const response = await fetch('/api/companies');
                    const data = await response.json();

                    if (data.success && data.data) {
                        const select = document.getElementById('hitlCompanySelect');
                        const nameSpan = document.getElementById('hitlSelectedCompanyName');

                        select.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬å¸...</option>';

                        data.data.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.company_id;
                            option.textContent = company.company_name;
                            select.appendChild(option);
                        });

                        console.log(`[HITLConfigManager] åŠ è½½äº† ${data.data.length} ä¸ªå…¬å¸`);
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] åŠ è½½å…¬å¸åˆ—è¡¨å¤±è´¥:', error);
                }
            },

            // åŠ è½½æ¨¡å‹åˆ—è¡¨
            async loadModels() {
                try {
                    const response = await fetch('/api/models');
                    const data = await response.json();

                    if (data.success && data.models) {
                        this.updateModelSelect(data.models);
                        console.log(`[HITLConfigManager] åŠ è½½äº† ${data.count} ä¸ªAIæ¨¡å‹`);
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                }
            },

            // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
            updateModelSelect(models) {
                const select = document.getElementById('hitlAiModel');
                if (!select) return;

                const currentValue = select.value;

                // ä¿æŒç°æœ‰é€‰é¡¹ä½†æ›´æ–°çŠ¶æ€
                Array.from(select.options).forEach(option => {
                    const model = models.find(m => m.name === option.value);
                    if (model) {
                        const baseText = option.textContent.replace(' âœ“', '').replace(' (æœªé…ç½®)', '');
                        if (model.status === 'available') {
                            option.textContent = baseText + ' âœ“';
                            option.disabled = false;
                        } else if (model.status === 'no_api_key') {
                            option.textContent = baseText + ' (æœªé…ç½®)';
                            option.disabled = true;
                        }
                    }
                });

                // æ¢å¤é€‰æ‹©
                if (currentValue) {
                    select.value = currentValue;
                }

                this.updateModelStatus();
            },

            // æ›´æ–°æ¨¡å‹çŠ¶æ€æ˜¾ç¤º
            updateModelStatus() {
                const select = document.getElementById('hitlAiModel');
                const statusDiv = document.getElementById('hitlModelStatus');
                const icon = document.getElementById('hitlModelStatusIcon');
                const text = document.getElementById('hitlModelStatusText');

                if (!select || !statusDiv) return;

                const selectedValue = select.value;

                if (selectedValue) {
                    statusDiv.style.display = 'block';
                    icon.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
                    text.textContent = 'æ¨¡å‹å¯ç”¨';
                    text.className = 'text-success';
                } else {
                    statusDiv.style.display = 'none';
                }
            },

            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                // å…¬å¸é€‰æ‹©å˜åŒ–
                const companySelect = document.getElementById('hitlCompanySelect');
                if (companySelect) {
                    companySelect.addEventListener('change', (e) => {
                        this.currentCompanyId = e.target.value;
                        const nameSpan = document.getElementById('hitlSelectedCompanyName');
                        const selectedText = e.target.options[e.target.selectedIndex].text;
                        nameSpan.textContent = e.target.value ? selectedText : 'æœªé€‰æ‹©';
                        nameSpan.className = e.target.value ? 'text-primary fw-bold' : 'text-muted';

                        console.log(`[HITLConfigManager] é€‰æ‹©å…¬å¸: ${selectedText} (ID: ${e.target.value})`);
                    });
                }

                // æ¨¡å‹é€‰æ‹©å˜åŒ–
                const modelSelect = document.getElementById('hitlAiModel');
                if (modelSelect) {
                    modelSelect.addEventListener('change', (e) => {
                        this.currentModel = e.target.value;
                        this.updateModelStatus();
                        console.log(`[HITLConfigManager] é€‰æ‹©æ¨¡å‹: ${e.target.value}`);
                    });
                }
            },

            // è·å–å½“å‰é…ç½®ï¼ˆä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ï¼‰
            getConfig() {
                return {
                    companyId: this.currentCompanyId,
                    model: this.currentModel,
                    projectId: document.getElementById('projectId')?.value
                };
            }
        };

        // å…¨å±€å‡½æ•°ï¼ˆä¾›HTMLè°ƒç”¨ï¼‰
        function onHitlModelChange() {
            HITLConfigManager.updateModelStatus();
        }

        function refreshHitlModels() {
            HITLConfigManager.loadModels();
        }

        /**
         * åˆå§‹åŒ–æ¨¡å‹é€‰æ‹©å™¨
         * - ä»localStorageè¯»å–ä¸Šæ¬¡é€‰æ‹©çš„æ¨¡å‹
         * - å¦‚æœæ²¡æœ‰ï¼Œé»˜è®¤é€‰æ‹© yuanjing-deepseek-v3ï¼ˆæ›´é€‚åˆæ™ºèƒ½æå–ï¼‰
         * - ä¿å­˜ç”¨æˆ·é€‰æ‹©åˆ°localStorage
         */
        function initModelSelector() {
            const modelSelect = document.getElementById('hitlAiModel');
            if (!modelSelect) {
                console.warn('[initModelSelector] æœªæ‰¾åˆ°æ¨¡å‹é€‰æ‹©å™¨');
                return;
            }

            // ä»localStorageè¯»å–ä¸Šæ¬¡é€‰æ‹©
            const STORAGE_KEY = 'hitl_selected_model';
            let savedModel = localStorage.getItem(STORAGE_KEY);

            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„é€‰æ‹©ï¼Œä½¿ç”¨æ™ºèƒ½é»˜è®¤å€¼ï¼ˆDeepSeek-V3æ›´é€‚åˆæå–ä»»åŠ¡ï¼‰
            if (!savedModel) {
                savedModel = 'yuanjing-deepseek-v3';
                console.log('[initModelSelector] é¦–æ¬¡ä½¿ç”¨ï¼Œé»˜è®¤é€‰æ‹©:', savedModel);
            } else {
                console.log('[initModelSelector] æ¢å¤ä¸Šæ¬¡é€‰æ‹©:', savedModel);
            }

            // è®¾ç½®é€‰ä¸­çŠ¶æ€
            modelSelect.value = savedModel;

            // ç›‘å¬å˜åŒ–ï¼Œä¿å­˜åˆ°localStorage
            modelSelect.addEventListener('change', function() {
                const selectedModel = this.value;
                localStorage.setItem(STORAGE_KEY, selectedModel);
                console.log('[initModelSelector] æ¨¡å‹å·²æ›´æ”¹å¹¶ä¿å­˜:', selectedModel);
            });

            // è§¦å‘ä¸€æ¬¡changeäº‹ä»¶ï¼Œæ›´æ–°æ¨¡å‹çŠ¶æ€æ˜¾ç¤º
            if (typeof onHitlModelChange === 'function') {
                onHitlModelChange();
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ï¼ˆä½¿ç”¨å·²å­˜åœ¨çš„DOMContentLoadedäº‹ä»¶ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[HITL] åˆå§‹åŒ–é…ç½®ç®¡ç†å™¨');
            HITLConfigManager.init();

            // åˆå§‹åŒ–AIæ¨¡å‹é€‰æ‹©å™¨
            initModelSelector();

            // ç›‘å¬åº”ç­”æ–‡ä»¶æ ¼å¼tabçš„shownäº‹ä»¶
            const documentFormatTabEl = document.getElementById('document-format-tab');
            if (documentFormatTabEl) {
                documentFormatTabEl.addEventListener('shown.bs.tab', function (event) {
                    console.log('[HITL] åº”ç­”æ–‡ä»¶æ ¼å¼tabå·²æ˜¾ç¤ºï¼Œå½“å‰ä»»åŠ¡ID:', typeof currentHitlTaskId !== 'undefined' ? currentHitlTaskId : 'æœªå®šä¹‰');
                    if (typeof currentHitlTaskId !== 'undefined' && currentHitlTaskId) {
                        if (typeof loadResponseFileInfo === 'function') {
                            loadResponseFileInfo(currentHitlTaskId);
                        } else {
                            console.error('[HITL] loadResponseFileInfoå‡½æ•°æœªå®šä¹‰');
                        }
                    } else {
                        console.warn('[HITL] å½“å‰ä»»åŠ¡IDæœªè®¾ç½®ï¼Œæ— æ³•åŠ è½½åº”ç­”æ–‡ä»¶');
                    }
                });
            }
        });
    </script>

    <!-- Mammoth.js - Wordæ–‡æ¡£è½¬HTML -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

    <!-- æ–‡æ¡£é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentPreviewModalLabel">
                        <i class="bi bi-eye"></i> æ–‡æ¡£é¢„è§ˆ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="documentPreviewContent" style="min-height: 500px; padding: 20px; background: white;">
                        <!-- é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
