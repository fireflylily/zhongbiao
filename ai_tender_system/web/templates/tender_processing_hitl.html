<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标书智能处理 - HITL流程 - AI标书系统</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- 自定义样式 -->
    <link rel="stylesheet" href="/static/css/tender-processing-hitl.css">

    <!-- 步骤3增强版样式 -->
    <link rel="stylesheet" href="/static/css/tender-processing-step3-enhanced.css">

    <style>
        body {
            background-color: #f5f5f5;
            padding-top: 70px;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.3rem;
        }

        /* 空白状态样式 */
        .empty-state {
            text-align: center;
            padding: 120px 40px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
            min-height: 450px;
        }

        .empty-state i {
            display: block;
            opacity: 0.4;
            margin-bottom: 20px;
        }

        .empty-state h5 {
            margin: 15px 0 10px 0;
            font-weight: 600;
            color: #6c757d;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.95rem;
            color: #adb5bd;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-file-earmark-text me-2"></i>AI标书系统
            </a>
            <div class="d-flex align-items-center">
                <a href="/" class="btn btn-sm btn-outline-light me-2">
                    <i class="bi bi-house"></i> 首页
                </a>
                <a href="/knowledge_base" class="btn btn-sm btn-outline-light">
                    <i class="bi bi-database"></i> 知识库
                </a>
            </div>
        </div>
    </nav>

    <!-- 主内容区 -->
    <div class="container-fluid" style="max-width: 1400px;">
        <!-- 页面标题 -->
        <div class="section-card">
            <h2>
                <i class="bi bi-magic text-primary me-2"></i>标书智能处理 - 人工确认流程
            </h2>
            <p class="text-muted mb-0">
                两步智能处理：<strong>章节选择</strong> → <strong>信息提取与编辑</strong>
            </p>
        </div>

        <!-- 项目和模型配置区域 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">
                            <i class="bi bi-gear"></i> 配置信息
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- 项目ID输入 -->
                            <div class="col-md-4">
                                <label for="projectId" class="form-label">
                                    <i class="bi bi-folder2"></i> 项目ID <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="projectId" placeholder="输入项目ID" value="1">
                                <small class="text-muted">用于关联此次处理任务</small>
                            </div>

                            <!-- 公司选择 -->
                            <div class="col-md-4">
                                <label for="hitlCompanySelect" class="form-label">
                                    <i class="bi bi-building"></i> 应答公司 <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <select class="form-select" id="hitlCompanySelect" required>
                                        <option value="">请选择公司...</option>
                                    </select>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="window.location.href='/knowledge_base?action=company_management';" title="管理公司">
                                        <i class="bi bi-building"></i>
                                    </button>
                                </div>
                                <div class="mt-1">
                                    <small class="text-muted">当前：</small>
                                    <span id="hitlSelectedCompanyName" class="text-muted">未选择</span>
                                </div>
                            </div>

                            <!-- AI模型选择 -->
                            <div class="col-md-4">
                                <label for="hitlAiModel" class="form-label">
                                    <i class="bi bi-cpu"></i> AI模型 <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex align-items-center gap-2">
                                    <select class="form-select" id="hitlAiModel" onchange="onHitlModelChange()">
                                        <optgroup label="OpenAI（推荐）">
                                            <option value="gpt-4o-mini">GPT-4O Mini ✓</option>
                                            <option value="gpt-4o">GPT-4O</option>
                                        </optgroup>
                                        <optgroup label="联通元景">
                                            <option value="yuanjing-deepseek-v3">DeepSeek-V3（智能提取） ✓</option>
                                            <option value="yuanjing-pro">元景专业版</option>
                                        </optgroup>
                                    </select>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="refreshHitlModels()" title="刷新模型列表">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <!-- 模型状态显示 -->
                                <div class="mt-1" id="hitlModelStatus" style="display: none;">
                                    <small class="d-flex align-items-center">
                                        <span id="hitlModelStatusIcon" class="me-1"></span>
                                        <span id="hitlModelStatusText"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 步骤指示器 -->
        <div class="step-indicator">
            <div class="step active" id="stepIndicator1">
                <div class="step-number">1</div>
                <div class="step-label">章节选择</div>
            </div>
            <!-- 步骤2已隐藏 -->
            <div class="step" id="stepIndicator3">
                <div class="step-number">2</div>
                <div class="step-label">信息提取与编辑</div>
            </div>
        </div>

        <!-- ==================== -->
        <!-- 上传文件区域 -->
        <!-- ==================== -->
        <div id="uploadSection" class="section-card">
            <h4 class="section-title">
                <i class="bi bi-upload me-2"></i>上传标书文档
            </h4>

            <div class="row">
                <div class="col-12">
                    <label for="tenderDocFile" class="form-label">标书文档 <span class="text-danger">*</span></label>
                    <input type="file" class="form-control" id="tenderDocFile" accept=".docx,.doc">
                    <small class="text-muted">支持 .docx 和 .doc 格式</small>
                </div>
            </div>

            <div class="mt-3">
                <button class="btn btn-primary" id="parseStructureBtn">
                    <i class="bi bi-file-earmark-code me-2"></i>解析文档结构
                </button>
            </div>
        </div>

        <!-- ==================== -->
        <!-- 步骤1：章节选择 -->
        <!-- ==================== -->
        <div id="chapterSelectionSection" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-list-nested me-2"></i>步骤1：选择需要处理的章节
            </h4>

            <!-- 统计信息 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">总章节数</div>
                    <div class="stat-value" id="statTotalChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">已选择</div>
                    <div class="stat-value text-success" id="statSelectedChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">选中字数</div>
                    <div class="stat-value text-info" id="statSelectedWords">0</div>
                </div>
            </div>

            <!-- 批量操作 -->
            <div class="batch-operations">
                <button class="btn btn-sm btn-outline-primary" id="selectAllBtn">
                    <i class="bi bi-check-all"></i> 全选
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="unselectAllBtn">
                    <i class="bi bi-x"></i> 全不选
                </button>
                <button class="btn btn-sm btn-outline-success" id="selectTechBtn">
                    <i class="bi bi-cpu"></i> 仅选技术章节
                </button>
                <button class="btn btn-sm btn-outline-danger" id="excludeContractBtn">
                    <i class="bi bi-file-x"></i> 排除合同条款
                </button>
            </div>

            <div class="row">
                <!-- 左侧：章节树 -->
                <div class="col-md-8">
                    <div class="chapter-search mb-3">
                        <input type="text"
                               class="form-control"
                               id="chapterSearch"
                               placeholder="🔍 搜索章节...">
                    </div>

                    <div class="chapter-tree-container" id="chapterTreeContainer">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-folder2-open" style="font-size: 3rem;"></i>
                            <p class="mt-3">等待文档解析...</p>
                        </div>
                    </div>
                </div>

                <!-- 右侧：预览区 -->
                <div class="col-md-4">
                    <h6 class="mb-3">章节预览</h6>
                    <div id="chapterPreview">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-eye" style="font-size: 3rem;"></i>
                            <p class="mt-3">点击"预览"按钮查看章节内容</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 确认按钮 -->
            <div class="mt-4 text-center">
                <button class="btn btn-primary btn-lg me-3" id="exportSelectedChaptersBtn" disabled>
                    <i class="bi bi-download me-2"></i>导出选中章节
                </button>
                <button class="btn btn-info btn-lg me-3" id="saveAsResponseFileBtn" disabled>
                    <i class="bi bi-file-earmark-arrow-down me-2"></i>另存为应答文件
                </button>
                <button class="btn btn-success btn-lg" id="confirmSelectionBtn">
                    <i class="bi bi-check-circle me-2"></i>确认选择并继续
                </button>
            </div>

            <!-- 完成消息 -->
            <div id="step1CompleteMessage" style="display: none;"></div>
        </div>

        <!-- ==================== -->
        <!-- 步骤2：章节要求预览 -->
        <!-- ==================== -->
        <div id="step2Section" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-list-check me-2"></i>步骤2：章节要求预览
            </h4>

            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                AI已从选中的章节中提取要求。您可以查看每个章节的要求数量，取消不需要的章节。
            </div>

            <!-- 统计信息 -->
            <div class="stats-grid mb-4">
                <div class="stat-card">
                    <div class="stat-label">总章节数</div>
                    <div class="stat-value" id="statTotalChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">已选章节</div>
                    <div class="stat-value text-success" id="statSelectedChapters">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">提取要求数</div>
                    <div class="stat-value text-primary" id="statTotalRequirementsStep2">0</div>
                </div>
            </div>

            <!-- 章节列表 -->
            <div id="chapterRequirementsContainer" style="max-height: 600px; overflow-y: auto;">
                <div class="text-center text-muted py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">正在加载章节数据...</p>
                </div>
            </div>

            <!-- 确认继续按钮 -->
            <div class="mt-4 text-center">
                <button class="btn btn-success btn-lg" id="confirmStep2Btn">
                    <i class="bi bi-arrow-right me-2"></i>确认并继续步骤3
                </button>
            </div>
        </div>

        <!-- ==================== -->
        <!-- 步骤3：综合信息提取与编辑 -->
        <!-- ==================== -->
        <div id="step3Section" class="section-card" style="display: none;">
            <h4 class="section-title">
                <i class="bi bi-clipboard-data me-2"></i>步骤3：信息提取与编辑
            </h4>

            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle me-2"></i>
                在此步骤中，您可以查看和编辑<strong>基本信息</strong>、<strong>资质要求</strong>、<strong>资格要求</strong>、<strong>评分办法</strong>、<strong>技术需求</strong>和<strong>应答文件格式</strong>。AI已自动提取这些信息，您可以根据需要修正。
            </div>

            <!-- Tab导航 -->
            <ul class="nav nav-tabs mb-4" id="step3Tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basicInfoPanel" type="button" role="tab">
                        <i class="bi bi-info-circle me-2"></i>基本信息
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="qualifications-tab" data-bs-toggle="tab" data-bs-target="#qualificationsPanel" type="button" role="tab">
                        <i class="bi bi-award me-2"></i>资质要求
                        <span class="badge bg-primary ms-1" id="qualBadge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="eligibility-tab" data-bs-toggle="tab" data-bs-target="#eligibilityPanel" type="button" role="tab">
                        <i class="bi bi-person-check me-2"></i>资格要求
                        <span class="badge bg-success ms-1" id="eligBadge">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="scoring-tab" data-bs-toggle="tab" data-bs-target="#scoringPanel" type="button" role="tab">
                        <i class="bi bi-graph-up me-2"></i>评分办法
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="technical-tab" data-bs-toggle="tab" data-bs-target="#technicalPanel" type="button" role="tab">
                        <i class="bi bi-gear me-2"></i>技术需求
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="document-format-tab" data-bs-toggle="tab" data-bs-target="#documentFormatPanel" type="button" role="tab">
                        <i class="bi bi-file-earmark-text me-2"></i>应答文件格式
                    </button>
                </li>
            </ul>

            <!-- Tab内容 -->
            <div class="tab-content" id="step3TabContent">
                <!-- ==================== -->
                <!-- Tab 1: 基本信息 -->
                <!-- ==================== -->
                <div class="tab-pane fade show active" id="basicInfoPanel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>项目基本信息</h5>
                        <button class="btn btn-sm btn-outline-primary" id="extractBasicInfoBtn">
                            <i class="bi bi-magic me-2"></i>AI提取基本信息
                        </button>
                    </div>

                    <div id="basicInfoLoading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3 text-muted">正在提取基本信息...</p>
                    </div>

                    <form id="basicInfoForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="projectName" class="form-label">项目名称</label>
                                <input type="text" class="form-control" id="projectName" name="project_name">
                            </div>
                            <div class="col-md-6">
                                <label for="projectNumber" class="form-label">项目编号</label>
                                <input type="text" class="form-control" id="projectNumber" name="project_number">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderParty" class="form-label">招标人</label>
                                <input type="text" class="form-control" id="tenderParty" name="tender_party">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderAgent" class="form-label">招标代理</label>
                                <input type="text" class="form-control" id="tenderAgent" name="tender_agent">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderMethod" class="form-label">投标方式</label>
                                <input type="text" class="form-control" id="tenderMethod" name="tender_method">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderLocation" class="form-label">投标地点</label>
                                <input type="text" class="form-control" id="tenderLocation" name="tender_location">
                            </div>
                            <div class="col-md-6">
                                <label for="tenderDeadline" class="form-label">投标时间</label>
                                <input type="text" class="form-control" id="tenderDeadline" name="tender_deadline">
                            </div>
                            <div class="col-md-6">
                                <label for="winnerCount" class="form-label">中标人数量</label>
                                <input type="text" class="form-control" id="winnerCount" name="winner_count">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- ==================== -->
                <!-- Tab 2: 资质要求 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="qualificationsPanel" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-shield-check me-2"></i>资质要求匹配</h5>
                        <button class="btn btn-sm btn-outline-success" id="extractQualificationsBtn">
                            <i class="bi bi-magic me-2"></i>AI提取资质要求
                        </button>
                    </div>

                    <div id="qualificationsLoading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="mt-3 text-muted">正在提取资质要求...</p>
                    </div>

                    <!-- 资质匹配汇总 -->
                    <div class="stats-grid mb-4" id="qualificationSummary" style="display: none;">
                        <div class="stat-card">
                            <div class="stat-label">要求总数</div>
                            <div class="stat-value" id="qualRequiredCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">已上传</div>
                            <div class="stat-value text-success" id="qualUploadedCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">缺失</div>
                            <div class="stat-value text-danger" id="qualMissingCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">匹配度</div>
                            <div class="stat-value text-primary" id="qualMatchRate">0%</div>
                        </div>
                    </div>

                    <!-- 资质详细列表 -->
                    <div id="qualificationsContainer">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-award" style="font-size: 3rem;"></i>
                            <p class="mt-3">点击"AI提取资质要求"按钮开始提取</p>
                        </div>
                    </div>
                </div>

                <!-- ==================== -->
                <!-- Tab 3: 资格要求 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="eligibilityPanel" role="tabpanel">
                    <!-- AI提取按钮区域 -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="mb-0">资格要求</h5>
                        <button class="btn btn-primary" id="extractRequirementsBtn">
                            <i class="fas fa-magic me-2"></i>AI提取资格要求
                        </button>
                    </div>

                    <!-- 提取进度提示 -->
                    <div id="requirementsExtractionProgress" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                            <div>
                                <strong>AI正在提取要求...</strong>
                                <p class="mb-0 small">这可能需要40-60秒，请耐心等待</p>
                            </div>
                        </div>
                    </div>

                    <!-- 空状态提示 -->
                    <div id="eligibilityEmptyState" class="alert alert-light border text-center py-5">
                        <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">尚未提取供应商资格要求</h5>
                        <p class="text-muted mb-3">点击上方的"AI提取资格要求"按钮开始智能提取</p>
                        <p class="small text-muted mb-0">
                            提取范围：您在步骤1中选中的章节<br>
                            提取内容：营业执照、财务、纳税、社保等13条供应商资格要求
                        </p>
                    </div>

                    <!-- 13条资格要求清单容器 -->
                    <div id="eligibilityChecklistContainer" style="display: none;">
                        <!-- 统计卡片 -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0"><span id="eligFoundCount">0</span> 条</h2>
                                        <div class="small">已找到</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card bg-warning text-white">
                                    <div class="card-body text-center">
                                        <h2 class="mb-0"><span id="eligNotFoundCount">13</span> 条</h2>
                                        <div class="small">未找到</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 清单显示区域 -->
                        <div id="eligibilityChecklistItems">
                            <!-- 这里将由JavaScript动态生成13条清单 -->
                        </div>
                    </div>

                    <!-- 要求表格容器 -->
                    <div id="requirementsTableContainer" style="display: none;">
                        <!-- 统计信息 -->
                        <div class="stats-grid mb-4">
                            <div class="stat-card">
                                <div class="stat-label">总要求数</div>
                                <div class="stat-value" id="statTotalRequirements">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">强制性</div>
                                <div class="stat-value text-danger" id="statMandatory">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">加分项</div>
                                <div class="stat-value text-warning" id="statScoring">0</div>
                            </div>
                        </div>

                        <!-- 操作栏 -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-secondary active" data-type-filter="all">
                                全部
                            </button>
                            <button class="btn btn-outline-danger" data-type-filter="mandatory">
                                强制性
                            </button>
                            <button class="btn btn-outline-warning" data-type-filter="scoring">
                                加分项
                            </button>
                            <button class="btn btn-outline-info" data-type-filter="optional">
                                可选
                            </button>
                        </div>

                        <div>
                            <button class="btn btn-sm btn-primary" id="addRequirementBtn">
                                <i class="bi bi-plus-circle"></i> 新增要求
                            </button>
                            <button class="btn btn-sm btn-success" id="exportExcelBtn">
                                <i class="bi bi-file-excel"></i> 导出Excel
                            </button>
                        </div>
                    </div>

                    <!-- 可编辑表格 -->
                    <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                        <table class="table table-bordered table-hover editable-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">ID</th>
                                    <th style="width: 120px;">类型</th>
                                    <th style="width: 100px;">分类</th>
                                    <th style="width: 120px;">子分类</th>
                                    <th style="min-width: 300px;">详细描述</th>
                                    <th style="width: 100px;">优先级</th>
                                    <th style="width: 80px;">操作</th>
                                </tr>
                            </thead>
                            <tbody id="requirementsTableBody">
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p class="mt-3">正在加载...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

                <!-- ==================== -->
                <!-- Tab 4: 评分办法 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="scoringPanel" role="tabpanel">
                    <div class="empty-state">
                        <i class="bi bi-clipboard2-data fs-1 text-muted"></i>
                        <h5 class="text-muted">评分办法</h5>
                        <p class="text-muted">内容待填充</p>
                    </div>
                </div>

                <!-- ==================== -->
                <!-- Tab 5: 技术需求 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="technicalPanel" role="tabpanel">
                    <div class="empty-state">
                        <i class="bi bi-gear fs-1 text-muted"></i>
                        <h5 class="text-muted">技术需求</h5>
                        <p class="text-muted">内容待填充</p>
                    </div>
                </div>

                <!-- ==================== -->
                <!-- Tab 6: 应答文件格式 -->
                <!-- ==================== -->
                <div class="tab-pane fade" id="documentFormatPanel" role="tabpanel">
                    <div id="responseFileContent" style="min-height: 200px; padding: 20px;">
                        <div class="empty-state" id="noResponseFileMessage">
                            <i class="bi bi-file-earmark-text fs-1 text-muted mb-3"></i>
                            <h5 class="text-muted">应答文件格式</h5>
                            <p class="text-muted">尚未保存应答文件模板</p>
                            <p class="text-muted small">请在步骤1中选择章节后，点击"另存为应答文件"按钮</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 统一保存按钮 -->
            <div class="mt-4 text-center">
                <button class="btn btn-success btn-lg" id="saveAndCompleteBtn">
                    <i class="bi bi-check-circle me-2"></i>保存并完成
                </button>
            </div>

            <!-- 完成消息 -->
            <div id="step3CompleteMessage" style="display: none;"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 步骤3增强版脚本（包含基本信息、资质要求、详细要求） - 必须先加载，因为步骤1需要调用proceedToStep3函数 -->
    <script src="/static/js/pages/tender-processing-step3-enhanced.js?v=20251008a"></script>

    <!-- 步骤1脚本 -->
    <script src="/static/js/pages/tender-processing-step1.js"></script>

    <!-- 步骤2脚本 -->
    <script src="/static/js/pages/tender-processing-step2.js"></script>

    <!-- HITL配置管理器 -->
    <script>
        // HITL页面的模型和公司管理
        const HITLConfigManager = {
            currentCompanyId: null,
            currentModel: 'yuanjing-deepseek-v3',

            // 初始化
            init() {
                console.log('[HITLConfigManager] 初始化配置管理器');

                // 加载公司列表
                this.loadCompanies();

                // 加载模型列表
                this.loadModels();

                // 绑定事件
                this.bindEvents();
            },

            // 加载公司列表
            async loadCompanies() {
                try {
                    const response = await fetch('/api/companies');
                    const data = await response.json();

                    if (data.success && data.data) {
                        const select = document.getElementById('hitlCompanySelect');
                        const nameSpan = document.getElementById('hitlSelectedCompanyName');

                        select.innerHTML = '<option value="">请选择公司...</option>';

                        data.data.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.company_id;
                            option.textContent = company.company_name;
                            select.appendChild(option);
                        });

                        console.log(`[HITLConfigManager] 加载了 ${data.data.length} 个公司`);
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] 加载公司列表失败:', error);
                }
            },

            // 加载模型列表
            async loadModels() {
                try {
                    const response = await fetch('/api/models');
                    const data = await response.json();

                    if (data.success && data.models) {
                        this.updateModelSelect(data.models);
                        console.log(`[HITLConfigManager] 加载了 ${data.count} 个AI模型`);
                    }
                } catch (error) {
                    console.error('[HITLConfigManager] 加载模型列表失败:', error);
                }
            },

            // 更新模型选择器
            updateModelSelect(models) {
                const select = document.getElementById('hitlAiModel');
                if (!select) return;

                const currentValue = select.value;

                // 保持现有选项但更新状态
                Array.from(select.options).forEach(option => {
                    const model = models.find(m => m.name === option.value);
                    if (model) {
                        const baseText = option.textContent.replace(' ✓', '').replace(' (未配置)', '');
                        if (model.status === 'available') {
                            option.textContent = baseText + ' ✓';
                            option.disabled = false;
                        } else if (model.status === 'no_api_key') {
                            option.textContent = baseText + ' (未配置)';
                            option.disabled = true;
                        }
                    }
                });

                // 恢复选择
                if (currentValue) {
                    select.value = currentValue;
                }

                this.updateModelStatus();
            },

            // 更新模型状态显示
            updateModelStatus() {
                const select = document.getElementById('hitlAiModel');
                const statusDiv = document.getElementById('hitlModelStatus');
                const icon = document.getElementById('hitlModelStatusIcon');
                const text = document.getElementById('hitlModelStatusText');

                if (!select || !statusDiv) return;

                const selectedValue = select.value;

                if (selectedValue) {
                    statusDiv.style.display = 'block';
                    icon.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
                    text.textContent = '模型可用';
                    text.className = 'text-success';
                } else {
                    statusDiv.style.display = 'none';
                }
            },

            // 绑定事件
            bindEvents() {
                // 公司选择变化
                const companySelect = document.getElementById('hitlCompanySelect');
                if (companySelect) {
                    companySelect.addEventListener('change', (e) => {
                        this.currentCompanyId = e.target.value;
                        const nameSpan = document.getElementById('hitlSelectedCompanyName');
                        const selectedText = e.target.options[e.target.selectedIndex].text;
                        nameSpan.textContent = e.target.value ? selectedText : '未选择';
                        nameSpan.className = e.target.value ? 'text-primary fw-bold' : 'text-muted';

                        console.log(`[HITLConfigManager] 选择公司: ${selectedText} (ID: ${e.target.value})`);
                    });
                }

                // 模型选择变化
                const modelSelect = document.getElementById('hitlAiModel');
                if (modelSelect) {
                    modelSelect.addEventListener('change', (e) => {
                        this.currentModel = e.target.value;
                        this.updateModelStatus();
                        console.log(`[HITLConfigManager] 选择模型: ${e.target.value}`);
                    });
                }
            },

            // 获取当前配置（供其他模块使用）
            getConfig() {
                return {
                    companyId: this.currentCompanyId,
                    model: this.currentModel,
                    projectId: document.getElementById('projectId')?.value
                };
            }
        };

        // 全局函数（供HTML调用）
        function onHitlModelChange() {
            HITLConfigManager.updateModelStatus();
        }

        function refreshHitlModels() {
            HITLConfigManager.loadModels();
        }

        /**
         * 初始化模型选择器
         * - 从localStorage读取上次选择的模型
         * - 如果没有，默认选择 yuanjing-deepseek-v3（更适合智能提取）
         * - 保存用户选择到localStorage
         */
        function initModelSelector() {
            const modelSelect = document.getElementById('hitlAiModel');
            if (!modelSelect) {
                console.warn('[initModelSelector] 未找到模型选择器');
                return;
            }

            // 从localStorage读取上次选择
            const STORAGE_KEY = 'hitl_selected_model';
            let savedModel = localStorage.getItem(STORAGE_KEY);

            // 如果没有保存的选择，使用智能默认值（DeepSeek-V3更适合提取任务）
            if (!savedModel) {
                savedModel = 'yuanjing-deepseek-v3';
                console.log('[initModelSelector] 首次使用，默认选择:', savedModel);
            } else {
                console.log('[initModelSelector] 恢复上次选择:', savedModel);
            }

            // 设置选中状态
            modelSelect.value = savedModel;

            // 监听变化，保存到localStorage
            modelSelect.addEventListener('change', function() {
                const selectedModel = this.value;
                localStorage.setItem(STORAGE_KEY, selectedModel);
                console.log('[initModelSelector] 模型已更改并保存:', selectedModel);
            });

            // 触发一次change事件，更新模型状态显示
            if (typeof onHitlModelChange === 'function') {
                onHitlModelChange();
            }
        }

        // 页面加载时初始化（使用已存在的DOMContentLoaded事件）
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[HITL] 初始化配置管理器');
            HITLConfigManager.init();

            // 初始化AI模型选择器
            initModelSelector();

            // 监听应答文件格式tab的shown事件
            const documentFormatTabEl = document.getElementById('document-format-tab');
            if (documentFormatTabEl) {
                documentFormatTabEl.addEventListener('shown.bs.tab', function (event) {
                    console.log('[HITL] 应答文件格式tab已显示，当前任务ID:', typeof currentHitlTaskId !== 'undefined' ? currentHitlTaskId : '未定义');
                    if (typeof currentHitlTaskId !== 'undefined' && currentHitlTaskId) {
                        if (typeof loadResponseFileInfo === 'function') {
                            loadResponseFileInfo(currentHitlTaskId);
                        } else {
                            console.error('[HITL] loadResponseFileInfo函数未定义');
                        }
                    } else {
                        console.warn('[HITL] 当前任务ID未设置，无法加载应答文件');
                    }
                });
            }
        });
    </script>

    <!-- Mammoth.js - Word文档转HTML -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

    <!-- 文档预览模态框 -->
    <div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentPreviewModalLabel">
                        <i class="bi bi-eye"></i> 文档预览
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="documentPreviewContent" style="min-height: 500px; padding: 20px; background: white;">
                        <!-- 预览内容将在这里显示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
