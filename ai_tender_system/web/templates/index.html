<!DOCTYPE html>
<!--
════════════════════════════════════════════════════════════════════════════════════════
                    前端架构统一重构计划 (index.html + knowledge_base.html)
════════════════════════════════════════════════════════════════════════════════════════

📊 现状分析：
  index.html:         6103行，275KB，~621行JavaScript代码
  knowledge_base.html: 3073行，157KB，~963行JavaScript代码

🔍 共同问题：
  1. 巨型单文件架构 - HTML+CSS+JS混合
  2. 定时器资源泄漏 - setInterval未正确清理
  3. 内存泄漏风险 - 事件监听器、DOM引用未清理
  4. 代码重复冗余 - 相同组件在多个页面重复实现
  5. 维护困难 - 缺乏模块化和组件化

🎯 统一重构目标：
  - 建立共享组件体系，60%+代码复用率
  - 主HTML文件减少75% (< 1500行)
  - 解决页面"死机"和性能问题
  - 建立可持续的前端架构

📁 共享架构设计：

阶段一：共享基础设施 (🔥最高优先级)
  /static/css/
  ├── base/
  │   ├── variables.css           # CSS变量定义 (配色、间距等)
  │   ├── bootstrap-overrides.css # Bootstrap统一覆盖
  │   └── animations.css          # 共同动画效果
  ├── components/
  │   ├── buttons.css            # 按钮组件样式
  │   ├── cards.css              # 卡片组件样式
  │   ├── modals.css             # 模态框样式
  │   ├── privacy-badges.css     # 隐私标识样式
  │   └── navigation.css         # 导航栏样式
  ├── knowledge_base.css         # 知识库特定样式
  └── index.css                  # 首页特定样式

  /static/js/
  ├── core/
  │   ├── api-client.js          # 统一API调用封装
  │   ├── notification.js        # 通知系统
  │   ├── validation.js          # 表单验证
  │   ├── timer-manager.js       # 定时器管理 (已存在)
  │   └── progress-manager.js    # 进度管理 (已存在)
  ├── components/
  │   ├── file-upload.js         # 文件上传组件
  │   ├── company-selector.js    # 公司选择器
  │   └── modal-manager.js       # 模态框管理

阶段二：页面特定重构 (⚡中优先级)
  /static/js/pages/
  ├── knowledge-base/
  │   ├── category-manager.js    # 分类管理
  │   ├── document-manager.js    # 文档管理
  │   └── search-manager.js      # 搜索功能
  ├── index/
  │   ├── proposal-generator.js  # 标书生成
  │   ├── tender-processor.js    # 招标文件处理
  │   └── dashboard-manager.js   # 仪表板管理

  /templates/components/
  ├── layout/
  │   ├── base.html              # 基础布局模板
  │   └── navbar.html            # 导航栏组件
  ├── shared/
  │   ├── company-selector.html  # 公司选择器
  │   ├── file-upload.html       # 文件上传区域
  │   ├── progress-bars.html     # 进度条组件
  │   └── modal-dialogs.html     # 模态框组件
  ├── knowledge-base/
  │   ├── category-tree.html     # 分类树组件
  │   └── document-list.html     # 文档列表组件
  └── index/
      ├── sidebar.html           # 首页侧边栏
      └── upload-area.html       # 上传区域组件

阶段三：性能优化 (🚀低优先级)
  1. 懒加载策略 - 按需加载组件和数据
  2. 缓存机制 - 前端数据缓存和状态管理
  3. 代码分割 - 按功能模块分割JavaScript包
  4. 资源优化 - 图片压缩、CSS/JS压缩合并

🔧 实施策略：
  1. 共享优先 - 先建立共同组件，再处理页面特定功能
  2. 渐进式重构 - 不影响现有功能的前提下逐步迁移
  3. 组件化开发 - 每个组件独立开发、测试、部署
  4. 统一规范 - 代码风格、命名约定、API设计保持一致

📈 预期收益：
  ✅ 代码复用率提升60%+ - 共享组件和样式
  ✅ 维护成本降低 - 统一的架构和规范
  ✅ 开发效率提升 - 组件化开发模式
  ✅ 性能改善 - 减少重复代码，优化加载
  ✅ 页面稳定性 - 解决定时器泄漏和内存问题

⚠️ 风险控制：
  - 分阶段实施，每个阶段独立测试验证
  - 保持API向后兼容，支持快速回滚
  - 共享组件变更需要回归测试所有页面
  - 建立组件文档和使用规范

📝 实施记录：
  - 2024-09-27: 建立统一重构计划
  - 已完成: timer-manager.js, progress-manager.js
  - 进行中: CSS样式分离和JavaScript模块化
  - 待完成: 组件模板化和性能优化

════════════════════════════════════════════════════════════════════════════════════════
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>元景AI智能标书生成平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/litera/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 统一CSS架构 - 基于模块化组件设计 -->
    <link href="/static/css/main.css" rel="stylesheet">
    <!-- Chart.js for modern charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <!-- TinyMCE Editor -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- 公司管理模块 -->
    <script src="/static/js/company-config.js"></script>
    <script src="/static/js/company-manager.js"></script>

    <!-- 第一阶段重构：性能优化管理器 (解决死机问题) -->
    <script src="/static/js/timer-manager.js"></script>
    <script src="/static/js/progress-manager.js"></script>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <!-- 侧边栏切换按钮 -->
            <button class="btn sidebar-toggle-btn me-3" type="button" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>

            <div class="navbar-brand d-flex align-items-center">
                <!-- 中国联通官方Logo -->
                <div class="unicom-logo me-3">
                    <svg width="120" height="40" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="unicomKnotGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#e60012;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#d10000;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#c00000;stop-opacity:1" />
                            </linearGradient>
                        </defs>

                        <!-- 中国联通结绳标志 -->
                        <g transform="translate(5, 5)">
                            <!-- 中心圆形 -->
                            <circle cx="25" cy="25" r="4" fill="url(#unicomKnotGradient)"/>

                            <!-- 左侧结绳 -->
                            <path d="M10 15 Q5 10 10 5 Q15 10 20 5 Q25 10 20 15 Q15 20 20 25 Q25 20 20 15"
                                  fill="url(#unicomKnotGradient)" stroke="none"/>

                            <!-- 右侧结绳 -->
                            <path d="M30 15 Q35 10 40 15 Q35 20 40 25 Q35 30 30 25 Q25 20 30 15"
                                  fill="url(#unicomKnotGradient)" stroke="none"/>

                            <!-- 上侧结绳 -->
                            <path d="M15 10 Q10 5 15 0 Q20 5 25 0 Q30 5 25 10 Q20 15 25 20 Q30 15 25 10"
                                  fill="url(#unicomKnotGradient)" stroke="none"/>

                            <!-- 下侧结绳 -->
                            <path d="M15 40 Q10 45 15 50 Q20 45 25 50 Q30 45 25 40 Q20 35 25 30 Q30 35 25 40"
                                  fill="url(#unicomKnotGradient)" stroke="none"/>

                            <!-- 装饰性连接线 -->
                            <path d="M15 25 Q20 20 25 25 Q30 30 35 25 Q30 20 25 25 Q20 30 15 25"
                                  fill="url(#unicomKnotGradient)" opacity="0.8" stroke="none"/>
                        </g>

                        <!-- 中国联通文字 -->
                        <g transform="translate(60, 8)">
                            <!-- 中国联通 -->
                            <text x="0" y="18" fill="#333" font-family="PingFang SC, Microsoft YaHei, sans-serif" font-size="16" font-weight="bold">中国联通</text>
                            <!-- China Unicom -->
                            <text x="0" y="35" fill="#666" font-family="Arial, sans-serif" font-size="11" font-weight="normal">China unicom</text>
                        </g>
                    </svg>
                </div>

                <div class="brand-text ms-2">
                    <h4 class="mb-0 brand-title">元景AI智能标书生成平台</h4>
                    <small class="text-muted brand-subtitle">Powered by China Unicom</small>
                </div>
            </div>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-grid-3x3-gap me-2"></i>
                            应用菜单
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item active" href="/"><i class="bi bi-house me-2"></i>标书生成</a></li>
                            <li><a class="dropdown-item" href="/knowledge_base"><i class="bi bi-collection me-2"></i>知识库管理</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>系统设置</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-muted" href="#" title="通知">
                            <i class="bi bi-bell"></i>
                            <span class="badge bg-danger badge-sm">2</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-muted" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> 用户
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>个人信息</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>系统设置</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 主体布局 -->
    <div class="d-flex" id="wrapper">
        <!-- 侧边栏 -->
        <div class="bg-light border-end" id="sidebar-wrapper">
            <div class="list-group list-group-flush" style="padding-top: 1rem;">
                <a href="#" class="list-group-item list-group-item-action active" id="home-nav" data-bs-toggle="pill" data-bs-target="#home">
                    <i class="bi bi-house me-2"></i>首页
                </a>
                <a href="#" class="list-group-item list-group-item-action" id="tender-info-nav" data-bs-toggle="pill" data-bs-target="#tender-info">
                    <i class="bi bi-upload me-2"></i>上传标书
                </a>
                <a href="#" class="list-group-item list-group-item-action" id="business-response-nav" data-bs-toggle="pill" data-bs-target="#business-response">
                    <i class="bi bi-briefcase me-2"></i>商务应答
                </a>
                <a href="#" class="list-group-item list-group-item-action" id="point-to-point-nav" data-bs-toggle="pill" data-bs-target="#point-to-point">
                    <i class="bi bi-chat-dots me-2"></i>点对点应答
                </a>
                <a href="#" class="list-group-item list-group-item-action" id="tech-proposal-nav" data-bs-toggle="pill" data-bs-target="#tech-proposal">
                    <i class="bi bi-file-earmark-code me-2"></i>技术方案生成
                </a>
                <a href="/knowledge_base?action=company_management" class="list-group-item list-group-item-action">
                    <i class="bi bi-building me-2"></i>公司管理
                </a>
                <a href="/knowledge_base" class="list-group-item list-group-item-action">
                    <i class="bi bi-collection me-2"></i>知识库管理
                </a>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div id="page-content-wrapper">
            <div class="container-fluid p-4">

        <div class="tab-content" id="mainTabContent">
            <!-- 首页选项卡 -->
            <div class="tab-pane fade show active" id="home" role="tabpanel">
                <!-- 系统统计面板 -->
                <div class="row mb-5">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-bar-chart"></i> 系统统计
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-3 col-md-6 mb-4">
                                        <div class="stat-card text-center">
                                            <div class="stat-icon mb-3">
                                                <i class="bi bi-file-text fs-1"></i>
                                            </div>
                                            <div class="stat-number">137</div>
                                            <div class="stat-label">模型总数</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-4">
                                        <div class="stat-card text-center bg-info">
                                            <div class="stat-icon mb-3">
                                                <i class="bi bi-cpu fs-1"></i>
                                            </div>
                                            <div class="stat-number">0</div>
                                            <div class="stat-label">我的模型</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-4">
                                        <div class="stat-card text-center bg-warning">
                                            <div class="stat-icon mb-3">
                                                <i class="bi bi-clock-history fs-1"></i>
                                            </div>
                                            <div class="stat-number">0</div>
                                            <div class="stat-label">调用次数</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-4">
                                        <div class="stat-card text-center bg-success">
                                            <div class="stat-icon mb-3">
                                                <i class="bi bi-check-circle fs-1"></i>
                                            </div>
                                            <div class="stat-number">100%</div>
                                            <div class="stat-label">成功率</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 图表区域 -->
                                <div class="row mt-4">
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-muted mb-3">模型使用趋势</h6>
                                        <canvas id="usageChart" height="200"></canvas>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-muted mb-3">调用类型分布</h6>
                                        <canvas id="typeChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 快速操作面板 -->
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-search text-primary display-1"></i>
                                <h5 class="mt-3">智能提取</h5>
                                <p class="text-muted">AI自动识别招标文件中的关键信息</p>
                                <button class="btn btn-primary" onclick="switchToTab('tender-info')">
                                    开始提取
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-briefcase text-success display-1"></i>
                                <h5 class="mt-3">商务应答</h5>
                                <p class="text-muted">生成专业的商务应答文档</p>
                                <button class="btn btn-success" onclick="switchToTab('business-response')">
                                    立即生成
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-building text-warning display-1"></i>
                                <h5 class="mt-3">公司管理</h5>
                                <p class="text-muted">管理公司信息和资质文件</p>
                                <button class="btn btn-warning" onclick="window.location.href='/knowledge_base?action=company_management';">
                                    管理公司
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 精简版权信息 -->
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="text-center py-3 border-top">
                            <small class="text-muted">
                                © 2025 元景AI智能标书生成平台 |
                                <a href="/help.html" class="text-decoration-none text-muted">
                                    <i class="bi bi-question-circle"></i> 帮助
                                </a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 上传标书选项卡 -->
            <div class="tab-pane fade" id="tender-info" role="tabpanel">

            <!-- 文件上传区域 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-cloud-upload"></i> 招标文档上传
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="tenderUploadArea">
                                <i class="bi bi-cloud-upload-fill text-primary display-1"></i>
                                <h5 class="mt-3">拖放招标文档到此处</h5>
                                <p class="text-muted mb-3">或点击选择文件</p>
                                <p class="text-muted small">
                                    支持格式：Word文档 (.docx, .doc)、文本文件 (.txt)、PDF文件 (.pdf)
                                </p>
                                <input type="file" class="d-none" id="tenderFileInput"
                                       accept=".docx,.doc,.txt,.pdf">
                            </div>

                            <!-- 文件信息显示 -->
                            <div class="mt-3 d-none" id="tenderFileInfo">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    已选择文件：<strong id="tenderFileName"></strong>
                                    <span class="text-muted" id="tenderFileSize"></span>
                                </div>
                            </div>

                            <!-- 提取按钮 -->
                            <div class="text-center mt-4">
                                <button class="btn btn-primary btn-lg" type="button" id="extractInfoBtn" disabled>
                                    <i class="bi bi-play-circle"></i> 开始提取信息
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 进度条 -->
            <div class="progress mb-2 d-none" id="tenderProgressBar">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <div class="text-center mb-4 d-none text-primary" id="stepMessage">
                正在提取招标信息...
            </div>

            <!-- 提取结果显示 -->
            <div class="row d-none" id="tenderResultArea">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-check-circle"></i> 招标信息提取完成
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="tenderInfoDisplay">
                                <!-- 提取结果将在这里显示 -->
                            </div>

                            <!-- 拆分文件显示区域 -->
                            <div id="splitDocumentsArea" class="d-none">
                                <hr>
                                <h6 class="mb-3">
                                    <i class="bi bi-file-earmark-break"></i> 文档拆分结果
                                </h6>
                                <div class="row" id="splitDocumentsList">
                                    <!-- 拆分文件将在这里显示 -->
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button class="btn btn-outline-success me-2" id="tenderRetryBtn">
                                    <i class="bi bi-arrow-clockwise"></i> 重新提取
                                </button>
                                <button class="btn btn-outline-secondary" id="tenderResetBtn">
                                    <i class="bi bi-x-circle"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 错误信息显示 -->
            <div class="row d-none" id="tenderErrorArea">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> 提取失败
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger mb-3">
                                <p id="tenderErrorAreaMessage"></p>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-outline-danger me-2" id="tenderRetryBtn2">
                                    <i class="bi bi-arrow-clockwise"></i> 重试
                                </button>
                                <button class="btn btn-outline-secondary" id="tenderResetBtn2">
                                    <i class="bi bi-x-circle"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- 功能特点 -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-search text-info" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">智能提取</h5>
                            <p class="card-text text-muted">AI自动识别招标文件中的关键信息</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-list-check text-success" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">完整字段</h5>
                            <p class="card-text text-muted">提取招标人、代理、时间等8个关键字段</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-gear text-warning" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">配置保存</h5>
                            <p class="card-text text-muted">自动保存提取结果到配置文件</p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- 功能说明 -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i> 功能说明
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>📄 提取字段</h6>
                                    <ul>
                                        <li>招标人（采购人/甲方）</li>
                                        <li>招标代理（代理机构）</li>
                                        <li>投标方式（公开招标等）</li>
                                        <li>投标地点（递交地点）</li>
                                        <li>投标时间（截止时间）</li>
                                        <li>中标人数量（预计数量）</li>
                                        <li>项目名称</li>
                                        <li>项目编号（招标编号）</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>🔧 技术特点</h6>
                                    <ul>
                                        <li>AI智能识别关键信息</li>
                                        <li>支持多种文档格式</li>
                                        <li>正则表达式备用方案</li>
                                        <li>自动保存到配置文件</li>
                                    </ul>
                                    
                                    <h6>⚠️ 注意事项</h6>
                                    <ul>
                                        <li>确保文档内容清晰可读</li>
                                        <li>建议使用标准招标文件格式</li>
                                        <li>提取结果会自动保存到配置文件</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 结束上传标书选项卡 -->


        <!-- 商务应答选项卡 -->
        <div class="tab-pane fade" id="business-response" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-briefcase"></i> 商务应答处理</h6>
                            <small class="text-muted">上传商务应答模板，按选择的公司信息填写投标人名称、项目信息并插入资质证明图片</small>
                        </div>
                        <div class="card-body">
                            <form id="businessResponseForm" enctype="multipart/form-data">
                                <!-- 模板文件上传 -->
                                <div class="mb-3">
                                    <label for="businessTemplateFile" class="form-label">商务应答模板 *</label>
                                    <div class="upload-area" onclick="document.getElementById('businessTemplateFile').click()">
                                        <i class="bi bi-cloud-upload display-4 text-primary"></i>
                                        <h5>点击上传商务应答模板</h5>
                                        <p class="text-muted">支持 .docx, .doc 格式</p>
                                        <input type="file" id="businessTemplateFile" class="form-control d-none" accept=".docx,.doc">
                                    </div>
                                    <div class="mt-2" id="businessTemplateFileName"></div>
                                </div>

                                <!-- 公司选择 -->
                                <div class="mb-3">
                                    <label for="businessCompanySelect" class="form-label">选择应答公司 *</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <select class="form-select" id="businessCompanySelect" style="flex: 1;">
                                            <option value="">请选择公司...</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="window.location.href='/knowledge_base?action=company_management';">
                                            <i class="bi bi-building"></i> 管理公司
                                        </button>
                                    </div>
                                    <!-- 当前选中公司显示 -->
                                    <div class="mt-2">
                                        <small class="text-muted">当前选中：</small>
                                        <span id="selectedCompanyName" class="text-muted">请选择公司</span>
                                    </div>
                                </div>

                                <!-- 项目信息 -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="businessProjectName" class="form-label">项目名称</label>
                                            <input type="text" class="form-control" id="businessProjectName" 
                                                   placeholder="输入项目名称">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="businessTenderNo" class="form-label">招标编号</label>
                                            <input type="text" class="form-control" id="businessTenderNo" 
                                                   placeholder="输入招标编号">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="businessDate" class="form-label">日期</label>
                                    <input type="text" class="form-control" id="businessDate" 
                                           placeholder="例如：2025年 9月 3日">
                                </div>


                                <!-- 处理按钮 -->
                                <button type="submit" class="btn btn-outline-success">
                                    <i class="bi bi-play-fill"></i> 开始处理
                                </button>
                            </form>

                            <!-- 进度条 -->
                            <div class="progress mt-3" id="businessProgress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>

                            <!-- 结果显示 -->
                            <div class="alert alert-success mt-3 d-none" id="businessResult">
                                <h6>处理完成！</h6>
                                <p id="businessResultMessage"></p>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="#" id="businessDownloadLink" class="btn btn-primary">
                                        <i class="bi bi-download"></i> 下载文件
                                    </a>
                                    <button type="button" class="btn btn-success" id="businessPreviewBtn" onclick="previewBusinessDocument()">
                                        <i class="bi bi-eye"></i> 预览文档
                                    </button>
                                    <button type="button" class="btn btn-warning" id="businessEditBtn" onclick="editBusinessDocument()">
                                        <i class="bi bi-pencil-square"></i> 编辑文档
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="businessNextStepBtn">
                                        <i class="bi bi-arrow-right"></i> 下一步：点对点应答
                                    </button>
                                </div>
                            </div>

                            <!-- 错误提示 -->
                            <div class="alert alert-danger mt-3 d-none" id="businessError">
                                <h6>处理失败</h6>
                                <p id="businessErrorMessage"></p>
                            </div>

                            <!-- 处理统计 -->
                            <div class="mt-3 d-none" id="businessStats">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="bi bi-bar-chart"></i> 处理统计</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="businessStatsContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 历史文件 -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-files"></i> 历史文件</h5>
                        </div>
                        <div class="card-body">
                            <div id="businessFilesList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 结束商务应答选项卡 -->

            <!-- 点对点应答选项卡 -->
            <div class="tab-pane fade" id="point-to-point" role="tabpanel">

        <!-- 功能说明 -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>内联回复功能（原地插入应答）</h6>
                    <p class="mb-2">该功能会在原文档中每个需求后<strong>直接插入应答</strong>，特点：</p>
                    <ul class="mb-0 small">
                        <li><strong>原地插入</strong>：应答紧跟在每个需求段落后面</li>
                        <li><strong>灰色底纹标记</strong>：应答内容添加浅灰色背景（RGB 217,217,217），便于识别</li>
                        <li><strong>格式完整保留</strong>：保持原文档的字体、样式、结构不变</li>
                        <li><strong>专业提示词</strong>：使用三种专业模板（点对点/内容生成/标题简化）</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 应答配置区域 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-gear"></i> 应答配置</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- 应答频次 -->
                            <div class="col-md-2">
                                <label for="responseFrequency" class="form-label"><strong>应答频次：</strong></label>
                                <select class="form-select" name="responseFrequency" id="responseFrequency">
                                    <option value="every_paragraph" selected>每段应答</option>
                                    <option value="major_headings">针对大标题条目应答</option>
                                </select>
                            </div>

                            <!-- 应答方式 -->
                            <div class="col-md-2">
                                <label for="responseMode" class="form-label"><strong>应答方式：</strong></label>
                                <select class="form-select" name="responseMode" id="responseMode">
                                    <option value="ai" selected>AI模型应答</option>
                                    <option value="simple">简单应答</option>
                                </select>
                            </div>

                            <!-- AI模型选择 -->
                            <div class="col-md-8" id="aiModelSelection">
                                <label for="aiModel" class="form-label">
                                    <strong>选择AI模型：</strong>
                                    <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="refreshModels()">
                                        <i class="bi bi-arrow-clockwise"></i> 刷新
                                    </button>
                                </label>
                                <select class="form-select" name="aiModel" id="aiModel" onchange="onModelChange()">
                                    <optgroup label="始皇API">
                                        <option value="shihuang-gpt4o-mini" selected>始皇-GPT4o迷你版（快速高效）</option>
                                        <option value="shihuang-gpt4">始皇-GPT4专业版（深度分析）</option>
                                    </optgroup>
                                    <optgroup label="联通元景">
                                        <option value="yuanjing-deepseek-v3">元景-DeepSeek-V3</option>
                                        <option value="yuanjing-qwen-235b">元景-通义千问235B</option>
                                    </optgroup>
                                </select>
                                <div id="modelStatus" class="mt-2 d-none">
                                    <small class="text-muted">
                                        <span id="modelStatusIcon"></span>
                                        <span id="modelStatusText"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文件上传区域 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-upload"></i> 文档上传处理</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click();">
                                <i class="bi bi-cloud-upload text-primary" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">拖拽文档到这里或点击选择</h4>
                                <p class="text-muted">支持 .docx 和 .doc 格式，最大 50MB</p>
                                <input type="file" class="d-none" id="fileInput" name="file" accept=".docx,.doc">
                                <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('fileInput').click();">
                                    <i class="bi bi-folder2-open"></i> 选择文件
                                </button>
                            </div>

                            <div id="fileInfo" class="mt-3 d-none">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <span id="fileName"></span>
                                    <span id="fileSize" class="text-muted ms-2"></span>
                                </div>
                            </div>

                            <div class="mt-3">
                                <button type="submit" class="btn btn-success btn-lg" id="processBtn" disabled>
                                    <i class="bi bi-play-circle"></i> 开始处理
                                </button>
                            </div>
                        </form>
                        
                        <!-- 进度条 -->
                        <div class="progress mt-3" id="progressBar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <!-- 结果区域 -->
                        <div id="resultArea" class="mt-4 d-none">
                            <div class="alert alert-success">
                                <h5><i class="bi bi-check-circle"></i> 处理完成！</h5>
                                <p id="resultMessage"></p>
                                <div class="d-flex gap-2 flex-wrap mt-3">
                                    <button id="downloadBtn" class="btn btn-primary">
                                        <i class="bi bi-download"></i> 下载处理后的文档
                                    </button>
                                    <button type="button" class="btn btn-success" id="pointPreviewBtn" onclick="previewPointDocument()">
                                        <i class="bi bi-eye"></i> 预览文档
                                    </button>
                                    <button type="button" class="btn btn-warning" id="pointEditBtn" onclick="editPointDocument()">
                                        <i class="bi bi-pencil-square"></i> 编辑文档
                                    </button>
                                    <button id="viewFilesBtn" class="btn btn-outline-info">
                                        <i class="bi bi-file-earmark-text"></i> 查看所有文件
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 错误区域 -->
                        <div id="errorArea" class="mt-4 d-none">
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-exclamation-triangle"></i> 处理失败</h5>
                                <p id="errorMessage"></p>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-primary" id="retryBtn">
                                        <i class="bi bi-arrow-clockwise"></i> 重试
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                                        <i class="bi bi-arrow-counterclockwise"></i> 重新选择文件
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 历史文件列表 -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-files"></i> 历史文件</h5>
                    </div>
                    <div class="card-body">
                        <div id="pointHistoryFilesList">
                            <p class="text-muted">正在加载历史文件...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


                <!-- 功能特点 -->
        <div class="row mb-5">
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-lightning-charge text-warning" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">智能识别</h5>
                        <p class="card-text text-muted">自动识别文档中的需求条目，减少遗漏</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-cpu text-primary" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">AI生成</h5>
                        <p class="card-text text-muted">使用先进AI模型生成专业技术应答</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-palette text-success" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">格式美化</h5>
                        <p class="card-text text-muted">自动设置字体、颜色、底纹和行距</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-question-circle"></i> 使用说明</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>📋 支持的文档格式</h6>
                                <ul>
                                    <li>Microsoft Word 文档 (.docx)</li>
                                    <li>Microsoft Word 97-2003 文档 (.doc)</li>
                                    <li>文档大小限制：50MB</li>
                                </ul>
                                
                                <h6>🎯 处理功能</h6>
                                <ul>
                                    <li>自动识别采购需求条目</li>
                                    <li>生成"应答：满足。"格式的专业应答</li>
                                    <li>保持原文档格式和字体</li>
                                    <li>应答内容：黑色字体，灰色底纹，1.5倍行距</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>🔧 系统配置</h6>
                                <ul>
                                    <li>使用GPT-4o-mini模型获得专业的应答效果</li>
                                    <li>支持多种文档格式的智能处理</li>
                                </ul>
                                
                                <h6>⚠️ 注意事项</h6>
                                <ul>
                                    <li>处理时间视文档大小和复杂度而定</li>
                                    <li>请确保网络连接稳定</li>
                                    <li>建议备份原始文档</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- 结束点对点应答选项卡 -->

        <!-- 技术方案生成选项卡 -->
        <div class="tab-pane fade" id="tech-proposal" role="tabpanel">

            <!-- 文件上传区域 -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-upload"></i> 技术方案生成</h6>
                        </div>
                        <div class="card-body">
                            <form id="techProposalForm" enctype="multipart/form-data">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="upload-area tech-upload" data-type="tender" onclick="document.getElementById('techTenderFileInput').click();">
                                            <i class="bi bi-file-earmark-check text-primary" style="font-size: 2rem;"></i>
                                            <h5 class="mt-2">招标文件</h5>
                                            <p class="text-muted mb-3">上传招标文件或需求文档</p>
                                            <input type="file" class="d-none" id="techTenderFileInput" name="tender_file" accept=".docx,.doc,.pdf">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="event.stopPropagation(); document.getElementById('techTenderFileInput').click();">
                                                <i class="bi bi-folder2-open"></i> 选择招标文件
                                            </button>
                                            <div id="techTenderFileInfo" class="mt-2 d-none">
                                                <small class="text-success"><i class="bi bi-check-circle"></i> <span id="techTenderFileName"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="upload-area tech-upload" data-type="product" onclick="document.getElementById('productFileInput').click();">
                                            <i class="bi bi-file-earmark-code text-info" style="font-size: 2rem;"></i>
                                            <h5 class="mt-2">产品文档</h5>
                                            <p class="text-muted mb-3">上传产品功能说明文档</p>
                                            <input type="file" class="d-none" id="productFileInput" name="product_file" accept=".docx,.doc,.pdf">
                                            <button type="button" class="btn btn-info btn-sm" onclick="event.stopPropagation(); document.getElementById('productFileInput').click();">
                                                <i class="bi bi-folder2-open"></i> 选择产品文档
                                            </button>
                                            <div id="productFileInfo" class="mt-2 d-none">
                                                <small class="text-success"><i class="bi bi-check-circle"></i> <span id="productFileName"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="outputPrefix" class="form-label">输出文件前缀</label>
                                        <input type="text" class="form-control" id="outputPrefix" name="output_prefix" value="技术方案" placeholder="输入文件名前缀">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button type="submit" class="btn btn-success btn-lg flex-fill" id="generateProposalBtn" disabled>
                                            <i class="bi bi-play-circle"></i> 生成技术方案
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- 进度条 -->
                            <div class="progress mt-3 d-none" id="techProgressBar">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            
                            <!-- 结果区域 -->
                            <div id="techResultArea" class="mt-4 d-none">
                                <div class="alert alert-success">
                                    <h6 class="mb-0"><i class="bi bi-check-circle"></i> 技术方案生成完成！</h6>
                                    <p id="techResultMessage"></p>
                                    <div id="techDownloadArea" class="mt-3">
                                        <!-- 下载按钮将动态生成 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 错误区域 -->
                            <div id="techErrorArea" class="mt-4 d-none">
                                <div class="alert alert-danger">
                                    <h5><i class="bi bi-exclamation-triangle"></i> 生成失败</h5>
                                    <p id="techErrorMessage"></p>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-primary" id="techRetryBtn">
                                            <i class="bi bi-arrow-clockwise"></i> 重试
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="techResetBtn">
                                            <i class="bi bi-arrow-counterclockwise"></i> 重新选择文件
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 技术方案功能特点 -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-file-earmark-text text-info" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">智能解析</h5>
                            <p class="card-text text-muted">自动解析招标文件和产品文档，提取关键信息</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-gear-wide-connected text-warning" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">智能匹配</h5>
                            <p class="card-text text-muted">精确匹配产品功能与招标需求</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-journal-text text-success" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">方案生成</h5>
                            <p class="card-text text-muted">自动生成完整的技术方案文档</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 技术方案使用说明 -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-question-circle"></i> 技术方案生成说明</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>📋 支持的文档格式</h6>
                                    <ul>
                                        <li>Word文档 (.docx, .doc)</li>
                                        <li>PDF文档 (.pdf)</li>
                                        <li>文档大小限制：50MB</li>
                                    </ul>
                                    
                                    <h6>🎯 生成功能</h6>
                                    <ul>
                                        <li>自动解析招标需求和产品功能</li>
                                        <li>智能匹配需求与功能特性</li>
                                        <li>生成完整的技术方案大纲</li>
                                        <li>输出专业的Word格式方案文档</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>📊 输出文件</h6>
                                    <ul>
                                        <li>技术方案文档 (.docx)</li>
                                        <li>方案大纲 (.json)</li>
                                        <li>匹配度报告 (.json)</li>
                                        <li>完整数据 (.json)</li>
                                    </ul>
                                    
                                    <h6>⚠️ 注意事项</h6>
                                    <ul>
                                        <li>需要上传招标文件和产品文档</li>
                                        <li>生成时间较长，请耐心等待</li>
                                        <li>建议使用格式规范的文档</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 结束技术方案选项卡 -->


        </div>
        <!-- 结束选项卡内容 -->

    </div>

    <!-- API密钥备份管理模态框 -->
    <div class="modal fade" id="apiBackupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock"></i> API密钥备份管理
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6>当前密钥</h6>
                            <div class="input-group">
                                <input type="password" class="form-control" id="currentApiKey" readonly>
                                <button class="btn btn-outline-primary" type="button" id="backupCurrentBtn">
                                    <i class="bi bi-cloud-upload"></i> 备份到服务器
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>已保存的备份</h6>
                    <div id="backupList" class="mt-3">
                        <div class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i> 正在加载备份列表...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局错误处理 - 捕获所有TypeError并给出友好提示
        window.addEventListener('error', function(e) {
            if (e.error && e.error.message && e.error.message.includes("Cannot read properties of null")) {
                console.warn('捕获到null元素错误，但已处理:', e.error.message);
                e.preventDefault(); // 阻止错误显示在控制台
                return true;
            }
        });

        // 安全的事件绑定函数，避免null元素错误
        function safeAddEventListener(elementId, eventType, handler) {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener(eventType, handler);
                return true;
            } else {
                console.log(`元素 ${elementId} 不存在，跳过 ${eventType} 事件绑定`);
                return false;
            }
        }

        // 重写document.getElementById以添加安全检查
        // 移除有问题的getElementById重写，使用原生方法
        // DOM元素引用 - 使用安全的元素获取方式
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const progressBar = document.getElementById('progressBar');
        const resultArea = document.getElementById('resultArea');
        const errorArea = document.getElementById('errorArea');
        const uploadForm = document.getElementById('uploadForm');
        // API密钥现在通过环境变量自动配置
        
        // API密钥相关元素（为了保持兼容性，创建虚拟元素）
        const apiKeyInput = { value: '', type: 'password' };
        const toggleApiBtn = { addEventListener: () => {}, innerHTML: '' };
        const saveApiBtn = { addEventListener: () => {} };
        const loadApiBtn = { addEventListener: () => {} };

        // API密钥安全管理
        const API_STORAGE_KEY = 'ai_tender_api_key_encrypted';
        
        // 简单的加密/解密函数（基于Base64和简单混淆）
        function encryptApiKey(key) {
            if (!key) return '';
            const encoded = btoa(unescape(encodeURIComponent(key)));
            return encoded.split('').reverse().join('');
        }
        
        function decryptApiKey(encrypted) {
            if (!encrypted) return '';
            try {
                const reversed = encrypted.split('').reverse().join('');
                return decodeURIComponent(escape(atob(reversed)));
            } catch (e) {
                console.error('解密失败:', e);
                return '';
            }
        }

        // 页面加载时尝试加载保存的API密钥或使用默认密钥
        window.addEventListener('load', function() {
            const defaultKey = '{{ default_api_key }}';
            const saved = localStorage.getItem(API_STORAGE_KEY);

            if (saved) {
                const decrypted = decryptApiKey(saved);
                if (decrypted) {
                    apiKeyInput.value = decrypted;
                    // document.getElementById('tenderApiKey').value = decrypted;  // API密钥从环境变量获取
                    showNotification('已加载保存的API密钥', 'success');
                    return;
                }
            }

            // 如果没有保存的密钥，使用默认密钥
            if (defaultKey && defaultKey !== 'None') {
                apiKeyInput.value = defaultKey;
                // document.getElementById('tenderApiKey').value = defaultKey;  // API密钥从环境变量获取
                showNotification('已加载默认API密钥', 'info');
            }
        });

        // 显示/隐藏API密钥
        toggleApiBtn.addEventListener('click', function() {
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            this.innerHTML = isPassword ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
        });

        // 保存API密钥
        saveApiBtn.addEventListener('click', function() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showNotification('请先输入API密钥', 'error');
                return;
            }
            
            const encrypted = encryptApiKey(apiKey);
            localStorage.setItem(API_STORAGE_KEY, encrypted);
            showNotification('API密钥已安全保存到本地', 'success');
        });

        // 加载API密钥
        loadApiBtn.addEventListener('click', function() {
            const saved = localStorage.getItem(API_STORAGE_KEY);
            if (saved) {
                const decrypted = decryptApiKey(saved);
                if (decrypted) {
                    apiKeyInput.value = decrypted;
                    showNotification('API密钥加载成功', 'success');
                } else {
                    showNotification('API密钥解密失败', 'error');
                }
            } else {
                showNotification('未找到保存的API密钥', 'error');
            }
        });

        // 管理API密钥备份
        const manageApiBtn = document.getElementById('manageApiBtn');
        if (manageApiBtn) {
            manageApiBtn.addEventListener('click', function() {
                const currentApiKey = document.getElementById('currentApiKey');
                if (currentApiKey) {
                    currentApiKey.value = apiKeyInput.value;
                }
                loadBackupList();
                const apiBackupModal = document.getElementById('apiBackupModal');
                if (apiBackupModal) {
                    new bootstrap.Modal(apiBackupModal).show();
                }
            });
        }

        // 备份当前密钥到服务器
        const backupCurrentBtn = document.getElementById('backupCurrentBtn');
        if (backupCurrentBtn) {
            backupCurrentBtn.addEventListener('click', function() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showNotification('请先输入API密钥', 'error');
                    return;
                }
                
                const btn = this;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 备份中...';
                btn.disabled = true;
                
                fetch('/api/save-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ api_key: apiKey })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        loadBackupList(); // 刷新备份列表
                    } else {
                        showNotification(data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('备份失败: ' + error.message, 'error');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            });
        }

        // 加载备份列表
        function loadBackupList() {
            const backupList = document.getElementById('backupList');
            backupList.innerHTML = '<div class="text-center text-muted"><i class="bi bi-hourglass-split"></i> 正在加载备份列表...</div>';
            
            fetch('/api/load-backups')
            .then(response => response.json())
            .then(data => {
                if (data.backups && data.backups.length > 0) {
                    let html = '';
                    data.backups.forEach(backup => {
                        const date = new Date(backup.created_at).toLocaleString('zh-CN');
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <strong>${backup.prefix}</strong>
                                            <small class="text-muted d-block">${backup.description}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">${date}</small>
                                        </div>
                                        <div class="col-md-2 text-end">
                                            <button class="btn btn-sm btn-outline-primary restore-backup-btn" 
                                                    data-backup-id="${backup.id}">
                                                <i class="bi bi-download"></i> 恢复
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    backupList.innerHTML = html;
                    
                    // 绑定恢复按钮事件
                    document.querySelectorAll('.restore-backup-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const backupId = this.dataset.backupId;
                            restoreApiKey(backupId);
                        });
                    });
                } else {
                    backupList.innerHTML = '<div class="text-center text-muted"><i class="bi bi-inbox"></i> 暂无备份记录</div>';
                }
            })
            .catch(error => {
                backupList.innerHTML = '<div class="text-center text-danger">加载失败: ' + error.message + '</div>';
            });
        }

        // 恢复API密钥
        function restoreApiKey(backupId) {
            fetch(`/api/restore-key/${backupId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    apiKeyInput.value = data.api_key;
                    document.getElementById('currentApiKey').value = data.api_key;
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('恢复失败: ' + error.message, 'error');
            });
        }

        // 下载文件函数
        function downloadFile(url, filename) {
            try {
                showNotification('开始下载...', 'info');
                
                // 创建隐藏的下载链接
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || '';
                link.style.display = 'none';
                
                // 添加到DOM并触发下载
                document.body.appendChild(link);
                link.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(link);
                    showNotification('下载已开始', 'success');
                }, 100);
                
            } catch (error) {
                console.error('下载失败:', error);
                showNotification('下载失败: ' + error.message, 'error');
            }
        }

        // 查看所有文件
        document.getElementById('viewFilesBtn').addEventListener('click', function() {
            fetch('/api/files')
            .then(response => response.json())
            .then(data => {
                if (data.files && data.files.length > 0) {
                    let fileList = '可下载的文件：\n\n';
                    data.files.forEach((file, index) => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        fileList += `${index + 1}. ${file.name}\n   大小: ${size} MB\n   创建时间: ${date}\n\n`;
                    });
                    alert(fileList);
                } else {
                    alert('暂无可下载的文件');
                }
            })
            .catch(error => {
                console.error('获取文件列表失败:', error);
                alert('获取文件列表失败: ' + error.message);
            });
        });

        // 通知功能
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // 拖拽上传
        if (uploadArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        if (uploadArea) {
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        if (fileInput) {
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                fileName.textContent = file.name;
                fileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                fileInfo.style.display = 'block';
                processBtn.disabled = false;
            }
        }

        // 处理应答方式选择变化
        document.addEventListener('change', function(e) {
            if (e.target.name === 'responseMode') {
                const aiModelSelection = document.getElementById('aiModelSelection');
                if (e.target.value === 'ai') {
                    aiModelSelection.style.display = 'block';
                } else {
                    aiModelSelection.style.display = 'none';
                }
            }
        });

        // API测试
        const testApiBtn = document.getElementById('testApiBtn');
        if (testApiBtn) {
            testApiBtn.addEventListener('click', function() {
                const apiKeyElement = document.getElementById('apiKey');
                const apiKey = apiKeyElement ? apiKeyElement.value.trim() : '';
                const btn = this;
                const originalText = btn.innerHTML;
                const statusDiv = document.getElementById('apiStatus');
            
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';
            btn.disabled = true;
            
            fetch('/api/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.style.display = 'block';
                if (data.success) {
                    statusDiv.className = 'api-status success';
                    statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message} (模型: ${data.model})`;
                } else {
                    statusDiv.className = 'api-status error';
                    statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.message}`;
                }
            })
            .catch(error => {
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> 连接失败: ${error.message}`;
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });
        }

        // 重试和重置功能
        const retryBtn = document.getElementById('retryBtn');
        if (retryBtn) {
            retryBtn.addEventListener('click', function() {
                if (uploadForm) {
                    uploadForm.dispatchEvent(new Event('submit'));
                }
            });
        }

        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                if (fileInput) fileInput.value = '';
                if (fileInfo) fileInfo.style.display = 'none';
                if (resultArea) resultArea.style.display = 'none';
                if (errorArea) errorArea.style.display = 'none';
                if (processBtn) {
                    processBtn.disabled = true;
                    processBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始处理';
                }
            });
        }

        // 表单提交处理函数
        function submitUpload() {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            // 从StateManager获取当前公司ID
            const companyId = StateManager.getCompanyId();
            if (companyId) {
                formData.append('companyId', companyId);
            }

            // 收集点对点应答配置参数
            const responseFrequency = document.getElementById('responseFrequency')?.value || 'every_paragraph';
            const responseMode = document.getElementById('responseMode')?.value || 'simple';
            const aiModel = document.getElementById('aiModel')?.value || 'gpt-4o-mini';

            formData.append('responseFrequency', responseFrequency);
            formData.append('responseMode', responseMode);
            if (responseMode === 'ai') {
                formData.append('aiModel', aiModel);
            }

            // API密钥通过环境变量自动获取，无需前端传递
        
            // 显示进度条
            progressBar.style.display = 'block';
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 处理中...';
            
            // 隐藏之前的结果
            resultArea.style.display = 'none';
            errorArea.style.display = 'none';
            
            // 模拟进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.querySelector('.progress-bar').style.width = progress + '%';
            }, 500);
            
            // 创建超时控制器
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5分钟超时

            fetch('/process-point-to-point', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                document.querySelector('.progress-bar').style.width = '100%';
                
                if (data.success) {
                    document.getElementById('resultMessage').textContent = data.message;
                    
                    // 设置下载按钮事件
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (data.download_url && data.filename) {
                        // 存储下载信息到按钮的data属性
                        downloadBtn.setAttribute('data-download-url', data.download_url);
                        downloadBtn.setAttribute('data-filename', data.filename);

                        downloadBtn.onclick = function(e) {
                            e.preventDefault();
                            downloadFile(data.download_url, data.filename);
                        };
                    } else {
                        downloadBtn.onclick = function(e) {
                            e.preventDefault();
                            showNotification('下载链接无效', 'error');
                        };
                    }
                    
                    resultArea.style.display = 'block';
                } else {
                    document.getElementById('errorMessage').textContent = data.error || '处理失败';
                    errorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = '上传失败: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += '请求超时，文档过大或网络不稳定。建议：1) 检查网络连接 2) 尝试更小的文档 3) 点击重试';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += '网络连接失败，请检查网络状态后重试';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('errorMessage').textContent = errorMsg;
                errorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    document.querySelector('.progress-bar').style.width = '0%';
                    processBtn.disabled = false;
                    processBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始处理';
                }, 1000);
            });
        }

        // 表单提交事件
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitUpload();
            });
        }

        // ================================
        // 技术方案相关功能
        // ================================
        
        // 技术方案表单元素
        const techProposalForm = document.getElementById('techProposalForm');
        const techTenderFileInput = document.getElementById('techTenderFileInput');
        const productFileInput = document.getElementById('productFileInput');
        const generateProposalBtn = document.getElementById('generateProposalBtn');
        const techProgressBar = document.getElementById('techProgressBar');
        const techResultArea = document.getElementById('techResultArea');
        const techErrorArea = document.getElementById('techErrorArea');

        // 技术方案文件选择处理
        if (techTenderFileInput) {
            techTenderFileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const fileNameElement = document.getElementById('techTenderFileName');
                    const fileInfoElement = document.getElementById('techTenderFileInfo');
                    if (fileNameElement) fileNameElement.textContent = file.name;
                    if (fileInfoElement) fileInfoElement.style.display = 'block';
                    checkTechFormReady();
                }
            });
        }

        if (productFileInput) {
            productFileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const fileNameElement = document.getElementById('productFileName');
                    const fileInfoElement = document.getElementById('productFileInfo');
                    if (fileNameElement) fileNameElement.textContent = file.name;
                    if (fileInfoElement) fileInfoElement.style.display = 'block';
                    checkTechFormReady();
                }
            });
        }

        function checkTechFormReady() {
            const hasTenderFile = techTenderFileInput && techTenderFileInput.files.length > 0;
            const hasProductFile = productFileInput && productFileInput.files.length > 0;
            if (generateProposalBtn) {
                generateProposalBtn.disabled = !(hasTenderFile && hasProductFile);
            }
        }

        // 技术方案表单提交
        if (techProposalForm) {
            techProposalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitTechProposal();
            });
        }

        function submitTechProposal() {
            const formData = new FormData();
            formData.append('tender_file', techTenderFileInput.files[0]);
            formData.append('product_file', productFileInput.files[0]);
            formData.append('output_prefix', document.getElementById('outputPrefix').value.trim() || '技术方案');
            // API密钥通过环境变量自动获取

            // 显示进度条
            techProgressBar.style.display = 'block';
            generateProposalBtn.disabled = true;
            generateProposalBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 生成中...';
            
            // 隐藏之前的结果
            techResultArea.style.display = 'none';
            techErrorArea.style.display = 'none';
            
            // 模拟进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                document.querySelector('#techProgressBar .progress-bar').style.width = progress + '%';
            }, 1000);
            
            // 创建超时控制器
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 600000); // 10分钟超时

            fetch('/generate-proposal', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                document.querySelector('#techProgressBar .progress-bar').style.width = '100%';
                
                if (data.success) {
                    document.getElementById('techResultMessage').innerHTML = `
                        <strong>生成统计：</strong><br>
                        • 需求数量：${data.requirements_count || 0}<br>
                        • 功能数量：${data.features_count || 0}<br>
                        • 匹配数量：${data.matches_count || 0}<br>
                        • 章节数量：${data.sections_count || 0}<br>
                        • 匹配成功率：${data.match_stats ? Math.round((data.match_stats.matched_requirements / data.requirements_count * 100) || 0) : 0}%
                    `;
                    
                    // 生成下载按钮
                    const downloadArea = document.getElementById('techDownloadArea');
                    downloadArea.innerHTML = '';
                    
                    if (data.output_files) {
                        Object.keys(data.output_files).forEach(fileType => {
                            const filePath = data.output_files[fileType];
                            const fileName = filePath.split('/').pop();
                            
                            let buttonClass = 'btn-primary';
                            let iconClass = 'bi-download';
                            let buttonText = '下载';
                            
                            switch (fileType) {
                                case 'proposal':
                                    buttonClass = 'btn-success';
                                    iconClass = 'bi-file-earmark-word';
                                    buttonText = '下载技术方案';
                                    break;
                                case 'outline':
                                    buttonClass = 'btn-info';
                                    iconClass = 'bi-list-ol';
                                    buttonText = '下载方案大纲';
                                    break;
                                case 'match_report':
                                    buttonClass = 'btn-warning';
                                    iconClass = 'bi-graph-up';
                                    buttonText = '下载匹配报告';
                                    break;
                                case 'full_data':
                                    buttonClass = 'btn-secondary';
                                    iconClass = 'bi-database';
                                    buttonText = '下载完整数据';
                                    break;
                            }
                            
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = `btn ${buttonClass} me-2 mb-2`;
                            downloadBtn.innerHTML = `<i class="${iconClass}"></i> ${buttonText}`;
                            downloadBtn.onclick = function() {
                                downloadFile(`/download-tech/${fileName}`, fileName);
                            };
                            downloadArea.appendChild(downloadBtn);
                        });
                    }
                    
                    techResultArea.style.display = 'block';
                } else {
                    document.getElementById('techErrorMessage').textContent = data.error || '生成失败';
                    techErrorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = '生成失败: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += '请求超时，文档过大或处理时间过长。建议：1) 检查网络连接 2) 尝试更小的文档 3) 点击重试';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += '网络连接失败，请检查网络状态后重试';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('techErrorMessage').textContent = errorMsg;
                techErrorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    techProgressBar.style.display = 'none';
                    document.querySelector('#techProgressBar .progress-bar').style.width = '0%';
                    generateProposalBtn.disabled = false;
                    generateProposalBtn.innerHTML = '<i class="bi bi-play-circle"></i> 生成技术方案';
                }, 1000);
            });
        }

        // 技术方案重试和重置功能
        const techRetryBtn = document.getElementById('techRetryBtn');
        if (techRetryBtn) {
            techRetryBtn.addEventListener('click', function() {
                submitTechProposal();
            });
        }

        const techResetBtn = document.getElementById('techResetBtn');
        if (techResetBtn) {
            techResetBtn.addEventListener('click', function() {
                if (techTenderFileInput) techTenderFileInput.value = '';
                if (productFileInput) productFileInput.value = '';
                
                const techTenderFileInfo = document.getElementById('techTenderFileInfo');
                const productFileInfo = document.getElementById('productFileInfo');
                
                if (techTenderFileInfo) techTenderFileInfo.style.display = 'none';
                if (productFileInfo) productFileInfo.style.display = 'none';
                if (techResultArea) techResultArea.style.display = 'none';
                if (techErrorArea) techErrorArea.style.display = 'none';
                if (generateProposalBtn) {
                    generateProposalBtn.disabled = true;
                    generateProposalBtn.innerHTML = '<i class="bi bi-play-circle"></i> 生成技术方案';
                }
            });
        }

        // ====== 招标信息提取功能 ======
        // 招标信息提取功能初始化（已移动到AppInitializer）
            console.log('Initializing tender info extraction...');
        const tenderUploadArea = document.getElementById('tenderUploadArea');
        const tenderFileInput = document.getElementById('tenderFileInput');
        const tenderFileInfo = document.getElementById('tenderFileInfo');
        const tenderFileName = document.getElementById('tenderFileName');
        const tenderFileSize = document.getElementById('tenderFileSize');
        const extractInfoBtn = document.getElementById('extractInfoBtn');
        const tenderProgressBar = document.getElementById('tenderProgressBar');
        const tenderResultArea = document.getElementById('tenderResultArea');
        const tenderErrorArea = document.getElementById('tenderErrorArea');
        const tenderInfoDisplay = document.getElementById('tenderInfoDisplay');
        
        console.log('Tender elements:', {
            tenderUploadArea,
            tenderFileInput,
            tenderFileInfo,
            tenderFileName,
            tenderFileSize,
            extractInfoBtn
        });

        // 上传区域点击事件
        if (tenderUploadArea && tenderFileInput) {
            tenderUploadArea.addEventListener('click', () => {
                console.log('Tender upload area clicked');
                tenderFileInput.click();
            });
        }

        // 拖拽上传
        if (tenderUploadArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                tenderUploadArea.addEventListener(eventName, preventDefaults, false);
            });
        }

        if (tenderUploadArea) {
            ['dragenter', 'dragover'].forEach(eventName => {
                tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.remove('dragover'), false);
            });

            tenderUploadArea.addEventListener('drop', handleTenderDrop, false);
        }

        function handleTenderDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                tenderFileInput.files = files;
                handleTenderFileSelect();
            }
        }

        if (tenderFileInput) {
            tenderFileInput.addEventListener('change', handleTenderFileSelect);
        }

        function handleTenderFileSelect() {
            console.log('handleTenderFileSelect called');
            const file = tenderFileInput.files[0];
            console.log('Selected file:', file);
            if (file) {
                console.log('File details:', file.name, file.size);
                tenderFileName.textContent = file.name;
                tenderFileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                tenderFileInfo.style.display = 'block';
                extractInfoBtn.disabled = false;
                console.log('File info updated, extract button enabled');
            } else {
                console.log('No file selected');
            }
        }

        // API测试功能已移除 - 使用环境变量API密钥

        // 提取信息按钮事件
        if (extractInfoBtn) {
            extractInfoBtn.addEventListener('click', function() {
                submitTenderExtraction();
            });
        }

        async function performStepwiseExtraction(formData, progressBar, tenderResultArea, tenderErrorArea, progressInterval, timeoutId) {
            try {
                // 确保容器管理器已初始化并清理之前的结果
                if (!tenderContainerManager && tenderResultArea) {
                    tenderContainerManager = new ContainerManager(tenderResultArea);
                }
                
                if (tenderContainerManager) {
                    tenderContainerManager.hideAllContainers();
                } else {
                    // 备用清理逻辑
                    ['basicInfoContainer', 'qualificationContainer', 'technicalContainer'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            const contentElement = element.querySelector('.card-body');
                            if (contentElement) {
                                contentElement.innerHTML = '';
                            }
                        }
                    });
                }
                
                // 步骤1：上传文件并处理
                safeSetTextContent('stepMessage', '正在上传文件...');
                if (progressBar) progressBar.style.width = '20%';
                
                await new Promise(resolve => setTimeout(resolve, 500)); // 模拟延迟
                
                // 步骤2：提取基本信息
                safeSetTextContent('stepMessage', '正在提取基本信息...');
                if (progressBar) progressBar.style.width = '40%';
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // 步骤3：分析资质要求
                safeSetTextContent('stepMessage', '正在分析资质要求...');
                if (progressBar) progressBar.style.width = '70%';
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // 步骤4：提取技术评分
                safeSetTextContent('stepMessage', '正在提取技术评分...');
                if (progressBar) progressBar.style.width = '90%';
                
                // 发送请求到统一的API端点
                const response = await fetch('/extract-tender-info', {
                    method: 'POST',
                    body: formData
                });
                
                // 检查HTTP状态
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    // 使用ErrorHandler来格式化错误信息
                    const errorMsg = ErrorHandler.formatErrorMessage(data.error || data.message || data);
                    throw new Error(errorMsg);
                }
                
                // 处理返回的数据
                const result = data.data;
                
                // 提取基本信息（招标相关的基本字段）
                const basicInfo = {
                    tenderer: result.tenderer,
                    agency: result.agency,
                    bidding_method: result.bidding_method,
                    bidding_location: result.bidding_location,
                    bidding_time: result.bidding_time,
                    winner_count: result.winner_count,
                    project_name: result.project_name,
                    project_number: result.project_number
                };
                
                // 提取资质要求（以qualification_开头的字段）
                const qualificationRequirements = {};
                for (const [key, value] of Object.entries(result)) {
                    if (key.startsWith('qualification_') || key.includes('requirements') || 
                        ['business_license', 'taxpayer_qualification', 'performance_requirements', 
                         'authorization_requirements', 'credit_china', 'commitment_letter', 
                         'audit_report', 'social_security', 'labor_contract', 'other_requirements'].includes(key)) {
                        qualificationRequirements[key] = value;
                    }
                }
                
                // 提取技术评分（以technical_开头的字段或包含scoring的字段）
                const technicalScoring = {};
                for (const [key, value] of Object.entries(result)) {
                    if (key.startsWith('technical_') || key.includes('scoring') || key.includes('score')) {
                        technicalScoring[key] = value;
                    }
                }
                
                // 显示提取结果
                displayBasicInfo(basicInfo);
                displayQualificationRequirements(qualificationRequirements);
                displayTechnicalScoring(technicalScoring);

                // 显示拆分文件（如果有）
                if (data.split_documents && data.split_documents.length > 0) {
                    displaySplitDocuments(data.split_documents);
                }

                // 完成
                if (progressBar) progressBar.style.width = '100%';
                safeSetTextContent('stepMessage', '所有信息提取完成！');
                
                // 清理定时器
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                if (tenderResultArea) tenderResultArea.style.display = 'block';

            } catch (error) {
                throw error;
            }
        }

        function submitTenderExtraction() {
            const formData = new FormData();
            formData.append('file', tenderFileInput.files[0]);
            // API密钥从环境变量获取，无需传递

            // 重置显示区域
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            
            // 显示进度条和步骤消息
            tenderProgressBar.style.display = 'block';
            document.getElementById('stepMessage').style.display = 'block';
            const progressBar = tenderProgressBar.querySelector('.progress-bar');
            
            // 设置按钮状态
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 提取中...';

            // 模拟进度更新
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            // 超时控制
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2分钟超时

            // 分步加载实现
            performStepwiseExtraction(formData, progressBar, tenderResultArea, tenderErrorArea, progressInterval, timeoutId)
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                const errorMsg = ErrorHandler.handleAPIError(error, '提取失败');
                ErrorHandler.displayError('tenderErrorArea', errorMsg);
            })
            .finally(() => {
                setTimeout(() => {
                    tenderProgressBar.style.display = 'none';
                    document.getElementById('stepMessage').style.display = 'none';
                    tenderProgressBar.querySelector('.progress-bar').style.width = '0%';
                    extractInfoBtn.disabled = false;
                    extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始提取信息';
                }, 1000);
            });
        }

        function displayTenderInfo(tenderInfo) {
            const fieldLabels = {
                'tenderer': '招标人',
                'agency': '招标代理',
                'bidding_method': '投标方式',
                'bidding_location': '投标地点',
                'bidding_time': '投标时间',
                'winner_count': '中标人数量',
                'project_name': '项目名称',
                'project_number': '项目编号'
            };

            // 基本信息部分
            let html = '<h5 class="text-primary mb-3"><i class="bi bi-info-circle"></i> 基本信息</h5>';
            let basicInfoHtml = '';
            
            for (const [key, value] of Object.entries(tenderInfo)) {
                if (fieldLabels[key]) {
                    const label = fieldLabels[key];
                    const displayValue = value || '未提取到';
                    const textColor = value ? 'text-success' : 'text-muted';
                    
                    basicInfoHtml += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-info-circle"></i> ${label}
                                    </h6>
                                    <p class="card-text ${textColor}">${displayValue}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            html += `<div class="row">${basicInfoHtml}</div>`;
            
            // 资质要求部分
            if (tenderInfo.qualification_requirements) {
                html += '<hr><h5 class="text-warning mb-3 mt-4"><i class="bi bi-list-check"></i> 资质要求</h5>';
                
                const qualificationLabels = {
                    'business_license': '营业执照',
                    'taxpayer_qualification': '纳税人资格（增值税纳税人）',
                    'performance_requirements': '业绩要求',
                    'authorization_requirements': '授权要求',
                    'credit_china': '信用中国',
                    'commitment_letter': '承诺函（默认满足）',
                    'audit_report': '审计报告（财务要求）',
                    'social_security': '社保要求',
                    'labor_contract': '劳动合同要求',
                    'other_requirements': '其他要求'
                };
                
                let qualHtml = '';
                for (const [key, qualData] of Object.entries(tenderInfo.qualification_requirements)) {
                    if (qualificationLabels[key]) {
                        const label = qualificationLabels[key];
                        const required = qualData.required;
                        const description = qualData.description || '';
                        const statusText = required ? '需要提供' : '不需要提供';
                        const statusColor = required ? 'text-danger' : 'text-success';
                        const iconClass = required ? 'bi-exclamation-triangle' : 'bi-check-circle';
                        
                        qualHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card ${required ? 'border-warning' : 'border-success'}">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi ${iconClass} ${statusColor}"></i> ${label}
                                        </h6>
                                        <p class="card-text ${statusColor} fw-bold">${statusText}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `<div class="row">${qualHtml}</div>`;
            }
            
            // 技术评分部分
            if (tenderInfo.technical_scoring) {
                html += '<hr><h5 class="text-info mb-3 mt-4"><i class="bi bi-graph-up-arrow"></i> 技术评分标准</h5>';
                
                const techScoring = tenderInfo.technical_scoring;
                
                // 技术总分显示
                if (techScoring.total_score) {
                    html += `
                        <div class="alert alert-info">
                            <h6 class="mb-2">
                                <i class="bi bi-trophy"></i> 技术评分总分：
                                <span class="text-primary fw-bold">${techScoring.total_score}</span>
                            </h6>
                            ${techScoring.extraction_summary ? 
                                `<small class="text-muted">${techScoring.extraction_summary}</small>` : ''}
                        </div>
                    `;
                }
                
                // 技术评分项表格
                if (techScoring.items && techScoring.items.length > 0) {
                    html += `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-info">
                                    <tr>
                                        <th style="width: 5%;">序号</th>
                                        <th style="width: 20%;">评分项名称</th>
                                        <th style="width: 10%;">分值</th>
                                        <th style="width: 50%;">评分标准</th>
                                        <th style="width: 15%;">数据来源</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    techScoring.items.forEach((item, index) => {
                        const weightDisplay = item.weight || '未提及';
                        const criteriaDisplay = item.criteria || '未提及';
                        const sourceDisplay = item.source || '未提及';
                        
                        html += `
                            <tr>
                                <td class="text-center fw-bold">${index + 1}</td>
                                <td class="fw-semibold text-primary">${item.name}</td>
                                <td class="text-center">
                                    <span class="badge bg-info">${weightDisplay}</span>
                                </td>
                                <td>
                                    <small class="text-muted">${criteriaDisplay}</small>
                                </td>
                                <td>
                                    <small class="text-secondary">${sourceDisplay}</small>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            未能提取到具体的技术评分项信息
                        </div>
                    `;
                }
            }
            
            tenderInfoDisplay.innerHTML = html;
        }

        // 显示拆分文件
        function displaySplitDocuments(splitDocuments) {
            if (!splitDocuments || splitDocuments.length === 0) {
                return;
            }

            const splitDocumentsArea = document.getElementById('splitDocumentsArea');
            const splitDocumentsList = document.getElementById('splitDocumentsList');

            let html = '';
            splitDocuments.forEach((doc, index) => {
                const iconClass = getDocumentIcon(doc.name);
                html += `
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="split-document-card">
                            <div class="split-document-title">
                                <i class="bi ${iconClass}"></i> ${doc.name}
                            </div>
                            <div class="split-document-meta">
                                文件大小: ${doc.file_size}
                            </div>
                            <div class="split-document-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="previewDocument('${doc.filename}')">
                                    <i class="bi bi-eye"></i> 预览
                                </button>
                                <a href="${doc.download_url}" class="btn btn-sm btn-outline-success" download>
                                    <i class="bi bi-download"></i> 下载
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });

            splitDocumentsList.innerHTML = html;
            splitDocumentsArea.style.display = 'block';
        }

        // 根据文档名称获取图标
        function getDocumentIcon(name) {
            if (name.includes('公告')) return 'bi-megaphone';
            if (name.includes('前附表')) return 'bi-table';
            if (name.includes('评分') || name.includes('评标')) return 'bi-award';
            if (name.includes('格式') || name.includes('响应')) return 'bi-file-text';
            return 'bi-file-earmark-word';
        }

        // 预览文档
        function previewDocument(filename) {
            fetch(`/preview/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 创建预览模态框
                        const modal = document.createElement('div');
                        modal.className = 'modal fade';
                        modal.innerHTML = `
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            <i class="bi bi-eye"></i> 文档预览 - ${filename}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="document-preview-content" style="max-height: 70vh; overflow-y: auto;">
                                            ${data.html_content}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <a href="/download/${filename}" class="btn btn-success" download>
                                            <i class="bi bi-download"></i> 下载文档
                                        </a>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            关闭
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);
                        const bsModal = new bootstrap.Modal(modal);
                        bsModal.show();

                        // 模态框关闭后删除元素
                        modal.addEventListener('hidden.bs.modal', () => {
                            modal.remove();
                        });
                    } else {
                        alert('预览失败: ' + (data.error || '未知错误'));
                    }
                })
                .catch(error => {
                    console.error('预览失败:', error);
                    alert('预览失败: ' + error.message);
                });
        }

        // 招标信息提取重试和重置功能
        document.getElementById('tenderRetryBtn').addEventListener('click', function() {
            submitTenderExtraction();
        });

        document.getElementById('tenderRetryBtn2').addEventListener('click', function() {
            submitTenderExtraction();
        });

        document.getElementById('tenderResetBtn').addEventListener('click', function() {
            tenderFileInput.value = '';
            tenderFileInfo.style.display = 'none';
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            document.getElementById('splitDocumentsArea').style.display = 'none';
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始提取信息';
        });

        document.getElementById('tenderResetBtn2').addEventListener('click', function() {
            tenderFileInput.value = '';
            tenderFileInfo.style.display = 'none';
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            document.getElementById('splitDocumentsArea').style.display = 'none';
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始提取信息';
        });
        // 招标信息提取功能结束

        // ====== 上传标书页面初始化 ======
        // 上传标书页面初始化功能已集成到AppInitializer
        
        // 获取项目信息
        function loadProjectInfo() {
            fetch('/api/project-config')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.projectInfo) {
                    fillProjectInfo(data.projectInfo);
                } else {
                    console.log('No project info found:', data.error || '未知错误');
                }
            })
            .catch(error => {
                console.error('Error loading project info:', error);
            });
        }
        
        // 填充项目信息到商务应答页面
        function fillProjectInfo(projectInfo) {
            // 填充商务应答页面的项目信息
            const projectNameField = document.getElementById('businessProjectName');
            const tenderNoField = document.getElementById('businessTenderNo'); 
            const dateField = document.getElementById('businessDate');
            
            if (projectNameField && projectInfo.projectName) {
                projectNameField.value = projectInfo.projectName;
            }
            
            if (tenderNoField && projectInfo.projectNumber && projectInfo.projectNumber !== '未提供') {
                tenderNoField.value = projectInfo.projectNumber;
            }
            
            // 优先使用投标时间，如果没有则使用当前日期
            if (dateField) {
                if (projectInfo.biddingTime && projectInfo.biddingTime.trim() !== '') {
                    dateField.value = projectInfo.biddingTime;
                } else {
                    // 如果没有投标时间，生成默认日期格式
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    dateField.value = `${year}年${month}月${day}日`;
                }
            }
            
            console.log('Project info loaded:', projectInfo);
        }

        // 公司选择下拉框更新功能已集成到统一的公司管理器中

        // 移除了对上传标书页面不存在元素的事件绑定
        // 注意：公司管理功能现在集中在商务应答页面

        // 加载公司信息
        function loadCompanyInfo(companyId) {
            fetch(`/api/companies/${companyId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.company) {
                    fillCompanyForm(data.company);
                    currentCompanyId = companyId;
                    deleteCompanyBtn.style.display = 'inline-block';
                    
                    // 加载资质文件信息
                    loadCompanyQualifications(companyId);
                    
                    showCompanyMessage('公司信息加载成功', 'success');
                } else {
                    showCompanyMessage('加载公司信息失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                showCompanyMessage('加载公司信息失败: ' + error.message, 'error');
            });
        }

        // 加载公司资质文件信息
        function loadCompanyQualifications(companyId) {
            console.log('[loadCompanyQualifications] 开始加载公司资质，companyId:', companyId);
            fetch(`/api/companies/${companyId}/qualifications`)
            .then(response => response.json())
            .then(data => {
                console.log('[loadCompanyQualifications] API响应数据:', data);
                if (data.success && data.qualifications) {
                    console.log(`[loadCompanyQualifications] 找到 ${Object.keys(data.qualifications).length} 个资质`);
                    // 先清空当前资质信息
                    clearAllQualificationsInternal();
                    
                    // 加载已有的资质信息
                    Object.keys(data.qualifications).forEach(qualKey => {
                        const qualInfo = data.qualifications[qualKey];
                        console.log(`[loadCompanyQualifications] 显示资质 ${qualKey}:`, qualInfo);
                        displayExistingQualification(qualKey, qualInfo);
                    });
                } else {
                    console.log('[loadCompanyQualifications] 无资质信息或加载失败:', data);
                }
            })
            .catch(error => {
                console.error('[loadCompanyQualifications] 加载公司资质失败:', error);
            });
        }

        // 容器管理器类
        class ContainerManager {
            constructor(parentContainer) {
                this.parentContainer = parentContainer;
                this.containers = new Map();
            }
            
            // 安全获取或创建容器
            getOrCreateContainer(id, config) {
                let container = document.getElementById(id);
                
                if (!container && this.parentContainer) {
                    container = this.createContainer(id, config);
                    this.parentContainer.appendChild(container);
                    this.parentContainer.style.display = 'block';
                }
                
                if (container) {
                    this.containers.set(id, container);
                    container.style.display = 'block';
                }
                
                return container;
            }
            
            // 创建容器
            createContainer(id, config) {
                const container = document.createElement('div');
                container.id = id;
                container.className = config.className || 'card border-primary mb-3';
                container.innerHTML = `
                    <div class="card-header ${config.headerClass}">
                        <h6 class="mb-0">${config.icon} ${config.title}</h6>
                    </div>
                    <div class="card-body" id="${config.contentId}">
                    </div>
                `;
                return container;
            }
            
            // 安全获取容器内容区域
            getContentElement(containerId, contentId) {
                const container = this.containers.get(containerId) || document.getElementById(containerId);
                if (!container) {
                    console.warn(`Container ${containerId} not found`);
                    return null;
                }
                
                return container.querySelector(`#${contentId}`) || container.querySelector('.card-body');
            }
            
            // 隐藏所有容器
            hideAllContainers() {
                this.containers.forEach(container => {
                    if (container) {
                        container.style.display = 'none';
                        const contentElement = container.querySelector('.card-body');
                        if (contentElement) {
                            contentElement.innerHTML = '';
                        }
                    }
                });
            }
            
            // 检查父容器是否存在
            isParentAvailable() {
                return this.parentContainer && document.contains(this.parentContainer);
            }
        }
        
        // 全局容器管理器实例
        let tenderContainerManager;
        
        // 安全元素访问辅助函数
        function safeGetElement(id, warn = true) {
            const element = document.getElementById(id);
            if (!element && warn) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }
        
        function safeSetTextContent(id, text, defaultText = '') {
            const element = safeGetElement(id, false);
            if (element) {
                element.textContent = text;
                return true;
            } else {
                console.warn(`Cannot set text content for element '${id}': element not found`);
                return false;
            }
        }
        
        function safeSetInnerHTML(id, html, defaultHTML = '') {
            const element = safeGetElement(id, false);
            if (element) {
                element.innerHTML = html;
                return true;
            } else {
                console.warn(`Cannot set innerHTML for element '${id}': element not found`);
                return false;
            }
        }
        
        // 标准化错误处理
        class ErrorHandler {
            static formatErrorMessage(error) {
                if (typeof error === 'string') {
                    return error;
                }
                
                if (error && typeof error === 'object') {
                    // 尝试多种可能的错误消息字段
                    if (error.message && typeof error.message === 'string') {
                        return error.message;
                    }
                    if (error.error) {
                        if (typeof error.error === 'string') {
                            return error.error;
                        }
                        if (error.error.message && typeof error.error.message === 'string') {
                            return error.error.message;
                        }
                    }
                    if (error.msg && typeof error.msg === 'string') {
                        return error.msg;
                    }
                    if (error.detail && typeof error.detail === 'string') {
                        return error.detail;
                    }
                    
                    // 如果是状态码错误，尝试构造描述性消息
                    if (error.status) {
                        return `HTTP ${error.status} 错误${error.statusText ? ': ' + error.statusText : ''}`;
                    }
                    
                    // 最后尝试JSON序列化，但限制长度
                    try {
                        const jsonStr = JSON.stringify(error);
                        return jsonStr.length > 200 ? '复杂错误对象（请查看控制台）' : jsonStr;
                    } catch (e) {
                        return '无法解析的错误对象';
                    }
                }
                
                return error ? String(error) : '未知错误';
            }
            
            static handleAPIError(error, prefix = '操作失败') {
                // 记录详细错误信息到控制台
                console.error(`${prefix} - 详细错误:`, error);
                
                let errorMsg = `${prefix}: `;
                
                if (error.name === 'AbortError') {
                    errorMsg += '请求超时，文档过大或处理时间过长。建议：1) 检查网络连接 2) 尝试更小的文档 3) 点击重试';
                } else if (error.message && error.message.includes('Failed to fetch')) {
                    errorMsg += '网络连接失败，请检查网络状态后重试';
                } else {
                    errorMsg += this.formatErrorMessage(error);
                }
                
                return errorMsg;
            }
            
            static displayError(containerId, message) {
                const container = safeGetElement(containerId, false);
                if (container) {
                    container.style.display = 'block';
                    safeSetTextContent(containerId + 'Message', message);
                } else {
                    console.error(`Error container ${containerId} not found. Error: ${message}`);
                }
            }
            
            static hideError(containerId) {
                const container = safeGetElement(containerId, false);
                if (container) {
                    container.style.display = 'none';
                }
            }
        }
        
        // 初始化管理器
        class InitializationManager {
            static isReady = false;
            static readyCallbacks = [];
            
            static onReady(callback) {
                if (this.isReady) {
                    callback();
                } else {
                    this.readyCallbacks.push(callback);
                }
            }
            
            static markReady() {
                this.isReady = true;
                this.readyCallbacks.forEach(callback => {
                    try {
                        callback();
                    } catch (error) {
                        console.error('Error in ready callback:', error);
                    }
                });
                this.readyCallbacks = [];
            }
            
            static ensureDOMReady(callback) {
                // 统一初始化：直接执行回调，不再添加新的DOMContentLoaded监听器
                callback();
            }
        }
        
        // 组件状态管理
        const ComponentState = {
            containerManager: null,
            isInitialized: false,
            
            init() {
                if (this.isInitialized) return;
                
                // 初始化全局容器管理器
                const tenderResultArea = safeGetElement('tenderResultArea', false);
                if (tenderResultArea) {
                    this.containerManager = new ContainerManager(tenderResultArea);
                    if (!window.tenderContainerManager) {
                        window.tenderContainerManager = this.containerManager;
                    }
                }
                
                this.isInitialized = true;
                console.log('Component state initialized');
            },
            
            getContainerManager() {
                if (!this.isInitialized) {
                    this.init();
                }
                return this.containerManager || window.tenderContainerManager;
            }
        };
        
        // 分步显示函数
        function displayBasicInfo(basicInfo) {
            // 使用组件状态管理器获取容器管理器
            const containerManager = ComponentState.getContainerManager();
            
            // 检查容器管理器是否可用
            if (!containerManager || !containerManager.isParentAvailable()) {
                console.warn('Container manager not available for basic info');
                return;
            }
            
            // 获取或创建基本信息容器
            const container = containerManager.getOrCreateContainer('basicInfoContainer', {
                className: 'card border-primary mb-3',
                headerClass: 'bg-primary text-white',
                icon: '<i class="bi bi-info-circle"></i>',
                title: '基本信息',
                contentId: 'basicInfoContent'
            });
            
            if (!container) {
                console.warn('Failed to create basicInfoContainer');
                return;
            }
            
            const content = containerManager.getContentElement('basicInfoContainer', 'basicInfoContent');
            let html = '<div class="row">';
            
            const fieldLabels = {
                'project_name': '项目名称',
                'project_number': '项目编号', 
                'tenderer': '招标人',
                'agency': '招标代理',
                'bidding_method': '投标方式',
                'bidding_location': '投标地点',
                'bidding_time': '投标时间',
                'winner_count': '中标人数量'
            };
            
            for (const [field, label] of Object.entries(fieldLabels)) {
                const value = basicInfo[field] || '未提供';
                html += `
                    <div class="col-md-6 mb-2">
                        <strong class="text-muted">${label}:</strong>
                        <span class="ms-2">${value}</span>
                    </div>
                `;
            }
            
            html += '</div>';
            if (content) {
                content.innerHTML = html;
            } else {
                console.warn('basicInfoContent element not found');
            }
        }

        // 使用统一公司管理器获取当前公司ID
        function getCurrentCompanyId() {
            return window.globalCompanyManager ? window.globalCompanyManager.currentCompanyId : null;
        }

        function displayQualificationRequirements(qualRequirements) {
            // 确保容器管理器已初始化
            if (!tenderContainerManager) {
                tenderContainerManager = new ContainerManager(tenderResultArea);
            }

            // 检查父容器是否可用
            if (!tenderContainerManager.isParentAvailable()) {
                console.warn('tenderResultArea not available for qualifications');
                return;
            }

            // 获取或创建资质要求容器
            const container = tenderContainerManager.getOrCreateContainer('qualificationContainer', {
                className: 'card border-warning mb-3',
                headerClass: 'bg-warning',
                icon: '<i class="bi bi-award"></i>',
                title: '资质要求分析',
                contentId: 'qualificationContent'
            });

            if (!container) {
                console.warn('Failed to create qualificationContainer');
                return;
            }

            const content = tenderContainerManager.getContentElement('qualificationContainer', 'qualificationContent');

            // 使用统一管理器获取公司资质文件上传状态
            const manager = window.globalCompanyManager;
            const currentCompanyId = manager ? manager.currentCompanyId : null;

            if (currentCompanyId && manager) {
                // 使用统一管理器加载资质信息
                manager.loadCompanyQualifications(currentCompanyId)
                    .then(companyQualifications => {
                        // 重新渲染资质显示（包含上传状态）
                        renderQualificationDisplay(qualRequirements, companyQualifications || {}, content);
                    })
                    .catch(error => {
                        console.warn('获取公司资质文件失败:', error);
                        // 即使获取失败，也显示基本的资质要求
                        renderQualificationDisplay(qualRequirements, {}, content);
                    });
            } else {
                // 没有选择公司时，只显示基本的资质要求
                renderQualificationDisplay(qualRequirements, {}, content);
            }
        }

        function renderQualificationDisplay(qualRequirements, companyQualifications, content) {

            // 使用统一配置的资质字段映射
            const qualificationMapping = CompanyConfig.qualificationMapping;

            // 使用统一配置的资质分类
            const categories = CompanyConfig.qualificationCategories;

            // 使用统一配置的标准资质类型
            const standardQualificationTypes = CompanyConfig.standardQualificationTypes;

            let html = '<div class="row">';
            let columnIndex = 0;

            // 按分类显示资质要求，两列布局
            Object.keys(categories).forEach(categoryKey => {
                const categoryQuals = standardQualificationTypes.filter(qual => qual.category === categoryKey);
                if (categoryQuals.length === 0) return;

                const categoryInfo = categories[categoryKey];

                // 每两个分类一行
                if (columnIndex % 2 === 0 && columnIndex > 0) {
                    html += '</div><div class="row">';
                }

                html += `
                    <div class="col-md-6 mb-4">
                        <div class="h-100">
                            <h6 class="text-${categoryInfo.color} mb-3 border-bottom pb-2">
                                <i class="${categoryInfo.icon}"></i> ${categoryInfo.name}
                            </h6>
                `;

                categoryQuals.forEach(qual => {
                    // 通过映射表查找对应的招标要求字段
                    const mappedField = qualificationMapping[qual.key];
                    let required = false;
                    let description = '未在招标文档中明确要求';

                    if (mappedField && qualRequirements.hasOwnProperty(mappedField)) {
                        required = qualRequirements[mappedField] === true || qualRequirements[mappedField] === 'true';
                        // 查找对应的描述字段
                        const descField = mappedField.replace('_required', '_description');
                        if (qualRequirements[descField]) {
                            description = qualRequirements[descField];
                        } else if (required) {
                            description = '招标文档要求提供此资质';
                        }
                    }

                    const statusText = required ? '本次招标要求提供' : '本次招标未要求提供';
                    const statusClass = required ? 'bg-success' : 'bg-secondary';
                    const borderClass = required ? 'border-success' : 'border-secondary';

                    // 检查公司是否已上传该资质文档
                    const hasUploaded = companyQualifications && companyQualifications[qual.key];
                    const uploadStatusIcon = hasUploaded ?
                        '<i class="bi bi-check-circle-fill text-success ms-1" title="已上传"></i>' :
                        '<i class="bi bi-x-circle text-secondary ms-1" title="未上传"></i>';
                    const uploadStatusText = hasUploaded ? '已上传' : '未上传';

                    html += `
                        <div class="mb-2 p-2 border-start border-3 ${borderClass}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-center">
                                    <strong class="fs-6">${qual.name}</strong>
                                    ${uploadStatusIcon}
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                columnIndex++;
            });

            html += '</div>';

            if (content) {
                content.innerHTML = html;
            } else {
                console.warn('qualificationContent element not found');
            }
        }

        function displayTechnicalScoring(technicalScoring) {
            // 确保容器管理器已初始化
            if (!tenderContainerManager) {
                tenderContainerManager = new ContainerManager(tenderResultArea);
            }
            
            // 检查父容器是否可用
            if (!tenderContainerManager.isParentAvailable()) {
                console.warn('tenderResultArea not available for technical scoring');
                return;
            }
            
            // 获取或创建技术评分容器
            const container = tenderContainerManager.getOrCreateContainer('technicalContainer', {
                className: 'card border-info mb-3',
                headerClass: 'bg-info text-white',
                icon: '<i class="bi bi-graph-up"></i>',
                title: '技术评分',
                contentId: 'technicalContent'
            });
            
            if (!container) {
                console.warn('Failed to create technicalContainer');
                return;
            }
            
            const content = tenderContainerManager.getContentElement('technicalContainer', 'technicalContent');
            const items = technicalScoring.technical_scoring_items || [];
            
            if (items.length > 0) {
                let html = `
                    <div class="mb-3">
                        <span class="badge bg-info fs-6">总分: ${technicalScoring.total_technical_score || '30分'}</span>
                        <span class="badge bg-secondary ms-2">${technicalScoring.extraction_summary}</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>序号</th>
                                    <th>评分项</th>
                                    <th>分值</th>
                                    <th>评分标准</th>
                                    <th>来源</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                items.forEach((item, index) => {
                    html += `
                        <tr>
                            <td class="text-center fw-bold">${index + 1}</td>
                            <td class="fw-semibold text-primary">${item.name}</td>
                            <td class="text-center">
                                <span class="badge bg-info">${item.weight}</span>
                            </td>
                            <td>
                                <small class="text-muted">${item.criteria}</small>
                            </td>
                            <td>
                                <small class="text-secondary">${item.source}</small>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        未能提取到技术评分信息
                    </div>
                `;
            }
            
            if (content) {
                content.innerHTML = html;
            } else {
                console.warn('technicalContent element not found');
            }
        }

        function getQualificationLabel(key) {
            const labels = {
                'business_license': '营业执照',
                'taxpayer_qualification': '纳税人资格',
                'performance_requirements': '业绩要求',
                'authorization_requirements': '授权要求',
                'credit_china': '信用中国',
                'commitment_letter': '承诺函',
                'audit_report': '审计报告',
                'social_security': '社保要求',
                'labor_contract': '劳动合同',
                'other_requirements': '其他要求'
            };
            return labels[key] || key;
        }

        // 显示已存在的资质文件
        function displayExistingQualification(qualKey, qualInfo) {
            const statusDiv = document.getElementById(`status-${qualKey}`);
            const qualElement = document.querySelector(`[data-qual-key="${qualKey}"]`);
            
            if (statusDiv && qualElement) {
                const viewBtn = qualElement.querySelector('.view-file-btn');
                const downloadBtn = qualElement.querySelector('.download-file-btn');
                const deleteBtn = qualElement.querySelector('.delete-file-btn');
                
                // 获取文件类型图标和格式化大小
                const fileTypeIcon = getFileTypeIcon('', qualInfo.original_filename);
                const fileSizeText = formatFileSize(qualInfo.file_size);
                
                // 显示文件信息
                statusDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="file-info">
                            <small class="text-success">
                                <i class="${fileTypeIcon}"></i> 已上传: ${qualInfo.original_filename} 
                                (${fileSizeText})
                                <span class="badge bg-success">已保存</span>
                            </small>
                        </div>
                    </div>
                `;
                statusDiv.style.display = 'block';
                
                // 显示操作按钮
                if (viewBtn) viewBtn.style.display = 'inline-block';
                if (downloadBtn) downloadBtn.style.display = 'inline-block';
                if (deleteBtn) deleteBtn.style.display = 'inline-block';
                
                // 记录文件信息用于显示（但不是本地文件）
                qualificationFiles[qualKey] = {
                    original_filename: qualInfo.original_filename,
                    file_size: qualInfo.file_size,
                    uploaded: true,
                    server_file: true // 标记这是服务器上的文件
                };
            } else if (qualKey.startsWith('custom_')) {
                // 如果是自定义资质，需要重新创建元素
                const qualName = qualInfo.qualification_name || '自定义资质';
                const qualElement = createQualificationElement(qualKey, qualName, 'bi-file-plus', true);
                document.getElementById('customQualifications').appendChild(qualElement);
                
                // 然后显示文件信息
                setTimeout(() => {
                    displayExistingQualification(qualKey, qualInfo);
                }, 100);
            }
        }

        // 填写表单
        function fillCompanyForm(company) {
            console.log('[fillCompanyForm] 开始填充公司表单，数据:', company);
            isLoadingCompany = true; // 防止填充时触发事件
            
            let filledFields = 0;
            let totalFields = 0;
            
            Object.keys(companyFields).forEach(fieldId => {
                totalFields++;
                const element = document.getElementById(fieldId);
                const fieldValue = company[fieldId];
                
                if (element) {
                    if (fieldValue) {
                        element.value = fieldValue;
                        filledFields++;
                        console.log(`[fillCompanyForm] 填充字段 ${fieldId}: ${fieldValue}`);
                    } else {
                        element.value = '';
                        console.log(`[fillCompanyForm] 清空字段 ${fieldId} (数据为空)`);
                    }
                } else {
                    console.warn(`[fillCompanyForm] 元素不存在: ${fieldId}`);
                }
            });
            
            console.log(`[fillCompanyForm] 表单填充完成，填充 ${filledFields}/${totalFields} 个字段`);
            isLoadingCompany = false; // 重置标志
        }

        // 移除了newCompanyBtn事件绑定 - 功能已转移到商务应答页面

        // 移除了clearFormBtn事件绑定 - 功能已转移到商务应答页面

        // 清空表单相关函数已移除 - 功能转移到商务应答页面

        // 移除了saveCompanyBtn事件绑定 - 功能已转移到商务应答页面

        // 移除了deleteCompanyBtn事件绑定 - 功能已转移到商务应答页面

        // 显示消息
        function showCompanyMessage(message, type) {
            hideCompanyMessages();
            
            if (type === 'success') {
                const messageElem = document.getElementById('companyResultMessage');
                const areaElem = document.getElementById('companyResultArea');
                if (messageElem) messageElem.textContent = message;
                if (areaElem) areaElem.style.display = 'block';
            } else {
                const messageElem = document.getElementById('companyErrorMessage');
                const areaElem = document.getElementById('companyErrorArea');
                if (messageElem) messageElem.textContent = message;
                if (areaElem) areaElem.style.display = 'block';
            }

            // 3秒后自动隐藏
            setTimeout(hideCompanyMessages, 3000);
        }

        // 隐藏消息
        function hideCompanyMessages() {
            const resultArea = document.getElementById('companyResultArea');
            const errorArea = document.getElementById('companyErrorArea');
            if (resultArea) resultArea.style.display = 'none';
            if (errorArea) errorArea.style.display = 'none';
        }

        console.log('Company management initialized');

        // ====== 资质文件管理功能 ======
        console.log('Initializing qualification management...');

        // 使用统一配置的资质类型
        const standardQualificationTypes = CompanyConfig.standardQualificationTypes;

        let customQualificationCounter = 0;
        let qualificationFiles = {}; // 存储上传的文件

        // 初始化标准资质项目
        function initializeStandardQualifications() {
            const container = document.getElementById('standardQualifications');
            if (!container) {
                console.log('standardQualifications 容器不存在，跳过资质初始化');
                return;
            }
            
            container.innerHTML = '';
            
            // 按分类组织资质
            const categories = {
                'basic': { name: '基本证件资质', icon: 'bi-card-text', color: 'primary' },
                'iso': { name: 'ISO体系认证', icon: 'bi-award', color: 'warning' },
                'credit': { name: '信用资质', icon: 'bi-shield-check', color: 'danger' },
                'tax': { name: '税务资质', icon: 'bi-receipt', color: 'success' },
                'financial': { name: '财务资质', icon: 'bi-graph-up', color: 'info' },
                'industry': { name: '行业资质', icon: 'bi-gear', color: 'secondary' },
                'social': { name: '社保资质', icon: 'bi-people', color: 'dark' },
                'intellectual': { name: '知识产权', icon: 'bi-lightbulb', color: 'success' }
            };
            
            // 按分类渲染资质项目
            Object.keys(categories).forEach(categoryKey => {
                const categoryQuals = standardQualificationTypes.filter(qual => qual.category === categoryKey);
                if (categoryQuals.length > 0) {
                    const categoryInfo = categories[categoryKey];
                    
                    // 创建分类标题
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'mb-4';
                    categoryDiv.innerHTML = `
                        <h6 class="text-${categoryInfo.color} mb-3 border-bottom pb-2">
                            <i class="${categoryInfo.icon}"></i> ${categoryInfo.name}
                            <small class="text-muted">(${categoryQuals.length}项)</small>
                        </h6>
                        <div class="category-qualifications"></div>
                    `;
                    
                    const categoryQualContainer = categoryDiv.querySelector('.category-qualifications');
                    
                    // 添加该分类下的所有资质项目
                    categoryQuals.forEach(qual => {
                        const qualElement = createQualificationElement(qual.key, qual.name, qual.icon, false, qual.required);
                        categoryQualContainer.appendChild(qualElement);
                    });
                    
                    container.appendChild(categoryDiv);
                }
            });
        }

        // 创建资质项目元素
        function createQualificationElement(key, name, icon, isCustom, required = false) {
            const div = document.createElement('div');
            div.className = 'card mb-3 qualification-item border-light shadow-sm';
            div.dataset.qualKey = key;
            
            div.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-3 col-md-12 mb-2 mb-lg-0">
                            <h6 class="mb-0 d-flex align-items-center">
                                <i class="${icon} text-primary me-2"></i> 
                                <span class="text-truncate" title="${name}">${name}</span>
                                ${required ? '<span class="text-danger ms-1" title="必填项">*</span>' : ''}
                            </h6>
                        </div>
                        <div class="col-lg-4 col-md-12 mb-2 mb-lg-0">
                            <div class="upload-zone border-2 border-dashed rounded p-3 text-center" 
                                 data-qual-key="${key}" style="cursor: pointer;">
                                <input type="file" class="form-control d-none qual-file-input" 
                                       accept=".pdf,.jpg,.jpeg,.png,.docx,.doc" 
                                       data-qual-key="${key}">
                                <i class="bi bi-cloud-upload text-muted"></i>
                                <small class="text-muted d-block">点击上传文件</small>
                                <small class="text-muted">支持 PDF, 图片, Word</small>
                            </div>
                        </div>
                        <div class="col-lg-5 col-md-12">
                            <div class="d-flex gap-1 flex-wrap">
                                <button type="button" class="btn btn-sm btn-outline-primary view-file-btn d-none"
                                        data-qual-key="${key}" title="预览文件">
                                    <i class="bi bi-eye"></i> 预览
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success download-file-btn d-none"
                                        data-qual-key="${key}" title="下载文件">
                                    <i class="bi bi-download"></i> 下载
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn d-none"
                                        data-qual-key="${key}" title="删除文件">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                                ${isCustom ? `
                                <button type="button" class="btn btn-sm btn-outline-secondary remove-qual-btn" 
                                        data-qual-key="${key}" title="移除此资质项">
                                    <i class="bi bi-x-circle"></i> 移除项
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 文件状态和预览区域 -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="file-status bg-light rounded p-2 d-none" id="status-${key}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="file-info">
                                        <small class="text-muted">未上传文件</small>
                                    </div>
                                    <div class="file-progress d-none">
                                        <div class="progress" style="width: 200px; height: 4px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 图片预览区域 -->
                                <div class="file-preview mt-2 d-none">
                                    <img class="preview-image img-thumbnail" style="max-height: 120px; max-width: 200px;" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 绑定文件输入事件
            const fileInput = div.querySelector('.qual-file-input');
            fileInput.addEventListener('change', function() {
                handleQualificationFileChange(key, this);
            });
            
            // 绑定上传区域点击事件
            const uploadZone = div.querySelector('.upload-zone');
            if (uploadZone) {
                uploadZone.addEventListener('click', function() {
                    fileInput.click();
                });
            }

            // 绑定查看按钮事件
            const viewBtn = div.querySelector('.view-file-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', function() {
                    viewQualificationFile(key);
                });
            }

            // 绑定删除按钮事件
            const deleteBtn = div.querySelector('.delete-file-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    deleteQualificationFile(key);
                });
            }
            
            // 绑定下载按钮事件
            const downloadBtn = div.querySelector('.download-file-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function() {
                    downloadQualificationFile(key);
                });
            }

            // 绑定移除资质项按钮事件（仅自定义资质）
            const removeBtn = div.querySelector('.remove-qual-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    removeCustomQualification(key);
                });
            }

            return div;
        }

        // 处理文件选择
        function handleQualificationFileChange(key, fileInput) {
            const file = fileInput.files[0];
            const statusDiv = document.getElementById(`status-${key}`);
            const qualElement = fileInput.closest('.qualification-item');
            const viewBtn = qualElement.querySelector('.view-file-btn');
            const downloadBtn = qualElement.querySelector('.download-file-btn');
            const deleteBtn = qualElement.querySelector('.delete-file-btn');

            if (file) {
                // 验证文件大小 (10MB限制)
                if (file.size > 10 * 1024 * 1024) {
                    showCompanyMessage('文件过大，请选择小于10MB的文件', 'error');
                    fileInput.value = '';
                    return;
                }

                // 存储文件信息
                qualificationFiles[key] = {
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploaded: false
                };

                // 更新状态显示
                const fileTypeIcon = getFileTypeIcon(file.type, file.name);
                const fileSizeText = formatFileSize(file.size);
                
                statusDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="file-info">
                            <small class="text-info">
                                <i class="${fileTypeIcon}"></i> 已选择: ${file.name} 
                                (${fileSizeText})
                                <span class="badge bg-warning">待上传</span>
                            </small>
                        </div>
                    </div>
                    <div class="file-preview mt-2 d-none">
                        <img class="preview-image img-thumbnail" style="max-height: 120px; max-width: 200px;" />
                    </div>
                `;
                
                // 如果是图片文件，显示预览
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewContainer = statusDiv.querySelector('.file-preview');
                        const previewImage = statusDiv.querySelector('.preview-image');
                        if (previewImage && previewContainer) {
                            previewImage.src = e.target.result;
                            previewContainer.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                }
                
                statusDiv.style.display = 'block';

                // 显示操作按钮
                viewBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'inline-block';
                deleteBtn.style.display = 'inline-block';
            } else {
                // 清除文件信息
                delete qualificationFiles[key];
                statusDiv.style.display = 'none';
                viewBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
            }
        }
        
        // 辅助函数：获取文件类型图标
        function getFileTypeIcon(fileType, fileName) {
            // 安全性检查
            const safeFileType = fileType || '';
            const safeFileName = fileName || '';
            
            if (safeFileType.startsWith('image/')) {
                return 'bi bi-image text-primary';
            } else if (safeFileType === 'application/pdf') {
                return 'bi bi-filetype-pdf text-danger';
            } else if (safeFileType.includes('word') || 
                       safeFileName.toLowerCase().endsWith('.docx') || 
                       safeFileName.toLowerCase().endsWith('.doc')) {
                return 'bi bi-filetype-docx text-info';
            } else if (safeFileType.includes('excel') || 
                       safeFileName.toLowerCase().endsWith('.xlsx') || 
                       safeFileName.toLowerCase().endsWith('.xls')) {
                return 'bi bi-filetype-xlsx text-success';
            } else if (safeFileName.toLowerCase().endsWith('.pdf')) {
                return 'bi bi-filetype-pdf text-danger';
            } else if (safeFileName.toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp)$/)) {
                return 'bi bi-image text-primary';
            } else {
                return 'bi bi-file-earmark text-secondary';
            }
        }
        
        // 辅助函数：格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // 查看文件
        function viewQualificationFile(key) {
            const fileInfo = qualificationFiles[key];
            if (!fileInfo) {
                showCompanyMessage('没有选择文件', 'error');
                return;
            }

            if (fileInfo.server_file) {
                // 服务器上的文件，通过API获取
                if (currentCompanyId) {
                    const url = `/api/companies/${currentCompanyId}/qualifications/${key}/download`;
                    window.open(url, '_blank');
                } else {
                    showCompanyMessage('无法获取文件，公司信息缺失', 'error');
                }
            } else if (fileInfo.file) {
                // 本地选择的文件，创建临时URL预览
                const url = URL.createObjectURL(fileInfo.file);
                const newWindow = window.open(url, '_blank');
                if (!newWindow) {
                    showCompanyMessage('无法打开文件预览，请检查浏览器弹窗设置', 'error');
                }
            } else {
                showCompanyMessage('文件不可用', 'error');
            }
        }
        
        // 下载文件
        function downloadQualificationFile(key) {
            const fileInfo = qualificationFiles[key];
            if (!fileInfo) {
                showCompanyMessage('没有找到文件信息', 'error');
                return;
            }
            
            if (fileInfo.server_file) {
                // 服务器上的文件，通过API下载
                if (currentCompanyId) {
                    const url = `/api/companies/${currentCompanyId}/qualifications/${key}/download`;
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileInfo.original_filename || 'download';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    showCompanyMessage('无法下载文件，公司信息缺失', 'error');
                }
            } else if (fileInfo.file) {
                // 本地选择的文件，创建下载链接
                const url = URL.createObjectURL(fileInfo.file);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileInfo.file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                showCompanyMessage('文件不可用', 'error');
            }
        }

        // 删除文件
        function deleteQualificationFile(key) {
            const fileInfo = qualificationFiles[key];
            if (!fileInfo) {
                showCompanyMessage('没有找到文件信息', 'error');
                return;
            }

            if (fileInfo.server_file) {
                if (!confirm('确定要从服务器删除这个文件吗？此操作不可撤销。')) {
                    return;
                }

                // 删除服务器上的文件
                if (currentCompanyId) {
                    fetch(`/api/companies/${currentCompanyId}/qualifications/${key}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // 清除UI状态
                            clearQualificationFileUI(key);
                            delete qualificationFiles[key];
                            showCompanyMessage('服务器文件已删除', 'success');
                        } else {
                            showCompanyMessage('删除服务器文件失败: ' + (data.error || '未知错误'), 'error');
                        }
                    })
                    .catch(error => {
                        showCompanyMessage('删除服务器文件失败: ' + error.message, 'error');
                    });
                } else {
                    showCompanyMessage('无法删除文件，公司信息缺失', 'error');
                }
            } else {
                if (!confirm('确定要删除这个文件吗？')) {
                    return;
                }

                // 删除本地选择的文件
                clearQualificationFileUI(key);
                delete qualificationFiles[key];
                showCompanyMessage('文件已删除', 'success');
            }
        }

        // 清除资质文件的UI状态
        function clearQualificationFileUI(key) {
            const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
            if (qualElement) {
                const fileInput = qualElement.querySelector('.qual-file-input');
                const statusDiv = document.getElementById(`status-${key}`);
                const viewBtn = qualElement.querySelector('.view-file-btn');
                const deleteBtn = qualElement.querySelector('.delete-file-btn');

                // 清除文件输入和UI状态
                if (fileInput) fileInput.value = '';
                if (statusDiv) statusDiv.style.display = 'none';
                if (viewBtn) viewBtn.style.display = 'none';
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
        }

        // 自定义资质功能已移除 - 功能集中在商务应答页面
        /*
        const addCustomQualificationBtn = document.getElementById('addCustomQualificationBtn');
        if (addCustomQualificationBtn) {
            addCustomQualificationBtn.addEventListener('click', function() {
            const nameInput = document.getElementById('customQualificationName');
            const name = nameInput.value.trim();

            if (!name) {
                showCompanyMessage('请输入资质名称', 'error');
                return;
            }

            // 生成唯一key
            customQualificationCounter++;
            const key = `custom_${customQualificationCounter}_${Date.now()}`;

            // 创建自定义资质项目
            const qualElement = createQualificationElement(key, name, 'bi-file-plus', true);
            document.getElementById('customQualifications').appendChild(qualElement);

            // 清空输入框
            nameInput.value = '';

            showCompanyMessage(`已添加自定义资质项: ${name}`, 'success');
        });
        } else {
            console.log('addCustomQualificationBtn 元素不存在，跳过事件绑定');
        }
        */

        // 移除自定义资质项
        function removeCustomQualification(key) {
            if (!confirm('确定要移除这个资质项吗？相关文件也会被删除。')) {
                return;
            }

            // 删除文件记录
            delete qualificationFiles[key];

            // 移除DOM元素
            const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
            if (qualElement) {
                qualElement.remove();
            }

            showCompanyMessage('资质项已移除', 'success');
        }

        // 资质文件保存功能
        safeAddEventListener('saveAllQualificationsBtn', 'click', function() {
            if (!currentCompanyId) {
                showCompanyGuideModal();
                return;
            }

            const fileCount = Object.keys(qualificationFiles).length;
            if (fileCount === 0) {
                showCompanyMessage('没有选择任何资质文件', 'error');
                return;
            }

            uploadQualificationFiles();
        });

        // 内部清空资质函数（不显示确认对话框）
        function clearAllQualificationsInternal() {
            // 清空所有文件
            qualificationFiles = {};

            // 重新初始化标准资质项目（这会清空并重建所有资质项）
            const container = document.getElementById('standardQualifications');
            if (container) {
                initializeStandardQualifications();
            }

            // 移除所有自定义资质项
            const customQualContainer = document.getElementById('customQualifications');
            if (customQualContainer) {
                customQualContainer.innerHTML = '';
            }
        }

        // 清空资质功能
        safeAddEventListener('clearAllQualificationsBtn', 'click', function() {
            if (!confirm('确定要清空所有资质文件吗？此操作不可撤销。')) {
                return;
            }

            clearAllQualificationsInternal();
            showCompanyMessage('所有资质文件已清空', 'success');
        });

        // 上传资质文件
        function uploadQualificationFiles() {
            const formData = new FormData();
            
            // 添加公司ID
            formData.append('company_id', currentCompanyId);
            
            // 准备自定义资质名称映射
            const qualificationNames = {};

            // 添加所有文件
            for (const [key, fileInfo] of Object.entries(qualificationFiles)) {
                if (fileInfo.file) {
                    formData.append(`qualifications[${key}]`, fileInfo.file);
                    
                    // 如果是自定义资质，收集名称信息
                    if (key.startsWith('custom_')) {
                        const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
                        if (qualElement) {
                            const qualName = qualElement.querySelector('h6').textContent.replace(/.*\s/, '');
                            qualificationNames[key] = qualName;
                        }
                    }
                }
            }
            
            // 添加自定义资质名称映射作为JSON字符串
            formData.append('qualification_names', JSON.stringify(qualificationNames));

            const btn = document.getElementById('saveAllQualificationsBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 上传中...';
            btn.disabled = true;

            fetch(`/api/companies/${currentCompanyId}/qualifications/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 更新文件状态
                    Object.keys(qualificationFiles).forEach(key => {
                        if (qualificationFiles[key]) {
                            qualificationFiles[key].uploaded = true;
                            updateFileStatus(key);
                        }
                    });

                    showCompanyMessage(`成功上传 ${data.uploaded_count} 个资质文件`, 'success');
                } else {
                    showCompanyMessage('上传失败: ' + (data.error || '未知错误'), 'error');
                }
            })
            .catch(error => {
                showCompanyMessage('上传失败: ' + error.message, 'error');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // 更新文件状态显示
        function updateFileStatus(key) {
            const fileInfo = qualificationFiles[key];
            const statusDiv = document.getElementById(`status-${key}`);

            if (fileInfo && statusDiv) {
                const statusClass = fileInfo.uploaded ? 'text-success' : 'text-info';
                const statusBadge = fileInfo.uploaded ? 
                    '<span class="badge bg-success">已上传</span>' : 
                    '<span class="badge bg-warning">待上传</span>';

                statusDiv.innerHTML = `
                    <small class="${statusClass}">
                        <i class="bi bi-file-earmark"></i> ${fileInfo.name} 
                        (${(fileInfo.size / 1024).toFixed(1)} KB)
                        ${statusBadge}
                    </small>
                `;
            }
        }
        
        // 标准资质功能和自定义资质功能（已集成到统一初始化中）
        // 自定义资质添加按钮事件（保持原有逻辑）
            safeAddEventListener('addCustomQualificationBtn', 'click', function() {
                const nameInput = document.getElementById('customQualificationName');
                const name = nameInput.value.trim();
                
                if (!name) {
                    alert('请输入资质名称');
                    return;
                }
                
                // 创建自定义资质项
                const customKey = `custom_${customQualificationCounter++}`;
                const qualElement = createQualificationElement(customKey, name, 'bi-file-earmark-plus', true);
                
                document.getElementById('customQualifications').appendChild(qualElement);
                nameInput.value = '';
                
                console.log(`添加自定义资质: ${name} (${customKey})`);
            });
        });

        console.log('Qualification management initialized');

        // =========================
        // 商务应答功能
        // =========================

        // 商务应答功能初始化（已移动到AppInitializer，暂时注释）
        // document.addEventListener('DOMContentLoaded', function() {
            // 商务应答文件上传处理
            const businessTemplateFile = document.getElementById('businessTemplateFile');
        if (businessTemplateFile) {
            businessTemplateFile.addEventListener('change', function() {
                const fileName = this.files[0]?.name;
                const fileNameDiv = document.getElementById('businessTemplateFileName');
                if (fileName && fileNameDiv) {
                    fileNameDiv.innerHTML = `<div class="alert alert-info py-2"><i class="bi bi-file-earmark-word"></i> ${fileName}</div>`;
                } else if (fileNameDiv) {
                    fileNameDiv.innerHTML = '';
                }
            });
        }
        
        // 商务应答表单提交处理
        const businessResponseForm = document.getElementById('businessResponseForm');
        if (businessResponseForm) {
            businessResponseForm.addEventListener('submit', function(e) {
                e.preventDefault();
            
            const templateFile = document.getElementById('businessTemplateFile').files[0];
            const companyId = document.getElementById('businessCompanySelect').value;
            const projectName = document.getElementById('businessProjectName').value;
            const tenderNo = document.getElementById('businessTenderNo').value;
            const dateText = document.getElementById('businessDate').value;
            const useMcp = 'true'; // 默认使用MCP处理器
            
            // 验证必填字段
            if (!templateFile) {
                alert('请选择商务应答模板');
                return;
            }
            
            if (!companyId) {
                alert('请选择应答公司');
                return;
            }
            
            // 显示进度条
            const progress = document.getElementById('businessProgress');
            const result = document.getElementById('businessResult');
            const error = document.getElementById('businessError');
            const stats = document.getElementById('businessStats');
            
            progress.style.display = 'block';
            result.style.display = 'none';
            error.style.display = 'none';
            stats.style.display = 'none';
            
            // 构建FormData
            const formData = new FormData();
            formData.append('template_file', templateFile);
            formData.append('company_id', companyId);
            formData.append('project_name', projectName);
            formData.append('tender_no', tenderNo);
            formData.append('date_text', dateText);
            formData.append('use_mcp', useMcp);
            
            // 发送请求
            fetch('/process-business-response', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                progress.style.display = 'none';
                
                if (data.success) {
                    // 隐藏错误提示，显示成功结果
                    error.style.display = 'none';
                    document.getElementById('businessResultMessage').textContent = data.message;
                    document.getElementById('businessDownloadLink').href = data.download_url;
                    result.style.display = 'block';
                    
                    // 显示处理统计
                    if (data.stats) {
                        const statsContent = document.getElementById('businessStatsContent');
                        let statsHtml = '';
                        
                        if (data.stats.bidder_name) {
                            statsHtml += `<p><strong>投标人名称填写：</strong> 段落${data.stats.bidder_name.paragraphs_changed}个，表格${data.stats.bidder_name.tables_changed}个</p>`;
                        }
                        if (data.stats.project_info) {
                            statsHtml += `<p><strong>项目信息填写：</strong> 替换${data.stats.project_info.replacements_made}项，投标人字段${data.stats.project_info.bidder_fields_filled}个</p>`;
                        }
                        if (data.stats.qualification_images) {
                            statsHtml += `<p><strong>资质图片插入：</strong> 找到关键词${data.stats.qualification_images.keywords_found}个，插入图片${data.stats.qualification_images.images_inserted}张</p>`;
                        }
                        
                        if (statsHtml) {
                            statsContent.innerHTML = statsHtml;
                            stats.style.display = 'block';
                        }
                    }
                    
                    // 刷新文件列表
                    loadBusinessFilesList();
                } else {
                    // 使用ErrorHandler处理错误信息，防止显示[object Object]
                    const errorMsg = ErrorHandler.formatErrorMessage(data.error || data.message || data) || '处理失败';
                    document.getElementById('businessErrorMessage').textContent = errorMsg;
                    error.style.display = 'block';
                }
            })
            .catch(err => {
                progress.style.display = 'none';
                // 使用ErrorHandler处理网络错误
                const errorMsg = ErrorHandler.handleAPIError(err, '商务应答处理失败');
                document.getElementById('businessErrorMessage').textContent = errorMsg;
                error.style.display = 'block';
                console.error('商务应答处理失败:', err);
            });
            });
        }
        
        // 文档预览和编辑功能
        let currentDocumentPath = null; // 存储当前文档路径
        let wordEditor = null; // WordEditor实例
        
        // 预览商务应答文档
        function previewBusinessDocument() {
            const downloadLink = document.getElementById('businessDownloadLink');
            if (!downloadLink || !downloadLink.href) {
                showNotification('没有可预览的文档', 'warning');
                return;
            }
            
            // 从下载链接获取文件路径
            const url = new URL(downloadLink.href, window.location.href);
            const filename = url.pathname.split('/').pop();
            currentDocumentPath = filename;
            
            // 显示加载状态
            const previewContent = document.getElementById('documentPreviewContent');
            previewContent.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在加载文档...</p></div>';
            
            // 显示预览模态框
            const previewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
            previewModal.show();
            
            // 调用API获取文档内容
            fetch(`/api/document/preview/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        previewContent.innerHTML = data.html_content || '<p>文档内容为空</p>';
                    } else {
                        previewContent.innerHTML = `<div class="alert alert-danger">预览失败: ${data.error || '未知错误'}</div>`;
                    }
                })
                .catch(error => {
                    previewContent.innerHTML = `<div class="alert alert-danger">预览失败: ${error.message}</div>`;
                });
        }
        
        // 编辑商务应答文档
        function editBusinessDocument() {
            const downloadLink = document.getElementById('businessDownloadLink');
            if (!downloadLink || !downloadLink.href) {
                showNotification('没有可编辑的文档', 'warning');
                return;
            }
            
            // 初始化编辑器（如果还没有初始化）
            if (!wordEditor) {
                wordEditor = new WordEditor('documentEditor', {
                    height: 500,
                    placeholder: '请点击"读取文档"加载商务应答文档内容...'
                });
            }
            
            // 显示编辑模态框
            const editModal = new bootstrap.Modal(document.getElementById('documentEditModal'));
            editModal.show();
            
            // 自动加载文档
            setTimeout(() => {
                loadDocumentToEditor();
            }, 500);
        }
        
        // 切换到编辑模式
        function switchToEditMode() {
            // 关闭预览模态框
            const previewModal = bootstrap.Modal.getInstance(document.getElementById('documentPreviewModal'));
            if (previewModal) {
                previewModal.hide();
            }

            // 打开编辑模态框
            setTimeout(() => {
                editBusinessDocument();
            }, 300);
        }

        // 点对点应答文档预览
        function previewPointDocument() {
            const downloadBtn = document.getElementById('downloadBtn');
            if (!downloadBtn) {
                showNotification('没有可预览的文档', 'warning');
                return;
            }

            // 从data属性获取下载URL
            const downloadUrl = downloadBtn.getAttribute('data-download-url');
            if (!downloadUrl || downloadUrl === 'undefined') {
                showNotification('无法获取文档路径，请重新处理内联回复', 'error');
                return;
            }

            const filename = downloadUrl.split('/').pop();
            currentDocumentPath = filename;

            // 显示加载状态
            const previewContent = document.getElementById('documentPreviewContent');
            previewContent.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">正在加载文档...</p></div>';

            // 显示预览模态框
            const previewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
            previewModal.show();

            // 调用API获取文档内容
            fetch(`/api/document/preview/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        previewContent.innerHTML = data.html_content || '<p>文档内容为空</p>';
                    } else {
                        previewContent.innerHTML = `<div class="alert alert-danger">预览失败: ${data.error || '未知错误'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('预览文档失败:', error);
                    previewContent.innerHTML = `<div class="alert alert-danger">预览失败: ${error.message}</div>`;
                });
        }

        // 点对点应答文档编辑
        function editPointDocument() {
            const downloadBtn = document.getElementById('downloadBtn');
            if (!downloadBtn) {
                showNotification('没有可编辑的文档', 'warning');
                return;
            }

            // 从data属性获取下载URL
            const downloadUrl = downloadBtn.getAttribute('data-download-url');
            if (!downloadUrl || downloadUrl === 'undefined') {
                showNotification('无法获取文档路径，请重新处理内联回复', 'error');
                return;
            }

            const filename = downloadUrl.split('/').pop();
            currentDocumentPath = filename;

            // 初始化编辑器（如果还没有初始化）
            if (!wordEditor) {
                wordEditor = new WordEditor('documentEditor', {
                    height: 500,
                    placeholder: '请点击"读取文档"加载点对点应答文档内容...'
                });
            }

            // 显示编辑模态框
            const editModal = new bootstrap.Modal(document.getElementById('documentEditModal'));
            editModal.show();

            // 自动加载文档
            setTimeout(() => {
                loadDocumentToEditor();
            }, 500);
        }
        
        // 预览历史文档
        function previewHistoricalDocument(filename) {
            if (!filename) {
                showNotification('文件名不能为空', 'warning');
                return;
            }
            
            // 设置当前文档路径（用于编辑功能）
            currentDocumentPath = filename;
            
            // 构建文档预览URL
            const previewUrl = `/api/document/preview/${encodeURIComponent(filename)}`;
            
            fetch(previewUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // 处理JSON响应
                let htmlContent = '';
                if (data.success && data.html_content) {
                    htmlContent = data.html_content;
                } else if (data.html_content) {
                    htmlContent = data.html_content;
                } else {
                    throw new Error(data.message || '预览内容为空');
                }
                
                // 显示预览内容
                const previewContent = document.getElementById('documentPreviewContent');
                if (previewContent) {
                    previewContent.innerHTML = htmlContent;
                }
                
                // 显示预览模态框
                const previewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
                previewModal.show();
                
                showNotification('历史文档预览加载成功', 'success');
            })
            .catch(error => {
                console.error('历史文档预览失败:', error);
                showNotification(`历史文档预览失败: ${error.message}`, 'error');
                
                // 降级处理：提供直接下载链接
                const downloadUrl = `/download/${encodeURIComponent(filename)}`;
                showNotification(`预览失败，可以<a href="${downloadUrl}" target="_blank">直接下载文档</a>`, 'warning', 5000);
            });
        }
        
        // 加载文档到编辑器
        function loadDocumentToEditor() {
            if (!currentDocumentPath) {
                showNotification('没有可加载的文档', 'warning');
                return;
            }
            
            if (!wordEditor) {
                showNotification('编辑器未初始化', 'error');
                return;
            }
            
            // 方案1：通过预览API获取HTML内容直接加载到编辑器
            fetch(`/api/document/preview/${currentDocumentPath}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.html_content) {
                        wordEditor.setContent(data.html_content);
                        showNotification('文档内容加载成功', 'success');
                    } else {
                        throw new Error(data.error || '无法获取文档内容');
                    }
                })
                .catch(error => {
                    console.error('Document loading error:', error);
                    showNotification('文档加载失败: ' + error.message, 'error');
                    
                    // 方案2：如果预览失败，尝试原始文件加载
                    tryLoadOriginalFile();
                });
        }
        
        // 尝试加载原始文件的备用方案
        function tryLoadOriginalFile() {
            if (!currentDocumentPath || !wordEditor) return;
            
            fetch(`/download/${currentDocumentPath}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // 确保正确的MIME类型
                    const mimeType = currentDocumentPath.endsWith('.docx') 
                        ? 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                        : 'application/msword';
                    
                    const file = new File([blob], currentDocumentPath, { 
                        type: mimeType 
                    });
                    
                    return wordEditor.loadDocument(file);
                })
                .then(() => {
                    showNotification('文档加载成功', 'success');
                })
                .catch(error => {
                    console.error('Fallback document loading error:', error);
                    showNotification('文档加载失败: ' + error.message, 'error');
                });
        }
        
        // 保存编辑的文档
        function saveEditedDocument() {
            if (!wordEditor) {
                showNotification('编辑器未初始化', 'error');
                return;
            }
            
            const filename = currentDocumentPath ? currentDocumentPath.replace('.docx', '_edited') : 'edited_document';
            wordEditor.saveDocument(filename)
                .then(() => {
                    showNotification('文档保存成功', 'success');
                })
                .catch(error => {
                    showNotification('文档保存失败: ' + error.message, 'error');
                });
        }
        
        // 保存并下载
        function saveAndDownload() {
            saveEditedDocument();
        }
        
        // 清空编辑器
        function clearEditor() {
            if (!wordEditor) {
                showNotification('编辑器未初始化', 'error');
                return;
            }
            
            if (confirm('确定要清空编辑器内容吗？')) {
                wordEditor.clearContent();
                showNotification('编辑器已清空', 'info');
            }
        }
        
        // 商务应答"下一步"按钮点击处理
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'businessNextStepBtn') {
                // 切换到点对点应答选项卡
                const pointToPointTab = document.getElementById('point-to-point-tab');
                if (pointToPointTab) {
                    pointToPointTab.click();
                }
            }
        });
        
        // 加载商务应答历史文件
        function loadBusinessFilesList() {
            const filesList = document.getElementById('businessFilesList');
            if (!filesList) {
                console.log('businessFilesList 元素不存在，跳过文件列表加载');
                return;
            }
            
            fetch('/api/business-files')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                    html += '<th>文件名</th><th>大小</th><th>创建时间</th><th>操作</th></tr></thead><tbody>';
                    
                    data.files.forEach(file => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        const downloadUrl = `/download/${encodeURIComponent(file.name)}`;
                        const previewBtn = `<button class="btn btn-sm btn-outline-info me-2" onclick="previewHistoricalDocument('${file.name}')">预览</button>`;
                        html += `<tr>
                            <td>${file.name}</td>
                            <td>${size} MB</td>
                            <td>${date}</td>
                            <td>
                                ${previewBtn}
                                <a href="${downloadUrl}" class="btn btn-sm btn-outline-primary">下载</a>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    filesList.innerHTML = html;
                } else {
                    filesList.innerHTML = '<p class="text-muted">暂无历史文件</p>';
                }
            })
            .catch(error => {
                console.error('加载商务应答文件列表失败:', error);
                filesList.innerHTML = '<p class="text-warning">文件列表加载失败，请稍后重试</p>';
            });
        }

        // 加载点对点应答历史文件
        function loadPointToPointFilesList() {
            const filesList = document.getElementById('pointHistoryFilesList');
            if (!filesList) {
                console.log('pointHistoryFilesList 元素不存在，跳过文件列表加载');
                return;
            }

            fetch('/api/point-to-point-files')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                    html += '<th>文件名</th><th>大小</th><th>创建时间</th><th>操作</th></tr></thead><tbody>';

                    data.files.forEach(file => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        const downloadUrl = `/download/${encodeURIComponent(file.name)}`;
                        const previewBtn = `<button class="btn btn-sm btn-outline-info me-2" onclick="previewHistoricalDocument('${file.name}')">预览</button>`;
                        html += `<tr>
                            <td>${file.name}</td>
                            <td>${size} MB</td>
                            <td>${date}</td>
                            <td>
                                ${previewBtn}
                                <a href="${downloadUrl}" class="btn btn-sm btn-outline-primary">下载</a>
                            </td>
                        </tr>`;
                    });

                    html += '</tbody></table></div>';
                    filesList.innerHTML = html;
                } else {
                    filesList.innerHTML = '<p class="text-muted">暂无历史文件</p>';
                }
            })
            .catch(error => {
                console.error('加载点对点应答文件列表失败:', error);
                filesList.innerHTML = '<p class="text-warning">文件列表加载失败，请稍后重试</p>';
            });
        }

        // 页面加载时初始化商务应答页面
        function initBusinessResponsePage() {
            // 确保所有结果区域都被隐藏
            const businessResult = document.getElementById('businessResult');
            const businessError = document.getElementById('businessError');
            const businessStats = document.getElementById('businessStats');
            const businessProgress = document.getElementById('businessProgress');
            
            if (businessResult) businessResult.style.display = 'none';
            if (businessError) businessError.style.display = 'none';
            if (businessStats) businessStats.style.display = 'none';
            if (businessProgress) businessProgress.style.display = 'none';
        }
        
        // 监听商务应答选项卡的显示事件
        document.addEventListener('shown.bs.tab', function(e) {
            if (e.target.id === 'business-response-nav') {
                // 当切换到商务应答选项卡时，确保结果区域被隐藏
                initBusinessResponsePage();
            } else if (e.target.id === 'point-to-point-nav') {
                // 当切换到点对点应答选项卡时，加载历史文件
                loadPointToPointFilesList();
            }
        });
        
        // 商务应答功能初始化（已集成到统一初始化中）
        // initBusinessResponsePage() 现在在统一初始化中调用
            loadBusinessFilesList();
            
            // 确保公司列表已加载（防止初始化顺序问题） - 已由统一初始化处理，移除重复调用
            // setTimeout(() => {
            //     if (typeof loadCompanyList === 'function') {
            //         console.log('商务应答页面：确保公司列表已加载');
            //         loadCompanyList();
            //     }
            // }, 100);
            
            // 商务应答公司选择事件已在统一初始化中通过CompanySelector处理
            
            // 商务应答页面的公司管理功能已简化，功能迁移到专门的公司管理页面
            
            // 添加页面状态检查
            function checkPageStatus() {
                console.log('=== 页面状态检查 ===');
                console.log('当前活跃tab:', document.querySelector('.nav-link.active')?.textContent?.trim());
                console.log('businessCompanySelect元素存在:', !!document.getElementById('businessCompanySelect'));
                console.log('=== 检查完成 ===');
            }
            
            // 立即执行一次状态检查
            checkPageStatus();
            
            // 每5秒自动检查一次（仅前3次，避免过多日志）
            let checkCount = 0;
            const checkInterval = setInterval(function() {
                checkCount++;
                console.log(`第${checkCount}次状态检查:`);
                checkPageStatus();
                if (checkCount >= 3) {
                    clearInterval(checkInterval);
                }
            }, 5000);
        });

        // =========================
        // 公司管理模态框功能
        // =========================
        
        
        
        // 重复的window.load事件已移除，功能已合并到上面的商务应答load事件中
        
        // handleViewCompany 和 handleAddCompany 函数已移除
        // 功能已迁移到专门的公司管理页面
        
        
        // 加载公司列表到模态框
        // 加载公司信息到模态框
        
        // 加载公司资质信息到模态框
        // 保存公司信息（使用统一管理器）
        
        // 删除公司（使用统一管理器）
        
        // 监听公司管理选项卡激活事件（使用统一管理器）
        document.addEventListener('shown.bs.tab', function(e) {
        });

        // DOM加载完成后初始化组件
        InitializationManager.ensureDOMReady(() => {
            ComponentState.init();
            InitializationManager.markReady();
            console.log('AI标书系统前端初始化完成');
        });

        // 显示公司信息引导模态框

        // 导航到公司管理标签页

    </script>

    <!-- 文档预览模态框 -->
    <div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentPreviewModalLabel">
                        <i class="bi bi-eye"></i> 文档预览
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="documentPreviewContent" style="min-height: 500px; padding: 20px; background: white;">
                        <!-- 预览内容将在这里显示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-warning" onclick="switchToEditMode()">
                        <i class="bi bi-pencil-square"></i> 编辑文档
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 文档编辑模态框 -->
    <div class="modal fade" id="documentEditModal" tabindex="-1" aria-labelledby="documentEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentEditModalLabel">
                        <i class="bi bi-pencil-square"></i> 文档编辑器
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="loadDocumentToEditor()">
                                <i class="bi bi-folder-open"></i> 读取文档
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="saveEditedDocument()">
                                <i class="bi bi-save"></i> 保存文档
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clearEditor()">
                                <i class="bi bi-trash"></i> 清空内容
                            </button>
                        </div>
                    </div>
                    <textarea id="documentEditor" style="width: 100%; min-height: 500px;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndDownload()">
                        <i class="bi bi-download"></i> 保存并下载
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- JavaScript文件引用 -->
    <script src="{{ url_for('static', filename='js/state-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script src="{{ url_for('static', filename='js/word-editor.js') }}"></script>
    
    <script>
        // 全局公司状态管理器
        const GlobalCompanyManager = {
            // 初始化状态标志
            _isInitialized: false,
            // 统一更新所有公司选择器
            syncCompanySelectors(companyId) {
                // console.log('[GlobalCompanyManager] 同步公司选择器:', companyId);
                
                // 同步商务应答选择器
                const businessSelect = document.getElementById('businessCompanySelect');
                if (businessSelect) {
                    businessSelect.value = companyId || '';
                }
                
                // 同步公司管理选择器
                
                // 更新StateManager
                StateManager.setCompanyId(companyId);
                
                // 更新UI状态指示
                this.updateCompanyStatusUI(companyId);
                
                // 显示选中的公司信息（异步调用）
                setTimeout(() => this.displaySelectedCompany(), 50);
            },
            
            // 更新公司状态UI显示
            async updateCompanyStatusUI(companyId) {
                // 更新当前选中公司显示
                const statusElements = document.querySelectorAll('.current-company-status');
                
                if (companyId) {
                    try {
                        const companyName = await this.getCompanyName(companyId);
                        statusElements.forEach(element => {
                            element.textContent = `当前公司: ${companyName}`;
                            element.className = 'current-company-status text-success';
                        });
                    } catch (error) {
                        // 如果获取失败，显示ID
                        statusElements.forEach(element => {
                            element.textContent = `当前公司: ${companyId}`;
                            element.className = 'current-company-status text-warning';
                        });
                    }
                } else {
                    statusElements.forEach(element => {
                        element.textContent = '请选择公司';
                        element.className = 'current-company-status text-warning';
                    });
                }
                
                // 控制功能按钮状态
                const needCompanyButtons = document.querySelectorAll('.requires-company');
                needCompanyButtons.forEach(btn => {
                    btn.disabled = !companyId;
                });
            },

            // 根据公司ID获取公司名称
            async getCompanyName(companyId) {
                try {
                    // 首先尝试从globalCompanyManager中获取
                    if (window.globalCompanyManager && window.globalCompanyManager.companies) {
                        const company = window.globalCompanyManager.companies.find(
                            c => (c.company_id || c.id) == companyId
                        );
                        if (company) {
                            return company.company_name;
                        }
                    }

                    // 如果本地没有找到，从API获取
                    const response = await apiRequest(`/api/companies/${companyId}`, 'GET');
                    if (response.success && response.company) {
                        return response.company.company_name;
                    }

                    // 如果都失败了，返回ID作为备用显示
                    return `公司 ${companyId}`;
                } catch (error) {
                    console.error('[GlobalCompanyManager] 获取公司名称失败:', error);
                    return `公司 ${companyId}`;
                }
            },

            // 根据公司ID获取完整公司信息
            async getCompanyInfo(companyId) {
                try {
                    // console.log('[GlobalCompanyManager] 获取公司信息:', companyId);

                    // 首先尝试从globalCompanyManager中获取
                    if (window.globalCompanyManager && window.globalCompanyManager.companies) {
                        const company = window.globalCompanyManager.companies.find(
                            c => (c.company_id || c.id) == companyId
                        );
                        if (company) {
                            // console.log('[GlobalCompanyManager] 从本地获取到公司信息:', company);
                            return company;
                        }
                    }

                    // 如果本地没有找到，从API获取
                    // console.log('[GlobalCompanyManager] 从API获取公司信息...');
                    const response = await apiRequest(`/api/companies/${companyId}`, 'GET');
                    if (response.success && response.company) {
                        // console.log('[GlobalCompanyManager] API返回公司信息:', response.company);
                        return response.company;
                    }

                    console.warn('[GlobalCompanyManager] 未找到公司信息:', companyId);
                    return null;
                } catch (error) {
                    console.error('[GlobalCompanyManager] 获取公司信息失败:', error);
                    return null;
                }
            },

            // 获取当前选中的公司信息
            async getCurrentCompanyInfo() {
                const companyId = StateManager.getCompanyId();
                if (!companyId) {
                    throw new Error('请先选择公司');
                }
                
                try {
                    const response = await apiRequest(`/api/companies/${companyId}`, 'GET');
                    if (!response.success) {
                        throw new Error(response.error || '获取公司信息失败');
                    }
                    return response.data.company; // 正确解析API响应格式
                } catch (error) {
                    console.error('[GlobalCompanyManager] 获取公司信息失败:', error);
                    throw error;
                }
            },
            
            // 显示当前选中的公司信息
            async displaySelectedCompany() {
                try {
                    const companyId = StateManager.getCompanyId();
                    // console.log('[GlobalCompanyManager] displaySelectedCompany 被调用，companyId:', companyId);
                    
                    if (!companyId) {
                        // console.log('[GlobalCompanyManager] 无选中公司，清空显示');
                        this.clearCompanyDisplay();
                        return;
                    }
                    
                    const companyInfo = await this.getCompanyInfo(companyId);
                    // console.log('[GlobalCompanyManager] 获取到公司信息:', companyInfo);
                    
                    if (companyInfo && companyInfo.company_name) {
                        // console.log('[GlobalCompanyManager] 显示选中公司:', companyInfo.company_name);
                        
                        // 更新商务应答页面中的公司显示
                        const businessCompanyName = document.getElementById('selectedCompanyName');
                        // console.log('[GlobalCompanyManager] selectedCompanyName 元素:', businessCompanyName);

                        if (businessCompanyName) {
                            businessCompanyName.textContent = companyInfo.company_name;
                            businessCompanyName.className = 'text-success fw-bold';
                            console.log('[GlobalCompanyManager] 已更新 selectedCompanyName 显示');
                        } else {
                            console.warn('[GlobalCompanyManager] selectedCompanyName 元素未找到');
                        }
                    } else {
                        console.warn('[GlobalCompanyManager] 公司信息为空或无公司名称');
                        this.clearCompanyDisplay();
                    }
                } catch (error) {
                    console.error('[GlobalCompanyManager] 显示选中公司失败:', error);
                    this.clearCompanyDisplay();
                }
            },
            
            // 清空公司显示
            clearCompanyDisplay() {
                const businessCompanyName = document.getElementById('selectedCompanyName');
                if (businessCompanyName) {
                    businessCompanyName.textContent = '请选择公司';
                    businessCompanyName.className = 'text-muted';
                }
            },

            // 初始化GlobalCompanyManager
            init() {
                if (this._isInitialized) {
                    console.log('[GlobalCompanyManager] 已经初始化过，跳过重复初始化');
                    return;
                }

                console.log('[GlobalCompanyManager] 开始初始化...');

                // 从StateManager恢复状态
                const savedCompanyId = StateManager.getCompanyId();
                if (savedCompanyId) {
                    console.log('[GlobalCompanyManager] 恢复保存的公司状态:', savedCompanyId);
                    this.syncCompanySelectors(savedCompanyId);
                }

                // 绑定事件
                this.bindCompanySelectors();

                // 监听StateManager状态变化
                StateManager.onStateChangeByKey('companyId', (newValue) => {
                    this.updateCompanyStatusUI(newValue);
                });

                // 创建应急修复函数
                this.createEmergencyFix();

                // 设置初始化标志
                this._isInitialized = true;

                console.log('[GlobalCompanyManager] 初始化完成');
            },

            // 创建应急修复函数
            createEmergencyFix() {
                window.emergencyFixDropdown = () => {
                    const dropdown = document.getElementById('businessCompanySelect');
                    if (dropdown && window.globalCompanyManager && window.globalCompanyManager.companies) {
                        console.log('[应急修复] 填充公司下拉菜单...');
                        dropdown.innerHTML = '';

                        // 添加占位符
                        const placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = '请选择公司...';
                        dropdown.appendChild(placeholder);

                        // 添加公司选项
                        window.globalCompanyManager.companies.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.company_id || company.id;
                            option.textContent = company.company_name;
                            dropdown.appendChild(option);
                            console.log('[应急修复] 添加公司选项:', company.company_name);
                        });

                        console.log('[应急修复] 公司选项填充完成，新的选项数量:', dropdown.options.length);
                        return true;
                    }
                    return false;
                };
            },

            // 绑定公司选择器事件
            bindCompanySelectors() {
                console.log('[GlobalCompanyManager] 绑定公司选择器事件');

                const businessSelect = document.getElementById('businessCompanySelect');
                if (businessSelect) {
                    businessSelect.addEventListener('change', (e) => {
                        const companyId = e.target.value;
                        console.log('[GlobalCompanyManager] 公司选择器变更:', companyId);
                        this.syncCompanySelectors(companyId);
                    });
                }

                // 监听globalCompanyManager的加载完成事件
                if (window.globalCompanyManager) {
                    window.globalCompanyManager.addEventListener('companiesLoaded', () => {
                        console.log('[GlobalCompanyManager] 收到公司加载完成事件，执行应急修复');
                        setTimeout(() => {
                            if (window.emergencyFixDropdown) {
                                window.emergencyFixDropdown();
                            }
                        }, 100);
                    });
                }
            }
        };

        // 定义页面就绪函数
        function onPageReady(callback) {
            // 统一初始化：直接执行回调，不再添加新的DOMContentLoaded监听器
            callback();
        }
        
        // 调试函数：检查页面元素状态
        function debugPageElements() {
            const elements = {
                businessCompanySelect: document.getElementById('businessCompanySelect'),
            };
            
            console.log('[调试] 页面元素检查:');
            for (const [name, element] of Object.entries(elements)) {
                if (element) {
                    console.log(`  ${name}: 存在, 选项数量: ${element.options.length}`);
                    for (let i = 0; i < element.options.length; i++) {
                        console.log(`    选项 ${i}: ${element.options[i].value} - ${element.options[i].text}`);
                    }
                } else {
                    console.log(`  ${name}: 不存在`);
                }
            }

            // 检查StateManager状态
            console.log('[调试] StateManager状态:');
            console.log('  当前公司ID:', StateManager.getCompanyId());
            console.log('  页面上下文:', StateManager.getPageContext());
        }
        
        // 页面初始化
        onPageReady(function() {
            console.log('[页面初始化] 开始初始化全局公司管理器和加载公司列表');
            
            // 调试页面元素
            setTimeout(debugPageElements, 100);
            
            // 初始化全局公司管理器
            GlobalCompanyManager.init();
            
            // 监听globalCompanyManager的加载完成事件，并更新选择器
            if (window.globalCompanyManager) {
                window.globalCompanyManager.addEventListener('companiesLoaded', function(event) {
                    console.log('[页面初始化] 监听到公司加载完成事件，更新选择器');
                    if (typeof window.updateAllCompanySelectors === 'function') {
                        window.updateAllCompanySelectors(event.detail.companies);
                    } else if (typeof window.directUpdateCompanyDropdown === 'function') {
                        console.warn('[页面初始化] updateAllCompanySelectors不存在，使用备用函数');
                        window.directUpdateCompanyDropdown(event.detail.companies);
                    } else {
                        console.warn('[页面初始化] 所有全局函数都不存在，使用内联更新');
                        const businessSelect = document.getElementById('businessCompanySelect');
                        if (businessSelect && event.detail.companies) {
                            businessSelect.innerHTML = '';
                            const placeholderOption = document.createElement('option');
                            placeholderOption.value = '';
                            placeholderOption.textContent = '请选择公司...';
                            businessSelect.appendChild(placeholderOption);

                            event.detail.companies.forEach(company => {
                                const option = document.createElement('option');
                                option.value = company.company_id || company.id;
                                option.textContent = company.company_name;
                                businessSelect.appendChild(option);
                            });
                            console.log(`[内联更新] 成功更新下拉菜单，共${event.detail.companies.length}家公司`);
                        }
                    }
                });
            }

            // 额外的备用机制：延迟检查和更新
            setTimeout(function() {
                console.log('[备用机制] 延迟检查公司加载状态');
                if (window.globalCompanyManager && window.globalCompanyManager.companies && window.globalCompanyManager.companies.length > 0) {
                    const businessSelect = document.getElementById('businessCompanySelect');
                    if (businessSelect && businessSelect.options.length <= 1) {
                        console.log('[备用机制] 检测到下拉菜单未更新，强制更新');
                        if (typeof window.directUpdateCompanyDropdown === 'function') {
                            window.directUpdateCompanyDropdown(window.globalCompanyManager.companies);
                        }
                    }
                }
            }, 2000);
            
            // 自动加载现有的投标信息配置
            loadExistingTenderConfig();

            console.log('[页面初始化] 初始化完成');
        });


        // 加载现有的投标信息配置
        function loadExistingTenderConfig() {
            fetch('/api/tender-config')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.config) {
                        console.log('[自动加载] 发现现有投标信息配置，自动显示');

                        // 显示项目基本信息
                        if (data.config.project_info) {
                            displayProjectInfo(data.config.project_info);
                        }

                        // 显示资质要求
                        if (data.config.qualification_requirements) {
                            displayQualificationRequirements(data.config.qualification_requirements);
                        }

                        // 显示技术评分（如果有）
                        if (data.config.technical_scoring) {
                            displayTechnicalScoring(data.config.technical_scoring);
                        }
                    }
                })
                .catch(error => {
                    console.log('[自动加载] 没有发现现有投标信息配置或加载失败:', error);
                });
        }
        
        // 防止重复加载的标志
        let isLoadingCompanyList = false;
        let companyListCache = null;
        
        // 加载公司列表
        async function loadCompanyList() {
            // 防止重复调用
            if (isLoadingCompanyList) {
                console.log('[loadCompanyList] 正在加载中，跳过重复调用');
                return companyListCache?.companies || [];
            }
            
            // 如果有缓存且时间不超过5分钟，直接使用缓存
            if (companyListCache && companyListCache.timestamp && 
                (Date.now() - companyListCache.timestamp) < 300000) {
                console.log('[loadCompanyList] 使用缓存的公司列表');
                const cachedCompanies = companyListCache.companies || [];
                updateAllCompanySelectors(cachedCompanies);
                return cachedCompanies;
            }
            
            isLoadingCompanyList = true;
            
            try {
                console.log('[loadCompanyList] 开始从API加载公司列表');
                const apiResponse = await apiRequest('/api/companies', 'GET');
                console.log('[loadCompanyList] API响应结构:', apiResponse);
                
                // apiRequest返回格式：{success: true, data: {...}} 或 {success: false, error: '...'}
                if (!apiResponse.success) {
                    throw new Error(apiResponse.error || 'API调用失败');
                }
                
                const responseData = apiResponse.data;
                console.log('[loadCompanyList] 提取的响应数据:', responseData);
                
                // 处理后端API返回的 {success: true, data: []} 格式
                let companies = [];
                if (responseData && Array.isArray(responseData)) {
                    // 直接是数组格式
                    companies = responseData;
                } else if (responseData && responseData.companies && Array.isArray(responseData.companies)) {
                    // {companies: [...]} 格式
                    companies = responseData.companies;
                } else if (responseData && typeof responseData === 'object') {
                    console.warn('[loadCompanyList] 响应数据格式异常，尝试提取data或companies字段:', responseData);
                    // 优先尝试data字段，再尝试companies字段
                    companies = responseData.data || responseData.companies || [];
                } else {
                    console.error('[loadCompanyList] 无法解析的响应数据格式:', responseData);
                    companies = [];
                }
                
                console.log('[loadCompanyList] 最终解析的公司列表:', companies);
                
                // 确保companies是数组
                if (!Array.isArray(companies)) {
                    console.error('[loadCompanyList] 公司数据不是数组格式:', typeof companies, companies);
                    companies = [];
                }
                
                // 更新缓存
                companyListCache = {
                    companies: companies,
                    timestamp: Date.now()
                };
                
                // 更新所有选择器
                updateAllCompanySelectors(companies);
                
                return companies;
                
            } catch (error) {
                console.error('[loadCompanyList] 加载公司列表失败:', error);
                throw error;
            } finally {
                isLoadingCompanyList = false;
            }
        }
        
        // 更新所有公司选择器的统一函数
        function updateAllCompanySelectors(companies) {
            // 强化数据验证
            if (!companies) {
                console.warn('[updateAllCompanySelectors] companies参数为空，使用空数组');
                companies = [];
            }
            
            if (!Array.isArray(companies)) {
                console.error('[updateAllCompanySelectors] companies参数必须是数组，收到:', typeof companies, companies);
                // 尝试转换或使用空数组
                if (companies && typeof companies === 'object' && companies.companies) {
                    companies = companies.companies;
                } else {
                    companies = [];
                }
            }
            
            console.log(`[updateAllCompanySelectors] 更新所有公司选择器，共 ${companies.length} 家公司`, companies);

            // 更新商务应答选择器
            const businessSelect = document.getElementById('businessCompanySelect');
            if (businessSelect) {
                businessSelect.innerHTML = '';
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = '请选择公司...';
                businessSelect.appendChild(placeholderOption);

                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.company_id || company.id;
                    option.textContent = company.company_name;
                    businessSelect.appendChild(option);
                });
                console.log('[updateAllCompanySelectors] 已更新businessCompanySelect选择器');
            }

            // 恢复选中状态
            const savedCompanyId = StateManager.getCompanyId();
            if (savedCompanyId) {
                console.log(`[updateAllCompanySelectors] 恢复保存的公司选择: ${savedCompanyId}`);
                if (typeof GlobalCompanyManager !== 'undefined') {
                    GlobalCompanyManager.syncCompanySelectors(savedCompanyId);
                }
            }
        }

        // 暴露函数到全局作用域以便事件监听器访问
        window.updateAllCompanySelectors = updateAllCompanySelectors;

        // 确保函数正确暴露的验证
        console.log('[函数暴露] updateAllCompanySelectors函数类型:', typeof window.updateAllCompanySelectors);

        // 添加一个备用的直接更新函数
        window.directUpdateCompanyDropdown = function(companies) {
            console.log('[备用函数] 直接更新公司下拉菜单', companies);
            const businessSelect = document.getElementById('businessCompanySelect');
            if (!businessSelect) {
                console.warn('[备用函数] 找不到businessCompanySelect元素');
                return;
            }

            // 清空并重新填充
            businessSelect.innerHTML = '';

            // 添加占位符选项
            const placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = '请选择公司...';
            businessSelect.appendChild(placeholderOption);

            // 添加公司选项
            if (companies && Array.isArray(companies)) {
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.company_id || company.id;
                    option.textContent = company.company_name;
                    businessSelect.appendChild(option);
                });
                console.log(`[备用函数] 成功更新下拉菜单，共${companies.length}家公司`);
            }
        };

        // ===================
        // AI模型管理功能
        // ===================

        // 模型管理对象
        const ModelManager = {
            _initialized: false,
            currentModels: [],
            currentModel: 'unicom-yuanjing',

            // 加载AI模型列表
            async loadModels() {
                try {
                    const response = await fetch('/api/models');
                    const data = await response.json();

                    if (data.success && data.models) {
                        this.currentModels = data.models;
                        this.updateModelSelect();
                        console.log(`加载了 ${data.count} 个AI模型`);
                    } else {
                        console.error('加载模型列表失败:', data.error);
                        showNotification('加载模型列表失败', 'error');
                    }
                } catch (error) {
                    console.error('获取模型列表失败:', error);
                    showNotification('获取模型列表失败', 'error');
                }
            },

            // 更新模型选择下拉框
            updateModelSelect() {
                const aiModelSelect = document.getElementById('aiModel');
                if (!aiModelSelect) return;

                // 保存当前选中的模型
                const currentValue = aiModelSelect.value;

                // 清空并重新填充选项
                aiModelSelect.innerHTML = '';

                this.currentModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.display_name || model.name;

                    // 添加状态信息到选项文本
                    if (model.status === 'no_api_key') {
                        option.textContent += ' (未配置)';
                        option.disabled = true;
                    } else if (model.status === 'available') {
                        option.textContent += ' ✓';
                    }

                    aiModelSelect.appendChild(option);
                });

                // 恢复之前选中的模型，如果不存在则选择第一个可用的
                if (currentValue && Array.from(aiModelSelect.options).some(opt => opt.value === currentValue)) {
                    aiModelSelect.value = currentValue;
                } else {
                    // 选择第一个可用的模型
                    const availableOption = Array.from(aiModelSelect.options).find(opt => !opt.disabled);
                    if (availableOption) {
                        aiModelSelect.value = availableOption.value;
                    }
                }

                this.updateModelStatus();
            },

            // 更新模型状态显示
            updateModelStatus() {
                const aiModelSelect = document.getElementById('aiModel');
                const modelStatus = document.getElementById('modelStatus');
                const statusIcon = document.getElementById('modelStatusIcon');
                const statusText = document.getElementById('modelStatusText');

                if (!aiModelSelect || !modelStatus) return;

                const selectedModel = this.currentModels.find(m => m.name === aiModelSelect.value);

                if (selectedModel) {
                    modelStatus.style.display = 'block';

                    if (selectedModel.status === 'available') {
                        statusIcon.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
                        statusText.textContent = `${selectedModel.provider} - ${selectedModel.status_message}`;
                        statusText.className = 'text-success';
                    } else if (selectedModel.status === 'no_api_key') {
                        statusIcon.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i>';
                        statusText.textContent = `${selectedModel.provider} - ${selectedModel.status_message}`;
                        statusText.className = 'text-warning';
                    } else {
                        statusIcon.innerHTML = '<i class="bi bi-question-circle text-muted"></i>';
                        statusText.textContent = `${selectedModel.provider} - 状态未知`;
                        statusText.className = 'text-muted';
                    }

                    // 显示模型描述（如果有）
                    if (selectedModel.description) {
                        statusText.textContent += ` - ${selectedModel.description}`;
                    }
                } else {
                    modelStatus.style.display = 'none';
                }
            },

            // 验证模型配置
            async validateModel(modelName) {
                try {
                    showNotification('正在验证模型配置...', 'info');

                    const response = await fetch(`/api/models/${modelName}/validate`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.success && data.validation.valid) {
                        showNotification(`模型 ${modelName} 配置验证成功`, 'success');
                        return true;
                    } else {
                        const error = data.validation?.error || data.error || '验证失败';
                        showNotification(`模型 ${modelName} 配置验证失败: ${error}`, 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('验证模型配置失败:', error);
                    showNotification('验证模型配置失败', 'error');
                    return false;
                }
            },

            // 初始化模型管理器
            init() {
                if (this._initialized) {
                    console.log('[ModelManager] 已经初始化，跳过重复初始化');
                    return;
                }

                console.log('[ModelManager] 正在初始化...');

                // 加载模型列表
                this.loadModels();

                // 绑定模型选择器事件
                const aiModelSelect = document.getElementById('aiModel');
                if (aiModelSelect) {
                    aiModelSelect.addEventListener('change', () => {
                        this.currentModel = aiModelSelect.value;
                        this.updateModelStatus();
                    });
                }

                // 更新模型状态显示
                this.updateModelStatus();

                this._initialized = true;
                console.log('[ModelManager] 初始化完成');
            }
        };

        // 刷新模型列表
        function refreshModels() {
            ModelManager.loadModels();
        }

        // 模型选择变化事件
        function onModelChange() {
            ModelManager.currentModel = document.getElementById('aiModel').value;
            ModelManager.updateModelStatus();
        }

        // ====== 统一初始化管理器 ======
        const AppInitializer = {
            _initialized: false,

            async init() {
                if (this._initialized) {
                    console.log('[AppInitializer] 已经初始化过，跳过重复初始化');
                    return;
                }

                console.log('[AppInitializer] 开始统一初始化...');
                this._initialized = true;

                try {
                    // 1. 初始化ModelManager
                    ModelManager.init();

                    // 2. 初始化招标信息提取功能
                    this.initTenderInfoExtraction();

                    // 6. 初始化UI组件
                    this.initUIComponents();

                    console.log('[AppInitializer] 统一初始化完成');
                } catch (error) {
                    console.error('[AppInitializer] 初始化失败:', error);
                }
            },

            initTenderInfoExtraction() {
                console.log('[AppInitializer] 初始化招标信息提取功能...');

                const tenderUploadArea = document.getElementById('tenderUploadArea');
                const tenderFileInput = document.getElementById('tenderFileInput');
                const tenderFileInfo = document.getElementById('tenderFileInfo');
                const tenderFileName = document.getElementById('tenderFileName');
                const tenderFileSize = document.getElementById('tenderFileSize');
                const extractInfoBtn = document.getElementById('extractInfoBtn');

                if (!tenderUploadArea || !tenderFileInput) {
                    console.log('[AppInitializer] 招标信息提取相关元素未找到，跳过初始化');
                    return;
                }

                // 上传区域点击事件
                tenderUploadArea.addEventListener('click', () => {
                    console.log('Tender upload area clicked');
                    tenderFileInput.click();
                });

                // 拖拽上传
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    tenderUploadArea.addEventListener(eventName, preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.add('dragover'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.remove('dragover'), false);
                });

                tenderUploadArea.addEventListener('drop', handleTenderDrop, false);

                function handleTenderDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length > 0) {
                        tenderFileInput.files = files;
                        handleTenderFileSelect();
                    }
                }

                tenderFileInput.addEventListener('change', handleTenderFileSelect);

                function handleTenderFileSelect() {
                    console.log('handleTenderFileSelect called');
                    const file = tenderFileInput.files[0];
                    console.log('Selected file:', file);
                    if (file) {
                        console.log('File details:', file.name, file.size);
                        tenderFileName.textContent = file.name;
                        tenderFileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                        tenderFileInfo.style.display = 'block';
                        extractInfoBtn.disabled = false;
                        console.log('File info updated, extract button enabled');
                    } else {
                        console.log('No file selected');
                    }
                }

                // 提取信息按钮事件
                if (extractInfoBtn) {
                    extractInfoBtn.addEventListener('click', function() {
                        submitTenderExtraction();
                    });
                }

                // 重试和重置按钮事件
                const tenderRetryBtn = document.getElementById('tenderRetryBtn');
                const tenderRetryBtn2 = document.getElementById('tenderRetryBtn2');
                const tenderResetBtn = document.getElementById('tenderResetBtn');
                const tenderResetBtn2 = document.getElementById('tenderResetBtn2');

                if (tenderRetryBtn) {
                    tenderRetryBtn.addEventListener('click', function() {
                        submitTenderExtraction();
                    });
                }

                if (tenderRetryBtn2) {
                    tenderRetryBtn2.addEventListener('click', function() {
                        submitTenderExtraction();
                    });
                }

                if (tenderResetBtn) {
                    tenderResetBtn.addEventListener('click', function() {
                        tenderFileInput.value = '';
                        tenderFileInfo.style.display = 'none';
                        document.getElementById('tenderResultArea').style.display = 'none';
                        document.getElementById('tenderErrorArea').style.display = 'none';
                        document.getElementById('splitDocumentsArea').style.display = 'none';
                        extractInfoBtn.disabled = true;
                        extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始提取信息';
                    });
                }

                if (tenderResetBtn2) {
                    tenderResetBtn2.addEventListener('click', function() {
                        tenderFileInput.value = '';
                        tenderFileInfo.style.display = 'none';
                        document.getElementById('tenderResultArea').style.display = 'none';
                        document.getElementById('tenderErrorArea').style.display = 'none';
                        document.getElementById('splitDocumentsArea').style.display = 'none';
                        extractInfoBtn.disabled = true;
                        extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始提取信息';
                    });
                }
            },


            initUIComponents() {
                console.log('[AppInitializer] 初始化UI组件...');

                // 侧边栏切换功能
                const sidebarToggle = document.getElementById('sidebarToggle');
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', function() {
                        const sidebar = document.getElementById('sidebar-wrapper');

                        if (window.innerWidth <= 768) {
                            sidebar.classList.toggle('show');
                        } else {
                            // 桌面端侧边栏收缩
                            if (sidebar.style.marginLeft === '-280px') {
                                sidebar.style.marginLeft = '0';
                            } else {
                                sidebar.style.marginLeft = '-280px';
                            }
                        }
                    });
                }

                // 移动端点击其他区域关闭侧边栏
                document.addEventListener('click', function(e) {
                    const sidebar = document.getElementById('sidebar-wrapper');
                    const toggle = document.getElementById('sidebarToggle');

                    if (window.innerWidth <= 768 &&
                        sidebar.classList.contains('show') &&
                        !sidebar.contains(e.target) &&
                        !toggle.contains(e.target)) {
                        sidebar.classList.remove('show');
                    }
                });

                // 初始化统计图表
                if (typeof initCharts === 'function') {
                    initCharts();
                }

                // 添加卡片悬停动画
                document.querySelectorAll('.stat-card').forEach(card => {
                    card.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateY(-5px) scale(1.02)';
                    });

                    card.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateY(0) scale(1)';
                    });
                });
            }
        };

        // 页面加载完成后统一初始化
        document.addEventListener('DOMContentLoaded', function() {
            AppInitializer.init();

            // 添加按钮点击动画
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });
        });

        // 初始化图表函数
        function initCharts() {
            // 使用趋势图表
            const usageCtx = document.getElementById('usageChart');
            if (usageCtx) {
                new Chart(usageCtx, {
                    type: 'line',
                    data: {
                        labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                        datasets: [{
                            label: '模型调用次数',
                            data: [65, 59, 80, 81, 56, 95],
                            borderColor: '#4fc3f7',
                            backgroundColor: 'rgba(79, 195, 247, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // 类型分布图表
            const typeCtx = document.getElementById('typeChart');
            if (typeCtx) {
                new Chart(typeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['招标信息提取', '商务应答', '技术方案', '点对点应答'],
                        datasets: [{
                            data: [40, 25, 20, 15],
                            backgroundColor: [
                                '#4fc3f7',
                                '#ff6b35',
                                '#667eea',
                                '#4caf50'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }
        }

        // 加载状态管理
        function showLoading(element, text = '加载中...') {
            const loadingHTML = `
                <div class="d-flex justify-content-center align-items-center p-4">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="text-muted">${text}</span>
                </div>
            `;
            element.innerHTML = loadingHTML;
        }

        function hideLoading(element, content) {
            element.innerHTML = content;
        }

        // 通知系统
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        // 数字动画效果
        function animateValue(element, start, end, duration) {
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                if (current === end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        // 页面加载完成后启动数字动画
        window.addEventListener('load', function() {
            document.querySelectorAll('.stat-number').forEach(el => {
                const finalValue = parseInt(el.textContent) || 0;
                if (finalValue > 0) {
                    el.textContent = '0';
                    setTimeout(() => {
                        animateValue(el, 0, finalValue, 1000);
                    }, 500);
                }
            });
        });

        // 切换选项卡函数
        function switchToTab(tabId) {
            // 移除所有活跃状态
            document.querySelectorAll('.list-group-item-action').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });

            // 激活指定的导航项和选项卡
            const navItem = document.querySelector(`[data-bs-target="#${tabId}"]`);
            const tabPane = document.querySelector(`#${tabId}`);

            if (navItem && tabPane) {
                navItem.classList.add('active');
                tabPane.classList.add('show', 'active');
            }
        }
    </script>

            </div>
        </div>
    </div>

</body>
</html>