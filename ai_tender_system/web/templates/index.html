<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>å…ƒæ™¯AIæ™ºèƒ½æ ‡ä¹¦ç”Ÿæˆå¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/litera/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js for modern charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <!-- TinyMCE Editor -->
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <!-- å…¬å¸ç®¡ç†æ¨¡å— -->
    <script src="/static/js/company-config.js"></script>
    <script src="/static/js/company-manager.js"></script>
    <style>
        /* ä¸“ä¸šå•†åŠ¡é£é…è‰²æ–¹æ¡ˆ - è¦†ç›–Bootstrapé»˜è®¤é¢œè‰² */
        :root {
            --bs-primary: #4a89dc;
            --bs-primary-rgb: 74, 137, 220;
            --bs-success: #48cfad;
            --bs-success-rgb: 72, 207, 173;
            --bs-warning: #eb7d3c;
            --bs-warning-rgb: 235, 125, 60;
            --bs-danger: #da4453;
            --bs-danger-rgb: 218, 68, 83;
            --bs-info: #5dade2;
            --bs-info-rgb: 93, 173, 226;
        }

        .upload-area {
            border: 2px dashed #4a89dc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #3d6cb9;
            background: #f4f7ff;
            box-shadow: 0 4px 12px rgba(74, 137, 220, 0.1);
        }
        .upload-area.dragover {
            border-color: #48cfad;
            background: #e8f9f5;
        }
        .feature-card {
            transition: transform 0.2s ease;
            height: 100%;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .progress {
            display: none;
        }
        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .api-status.success {
            background-color: rgba(72, 207, 173, 0.1);
            color: #2a7a68;
            border: 1px solid #48cfad;
        }
        .api-status.error {
            background-color: rgba(218, 68, 83, 0.1);
            color: #8b1a26;
            border: 1px solid #da4453;
        }
        .footer {
            margin-top: 60px;
            padding: 20px 0;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
        }
        
        /* æ”¹å–„æ¨¡æ€æ¡†æ˜¾ç¤º */
        .modal-backdrop {
            backdrop-filter: blur(3px);
        }
        
        .modal {
            z-index: 1055;
        }
        
        /* æœªä¿å­˜çŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
        .unsaved-indicator {
            color: #da4453;
            font-weight: bold;
            animation: pulse-indicator 2s infinite;
            margin-left: 5px;
        }
        
        @keyframes pulse-indicator {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* æ ‡ç­¾é¡µæ”¹è¿›æ ·å¼ */
        .nav-pills .nav-link {
            position: relative;
        }
        
        /* å¼•å¯¼æç¤ºæ ·å¼ */
        .guide-alert {
            background: linear-gradient(45deg, #f4f7ff, #f8f9fa);
            border: 1px solid #4a89dc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .guide-alert .bi {
            color: #4a89dc;
            margin-right: 8px;
        }

        /* æ‹†åˆ†æ–‡ä»¶å¡ç‰‡æ ·å¼ */
        .split-document-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }

        .split-document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 137, 220, 0.15);
            border-color: #4a89dc;
        }

        .split-document-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .split-document-meta {
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 10px;
        }

        .split-document-actions .btn {
            margin-right: 8px;
            margin-bottom: 5px;
        }

        /* å¢å¼ºçš„æŒ‰é’®æ ·å¼ */
        .btn-primary {
            background: linear-gradient(135deg, #4a89dc, #74b9ff);
            border: none;
            box-shadow: 0 2px 4px rgba(74, 137, 220, 0.2);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #3d6cb9, #4a89dc);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 137, 220, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #48cfad, #5dade2);
            border: none;
            box-shadow: 0 2px 4px rgba(72, 207, 173, 0.2);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #3ea99f, #48cfad);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(72, 207, 173, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #eb7d3c, #f39c12);
            border: none;
            box-shadow: 0 2px 4px rgba(235, 125, 60, 0.2);
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400, #eb7d3c);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(235, 125, 60, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #da4453, #e74c3c);
            border: none;
            box-shadow: 0 2px 4px rgba(218, 68, 83, 0.2);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #da4453);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(218, 68, 83, 0.3);
        }

        /* å¡ç‰‡æ‚¬æµ®æ•ˆæœä¼˜åŒ– */
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* æ–°ä¾§è¾¹æ æ ·å¼ - ç«‹å³ç”Ÿæ•ˆ */
        #sidebar-wrapper {
            min-height: 100vh !important;
            width: 280px !important;
            background: #ffffff !important;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.08) !important;
            border-right: 1px solid #f0f0f0 !important;
        }

        #sidebar-wrapper .sidebar-header {
            background: #ffffff !important;
            color: #333 !important;
            border-bottom: 1px solid #f0f0f0 !important;
            padding: 1.5rem 1.2rem !important;
        }

        #sidebar-wrapper .sidebar-header h6 {
            color: #666 !important;
            font-weight: 500 !important;
            font-size: 0.85rem !important;
            letter-spacing: 0.5px !important;
            margin: 0 !important;
            text-transform: uppercase !important;
        }

        #sidebar-wrapper .list-group-item {
            border: none !important;
            border-radius: 0 !important;
            padding: 0.9rem 1.2rem !important;
            transition: all 0.2s ease !important;
            margin: 0 !important;
            font-weight: 400 !important;
            font-size: 0.9rem !important;
            color: #666 !important;
            background: transparent !important;
            position: relative !important;
            border-left: 3px solid transparent !important;
        }

        #sidebar-wrapper .list-group-item:hover {
            background: #f8f9fa !important;
            color: #333 !important;
            border-left-color: #e0e0e0 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        #sidebar-wrapper .list-group-item.active {
            background: #f4f7ff !important;
            color: #4a89dc !important;
            border-left-color: #4a89dc !important;
            font-weight: 500 !important;
            transform: none !important;
            box-shadow: none !important;
        }

        #sidebar-wrapper .list-group-item.active:hover {
            background: #eef3ff !important;
        }

        #sidebar-wrapper .list-group-item.active::before {
            display: none !important;
        }

        #sidebar-wrapper .list-group-item i {
            width: 16px !important;
            text-align: center !important;
            margin-right: 0.75rem !important;
            font-size: 0.9rem !important;
        }

        /* ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’®æ ·å¼ - å‚è€ƒå…ƒæ™¯å¹³å° */
        .sidebar-toggle-btn {
            background: #ffffff !important;
            border: 1px solid #e0e0e0 !important;
            border-radius: 6px !important;
            width: 40px !important;
            height: 40px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            color: #666 !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08) !important;
            transition: all 0.2s ease !important;
        }

        .sidebar-toggle-btn:hover {
            background: #f8f9fa !important;
            border-color: #d0d0d0 !important;
            color: #333 !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.12) !important;
        }

        .sidebar-toggle-btn:active {
            background: #e9ecef !important;
            transform: translateY(0) !important;
        }

        /* åº”ç”¨èœå•ä¸‹æ‹‰æ ·å¼ */
        .dropdown-menu {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        .dropdown-item {
            padding: 10px 16px;
            transition: all 0.2s ease;
        }
        .dropdown-item:hover {
            background-color: #f8f9fa;
            color: #e60012;
        }
        .dropdown-item.active {
            background-color: #e60012;
            color: white;
        }
        .dropdown-item i {
            width: 16px;
            text-align: center;
        }

        .sidebar-toggle-btn i {
            font-size: 18px !important;
        }

        /* å›ºå®šé¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 1030 !important;
            background: white !important;
        }

        /* è°ƒæ•´bodyçš„ä¸Šè¾¹è·ï¼Œé¿å…å†…å®¹è¢«å¯¼èˆªæ é®æŒ¡ */
        body {
            padding-top: 70px !important;
        }

        /* è°ƒæ•´ä¾§è¾¹æ çš„ä½ç½®ï¼Œä»å¯¼èˆªæ ä¸‹æ–¹å¼€å§‹ */
        #sidebar-wrapper {
            position: fixed !important;
            top: 70px !important;
            left: 0 !important;
            height: calc(100vh - 70px) !important;
            min-height: auto !important;
        }

        /* è°ƒæ•´ä¸»å†…å®¹åŒºåŸŸï¼Œç•™å‡ºä¾§è¾¹æ ç©ºé—´ */
        #page-content-wrapper {
            margin-left: 280px !important;
            width: calc(100% - 280px) !important;
            min-height: calc(100vh - 70px) !important;
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            #sidebar-wrapper {
                margin-left: -280px !important;
            }

            #page-content-wrapper {
                margin-left: 0 !important;
                width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <!-- ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’® -->
            <button class="btn sidebar-toggle-btn me-3" type="button" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>

            <div class="navbar-brand d-flex align-items-center">
                <!-- ä¸­å›½è”é€šå®˜æ–¹Logo -->
                <div class="unicom-logo me-3">
                    <svg width="120" height="40" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="unicomKnotGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#e60012;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#d10000;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#c00000;stop-opacity:1" />
                            </linearGradient>
                        </defs>

                        <!-- ä¸­å›½è”é€šç»“ç»³æ ‡å¿— -->
                        <g transform="translate(5, 5)">
                            <!-- ä¸­å¿ƒåœ†å½¢ -->
                            <circle cx="25" cy="25" r="4" fill="url(#unicomKnotGradient)"/>

                            <!-- å·¦ä¾§ç»“ç»³ -->
                            <path d="M10 15 Q5 10 10 5 Q15 10 20 5 Q25 10 20 15 Q15 20 20 25 Q25 20 20 15"
                                  fill="url(#unicomKnotGradient)" stroke="none"/>

                            <!-- å³ä¾§ç»“ç»³ -->
                            <path d="M30 15 Q35 10 40 15 Q35 20 40 25 Q35 30 30 25 Q25 20 30 15"
                                  fill="url(#unicomKnotGradient)" stroke="none"/>

                            <!-- ä¸Šä¾§ç»“ç»³ -->
                            <path d="M15 10 Q10 5 15 0 Q20 5 25 0 Q30 5 25 10 Q20 15 25 20 Q30 15 25 10"
                                  fill="url(#unicomKnotGradient)" stroke="none"/>

                            <!-- ä¸‹ä¾§ç»“ç»³ -->
                            <path d="M15 40 Q10 45 15 50 Q20 45 25 50 Q30 45 25 40 Q20 35 25 30 Q30 35 25 40"
                                  fill="url(#unicomKnotGradient)" stroke="none"/>

                            <!-- è£…é¥°æ€§è¿æ¥çº¿ -->
                            <path d="M15 25 Q20 20 25 25 Q30 30 35 25 Q30 20 25 25 Q20 30 15 25"
                                  fill="url(#unicomKnotGradient)" opacity="0.8" stroke="none"/>
                        </g>

                        <!-- ä¸­å›½è”é€šæ–‡å­— -->
                        <g transform="translate(60, 8)">
                            <!-- ä¸­å›½è”é€š -->
                            <text x="0" y="18" fill="#333" font-family="PingFang SC, Microsoft YaHei, sans-serif" font-size="16" font-weight="bold">ä¸­å›½è”é€š</text>
                            <!-- China Unicom -->
                            <text x="0" y="35" fill="#666" font-family="Arial, sans-serif" font-size="11" font-weight="normal">China unicom</text>
                        </g>
                    </svg>
                </div>

                <div class="brand-text ms-2">
                    <h4 class="mb-0 brand-title">å…ƒæ™¯AIæ™ºèƒ½æ ‡ä¹¦ç”Ÿæˆå¹³å°</h4>
                    <small class="text-muted brand-subtitle">Powered by China Unicom</small>
                </div>
            </div>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-grid-3x3-gap me-2"></i>
                            åº”ç”¨èœå•
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item active" href="/"><i class="bi bi-house me-2"></i>æ ‡ä¹¦ç”Ÿæˆ</a></li>
                            <li><a class="dropdown-item" href="/knowledge_base"><i class="bi bi-collection me-2"></i>çŸ¥è¯†åº“ç®¡ç†</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>ç³»ç»Ÿè®¾ç½®</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-muted" href="#" title="é€šçŸ¥">
                            <i class="bi bi-bell"></i>
                            <span class="badge bg-danger badge-sm">2</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle text-muted" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> ç”¨æˆ·
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>ä¸ªäººä¿¡æ¯</a></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>ç³»ç»Ÿè®¾ç½®</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>é€€å‡ºç™»å½•</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»ä½“å¸ƒå±€ -->
    <div class="d-flex" id="wrapper">
        <!-- ä¾§è¾¹æ  -->
        <div class="bg-light border-end" id="sidebar-wrapper">
            <div class="list-group list-group-flush" style="padding-top: 1rem;">
                <a href="#" class="list-group-item list-group-item-action active" id="home-nav" data-bs-toggle="pill" data-bs-target="#home">
                    <i class="bi bi-house me-2"></i>é¦–é¡µ
                </a>
                <a href="#" class="list-group-item list-group-item-action" id="tender-info-nav" data-bs-toggle="pill" data-bs-target="#tender-info">
                    <i class="bi bi-upload me-2"></i>ä¸Šä¼ æ ‡ä¹¦
                </a>
                <a href="#" class="list-group-item list-group-item-action" id="business-response-nav" data-bs-toggle="pill" data-bs-target="#business-response">
                    <i class="bi bi-briefcase me-2"></i>å•†åŠ¡åº”ç­”
                </a>
                <a href="#" class="list-group-item list-group-item-action" id="point-to-point-nav" data-bs-toggle="pill" data-bs-target="#point-to-point">
                    <i class="bi bi-chat-dots me-2"></i>ç‚¹å¯¹ç‚¹åº”ç­”
                </a>
                <a href="#" class="list-group-item list-group-item-action" id="tech-proposal-nav" data-bs-toggle="pill" data-bs-target="#tech-proposal">
                    <i class="bi bi-file-earmark-code me-2"></i>æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆ
                </a>
                <a href="/knowledge_base?action=company_management" class="list-group-item list-group-item-action">
                    <i class="bi bi-building me-2"></i>å…¬å¸ç®¡ç†
                </a>
                <a href="/knowledge_base" class="list-group-item list-group-item-action">
                    <i class="bi bi-collection me-2"></i>çŸ¥è¯†åº“ç®¡ç†
                </a>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div id="page-content-wrapper">
            <div class="container-fluid p-4">

        <div class="tab-content" id="mainTabContent">
            <!-- é¦–é¡µé€‰é¡¹å¡ -->
            <div class="tab-pane fade show active" id="home" role="tabpanel">
                <!-- ç³»ç»Ÿç»Ÿè®¡é¢æ¿ -->
                <div class="row mb-5">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-bar-chart"></i> ç³»ç»Ÿç»Ÿè®¡
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-3 col-md-6 mb-4">
                                        <div class="stat-card text-center">
                                            <div class="stat-icon mb-3">
                                                <i class="bi bi-file-text fs-1"></i>
                                            </div>
                                            <div class="stat-number">137</div>
                                            <div class="stat-label">æ¨¡å‹æ€»æ•°</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-4">
                                        <div class="stat-card text-center bg-info">
                                            <div class="stat-icon mb-3">
                                                <i class="bi bi-cpu fs-1"></i>
                                            </div>
                                            <div class="stat-number">0</div>
                                            <div class="stat-label">æˆ‘çš„æ¨¡å‹</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-4">
                                        <div class="stat-card text-center bg-warning">
                                            <div class="stat-icon mb-3">
                                                <i class="bi bi-clock-history fs-1"></i>
                                            </div>
                                            <div class="stat-number">0</div>
                                            <div class="stat-label">è°ƒç”¨æ¬¡æ•°</div>
                                        </div>
                                    </div>
                                    <div class="col-lg-3 col-md-6 mb-4">
                                        <div class="stat-card text-center bg-success">
                                            <div class="stat-icon mb-3">
                                                <i class="bi bi-check-circle fs-1"></i>
                                            </div>
                                            <div class="stat-number">100%</div>
                                            <div class="stat-label">æˆåŠŸç‡</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- å›¾è¡¨åŒºåŸŸ -->
                                <div class="row mt-4">
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-muted mb-3">æ¨¡å‹ä½¿ç”¨è¶‹åŠ¿</h6>
                                        <canvas id="usageChart" height="200"></canvas>
                                    </div>
                                    <div class="col-lg-6 mb-4">
                                        <h6 class="text-muted mb-3">è°ƒç”¨ç±»å‹åˆ†å¸ƒ</h6>
                                        <canvas id="typeChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œé¢æ¿ -->
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-search text-primary display-1"></i>
                                <h5 class="mt-3">æ™ºèƒ½æå–</h5>
                                <p class="text-muted">AIè‡ªåŠ¨è¯†åˆ«æ‹›æ ‡æ–‡ä»¶ä¸­çš„å…³é”®ä¿¡æ¯</p>
                                <button class="btn btn-primary" onclick="switchToTab('tender-info')">
                                    å¼€å§‹æå–
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-briefcase text-success display-1"></i>
                                <h5 class="mt-3">å•†åŠ¡åº”ç­”</h5>
                                <p class="text-muted">ç”Ÿæˆä¸“ä¸šçš„å•†åŠ¡åº”ç­”æ–‡æ¡£</p>
                                <button class="btn btn-success" onclick="switchToTab('business-response')">
                                    ç«‹å³ç”Ÿæˆ
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card feature-card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-building text-warning display-1"></i>
                                <h5 class="mt-3">å…¬å¸ç®¡ç†</h5>
                                <p class="text-muted">ç®¡ç†å…¬å¸ä¿¡æ¯å’Œèµ„è´¨æ–‡ä»¶</p>
                                <button class="btn btn-warning" onclick="window.location.href='/knowledge_base?action=company_management';">
                                    ç®¡ç†å…¬å¸
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç²¾ç®€ç‰ˆæƒä¿¡æ¯ -->
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="text-center py-3 border-top">
                            <small class="text-muted">
                                Â© 2025 å…ƒæ™¯AIæ™ºèƒ½æ ‡ä¹¦ç”Ÿæˆå¹³å° |
                                <a href="/help.html" class="text-decoration-none text-muted">
                                    <i class="bi bi-question-circle"></i> å¸®åŠ©
                                </a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸Šä¼ æ ‡ä¹¦é€‰é¡¹å¡ -->
            <div class="tab-pane fade" id="tender-info" role="tabpanel">

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-cloud-upload"></i> æ‹›æ ‡æ–‡æ¡£ä¸Šä¼ 
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="tenderUploadArea">
                                <i class="bi bi-cloud-upload-fill text-primary display-1"></i>
                                <h5 class="mt-3">æ‹–æ”¾æ‹›æ ‡æ–‡æ¡£åˆ°æ­¤å¤„</h5>
                                <p class="text-muted mb-3">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                                <p class="text-muted small">
                                    æ”¯æŒæ ¼å¼ï¼šWordæ–‡æ¡£ (.docx, .doc)ã€æ–‡æœ¬æ–‡ä»¶ (.txt)ã€PDFæ–‡ä»¶ (.pdf)
                                </p>
                                <input type="file" d-none" id="tenderFileInput"
                                       accept=".docx,.doc,.txt,.pdf">
                            </div>

                            <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º -->
                            <div class="mt-3 d-none" id="tenderFileInfo">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    å·²é€‰æ‹©æ–‡ä»¶ï¼š<strong id="tenderFileName"></strong>
                                    <span class="text-muted" id="tenderFileSize"></span>
                                </div>
                            </div>

                            <!-- æå–æŒ‰é’® -->
                            <div class="text-center mt-4">
                                <button class="btn btn-primary btn-lg" type="button" id="extractInfoBtn" disabled>
                                    <i class="bi bi-play-circle"></i> å¼€å§‹æå–ä¿¡æ¯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress mb-2 d-none" id="tenderProgressBar">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <div class="text-center mb-4 d-none text-primary" id="stepMessage">
                æ­£åœ¨æå–æ‹›æ ‡ä¿¡æ¯...
            </div>

            <!-- æå–ç»“æœæ˜¾ç¤º -->
            <div class="row d-none" id="tenderResultArea">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-check-circle"></i> æ‹›æ ‡ä¿¡æ¯æå–å®Œæˆ
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="tenderInfoDisplay">
                                <!-- æå–ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>

                            <!-- æ‹†åˆ†æ–‡ä»¶æ˜¾ç¤ºåŒºåŸŸ -->
                            <div id="splitDocumentsArea" d-none">
                                <hr>
                                <h6 class="mb-3">
                                    <i class="bi bi-file-earmark-break"></i> æ–‡æ¡£æ‹†åˆ†ç»“æœ
                                </h6>
                                <div class="row" id="splitDocumentsList">
                                    <!-- æ‹†åˆ†æ–‡ä»¶å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                                </div>
                            </div>

                            <div class="text-center mt-3">
                                <button class="btn btn-outline-success me-2" id="tenderRetryBtn">
                                    <i class="bi bi-arrow-clockwise"></i> é‡æ–°æå–
                                </button>
                                <button class="btn btn-outline-secondary" id="tenderResetBtn">
                                    <i class="bi bi-x-circle"></i> é‡ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤º -->
            <div class="row d-none" id="tenderErrorArea">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> æå–å¤±è´¥
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger mb-3">
                                <p id="tenderErrorAreaMessage"></p>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-outline-danger me-2" id="tenderRetryBtn2">
                                    <i class="bi bi-arrow-clockwise"></i> é‡è¯•
                                </button>
                                <button class="btn btn-outline-secondary" id="tenderResetBtn2">
                                    <i class="bi bi-x-circle"></i> é‡ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-search text-info" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">æ™ºèƒ½æå–</h5>
                            <p class="card-text text-muted">AIè‡ªåŠ¨è¯†åˆ«æ‹›æ ‡æ–‡ä»¶ä¸­çš„å…³é”®ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-list-check text-success" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">å®Œæ•´å­—æ®µ</h5>
                            <p class="card-text text-muted">æå–æ‹›æ ‡äººã€ä»£ç†ã€æ—¶é—´ç­‰8ä¸ªå…³é”®å­—æ®µ</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-gear text-warning" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">é…ç½®ä¿å­˜</h5>
                            <p class="card-text text-muted">è‡ªåŠ¨ä¿å­˜æå–ç»“æœåˆ°é…ç½®æ–‡ä»¶</p>
                        </div>
                    </div>
                </div>
            </div>


            <!-- åŠŸèƒ½è¯´æ˜ -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i> åŠŸèƒ½è¯´æ˜
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>ğŸ“„ æå–å­—æ®µ</h6>
                                    <ul>
                                        <li>æ‹›æ ‡äººï¼ˆé‡‡è´­äºº/ç”²æ–¹ï¼‰</li>
                                        <li>æ‹›æ ‡ä»£ç†ï¼ˆä»£ç†æœºæ„ï¼‰</li>
                                        <li>æŠ•æ ‡æ–¹å¼ï¼ˆå…¬å¼€æ‹›æ ‡ç­‰ï¼‰</li>
                                        <li>æŠ•æ ‡åœ°ç‚¹ï¼ˆé€’äº¤åœ°ç‚¹ï¼‰</li>
                                        <li>æŠ•æ ‡æ—¶é—´ï¼ˆæˆªæ­¢æ—¶é—´ï¼‰</li>
                                        <li>ä¸­æ ‡äººæ•°é‡ï¼ˆé¢„è®¡æ•°é‡ï¼‰</li>
                                        <li>é¡¹ç›®åç§°</li>
                                        <li>é¡¹ç›®ç¼–å·ï¼ˆæ‹›æ ‡ç¼–å·ï¼‰</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹</h6>
                                    <ul>
                                        <li>AIæ™ºèƒ½è¯†åˆ«å…³é”®ä¿¡æ¯</li>
                                        <li>æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼</li>
                                        <li>æ­£åˆ™è¡¨è¾¾å¼å¤‡ç”¨æ–¹æ¡ˆ</li>
                                        <li>è‡ªåŠ¨ä¿å­˜åˆ°é…ç½®æ–‡ä»¶</li>
                                    </ul>
                                    
                                    <h6>âš ï¸ æ³¨æ„äº‹é¡¹</h6>
                                    <ul>
                                        <li>ç¡®ä¿æ–‡æ¡£å†…å®¹æ¸…æ™°å¯è¯»</li>
                                        <li>å»ºè®®ä½¿ç”¨æ ‡å‡†æ‹›æ ‡æ–‡ä»¶æ ¼å¼</li>
                                        <li>æå–ç»“æœä¼šè‡ªåŠ¨ä¿å­˜åˆ°é…ç½®æ–‡ä»¶</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ç»“æŸä¸Šä¼ æ ‡ä¹¦é€‰é¡¹å¡ -->


        <!-- å•†åŠ¡åº”ç­”é€‰é¡¹å¡ -->
        <div class="tab-pane fade" id="business-response" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-briefcase"></i> å•†åŠ¡åº”ç­”å¤„ç†</h6>
                            <small class="text-muted">ä¸Šä¼ å•†åŠ¡åº”ç­”æ¨¡æ¿ï¼ŒæŒ‰é€‰æ‹©çš„å…¬å¸ä¿¡æ¯å¡«å†™æŠ•æ ‡äººåç§°ã€é¡¹ç›®ä¿¡æ¯å¹¶æ’å…¥èµ„è´¨è¯æ˜å›¾ç‰‡</small>
                        </div>
                        <div class="card-body">
                            <form id="businessResponseForm" enctype="multipart/form-data">
                                <!-- æ¨¡æ¿æ–‡ä»¶ä¸Šä¼  -->
                                <div class="mb-3">
                                    <label for="businessTemplateFile" class="form-label">å•†åŠ¡åº”ç­”æ¨¡æ¿ *</label>
                                    <div class="upload-area" onclick="document.getElementById('businessTemplateFile').click()">
                                        <i class="bi bi-cloud-upload display-4 text-primary"></i>
                                        <h5>ç‚¹å‡»ä¸Šä¼ å•†åŠ¡åº”ç­”æ¨¡æ¿</h5>
                                        <p class="text-muted">æ”¯æŒ .docx, .doc æ ¼å¼</p>
                                        <input type="file" id="businessTemplateFile" class="form-control d-none" accept=".docx,.doc">
                                    </div>
                                    <div class="mt-2" id="businessTemplateFileName"></div>
                                </div>

                                <!-- å…¬å¸é€‰æ‹© -->
                                <div class="mb-3">
                                    <label for="businessCompanySelect" class="form-label">é€‰æ‹©åº”ç­”å…¬å¸ *</label>
                                    <div class="d-flex align-items-center gap-2">
                                        <select class="form-select" id="businessCompanySelect" style="flex: 1;">
                                            <option value="">è¯·é€‰æ‹©å…¬å¸...</option>
                                        </select>
                                        <button type="button" class="btn btn-outline-info btn-sm" onclick="window.location.href='/knowledge_base?action=company_management';">
                                            <i class="bi bi-building"></i> ç®¡ç†å…¬å¸
                                        </button>
                                    </div>
                                    <!-- å½“å‰é€‰ä¸­å…¬å¸æ˜¾ç¤º -->
                                    <div class="mt-2">
                                        <small class="text-muted">å½“å‰é€‰ä¸­ï¼š</small>
                                        <span id="selectedCompanyName" class="text-muted">è¯·é€‰æ‹©å…¬å¸</span>
                                    </div>
                                </div>

                                <!-- é¡¹ç›®ä¿¡æ¯ -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="businessProjectName" class="form-label">é¡¹ç›®åç§°</label>
                                            <input type="text" class="form-control" id="businessProjectName" 
                                                   placeholder="è¾“å…¥é¡¹ç›®åç§°">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="businessTenderNo" class="form-label">æ‹›æ ‡ç¼–å·</label>
                                            <input type="text" class="form-control" id="businessTenderNo" 
                                                   placeholder="è¾“å…¥æ‹›æ ‡ç¼–å·">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="businessDate" class="form-label">æ—¥æœŸ</label>
                                    <input type="text" class="form-control" id="businessDate" 
                                           placeholder="ä¾‹å¦‚ï¼š2025å¹´ 9æœˆ 3æ—¥">
                                </div>


                                <!-- å¤„ç†æŒ‰é’® -->
                                <button type="submit" class="btn btn-outline-success">
                                    <i class="bi bi-play-fill"></i> å¼€å§‹å¤„ç†
                                </button>
                            </form>

                            <!-- è¿›åº¦æ¡ -->
                            <div class="progress mt-3" id="businessProgress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>

                            <!-- ç»“æœæ˜¾ç¤º -->
                            <div class="alert alert-success mt-3 d-none" id="businessResult">
                                <h6>å¤„ç†å®Œæˆï¼</h6>
                                <p id="businessResultMessage"></p>
                                <div class="d-flex gap-2 flex-wrap">
                                    <a href="#" id="businessDownloadLink" class="btn btn-primary">
                                        <i class="bi bi-download"></i> ä¸‹è½½æ–‡ä»¶
                                    </a>
                                    <button type="button" class="btn btn-success" id="businessPreviewBtn" onclick="previewBusinessDocument()">
                                        <i class="bi bi-eye"></i> é¢„è§ˆæ–‡æ¡£
                                    </button>
                                    <button type="button" class="btn btn-warning" id="businessEditBtn" onclick="editBusinessDocument()">
                                        <i class="bi bi-pencil-square"></i> ç¼–è¾‘æ–‡æ¡£
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="businessNextStepBtn">
                                        <i class="bi bi-arrow-right"></i> ä¸‹ä¸€æ­¥ï¼šç‚¹å¯¹ç‚¹åº”ç­”
                                    </button>
                                </div>
                            </div>

                            <!-- é”™è¯¯æç¤º -->
                            <div class="alert alert-danger mt-3 d-none" id="businessError">
                                <h6>å¤„ç†å¤±è´¥</h6>
                                <p id="businessErrorMessage"></p>
                            </div>

                            <!-- å¤„ç†ç»Ÿè®¡ -->
                            <div class="mt-3 d-none" id="businessStats">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="bi bi-bar-chart"></i> å¤„ç†ç»Ÿè®¡</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="businessStatsContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å†å²æ–‡ä»¶ -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-files"></i> å†å²æ–‡ä»¶</h5>
                        </div>
                        <div class="card-body">
                            <div id="businessFilesList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ç»“æŸå•†åŠ¡åº”ç­”é€‰é¡¹å¡ -->

            <!-- ç‚¹å¯¹ç‚¹åº”ç­”é€‰é¡¹å¡ -->
            <div class="tab-pane fade" id="point-to-point" role="tabpanel">

        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <h6 class="alert-heading"><i class="bi bi-info-circle me-2"></i>å†…è”å›å¤åŠŸèƒ½ï¼ˆåŸåœ°æ’å…¥åº”ç­”ï¼‰</h6>
                    <p class="mb-2">è¯¥åŠŸèƒ½ä¼šåœ¨åŸæ–‡æ¡£ä¸­æ¯ä¸ªéœ€æ±‚å<strong>ç›´æ¥æ’å…¥åº”ç­”</strong>ï¼Œç‰¹ç‚¹ï¼š</p>
                    <ul class="mb-0 small">
                        <li><strong>åŸåœ°æ’å…¥</strong>ï¼šåº”ç­”ç´§è·Ÿåœ¨æ¯ä¸ªéœ€æ±‚æ®µè½åé¢</li>
                        <li><strong>ç°è‰²åº•çº¹æ ‡è®°</strong>ï¼šåº”ç­”å†…å®¹æ·»åŠ æµ…ç°è‰²èƒŒæ™¯ï¼ˆRGB 217,217,217ï¼‰ï¼Œä¾¿äºè¯†åˆ«</li>
                        <li><strong>æ ¼å¼å®Œæ•´ä¿ç•™</strong>ï¼šä¿æŒåŸæ–‡æ¡£çš„å­—ä½“ã€æ ·å¼ã€ç»“æ„ä¸å˜</li>
                        <li><strong>ä¸“ä¸šæç¤ºè¯</strong>ï¼šä½¿ç”¨ä¸‰ç§ä¸“ä¸šæ¨¡æ¿ï¼ˆç‚¹å¯¹ç‚¹/å†…å®¹ç”Ÿæˆ/æ ‡é¢˜ç®€åŒ–ï¼‰</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- åº”ç­”é…ç½®åŒºåŸŸ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-gear"></i> åº”ç­”é…ç½®</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- åº”ç­”é¢‘æ¬¡ -->
                            <div class="col-md-2">
                                <label for="responseFrequency" class="form-label"><strong>åº”ç­”é¢‘æ¬¡ï¼š</strong></label>
                                <select class="form-select" name="responseFrequency" id="responseFrequency">
                                    <option value="every_paragraph" selected>æ¯æ®µåº”ç­”</option>
                                    <option value="major_headings">é’ˆå¯¹å¤§æ ‡é¢˜æ¡ç›®åº”ç­”</option>
                                </select>
                            </div>

                            <!-- åº”ç­”æ–¹å¼ -->
                            <div class="col-md-2">
                                <label for="responseMode" class="form-label"><strong>åº”ç­”æ–¹å¼ï¼š</strong></label>
                                <select class="form-select" name="responseMode" id="responseMode">
                                    <option value="ai" selected>AIæ¨¡å‹åº”ç­”</option>
                                    <option value="simple">ç®€å•åº”ç­”</option>
                                </select>
                            </div>

                            <!-- AIæ¨¡å‹é€‰æ‹© -->
                            <div class="col-md-8" id="aiModelSelection">
                                <label for="aiModel" class="form-label">
                                    <strong>é€‰æ‹©AIæ¨¡å‹ï¼š</strong>
                                    <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="refreshModels()">
                                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                                    </button>
                                </label>
                                <select class="form-select" name="aiModel" id="aiModel" onchange="onModelChange()">
                                    <optgroup label="å§‹çš‡API">
                                        <option value="shihuang-gpt4o-mini" selected>å§‹çš‡-GPT4oè¿·ä½ ç‰ˆï¼ˆå¿«é€Ÿé«˜æ•ˆï¼‰</option>
                                        <option value="shihuang-gpt4">å§‹çš‡-GPT4ä¸“ä¸šç‰ˆï¼ˆæ·±åº¦åˆ†æï¼‰</option>
                                    </optgroup>
                                    <optgroup label="è”é€šå…ƒæ™¯">
                                        <option value="yuanjing-deepseek-v3">å…ƒæ™¯-DeepSeek-V3</option>
                                        <option value="yuanjing-qwen-235b">å…ƒæ™¯-é€šä¹‰åƒé—®235B</option>
                                    </optgroup>
                                </select>
                                <div id="modelStatus" class="mt-2" d-none">
                                    <small class="text-muted">
                                        <span id="modelStatusIcon"></span>
                                        <span id="modelStatusText"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-upload"></i> æ–‡æ¡£ä¸Šä¼ å¤„ç†</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click();">
                                <i class="bi bi-cloud-upload text-primary" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">æ‹–æ‹½æ–‡æ¡£åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</h4>
                                <p class="text-muted">æ”¯æŒ .docx å’Œ .doc æ ¼å¼ï¼Œæœ€å¤§ 50MB</p>
                                <input type="file" d-none" id="fileInput" name="file" accept=".docx,.doc">
                                <button type="button" class="btn btn-primary" onclick="event.stopPropagation(); document.getElementById('fileInput').click();">
                                    <i class="bi bi-folder2-open"></i> é€‰æ‹©æ–‡ä»¶
                                </button>
                            </div>

                            <div id="fileInfo" class="mt-3" d-none">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <span id="fileName"></span>
                                    <span id="fileSize" class="text-muted ms-2"></span>
                                </div>
                            </div>

                            <div class="mt-3">
                                <button type="submit" class="btn btn-success btn-lg" id="processBtn" disabled>
                                    <i class="bi bi-play-circle"></i> å¼€å§‹å¤„ç†
                                </button>
                            </div>
                        </form>
                        
                        <!-- è¿›åº¦æ¡ -->
                        <div class="progress mt-3" id="progressBar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <!-- ç»“æœåŒºåŸŸ -->
                        <div id="resultArea" class="mt-4" d-none">
                            <div class="alert alert-success">
                                <h5><i class="bi bi-check-circle"></i> å¤„ç†å®Œæˆï¼</h5>
                                <p id="resultMessage"></p>
                                <div class="d-flex gap-2 flex-wrap mt-3">
                                    <button id="downloadBtn" class="btn btn-primary">
                                        <i class="bi bi-download"></i> ä¸‹è½½å¤„ç†åçš„æ–‡æ¡£
                                    </button>
                                    <button type="button" class="btn btn-success" id="pointPreviewBtn" onclick="previewPointDocument()">
                                        <i class="bi bi-eye"></i> é¢„è§ˆæ–‡æ¡£
                                    </button>
                                    <button type="button" class="btn btn-warning" id="pointEditBtn" onclick="editPointDocument()">
                                        <i class="bi bi-pencil-square"></i> ç¼–è¾‘æ–‡æ¡£
                                    </button>
                                    <button id="viewFilesBtn" class="btn btn-outline-info">
                                        <i class="bi bi-file-earmark-text"></i> æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é”™è¯¯åŒºåŸŸ -->
                        <div id="errorArea" class="mt-4" d-none">
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-exclamation-triangle"></i> å¤„ç†å¤±è´¥</h5>
                                <p id="errorMessage"></p>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-primary" id="retryBtn">
                                        <i class="bi bi-arrow-clockwise"></i> é‡è¯•
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                                        <i class="bi bi-arrow-counterclockwise"></i> é‡æ–°é€‰æ‹©æ–‡ä»¶
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²æ–‡ä»¶åˆ—è¡¨ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-files"></i> å†å²æ–‡ä»¶</h5>
                    </div>
                    <div class="card-body">
                        <div id="pointHistoryFilesList">
                            <p class="text-muted">æ­£åœ¨åŠ è½½å†å²æ–‡ä»¶...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


                <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
        <div class="row mb-5">
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-lightning-charge text-warning" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">æ™ºèƒ½è¯†åˆ«</h5>
                        <p class="card-text text-muted">è‡ªåŠ¨è¯†åˆ«æ–‡æ¡£ä¸­çš„éœ€æ±‚æ¡ç›®ï¼Œå‡å°‘é—æ¼</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-cpu text-primary" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">AIç”Ÿæˆ</h5>
                        <p class="card-text text-muted">ä½¿ç”¨å…ˆè¿›AIæ¨¡å‹ç”Ÿæˆä¸“ä¸šæŠ€æœ¯åº”ç­”</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-palette text-success" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">æ ¼å¼ç¾åŒ–</h5>
                        <p class="card-text text-muted">è‡ªåŠ¨è®¾ç½®å­—ä½“ã€é¢œè‰²ã€åº•çº¹å’Œè¡Œè·</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-question-circle"></i> ä½¿ç”¨è¯´æ˜</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ğŸ“‹ æ”¯æŒçš„æ–‡æ¡£æ ¼å¼</h6>
                                <ul>
                                    <li>Microsoft Word æ–‡æ¡£ (.docx)</li>
                                    <li>Microsoft Word 97-2003 æ–‡æ¡£ (.doc)</li>
                                    <li>æ–‡æ¡£å¤§å°é™åˆ¶ï¼š50MB</li>
                                </ul>
                                
                                <h6>ğŸ¯ å¤„ç†åŠŸèƒ½</h6>
                                <ul>
                                    <li>è‡ªåŠ¨è¯†åˆ«é‡‡è´­éœ€æ±‚æ¡ç›®</li>
                                    <li>ç”Ÿæˆ"åº”ç­”ï¼šæ»¡è¶³ã€‚"æ ¼å¼çš„ä¸“ä¸šåº”ç­”</li>
                                    <li>ä¿æŒåŸæ–‡æ¡£æ ¼å¼å’Œå­—ä½“</li>
                                    <li>åº”ç­”å†…å®¹ï¼šé»‘è‰²å­—ä½“ï¼Œç°è‰²åº•çº¹ï¼Œ1.5å€è¡Œè·</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>ğŸ”§ ç³»ç»Ÿé…ç½®</h6>
                                <ul>
                                    <li>ä½¿ç”¨GPT-4o-miniæ¨¡å‹è·å¾—ä¸“ä¸šçš„åº”ç­”æ•ˆæœ</li>
                                    <li>æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼çš„æ™ºèƒ½å¤„ç†</li>
                                </ul>
                                
                                <h6>âš ï¸ æ³¨æ„äº‹é¡¹</h6>
                                <ul>
                                    <li>å¤„ç†æ—¶é—´è§†æ–‡æ¡£å¤§å°å’Œå¤æ‚åº¦è€Œå®š</li>
                                    <li>è¯·ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š</li>
                                    <li>å»ºè®®å¤‡ä»½åŸå§‹æ–‡æ¡£</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- ç»“æŸç‚¹å¯¹ç‚¹åº”ç­”é€‰é¡¹å¡ -->

        <!-- æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆé€‰é¡¹å¡ -->
        <div class="tab-pane fade" id="tech-proposal" role="tabpanel">

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-upload"></i> æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆ</h6>
                        </div>
                        <div class="card-body">
                            <form id="techProposalForm" enctype="multipart/form-data">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="upload-area tech-upload" data-type="tender" onclick="document.getElementById('techTenderFileInput').click();">
                                            <i class="bi bi-file-earmark-check text-primary" style="font-size: 2rem;"></i>
                                            <h5 class="mt-2">æ‹›æ ‡æ–‡ä»¶</h5>
                                            <p class="text-muted mb-3">ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶æˆ–éœ€æ±‚æ–‡æ¡£</p>
                                            <input type="file" d-none" id="techTenderFileInput" name="tender_file" accept=".docx,.doc,.pdf">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="event.stopPropagation(); document.getElementById('techTenderFileInput').click();">
                                                <i class="bi bi-folder2-open"></i> é€‰æ‹©æ‹›æ ‡æ–‡ä»¶
                                            </button>
                                            <div id="techTenderFileInfo" class="mt-2" d-none">
                                                <small class="text-success"><i class="bi bi-check-circle"></i> <span id="techTenderFileName"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="upload-area tech-upload" data-type="product" onclick="document.getElementById('productFileInput').click();">
                                            <i class="bi bi-file-earmark-code text-info" style="font-size: 2rem;"></i>
                                            <h5 class="mt-2">äº§å“æ–‡æ¡£</h5>
                                            <p class="text-muted mb-3">ä¸Šä¼ äº§å“åŠŸèƒ½è¯´æ˜æ–‡æ¡£</p>
                                            <input type="file" d-none" id="productFileInput" name="product_file" accept=".docx,.doc,.pdf">
                                            <button type="button" class="btn btn-info btn-sm" onclick="event.stopPropagation(); document.getElementById('productFileInput').click();">
                                                <i class="bi bi-folder2-open"></i> é€‰æ‹©äº§å“æ–‡æ¡£
                                            </button>
                                            <div id="productFileInfo" class="mt-2" d-none">
                                                <small class="text-success"><i class="bi bi-check-circle"></i> <span id="productFileName"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="outputPrefix" class="form-label">è¾“å‡ºæ–‡ä»¶å‰ç¼€</label>
                                        <input type="text" class="form-control" id="outputPrefix" name="output_prefix" value="æŠ€æœ¯æ–¹æ¡ˆ" placeholder="è¾“å…¥æ–‡ä»¶åå‰ç¼€">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button type="submit" class="btn btn-success btn-lg flex-fill" id="generateProposalBtn" disabled>
                                            <i class="bi bi-play-circle"></i> ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆ
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- è¿›åº¦æ¡ -->
                            <div class="progress mt-3" id="techProgressBar" d-none">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            
                            <!-- ç»“æœåŒºåŸŸ -->
                            <div id="techResultArea" class="mt-4" d-none">
                                <div class="alert alert-success">
                                    <h6 class="mb-0"><i class="bi bi-check-circle"></i> æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆå®Œæˆï¼</h6>
                                    <p id="techResultMessage"></p>
                                    <div id="techDownloadArea" class="mt-3">
                                        <!-- ä¸‹è½½æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- é”™è¯¯åŒºåŸŸ -->
                            <div id="techErrorArea" class="mt-4" d-none">
                                <div class="alert alert-danger">
                                    <h5><i class="bi bi-exclamation-triangle"></i> ç”Ÿæˆå¤±è´¥</h5>
                                    <p id="techErrorMessage"></p>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-primary" id="techRetryBtn">
                                            <i class="bi bi-arrow-clockwise"></i> é‡è¯•
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="techResetBtn">
                                            <i class="bi bi-arrow-counterclockwise"></i> é‡æ–°é€‰æ‹©æ–‡ä»¶
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯æ–¹æ¡ˆåŠŸèƒ½ç‰¹ç‚¹ -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-file-earmark-text text-info" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">æ™ºèƒ½è§£æ</h5>
                            <p class="card-text text-muted">è‡ªåŠ¨è§£ææ‹›æ ‡æ–‡ä»¶å’Œäº§å“æ–‡æ¡£ï¼Œæå–å…³é”®ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-gear-wide-connected text-warning" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">æ™ºèƒ½åŒ¹é…</h5>
                            <p class="card-text text-muted">ç²¾ç¡®åŒ¹é…äº§å“åŠŸèƒ½ä¸æ‹›æ ‡éœ€æ±‚</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-journal-text text-success" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">æ–¹æ¡ˆç”Ÿæˆ</h5>
                            <p class="card-text text-muted">è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯æ–¹æ¡ˆä½¿ç”¨è¯´æ˜ -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-question-circle"></i> æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆè¯´æ˜</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>ğŸ“‹ æ”¯æŒçš„æ–‡æ¡£æ ¼å¼</h6>
                                    <ul>
                                        <li>Wordæ–‡æ¡£ (.docx, .doc)</li>
                                        <li>PDFæ–‡æ¡£ (.pdf)</li>
                                        <li>æ–‡æ¡£å¤§å°é™åˆ¶ï¼š50MB</li>
                                    </ul>
                                    
                                    <h6>ğŸ¯ ç”ŸæˆåŠŸèƒ½</h6>
                                    <ul>
                                        <li>è‡ªåŠ¨è§£ææ‹›æ ‡éœ€æ±‚å’Œäº§å“åŠŸèƒ½</li>
                                        <li>æ™ºèƒ½åŒ¹é…éœ€æ±‚ä¸åŠŸèƒ½ç‰¹æ€§</li>
                                        <li>ç”Ÿæˆå®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆå¤§çº²</li>
                                        <li>è¾“å‡ºä¸“ä¸šçš„Wordæ ¼å¼æ–¹æ¡ˆæ–‡æ¡£</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>ğŸ“Š è¾“å‡ºæ–‡ä»¶</h6>
                                    <ul>
                                        <li>æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£ (.docx)</li>
                                        <li>æ–¹æ¡ˆå¤§çº² (.json)</li>
                                        <li>åŒ¹é…åº¦æŠ¥å‘Š (.json)</li>
                                        <li>å®Œæ•´æ•°æ® (.json)</li>
                                    </ul>
                                    
                                    <h6>âš ï¸ æ³¨æ„äº‹é¡¹</h6>
                                    <ul>
                                        <li>éœ€è¦ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶å’Œäº§å“æ–‡æ¡£</li>
                                        <li>ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…</li>
                                        <li>å»ºè®®ä½¿ç”¨æ ¼å¼è§„èŒƒçš„æ–‡æ¡£</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ç»“æŸæŠ€æœ¯æ–¹æ¡ˆé€‰é¡¹å¡ -->


        </div>
        <!-- ç»“æŸé€‰é¡¹å¡å†…å®¹ -->

    </div>

    <!-- APIå¯†é’¥å¤‡ä»½ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal fade" id="apiBackupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock"></i> APIå¯†é’¥å¤‡ä»½ç®¡ç†
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6>å½“å‰å¯†é’¥</h6>
                            <div class="input-group">
                                <input type="password" class="form-control" id="currentApiKey" readonly>
                                <button class="btn btn-outline-primary" type="button" id="backupCurrentBtn">
                                    <i class="bi bi-cloud-upload"></i> å¤‡ä»½åˆ°æœåŠ¡å™¨
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>å·²ä¿å­˜çš„å¤‡ä»½</h6>
                    <div id="backupList" class="mt-3">
                        <div class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i> æ­£åœ¨åŠ è½½å¤‡ä»½åˆ—è¡¨...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€é”™è¯¯å¤„ç† - æ•è·æ‰€æœ‰TypeErrorå¹¶ç»™å‡ºå‹å¥½æç¤º
        window.addEventListener('error', function(e) {
            if (e.error && e.error.message && e.error.message.includes("Cannot read properties of null")) {
                console.warn('æ•è·åˆ°nullå…ƒç´ é”™è¯¯ï¼Œä½†å·²å¤„ç†:', e.error.message);
                e.preventDefault(); // é˜»æ­¢é”™è¯¯æ˜¾ç¤ºåœ¨æ§åˆ¶å°
                return true;
            }
        });

        // å®‰å…¨çš„äº‹ä»¶ç»‘å®šå‡½æ•°ï¼Œé¿å…nullå…ƒç´ é”™è¯¯
        function safeAddEventListener(elementId, eventType, handler) {
            const element = document.getElementById(elementId);
            if (element) {
                element.addEventListener(eventType, handler);
                return true;
            } else {
                console.log(`å…ƒç´  ${elementId} ä¸å­˜åœ¨ï¼Œè·³è¿‡ ${eventType} äº‹ä»¶ç»‘å®š`);
                return false;
            }
        }

        // é‡å†™document.getElementByIdä»¥æ·»åŠ å®‰å…¨æ£€æŸ¥
        const originalGetElementById = document.getElementById;
        document.getElementById = function(id) {
            const element = originalGetElementById.call(document, id);
            // é™é»˜å¤„ç†ä¸å­˜åœ¨çš„APIç›¸å…³å…ƒç´ 
            if (!element && !id.includes('Api') && !id.includes('api')) {
                console.warn(`å…ƒç´  '${id}' ä¸å­˜åœ¨`);
            }
            return element;
        };
        // DOMå…ƒç´ å¼•ç”¨ - ä½¿ç”¨å®‰å…¨çš„å…ƒç´ è·å–æ–¹å¼
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const progressBar = document.getElementById('progressBar');
        const resultArea = document.getElementById('resultArea');
        const errorArea = document.getElementById('errorArea');
        const uploadForm = document.getElementById('uploadForm');
        // APIå¯†é’¥ç°åœ¨é€šè¿‡ç¯å¢ƒå˜é‡è‡ªåŠ¨é…ç½®
        
        // APIå¯†é’¥ç›¸å…³å…ƒç´ ï¼ˆä¸ºäº†ä¿æŒå…¼å®¹æ€§ï¼Œåˆ›å»ºè™šæ‹Ÿå…ƒç´ ï¼‰
        const apiKeyInput = { value: '', type: 'password' };
        const toggleApiBtn = { addEventListener: () => {}, innerHTML: '' };
        const saveApiBtn = { addEventListener: () => {} };
        const loadApiBtn = { addEventListener: () => {} };

        // APIå¯†é’¥å®‰å…¨ç®¡ç†
        const API_STORAGE_KEY = 'ai_tender_api_key_encrypted';
        
        // ç®€å•çš„åŠ å¯†/è§£å¯†å‡½æ•°ï¼ˆåŸºäºBase64å’Œç®€å•æ··æ·†ï¼‰
        function encryptApiKey(key) {
            if (!key) return '';
            const encoded = btoa(unescape(encodeURIComponent(key)));
            return encoded.split('').reverse().join('');
        }
        
        function decryptApiKey(encrypted) {
            if (!encrypted) return '';
            try {
                const reversed = encrypted.split('').reverse().join('');
                return decodeURIComponent(escape(atob(reversed)));
            } catch (e) {
                console.error('è§£å¯†å¤±è´¥:', e);
                return '';
            }
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•åŠ è½½ä¿å­˜çš„APIå¯†é’¥æˆ–ä½¿ç”¨é»˜è®¤å¯†é’¥
        window.addEventListener('load', function() {
            const defaultKey = '{{ default_api_key }}';
            const saved = localStorage.getItem(API_STORAGE_KEY);

            if (saved) {
                const decrypted = decryptApiKey(saved);
                if (decrypted) {
                    apiKeyInput.value = decrypted;
                    // document.getElementById('tenderApiKey').value = decrypted;  // APIå¯†é’¥ä»ç¯å¢ƒå˜é‡è·å–
                    showNotification('å·²åŠ è½½ä¿å­˜çš„APIå¯†é’¥', 'success');
                    return;
                }
            }

            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å¯†é’¥ï¼Œä½¿ç”¨é»˜è®¤å¯†é’¥
            if (defaultKey && defaultKey !== 'None') {
                apiKeyInput.value = defaultKey;
                // document.getElementById('tenderApiKey').value = defaultKey;  // APIå¯†é’¥ä»ç¯å¢ƒå˜é‡è·å–
                showNotification('å·²åŠ è½½é»˜è®¤APIå¯†é’¥', 'info');
            }
        });

        // æ˜¾ç¤º/éšè—APIå¯†é’¥
        toggleApiBtn.addEventListener('click', function() {
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            this.innerHTML = isPassword ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
        });

        // ä¿å­˜APIå¯†é’¥
        saveApiBtn.addEventListener('click', function() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showNotification('è¯·å…ˆè¾“å…¥APIå¯†é’¥', 'error');
                return;
            }
            
            const encrypted = encryptApiKey(apiKey);
            localStorage.setItem(API_STORAGE_KEY, encrypted);
            showNotification('APIå¯†é’¥å·²å®‰å…¨ä¿å­˜åˆ°æœ¬åœ°', 'success');
        });

        // åŠ è½½APIå¯†é’¥
        loadApiBtn.addEventListener('click', function() {
            const saved = localStorage.getItem(API_STORAGE_KEY);
            if (saved) {
                const decrypted = decryptApiKey(saved);
                if (decrypted) {
                    apiKeyInput.value = decrypted;
                    showNotification('APIå¯†é’¥åŠ è½½æˆåŠŸ', 'success');
                } else {
                    showNotification('APIå¯†é’¥è§£å¯†å¤±è´¥', 'error');
                }
            } else {
                showNotification('æœªæ‰¾åˆ°ä¿å­˜çš„APIå¯†é’¥', 'error');
            }
        });

        // ç®¡ç†APIå¯†é’¥å¤‡ä»½
        const manageApiBtn = document.getElementById('manageApiBtn');
        if (manageApiBtn) {
            manageApiBtn.addEventListener('click', function() {
                const currentApiKey = document.getElementById('currentApiKey');
                if (currentApiKey) {
                    currentApiKey.value = apiKeyInput.value;
                }
                loadBackupList();
                const apiBackupModal = document.getElementById('apiBackupModal');
                if (apiBackupModal) {
                    new bootstrap.Modal(apiBackupModal).show();
                }
            });
        }

        // å¤‡ä»½å½“å‰å¯†é’¥åˆ°æœåŠ¡å™¨
        const backupCurrentBtn = document.getElementById('backupCurrentBtn');
        if (backupCurrentBtn) {
            backupCurrentBtn.addEventListener('click', function() {
                const apiKey = apiKeyInput.value.trim();
                if (!apiKey) {
                    showNotification('è¯·å…ˆè¾“å…¥APIå¯†é’¥', 'error');
                    return;
                }
                
                const btn = this;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> å¤‡ä»½ä¸­...';
                btn.disabled = true;
                
                fetch('/api/save-key', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ api_key: apiKey })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        loadBackupList(); // åˆ·æ–°å¤‡ä»½åˆ—è¡¨
                    } else {
                        showNotification(data.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            });
        }

        // åŠ è½½å¤‡ä»½åˆ—è¡¨
        function loadBackupList() {
            const backupList = document.getElementById('backupList');
            backupList.innerHTML = '<div class="text-center text-muted"><i class="bi bi-hourglass-split"></i> æ­£åœ¨åŠ è½½å¤‡ä»½åˆ—è¡¨...</div>';
            
            fetch('/api/load-backups')
            .then(response => response.json())
            .then(data => {
                if (data.backups && data.backups.length > 0) {
                    let html = '';
                    data.backups.forEach(backup => {
                        const date = new Date(backup.created_at).toLocaleString('zh-CN');
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <strong>${backup.prefix}</strong>
                                            <small class="text-muted d-block">${backup.description}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">${date}</small>
                                        </div>
                                        <div class="col-md-2 text-end">
                                            <button class="btn btn-sm btn-outline-primary restore-backup-btn" 
                                                    data-backup-id="${backup.id}">
                                                <i class="bi bi-download"></i> æ¢å¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    backupList.innerHTML = html;
                    
                    // ç»‘å®šæ¢å¤æŒ‰é’®äº‹ä»¶
                    document.querySelectorAll('.restore-backup-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const backupId = this.dataset.backupId;
                            restoreApiKey(backupId);
                        });
                    });
                } else {
                    backupList.innerHTML = '<div class="text-center text-muted"><i class="bi bi-inbox"></i> æš‚æ— å¤‡ä»½è®°å½•</div>';
                }
            })
            .catch(error => {
                backupList.innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            });
        }

        // æ¢å¤APIå¯†é’¥
        function restoreApiKey(backupId) {
            fetch(`/api/restore-key/${backupId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    apiKeyInput.value = data.api_key;
                    document.getElementById('currentApiKey').value = data.api_key;
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            });
        }

        // ä¸‹è½½æ–‡ä»¶å‡½æ•°
        function downloadFile(url, filename) {
            try {
                showNotification('å¼€å§‹ä¸‹è½½...', 'info');
                
                // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || '';
                link.style.display = 'none';
                
                // æ·»åŠ åˆ°DOMå¹¶è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(link);
                    showNotification('ä¸‹è½½å·²å¼€å§‹', 'success');
                }, 100);
                
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                showNotification('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
        document.getElementById('viewFilesBtn').addEventListener('click', function() {
            fetch('/api/files')
            .then(response => response.json())
            .then(data => {
                if (data.files && data.files.length > 0) {
                    let fileList = 'å¯ä¸‹è½½çš„æ–‡ä»¶ï¼š\n\n';
                    data.files.forEach((file, index) => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        fileList += `${index + 1}. ${file.name}\n   å¤§å°: ${size} MB\n   åˆ›å»ºæ—¶é—´: ${date}\n\n`;
                    });
                    alert(fileList);
                } else {
                    alert('æš‚æ— å¯ä¸‹è½½çš„æ–‡ä»¶');
                }
            })
            .catch(error => {
                console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                alert('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message);
            });
        });

        // é€šçŸ¥åŠŸèƒ½
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // æ‹–æ‹½ä¸Šä¼ 
        if (uploadArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        if (uploadArea) {
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
            });

            uploadArea.addEventListener('drop', handleDrop, false);
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        if (fileInput) {
            fileInput.addEventListener('change', handleFileSelect);
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                fileName.textContent = file.name;
                fileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                fileInfo.style.display = 'block';
                processBtn.disabled = false;
            }
        }

        // å¤„ç†åº”ç­”æ–¹å¼é€‰æ‹©å˜åŒ–
        document.addEventListener('change', function(e) {
            if (e.target.name === 'responseMode') {
                const aiModelSelection = document.getElementById('aiModelSelection');
                if (e.target.value === 'ai') {
                    aiModelSelection.style.display = 'block';
                } else {
                    aiModelSelection.style.display = 'none';
                }
            }
        });

        // APIæµ‹è¯•
        const testApiBtn = document.getElementById('testApiBtn');
        if (testApiBtn) {
            testApiBtn.addEventListener('click', function() {
                const apiKeyElement = document.getElementById('apiKey');
                const apiKey = apiKeyElement ? apiKeyElement.value.trim() : '';
                const btn = this;
                const originalText = btn.innerHTML;
                const statusDiv = document.getElementById('apiStatus');
            
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> æµ‹è¯•ä¸­...';
            btn.disabled = true;
            
            fetch('/api/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.style.display = 'block';
                if (data.success) {
                    statusDiv.className = 'api-status success';
                    statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message} (æ¨¡å‹: ${data.model})`;
                } else {
                    statusDiv.className = 'api-status error';
                    statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.message}`;
                }
            })
            .catch(error => {
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> è¿æ¥å¤±è´¥: ${error.message}`;
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });
        }

        // é‡è¯•å’Œé‡ç½®åŠŸèƒ½
        const retryBtn = document.getElementById('retryBtn');
        if (retryBtn) {
            retryBtn.addEventListener('click', function() {
                if (uploadForm) {
                    uploadForm.dispatchEvent(new Event('submit'));
                }
            });
        }

        const resetBtn = document.getElementById('resetBtn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                if (fileInput) fileInput.value = '';
                if (fileInfo) fileInfo.style.display = 'none';
                if (resultArea) resultArea.style.display = 'none';
                if (errorArea) errorArea.style.display = 'none';
                if (processBtn) {
                    processBtn.disabled = true;
                    processBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹å¤„ç†';
                }
            });
        }

        // è¡¨å•æäº¤å¤„ç†å‡½æ•°
        function submitUpload() {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            // ä»StateManagerè·å–å½“å‰å…¬å¸ID
            const companyId = StateManager.getCompanyId();
            if (companyId) {
                formData.append('companyId', companyId);
            }

            // æ”¶é›†ç‚¹å¯¹ç‚¹åº”ç­”é…ç½®å‚æ•°
            const responseFrequency = document.getElementById('responseFrequency')?.value || 'every_paragraph';
            const responseMode = document.getElementById('responseMode')?.value || 'simple';
            const aiModel = document.getElementById('aiModel')?.value || 'gpt-4o-mini';

            formData.append('responseFrequency', responseFrequency);
            formData.append('responseMode', responseMode);
            if (responseMode === 'ai') {
                formData.append('aiModel', aiModel);
            }

            // APIå¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡è‡ªåŠ¨è·å–ï¼Œæ— éœ€å‰ç«¯ä¼ é€’
        
            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressBar.style.display = 'block';
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> å¤„ç†ä¸­...';
            
            // éšè—ä¹‹å‰çš„ç»“æœ
            resultArea.style.display = 'none';
            errorArea.style.display = 'none';
            
            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.querySelector('.progress-bar').style.width = progress + '%';
            }, 500);
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5åˆ†é’Ÿè¶…æ—¶

            fetch('/process-point-to-point', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                document.querySelector('.progress-bar').style.width = '100%';
                
                if (data.success) {
                    document.getElementById('resultMessage').textContent = data.message;
                    
                    // è®¾ç½®ä¸‹è½½æŒ‰é’®äº‹ä»¶
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (data.download_url && data.filename) {
                        // å­˜å‚¨ä¸‹è½½ä¿¡æ¯åˆ°æŒ‰é’®çš„dataå±æ€§
                        downloadBtn.setAttribute('data-download-url', data.download_url);
                        downloadBtn.setAttribute('data-filename', data.filename);

                        downloadBtn.onclick = function(e) {
                            e.preventDefault();
                            downloadFile(data.download_url, data.filename);
                        };
                    } else {
                        downloadBtn.onclick = function(e) {
                            e.preventDefault();
                            showNotification('ä¸‹è½½é“¾æ¥æ— æ•ˆ', 'error');
                        };
                    }
                    
                    resultArea.style.display = 'block';
                } else {
                    document.getElementById('errorMessage').textContent = data.error || 'å¤„ç†å¤±è´¥';
                    errorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = 'ä¸Šä¼ å¤±è´¥: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += 'è¯·æ±‚è¶…æ—¶ï¼Œæ–‡æ¡£è¿‡å¤§æˆ–ç½‘ç»œä¸ç¨³å®šã€‚å»ºè®®ï¼š1) æ£€æŸ¥ç½‘ç»œè¿æ¥ 2) å°è¯•æ›´å°çš„æ–‡æ¡£ 3) ç‚¹å‡»é‡è¯•';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€åé‡è¯•';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('errorMessage').textContent = errorMsg;
                errorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    document.querySelector('.progress-bar').style.width = '0%';
                    processBtn.disabled = false;
                    processBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹å¤„ç†';
                }, 1000);
            });
        }

        // è¡¨å•æäº¤äº‹ä»¶
        if (uploadForm) {
            uploadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitUpload();
            });
        }

        // ================================
        // æŠ€æœ¯æ–¹æ¡ˆç›¸å…³åŠŸèƒ½
        // ================================
        
        // æŠ€æœ¯æ–¹æ¡ˆè¡¨å•å…ƒç´ 
        const techProposalForm = document.getElementById('techProposalForm');
        const techTenderFileInput = document.getElementById('techTenderFileInput');
        const productFileInput = document.getElementById('productFileInput');
        const generateProposalBtn = document.getElementById('generateProposalBtn');
        const techProgressBar = document.getElementById('techProgressBar');
        const techResultArea = document.getElementById('techResultArea');
        const techErrorArea = document.getElementById('techErrorArea');

        // æŠ€æœ¯æ–¹æ¡ˆæ–‡ä»¶é€‰æ‹©å¤„ç†
        if (techTenderFileInput) {
            techTenderFileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const fileNameElement = document.getElementById('techTenderFileName');
                    const fileInfoElement = document.getElementById('techTenderFileInfo');
                    if (fileNameElement) fileNameElement.textContent = file.name;
                    if (fileInfoElement) fileInfoElement.style.display = 'block';
                    checkTechFormReady();
                }
            });
        }

        if (productFileInput) {
            productFileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const fileNameElement = document.getElementById('productFileName');
                    const fileInfoElement = document.getElementById('productFileInfo');
                    if (fileNameElement) fileNameElement.textContent = file.name;
                    if (fileInfoElement) fileInfoElement.style.display = 'block';
                    checkTechFormReady();
                }
            });
        }

        function checkTechFormReady() {
            const hasTenderFile = techTenderFileInput && techTenderFileInput.files.length > 0;
            const hasProductFile = productFileInput && productFileInput.files.length > 0;
            if (generateProposalBtn) {
                generateProposalBtn.disabled = !(hasTenderFile && hasProductFile);
            }
        }

        // æŠ€æœ¯æ–¹æ¡ˆè¡¨å•æäº¤
        if (techProposalForm) {
            techProposalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitTechProposal();
            });
        }

        function submitTechProposal() {
            const formData = new FormData();
            formData.append('tender_file', techTenderFileInput.files[0]);
            formData.append('product_file', productFileInput.files[0]);
            formData.append('output_prefix', document.getElementById('outputPrefix').value.trim() || 'æŠ€æœ¯æ–¹æ¡ˆ');
            // APIå¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡è‡ªåŠ¨è·å–

            // æ˜¾ç¤ºè¿›åº¦æ¡
            techProgressBar.style.display = 'block';
            generateProposalBtn.disabled = true;
            generateProposalBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...';
            
            // éšè—ä¹‹å‰çš„ç»“æœ
            techResultArea.style.display = 'none';
            techErrorArea.style.display = 'none';
            
            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                document.querySelector('#techProgressBar .progress-bar').style.width = progress + '%';
            }, 1000);
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†é’Ÿè¶…æ—¶

            fetch('/generate-proposal', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                document.querySelector('#techProgressBar .progress-bar').style.width = '100%';
                
                if (data.success) {
                    document.getElementById('techResultMessage').innerHTML = `
                        <strong>ç”Ÿæˆç»Ÿè®¡ï¼š</strong><br>
                        â€¢ éœ€æ±‚æ•°é‡ï¼š${data.requirements_count || 0}<br>
                        â€¢ åŠŸèƒ½æ•°é‡ï¼š${data.features_count || 0}<br>
                        â€¢ åŒ¹é…æ•°é‡ï¼š${data.matches_count || 0}<br>
                        â€¢ ç« èŠ‚æ•°é‡ï¼š${data.sections_count || 0}<br>
                        â€¢ åŒ¹é…æˆåŠŸç‡ï¼š${data.match_stats ? Math.round((data.match_stats.matched_requirements / data.requirements_count * 100) || 0) : 0}%
                    `;
                    
                    // ç”Ÿæˆä¸‹è½½æŒ‰é’®
                    const downloadArea = document.getElementById('techDownloadArea');
                    downloadArea.innerHTML = '';
                    
                    if (data.output_files) {
                        Object.keys(data.output_files).forEach(fileType => {
                            const filePath = data.output_files[fileType];
                            const fileName = filePath.split('/').pop();
                            
                            let buttonClass = 'btn-primary';
                            let iconClass = 'bi-download';
                            let buttonText = 'ä¸‹è½½';
                            
                            switch (fileType) {
                                case 'proposal':
                                    buttonClass = 'btn-success';
                                    iconClass = 'bi-file-earmark-word';
                                    buttonText = 'ä¸‹è½½æŠ€æœ¯æ–¹æ¡ˆ';
                                    break;
                                case 'outline':
                                    buttonClass = 'btn-info';
                                    iconClass = 'bi-list-ol';
                                    buttonText = 'ä¸‹è½½æ–¹æ¡ˆå¤§çº²';
                                    break;
                                case 'match_report':
                                    buttonClass = 'btn-warning';
                                    iconClass = 'bi-graph-up';
                                    buttonText = 'ä¸‹è½½åŒ¹é…æŠ¥å‘Š';
                                    break;
                                case 'full_data':
                                    buttonClass = 'btn-secondary';
                                    iconClass = 'bi-database';
                                    buttonText = 'ä¸‹è½½å®Œæ•´æ•°æ®';
                                    break;
                            }
                            
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = `btn ${buttonClass} me-2 mb-2`;
                            downloadBtn.innerHTML = `<i class="${iconClass}"></i> ${buttonText}`;
                            downloadBtn.onclick = function() {
                                downloadFile(`/download-tech/${fileName}`, fileName);
                            };
                            downloadArea.appendChild(downloadBtn);
                        });
                    }
                    
                    techResultArea.style.display = 'block';
                } else {
                    document.getElementById('techErrorMessage').textContent = data.error || 'ç”Ÿæˆå¤±è´¥';
                    techErrorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = 'ç”Ÿæˆå¤±è´¥: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += 'è¯·æ±‚è¶…æ—¶ï¼Œæ–‡æ¡£è¿‡å¤§æˆ–å¤„ç†æ—¶é—´è¿‡é•¿ã€‚å»ºè®®ï¼š1) æ£€æŸ¥ç½‘ç»œè¿æ¥ 2) å°è¯•æ›´å°çš„æ–‡æ¡£ 3) ç‚¹å‡»é‡è¯•';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€åé‡è¯•';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('techErrorMessage').textContent = errorMsg;
                techErrorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    techProgressBar.style.display = 'none';
                    document.querySelector('#techProgressBar .progress-bar').style.width = '0%';
                    generateProposalBtn.disabled = false;
                    generateProposalBtn.innerHTML = '<i class="bi bi-play-circle"></i> ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆ';
                }, 1000);
            });
        }

        // æŠ€æœ¯æ–¹æ¡ˆé‡è¯•å’Œé‡ç½®åŠŸèƒ½
        const techRetryBtn = document.getElementById('techRetryBtn');
        if (techRetryBtn) {
            techRetryBtn.addEventListener('click', function() {
                submitTechProposal();
            });
        }

        const techResetBtn = document.getElementById('techResetBtn');
        if (techResetBtn) {
            techResetBtn.addEventListener('click', function() {
                if (techTenderFileInput) techTenderFileInput.value = '';
                if (productFileInput) productFileInput.value = '';
                
                const techTenderFileInfo = document.getElementById('techTenderFileInfo');
                const productFileInfo = document.getElementById('productFileInfo');
                
                if (techTenderFileInfo) techTenderFileInfo.style.display = 'none';
                if (productFileInfo) productFileInfo.style.display = 'none';
                if (techResultArea) techResultArea.style.display = 'none';
                if (techErrorArea) techErrorArea.style.display = 'none';
                if (generateProposalBtn) {
                    generateProposalBtn.disabled = true;
                    generateProposalBtn.innerHTML = '<i class="bi bi-play-circle"></i> ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆ';
                }
            });
        }

        // ====== æ‹›æ ‡ä¿¡æ¯æå–åŠŸèƒ½ ======
        console.log('Initializing tender info extraction...');
        const tenderUploadArea = document.getElementById('tenderUploadArea');
        const tenderFileInput = document.getElementById('tenderFileInput');
        const tenderFileInfo = document.getElementById('tenderFileInfo');
        const tenderFileName = document.getElementById('tenderFileName');
        const tenderFileSize = document.getElementById('tenderFileSize');
        const extractInfoBtn = document.getElementById('extractInfoBtn');
        const tenderProgressBar = document.getElementById('tenderProgressBar');
        const tenderResultArea = document.getElementById('tenderResultArea');
        const tenderErrorArea = document.getElementById('tenderErrorArea');
        const tenderInfoDisplay = document.getElementById('tenderInfoDisplay');
        
        console.log('Tender elements:', {
            tenderUploadArea,
            tenderFileInput,
            tenderFileInfo,
            tenderFileName,
            tenderFileSize,
            extractInfoBtn
        });

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
        if (tenderUploadArea && tenderFileInput) {
            tenderUploadArea.addEventListener('click', () => {
                console.log('Tender upload area clicked');
                tenderFileInput.click();
            });
        }

        // æ‹–æ‹½ä¸Šä¼ 
        if (tenderUploadArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                tenderUploadArea.addEventListener(eventName, preventDefaults, false);
            });
        }

        if (tenderUploadArea) {
            ['dragenter', 'dragover'].forEach(eventName => {
                tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.remove('dragover'), false);
            });

            tenderUploadArea.addEventListener('drop', handleTenderDrop, false);
        }

        function handleTenderDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                tenderFileInput.files = files;
                handleTenderFileSelect();
            }
        }

        if (tenderFileInput) {
            tenderFileInput.addEventListener('change', handleTenderFileSelect);
        }

        function handleTenderFileSelect() {
            console.log('handleTenderFileSelect called');
            const file = tenderFileInput.files[0];
            console.log('Selected file:', file);
            if (file) {
                console.log('File details:', file.name, file.size);
                tenderFileName.textContent = file.name;
                tenderFileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                tenderFileInfo.style.display = 'block';
                extractInfoBtn.disabled = false;
                console.log('File info updated, extract button enabled');
            } else {
                console.log('No file selected');
            }
        }

        // APIæµ‹è¯•åŠŸèƒ½å·²ç§»é™¤ - ä½¿ç”¨ç¯å¢ƒå˜é‡APIå¯†é’¥

        // æå–ä¿¡æ¯æŒ‰é’®äº‹ä»¶
        if (extractInfoBtn) {
            extractInfoBtn.addEventListener('click', function() {
                submitTenderExtraction();
            });
        }

        async function performStepwiseExtraction(formData, progressBar, tenderResultArea, tenderErrorArea, progressInterval, timeoutId) {
            try {
                // ç¡®ä¿å®¹å™¨ç®¡ç†å™¨å·²åˆå§‹åŒ–å¹¶æ¸…ç†ä¹‹å‰çš„ç»“æœ
                if (!tenderContainerManager && tenderResultArea) {
                    tenderContainerManager = new ContainerManager(tenderResultArea);
                }
                
                if (tenderContainerManager) {
                    tenderContainerManager.hideAllContainers();
                } else {
                    // å¤‡ç”¨æ¸…ç†é€»è¾‘
                    ['basicInfoContainer', 'qualificationContainer', 'technicalContainer'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.style.display = 'none';
                            const contentElement = element.querySelector('.card-body');
                            if (contentElement) {
                                contentElement.innerHTML = '';
                            }
                        }
                    });
                }
                
                // æ­¥éª¤1ï¼šä¸Šä¼ æ–‡ä»¶å¹¶å¤„ç†
                safeSetTextContent('stepMessage', 'æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...');
                if (progressBar) progressBar.style.width = '20%';
                
                await new Promise(resolve => setTimeout(resolve, 500)); // æ¨¡æ‹Ÿå»¶è¿Ÿ
                
                // æ­¥éª¤2ï¼šæå–åŸºæœ¬ä¿¡æ¯
                safeSetTextContent('stepMessage', 'æ­£åœ¨æå–åŸºæœ¬ä¿¡æ¯...');
                if (progressBar) progressBar.style.width = '40%';
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // æ­¥éª¤3ï¼šåˆ†æèµ„è´¨è¦æ±‚
                safeSetTextContent('stepMessage', 'æ­£åœ¨åˆ†æèµ„è´¨è¦æ±‚...');
                if (progressBar) progressBar.style.width = '70%';
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // æ­¥éª¤4ï¼šæå–æŠ€æœ¯è¯„åˆ†
                safeSetTextContent('stepMessage', 'æ­£åœ¨æå–æŠ€æœ¯è¯„åˆ†...');
                if (progressBar) progressBar.style.width = '90%';
                
                // å‘é€è¯·æ±‚åˆ°ç»Ÿä¸€çš„APIç«¯ç‚¹
                const response = await fetch('/extract-tender-info', {
                    method: 'POST',
                    body: formData
                });
                
                // æ£€æŸ¥HTTPçŠ¶æ€
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    // ä½¿ç”¨ErrorHandleræ¥æ ¼å¼åŒ–é”™è¯¯ä¿¡æ¯
                    const errorMsg = ErrorHandler.formatErrorMessage(data.error || data.message || data);
                    throw new Error(errorMsg);
                }
                
                // å¤„ç†è¿”å›çš„æ•°æ®
                const result = data.data;
                
                // æå–åŸºæœ¬ä¿¡æ¯ï¼ˆæ‹›æ ‡ç›¸å…³çš„åŸºæœ¬å­—æ®µï¼‰
                const basicInfo = {
                    tenderer: result.tenderer,
                    agency: result.agency,
                    bidding_method: result.bidding_method,
                    bidding_location: result.bidding_location,
                    bidding_time: result.bidding_time,
                    winner_count: result.winner_count,
                    project_name: result.project_name,
                    project_number: result.project_number
                };
                
                // æå–èµ„è´¨è¦æ±‚ï¼ˆä»¥qualification_å¼€å¤´çš„å­—æ®µï¼‰
                const qualificationRequirements = {};
                for (const [key, value] of Object.entries(result)) {
                    if (key.startsWith('qualification_') || key.includes('requirements') || 
                        ['business_license', 'taxpayer_qualification', 'performance_requirements', 
                         'authorization_requirements', 'credit_china', 'commitment_letter', 
                         'audit_report', 'social_security', 'labor_contract', 'other_requirements'].includes(key)) {
                        qualificationRequirements[key] = value;
                    }
                }
                
                // æå–æŠ€æœ¯è¯„åˆ†ï¼ˆä»¥technical_å¼€å¤´çš„å­—æ®µæˆ–åŒ…å«scoringçš„å­—æ®µï¼‰
                const technicalScoring = {};
                for (const [key, value] of Object.entries(result)) {
                    if (key.startsWith('technical_') || key.includes('scoring') || key.includes('score')) {
                        technicalScoring[key] = value;
                    }
                }
                
                // æ˜¾ç¤ºæå–ç»“æœ
                displayBasicInfo(basicInfo);
                displayQualificationRequirements(qualificationRequirements);
                displayTechnicalScoring(technicalScoring);

                // æ˜¾ç¤ºæ‹†åˆ†æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
                if (data.split_documents && data.split_documents.length > 0) {
                    displaySplitDocuments(data.split_documents);
                }

                // å®Œæˆ
                if (progressBar) progressBar.style.width = '100%';
                safeSetTextContent('stepMessage', 'æ‰€æœ‰ä¿¡æ¯æå–å®Œæˆï¼');
                
                // æ¸…ç†å®šæ—¶å™¨
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                if (tenderResultArea) tenderResultArea.style.display = 'block';
                
            } catch (error) {
                throw error;
            }
        }

        function submitTenderExtraction() {
            const formData = new FormData();
            formData.append('file', tenderFileInput.files[0]);
            // APIå¯†é’¥ä»ç¯å¢ƒå˜é‡è·å–ï¼Œæ— éœ€ä¼ é€’

            // é‡ç½®æ˜¾ç¤ºåŒºåŸŸ
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            
            // æ˜¾ç¤ºè¿›åº¦æ¡å’Œæ­¥éª¤æ¶ˆæ¯
            tenderProgressBar.style.display = 'block';
            document.getElementById('stepMessage').style.display = 'block';
            const progressBar = tenderProgressBar.querySelector('.progress-bar');
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> æå–ä¸­...';

            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            // è¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2åˆ†é’Ÿè¶…æ—¶

            // åˆ†æ­¥åŠ è½½å®ç°
            performStepwiseExtraction(formData, progressBar, tenderResultArea, tenderErrorArea, progressInterval, timeoutId)
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                const errorMsg = ErrorHandler.handleAPIError(error, 'æå–å¤±è´¥');
                ErrorHandler.displayError('tenderErrorArea', errorMsg);
            })
            .finally(() => {
                setTimeout(() => {
                    tenderProgressBar.style.display = 'none';
                    document.getElementById('stepMessage').style.display = 'none';
                    tenderProgressBar.querySelector('.progress-bar').style.width = '0%';
                    extractInfoBtn.disabled = false;
                    extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹æå–ä¿¡æ¯';
                }, 1000);
            });
        }

        function displayTenderInfo(tenderInfo) {
            const fieldLabels = {
                'tenderer': 'æ‹›æ ‡äºº',
                'agency': 'æ‹›æ ‡ä»£ç†',
                'bidding_method': 'æŠ•æ ‡æ–¹å¼',
                'bidding_location': 'æŠ•æ ‡åœ°ç‚¹',
                'bidding_time': 'æŠ•æ ‡æ—¶é—´',
                'winner_count': 'ä¸­æ ‡äººæ•°é‡',
                'project_name': 'é¡¹ç›®åç§°',
                'project_number': 'é¡¹ç›®ç¼–å·'
            };

            // åŸºæœ¬ä¿¡æ¯éƒ¨åˆ†
            let html = '<h5 class="text-primary mb-3"><i class="bi bi-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h5>';
            let basicInfoHtml = '';
            
            for (const [key, value] of Object.entries(tenderInfo)) {
                if (fieldLabels[key]) {
                    const label = fieldLabels[key];
                    const displayValue = value || 'æœªæå–åˆ°';
                    const textColor = value ? 'text-success' : 'text-muted';
                    
                    basicInfoHtml += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-info-circle"></i> ${label}
                                    </h6>
                                    <p class="card-text ${textColor}">${displayValue}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            html += `<div class="row">${basicInfoHtml}</div>`;
            
            // èµ„è´¨è¦æ±‚éƒ¨åˆ†
            if (tenderInfo.qualification_requirements) {
                html += '<hr><h5 class="text-warning mb-3 mt-4"><i class="bi bi-list-check"></i> èµ„è´¨è¦æ±‚</h5>';
                
                const qualificationLabels = {
                    'business_license': 'è¥ä¸šæ‰§ç…§',
                    'taxpayer_qualification': 'çº³ç¨äººèµ„æ ¼ï¼ˆå¢å€¼ç¨çº³ç¨äººï¼‰',
                    'performance_requirements': 'ä¸šç»©è¦æ±‚',
                    'authorization_requirements': 'æˆæƒè¦æ±‚',
                    'credit_china': 'ä¿¡ç”¨ä¸­å›½',
                    'commitment_letter': 'æ‰¿è¯ºå‡½ï¼ˆé»˜è®¤æ»¡è¶³ï¼‰',
                    'audit_report': 'å®¡è®¡æŠ¥å‘Šï¼ˆè´¢åŠ¡è¦æ±‚ï¼‰',
                    'social_security': 'ç¤¾ä¿è¦æ±‚',
                    'labor_contract': 'åŠ³åŠ¨åˆåŒè¦æ±‚',
                    'other_requirements': 'å…¶ä»–è¦æ±‚'
                };
                
                let qualHtml = '';
                for (const [key, qualData] of Object.entries(tenderInfo.qualification_requirements)) {
                    if (qualificationLabels[key]) {
                        const label = qualificationLabels[key];
                        const required = qualData.required;
                        const description = qualData.description || '';
                        const statusText = required ? 'éœ€è¦æä¾›' : 'ä¸éœ€è¦æä¾›';
                        const statusColor = required ? 'text-danger' : 'text-success';
                        const iconClass = required ? 'bi-exclamation-triangle' : 'bi-check-circle';
                        
                        qualHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card ${required ? 'border-warning' : 'border-success'}">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi ${iconClass} ${statusColor}"></i> ${label}
                                        </h6>
                                        <p class="card-text ${statusColor} fw-bold">${statusText}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `<div class="row">${qualHtml}</div>`;
            }
            
            // æŠ€æœ¯è¯„åˆ†éƒ¨åˆ†
            if (tenderInfo.technical_scoring) {
                html += '<hr><h5 class="text-info mb-3 mt-4"><i class="bi bi-graph-up-arrow"></i> æŠ€æœ¯è¯„åˆ†æ ‡å‡†</h5>';
                
                const techScoring = tenderInfo.technical_scoring;
                
                // æŠ€æœ¯æ€»åˆ†æ˜¾ç¤º
                if (techScoring.total_score) {
                    html += `
                        <div class="alert alert-info">
                            <h6 class="mb-2">
                                <i class="bi bi-trophy"></i> æŠ€æœ¯è¯„åˆ†æ€»åˆ†ï¼š
                                <span class="text-primary fw-bold">${techScoring.total_score}</span>
                            </h6>
                            ${techScoring.extraction_summary ? 
                                `<small class="text-muted">${techScoring.extraction_summary}</small>` : ''}
                        </div>
                    `;
                }
                
                // æŠ€æœ¯è¯„åˆ†é¡¹è¡¨æ ¼
                if (techScoring.items && techScoring.items.length > 0) {
                    html += `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-info">
                                    <tr>
                                        <th style="width: 5%;">åºå·</th>
                                        <th style="width: 20%;">è¯„åˆ†é¡¹åç§°</th>
                                        <th style="width: 10%;">åˆ†å€¼</th>
                                        <th style="width: 50%;">è¯„åˆ†æ ‡å‡†</th>
                                        <th style="width: 15%;">æ•°æ®æ¥æº</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    techScoring.items.forEach((item, index) => {
                        const weightDisplay = item.weight || 'æœªæåŠ';
                        const criteriaDisplay = item.criteria || 'æœªæåŠ';
                        const sourceDisplay = item.source || 'æœªæåŠ';
                        
                        html += `
                            <tr>
                                <td class="text-center fw-bold">${index + 1}</td>
                                <td class="fw-semibold text-primary">${item.name}</td>
                                <td class="text-center">
                                    <span class="badge bg-info">${weightDisplay}</span>
                                </td>
                                <td>
                                    <small class="text-muted">${criteriaDisplay}</small>
                                </td>
                                <td>
                                    <small class="text-secondary">${sourceDisplay}</small>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            æœªèƒ½æå–åˆ°å…·ä½“çš„æŠ€æœ¯è¯„åˆ†é¡¹ä¿¡æ¯
                        </div>
                    `;
                }
            }
            
            tenderInfoDisplay.innerHTML = html;
        }

        // æ˜¾ç¤ºæ‹†åˆ†æ–‡ä»¶
        function displaySplitDocuments(splitDocuments) {
            if (!splitDocuments || splitDocuments.length === 0) {
                return;
            }

            const splitDocumentsArea = document.getElementById('splitDocumentsArea');
            const splitDocumentsList = document.getElementById('splitDocumentsList');

            let html = '';
            splitDocuments.forEach((doc, index) => {
                const iconClass = getDocumentIcon(doc.name);
                html += `
                    <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                        <div class="split-document-card">
                            <div class="split-document-title">
                                <i class="bi ${iconClass}"></i> ${doc.name}
                            </div>
                            <div class="split-document-meta">
                                æ–‡ä»¶å¤§å°: ${doc.file_size}
                            </div>
                            <div class="split-document-actions">
                                <button class="btn btn-sm btn-outline-primary" onclick="previewDocument('${doc.filename}')">
                                    <i class="bi bi-eye"></i> é¢„è§ˆ
                                </button>
                                <a href="${doc.download_url}" class="btn btn-sm btn-outline-success" download>
                                    <i class="bi bi-download"></i> ä¸‹è½½
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });

            splitDocumentsList.innerHTML = html;
            splitDocumentsArea.style.display = 'block';
        }

        // æ ¹æ®æ–‡æ¡£åç§°è·å–å›¾æ ‡
        function getDocumentIcon(name) {
            if (name.includes('å…¬å‘Š')) return 'bi-megaphone';
            if (name.includes('å‰é™„è¡¨')) return 'bi-table';
            if (name.includes('è¯„åˆ†') || name.includes('è¯„æ ‡')) return 'bi-award';
            if (name.includes('æ ¼å¼') || name.includes('å“åº”')) return 'bi-file-text';
            return 'bi-file-earmark-word';
        }

        // é¢„è§ˆæ–‡æ¡£
        function previewDocument(filename) {
            fetch(`/preview/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // åˆ›å»ºé¢„è§ˆæ¨¡æ€æ¡†
                        const modal = document.createElement('div');
                        modal.className = 'modal fade';
                        modal.innerHTML = `
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            <i class="bi bi-eye"></i> æ–‡æ¡£é¢„è§ˆ - ${filename}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="document-preview-content" style="max-height: 70vh; overflow-y: auto;">
                                            ${data.html_content}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <a href="/download/${filename}" class="btn btn-success" download>
                                            <i class="bi bi-download"></i> ä¸‹è½½æ–‡æ¡£
                                        </a>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                            å…³é—­
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);
                        const bsModal = new bootstrap.Modal(modal);
                        bsModal.show();

                        // æ¨¡æ€æ¡†å…³é—­ååˆ é™¤å…ƒç´ 
                        modal.addEventListener('hidden.bs.modal', () => {
                            modal.remove();
                        });
                    } else {
                        alert('é¢„è§ˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('é¢„è§ˆå¤±è´¥:', error);
                    alert('é¢„è§ˆå¤±è´¥: ' + error.message);
                });
        }

        // æ‹›æ ‡ä¿¡æ¯æå–é‡è¯•å’Œé‡ç½®åŠŸèƒ½
        document.getElementById('tenderRetryBtn').addEventListener('click', function() {
            submitTenderExtraction();
        });

        document.getElementById('tenderRetryBtn2').addEventListener('click', function() {
            submitTenderExtraction();
        });

        document.getElementById('tenderResetBtn').addEventListener('click', function() {
            tenderFileInput.value = '';
            tenderFileInfo.style.display = 'none';
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            document.getElementById('splitDocumentsArea').style.display = 'none';
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹æå–ä¿¡æ¯';
        });

        document.getElementById('tenderResetBtn2').addEventListener('click', function() {
            tenderFileInput.value = '';
            tenderFileInfo.style.display = 'none';
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            document.getElementById('splitDocumentsArea').style.display = 'none';
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹æå–ä¿¡æ¯';
        });

        // ====== ä¸Šä¼ æ ‡ä¹¦é¡µé¢åˆå§‹åŒ– ======
        console.log('Initializing tender info page...');
        // æ³¨æ„ï¼šå…¬å¸ç®¡ç†åŠŸèƒ½å·²ç§»è‡³å•†åŠ¡åº”ç­”é¡µé¢ï¼Œæ­¤å¤„ä¸å†éœ€è¦ç›¸å…³å…ƒç´ 

        // ä½¿ç”¨ç»Ÿä¸€é…ç½®çš„å­—æ®µæ˜ å°„
        const companyFields = CompanyConfig.fieldMapping;

        let currentCompanyId = null;
        let isLoadingCompany = false; // é˜²æ­¢å¾ªç¯è§¦å‘çš„æ ‡å¿—

        // ç»Ÿä¸€çš„é¡µé¢åˆå§‹åŒ–å‡½æ•°
        function initializeApplication() {
            console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');

            // ç­‰å¾…å…¨å±€å…¬å¸ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ
            if (window.globalCompanyManager) {
                setupCompanySelectors();
            } else {
                // å¦‚æœç®¡ç†å™¨è¿˜æœªå‡†å¤‡å¥½ï¼Œç¨åé‡è¯•
                setTimeout(initializeApplication, 100);
                return;
            }

            loadProjectInfo();
            initializeStandardQualifications();
            initBusinessResponsePage();

            console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }

        // è®¾ç½®å…¬å¸é€‰æ‹©å™¨
        function setupCompanySelectors() {
            const manager = window.globalCompanyManager;

            // æ³¨å†Œå•†åŠ¡åº”ç­”é¡µé¢çš„å…¬å¸é€‰æ‹©å™¨
            const businessSelector = new CompanySelector('businessCompanySelect', {
                placeholder: 'è¯·é€‰æ‹©å…¬å¸...',
                showManageButton: true,
                onSelectionChange: async (companyId) => {
                    manager.setCurrentCompany(companyId);

                    // æ›´æ–°é€‰ä¸­å…¬å¸æ˜¾ç¤º
                    const selectedCompanyName = document.getElementById('selectedCompanyName');
                    if (selectedCompanyName) {
                        if (companyId) {
                            const company = manager.getCompanyById(companyId);
                            selectedCompanyName.textContent = company ? company.company_name : 'æœªçŸ¥å…¬å¸';
                            selectedCompanyName.className = 'text-success fw-bold';

                            // åŠ è½½å…¬å¸èµ„è´¨ä¿¡æ¯
                            try {
                                const qualifications = await manager.loadCompanyQualifications(companyId);
                                if (qualifications) {
                                    console.log('å·²åŠ è½½å…¬å¸èµ„è´¨ä¿¡æ¯', Object.keys(qualifications));
                                }
                            } catch (error) {
                                console.error('åŠ è½½å…¬å¸èµ„è´¨å¤±è´¥:', error);
                            }
                        } else {
                            selectedCompanyName.textContent = 'è¯·é€‰æ‹©å…¬å¸';
                            selectedCompanyName.className = 'text-muted';
                        }
                    }
                }
            });
            manager.registerSelector('business', businessSelector);

                }
            });
            manager.registerSelector('management', managementSelector);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–åº”ç”¨
        window.addEventListener('load', function() {
            initializeApplication();
        });

        // ä½¿ç”¨ç»Ÿä¸€å…¬å¸ç®¡ç†å™¨çš„åŠ è½½æ–¹æ³•ï¼ˆå·²æ›¿æ¢æ—§çš„loadCompanyListLegacyï¼‰
        
        // è·å–é¡¹ç›®ä¿¡æ¯
        function loadProjectInfo() {
            fetch('/api/project-config')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.projectInfo) {
                    fillProjectInfo(data.projectInfo);
                } else {
                    console.log('No project info found:', data.error || 'æœªçŸ¥é”™è¯¯');
                }
            })
            .catch(error => {
                console.error('Error loading project info:', error);
            });
        }
        
        // å¡«å……é¡¹ç›®ä¿¡æ¯åˆ°å•†åŠ¡åº”ç­”é¡µé¢
        function fillProjectInfo(projectInfo) {
            // å¡«å……å•†åŠ¡åº”ç­”é¡µé¢çš„é¡¹ç›®ä¿¡æ¯
            const projectNameField = document.getElementById('businessProjectName');
            const tenderNoField = document.getElementById('businessTenderNo'); 
            const dateField = document.getElementById('businessDate');
            
            if (projectNameField && projectInfo.projectName) {
                projectNameField.value = projectInfo.projectName;
            }
            
            if (tenderNoField && projectInfo.projectNumber && projectInfo.projectNumber !== 'æœªæä¾›') {
                tenderNoField.value = projectInfo.projectNumber;
            }
            
            // ä¼˜å…ˆä½¿ç”¨æŠ•æ ‡æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨å½“å‰æ—¥æœŸ
            if (dateField) {
                if (projectInfo.biddingTime && projectInfo.biddingTime.trim() !== '') {
                    dateField.value = projectInfo.biddingTime;
                } else {
                    // å¦‚æœæ²¡æœ‰æŠ•æ ‡æ—¶é—´ï¼Œç”Ÿæˆé»˜è®¤æ—¥æœŸæ ¼å¼
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    dateField.value = `${year}å¹´${month}æœˆ${day}æ—¥`;
                }
            }
            
            console.log('Project info loaded:', projectInfo);
        }

        // å…¬å¸é€‰æ‹©ä¸‹æ‹‰æ¡†æ›´æ–°åŠŸèƒ½å·²é›†æˆåˆ°ç»Ÿä¸€çš„å…¬å¸ç®¡ç†å™¨ä¸­

        // ç§»é™¤äº†å¯¹ä¸Šä¼ æ ‡ä¹¦é¡µé¢ä¸å­˜åœ¨å…ƒç´ çš„äº‹ä»¶ç»‘å®š
        // æ³¨æ„ï¼šå…¬å¸ç®¡ç†åŠŸèƒ½ç°åœ¨é›†ä¸­åœ¨å•†åŠ¡åº”ç­”é¡µé¢

        // åŠ è½½å…¬å¸ä¿¡æ¯
        function loadCompanyInfo(companyId) {
            fetch(`/api/companies/${companyId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.company) {
                    fillCompanyForm(data.company);
                    currentCompanyId = companyId;
                    deleteCompanyBtn.style.display = 'inline-block';
                    
                    // åŠ è½½èµ„è´¨æ–‡ä»¶ä¿¡æ¯
                    loadCompanyQualifications(companyId);
                    
                    showCompanyMessage('å…¬å¸ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
                } else {
                    showCompanyMessage('åŠ è½½å…¬å¸ä¿¡æ¯å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                showCompanyMessage('åŠ è½½å…¬å¸ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            });
        }

        // åŠ è½½å…¬å¸èµ„è´¨æ–‡ä»¶ä¿¡æ¯
        function loadCompanyQualifications(companyId) {
            console.log('[loadCompanyQualifications] å¼€å§‹åŠ è½½å…¬å¸èµ„è´¨ï¼ŒcompanyId:', companyId);
            fetch(`/api/companies/${companyId}/qualifications`)
            .then(response => response.json())
            .then(data => {
                console.log('[loadCompanyQualifications] APIå“åº”æ•°æ®:', data);
                if (data.success && data.qualifications) {
                    console.log(`[loadCompanyQualifications] æ‰¾åˆ° ${Object.keys(data.qualifications).length} ä¸ªèµ„è´¨`);
                    // å…ˆæ¸…ç©ºå½“å‰èµ„è´¨ä¿¡æ¯
                    clearAllQualificationsInternal();
                    
                    // åŠ è½½å·²æœ‰çš„èµ„è´¨ä¿¡æ¯
                    Object.keys(data.qualifications).forEach(qualKey => {
                        const qualInfo = data.qualifications[qualKey];
                        console.log(`[loadCompanyQualifications] æ˜¾ç¤ºèµ„è´¨ ${qualKey}:`, qualInfo);
                        displayExistingQualification(qualKey, qualInfo);
                    });
                } else {
                    console.log('[loadCompanyQualifications] æ— èµ„è´¨ä¿¡æ¯æˆ–åŠ è½½å¤±è´¥:', data);
                }
            })
            .catch(error => {
                console.error('[loadCompanyQualifications] åŠ è½½å…¬å¸èµ„è´¨å¤±è´¥:', error);
            });
        }

        // å®¹å™¨ç®¡ç†å™¨ç±»
        class ContainerManager {
            constructor(parentContainer) {
                this.parentContainer = parentContainer;
                this.containers = new Map();
            }
            
            // å®‰å…¨è·å–æˆ–åˆ›å»ºå®¹å™¨
            getOrCreateContainer(id, config) {
                let container = document.getElementById(id);
                
                if (!container && this.parentContainer) {
                    container = this.createContainer(id, config);
                    this.parentContainer.appendChild(container);
                    this.parentContainer.style.display = 'block';
                }
                
                if (container) {
                    this.containers.set(id, container);
                    container.style.display = 'block';
                }
                
                return container;
            }
            
            // åˆ›å»ºå®¹å™¨
            createContainer(id, config) {
                const container = document.createElement('div');
                container.id = id;
                container.className = config.className || 'card border-primary mb-3';
                container.innerHTML = `
                    <div class="card-header ${config.headerClass}">
                        <h6 class="mb-0">${config.icon} ${config.title}</h6>
                    </div>
                    <div class="card-body" id="${config.contentId}">
                    </div>
                `;
                return container;
            }
            
            // å®‰å…¨è·å–å®¹å™¨å†…å®¹åŒºåŸŸ
            getContentElement(containerId, contentId) {
                const container = this.containers.get(containerId) || document.getElementById(containerId);
                if (!container) {
                    console.warn(`Container ${containerId} not found`);
                    return null;
                }
                
                return container.querySelector(`#${contentId}`) || container.querySelector('.card-body');
            }
            
            // éšè—æ‰€æœ‰å®¹å™¨
            hideAllContainers() {
                this.containers.forEach(container => {
                    if (container) {
                        container.style.display = 'none';
                        const contentElement = container.querySelector('.card-body');
                        if (contentElement) {
                            contentElement.innerHTML = '';
                        }
                    }
                });
            }
            
            // æ£€æŸ¥çˆ¶å®¹å™¨æ˜¯å¦å­˜åœ¨
            isParentAvailable() {
                return this.parentContainer && document.contains(this.parentContainer);
            }
        }
        
        // å…¨å±€å®¹å™¨ç®¡ç†å™¨å®ä¾‹
        let tenderContainerManager;
        
        // å®‰å…¨å…ƒç´ è®¿é—®è¾…åŠ©å‡½æ•°
        function safeGetElement(id, warn = true) {
            const element = document.getElementById(id);
            if (!element && warn) {
                console.warn(`Element with id '${id}' not found`);
            }
            return element;
        }
        
        function safeSetTextContent(id, text, defaultText = '') {
            const element = safeGetElement(id, false);
            if (element) {
                element.textContent = text;
                return true;
            } else {
                console.warn(`Cannot set text content for element '${id}': element not found`);
                return false;
            }
        }
        
        function safeSetInnerHTML(id, html, defaultHTML = '') {
            const element = safeGetElement(id, false);
            if (element) {
                element.innerHTML = html;
                return true;
            } else {
                console.warn(`Cannot set innerHTML for element '${id}': element not found`);
                return false;
            }
        }
        
        // æ ‡å‡†åŒ–é”™è¯¯å¤„ç†
        class ErrorHandler {
            static formatErrorMessage(error) {
                if (typeof error === 'string') {
                    return error;
                }
                
                if (error && typeof error === 'object') {
                    // å°è¯•å¤šç§å¯èƒ½çš„é”™è¯¯æ¶ˆæ¯å­—æ®µ
                    if (error.message && typeof error.message === 'string') {
                        return error.message;
                    }
                    if (error.error) {
                        if (typeof error.error === 'string') {
                            return error.error;
                        }
                        if (error.error.message && typeof error.error.message === 'string') {
                            return error.error.message;
                        }
                    }
                    if (error.msg && typeof error.msg === 'string') {
                        return error.msg;
                    }
                    if (error.detail && typeof error.detail === 'string') {
                        return error.detail;
                    }
                    
                    // å¦‚æœæ˜¯çŠ¶æ€ç é”™è¯¯ï¼Œå°è¯•æ„é€ æè¿°æ€§æ¶ˆæ¯
                    if (error.status) {
                        return `HTTP ${error.status} é”™è¯¯${error.statusText ? ': ' + error.statusText : ''}`;
                    }
                    
                    // æœ€åå°è¯•JSONåºåˆ—åŒ–ï¼Œä½†é™åˆ¶é•¿åº¦
                    try {
                        const jsonStr = JSON.stringify(error);
                        return jsonStr.length > 200 ? 'å¤æ‚é”™è¯¯å¯¹è±¡ï¼ˆè¯·æŸ¥çœ‹æ§åˆ¶å°ï¼‰' : jsonStr;
                    } catch (e) {
                        return 'æ— æ³•è§£æçš„é”™è¯¯å¯¹è±¡';
                    }
                }
                
                return error ? String(error) : 'æœªçŸ¥é”™è¯¯';
            }
            
            static handleAPIError(error, prefix = 'æ“ä½œå¤±è´¥') {
                // è®°å½•è¯¦ç»†é”™è¯¯ä¿¡æ¯åˆ°æ§åˆ¶å°
                console.error(`${prefix} - è¯¦ç»†é”™è¯¯:`, error);
                
                let errorMsg = `${prefix}: `;
                
                if (error.name === 'AbortError') {
                    errorMsg += 'è¯·æ±‚è¶…æ—¶ï¼Œæ–‡æ¡£è¿‡å¤§æˆ–å¤„ç†æ—¶é—´è¿‡é•¿ã€‚å»ºè®®ï¼š1) æ£€æŸ¥ç½‘ç»œè¿æ¥ 2) å°è¯•æ›´å°çš„æ–‡æ¡£ 3) ç‚¹å‡»é‡è¯•';
                } else if (error.message && error.message.includes('Failed to fetch')) {
                    errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€åé‡è¯•';
                } else {
                    errorMsg += this.formatErrorMessage(error);
                }
                
                return errorMsg;
            }
            
            static displayError(containerId, message) {
                const container = safeGetElement(containerId, false);
                if (container) {
                    container.style.display = 'block';
                    safeSetTextContent(containerId + 'Message', message);
                } else {
                    console.error(`Error container ${containerId} not found. Error: ${message}`);
                }
            }
            
            static hideError(containerId) {
                const container = safeGetElement(containerId, false);
                if (container) {
                    container.style.display = 'none';
                }
            }
        }
        
        // åˆå§‹åŒ–ç®¡ç†å™¨
        class InitializationManager {
            static isReady = false;
            static readyCallbacks = [];
            
            static onReady(callback) {
                if (this.isReady) {
                    callback();
                } else {
                    this.readyCallbacks.push(callback);
                }
            }
            
            static markReady() {
                this.isReady = true;
                this.readyCallbacks.forEach(callback => {
                    try {
                        callback();
                    } catch (error) {
                        console.error('Error in ready callback:', error);
                    }
                });
                this.readyCallbacks = [];
            }
            
            static ensureDOMReady(callback) {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', callback);
                } else {
                    callback();
                }
            }
        }
        
        // ç»„ä»¶çŠ¶æ€ç®¡ç†
        const ComponentState = {
            containerManager: null,
            isInitialized: false,
            
            init() {
                if (this.isInitialized) return;
                
                // åˆå§‹åŒ–å…¨å±€å®¹å™¨ç®¡ç†å™¨
                const tenderResultArea = safeGetElement('tenderResultArea', false);
                if (tenderResultArea) {
                    this.containerManager = new ContainerManager(tenderResultArea);
                    if (!window.tenderContainerManager) {
                        window.tenderContainerManager = this.containerManager;
                    }
                }
                
                this.isInitialized = true;
                console.log('Component state initialized');
            },
            
            getContainerManager() {
                if (!this.isInitialized) {
                    this.init();
                }
                return this.containerManager || window.tenderContainerManager;
            }
        };
        
        // åˆ†æ­¥æ˜¾ç¤ºå‡½æ•°
        function displayBasicInfo(basicInfo) {
            // ä½¿ç”¨ç»„ä»¶çŠ¶æ€ç®¡ç†å™¨è·å–å®¹å™¨ç®¡ç†å™¨
            const containerManager = ComponentState.getContainerManager();
            
            // æ£€æŸ¥å®¹å™¨ç®¡ç†å™¨æ˜¯å¦å¯ç”¨
            if (!containerManager || !containerManager.isParentAvailable()) {
                console.warn('Container manager not available for basic info');
                return;
            }
            
            // è·å–æˆ–åˆ›å»ºåŸºæœ¬ä¿¡æ¯å®¹å™¨
            const container = containerManager.getOrCreateContainer('basicInfoContainer', {
                className: 'card border-primary mb-3',
                headerClass: 'bg-primary text-white',
                icon: '<i class="bi bi-info-circle"></i>',
                title: 'åŸºæœ¬ä¿¡æ¯',
                contentId: 'basicInfoContent'
            });
            
            if (!container) {
                console.warn('Failed to create basicInfoContainer');
                return;
            }
            
            const content = containerManager.getContentElement('basicInfoContainer', 'basicInfoContent');
            let html = '<div class="row">';
            
            const fieldLabels = {
                'project_name': 'é¡¹ç›®åç§°',
                'project_number': 'é¡¹ç›®ç¼–å·', 
                'tenderer': 'æ‹›æ ‡äºº',
                'agency': 'æ‹›æ ‡ä»£ç†',
                'bidding_method': 'æŠ•æ ‡æ–¹å¼',
                'bidding_location': 'æŠ•æ ‡åœ°ç‚¹',
                'bidding_time': 'æŠ•æ ‡æ—¶é—´',
                'winner_count': 'ä¸­æ ‡äººæ•°é‡'
            };
            
            for (const [field, label] of Object.entries(fieldLabels)) {
                const value = basicInfo[field] || 'æœªæä¾›';
                html += `
                    <div class="col-md-6 mb-2">
                        <strong class="text-muted">${label}:</strong>
                        <span class="ms-2">${value}</span>
                    </div>
                `;
            }
            
            html += '</div>';
            if (content) {
                content.innerHTML = html;
            } else {
                console.warn('basicInfoContent element not found');
            }
        }

        // ä½¿ç”¨ç»Ÿä¸€å…¬å¸ç®¡ç†å™¨è·å–å½“å‰å…¬å¸ID
        function getCurrentCompanyId() {
            return window.globalCompanyManager ? window.globalCompanyManager.currentCompanyId : null;
        }

        function displayQualificationRequirements(qualRequirements) {
            // ç¡®ä¿å®¹å™¨ç®¡ç†å™¨å·²åˆå§‹åŒ–
            if (!tenderContainerManager) {
                tenderContainerManager = new ContainerManager(tenderResultArea);
            }

            // æ£€æŸ¥çˆ¶å®¹å™¨æ˜¯å¦å¯ç”¨
            if (!tenderContainerManager.isParentAvailable()) {
                console.warn('tenderResultArea not available for qualifications');
                return;
            }

            // è·å–æˆ–åˆ›å»ºèµ„è´¨è¦æ±‚å®¹å™¨
            const container = tenderContainerManager.getOrCreateContainer('qualificationContainer', {
                className: 'card border-warning mb-3',
                headerClass: 'bg-warning',
                icon: '<i class="bi bi-award"></i>',
                title: 'èµ„è´¨è¦æ±‚åˆ†æ',
                contentId: 'qualificationContent'
            });

            if (!container) {
                console.warn('Failed to create qualificationContainer');
                return;
            }

            const content = tenderContainerManager.getContentElement('qualificationContainer', 'qualificationContent');

            // ä½¿ç”¨ç»Ÿä¸€ç®¡ç†å™¨è·å–å…¬å¸èµ„è´¨æ–‡ä»¶ä¸Šä¼ çŠ¶æ€
            const manager = window.globalCompanyManager;
            const currentCompanyId = manager ? manager.currentCompanyId : null;

            if (currentCompanyId && manager) {
                // ä½¿ç”¨ç»Ÿä¸€ç®¡ç†å™¨åŠ è½½èµ„è´¨ä¿¡æ¯
                manager.loadCompanyQualifications(currentCompanyId)
                    .then(companyQualifications => {
                        // é‡æ–°æ¸²æŸ“èµ„è´¨æ˜¾ç¤ºï¼ˆåŒ…å«ä¸Šä¼ çŠ¶æ€ï¼‰
                        renderQualificationDisplay(qualRequirements, companyQualifications || {}, content);
                    })
                    .catch(error => {
                        console.warn('è·å–å…¬å¸èµ„è´¨æ–‡ä»¶å¤±è´¥:', error);
                        // å³ä½¿è·å–å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºåŸºæœ¬çš„èµ„è´¨è¦æ±‚
                        renderQualificationDisplay(qualRequirements, {}, content);
                    });
            } else {
                // æ²¡æœ‰é€‰æ‹©å…¬å¸æ—¶ï¼Œåªæ˜¾ç¤ºåŸºæœ¬çš„èµ„è´¨è¦æ±‚
                renderQualificationDisplay(qualRequirements, {}, content);
            }
        }

        function renderQualificationDisplay(qualRequirements, companyQualifications, content) {

            // ä½¿ç”¨ç»Ÿä¸€é…ç½®çš„èµ„è´¨å­—æ®µæ˜ å°„
            const qualificationMapping = CompanyConfig.qualificationMapping;

            // ä½¿ç”¨ç»Ÿä¸€é…ç½®çš„èµ„è´¨åˆ†ç±»
            const categories = CompanyConfig.qualificationCategories;

            // ä½¿ç”¨ç»Ÿä¸€é…ç½®çš„æ ‡å‡†èµ„è´¨ç±»å‹
            const standardQualificationTypes = CompanyConfig.standardQualificationTypes;

            let html = '<div class="row">';
            let columnIndex = 0;

            // æŒ‰åˆ†ç±»æ˜¾ç¤ºèµ„è´¨è¦æ±‚ï¼Œä¸¤åˆ—å¸ƒå±€
            Object.keys(categories).forEach(categoryKey => {
                const categoryQuals = standardQualificationTypes.filter(qual => qual.category === categoryKey);
                if (categoryQuals.length === 0) return;

                const categoryInfo = categories[categoryKey];

                // æ¯ä¸¤ä¸ªåˆ†ç±»ä¸€è¡Œ
                if (columnIndex % 2 === 0 && columnIndex > 0) {
                    html += '</div><div class="row">';
                }

                html += `
                    <div class="col-md-6 mb-4">
                        <div class="h-100">
                            <h6 class="text-${categoryInfo.color} mb-3 border-bottom pb-2">
                                <i class="${categoryInfo.icon}"></i> ${categoryInfo.name}
                            </h6>
                `;

                categoryQuals.forEach(qual => {
                    // é€šè¿‡æ˜ å°„è¡¨æŸ¥æ‰¾å¯¹åº”çš„æ‹›æ ‡è¦æ±‚å­—æ®µ
                    const mappedField = qualificationMapping[qual.key];
                    let required = false;
                    let description = 'æœªåœ¨æ‹›æ ‡æ–‡æ¡£ä¸­æ˜ç¡®è¦æ±‚';

                    if (mappedField && qualRequirements.hasOwnProperty(mappedField)) {
                        required = qualRequirements[mappedField] === true || qualRequirements[mappedField] === 'true';
                        // æŸ¥æ‰¾å¯¹åº”çš„æè¿°å­—æ®µ
                        const descField = mappedField.replace('_required', '_description');
                        if (qualRequirements[descField]) {
                            description = qualRequirements[descField];
                        } else if (required) {
                            description = 'æ‹›æ ‡æ–‡æ¡£è¦æ±‚æä¾›æ­¤èµ„è´¨';
                        }
                    }

                    const statusText = required ? 'æœ¬æ¬¡æ‹›æ ‡è¦æ±‚æä¾›' : 'æœ¬æ¬¡æ‹›æ ‡æœªè¦æ±‚æä¾›';
                    const statusClass = required ? 'bg-success' : 'bg-secondary';
                    const borderClass = required ? 'border-success' : 'border-secondary';

                    // æ£€æŸ¥å…¬å¸æ˜¯å¦å·²ä¸Šä¼ è¯¥èµ„è´¨æ–‡æ¡£
                    const hasUploaded = companyQualifications && companyQualifications[qual.key];
                    const uploadStatusIcon = hasUploaded ?
                        '<i class="bi bi-check-circle-fill text-success ms-1" title="å·²ä¸Šä¼ "></i>' :
                        '<i class="bi bi-x-circle text-secondary ms-1" title="æœªä¸Šä¼ "></i>';
                    const uploadStatusText = hasUploaded ? 'å·²ä¸Šä¼ ' : 'æœªä¸Šä¼ ';

                    html += `
                        <div class="mb-2 p-2 border-start border-3 ${borderClass}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="d-flex align-items-center">
                                    <strong class="fs-6">${qual.name}</strong>
                                    ${uploadStatusIcon}
                                </div>
                                <div class="d-flex flex-column align-items-end">
                                    <span class="badge ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                columnIndex++;
            });

            html += '</div>';

            if (content) {
                content.innerHTML = html;
            } else {
                console.warn('qualificationContent element not found');
            }
        }

        function displayTechnicalScoring(technicalScoring) {
            // ç¡®ä¿å®¹å™¨ç®¡ç†å™¨å·²åˆå§‹åŒ–
            if (!tenderContainerManager) {
                tenderContainerManager = new ContainerManager(tenderResultArea);
            }
            
            // æ£€æŸ¥çˆ¶å®¹å™¨æ˜¯å¦å¯ç”¨
            if (!tenderContainerManager.isParentAvailable()) {
                console.warn('tenderResultArea not available for technical scoring');
                return;
            }
            
            // è·å–æˆ–åˆ›å»ºæŠ€æœ¯è¯„åˆ†å®¹å™¨
            const container = tenderContainerManager.getOrCreateContainer('technicalContainer', {
                className: 'card border-info mb-3',
                headerClass: 'bg-info text-white',
                icon: '<i class="bi bi-graph-up"></i>',
                title: 'æŠ€æœ¯è¯„åˆ†',
                contentId: 'technicalContent'
            });
            
            if (!container) {
                console.warn('Failed to create technicalContainer');
                return;
            }
            
            const content = tenderContainerManager.getContentElement('technicalContainer', 'technicalContent');
            const items = technicalScoring.technical_scoring_items || [];
            
            if (items.length > 0) {
                let html = `
                    <div class="mb-3">
                        <span class="badge bg-info fs-6">æ€»åˆ†: ${technicalScoring.total_technical_score || '30åˆ†'}</span>
                        <span class="badge bg-secondary ms-2">${technicalScoring.extraction_summary}</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>åºå·</th>
                                    <th>è¯„åˆ†é¡¹</th>
                                    <th>åˆ†å€¼</th>
                                    <th>è¯„åˆ†æ ‡å‡†</th>
                                    <th>æ¥æº</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                items.forEach((item, index) => {
                    html += `
                        <tr>
                            <td class="text-center fw-bold">${index + 1}</td>
                            <td class="fw-semibold text-primary">${item.name}</td>
                            <td class="text-center">
                                <span class="badge bg-info">${item.weight}</span>
                            </td>
                            <td>
                                <small class="text-muted">${item.criteria}</small>
                            </td>
                            <td>
                                <small class="text-secondary">${item.source}</small>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        æœªèƒ½æå–åˆ°æŠ€æœ¯è¯„åˆ†ä¿¡æ¯
                    </div>
                `;
            }
            
            if (content) {
                content.innerHTML = html;
            } else {
                console.warn('technicalContent element not found');
            }
        }

        function getQualificationLabel(key) {
            const labels = {
                'business_license': 'è¥ä¸šæ‰§ç…§',
                'taxpayer_qualification': 'çº³ç¨äººèµ„æ ¼',
                'performance_requirements': 'ä¸šç»©è¦æ±‚',
                'authorization_requirements': 'æˆæƒè¦æ±‚',
                'credit_china': 'ä¿¡ç”¨ä¸­å›½',
                'commitment_letter': 'æ‰¿è¯ºå‡½',
                'audit_report': 'å®¡è®¡æŠ¥å‘Š',
                'social_security': 'ç¤¾ä¿è¦æ±‚',
                'labor_contract': 'åŠ³åŠ¨åˆåŒ',
                'other_requirements': 'å…¶ä»–è¦æ±‚'
            };
            return labels[key] || key;
        }

        // æ˜¾ç¤ºå·²å­˜åœ¨çš„èµ„è´¨æ–‡ä»¶
        function displayExistingQualification(qualKey, qualInfo) {
            const statusDiv = document.getElementById(`status-${qualKey}`);
            const qualElement = document.querySelector(`[data-qual-key="${qualKey}"]`);
            
            if (statusDiv && qualElement) {
                const viewBtn = qualElement.querySelector('.view-file-btn');
                const downloadBtn = qualElement.querySelector('.download-file-btn');
                const deleteBtn = qualElement.querySelector('.delete-file-btn');
                
                // è·å–æ–‡ä»¶ç±»å‹å›¾æ ‡å’Œæ ¼å¼åŒ–å¤§å°
                const fileTypeIcon = getFileTypeIcon('', qualInfo.original_filename);
                const fileSizeText = formatFileSize(qualInfo.file_size);
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                statusDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="file-info">
                            <small class="text-success">
                                <i class="${fileTypeIcon}"></i> å·²ä¸Šä¼ : ${qualInfo.original_filename} 
                                (${fileSizeText})
                                <span class="badge bg-success">å·²ä¿å­˜</span>
                            </small>
                        </div>
                    </div>
                `;
                statusDiv.style.display = 'block';
                
                // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                if (viewBtn) viewBtn.style.display = 'inline-block';
                if (downloadBtn) downloadBtn.style.display = 'inline-block';
                if (deleteBtn) deleteBtn.style.display = 'inline-block';
                
                // è®°å½•æ–‡ä»¶ä¿¡æ¯ç”¨äºæ˜¾ç¤ºï¼ˆä½†ä¸æ˜¯æœ¬åœ°æ–‡ä»¶ï¼‰
                qualificationFiles[qualKey] = {
                    original_filename: qualInfo.original_filename,
                    file_size: qualInfo.file_size,
                    uploaded: true,
                    server_file: true // æ ‡è®°è¿™æ˜¯æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
                };
            } else if (qualKey.startsWith('custom_')) {
                // å¦‚æœæ˜¯è‡ªå®šä¹‰èµ„è´¨ï¼Œéœ€è¦é‡æ–°åˆ›å»ºå…ƒç´ 
                const qualName = qualInfo.qualification_name || 'è‡ªå®šä¹‰èµ„è´¨';
                const qualElement = createQualificationElement(qualKey, qualName, 'bi-file-plus', true);
                document.getElementById('customQualifications').appendChild(qualElement);
                
                // ç„¶åæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                setTimeout(() => {
                    displayExistingQualification(qualKey, qualInfo);
                }, 100);
            }
        }

        // å¡«å†™è¡¨å•
        function fillCompanyForm(company) {
            console.log('[fillCompanyForm] å¼€å§‹å¡«å……å…¬å¸è¡¨å•ï¼Œæ•°æ®:', company);
            isLoadingCompany = true; // é˜²æ­¢å¡«å……æ—¶è§¦å‘äº‹ä»¶
            
            let filledFields = 0;
            let totalFields = 0;
            
            Object.keys(companyFields).forEach(fieldId => {
                totalFields++;
                const element = document.getElementById(fieldId);
                const fieldValue = company[fieldId];
                
                if (element) {
                    if (fieldValue) {
                        element.value = fieldValue;
                        filledFields++;
                        console.log(`[fillCompanyForm] å¡«å……å­—æ®µ ${fieldId}: ${fieldValue}`);
                    } else {
                        element.value = '';
                        console.log(`[fillCompanyForm] æ¸…ç©ºå­—æ®µ ${fieldId} (æ•°æ®ä¸ºç©º)`);
                    }
                } else {
                    console.warn(`[fillCompanyForm] å…ƒç´ ä¸å­˜åœ¨: ${fieldId}`);
                }
            });
            
            console.log(`[fillCompanyForm] è¡¨å•å¡«å……å®Œæˆï¼Œå¡«å…… ${filledFields}/${totalFields} ä¸ªå­—æ®µ`);
            isLoadingCompany = false; // é‡ç½®æ ‡å¿—
        }

        // ç§»é™¤äº†newCompanyBtnäº‹ä»¶ç»‘å®š - åŠŸèƒ½å·²è½¬ç§»åˆ°å•†åŠ¡åº”ç­”é¡µé¢

        // ç§»é™¤äº†clearFormBtnäº‹ä»¶ç»‘å®š - åŠŸèƒ½å·²è½¬ç§»åˆ°å•†åŠ¡åº”ç­”é¡µé¢

        // æ¸…ç©ºè¡¨å•ç›¸å…³å‡½æ•°å·²ç§»é™¤ - åŠŸèƒ½è½¬ç§»åˆ°å•†åŠ¡åº”ç­”é¡µé¢

        // ç§»é™¤äº†saveCompanyBtnäº‹ä»¶ç»‘å®š - åŠŸèƒ½å·²è½¬ç§»åˆ°å•†åŠ¡åº”ç­”é¡µé¢

        // ç§»é™¤äº†deleteCompanyBtnäº‹ä»¶ç»‘å®š - åŠŸèƒ½å·²è½¬ç§»åˆ°å•†åŠ¡åº”ç­”é¡µé¢

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showCompanyMessage(message, type) {
            hideCompanyMessages();
            
            if (type === 'success') {
                const messageElem = document.getElementById('companyResultMessage');
                const areaElem = document.getElementById('companyResultArea');
                if (messageElem) messageElem.textContent = message;
                if (areaElem) areaElem.style.display = 'block';
            } else {
                const messageElem = document.getElementById('companyErrorMessage');
                const areaElem = document.getElementById('companyErrorArea');
                if (messageElem) messageElem.textContent = message;
                if (areaElem) areaElem.style.display = 'block';
            }

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(hideCompanyMessages, 3000);
        }

        // éšè—æ¶ˆæ¯
        function hideCompanyMessages() {
            const resultArea = document.getElementById('companyResultArea');
            const errorArea = document.getElementById('companyErrorArea');
            if (resultArea) resultArea.style.display = 'none';
            if (errorArea) errorArea.style.display = 'none';
        }

        console.log('Company management initialized');

        // ====== èµ„è´¨æ–‡ä»¶ç®¡ç†åŠŸèƒ½ ======
        console.log('Initializing qualification management...');

        // ä½¿ç”¨ç»Ÿä¸€é…ç½®çš„èµ„è´¨ç±»å‹
        const standardQualificationTypes = CompanyConfig.standardQualificationTypes;

        let customQualificationCounter = 0;
        let qualificationFiles = {}; // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶

        // åˆå§‹åŒ–æ ‡å‡†èµ„è´¨é¡¹ç›®
        function initializeStandardQualifications() {
            const container = document.getElementById('standardQualifications');
            if (!container) {
                console.log('standardQualifications å®¹å™¨ä¸å­˜åœ¨ï¼Œè·³è¿‡èµ„è´¨åˆå§‹åŒ–');
                return;
            }
            
            container.innerHTML = '';
            
            // æŒ‰åˆ†ç±»ç»„ç»‡èµ„è´¨
            const categories = {
                'basic': { name: 'åŸºæœ¬è¯ä»¶èµ„è´¨', icon: 'bi-card-text', color: 'primary' },
                'iso': { name: 'ISOä½“ç³»è®¤è¯', icon: 'bi-award', color: 'warning' },
                'credit': { name: 'ä¿¡ç”¨èµ„è´¨', icon: 'bi-shield-check', color: 'danger' },
                'tax': { name: 'ç¨åŠ¡èµ„è´¨', icon: 'bi-receipt', color: 'success' },
                'financial': { name: 'è´¢åŠ¡èµ„è´¨', icon: 'bi-graph-up', color: 'info' },
                'industry': { name: 'è¡Œä¸šèµ„è´¨', icon: 'bi-gear', color: 'secondary' },
                'social': { name: 'ç¤¾ä¿èµ„è´¨', icon: 'bi-people', color: 'dark' },
                'intellectual': { name: 'çŸ¥è¯†äº§æƒ', icon: 'bi-lightbulb', color: 'success' }
            };
            
            // æŒ‰åˆ†ç±»æ¸²æŸ“èµ„è´¨é¡¹ç›®
            Object.keys(categories).forEach(categoryKey => {
                const categoryQuals = standardQualificationTypes.filter(qual => qual.category === categoryKey);
                if (categoryQuals.length > 0) {
                    const categoryInfo = categories[categoryKey];
                    
                    // åˆ›å»ºåˆ†ç±»æ ‡é¢˜
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'mb-4';
                    categoryDiv.innerHTML = `
                        <h6 class="text-${categoryInfo.color} mb-3 border-bottom pb-2">
                            <i class="${categoryInfo.icon}"></i> ${categoryInfo.name}
                            <small class="text-muted">(${categoryQuals.length}é¡¹)</small>
                        </h6>
                        <div class="category-qualifications"></div>
                    `;
                    
                    const categoryQualContainer = categoryDiv.querySelector('.category-qualifications');
                    
                    // æ·»åŠ è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰èµ„è´¨é¡¹ç›®
                    categoryQuals.forEach(qual => {
                        const qualElement = createQualificationElement(qual.key, qual.name, qual.icon, false, qual.required);
                        categoryQualContainer.appendChild(qualElement);
                    });
                    
                    container.appendChild(categoryDiv);
                }
            });
        }

        // åˆ›å»ºèµ„è´¨é¡¹ç›®å…ƒç´ 
        function createQualificationElement(key, name, icon, isCustom, required = false) {
            const div = document.createElement('div');
            div.className = 'card mb-3 qualification-item border-light shadow-sm';
            div.dataset.qualKey = key;
            
            div.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-3 col-md-12 mb-2 mb-lg-0">
                            <h6 class="mb-0 d-flex align-items-center">
                                <i class="${icon} text-primary me-2"></i> 
                                <span class="text-truncate" title="${name}">${name}</span>
                                ${required ? '<span class="text-danger ms-1" title="å¿…å¡«é¡¹">*</span>' : ''}
                            </h6>
                        </div>
                        <div class="col-lg-4 col-md-12 mb-2 mb-lg-0">
                            <div class="upload-zone border-2 border-dashed rounded p-3 text-center" 
                                 data-qual-key="${key}" style="cursor: pointer;">
                                <input type="file" class="form-control d-none qual-file-input" 
                                       accept=".pdf,.jpg,.jpeg,.png,.docx,.doc" 
                                       data-qual-key="${key}">
                                <i class="bi bi-cloud-upload text-muted"></i>
                                <small class="text-muted d-block">ç‚¹å‡»ä¸Šä¼ æ–‡ä»¶</small>
                                <small class="text-muted">æ”¯æŒ PDF, å›¾ç‰‡, Word</small>
                            </div>
                        </div>
                        <div class="col-lg-5 col-md-12">
                            <div class="d-flex gap-1 flex-wrap">
                                <button type="button" class="btn btn-sm btn-outline-primary view-file-btn" 
                                        d-none" data-qual-key="${key}" title="é¢„è§ˆæ–‡ä»¶">
                                    <i class="bi bi-eye"></i> é¢„è§ˆ
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success download-file-btn" 
                                        d-none" data-qual-key="${key}" title="ä¸‹è½½æ–‡ä»¶">
                                    <i class="bi bi-download"></i> ä¸‹è½½
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" 
                                        d-none" data-qual-key="${key}" title="åˆ é™¤æ–‡ä»¶">
                                    <i class="bi bi-trash"></i> åˆ é™¤
                                </button>
                                ${isCustom ? `
                                <button type="button" class="btn btn-sm btn-outline-secondary remove-qual-btn" 
                                        data-qual-key="${key}" title="ç§»é™¤æ­¤èµ„è´¨é¡¹">
                                    <i class="bi bi-x-circle"></i> ç§»é™¤é¡¹
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ–‡ä»¶çŠ¶æ€å’Œé¢„è§ˆåŒºåŸŸ -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="file-status bg-light rounded p-2" id="status-${key}" d-none">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="file-info">
                                        <small class="text-muted">æœªä¸Šä¼ æ–‡ä»¶</small>
                                    </div>
                                    <div class="file-progress" d-none">
                                        <div class="progress" style="width: 200px; height: 4px;">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                 role="progressbar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- å›¾ç‰‡é¢„è§ˆåŒºåŸŸ -->
                                <div class="file-preview mt-2" d-none">
                                    <img class="preview-image img-thumbnail" style="max-height: 120px; max-width: 200px;" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç»‘å®šæ–‡ä»¶è¾“å…¥äº‹ä»¶
            const fileInput = div.querySelector('.qual-file-input');
            fileInput.addEventListener('change', function() {
                handleQualificationFileChange(key, this);
            });
            
            // ç»‘å®šä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            const uploadZone = div.querySelector('.upload-zone');
            if (uploadZone) {
                uploadZone.addEventListener('click', function() {
                    fileInput.click();
                });
            }

            // ç»‘å®šæŸ¥çœ‹æŒ‰é’®äº‹ä»¶
            const viewBtn = div.querySelector('.view-file-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', function() {
                    viewQualificationFile(key);
                });
            }

            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const deleteBtn = div.querySelector('.delete-file-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    deleteQualificationFile(key);
                });
            }
            
            // ç»‘å®šä¸‹è½½æŒ‰é’®äº‹ä»¶
            const downloadBtn = div.querySelector('.download-file-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', function() {
                    downloadQualificationFile(key);
                });
            }

            // ç»‘å®šç§»é™¤èµ„è´¨é¡¹æŒ‰é’®äº‹ä»¶ï¼ˆä»…è‡ªå®šä¹‰èµ„è´¨ï¼‰
            const removeBtn = div.querySelector('.remove-qual-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    removeCustomQualification(key);
                });
            }

            return div;
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleQualificationFileChange(key, fileInput) {
            const file = fileInput.files[0];
            const statusDiv = document.getElementById(`status-${key}`);
            const qualElement = fileInput.closest('.qualification-item');
            const viewBtn = qualElement.querySelector('.view-file-btn');
            const downloadBtn = qualElement.querySelector('.download-file-btn');
            const deleteBtn = qualElement.querySelector('.delete-file-btn');

            if (file) {
                // éªŒè¯æ–‡ä»¶å¤§å° (10MBé™åˆ¶)
                if (file.size > 10 * 1024 * 1024) {
                    showCompanyMessage('æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„æ–‡ä»¶', 'error');
                    fileInput.value = '';
                    return;
                }

                // å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
                qualificationFiles[key] = {
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploaded: false
                };

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                const fileTypeIcon = getFileTypeIcon(file.type, file.name);
                const fileSizeText = formatFileSize(file.size);
                
                statusDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="file-info">
                            <small class="text-info">
                                <i class="${fileTypeIcon}"></i> å·²é€‰æ‹©: ${file.name} 
                                (${fileSizeText})
                                <span class="badge bg-warning">å¾…ä¸Šä¼ </span>
                            </small>
                        </div>
                    </div>
                    <div class="file-preview mt-2" d-none">
                        <img class="preview-image img-thumbnail" style="max-height: 120px; max-width: 200px;" />
                    </div>
                `;
                
                // å¦‚æœæ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œæ˜¾ç¤ºé¢„è§ˆ
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewContainer = statusDiv.querySelector('.file-preview');
                        const previewImage = statusDiv.querySelector('.preview-image');
                        if (previewImage && previewContainer) {
                            previewImage.src = e.target.result;
                            previewContainer.style.display = 'block';
                        }
                    };
                    reader.readAsDataURL(file);
                }
                
                statusDiv.style.display = 'block';

                // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                viewBtn.style.display = 'inline-block';
                downloadBtn.style.display = 'inline-block';
                deleteBtn.style.display = 'inline-block';
            } else {
                // æ¸…é™¤æ–‡ä»¶ä¿¡æ¯
                delete qualificationFiles[key];
                statusDiv.style.display = 'none';
                viewBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šè·å–æ–‡ä»¶ç±»å‹å›¾æ ‡
        function getFileTypeIcon(fileType, fileName) {
            // å®‰å…¨æ€§æ£€æŸ¥
            const safeFileType = fileType || '';
            const safeFileName = fileName || '';
            
            if (safeFileType.startsWith('image/')) {
                return 'bi bi-image text-primary';
            } else if (safeFileType === 'application/pdf') {
                return 'bi bi-filetype-pdf text-danger';
            } else if (safeFileType.includes('word') || 
                       safeFileName.toLowerCase().endsWith('.docx') || 
                       safeFileName.toLowerCase().endsWith('.doc')) {
                return 'bi bi-filetype-docx text-info';
            } else if (safeFileType.includes('excel') || 
                       safeFileName.toLowerCase().endsWith('.xlsx') || 
                       safeFileName.toLowerCase().endsWith('.xls')) {
                return 'bi bi-filetype-xlsx text-success';
            } else if (safeFileName.toLowerCase().endsWith('.pdf')) {
                return 'bi bi-filetype-pdf text-danger';
            } else if (safeFileName.toLowerCase().match(/\.(jpg|jpeg|png|gif|bmp)$/)) {
                return 'bi bi-image text-primary';
            } else {
                return 'bi bi-file-earmark text-secondary';
            }
        }
        
        // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // æŸ¥çœ‹æ–‡ä»¶
        function viewQualificationFile(key) {
            const fileInfo = qualificationFiles[key];
            if (!fileInfo) {
                showCompanyMessage('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            if (fileInfo.server_file) {
                // æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œé€šè¿‡APIè·å–
                if (currentCompanyId) {
                    const url = `/api/companies/${currentCompanyId}/qualifications/${key}/download`;
                    window.open(url, '_blank');
                } else {
                    showCompanyMessage('æ— æ³•è·å–æ–‡ä»¶ï¼Œå…¬å¸ä¿¡æ¯ç¼ºå¤±', 'error');
                }
            } else if (fileInfo.file) {
                // æœ¬åœ°é€‰æ‹©çš„æ–‡ä»¶ï¼Œåˆ›å»ºä¸´æ—¶URLé¢„è§ˆ
                const url = URL.createObjectURL(fileInfo.file);
                const newWindow = window.open(url, '_blank');
                if (!newWindow) {
                    showCompanyMessage('æ— æ³•æ‰“å¼€æ–‡ä»¶é¢„è§ˆï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
                }
            } else {
                showCompanyMessage('æ–‡ä»¶ä¸å¯ç”¨', 'error');
            }
        }
        
        // ä¸‹è½½æ–‡ä»¶
        function downloadQualificationFile(key) {
            const fileInfo = qualificationFiles[key];
            if (!fileInfo) {
                showCompanyMessage('æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ä¿¡æ¯', 'error');
                return;
            }
            
            if (fileInfo.server_file) {
                // æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œé€šè¿‡APIä¸‹è½½
                if (currentCompanyId) {
                    const url = `/api/companies/${currentCompanyId}/qualifications/${key}/download`;
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileInfo.original_filename || 'download';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    showCompanyMessage('æ— æ³•ä¸‹è½½æ–‡ä»¶ï¼Œå…¬å¸ä¿¡æ¯ç¼ºå¤±', 'error');
                }
            } else if (fileInfo.file) {
                // æœ¬åœ°é€‰æ‹©çš„æ–‡ä»¶ï¼Œåˆ›å»ºä¸‹è½½é“¾æ¥
                const url = URL.createObjectURL(fileInfo.file);
                const link = document.createElement('a');
                link.href = url;
                link.download = fileInfo.file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                showCompanyMessage('æ–‡ä»¶ä¸å¯ç”¨', 'error');
            }
        }

        // åˆ é™¤æ–‡ä»¶
        function deleteQualificationFile(key) {
            const fileInfo = qualificationFiles[key];
            if (!fileInfo) {
                showCompanyMessage('æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ä¿¡æ¯', 'error');
                return;
            }

            if (fileInfo.server_file) {
                if (!confirm('ç¡®å®šè¦ä»æœåŠ¡å™¨åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    return;
                }

                // åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
                if (currentCompanyId) {
                    fetch(`/api/companies/${currentCompanyId}/qualifications/${key}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // æ¸…é™¤UIçŠ¶æ€
                            clearQualificationFileUI(key);
                            delete qualificationFiles[key];
                            showCompanyMessage('æœåŠ¡å™¨æ–‡ä»¶å·²åˆ é™¤', 'success');
                        } else {
                            showCompanyMessage('åˆ é™¤æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    })
                    .catch(error => {
                        showCompanyMessage('åˆ é™¤æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                    });
                } else {
                    showCompanyMessage('æ— æ³•åˆ é™¤æ–‡ä»¶ï¼Œå…¬å¸ä¿¡æ¯ç¼ºå¤±', 'error');
                }
            } else {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    return;
                }

                // åˆ é™¤æœ¬åœ°é€‰æ‹©çš„æ–‡ä»¶
                clearQualificationFileUI(key);
                delete qualificationFiles[key];
                showCompanyMessage('æ–‡ä»¶å·²åˆ é™¤', 'success');
            }
        }

        // æ¸…é™¤èµ„è´¨æ–‡ä»¶çš„UIçŠ¶æ€
        function clearQualificationFileUI(key) {
            const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
            if (qualElement) {
                const fileInput = qualElement.querySelector('.qual-file-input');
                const statusDiv = document.getElementById(`status-${key}`);
                const viewBtn = qualElement.querySelector('.view-file-btn');
                const deleteBtn = qualElement.querySelector('.delete-file-btn');

                // æ¸…é™¤æ–‡ä»¶è¾“å…¥å’ŒUIçŠ¶æ€
                if (fileInput) fileInput.value = '';
                if (statusDiv) statusDiv.style.display = 'none';
                if (viewBtn) viewBtn.style.display = 'none';
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
        }

        // è‡ªå®šä¹‰èµ„è´¨åŠŸèƒ½å·²ç§»é™¤ - åŠŸèƒ½é›†ä¸­åœ¨å•†åŠ¡åº”ç­”é¡µé¢
        /*
        const addCustomQualificationBtn = document.getElementById('addCustomQualificationBtn');
        if (addCustomQualificationBtn) {
            addCustomQualificationBtn.addEventListener('click', function() {
            const nameInput = document.getElementById('customQualificationName');
            const name = nameInput.value.trim();

            if (!name) {
                showCompanyMessage('è¯·è¾“å…¥èµ„è´¨åç§°', 'error');
                return;
            }

            // ç”Ÿæˆå”¯ä¸€key
            customQualificationCounter++;
            const key = `custom_${customQualificationCounter}_${Date.now()}`;

            // åˆ›å»ºè‡ªå®šä¹‰èµ„è´¨é¡¹ç›®
            const qualElement = createQualificationElement(key, name, 'bi-file-plus', true);
            document.getElementById('customQualifications').appendChild(qualElement);

            // æ¸…ç©ºè¾“å…¥æ¡†
            nameInput.value = '';

            showCompanyMessage(`å·²æ·»åŠ è‡ªå®šä¹‰èµ„è´¨é¡¹: ${name}`, 'success');
        });
        } else {
            console.log('addCustomQualificationBtn å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡äº‹ä»¶ç»‘å®š');
        }
        */

        // ç§»é™¤è‡ªå®šä¹‰èµ„è´¨é¡¹
        function removeCustomQualification(key) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªèµ„è´¨é¡¹å—ï¼Ÿç›¸å…³æ–‡ä»¶ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) {
                return;
            }

            // åˆ é™¤æ–‡ä»¶è®°å½•
            delete qualificationFiles[key];

            // ç§»é™¤DOMå…ƒç´ 
            const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
            if (qualElement) {
                qualElement.remove();
            }

            showCompanyMessage('èµ„è´¨é¡¹å·²ç§»é™¤', 'success');
        }

        // èµ„è´¨æ–‡ä»¶ä¿å­˜åŠŸèƒ½
        safeAddEventListener('saveAllQualificationsBtn', 'click', function() {
            if (!currentCompanyId) {
                showCompanyGuideModal();
                return;
            }

            const fileCount = Object.keys(qualificationFiles).length;
            if (fileCount === 0) {
                showCompanyMessage('æ²¡æœ‰é€‰æ‹©ä»»ä½•èµ„è´¨æ–‡ä»¶', 'error');
                return;
            }

            uploadQualificationFiles();
        });

        // å†…éƒ¨æ¸…ç©ºèµ„è´¨å‡½æ•°ï¼ˆä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼‰
        function clearAllQualificationsInternal() {
            // æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶
            qualificationFiles = {};

            // é‡æ–°åˆå§‹åŒ–æ ‡å‡†èµ„è´¨é¡¹ç›®ï¼ˆè¿™ä¼šæ¸…ç©ºå¹¶é‡å»ºæ‰€æœ‰èµ„è´¨é¡¹ï¼‰
            const container = document.getElementById('standardQualifications');
            if (container) {
                initializeStandardQualifications();
            }

            // ç§»é™¤æ‰€æœ‰è‡ªå®šä¹‰èµ„è´¨é¡¹
            const customQualContainer = document.getElementById('customQualifications');
            if (customQualContainer) {
                customQualContainer.innerHTML = '';
            }
        }

        // æ¸…ç©ºèµ„è´¨åŠŸèƒ½
        safeAddEventListener('clearAllQualificationsBtn', 'click', function() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èµ„è´¨æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            clearAllQualificationsInternal();
            showCompanyMessage('æ‰€æœ‰èµ„è´¨æ–‡ä»¶å·²æ¸…ç©º', 'success');
        });

        // ä¸Šä¼ èµ„è´¨æ–‡ä»¶
        function uploadQualificationFiles() {
            const formData = new FormData();
            
            // æ·»åŠ å…¬å¸ID
            formData.append('company_id', currentCompanyId);
            
            // å‡†å¤‡è‡ªå®šä¹‰èµ„è´¨åç§°æ˜ å°„
            const qualificationNames = {};

            // æ·»åŠ æ‰€æœ‰æ–‡ä»¶
            for (const [key, fileInfo] of Object.entries(qualificationFiles)) {
                if (fileInfo.file) {
                    formData.append(`qualifications[${key}]`, fileInfo.file);
                    
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰èµ„è´¨ï¼Œæ”¶é›†åç§°ä¿¡æ¯
                    if (key.startsWith('custom_')) {
                        const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
                        if (qualElement) {
                            const qualName = qualElement.querySelector('h6').textContent.replace(/.*\s/, '');
                            qualificationNames[key] = qualName;
                        }
                    }
                }
            }
            
            // æ·»åŠ è‡ªå®šä¹‰èµ„è´¨åç§°æ˜ å°„ä½œä¸ºJSONå­—ç¬¦ä¸²
            formData.append('qualification_names', JSON.stringify(qualificationNames));

            const btn = document.getElementById('saveAllQualificationsBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> ä¸Šä¼ ä¸­...';
            btn.disabled = true;

            fetch(`/api/companies/${currentCompanyId}/qualifications/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°æ–‡ä»¶çŠ¶æ€
                    Object.keys(qualificationFiles).forEach(key => {
                        if (qualificationFiles[key]) {
                            qualificationFiles[key].uploaded = true;
                            updateFileStatus(key);
                        }
                    });

                    showCompanyMessage(`æˆåŠŸä¸Šä¼  ${data.uploaded_count} ä¸ªèµ„è´¨æ–‡ä»¶`, 'success');
                } else {
                    showCompanyMessage('ä¸Šä¼ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                showCompanyMessage('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
        function updateFileStatus(key) {
            const fileInfo = qualificationFiles[key];
            const statusDiv = document.getElementById(`status-${key}`);

            if (fileInfo && statusDiv) {
                const statusClass = fileInfo.uploaded ? 'text-success' : 'text-info';
                const statusBadge = fileInfo.uploaded ? 
                    '<span class="badge bg-success">å·²ä¸Šä¼ </span>' : 
                    '<span class="badge bg-warning">å¾…ä¸Šä¼ </span>';

                statusDiv.innerHTML = `
                    <small class="${statusClass}">
                        <i class="bi bi-file-earmark"></i> ${fileInfo.name} 
                        (${(fileInfo.size / 1024).toFixed(1)} KB)
                        ${statusBadge}
                    </small>
                `;
            }
        }
        
        // æ ‡å‡†èµ„è´¨åŠŸèƒ½å’Œè‡ªå®šä¹‰èµ„è´¨åŠŸèƒ½ï¼ˆå·²é›†æˆåˆ°ç»Ÿä¸€åˆå§‹åŒ–ä¸­ï¼‰
        // è‡ªå®šä¹‰èµ„è´¨æ·»åŠ æŒ‰é’®äº‹ä»¶ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
            safeAddEventListener('addCustomQualificationBtn', 'click', function() {
                const nameInput = document.getElementById('customQualificationName');
                const name = nameInput.value.trim();
                
                if (!name) {
                    alert('è¯·è¾“å…¥èµ„è´¨åç§°');
                    return;
                }
                
                // åˆ›å»ºè‡ªå®šä¹‰èµ„è´¨é¡¹
                const customKey = `custom_${customQualificationCounter++}`;
                const qualElement = createQualificationElement(customKey, name, 'bi-file-earmark-plus', true);
                
                document.getElementById('customQualifications').appendChild(qualElement);
                nameInput.value = '';
                
                console.log(`æ·»åŠ è‡ªå®šä¹‰èµ„è´¨: ${name} (${customKey})`);
            });
        });

        console.log('Qualification management initialized');

        // =========================
        // å•†åŠ¡åº”ç­”åŠŸèƒ½
        // =========================
        
        // å•†åŠ¡åº”ç­”æ–‡ä»¶ä¸Šä¼ å¤„ç†
        const businessTemplateFile = document.getElementById('businessTemplateFile');
        if (businessTemplateFile) {
            businessTemplateFile.addEventListener('change', function() {
                const fileName = this.files[0]?.name;
                const fileNameDiv = document.getElementById('businessTemplateFileName');
                if (fileName && fileNameDiv) {
                    fileNameDiv.innerHTML = `<div class="alert alert-info py-2"><i class="bi bi-file-earmark-word"></i> ${fileName}</div>`;
                } else if (fileNameDiv) {
                    fileNameDiv.innerHTML = '';
                }
            });
        }
        
        // å•†åŠ¡åº”ç­”è¡¨å•æäº¤å¤„ç†
        const businessResponseForm = document.getElementById('businessResponseForm');
        if (businessResponseForm) {
            businessResponseForm.addEventListener('submit', function(e) {
                e.preventDefault();
            
            const templateFile = document.getElementById('businessTemplateFile').files[0];
            const companyId = document.getElementById('businessCompanySelect').value;
            const projectName = document.getElementById('businessProjectName').value;
            const tenderNo = document.getElementById('businessTenderNo').value;
            const dateText = document.getElementById('businessDate').value;
            const useMcp = 'true'; // é»˜è®¤ä½¿ç”¨MCPå¤„ç†å™¨
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!templateFile) {
                alert('è¯·é€‰æ‹©å•†åŠ¡åº”ç­”æ¨¡æ¿');
                return;
            }
            
            if (!companyId) {
                alert('è¯·é€‰æ‹©åº”ç­”å…¬å¸');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progress = document.getElementById('businessProgress');
            const result = document.getElementById('businessResult');
            const error = document.getElementById('businessError');
            const stats = document.getElementById('businessStats');
            
            progress.style.display = 'block';
            result.style.display = 'none';
            error.style.display = 'none';
            stats.style.display = 'none';
            
            // æ„å»ºFormData
            const formData = new FormData();
            formData.append('template_file', templateFile);
            formData.append('company_id', companyId);
            formData.append('project_name', projectName);
            formData.append('tender_no', tenderNo);
            formData.append('date_text', dateText);
            formData.append('use_mcp', useMcp);
            
            // å‘é€è¯·æ±‚
            fetch('/process-business-response', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                progress.style.display = 'none';
                
                if (data.success) {
                    // éšè—é”™è¯¯æç¤ºï¼Œæ˜¾ç¤ºæˆåŠŸç»“æœ
                    error.style.display = 'none';
                    document.getElementById('businessResultMessage').textContent = data.message;
                    document.getElementById('businessDownloadLink').href = data.download_url;
                    result.style.display = 'block';
                    
                    // æ˜¾ç¤ºå¤„ç†ç»Ÿè®¡
                    if (data.stats) {
                        const statsContent = document.getElementById('businessStatsContent');
                        let statsHtml = '';
                        
                        if (data.stats.bidder_name) {
                            statsHtml += `<p><strong>æŠ•æ ‡äººåç§°å¡«å†™ï¼š</strong> æ®µè½${data.stats.bidder_name.paragraphs_changed}ä¸ªï¼Œè¡¨æ ¼${data.stats.bidder_name.tables_changed}ä¸ª</p>`;
                        }
                        if (data.stats.project_info) {
                            statsHtml += `<p><strong>é¡¹ç›®ä¿¡æ¯å¡«å†™ï¼š</strong> æ›¿æ¢${data.stats.project_info.replacements_made}é¡¹ï¼ŒæŠ•æ ‡äººå­—æ®µ${data.stats.project_info.bidder_fields_filled}ä¸ª</p>`;
                        }
                        if (data.stats.qualification_images) {
                            statsHtml += `<p><strong>èµ„è´¨å›¾ç‰‡æ’å…¥ï¼š</strong> æ‰¾åˆ°å…³é”®è¯${data.stats.qualification_images.keywords_found}ä¸ªï¼Œæ’å…¥å›¾ç‰‡${data.stats.qualification_images.images_inserted}å¼ </p>`;
                        }
                        
                        if (statsHtml) {
                            statsContent.innerHTML = statsHtml;
                            stats.style.display = 'block';
                        }
                    }
                    
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    loadBusinessFilesList();
                } else {
                    // ä½¿ç”¨ErrorHandlerå¤„ç†é”™è¯¯ä¿¡æ¯ï¼Œé˜²æ­¢æ˜¾ç¤º[object Object]
                    const errorMsg = ErrorHandler.formatErrorMessage(data.error || data.message || data) || 'å¤„ç†å¤±è´¥';
                    document.getElementById('businessErrorMessage').textContent = errorMsg;
                    error.style.display = 'block';
                }
            })
            .catch(err => {
                progress.style.display = 'none';
                // ä½¿ç”¨ErrorHandlerå¤„ç†ç½‘ç»œé”™è¯¯
                const errorMsg = ErrorHandler.handleAPIError(err, 'å•†åŠ¡åº”ç­”å¤„ç†å¤±è´¥');
                document.getElementById('businessErrorMessage').textContent = errorMsg;
                error.style.display = 'block';
                console.error('å•†åŠ¡åº”ç­”å¤„ç†å¤±è´¥:', err);
            });
            });
        }
        
        // æ–‡æ¡£é¢„è§ˆå’Œç¼–è¾‘åŠŸèƒ½
        let currentDocumentPath = null; // å­˜å‚¨å½“å‰æ–‡æ¡£è·¯å¾„
        let wordEditor = null; // WordEditorå®ä¾‹
        
        // é¢„è§ˆå•†åŠ¡åº”ç­”æ–‡æ¡£
        function previewBusinessDocument() {
            const downloadLink = document.getElementById('businessDownloadLink');
            if (!downloadLink || !downloadLink.href) {
                showNotification('æ²¡æœ‰å¯é¢„è§ˆçš„æ–‡æ¡£', 'warning');
                return;
            }
            
            // ä»ä¸‹è½½é“¾æ¥è·å–æ–‡ä»¶è·¯å¾„
            const url = new URL(downloadLink.href, window.location.href);
            const filename = url.pathname.split('/').pop();
            currentDocumentPath = filename;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const previewContent = document.getElementById('documentPreviewContent');
            previewContent.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">æ­£åœ¨åŠ è½½æ–‡æ¡£...</p></div>';
            
            // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
            const previewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
            previewModal.show();
            
            // è°ƒç”¨APIè·å–æ–‡æ¡£å†…å®¹
            fetch(`/api/document/preview/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        previewContent.innerHTML = data.html_content || '<p>æ–‡æ¡£å†…å®¹ä¸ºç©º</p>';
                    } else {
                        previewContent.innerHTML = `<div class="alert alert-danger">é¢„è§ˆå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    }
                })
                .catch(error => {
                    previewContent.innerHTML = `<div class="alert alert-danger">é¢„è§ˆå¤±è´¥: ${error.message}</div>`;
                });
        }
        
        // ç¼–è¾‘å•†åŠ¡åº”ç­”æ–‡æ¡£
        function editBusinessDocument() {
            const downloadLink = document.getElementById('businessDownloadLink');
            if (!downloadLink || !downloadLink.href) {
                showNotification('æ²¡æœ‰å¯ç¼–è¾‘çš„æ–‡æ¡£', 'warning');
                return;
            }
            
            // åˆå§‹åŒ–ç¼–è¾‘å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
            if (!wordEditor) {
                wordEditor = new WordEditor('documentEditor', {
                    height: 500,
                    placeholder: 'è¯·ç‚¹å‡»"è¯»å–æ–‡æ¡£"åŠ è½½å•†åŠ¡åº”ç­”æ–‡æ¡£å†…å®¹...'
                });
            }
            
            // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
            const editModal = new bootstrap.Modal(document.getElementById('documentEditModal'));
            editModal.show();
            
            // è‡ªåŠ¨åŠ è½½æ–‡æ¡£
            setTimeout(() => {
                loadDocumentToEditor();
            }, 500);
        }
        
        // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
        function switchToEditMode() {
            // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
            const previewModal = bootstrap.Modal.getInstance(document.getElementById('documentPreviewModal'));
            if (previewModal) {
                previewModal.hide();
            }

            // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
            setTimeout(() => {
                editBusinessDocument();
            }, 300);
        }

        // ç‚¹å¯¹ç‚¹åº”ç­”æ–‡æ¡£é¢„è§ˆ
        function previewPointDocument() {
            const downloadBtn = document.getElementById('downloadBtn');
            if (!downloadBtn) {
                showNotification('æ²¡æœ‰å¯é¢„è§ˆçš„æ–‡æ¡£', 'warning');
                return;
            }

            // ä»dataå±æ€§è·å–ä¸‹è½½URL
            const downloadUrl = downloadBtn.getAttribute('data-download-url');
            if (!downloadUrl || downloadUrl === 'undefined') {
                showNotification('æ— æ³•è·å–æ–‡æ¡£è·¯å¾„ï¼Œè¯·é‡æ–°å¤„ç†å†…è”å›å¤', 'error');
                return;
            }

            const filename = downloadUrl.split('/').pop();
            currentDocumentPath = filename;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const previewContent = document.getElementById('documentPreviewContent');
            previewContent.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">æ­£åœ¨åŠ è½½æ–‡æ¡£...</p></div>';

            // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
            const previewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
            previewModal.show();

            // è°ƒç”¨APIè·å–æ–‡æ¡£å†…å®¹
            fetch(`/api/document/preview/${filename}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        previewContent.innerHTML = data.html_content || '<p>æ–‡æ¡£å†…å®¹ä¸ºç©º</p>';
                    } else {
                        previewContent.innerHTML = `<div class="alert alert-danger">é¢„è§ˆå¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    }
                })
                .catch(error => {
                    console.error('é¢„è§ˆæ–‡æ¡£å¤±è´¥:', error);
                    previewContent.innerHTML = `<div class="alert alert-danger">é¢„è§ˆå¤±è´¥: ${error.message}</div>`;
                });
        }

        // ç‚¹å¯¹ç‚¹åº”ç­”æ–‡æ¡£ç¼–è¾‘
        function editPointDocument() {
            const downloadBtn = document.getElementById('downloadBtn');
            if (!downloadBtn) {
                showNotification('æ²¡æœ‰å¯ç¼–è¾‘çš„æ–‡æ¡£', 'warning');
                return;
            }

            // ä»dataå±æ€§è·å–ä¸‹è½½URL
            const downloadUrl = downloadBtn.getAttribute('data-download-url');
            if (!downloadUrl || downloadUrl === 'undefined') {
                showNotification('æ— æ³•è·å–æ–‡æ¡£è·¯å¾„ï¼Œè¯·é‡æ–°å¤„ç†å†…è”å›å¤', 'error');
                return;
            }

            const filename = downloadUrl.split('/').pop();
            currentDocumentPath = filename;

            // åˆå§‹åŒ–ç¼–è¾‘å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
            if (!wordEditor) {
                wordEditor = new WordEditor('documentEditor', {
                    height: 500,
                    placeholder: 'è¯·ç‚¹å‡»"è¯»å–æ–‡æ¡£"åŠ è½½ç‚¹å¯¹ç‚¹åº”ç­”æ–‡æ¡£å†…å®¹...'
                });
            }

            // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
            const editModal = new bootstrap.Modal(document.getElementById('documentEditModal'));
            editModal.show();

            // è‡ªåŠ¨åŠ è½½æ–‡æ¡£
            setTimeout(() => {
                loadDocumentToEditor();
            }, 500);
        }
        
        // é¢„è§ˆå†å²æ–‡æ¡£
        function previewHistoricalDocument(filename) {
            if (!filename) {
                showNotification('æ–‡ä»¶åä¸èƒ½ä¸ºç©º', 'warning');
                return;
            }
            
            // è®¾ç½®å½“å‰æ–‡æ¡£è·¯å¾„ï¼ˆç”¨äºç¼–è¾‘åŠŸèƒ½ï¼‰
            currentDocumentPath = filename;
            
            // æ„å»ºæ–‡æ¡£é¢„è§ˆURL
            const previewUrl = `/api/document/preview/${encodeURIComponent(filename)}`;
            
            fetch(previewUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                // å¤„ç†JSONå“åº”
                let htmlContent = '';
                if (data.success && data.html_content) {
                    htmlContent = data.html_content;
                } else if (data.html_content) {
                    htmlContent = data.html_content;
                } else {
                    throw new Error(data.message || 'é¢„è§ˆå†…å®¹ä¸ºç©º');
                }
                
                // æ˜¾ç¤ºé¢„è§ˆå†…å®¹
                const previewContent = document.getElementById('documentPreviewContent');
                if (previewContent) {
                    previewContent.innerHTML = htmlContent;
                }
                
                // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
                const previewModal = new bootstrap.Modal(document.getElementById('documentPreviewModal'));
                previewModal.show();
                
                showNotification('å†å²æ–‡æ¡£é¢„è§ˆåŠ è½½æˆåŠŸ', 'success');
            })
            .catch(error => {
                console.error('å†å²æ–‡æ¡£é¢„è§ˆå¤±è´¥:', error);
                showNotification(`å†å²æ–‡æ¡£é¢„è§ˆå¤±è´¥: ${error.message}`, 'error');
                
                // é™çº§å¤„ç†ï¼šæä¾›ç›´æ¥ä¸‹è½½é“¾æ¥
                const downloadUrl = `/download/${encodeURIComponent(filename)}`;
                showNotification(`é¢„è§ˆå¤±è´¥ï¼Œå¯ä»¥<a href="${downloadUrl}" target="_blank">ç›´æ¥ä¸‹è½½æ–‡æ¡£</a>`, 'warning', 5000);
            });
        }
        
        // åŠ è½½æ–‡æ¡£åˆ°ç¼–è¾‘å™¨
        function loadDocumentToEditor() {
            if (!currentDocumentPath) {
                showNotification('æ²¡æœ‰å¯åŠ è½½çš„æ–‡æ¡£', 'warning');
                return;
            }
            
            if (!wordEditor) {
                showNotification('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            // æ–¹æ¡ˆ1ï¼šé€šè¿‡é¢„è§ˆAPIè·å–HTMLå†…å®¹ç›´æ¥åŠ è½½åˆ°ç¼–è¾‘å™¨
            fetch(`/api/document/preview/${currentDocumentPath}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.html_content) {
                        wordEditor.setContent(data.html_content);
                        showNotification('æ–‡æ¡£å†…å®¹åŠ è½½æˆåŠŸ', 'success');
                    } else {
                        throw new Error(data.error || 'æ— æ³•è·å–æ–‡æ¡£å†…å®¹');
                    }
                })
                .catch(error => {
                    console.error('Document loading error:', error);
                    showNotification('æ–‡æ¡£åŠ è½½å¤±è´¥: ' + error.message, 'error');
                    
                    // æ–¹æ¡ˆ2ï¼šå¦‚æœé¢„è§ˆå¤±è´¥ï¼Œå°è¯•åŸå§‹æ–‡ä»¶åŠ è½½
                    tryLoadOriginalFile();
                });
        }
        
        // å°è¯•åŠ è½½åŸå§‹æ–‡ä»¶çš„å¤‡ç”¨æ–¹æ¡ˆ
        function tryLoadOriginalFile() {
            if (!currentDocumentPath || !wordEditor) return;
            
            fetch(`/download/${currentDocumentPath}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // ç¡®ä¿æ­£ç¡®çš„MIMEç±»å‹
                    const mimeType = currentDocumentPath.endsWith('.docx') 
                        ? 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
                        : 'application/msword';
                    
                    const file = new File([blob], currentDocumentPath, { 
                        type: mimeType 
                    });
                    
                    return wordEditor.loadDocument(file);
                })
                .then(() => {
                    showNotification('æ–‡æ¡£åŠ è½½æˆåŠŸ', 'success');
                })
                .catch(error => {
                    console.error('Fallback document loading error:', error);
                    showNotification('æ–‡æ¡£åŠ è½½å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        // ä¿å­˜ç¼–è¾‘çš„æ–‡æ¡£
        function saveEditedDocument() {
            if (!wordEditor) {
                showNotification('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const filename = currentDocumentPath ? currentDocumentPath.replace('.docx', '_edited') : 'edited_document';
            wordEditor.saveDocument(filename)
                .then(() => {
                    showNotification('æ–‡æ¡£ä¿å­˜æˆåŠŸ', 'success');
                })
                .catch(error => {
                    showNotification('æ–‡æ¡£ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                });
        }
        
        // ä¿å­˜å¹¶ä¸‹è½½
        function saveAndDownload() {
            saveEditedDocument();
        }
        
        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearEditor() {
            if (!wordEditor) {
                showNotification('ç¼–è¾‘å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºç¼–è¾‘å™¨å†…å®¹å—ï¼Ÿ')) {
                wordEditor.clearContent();
                showNotification('ç¼–è¾‘å™¨å·²æ¸…ç©º', 'info');
            }
        }
        
        // å•†åŠ¡åº”ç­”"ä¸‹ä¸€æ­¥"æŒ‰é’®ç‚¹å‡»å¤„ç†
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'businessNextStepBtn') {
                // åˆ‡æ¢åˆ°ç‚¹å¯¹ç‚¹åº”ç­”é€‰é¡¹å¡
                const pointToPointTab = document.getElementById('point-to-point-tab');
                if (pointToPointTab) {
                    pointToPointTab.click();
                }
            }
        });
        
        // åŠ è½½å•†åŠ¡åº”ç­”å†å²æ–‡ä»¶
        function loadBusinessFilesList() {
            const filesList = document.getElementById('businessFilesList');
            if (!filesList) {
                console.log('businessFilesList å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡æ–‡ä»¶åˆ—è¡¨åŠ è½½');
                return;
            }
            
            fetch('/api/business-files')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                    html += '<th>æ–‡ä»¶å</th><th>å¤§å°</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    
                    data.files.forEach(file => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        const downloadUrl = `/download/${encodeURIComponent(file.name)}`;
                        const previewBtn = `<button class="btn btn-sm btn-outline-info me-2" onclick="previewHistoricalDocument('${file.name}')">é¢„è§ˆ</button>`;
                        html += `<tr>
                            <td>${file.name}</td>
                            <td>${size} MB</td>
                            <td>${date}</td>
                            <td>
                                ${previewBtn}
                                <a href="${downloadUrl}" class="btn btn-sm btn-outline-primary">ä¸‹è½½</a>
                            </td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    filesList.innerHTML = html;
                } else {
                    filesList.innerHTML = '<p class="text-muted">æš‚æ— å†å²æ–‡ä»¶</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½å•†åŠ¡åº”ç­”æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                filesList.innerHTML = '<p class="text-warning">æ–‡ä»¶åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            });
        }

        // åŠ è½½ç‚¹å¯¹ç‚¹åº”ç­”å†å²æ–‡ä»¶
        function loadPointToPointFilesList() {
            const filesList = document.getElementById('pointHistoryFilesList');
            if (!filesList) {
                console.log('pointHistoryFilesList å…ƒç´ ä¸å­˜åœ¨ï¼Œè·³è¿‡æ–‡ä»¶åˆ—è¡¨åŠ è½½');
                return;
            }

            fetch('/api/point-to-point-files')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                    html += '<th>æ–‡ä»¶å</th><th>å¤§å°</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';

                    data.files.forEach(file => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        const downloadUrl = `/download/${encodeURIComponent(file.name)}`;
                        const previewBtn = `<button class="btn btn-sm btn-outline-info me-2" onclick="previewHistoricalDocument('${file.name}')">é¢„è§ˆ</button>`;
                        html += `<tr>
                            <td>${file.name}</td>
                            <td>${size} MB</td>
                            <td>${date}</td>
                            <td>
                                ${previewBtn}
                                <a href="${downloadUrl}" class="btn btn-sm btn-outline-primary">ä¸‹è½½</a>
                            </td>
                        </tr>`;
                    });

                    html += '</tbody></table></div>';
                    filesList.innerHTML = html;
                } else {
                    filesList.innerHTML = '<p class="text-muted">æš‚æ— å†å²æ–‡ä»¶</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½ç‚¹å¯¹ç‚¹åº”ç­”æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                filesList.innerHTML = '<p class="text-warning">æ–‡ä»¶åˆ—è¡¨åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            });
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å•†åŠ¡åº”ç­”é¡µé¢
        function initBusinessResponsePage() {
            // ç¡®ä¿æ‰€æœ‰ç»“æœåŒºåŸŸéƒ½è¢«éšè—
            const businessResult = document.getElementById('businessResult');
            const businessError = document.getElementById('businessError');
            const businessStats = document.getElementById('businessStats');
            const businessProgress = document.getElementById('businessProgress');
            
            if (businessResult) businessResult.style.display = 'none';
            if (businessError) businessError.style.display = 'none';
            if (businessStats) businessStats.style.display = 'none';
            if (businessProgress) businessProgress.style.display = 'none';
        }
        
        // ç›‘å¬å•†åŠ¡åº”ç­”é€‰é¡¹å¡çš„æ˜¾ç¤ºäº‹ä»¶
        document.addEventListener('shown.bs.tab', function(e) {
            if (e.target.id === 'business-response-nav') {
                // å½“åˆ‡æ¢åˆ°å•†åŠ¡åº”ç­”é€‰é¡¹å¡æ—¶ï¼Œç¡®ä¿ç»“æœåŒºåŸŸè¢«éšè—
                initBusinessResponsePage();
            } else if (e.target.id === 'point-to-point-nav') {
                // å½“åˆ‡æ¢åˆ°ç‚¹å¯¹ç‚¹åº”ç­”é€‰é¡¹å¡æ—¶ï¼ŒåŠ è½½å†å²æ–‡ä»¶
                loadPointToPointFilesList();
            }
        });
        
        // å•†åŠ¡åº”ç­”åŠŸèƒ½åˆå§‹åŒ–ï¼ˆå·²é›†æˆåˆ°ç»Ÿä¸€åˆå§‹åŒ–ä¸­ï¼‰
        // initBusinessResponsePage() ç°åœ¨åœ¨ç»Ÿä¸€åˆå§‹åŒ–ä¸­è°ƒç”¨
            loadBusinessFilesList();
            
            // ç¡®ä¿å…¬å¸åˆ—è¡¨å·²åŠ è½½ï¼ˆé˜²æ­¢åˆå§‹åŒ–é¡ºåºé—®é¢˜ï¼‰ - å·²ç”±ç»Ÿä¸€åˆå§‹åŒ–å¤„ç†ï¼Œç§»é™¤é‡å¤è°ƒç”¨
            // setTimeout(() => {
            //     if (typeof loadCompanyList === 'function') {
            //         console.log('å•†åŠ¡åº”ç­”é¡µé¢ï¼šç¡®ä¿å…¬å¸åˆ—è¡¨å·²åŠ è½½');
            //         loadCompanyList();
            //     }
            // }, 100);
            
            // å•†åŠ¡åº”ç­”å…¬å¸é€‰æ‹©äº‹ä»¶å·²åœ¨ç»Ÿä¸€åˆå§‹åŒ–ä¸­é€šè¿‡CompanySelectorå¤„ç†
            
            // å•†åŠ¡åº”ç­”é¡µé¢çš„å…¬å¸ç®¡ç†åŠŸèƒ½å·²ç®€åŒ–ï¼ŒåŠŸèƒ½è¿ç§»åˆ°ä¸“é—¨çš„å…¬å¸ç®¡ç†é¡µé¢
            
            // æ·»åŠ é¡µé¢çŠ¶æ€æ£€æŸ¥
            function checkPageStatus() {
                console.log('=== é¡µé¢çŠ¶æ€æ£€æŸ¥ ===');
                console.log('å½“å‰æ´»è·ƒtab:', document.querySelector('.nav-link.active')?.textContent?.trim());
                console.log('businessCompanySelectå…ƒç´ å­˜åœ¨:', !!document.getElementById('businessCompanySelect'));
                console.log('=== æ£€æŸ¥å®Œæˆ ===');
            }
            
            // ç«‹å³æ‰§è¡Œä¸€æ¬¡çŠ¶æ€æ£€æŸ¥
            checkPageStatus();
            
            // æ¯5ç§’è‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡ï¼ˆä»…å‰3æ¬¡ï¼Œé¿å…è¿‡å¤šæ—¥å¿—ï¼‰
            let checkCount = 0;
            const checkInterval = setInterval(function() {
                checkCount++;
                console.log(`ç¬¬${checkCount}æ¬¡çŠ¶æ€æ£€æŸ¥:`);
                checkPageStatus();
                if (checkCount >= 3) {
                    clearInterval(checkInterval);
                }
            }, 5000);
        });

        // =========================
        // å…¬å¸ç®¡ç†æ¨¡æ€æ¡†åŠŸèƒ½
        // =========================
        
        
        
        // é‡å¤çš„window.loadäº‹ä»¶å·²ç§»é™¤ï¼ŒåŠŸèƒ½å·²åˆå¹¶åˆ°ä¸Šé¢çš„å•†åŠ¡åº”ç­”loadäº‹ä»¶ä¸­
        
        // handleViewCompany å’Œ handleAddCompany å‡½æ•°å·²ç§»é™¤
        // åŠŸèƒ½å·²è¿ç§»åˆ°ä¸“é—¨çš„å…¬å¸ç®¡ç†é¡µé¢
        
        
        // åŠ è½½å…¬å¸åˆ—è¡¨åˆ°æ¨¡æ€æ¡†
        // åŠ è½½å…¬å¸ä¿¡æ¯åˆ°æ¨¡æ€æ¡†
        
        // åŠ è½½å…¬å¸èµ„è´¨ä¿¡æ¯åˆ°æ¨¡æ€æ¡†
        // ä¿å­˜å…¬å¸ä¿¡æ¯ï¼ˆä½¿ç”¨ç»Ÿä¸€ç®¡ç†å™¨ï¼‰
        
        // åˆ é™¤å…¬å¸ï¼ˆä½¿ç”¨ç»Ÿä¸€ç®¡ç†å™¨ï¼‰
        
        // ç›‘å¬å…¬å¸ç®¡ç†é€‰é¡¹å¡æ¿€æ´»äº‹ä»¶ï¼ˆä½¿ç”¨ç»Ÿä¸€ç®¡ç†å™¨ï¼‰
        document.addEventListener('shown.bs.tab', function(e) {
        });

        // DOMåŠ è½½å®Œæˆååˆå§‹åŒ–ç»„ä»¶
        InitializationManager.ensureDOMReady(() => {
            ComponentState.init();
            InitializationManager.markReady();
            console.log('AIæ ‡ä¹¦ç³»ç»Ÿå‰ç«¯åˆå§‹åŒ–å®Œæˆ');
        });

        // æ˜¾ç¤ºå…¬å¸ä¿¡æ¯å¼•å¯¼æ¨¡æ€æ¡†

        // å¯¼èˆªåˆ°å…¬å¸ç®¡ç†æ ‡ç­¾é¡µ

    </script>

    <!-- æ–‡æ¡£é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal fade" id="documentPreviewModal" tabindex="-1" aria-labelledby="documentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentPreviewModalLabel">
                        <i class="bi bi-eye"></i> æ–‡æ¡£é¢„è§ˆ
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="documentPreviewContent" style="min-height: 500px; padding: 20px; background: white;">
                        <!-- é¢„è§ˆå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-warning" onclick="switchToEditMode()">
                        <i class="bi bi-pencil-square"></i> ç¼–è¾‘æ–‡æ¡£
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–‡æ¡£ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="documentEditModal" tabindex="-1" aria-labelledby="documentEditModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentEditModalLabel">
                        <i class="bi bi-pencil-square"></i> æ–‡æ¡£ç¼–è¾‘å™¨
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="loadDocumentToEditor()">
                                <i class="bi bi-folder-open"></i> è¯»å–æ–‡æ¡£
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="saveEditedDocument()">
                                <i class="bi bi-save"></i> ä¿å­˜æ–‡æ¡£
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clearEditor()">
                                <i class="bi bi-trash"></i> æ¸…ç©ºå†…å®¹
                            </button>
                        </div>
                    </div>
                    <textarea id="documentEditor" style="width: 100%; min-height: 500px;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndDownload()">
                        <i class="bi bi-download"></i> ä¿å­˜å¹¶ä¸‹è½½
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- JavaScriptæ–‡ä»¶å¼•ç”¨ -->
    <script src="{{ url_for('static', filename='js/state-manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/common.js') }}"></script>
    <script src="{{ url_for('static', filename='js/word-editor.js') }}"></script>
    
    <script>
        // å…¨å±€å…¬å¸çŠ¶æ€ç®¡ç†å™¨
        const GlobalCompanyManager = {
            // åˆå§‹åŒ–çŠ¶æ€æ ‡å¿—
            _isInitialized: false,
            // ç»Ÿä¸€æ›´æ–°æ‰€æœ‰å…¬å¸é€‰æ‹©å™¨
            syncCompanySelectors(companyId) {
                console.log('[GlobalCompanyManager] åŒæ­¥å…¬å¸é€‰æ‹©å™¨:', companyId);
                
                // åŒæ­¥å•†åŠ¡åº”ç­”é€‰æ‹©å™¨
                const businessSelect = document.getElementById('businessCompanySelect');
                if (businessSelect) {
                    businessSelect.value = companyId || '';
                }
                
                // åŒæ­¥å…¬å¸ç®¡ç†é€‰æ‹©å™¨
                
                // æ›´æ–°StateManager
                StateManager.setCompanyId(companyId);
                
                // æ›´æ–°UIçŠ¶æ€æŒ‡ç¤º
                this.updateCompanyStatusUI(companyId);
                
                // æ˜¾ç¤ºé€‰ä¸­çš„å…¬å¸ä¿¡æ¯ï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰
                setTimeout(() => this.displaySelectedCompany(), 50);
            },
            
            // æ›´æ–°å…¬å¸çŠ¶æ€UIæ˜¾ç¤º
            async updateCompanyStatusUI(companyId) {
                // æ›´æ–°å½“å‰é€‰ä¸­å…¬å¸æ˜¾ç¤º
                const statusElements = document.querySelectorAll('.current-company-status');
                
                if (companyId) {
                        
                        statusElements.forEach(element => {
                            element.textContent = `å½“å‰å…¬å¸: ${companyName}`;
                            element.className = 'current-company-status text-success';
                        });
                    } catch (error) {
                        // å¦‚æœè·å–å¤±è´¥ï¼Œæ˜¾ç¤ºID
                        statusElements.forEach(element => {
                            element.textContent = `å½“å‰å…¬å¸: ${companyId}`;
                            element.className = 'current-company-status text-warning';
                        });
                    }
                } else {
                    statusElements.forEach(element => {
                        element.textContent = 'è¯·é€‰æ‹©å…¬å¸';
                        element.className = 'current-company-status text-warning';
                    });
                }
                
                // æ§åˆ¶åŠŸèƒ½æŒ‰é’®çŠ¶æ€
                const needCompanyButtons = document.querySelectorAll('.requires-company');
                needCompanyButtons.forEach(btn => {
                    btn.disabled = !companyId;
                });
            },
            
            // è·å–å½“å‰é€‰ä¸­çš„å…¬å¸ä¿¡æ¯
            async getCurrentCompanyInfo() {
                const companyId = StateManager.getCompanyId();
                if (!companyId) {
                    throw new Error('è¯·å…ˆé€‰æ‹©å…¬å¸');
                }
                
                try {
                    const response = await apiRequest(`/api/companies/${companyId}`, 'GET');
                    if (!response.success) {
                        throw new Error(response.error || 'è·å–å…¬å¸ä¿¡æ¯å¤±è´¥');
                    }
                    return response.data.company; // æ­£ç¡®è§£æAPIå“åº”æ ¼å¼
                } catch (error) {
                    console.error('[GlobalCompanyManager] è·å–å…¬å¸ä¿¡æ¯å¤±è´¥:', error);
                    throw error;
                }
            },
            
            // æ˜¾ç¤ºå½“å‰é€‰ä¸­çš„å…¬å¸ä¿¡æ¯
            async displaySelectedCompany() {
                try {
                    const companyId = StateManager.getCompanyId();
                    console.log('[GlobalCompanyManager] displaySelectedCompany è¢«è°ƒç”¨ï¼ŒcompanyId:', companyId);
                    
                    if (!companyId) {
                        console.log('[GlobalCompanyManager] æ— é€‰ä¸­å…¬å¸ï¼Œæ¸…ç©ºæ˜¾ç¤º');
                        this.clearCompanyDisplay();
                        return;
                    }
                    
                    const companyInfo = await this.getCurrentCompanyInfo();
                    console.log('[GlobalCompanyManager] è·å–åˆ°å…¬å¸ä¿¡æ¯:', companyInfo);
                    
                    if (companyInfo && companyInfo.companyName) {
                        console.log('[GlobalCompanyManager] æ˜¾ç¤ºé€‰ä¸­å…¬å¸:', companyInfo.companyName);
                        
                        // æ›´æ–°å•†åŠ¡åº”ç­”é¡µé¢ä¸­çš„å…¬å¸æ˜¾ç¤º
                        const businessCompanyName = document.getElementById('selectedCompanyName');
                        console.log('[GlobalCompanyManager] selectedCompanyName å…ƒç´ :', businessCompanyName);
                        
                        if (businessCompanyName) {
                            businessCompanyName.textContent = companyInfo.companyName;
                            businessCompanyName.className = 'text-success fw-bold';
                            console.log('[GlobalCompanyManager] å·²æ›´æ–° selectedCompanyName æ˜¾ç¤º');
                        } else {
                            console.warn('[GlobalCompanyManager] selectedCompanyName å…ƒç´ æœªæ‰¾åˆ°');
                        }
                        
                        // è§¦å‘ä¿¡æ¯åŠ è½½ï¼ˆç»Ÿä¸€å¤„ç†ï¼‰
                        this.loadSelectedCompanyData(companyId, companyInfo);
                    } else {
                        console.warn('[GlobalCompanyManager] å…¬å¸ä¿¡æ¯ä¸ºç©ºæˆ–æ— å…¬å¸åç§°');
                        this.clearCompanyDisplay();
                    }
                } catch (error) {
                    console.error('[GlobalCompanyManager] æ˜¾ç¤ºé€‰ä¸­å…¬å¸å¤±è´¥:', error);
                    this.clearCompanyDisplay();
                }
            },
            
            // æ¸…ç©ºå…¬å¸æ˜¾ç¤º
            clearCompanyDisplay() {
                const businessCompanyName = document.getElementById('selectedCompanyName');
                if (businessCompanyName) {
                    businessCompanyName.textContent = 'è¯·é€‰æ‹©å…¬å¸';
                    businessCompanyName.className = 'text-muted';
                }
            },
            
            // åŠ è½½é€‰ä¸­å…¬å¸çš„å®Œæ•´æ•°æ®
            async loadSelectedCompanyData(companyId, companyInfo) {
                try {
                    console.log('[GlobalCompanyManager] åŠ è½½å…¬å¸å®Œæ•´æ•°æ®:', companyId);
                    
                    // æ£€æŸ¥å…¬å¸ç®¡ç†æ ‡ç­¾é¡µæ˜¯å¦å­˜åœ¨ä¸”æ¿€æ´»
                    console.log('[GlobalCompanyManager] å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                    return;
                }
                
                console.log('[GlobalCompanyManager] å¼€å§‹åˆå§‹åŒ–...');
                
                // ä»StateManageræ¢å¤çŠ¶æ€
                const savedCompanyId = StateManager.getCompanyId();
                if (savedCompanyId) {
                    console.log('[GlobalCompanyManager] æ¢å¤ä¿å­˜çš„å…¬å¸çŠ¶æ€:', savedCompanyId);
                    this.syncCompanySelectors(savedCompanyId);
                }
                
                // ç»‘å®šäº‹ä»¶
                this.bindCompanySelectors();
                
                // ç›‘å¬StateManagerçŠ¶æ€å˜åŒ–
                StateManager.onStateChangeByKey('companyId', (newValue) => {
                    this.updateCompanyStatusUI(newValue);
                });
        };
        
        // å®šä¹‰é¡µé¢å°±ç»ªå‡½æ•°
        function onPageReady(callback) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', callback);
            } else {
                callback();
            }
        }
        
        // è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥é¡µé¢å…ƒç´ çŠ¶æ€
        function debugPageElements() {
            const elements = {
                businessCompanySelect: document.getElementById('businessCompanySelect'),
            };
            
            console.log('[è°ƒè¯•] é¡µé¢å…ƒç´ æ£€æŸ¥:');
                if (element) {
                    console.log(`  ${name}: å­˜åœ¨, é€‰é¡¹æ•°é‡: ${element.options.length}`);
                    for (let i = 0; i < element.options.length; i++) {
                        console.log(`    é€‰é¡¹ ${i}: ${element.options[i].value} - ${element.options[i].text}`);
                    }
                } else {
                    console.log(`  ${name}: ä¸å­˜åœ¨`);
                }
            }
            
            // æ£€æŸ¥StateManagerçŠ¶æ€
            console.log('[è°ƒè¯•] StateManagerçŠ¶æ€:');
            console.log('  å½“å‰å…¬å¸ID:', StateManager.getCompanyId());
            console.log('  é¡µé¢ä¸Šä¸‹æ–‡:', StateManager.getPageContext());
        }
        
        // é¡µé¢åˆå§‹åŒ–
        onPageReady(function() {
            console.log('[é¡µé¢åˆå§‹åŒ–] å¼€å§‹åˆå§‹åŒ–å…¨å±€å…¬å¸ç®¡ç†å™¨å’ŒåŠ è½½å…¬å¸åˆ—è¡¨');
            
            // è°ƒè¯•é¡µé¢å…ƒç´ 
            setTimeout(debugPageElements, 100);
            
            // åˆå§‹åŒ–å…¨å±€å…¬å¸ç®¡ç†å™¨
            GlobalCompanyManager.init();
            
            // åŠ è½½å…¬å¸åˆ—è¡¨ - ç»Ÿä¸€çš„å…¬å¸åˆ—è¡¨åŠ è½½å‡½æ•°
            loadCompanyList().then((companies) => {
                console.log('[é¡µé¢åˆå§‹åŒ–] å…¬å¸åˆ—è¡¨åŠ è½½å®Œæˆï¼Œè¿”å›æ•°æ®:', companies);
                setTimeout(debugPageElements, 500);
                
                // å¦‚æœå•†åŠ¡åº”ç­”é€‰æ‹©å™¨ä»ç„¶ä¸ºç©ºï¼Œæ‰‹åŠ¨å¡«å……ä¸€æ¬¡
                setTimeout(() => {
                    const businessSelect = document.getElementById('businessCompanySelect');
                    if (businessSelect && businessSelect.options.length <= 1 && companies && companies.length > 0) {
                        console.log('[é¡µé¢åˆå§‹åŒ–] æ£€æµ‹åˆ°å•†åŠ¡åº”ç­”é€‰æ‹©å™¨ä¸ºç©ºï¼Œæ‰‹åŠ¨å¡«å……');
                        updateAllCompanySelectors(companies);
                }, 1000);
            }).catch(error => {
                console.error('[é¡µé¢åˆå§‹åŒ–] åŠ è½½å…¬å¸åˆ—è¡¨å¤±è´¥:', error);
            });
            
            // è‡ªåŠ¨åŠ è½½ç°æœ‰çš„æŠ•æ ‡ä¿¡æ¯é…ç½®
            loadExistingTenderConfig();

            console.log('[é¡µé¢åˆå§‹åŒ–] åˆå§‹åŒ–å®Œæˆ');
        });


        // åŠ è½½ç°æœ‰çš„æŠ•æ ‡ä¿¡æ¯é…ç½®
        function loadExistingTenderConfig() {
            fetch('/api/tender-config')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.config) {
                        console.log('[è‡ªåŠ¨åŠ è½½] å‘ç°ç°æœ‰æŠ•æ ‡ä¿¡æ¯é…ç½®ï¼Œè‡ªåŠ¨æ˜¾ç¤º');

                        // æ˜¾ç¤ºé¡¹ç›®åŸºæœ¬ä¿¡æ¯
                        if (data.config.project_info) {
                            displayProjectInfo(data.config.project_info);
                        }

                        // æ˜¾ç¤ºèµ„è´¨è¦æ±‚
                        if (data.config.qualification_requirements) {
                            displayQualificationRequirements(data.config.qualification_requirements);
                        }

                        // æ˜¾ç¤ºæŠ€æœ¯è¯„åˆ†ï¼ˆå¦‚æœæœ‰ï¼‰
                        if (data.config.technical_scoring) {
                            displayTechnicalScoring(data.config.technical_scoring);
                        }
                    }
                })
                .catch(error => {
                    console.log('[è‡ªåŠ¨åŠ è½½] æ²¡æœ‰å‘ç°ç°æœ‰æŠ•æ ‡ä¿¡æ¯é…ç½®æˆ–åŠ è½½å¤±è´¥:', error);
                });
        }
        
        // é˜²æ­¢é‡å¤åŠ è½½çš„æ ‡å¿—
        let isLoadingCompanyList = false;
        let companyListCache = null;
        
        // åŠ è½½å…¬å¸åˆ—è¡¨
        async function loadCompanyList() {
            // é˜²æ­¢é‡å¤è°ƒç”¨
            if (isLoadingCompanyList) {
                console.log('[loadCompanyList] æ­£åœ¨åŠ è½½ä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
                return companyListCache?.companies || [];
            }
            
            // å¦‚æœæœ‰ç¼“å­˜ä¸”æ—¶é—´ä¸è¶…è¿‡5åˆ†é’Ÿï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜
            if (companyListCache && companyListCache.timestamp && 
                (Date.now() - companyListCache.timestamp) < 300000) {
                console.log('[loadCompanyList] ä½¿ç”¨ç¼“å­˜çš„å…¬å¸åˆ—è¡¨');
                const cachedCompanies = companyListCache.companies || [];
                updateAllCompanySelectors(cachedCompanies);
                return cachedCompanies;
            }
            
            isLoadingCompanyList = true;
            
            try {
                console.log('[loadCompanyList] å¼€å§‹ä»APIåŠ è½½å…¬å¸åˆ—è¡¨');
                const apiResponse = await apiRequest('/api/companies', 'GET');
                console.log('[loadCompanyList] APIå“åº”ç»“æ„:', apiResponse);
                
                // apiRequestè¿”å›æ ¼å¼ï¼š{success: true, data: {...}} æˆ– {success: false, error: '...'}
                if (!apiResponse.success) {
                    throw new Error(apiResponse.error || 'APIè°ƒç”¨å¤±è´¥');
                }
                
                const responseData = apiResponse.data;
                console.log('[loadCompanyList] æå–çš„å“åº”æ•°æ®:', responseData);
                
                // å¤„ç†åç«¯APIè¿”å›çš„ {success: true, data: []} æ ¼å¼
                let companies = [];
                if (responseData && Array.isArray(responseData)) {
                    // ç›´æ¥æ˜¯æ•°ç»„æ ¼å¼
                    companies = responseData;
                } else if (responseData && responseData.companies && Array.isArray(responseData.companies)) {
                    // {companies: [...]} æ ¼å¼
                    companies = responseData.companies;
                } else if (responseData && typeof responseData === 'object') {
                    console.warn('[loadCompanyList] å“åº”æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œå°è¯•æå–dataæˆ–companieså­—æ®µ:', responseData);
                    // ä¼˜å…ˆå°è¯•dataå­—æ®µï¼Œå†å°è¯•companieså­—æ®µ
                    companies = responseData.data || responseData.companies || [];
                } else {
                    console.error('[loadCompanyList] æ— æ³•è§£æçš„å“åº”æ•°æ®æ ¼å¼:', responseData);
                    companies = [];
                }
                
                console.log('[loadCompanyList] æœ€ç»ˆè§£æçš„å…¬å¸åˆ—è¡¨:', companies);
                
                // ç¡®ä¿companiesæ˜¯æ•°ç»„
                if (!Array.isArray(companies)) {
                    console.error('[loadCompanyList] å…¬å¸æ•°æ®ä¸æ˜¯æ•°ç»„æ ¼å¼:', typeof companies, companies);
                    companies = [];
                }
                
                // æ›´æ–°ç¼“å­˜
                companyListCache = {
                    companies: companies,
                    timestamp: Date.now()
                };
                
                // æ›´æ–°æ‰€æœ‰é€‰æ‹©å™¨
                updateAllCompanySelectors(companies);
                
                return companies;
                
            } catch (error) {
                console.error('[loadCompanyList] åŠ è½½å…¬å¸åˆ—è¡¨å¤±è´¥:', error);
                throw error;
            } finally {
                isLoadingCompanyList = false;
            }
        }
        
        // æ›´æ–°æ‰€æœ‰å…¬å¸é€‰æ‹©å™¨çš„ç»Ÿä¸€å‡½æ•°
        function updateAllCompanySelectors(companies) {
            // å¼ºåŒ–æ•°æ®éªŒè¯
            if (!companies) {
                console.warn('[updateAllCompanySelectors] companieså‚æ•°ä¸ºç©ºï¼Œä½¿ç”¨ç©ºæ•°ç»„');
                companies = [];
            }
            
            if (!Array.isArray(companies)) {
                console.error('[updateAllCompanySelectors] companieså‚æ•°å¿…é¡»æ˜¯æ•°ç»„ï¼Œæ”¶åˆ°:', typeof companies, companies);
                // å°è¯•è½¬æ¢æˆ–ä½¿ç”¨ç©ºæ•°ç»„
                if (companies && typeof companies === 'object' && companies.companies) {
                    companies = companies.companies;
                } else {
                    companies = [];
                }
            }
            
            console.log(`[updateAllCompanySelectors] æ›´æ–°æ‰€æœ‰å…¬å¸é€‰æ‹©å™¨ï¼Œå…± ${companies.length} å®¶å…¬å¸`, companies);
            
            // æ›´æ–°å•†åŠ¡åº”ç­”é€‰æ‹©å™¨
            const businessSelect = document.getElementById('businessCompanySelect');
            if (businessSelect) {
                businessSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬å¸...</option>';
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.company_id || company.id;
                    option.textContent = company.company_name || company.companyName;
                    businessSelect.appendChild(option);
                });
                console.log('[updateAllCompanySelectors] businessCompanySelectå·²æ›´æ–°');
            } else {
                console.log('[updateAllCompanySelectors] businessCompanySelectå…ƒç´ ä¸å­˜åœ¨');
            }
            
            } else {
                // æ¢å¤é€‰ä¸­çŠ¶æ€
                const savedCompanyId = StateManager.getCompanyId();
                if (savedCompanyId) {
                    console.log(`[updateAllCompanySelectors] æ¢å¤ä¿å­˜çš„å…¬å¸é€‰æ‹©: ${savedCompanyId}`);
                    if (typeof GlobalCompanyManager !== 'undefined') {
                        GlobalCompanyManager.syncCompanySelectors(savedCompanyId);
                    }
                }
            }
        }

        // ===================
        // AIæ¨¡å‹ç®¡ç†åŠŸèƒ½
        // ===================

        // æ¨¡å‹ç®¡ç†å¯¹è±¡
        const ModelManager = {
            currentModels: [],
            currentModel: 'unicom-yuanjing',

                        console.log(`åŠ è½½äº† ${data.count} ä¸ªAIæ¨¡å‹`);
                    } else {
                        console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', data.error);
                        showNotification('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
                    showNotification('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥', 'error');
                }
            },

            // æ›´æ–°æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
            updateModelSelect() {
                const aiModelSelect = document.getElementById('aiModel');
                if (!aiModelSelect) return;

                // ä¿å­˜å½“å‰é€‰ä¸­çš„æ¨¡å‹
                const currentValue = aiModelSelect.value;

                // æ¸…ç©ºå¹¶é‡æ–°å¡«å……é€‰é¡¹
                aiModelSelect.innerHTML = '';

                this.currentModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.display_name || model.name;

                    // æ·»åŠ çŠ¶æ€ä¿¡æ¯åˆ°é€‰é¡¹æ–‡æœ¬
                    if (model.status === 'no_api_key') {
                        option.textContent += ' (æœªé…ç½®)';
                        option.disabled = true;
                    } else if (model.status === 'available') {
                        option.textContent += ' âœ“';
                    }

                    aiModelSelect.appendChild(option);
                });

                // æ¢å¤ä¹‹å‰é€‰ä¸­çš„æ¨¡å‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„
                if (currentValue && Array.from(aiModelSelect.options).some(opt => opt.value === currentValue)) {
                    aiModelSelect.value = currentValue;
                } else {
                    // é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨çš„æ¨¡å‹
                    const availableOption = Array.from(aiModelSelect.options).find(opt => !opt.disabled);
                    if (availableOption) {
                        aiModelSelect.value = availableOption.value;
                    }
                }

                this.updateModelStatus();
            },

            // æ›´æ–°æ¨¡å‹çŠ¶æ€æ˜¾ç¤º
            updateModelStatus() {
                const aiModelSelect = document.getElementById('aiModel');
                const modelStatus = document.getElementById('modelStatus');
                const statusIcon = document.getElementById('modelStatusIcon');
                const statusText = document.getElementById('modelStatusText');

                if (!aiModelSelect || !modelStatus) return;

                const selectedModel = this.currentModels.find(m => m.name === aiModelSelect.value);

                if (selectedModel) {
                    modelStatus.style.display = 'block';

                    if (selectedModel.status === 'available') {
                        statusIcon.innerHTML = '<i class="bi bi-check-circle text-success"></i>';
                        statusText.textContent = `${selectedModel.provider} - ${selectedModel.status_message}`;
                        statusText.className = 'text-success';
                    } else if (selectedModel.status === 'no_api_key') {
                        statusIcon.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i>';
                        statusText.textContent = `${selectedModel.provider} - ${selectedModel.status_message}`;
                        statusText.className = 'text-warning';
                    } else {
                        statusIcon.innerHTML = '<i class="bi bi-question-circle text-muted"></i>';
                        statusText.textContent = `${selectedModel.provider} - çŠ¶æ€æœªçŸ¥`;
                        statusText.className = 'text-muted';
                    }

                    // æ˜¾ç¤ºæ¨¡å‹æè¿°ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (selectedModel.description) {
                        statusText.textContent += ` - ${selectedModel.description}`;
                    }
                } else {
                    modelStatus.style.display = 'none';
                }
            },

            // éªŒè¯æ¨¡å‹é…ç½®
            async validateModel(modelName) {
                try {
                    showNotification('æ­£åœ¨éªŒè¯æ¨¡å‹é…ç½®...', 'info');

                    const response = await fetch(`/api/models/${modelName}/validate`, {
                        method: 'POST'
                    });
                    const data = await response.json();

                    if (data.success && data.validation.valid) {
                        showNotification(`æ¨¡å‹ ${modelName} é…ç½®éªŒè¯æˆåŠŸ`, 'success');
                        return true;
                    } else {
                        const error = data.validation?.error || data.error || 'éªŒè¯å¤±è´¥';
                        showNotification(`æ¨¡å‹ ${modelName} é…ç½®éªŒè¯å¤±è´¥: ${error}`, 'error');
                        return false;
                    }
                } catch (error) {
                    console.error('éªŒè¯æ¨¡å‹é…ç½®å¤±è´¥:', error);
                    showNotification('éªŒè¯æ¨¡å‹é…ç½®å¤±è´¥', 'error');
                    return false;
                }
            }
        };

        // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
        function refreshModels() {
            ModelManager.loadModels();
        }

        // æ¨¡å‹é€‰æ‹©å˜åŒ–äº‹ä»¶
        function onModelChange() {
            ModelManager.currentModel = document.getElementById('aiModel').value;
            ModelManager.updateModelStatus();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æ¨¡å‹ç®¡ç†
        document.addEventListener('DOMContentLoaded', function() {
            ModelManager.init();

            // ä¾§è¾¹æ åˆ‡æ¢åŠŸèƒ½
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                const sidebar = document.getElementById('sidebar-wrapper');

                if (window.innerWidth <= 768) {
                    sidebar.classList.toggle('show');
                } else {
                    // æ¡Œé¢ç«¯ä¾§è¾¹æ æ”¶ç¼©
                    if (sidebar.style.marginLeft === '-280px') {
                        sidebar.style.marginLeft = '0';
                    } else {
                        sidebar.style.marginLeft = '-280px';
                    }
                }
            });

            // ç§»åŠ¨ç«¯ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­ä¾§è¾¹æ 
            document.addEventListener('click', function(e) {
                const sidebar = document.getElementById('sidebar-wrapper');
                const toggle = document.getElementById('sidebarToggle');

                if (window.innerWidth <= 768 &&
                    sidebar.classList.contains('show') &&
                    !sidebar.contains(e.target) &&
                    !toggle.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            });

            // åˆå§‹åŒ–ç»Ÿè®¡å›¾è¡¨
            initCharts();

            // æ·»åŠ å¡ç‰‡æ‚¬åœåŠ¨ç”»
            document.querySelectorAll('.stat-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px) scale(1.02)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0) scale(1)';
                });
            });

            // æ·»åŠ æŒ‰é’®ç‚¹å‡»åŠ¨ç”»
            document.querySelectorAll('.btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 150);
                });
            });
        });

        // åˆå§‹åŒ–å›¾è¡¨å‡½æ•°
        function initCharts() {
            // ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨
            const usageCtx = document.getElementById('usageChart');
            if (usageCtx) {
                new Chart(usageCtx, {
                    type: 'line',
                    data: {
                        labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'],
                        datasets: [{
                            label: 'æ¨¡å‹è°ƒç”¨æ¬¡æ•°',
                            data: [65, 59, 80, 81, 56, 95],
                            borderColor: '#4fc3f7',
                            backgroundColor: 'rgba(79, 195, 247, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            }

            // ç±»å‹åˆ†å¸ƒå›¾è¡¨
            const typeCtx = document.getElementById('typeChart');
            if (typeCtx) {
                new Chart(typeCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['æ‹›æ ‡ä¿¡æ¯æå–', 'å•†åŠ¡åº”ç­”', 'æŠ€æœ¯æ–¹æ¡ˆ', 'ç‚¹å¯¹ç‚¹åº”ç­”'],
                        datasets: [{
                            data: [40, 25, 20, 15],
                            backgroundColor: [
                                '#4fc3f7',
                                '#ff6b35',
                                '#667eea',
                                '#4caf50'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            }
        }

        // åŠ è½½çŠ¶æ€ç®¡ç†
        function showLoading(element, text = 'åŠ è½½ä¸­...') {
            const loadingHTML = `
                <div class="d-flex justify-content-center align-items-center p-4">
                    <div class="spinner-border text-primary me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <span class="text-muted">${text}</span>
                </div>
            `;
            element.innerHTML = loadingHTML;
        }

        function hideLoading(element, content) {
            element.innerHTML = content;
        }

        // é€šçŸ¥ç³»ç»Ÿ
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.remove();
                }
            }, duration);
        }

        // æ•°å­—åŠ¨ç”»æ•ˆæœ
        function animateValue(element, start, end, duration) {
            const range = end - start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                if (current === end) {
                    clearInterval(timer);
                }
            }, stepTime);
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æ•°å­—åŠ¨ç”»
        window.addEventListener('load', function() {
            document.querySelectorAll('.stat-number').forEach(el => {
                const finalValue = parseInt(el.textContent) || 0;
                if (finalValue > 0) {
                    el.textContent = '0';
                    setTimeout(() => {
                        animateValue(el, 0, finalValue, 1000);
                    }, 500);
                }
            });
        });

        // åˆ‡æ¢é€‰é¡¹å¡å‡½æ•°
        function switchToTab(tabId) {
            // ç§»é™¤æ‰€æœ‰æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.list-group-item-action').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('show', 'active');
            });

            // æ¿€æ´»æŒ‡å®šçš„å¯¼èˆªé¡¹å’Œé€‰é¡¹å¡
            const navItem = document.querySelector(`[data-bs-target="#${tabId}"]`);
            const tabPane = document.querySelector(`#${tabId}`);

            if (navItem && tabPane) {
                navItem.classList.add('active');
                tabPane.classList.add('show', 'active');
            }
        }
    </script>

            </div>
        </div>
    </div>

</body>
</html>