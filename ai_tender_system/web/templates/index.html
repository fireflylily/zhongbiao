<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ ‡ä¹¦ç‚¹å¯¹ç‚¹åº”ç­”ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0056b3;
            background: #e9ecef;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        .feature-card {
            transition: transform 0.2s ease;
            height: 100%;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .progress {
            display: none;
        }
        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .api-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .api-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .footer {
            margin-top: 60px;
            padding: 20px 0;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-5">
                    <h1 class="display-4 text-primary">
                        <i class="bi bi-robot"></i> AIæ ‡ä¹¦æ™ºèƒ½ç”Ÿæˆç³»ç»Ÿ
                    </h1>
                    <p class="lead text-muted">æ™ºèƒ½è¯†åˆ«é‡‡è´­éœ€æ±‚ï¼Œè‡ªåŠ¨ç”Ÿæˆä¸“ä¸šåº”ç­”å’ŒæŠ€æœ¯æ–¹æ¡ˆ</p>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½é€‰é¡¹å¡ -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-pills nav-justified mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="tender-info-tab" data-bs-toggle="pill" 
                                data-bs-target="#tender-info" type="button" role="tab">
                            <i class="bi bi-search"></i> è¯»å–ä¿¡æ¯
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="business-response-tab" data-bs-toggle="pill" 
                                data-bs-target="#business-response" type="button" role="tab">
                            <i class="bi bi-briefcase"></i> å•†åŠ¡åº”ç­”
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="point-to-point-tab" data-bs-toggle="pill" 
                                data-bs-target="#point-to-point" type="button" role="tab">
                            <i class="bi bi-chat-dots"></i> ç‚¹å¯¹ç‚¹åº”ç­”
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tech-proposal-tab" data-bs-toggle="pill" 
                                data-bs-target="#tech-proposal" type="button" role="tab">
                            <i class="bi bi-file-earmark-code"></i> æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆ
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="mainTabContent">
            <!-- è¯»å–ä¿¡æ¯é€‰é¡¹å¡ -->
            <div class="tab-pane fade show active" id="tender-info" role="tabpanel">

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-cloud-upload"></i> æ‹›æ ‡æ–‡æ¡£ä¸Šä¼ 
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="tenderUploadArea">
                                <i class="bi bi-cloud-upload-fill text-primary" style="font-size: 3rem;"></i>
                                <h5 class="mt-3">æ‹–æ”¾æ‹›æ ‡æ–‡æ¡£åˆ°æ­¤å¤„</h5>
                                <p class="text-muted mb-3">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                                <p class="text-muted small">
                                    æ”¯æŒæ ¼å¼ï¼šWordæ–‡æ¡£ (.docx, .doc)ã€æ–‡æœ¬æ–‡ä»¶ (.txt)ã€PDFæ–‡ä»¶ (.pdf)
                                </p>
                                <input type="file" class="d-none" id="tenderFileInput" 
                                       accept=".docx,.doc,.txt,.pdf">
                            </div>
                            
                            <!-- æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º -->
                            <div class="mt-3" id="tenderFileInfo" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    å·²é€‰æ‹©æ–‡ä»¶ï¼š<strong id="tenderFileName"></strong>
                                    <span class="text-muted" id="tenderFileSize"></span>
                                </div>
                            </div>

                            <!-- æå–æŒ‰é’® -->
                            <div class="text-center mt-4">
                                <button class="btn btn-primary btn-lg" type="button" id="extractInfoBtn" disabled>
                                    <i class="bi bi-play-circle"></i> å¼€å§‹æå–ä¿¡æ¯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress mb-2" id="tenderProgressBar" style="display: none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <div class="text-center mb-4" id="stepMessage" style="display: none; color: #007bff;">
                æ­£åœ¨æå–æ‹›æ ‡ä¿¡æ¯...
            </div>

            <!-- æå–ç»“æœæ˜¾ç¤º -->
            <div class="row" id="tenderResultArea" style="display: none;">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-check-circle"></i> æ‹›æ ‡ä¿¡æ¯æå–å®Œæˆ
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row" id="tenderInfoDisplay">
                                <!-- æå–ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-outline-success me-2" id="tenderRetryBtn">
                                    <i class="bi bi-arrow-clockwise"></i> é‡æ–°æå–
                                </button>
                                <button class="btn btn-outline-secondary" id="tenderResetBtn">
                                    <i class="bi bi-x-circle"></i> é‡ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯æ˜¾ç¤º -->
            <div class="row" id="tenderErrorArea" style="display: none;">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> æå–å¤±è´¥
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger mb-3">
                                <p id="tenderErrorMessage"></p>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-outline-danger me-2" id="tenderRetryBtn2">
                                    <i class="bi bi-arrow-clockwise"></i> é‡è¯•
                                </button>
                                <button class="btn btn-outline-secondary" id="tenderResetBtn2">
                                    <i class="bi bi-x-circle"></i> é‡ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- APIå¯†é’¥é…ç½® -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-key"></i> APIå¯†é’¥é…ç½®
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8 mb-2">
                                    <input type="password" class="form-control" id="tenderApiKey" 
                                           placeholder="è¯·è¾“å…¥å§‹çš‡APIå¯†é’¥ (sk-...)" 
                                           value="sk-4sYV1WXMcdGcLz9XEKWyntV58pSnhb4GXM6aMBfzWUic3pLfnwob">
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button class="btn btn-outline-primary" type="button" id="testTenderApiBtn">
                                        <i class="bi bi-wifi"></i> æµ‹è¯•è¿æ¥
                                    </button>
                                </div>
                            </div>
                            <div id="tenderApiStatus" class="api-status"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-search text-info" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">æ™ºèƒ½æå–</h5>
                            <p class="card-text text-muted">AIè‡ªåŠ¨è¯†åˆ«æ‹›æ ‡æ–‡ä»¶ä¸­çš„å…³é”®ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-list-check text-success" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">å®Œæ•´å­—æ®µ</h5>
                            <p class="card-text text-muted">æå–æ‹›æ ‡äººã€ä»£ç†ã€æ—¶é—´ç­‰8ä¸ªå…³é”®å­—æ®µ</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-gear text-warning" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">é…ç½®ä¿å­˜</h5>
                            <p class="card-text text-muted">è‡ªåŠ¨ä¿å­˜æå–ç»“æœåˆ°é…ç½®æ–‡ä»¶</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½è¯´æ˜ -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i> åŠŸèƒ½è¯´æ˜
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>ğŸ“„ æå–å­—æ®µ</h6>
                                    <ul>
                                        <li>æ‹›æ ‡äººï¼ˆé‡‡è´­äºº/ç”²æ–¹ï¼‰</li>
                                        <li>æ‹›æ ‡ä»£ç†ï¼ˆä»£ç†æœºæ„ï¼‰</li>
                                        <li>æŠ•æ ‡æ–¹å¼ï¼ˆå…¬å¼€æ‹›æ ‡ç­‰ï¼‰</li>
                                        <li>æŠ•æ ‡åœ°ç‚¹ï¼ˆé€’äº¤åœ°ç‚¹ï¼‰</li>
                                        <li>æŠ•æ ‡æ—¶é—´ï¼ˆæˆªæ­¢æ—¶é—´ï¼‰</li>
                                        <li>ä¸­æ ‡äººæ•°é‡ï¼ˆé¢„è®¡æ•°é‡ï¼‰</li>
                                        <li>é¡¹ç›®åç§°</li>
                                        <li>é¡¹ç›®ç¼–å·ï¼ˆæ‹›æ ‡ç¼–å·ï¼‰</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>ğŸ”§ æŠ€æœ¯ç‰¹ç‚¹</h6>
                                    <ul>
                                        <li>AIæ™ºèƒ½è¯†åˆ«å…³é”®ä¿¡æ¯</li>
                                        <li>æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼</li>
                                        <li>æ­£åˆ™è¡¨è¾¾å¼å¤‡ç”¨æ–¹æ¡ˆ</li>
                                        <li>è‡ªåŠ¨ä¿å­˜åˆ°é…ç½®æ–‡ä»¶</li>
                                    </ul>
                                    
                                    <h6>âš ï¸ æ³¨æ„äº‹é¡¹</h6>
                                    <ul>
                                        <li>ç¡®ä¿æ–‡æ¡£å†…å®¹æ¸…æ™°å¯è¯»</li>
                                        <li>å»ºè®®ä½¿ç”¨æ ‡å‡†æ‹›æ ‡æ–‡ä»¶æ ¼å¼</li>
                                        <li>æå–ç»“æœä¼šè‡ªåŠ¨ä¿å­˜åˆ°é…ç½®æ–‡ä»¶</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ç»“æŸè¯»å–ä¿¡æ¯é€‰é¡¹å¡ -->


        <!-- å•†åŠ¡åº”ç­”é€‰é¡¹å¡ -->
        <div class="tab-pane fade" id="business-response" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-briefcase"></i> å•†åŠ¡åº”ç­”å¤„ç†</h5>
                            <small class="text-muted">ä¸Šä¼ å•†åŠ¡åº”ç­”æ¨¡æ¿ï¼ŒæŒ‰é€‰æ‹©çš„å…¬å¸ä¿¡æ¯å¡«å†™æŠ•æ ‡äººåç§°ã€é¡¹ç›®ä¿¡æ¯å¹¶æ’å…¥èµ„è´¨è¯æ˜å›¾ç‰‡</small>
                        </div>
                        <div class="card-body">
                            <form id="businessResponseForm" enctype="multipart/form-data">
                                <!-- æ¨¡æ¿æ–‡ä»¶ä¸Šä¼  -->
                                <div class="mb-3">
                                    <label for="businessTemplateFile" class="form-label">å•†åŠ¡åº”ç­”æ¨¡æ¿ *</label>
                                    <div class="upload-area" onclick="document.getElementById('businessTemplateFile').click()">
                                        <i class="bi bi-cloud-upload display-4 text-primary"></i>
                                        <h5>ç‚¹å‡»ä¸Šä¼ å•†åŠ¡åº”ç­”æ¨¡æ¿</h5>
                                        <p class="text-muted">æ”¯æŒ .docx, .doc æ ¼å¼</p>
                                        <input type="file" id="businessTemplateFile" class="form-control" accept=".docx,.doc" style="display: none;">
                                    </div>
                                    <div class="mt-2" id="businessTemplateFileName"></div>
                                </div>

                                <!-- å…¬å¸é€‰æ‹© -->
                                <div class="mb-3">
                                    <label for="businessCompanySelect" class="form-label">é€‰æ‹©åº”ç­”å…¬å¸ *</label>
                                    <select class="form-select" id="businessCompanySelect">
                                        <option value="">è¯·é€‰æ‹©å…¬å¸...</option>
                                    </select>
                                </div>

                                <!-- é¡¹ç›®ä¿¡æ¯ -->
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="businessProjectName" class="form-label">é¡¹ç›®åç§°</label>
                                            <input type="text" class="form-control" id="businessProjectName" 
                                                   placeholder="è¾“å…¥é¡¹ç›®åç§°">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="businessTenderNo" class="form-label">æ‹›æ ‡ç¼–å·</label>
                                            <input type="text" class="form-control" id="businessTenderNo" 
                                                   placeholder="è¾“å…¥æ‹›æ ‡ç¼–å·">
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="businessDate" class="form-label">æ—¥æœŸ</label>
                                    <input type="text" class="form-control" id="businessDate" 
                                           placeholder="ä¾‹å¦‚ï¼š2025å¹´ 9æœˆ 3æ—¥">
                                </div>


                                <!-- å¤„ç†æŒ‰é’® -->
                                <button type="submit" class="btn btn-outline-success">
                                    <i class="bi bi-play-fill"></i> å¼€å§‹å¤„ç†
                                </button>
                            </form>

                            <!-- è¿›åº¦æ¡ -->
                            <div class="progress mt-3" id="businessProgress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>

                            <!-- ç»“æœæ˜¾ç¤º -->
                            <div class="alert alert-success mt-3" id="businessResult" style="display: none;">
                                <h6>å¤„ç†å®Œæˆï¼</h6>
                                <p id="businessResultMessage"></p>
                                <div class="d-flex gap-2">
                                    <a href="#" id="businessDownloadLink" class="btn btn-primary">
                                        <i class="bi bi-download"></i> ä¸‹è½½æ–‡ä»¶
                                    </a>
                                    <button type="button" class="btn btn-outline-primary" id="businessNextStepBtn">
                                        <i class="bi bi-arrow-right"></i> ä¸‹ä¸€æ­¥ï¼šç‚¹å¯¹ç‚¹åº”ç­”
                                    </button>
                                </div>
                            </div>

                            <!-- é”™è¯¯æç¤º -->
                            <div class="alert alert-danger mt-3" id="businessError" style="display: none;">
                                <h6>å¤„ç†å¤±è´¥</h6>
                                <p id="businessErrorMessage"></p>
                            </div>

                            <!-- å¤„ç†ç»Ÿè®¡ -->
                            <div class="mt-3" id="businessStats" style="display: none;">
                                <div class="card">
                                    <div class="card-header">
                                        <h6><i class="bi bi-bar-chart"></i> å¤„ç†ç»Ÿè®¡</h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="businessStatsContent"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å†å²æ–‡ä»¶ -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-files"></i> å†å²æ–‡ä»¶</h5>
                        </div>
                        <div class="card-body">
                            <div id="businessFilesList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ç»“æŸå•†åŠ¡åº”ç­”é€‰é¡¹å¡ -->

            <!-- ç‚¹å¯¹ç‚¹åº”ç­”é€‰é¡¹å¡ -->
            <div class="tab-pane fade" id="point-to-point" role="tabpanel">

        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-upload"></i> æ–‡æ¡£ä¸Šä¼ å¤„ç†</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="upload-area" id="uploadArea">
                                <i class="bi bi-cloud-upload text-primary" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">æ‹–æ‹½æ–‡æ¡£åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</h4>
                                <p class="text-muted">æ”¯æŒ .docx å’Œ .doc æ ¼å¼ï¼Œæœ€å¤§ 50MB</p>
                                <input type="file" class="d-none" id="fileInput" name="file" accept=".docx,.doc">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click();">
                                    <i class="bi bi-folder2-open"></i> é€‰æ‹©æ–‡ä»¶
                                </button>
                            </div>
                            
                            <div id="fileInfo" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <span id="fileName"></span>
                                    <span id="fileSize" class="text-muted ms-2"></span>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button type="submit" class="btn btn-success btn-lg" id="processBtn" disabled>
                                    <i class="bi bi-play-circle"></i> å¼€å§‹å¤„ç†
                                </button>
                            </div>
                        </form>
                        
                        <!-- è¿›åº¦æ¡ -->
                        <div class="progress mt-3" id="progressBar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <!-- ç»“æœåŒºåŸŸ -->
                        <div id="resultArea" class="mt-4" style="display: none;">
                            <div class="alert alert-success">
                                <h5><i class="bi bi-check-circle"></i> å¤„ç†å®Œæˆï¼</h5>
                                <p id="resultMessage"></p>
                                <div class="mt-3">
                                    <button id="downloadBtn" class="btn btn-primary me-2">
                                        <i class="bi bi-download"></i> ä¸‹è½½å¤„ç†åçš„æ–‡æ¡£
                                    </button>
                                    <button id="viewFilesBtn" class="btn btn-outline-info">
                                        <i class="bi bi-file-earmark-text"></i> æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é”™è¯¯åŒºåŸŸ -->
                        <div id="errorArea" class="mt-4" style="display: none;">
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-exclamation-triangle"></i> å¤„ç†å¤±è´¥</h5>
                                <p id="errorMessage"></p>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-primary" id="retryBtn">
                                        <i class="bi bi-arrow-clockwise"></i> é‡è¯•
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                                        <i class="bi bi-arrow-counterclockwise"></i> é‡æ–°é€‰æ‹©æ–‡ä»¶
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- APIé…ç½®åŒºåŸŸ -->
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-gear"></i> APIé…ç½®</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="apiKey" class="form-label">å§‹çš‡APIå¯†é’¥</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="apiKey" 
                                           placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxx" 
                                           value="sk-4sYV1WXMcdGcLz9XEKWyntV58pSnhb4GXM6aMBfzWUic3pLfnwob">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    APIå¯†é’¥ç”¨äºç”Ÿæˆä¸“ä¸šçš„æŠ€æœ¯åº”ç­”ï¼Œç•™ç©ºå°†ä½¿ç”¨é»˜è®¤æ¨¡æ¿
                                </small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">å¯†é’¥ç®¡ç†</label>
                                <div class="btn-group d-flex">
                                    <button type="button" class="btn btn-outline-success btn-sm" id="saveApiBtn">
                                        <i class="bi bi-save"></i> ä¿å­˜
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="loadApiBtn">
                                        <i class="bi bi-upload"></i> åŠ è½½
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="manageApiBtn">
                                        <i class="bi bi-gear"></i> ç®¡ç†
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-primary flex-fill" id="testApiBtn">
                                    <i class="bi bi-wifi"></i> æµ‹è¯•è¿æ¥
                                </button>
                            </div>
                        </div>
                        <div id="apiStatus" class="api-status"></div>
                    </div>
                </div>
            </div>
        </div>

                <!-- åŠŸèƒ½ç‰¹ç‚¹ -->
        <div class="row mb-5">
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-lightning-charge text-warning" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">æ™ºèƒ½è¯†åˆ«</h5>
                        <p class="card-text text-muted">è‡ªåŠ¨è¯†åˆ«æ–‡æ¡£ä¸­çš„éœ€æ±‚æ¡ç›®ï¼Œå‡å°‘é—æ¼</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-cpu text-primary" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">AIç”Ÿæˆ</h5>
                        <p class="card-text text-muted">ä½¿ç”¨å…ˆè¿›AIæ¨¡å‹ç”Ÿæˆä¸“ä¸šæŠ€æœ¯åº”ç­”</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-palette text-success" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">æ ¼å¼ç¾åŒ–</h5>
                        <p class="card-text text-muted">è‡ªåŠ¨è®¾ç½®å­—ä½“ã€é¢œè‰²ã€åº•çº¹å’Œè¡Œè·</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-question-circle"></i> ä½¿ç”¨è¯´æ˜</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>ğŸ“‹ æ”¯æŒçš„æ–‡æ¡£æ ¼å¼</h6>
                                <ul>
                                    <li>Microsoft Word æ–‡æ¡£ (.docx)</li>
                                    <li>Microsoft Word 97-2003 æ–‡æ¡£ (.doc)</li>
                                    <li>æ–‡æ¡£å¤§å°é™åˆ¶ï¼š50MB</li>
                                </ul>
                                
                                <h6>ğŸ¯ å¤„ç†åŠŸèƒ½</h6>
                                <ul>
                                    <li>è‡ªåŠ¨è¯†åˆ«é‡‡è´­éœ€æ±‚æ¡ç›®</li>
                                    <li>ç”Ÿæˆ"åº”ç­”ï¼šæ»¡è¶³ã€‚"æ ¼å¼çš„ä¸“ä¸šåº”ç­”</li>
                                    <li>ä¿æŒåŸæ–‡æ¡£æ ¼å¼å’Œå­—ä½“</li>
                                    <li>åº”ç­”å†…å®¹ï¼šé»‘è‰²å­—ä½“ï¼Œç°è‰²åº•çº¹ï¼Œ1.5å€è¡Œè·</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>ğŸ”§ APIé…ç½®</h6>
                                <ul>
                                    <li>é…ç½®å§‹çš‡APIå¯†é’¥ä»¥è·å¾—æ›´ä¸“ä¸šçš„AIåº”ç­”</li>
                                    <li>ä¸é…ç½®APIå¯†é’¥å°†ä½¿ç”¨å†…ç½®åº”ç­”æ¨¡æ¿</li>
                                    <li>å»ºè®®ä½¿ç”¨GPT-4o-miniæ¨¡å‹è·å¾—æœ€ä½³æ•ˆæœ</li>
                                </ul>
                                
                                <h6>âš ï¸ æ³¨æ„äº‹é¡¹</h6>
                                <ul>
                                    <li>å¤„ç†æ—¶é—´è§†æ–‡æ¡£å¤§å°å’Œå¤æ‚åº¦è€Œå®š</li>
                                    <li>è¯·ç¡®ä¿ç½‘ç»œè¿æ¥ç¨³å®š</li>
                                    <li>å»ºè®®å¤‡ä»½åŸå§‹æ–‡æ¡£</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- ç»“æŸç‚¹å¯¹ç‚¹åº”ç­”é€‰é¡¹å¡ -->

        <!-- æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆé€‰é¡¹å¡ -->
        <div class="tab-pane fade" id="tech-proposal" role="tabpanel">

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-upload"></i> æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆ</h5>
                        </div>
                        <div class="card-body">
                            <form id="techProposalForm" enctype="multipart/form-data">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="upload-area tech-upload" data-type="tender">
                                            <i class="bi bi-file-earmark-check text-primary" style="font-size: 2rem;"></i>
                                            <h5 class="mt-2">æ‹›æ ‡æ–‡ä»¶</h5>
                                            <p class="text-muted mb-3">ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶æˆ–éœ€æ±‚æ–‡æ¡£</p>
                                            <input type="file" class="d-none" id="techTenderFileInput" name="tender_file" accept=".docx,.doc,.pdf">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('techTenderFileInput').click();">
                                                <i class="bi bi-folder2-open"></i> é€‰æ‹©æ‹›æ ‡æ–‡ä»¶
                                            </button>
                                            <div id="techTenderFileInfo" class="mt-2" style="display: none;">
                                                <small class="text-success"><i class="bi bi-check-circle"></i> <span id="techTenderFileName"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="upload-area tech-upload" data-type="product">
                                            <i class="bi bi-file-earmark-code text-info" style="font-size: 2rem;"></i>
                                            <h5 class="mt-2">äº§å“æ–‡æ¡£</h5>
                                            <p class="text-muted mb-3">ä¸Šä¼ äº§å“åŠŸèƒ½è¯´æ˜æ–‡æ¡£</p>
                                            <input type="file" class="d-none" id="productFileInput" name="product_file" accept=".docx,.doc,.pdf">
                                            <button type="button" class="btn btn-info btn-sm" onclick="document.getElementById('productFileInput').click();">
                                                <i class="bi bi-folder2-open"></i> é€‰æ‹©äº§å“æ–‡æ¡£
                                            </button>
                                            <div id="productFileInfo" class="mt-2" style="display: none;">
                                                <small class="text-success"><i class="bi bi-check-circle"></i> <span id="productFileName"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="outputPrefix" class="form-label">è¾“å‡ºæ–‡ä»¶å‰ç¼€</label>
                                        <input type="text" class="form-control" id="outputPrefix" name="output_prefix" value="æŠ€æœ¯æ–¹æ¡ˆ" placeholder="è¾“å…¥æ–‡ä»¶åå‰ç¼€">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button type="submit" class="btn btn-success btn-lg flex-fill" id="generateProposalBtn" disabled>
                                            <i class="bi bi-play-circle"></i> ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆ
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- è¿›åº¦æ¡ -->
                            <div class="progress mt-3" id="techProgressBar" style="display: none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            
                            <!-- ç»“æœåŒºåŸŸ -->
                            <div id="techResultArea" class="mt-4" style="display: none;">
                                <div class="alert alert-success">
                                    <h5><i class="bi bi-check-circle"></i> æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆå®Œæˆï¼</h5>
                                    <p id="techResultMessage"></p>
                                    <div id="techDownloadArea" class="mt-3">
                                        <!-- ä¸‹è½½æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- é”™è¯¯åŒºåŸŸ -->
                            <div id="techErrorArea" class="mt-4" style="display: none;">
                                <div class="alert alert-danger">
                                    <h5><i class="bi bi-exclamation-triangle"></i> ç”Ÿæˆå¤±è´¥</h5>
                                    <p id="techErrorMessage"></p>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-primary" id="techRetryBtn">
                                            <i class="bi bi-arrow-clockwise"></i> é‡è¯•
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="techResetBtn">
                                            <i class="bi bi-arrow-counterclockwise"></i> é‡æ–°é€‰æ‹©æ–‡ä»¶
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯æ–¹æ¡ˆåŠŸèƒ½ç‰¹ç‚¹ -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-file-earmark-text text-info" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">æ™ºèƒ½è§£æ</h5>
                            <p class="card-text text-muted">è‡ªåŠ¨è§£ææ‹›æ ‡æ–‡ä»¶å’Œäº§å“æ–‡æ¡£ï¼Œæå–å…³é”®ä¿¡æ¯</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-gear-wide-connected text-warning" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">æ™ºèƒ½åŒ¹é…</h5>
                            <p class="card-text text-muted">ç²¾ç¡®åŒ¹é…äº§å“åŠŸèƒ½ä¸æ‹›æ ‡éœ€æ±‚</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-journal-text text-success" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">æ–¹æ¡ˆç”Ÿæˆ</h5>
                            <p class="card-text text-muted">è‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æŠ€æœ¯æ–¹æ¡ˆä½¿ç”¨è¯´æ˜ -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-question-circle"></i> æŠ€æœ¯æ–¹æ¡ˆç”Ÿæˆè¯´æ˜</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>ğŸ“‹ æ”¯æŒçš„æ–‡æ¡£æ ¼å¼</h6>
                                    <ul>
                                        <li>Wordæ–‡æ¡£ (.docx, .doc)</li>
                                        <li>PDFæ–‡æ¡£ (.pdf)</li>
                                        <li>æ–‡æ¡£å¤§å°é™åˆ¶ï¼š50MB</li>
                                    </ul>
                                    
                                    <h6>ğŸ¯ ç”ŸæˆåŠŸèƒ½</h6>
                                    <ul>
                                        <li>è‡ªåŠ¨è§£ææ‹›æ ‡éœ€æ±‚å’Œäº§å“åŠŸèƒ½</li>
                                        <li>æ™ºèƒ½åŒ¹é…éœ€æ±‚ä¸åŠŸèƒ½ç‰¹æ€§</li>
                                        <li>ç”Ÿæˆå®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆå¤§çº²</li>
                                        <li>è¾“å‡ºä¸“ä¸šçš„Wordæ ¼å¼æ–¹æ¡ˆæ–‡æ¡£</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>ğŸ“Š è¾“å‡ºæ–‡ä»¶</h6>
                                    <ul>
                                        <li>æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£ (.docx)</li>
                                        <li>æ–¹æ¡ˆå¤§çº² (.json)</li>
                                        <li>åŒ¹é…åº¦æŠ¥å‘Š (.json)</li>
                                        <li>å®Œæ•´æ•°æ® (.json)</li>
                                    </ul>
                                    
                                    <h6>âš ï¸ æ³¨æ„äº‹é¡¹</h6>
                                    <ul>
                                        <li>éœ€è¦ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶å’Œäº§å“æ–‡æ¡£</li>
                                        <li>ç”Ÿæˆæ—¶é—´è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…</li>
                                        <li>å»ºè®®ä½¿ç”¨æ ¼å¼è§„èŒƒçš„æ–‡æ¡£</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- ç»“æŸæŠ€æœ¯æ–¹æ¡ˆé€‰é¡¹å¡ -->


        </div>
        <!-- ç»“æŸé€‰é¡¹å¡å†…å®¹ -->

        <!-- é¡µè„š -->
        <div class="footer text-center">
            <p>&copy; 2025 æ™ºæ…§è¶³è¿¹AIæ ‡ä¹¦ç”Ÿæˆç³»ç»Ÿ | ä¸“ä¸š Â· é«˜æ•ˆ Â· æ™ºèƒ½</p>
            <p>
                <a href="/help.html" class="text-decoration-none">
                    <i class="bi bi-question-circle"></i> å¸®åŠ©ä¸­å¿ƒ
                </a>
            </p>
        </div>
    </div>

    <!-- APIå¯†é’¥å¤‡ä»½ç®¡ç†æ¨¡æ€æ¡† -->
    <div class="modal fade" id="apiBackupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock"></i> APIå¯†é’¥å¤‡ä»½ç®¡ç†
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6>å½“å‰å¯†é’¥</h6>
                            <div class="input-group">
                                <input type="password" class="form-control" id="currentApiKey" readonly>
                                <button class="btn btn-outline-primary" type="button" id="backupCurrentBtn">
                                    <i class="bi bi-cloud-upload"></i> å¤‡ä»½åˆ°æœåŠ¡å™¨
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>å·²ä¿å­˜çš„å¤‡ä»½</h6>
                    <div id="backupList" class="mt-3">
                        <div class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i> æ­£åœ¨åŠ è½½å¤‡ä»½åˆ—è¡¨...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOMå…ƒç´ å¼•ç”¨
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const progressBar = document.getElementById('progressBar');
        const resultArea = document.getElementById('resultArea');
        const errorArea = document.getElementById('errorArea');
        const uploadForm = document.getElementById('uploadForm');
        const apiKeyInput = document.getElementById('apiKey');
        const toggleApiBtn = document.getElementById('toggleApiKey');
        const saveApiBtn = document.getElementById('saveApiBtn');
        const loadApiBtn = document.getElementById('loadApiBtn');

        // APIå¯†é’¥å®‰å…¨ç®¡ç†
        const API_STORAGE_KEY = 'ai_tender_api_key_encrypted';
        
        // ç®€å•çš„åŠ å¯†/è§£å¯†å‡½æ•°ï¼ˆåŸºäºBase64å’Œç®€å•æ··æ·†ï¼‰
        function encryptApiKey(key) {
            if (!key) return '';
            const encoded = btoa(unescape(encodeURIComponent(key)));
            return encoded.split('').reverse().join('');
        }
        
        function decryptApiKey(encrypted) {
            if (!encrypted) return '';
            try {
                const reversed = encrypted.split('').reverse().join('');
                return decodeURIComponent(escape(atob(reversed)));
            } catch (e) {
                console.error('è§£å¯†å¤±è´¥:', e);
                return '';
            }
        }

        // é¡µé¢åŠ è½½æ—¶å°è¯•åŠ è½½ä¿å­˜çš„APIå¯†é’¥æˆ–ä½¿ç”¨é»˜è®¤å¯†é’¥
        window.addEventListener('load', function() {
            const defaultKey = '{{ default_api_key }}';
            const saved = localStorage.getItem(API_STORAGE_KEY);
            
            if (saved) {
                const decrypted = decryptApiKey(saved);
                if (decrypted) {
                    apiKeyInput.value = decrypted;
                    document.getElementById('tenderApiKey').value = decrypted;
                    showNotification('å·²åŠ è½½ä¿å­˜çš„APIå¯†é’¥', 'success');
                    return;
                }
            }
            
            // å¦‚æœæ²¡æœ‰ä¿å­˜çš„å¯†é’¥ï¼Œä½¿ç”¨é»˜è®¤å¯†é’¥
            if (defaultKey && defaultKey !== 'None') {
                apiKeyInput.value = defaultKey;
                document.getElementById('tenderApiKey').value = defaultKey;
                showNotification('å·²åŠ è½½é»˜è®¤APIå¯†é’¥', 'info');
            }
        });

        // æ˜¾ç¤º/éšè—APIå¯†é’¥
        toggleApiBtn.addEventListener('click', function() {
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            this.innerHTML = isPassword ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
        });

        // ä¿å­˜APIå¯†é’¥
        saveApiBtn.addEventListener('click', function() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showNotification('è¯·å…ˆè¾“å…¥APIå¯†é’¥', 'error');
                return;
            }
            
            const encrypted = encryptApiKey(apiKey);
            localStorage.setItem(API_STORAGE_KEY, encrypted);
            showNotification('APIå¯†é’¥å·²å®‰å…¨ä¿å­˜åˆ°æœ¬åœ°', 'success');
        });

        // åŠ è½½APIå¯†é’¥
        loadApiBtn.addEventListener('click', function() {
            const saved = localStorage.getItem(API_STORAGE_KEY);
            if (saved) {
                const decrypted = decryptApiKey(saved);
                if (decrypted) {
                    apiKeyInput.value = decrypted;
                    showNotification('APIå¯†é’¥åŠ è½½æˆåŠŸ', 'success');
                } else {
                    showNotification('APIå¯†é’¥è§£å¯†å¤±è´¥', 'error');
                }
            } else {
                showNotification('æœªæ‰¾åˆ°ä¿å­˜çš„APIå¯†é’¥', 'error');
            }
        });

        // ç®¡ç†APIå¯†é’¥å¤‡ä»½
        document.getElementById('manageApiBtn').addEventListener('click', function() {
            document.getElementById('currentApiKey').value = apiKeyInput.value;
            loadBackupList();
            new bootstrap.Modal(document.getElementById('apiBackupModal')).show();
        });

        // å¤‡ä»½å½“å‰å¯†é’¥åˆ°æœåŠ¡å™¨
        document.getElementById('backupCurrentBtn').addEventListener('click', function() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showNotification('è¯·å…ˆè¾“å…¥APIå¯†é’¥', 'error');
                return;
            }
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> å¤‡ä»½ä¸­...';
            btn.disabled = true;
            
            fetch('/api/save-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadBackupList(); // åˆ·æ–°å¤‡ä»½åˆ—è¡¨
                } else {
                    showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('å¤‡ä»½å¤±è´¥: ' + error.message, 'error');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        // åŠ è½½å¤‡ä»½åˆ—è¡¨
        function loadBackupList() {
            const backupList = document.getElementById('backupList');
            backupList.innerHTML = '<div class="text-center text-muted"><i class="bi bi-hourglass-split"></i> æ­£åœ¨åŠ è½½å¤‡ä»½åˆ—è¡¨...</div>';
            
            fetch('/api/load-backups')
            .then(response => response.json())
            .then(data => {
                if (data.backups && data.backups.length > 0) {
                    let html = '';
                    data.backups.forEach(backup => {
                        const date = new Date(backup.created_at).toLocaleString('zh-CN');
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <strong>${backup.prefix}</strong>
                                            <small class="text-muted d-block">${backup.description}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">${date}</small>
                                        </div>
                                        <div class="col-md-2 text-end">
                                            <button class="btn btn-sm btn-outline-primary restore-backup-btn" 
                                                    data-backup-id="${backup.id}">
                                                <i class="bi bi-download"></i> æ¢å¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    backupList.innerHTML = html;
                    
                    // ç»‘å®šæ¢å¤æŒ‰é’®äº‹ä»¶
                    document.querySelectorAll('.restore-backup-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const backupId = this.dataset.backupId;
                            restoreApiKey(backupId);
                        });
                    });
                } else {
                    backupList.innerHTML = '<div class="text-center text-muted"><i class="bi bi-inbox"></i> æš‚æ— å¤‡ä»½è®°å½•</div>';
                }
            })
            .catch(error => {
                backupList.innerHTML = '<div class="text-center text-danger">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
            });
        }

        // æ¢å¤APIå¯†é’¥
        function restoreApiKey(backupId) {
            fetch(`/api/restore-key/${backupId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    apiKeyInput.value = data.api_key;
                    document.getElementById('currentApiKey').value = data.api_key;
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('æ¢å¤å¤±è´¥: ' + error.message, 'error');
            });
        }

        // ä¸‹è½½æ–‡ä»¶å‡½æ•°
        function downloadFile(url, filename) {
            try {
                showNotification('å¼€å§‹ä¸‹è½½...', 'info');
                
                // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || '';
                link.style.display = 'none';
                
                // æ·»åŠ åˆ°DOMå¹¶è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(link);
                    showNotification('ä¸‹è½½å·²å¼€å§‹', 'success');
                }, 100);
                
            } catch (error) {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                showNotification('ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æŸ¥çœ‹æ‰€æœ‰æ–‡ä»¶
        document.getElementById('viewFilesBtn').addEventListener('click', function() {
            fetch('/api/files')
            .then(response => response.json())
            .then(data => {
                if (data.files && data.files.length > 0) {
                    let fileList = 'å¯ä¸‹è½½çš„æ–‡ä»¶ï¼š\n\n';
                    data.files.forEach((file, index) => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        fileList += `${index + 1}. ${file.name}\n   å¤§å°: ${size} MB\n   åˆ›å»ºæ—¶é—´: ${date}\n\n`;
                    });
                    alert(fileList);
                } else {
                    alert('æš‚æ— å¯ä¸‹è½½çš„æ–‡ä»¶');
                }
            })
            .catch(error => {
                console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                alert('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + error.message);
            });
        });

        // é€šçŸ¥åŠŸèƒ½
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // æ‹–æ‹½ä¸Šä¼ 
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                fileName.textContent = file.name;
                fileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                fileInfo.style.display = 'block';
                processBtn.disabled = false;
            }
        }

        // APIæµ‹è¯•
        document.getElementById('testApiBtn').addEventListener('click', function() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const btn = this;
            const originalText = btn.innerHTML;
            const statusDiv = document.getElementById('apiStatus');
            
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> æµ‹è¯•ä¸­...';
            btn.disabled = true;
            
            fetch('/api/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.style.display = 'block';
                if (data.success) {
                    statusDiv.className = 'api-status success';
                    statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message} (æ¨¡å‹: ${data.model})`;
                } else {
                    statusDiv.className = 'api-status error';
                    statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.message}`;
                }
            })
            .catch(error => {
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> è¿æ¥å¤±è´¥: ${error.message}`;
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        // é‡è¯•å’Œé‡ç½®åŠŸèƒ½
        document.getElementById('retryBtn').addEventListener('click', function() {
            uploadForm.dispatchEvent(new Event('submit'));
        });

        document.getElementById('resetBtn').addEventListener('click', function() {
            fileInput.value = '';
            fileInfo.style.display = 'none';
            resultArea.style.display = 'none';
            errorArea.style.display = 'none';
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹å¤„ç†';
        });

        // è¡¨å•æäº¤å¤„ç†å‡½æ•°
        function submitUpload() {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('api_key', document.getElementById('apiKey').value.trim());
        
            // æ˜¾ç¤ºè¿›åº¦æ¡
            progressBar.style.display = 'block';
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> å¤„ç†ä¸­...';
            
            // éšè—ä¹‹å‰çš„ç»“æœ
            resultArea.style.display = 'none';
            errorArea.style.display = 'none';
            
            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.querySelector('.progress-bar').style.width = progress + '%';
            }, 500);
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5åˆ†é’Ÿè¶…æ—¶

            fetch('/upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                document.querySelector('.progress-bar').style.width = '100%';
                
                if (data.success) {
                    document.getElementById('resultMessage').textContent = data.message;
                    
                    // è®¾ç½®ä¸‹è½½æŒ‰é’®äº‹ä»¶
                    const downloadBtn = document.getElementById('downloadBtn');
                    downloadBtn.onclick = function(e) {
                        e.preventDefault();
                        downloadFile(data.download_url, data.filename);
                    };
                    
                    resultArea.style.display = 'block';
                } else {
                    document.getElementById('errorMessage').textContent = data.error || 'å¤„ç†å¤±è´¥';
                    errorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = 'ä¸Šä¼ å¤±è´¥: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += 'è¯·æ±‚è¶…æ—¶ï¼Œæ–‡æ¡£è¿‡å¤§æˆ–ç½‘ç»œä¸ç¨³å®šã€‚å»ºè®®ï¼š1) æ£€æŸ¥ç½‘ç»œè¿æ¥ 2) å°è¯•æ›´å°çš„æ–‡æ¡£ 3) ç‚¹å‡»é‡è¯•';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€åé‡è¯•';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('errorMessage').textContent = errorMsg;
                errorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    document.querySelector('.progress-bar').style.width = '0%';
                    processBtn.disabled = false;
                    processBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹å¤„ç†';
                }, 1000);
            });
        }

        // è¡¨å•æäº¤äº‹ä»¶
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitUpload();
        });

        // ================================
        // æŠ€æœ¯æ–¹æ¡ˆç›¸å…³åŠŸèƒ½
        // ================================
        
        // æŠ€æœ¯æ–¹æ¡ˆè¡¨å•å…ƒç´ 
        const techProposalForm = document.getElementById('techProposalForm');
        const techTenderFileInput = document.getElementById('techTenderFileInput');
        const productFileInput = document.getElementById('productFileInput');
        const generateProposalBtn = document.getElementById('generateProposalBtn');
        const techProgressBar = document.getElementById('techProgressBar');
        const techResultArea = document.getElementById('techResultArea');
        const techErrorArea = document.getElementById('techErrorArea');

        // æŠ€æœ¯æ–¹æ¡ˆæ–‡ä»¶é€‰æ‹©å¤„ç†
        techTenderFileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('techTenderFileName').textContent = file.name;
                document.getElementById('techTenderFileInfo').style.display = 'block';
                checkTechFormReady();
            }
        });

        productFileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('productFileName').textContent = file.name;
                document.getElementById('productFileInfo').style.display = 'block';
                checkTechFormReady();
            }
        });

        function checkTechFormReady() {
            const hasTenderFile = techTenderFileInput.files.length > 0;
            const hasProductFile = productFileInput.files.length > 0;
            generateProposalBtn.disabled = !(hasTenderFile && hasProductFile);
        }

        // æŠ€æœ¯æ–¹æ¡ˆè¡¨å•æäº¤
        techProposalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitTechProposal();
        });

        function submitTechProposal() {
            const formData = new FormData();
            formData.append('tender_file', techTenderFileInput.files[0]);
            formData.append('product_file', productFileInput.files[0]);
            formData.append('output_prefix', document.getElementById('outputPrefix').value.trim() || 'æŠ€æœ¯æ–¹æ¡ˆ');
            formData.append('api_key', apiKeyInput.value.trim());

            // æ˜¾ç¤ºè¿›åº¦æ¡
            techProgressBar.style.display = 'block';
            generateProposalBtn.disabled = true;
            generateProposalBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> ç”Ÿæˆä¸­...';
            
            // éšè—ä¹‹å‰çš„ç»“æœ
            techResultArea.style.display = 'none';
            techErrorArea.style.display = 'none';
            
            // æ¨¡æ‹Ÿè¿›åº¦
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                document.querySelector('#techProgressBar .progress-bar').style.width = progress + '%';
            }, 1000);
            
            // åˆ›å»ºè¶…æ—¶æ§åˆ¶å™¨
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 600000); // 10åˆ†é’Ÿè¶…æ—¶

            fetch('/generate-proposal', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                document.querySelector('#techProgressBar .progress-bar').style.width = '100%';
                
                if (data.success) {
                    document.getElementById('techResultMessage').innerHTML = `
                        <strong>ç”Ÿæˆç»Ÿè®¡ï¼š</strong><br>
                        â€¢ éœ€æ±‚æ•°é‡ï¼š${data.requirements_count || 0}<br>
                        â€¢ åŠŸèƒ½æ•°é‡ï¼š${data.features_count || 0}<br>
                        â€¢ åŒ¹é…æ•°é‡ï¼š${data.matches_count || 0}<br>
                        â€¢ ç« èŠ‚æ•°é‡ï¼š${data.sections_count || 0}<br>
                        â€¢ åŒ¹é…æˆåŠŸç‡ï¼š${data.match_stats ? Math.round((data.match_stats.matched_requirements / data.requirements_count * 100) || 0) : 0}%
                    `;
                    
                    // ç”Ÿæˆä¸‹è½½æŒ‰é’®
                    const downloadArea = document.getElementById('techDownloadArea');
                    downloadArea.innerHTML = '';
                    
                    if (data.output_files) {
                        Object.keys(data.output_files).forEach(fileType => {
                            const filePath = data.output_files[fileType];
                            const fileName = filePath.split('/').pop();
                            
                            let buttonClass = 'btn-primary';
                            let iconClass = 'bi-download';
                            let buttonText = 'ä¸‹è½½';
                            
                            switch (fileType) {
                                case 'proposal':
                                    buttonClass = 'btn-success';
                                    iconClass = 'bi-file-earmark-word';
                                    buttonText = 'ä¸‹è½½æŠ€æœ¯æ–¹æ¡ˆ';
                                    break;
                                case 'outline':
                                    buttonClass = 'btn-info';
                                    iconClass = 'bi-list-ol';
                                    buttonText = 'ä¸‹è½½æ–¹æ¡ˆå¤§çº²';
                                    break;
                                case 'match_report':
                                    buttonClass = 'btn-warning';
                                    iconClass = 'bi-graph-up';
                                    buttonText = 'ä¸‹è½½åŒ¹é…æŠ¥å‘Š';
                                    break;
                                case 'full_data':
                                    buttonClass = 'btn-secondary';
                                    iconClass = 'bi-database';
                                    buttonText = 'ä¸‹è½½å®Œæ•´æ•°æ®';
                                    break;
                            }
                            
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = `btn ${buttonClass} me-2 mb-2`;
                            downloadBtn.innerHTML = `<i class="${iconClass}"></i> ${buttonText}`;
                            downloadBtn.onclick = function() {
                                downloadFile(`/download-tech/${fileName}`, fileName);
                            };
                            downloadArea.appendChild(downloadBtn);
                        });
                    }
                    
                    techResultArea.style.display = 'block';
                } else {
                    document.getElementById('techErrorMessage').textContent = data.error || 'ç”Ÿæˆå¤±è´¥';
                    techErrorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = 'ç”Ÿæˆå¤±è´¥: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += 'è¯·æ±‚è¶…æ—¶ï¼Œæ–‡æ¡£è¿‡å¤§æˆ–å¤„ç†æ—¶é—´è¿‡é•¿ã€‚å»ºè®®ï¼š1) æ£€æŸ¥ç½‘ç»œè¿æ¥ 2) å°è¯•æ›´å°çš„æ–‡æ¡£ 3) ç‚¹å‡»é‡è¯•';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€åé‡è¯•';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('techErrorMessage').textContent = errorMsg;
                techErrorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    techProgressBar.style.display = 'none';
                    document.querySelector('#techProgressBar .progress-bar').style.width = '0%';
                    generateProposalBtn.disabled = false;
                    generateProposalBtn.innerHTML = '<i class="bi bi-play-circle"></i> ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆ';
                }, 1000);
            });
        }

        // æŠ€æœ¯æ–¹æ¡ˆé‡è¯•å’Œé‡ç½®åŠŸèƒ½
        document.getElementById('techRetryBtn').addEventListener('click', function() {
            submitTechProposal();
        });

        document.getElementById('techResetBtn').addEventListener('click', function() {
            techTenderFileInput.value = '';
            productFileInput.value = '';
            document.getElementById('techTenderFileInfo').style.display = 'none';
            document.getElementById('productFileInfo').style.display = 'none';
            techResultArea.style.display = 'none';
            techErrorArea.style.display = 'none';
            generateProposalBtn.disabled = true;
            generateProposalBtn.innerHTML = '<i class="bi bi-play-circle"></i> ç”ŸæˆæŠ€æœ¯æ–¹æ¡ˆ';
        });

        // ====== æ‹›æ ‡ä¿¡æ¯æå–åŠŸèƒ½ ======
        console.log('Initializing tender info extraction...');
        const tenderUploadArea = document.getElementById('tenderUploadArea');
        const tenderFileInput = document.getElementById('tenderFileInput');
        const tenderFileInfo = document.getElementById('tenderFileInfo');
        const tenderFileName = document.getElementById('tenderFileName');
        const tenderFileSize = document.getElementById('tenderFileSize');
        const extractInfoBtn = document.getElementById('extractInfoBtn');
        const tenderProgressBar = document.getElementById('tenderProgressBar');
        const tenderResultArea = document.getElementById('tenderResultArea');
        const tenderErrorArea = document.getElementById('tenderErrorArea');
        const tenderInfoDisplay = document.getElementById('tenderInfoDisplay');
        
        console.log('Tender elements:', {
            tenderUploadArea,
            tenderFileInput,
            tenderFileInfo,
            tenderFileName,
            tenderFileSize,
            extractInfoBtn
        });

        // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
        tenderUploadArea.addEventListener('click', () => {
            console.log('Tender upload area clicked');
            tenderFileInput.click();
        });

        // æ‹–æ‹½ä¸Šä¼ 
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            tenderUploadArea.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.remove('dragover'), false);
        });

        tenderUploadArea.addEventListener('drop', handleTenderDrop, false);

        function handleTenderDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                tenderFileInput.files = files;
                handleTenderFileSelect();
            }
        }

        tenderFileInput.addEventListener('change', handleTenderFileSelect);

        function handleTenderFileSelect() {
            console.log('handleTenderFileSelect called');
            const file = tenderFileInput.files[0];
            console.log('Selected file:', file);
            if (file) {
                console.log('File details:', file.name, file.size);
                tenderFileName.textContent = file.name;
                tenderFileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                tenderFileInfo.style.display = 'block';
                extractInfoBtn.disabled = false;
                console.log('File info updated, extract button enabled');
            } else {
                console.log('No file selected');
            }
        }

        // APIæµ‹è¯•
        document.getElementById('testTenderApiBtn').addEventListener('click', function() {
            const apiKey = document.getElementById('tenderApiKey').value.trim();
            const btn = this;
            const originalText = btn.innerHTML;
            const statusDiv = document.getElementById('tenderApiStatus');
            
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> æµ‹è¯•ä¸­...';
            btn.disabled = true;
            
            fetch('/api/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.style.display = 'block';
                if (data.success) {
                    statusDiv.className = 'api-status success';
                    statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message} (æ¨¡å‹: ${data.model})`;
                } else {
                    statusDiv.className = 'api-status error';
                    statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.message}`;
                }
            })
            .catch(error => {
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> è¿æ¥å¤±è´¥: ${error.message}`;
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        // æå–ä¿¡æ¯æŒ‰é’®äº‹ä»¶
        extractInfoBtn.addEventListener('click', function() {
            submitTenderExtraction();
        });

        async function performStepwiseExtraction(formData, progressBar, tenderResultArea, tenderErrorArea, progressInterval, timeoutId) {
            try {
                // æ¸…ç©ºä¹‹å‰çš„ç»“æœå®¹å™¨
                ['basicInfoContainer', 'qualificationContainer', 'technicalContainer'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) element.remove();
                });
                
                // ç¬¬ä¸€æ­¥ï¼šæå–åŸºæœ¬ä¿¡æ¯
                document.getElementById('stepMessage').textContent = 'æ­£åœ¨æå–åŸºæœ¬ä¿¡æ¯...';
                progressBar.style.width = '20%';
                
                const step1FormData = new FormData();
                for (let pair of formData.entries()) {
                    step1FormData.append(pair[0], pair[1]);
                }
                step1FormData.append('step', '1');
                
                const step1Response = await fetch('/extract-tender-info-step', {
                    method: 'POST',
                    body: step1FormData
                });
                const step1Data = await step1Response.json();
                
                if (!step1Data.success) {
                    throw new Error(step1Data.error);
                }
                
                // æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯
                displayBasicInfo(step1Data.basic_info);
                progressBar.style.width = '40%';
                
                // ç¬¬äºŒæ­¥ï¼šæå–èµ„è´¨è¦æ±‚  
                document.getElementById('stepMessage').textContent = 'æ­£åœ¨æå–èµ„è´¨è¦æ±‚...';
                
                const step2FormData = new FormData();
                step2FormData.append('step', '2');
                step2FormData.append('file_path', step1Data.file_path);
                step2FormData.append('api_key', document.getElementById('tenderApiKey').value);
                
                const step2Response = await fetch('/extract-tender-info-step', {
                    method: 'POST',
                    body: step2FormData
                });
                const step2Data = await step2Response.json();
                
                if (!step2Data.success) {
                    throw new Error(step2Data.error);
                }
                
                // æ˜¾ç¤ºèµ„è´¨è¦æ±‚
                displayQualificationRequirements(step2Data.qualification_requirements);
                progressBar.style.width = '70%';
                
                // ç¬¬ä¸‰æ­¥ï¼šæå–æŠ€æœ¯è¯„åˆ†
                document.getElementById('stepMessage').textContent = 'æ­£åœ¨åˆ†ææŠ€æœ¯è¯„åˆ†...';
                
                const step3FormData = new FormData();
                step3FormData.append('step', '3');
                step3FormData.append('file_path', step1Data.file_path);
                step3FormData.append('api_key', document.getElementById('tenderApiKey').value);
                
                const step3Response = await fetch('/extract-tender-info-step', {
                    method: 'POST',
                    body: step3FormData
                });
                const step3Data = await step3Response.json();
                
                if (!step3Data.success) {
                    throw new Error(step3Data.error);
                }
                
                // æ˜¾ç¤ºæŠ€æœ¯è¯„åˆ†
                displayTechnicalScoring(step3Data.technical_scoring);
                progressBar.style.width = '100%';
                document.getElementById('stepMessage').textContent = 'æ‰€æœ‰ä¿¡æ¯æå–å®Œæˆï¼';
                
                // æ¸…ç†å®šæ—¶å™¨
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                
                tenderResultArea.style.display = 'block';
                
            } catch (error) {
                throw error;
            }
        }

        function submitTenderExtraction() {
            const formData = new FormData();
            formData.append('file', tenderFileInput.files[0]);
            formData.append('api_key', document.getElementById('tenderApiKey').value);

            // é‡ç½®æ˜¾ç¤ºåŒºåŸŸ
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            
            // æ˜¾ç¤ºè¿›åº¦æ¡å’Œæ­¥éª¤æ¶ˆæ¯
            tenderProgressBar.style.display = 'block';
            document.getElementById('stepMessage').style.display = 'block';
            const progressBar = tenderProgressBar.querySelector('.progress-bar');
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> æå–ä¸­...';

            // æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            // è¶…æ—¶æ§åˆ¶
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2åˆ†é’Ÿè¶…æ—¶

            // åˆ†æ­¥åŠ è½½å®ç°
            performStepwiseExtraction(formData, progressBar, tenderResultArea, tenderErrorArea, progressInterval, timeoutId)
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = 'æå–å¤±è´¥: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += 'è¯·æ±‚è¶…æ—¶ï¼Œæ–‡æ¡£è¿‡å¤§æˆ–å¤„ç†æ—¶é—´è¿‡é•¿ã€‚å»ºè®®ï¼š1) æ£€æŸ¥ç½‘ç»œè¿æ¥ 2) å°è¯•æ›´å°çš„æ–‡æ¡£ 3) ç‚¹å‡»é‡è¯•';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€åé‡è¯•';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('tenderErrorMessage').textContent = errorMsg;
                tenderErrorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    tenderProgressBar.style.display = 'none';
                    document.getElementById('stepMessage').style.display = 'none';
                    tenderProgressBar.querySelector('.progress-bar').style.width = '0%';
                    extractInfoBtn.disabled = false;
                    extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹æå–ä¿¡æ¯';
                }, 1000);
            });
        }

        function displayTenderInfo(tenderInfo) {
            const fieldLabels = {
                'tenderer': 'æ‹›æ ‡äºº',
                'agency': 'æ‹›æ ‡ä»£ç†',
                'bidding_method': 'æŠ•æ ‡æ–¹å¼',
                'bidding_location': 'æŠ•æ ‡åœ°ç‚¹',
                'bidding_time': 'æŠ•æ ‡æ—¶é—´',
                'winner_count': 'ä¸­æ ‡äººæ•°é‡',
                'project_name': 'é¡¹ç›®åç§°',
                'project_number': 'é¡¹ç›®ç¼–å·'
            };

            // åŸºæœ¬ä¿¡æ¯éƒ¨åˆ†
            let html = '<h5 class="text-primary mb-3"><i class="bi bi-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h5>';
            let basicInfoHtml = '';
            
            for (const [key, value] of Object.entries(tenderInfo)) {
                if (fieldLabels[key]) {
                    const label = fieldLabels[key];
                    const displayValue = value || 'æœªæå–åˆ°';
                    const textColor = value ? 'text-success' : 'text-muted';
                    
                    basicInfoHtml += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-info-circle"></i> ${label}
                                    </h6>
                                    <p class="card-text ${textColor}">${displayValue}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            html += `<div class="row">${basicInfoHtml}</div>`;
            
            // èµ„è´¨è¦æ±‚éƒ¨åˆ†
            if (tenderInfo.qualification_requirements) {
                html += '<hr><h5 class="text-warning mb-3 mt-4"><i class="bi bi-list-check"></i> èµ„è´¨è¦æ±‚</h5>';
                
                const qualificationLabels = {
                    'business_license': 'è¥ä¸šæ‰§ç…§',
                    'taxpayer_qualification': 'çº³ç¨äººèµ„æ ¼ï¼ˆå¢å€¼ç¨çº³ç¨äººï¼‰',
                    'performance_requirements': 'ä¸šç»©è¦æ±‚',
                    'authorization_requirements': 'æˆæƒè¦æ±‚',
                    'credit_china': 'ä¿¡ç”¨ä¸­å›½',
                    'commitment_letter': 'æ‰¿è¯ºå‡½ï¼ˆé»˜è®¤æ»¡è¶³ï¼‰',
                    'audit_report': 'å®¡è®¡æŠ¥å‘Šï¼ˆè´¢åŠ¡è¦æ±‚ï¼‰',
                    'social_security': 'ç¤¾ä¿è¦æ±‚',
                    'labor_contract': 'åŠ³åŠ¨åˆåŒè¦æ±‚',
                    'other_requirements': 'å…¶ä»–è¦æ±‚'
                };
                
                let qualHtml = '';
                for (const [key, qualData] of Object.entries(tenderInfo.qualification_requirements)) {
                    if (qualificationLabels[key]) {
                        const label = qualificationLabels[key];
                        const required = qualData.required;
                        const description = qualData.description || '';
                        const statusText = required ? 'éœ€è¦æä¾›' : 'ä¸éœ€è¦æä¾›';
                        const statusColor = required ? 'text-danger' : 'text-success';
                        const iconClass = required ? 'bi-exclamation-triangle' : 'bi-check-circle';
                        
                        qualHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card ${required ? 'border-warning' : 'border-success'}">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi ${iconClass} ${statusColor}"></i> ${label}
                                        </h6>
                                        <p class="card-text ${statusColor} fw-bold">${statusText}</p>
                                        ${description ? `<p class="card-text text-muted small">${description}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `<div class="row">${qualHtml}</div>`;
            }
            
            // æŠ€æœ¯è¯„åˆ†éƒ¨åˆ†
            if (tenderInfo.technical_scoring) {
                html += '<hr><h5 class="text-info mb-3 mt-4"><i class="bi bi-graph-up-arrow"></i> æŠ€æœ¯è¯„åˆ†æ ‡å‡†</h5>';
                
                const techScoring = tenderInfo.technical_scoring;
                
                // æŠ€æœ¯æ€»åˆ†æ˜¾ç¤º
                if (techScoring.total_score) {
                    html += `
                        <div class="alert alert-info">
                            <h6 class="mb-2">
                                <i class="bi bi-trophy"></i> æŠ€æœ¯è¯„åˆ†æ€»åˆ†ï¼š
                                <span class="text-primary fw-bold">${techScoring.total_score}</span>
                            </h6>
                            ${techScoring.extraction_summary ? 
                                `<small class="text-muted">${techScoring.extraction_summary}</small>` : ''}
                        </div>
                    `;
                }
                
                // æŠ€æœ¯è¯„åˆ†é¡¹è¡¨æ ¼
                if (techScoring.items && techScoring.items.length > 0) {
                    html += `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-info">
                                    <tr>
                                        <th style="width: 5%;">åºå·</th>
                                        <th style="width: 20%;">è¯„åˆ†é¡¹åç§°</th>
                                        <th style="width: 10%;">åˆ†å€¼</th>
                                        <th style="width: 50%;">è¯„åˆ†æ ‡å‡†</th>
                                        <th style="width: 15%;">æ•°æ®æ¥æº</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    techScoring.items.forEach((item, index) => {
                        const weightDisplay = item.weight || 'æœªæåŠ';
                        const criteriaDisplay = item.criteria || 'æœªæåŠ';
                        const sourceDisplay = item.source || 'æœªæåŠ';
                        
                        html += `
                            <tr>
                                <td class="text-center fw-bold">${index + 1}</td>
                                <td class="fw-semibold text-primary">${item.name}</td>
                                <td class="text-center">
                                    <span class="badge bg-info">${weightDisplay}</span>
                                </td>
                                <td>
                                    <small class="text-muted">${criteriaDisplay}</small>
                                </td>
                                <td>
                                    <small class="text-secondary">${sourceDisplay}</small>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            æœªèƒ½æå–åˆ°å…·ä½“çš„æŠ€æœ¯è¯„åˆ†é¡¹ä¿¡æ¯
                        </div>
                    `;
                }
            }
            
            tenderInfoDisplay.innerHTML = html;
        }

        // æ‹›æ ‡ä¿¡æ¯æå–é‡è¯•å’Œé‡ç½®åŠŸèƒ½
        document.getElementById('tenderRetryBtn').addEventListener('click', function() {
            submitTenderExtraction();
        });

        document.getElementById('tenderRetryBtn2').addEventListener('click', function() {
            submitTenderExtraction();
        });

        document.getElementById('tenderResetBtn').addEventListener('click', function() {
            tenderFileInput.value = '';
            tenderFileInfo.style.display = 'none';
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹æå–ä¿¡æ¯';
        });

        document.getElementById('tenderResetBtn2').addEventListener('click', function() {
            tenderFileInput.value = '';
            tenderFileInfo.style.display = 'none';
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> å¼€å§‹æå–ä¿¡æ¯';
        });

        // ====== å…¬å¸ä¿¡æ¯ç®¡ç†åŠŸèƒ½ ======
        console.log('Initializing company management...');
        const companySelect = document.getElementById('companySelect');
        const companyInfoForm = document.getElementById('companyInfoForm');
        const saveCompanyBtn = document.getElementById('saveCompanyBtn');
        const loadCompanyBtn = document.getElementById('loadCompanyBtn');
        const newCompanyBtn = document.getElementById('newCompanyBtn');
        const clearFormBtn = document.getElementById('clearFormBtn');
        const deleteCompanyBtn = document.getElementById('deleteCompanyBtn');
        const companyResultArea = document.getElementById('companyResultArea');
        const companyErrorArea = document.getElementById('companyErrorArea');

        // å…¬å¸ä¿¡æ¯å­—æ®µæ˜ å°„
        const companyFields = {
            'companyName': 'å…¬å¸åç§°',
            'establishDate': 'æˆç«‹æ—¥æœŸ',
            'legalRepresentative': 'æ³•å®šä»£è¡¨äºº',
            'socialCreditCode': 'ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ',
            'registeredCapital': 'æ³¨å†Œèµ„æœ¬',
            'companyType': 'å…¬å¸ç±»å‹',
            'fixedPhone': 'å›ºå®šç”µè¯',
            'postalCode': 'é‚®æ”¿ç¼–ç ',
            'registeredAddress': 'æ³¨å†Œåœ°å€',
            'officeAddress': 'åŠå…¬åœ°å€',
            'website': 'å®˜æ–¹ç½‘å€',
            'employeeCount': 'å‘˜å·¥äººæ•°',
            'companyDescription': 'å…¬å¸ç®€ä»‹',
            'businessScope': 'ç»è¥èŒƒå›´',
            'bankName': 'å¼€æˆ·è¡Œå…¨ç§°',
            'bankAccount': 'é“¶è¡Œè´¦å·'
        };

        let currentCompanyId = null;
        let isLoadingCompany = false; // é˜²æ­¢å¾ªç¯è§¦å‘çš„æ ‡å¿—

        // é¡µé¢åŠ è½½æ—¶è·å–å…¬å¸åˆ—è¡¨å’Œé¡¹ç›®ä¿¡æ¯
        window.addEventListener('load', function() {
            loadCompanyList();
            loadProjectInfo();
        });

        // è·å–å…¬å¸åˆ—è¡¨
        function loadCompanyList() {
            fetch('/api/companies')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.companies) {
                    updateCompanySelect(data.companies);
                } else {
                    console.log('No companies found or error loading companies');
                }
            })
            .catch(error => {
                console.error('Error loading companies:', error);
            });
        }
        
        // è·å–é¡¹ç›®ä¿¡æ¯
        function loadProjectInfo() {
            fetch('/api/project-config')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.project_info) {
                    fillProjectInfo(data.project_info);
                } else {
                    console.log('No project info found or error loading project info');
                }
            })
            .catch(error => {
                console.error('Error loading project info:', error);
            });
        }
        
        // å¡«å……é¡¹ç›®ä¿¡æ¯åˆ°å•†åŠ¡åº”ç­”é¡µé¢
        function fillProjectInfo(projectInfo) {
            // å¡«å……å•†åŠ¡åº”ç­”é¡µé¢çš„é¡¹ç›®ä¿¡æ¯
            const projectNameField = document.getElementById('businessProjectName');
            const tenderNoField = document.getElementById('businessTenderNo'); 
            const dateField = document.getElementById('businessDate');
            
            if (projectNameField && projectInfo.projectName) {
                projectNameField.value = projectInfo.projectName;
            }
            
            if (tenderNoField && projectInfo.projectNumber && projectInfo.projectNumber !== 'æœªæä¾›') {
                tenderNoField.value = projectInfo.projectNumber;
            }
            
            if (dateField && projectInfo.currentDate) {
                dateField.value = projectInfo.currentDate;
            }
            
            console.log('Project info loaded:', projectInfo);
        }

        // æ›´æ–°å…¬å¸é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateCompanySelect(companies) {
            companySelect.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬å¸ï¼ˆé€‰æ‹©åè‡ªåŠ¨åŠ è½½ï¼‰</option>';
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = company.companyName;
                companySelect.appendChild(option);
            });
            
            // åŒæ—¶æ›´æ–°å•†åŠ¡åº”ç­”é¡µé¢çš„å…¬å¸ä¸‹æ‹‰æ¡†
            const businessCompanySelect = document.getElementById('businessCompanySelect');
            if (businessCompanySelect) {
                businessCompanySelect.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬å¸...</option>';
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.id;
                    option.textContent = company.companyName;
                    businessCompanySelect.appendChild(option);
                });
            }
            
            // å¦‚æœåªæœ‰ä¸€ä¸ªå…¬å¸ï¼Œè‡ªåŠ¨é€‰æ‹©å®ƒ
            if (companies.length === 1) {
                const company = companies[0];
                
                // é€‰æ‹©åº”ç­”äººé¡µé¢è‡ªåŠ¨é€‰æ‹©
                companySelect.value = company.id;
                loadCompanyInfo(company.id);
                
                // å•†åŠ¡åº”ç­”é¡µé¢è‡ªåŠ¨é€‰æ‹©
                if (businessCompanySelect) {
                    businessCompanySelect.value = company.id;
                }
            }
        }

        // æ·»åŠ å…¬å¸é€‰æ‹©å˜åŒ–ç›‘å¬å™¨
        companySelect.addEventListener('change', function() {
            if (isLoadingCompany) return; // é˜²æ­¢å¾ªç¯è§¦å‘
            
            const companyId = this.value;
            if (companyId) {
                // è‡ªåŠ¨åŠ è½½é€‰ä¸­çš„å…¬å¸ä¿¡æ¯
                loadCompanyInfo(companyId);
            } else {
                // å¦‚æœé€‰æ‹©ç©ºå€¼ï¼Œæ¸…ç©ºè¡¨å•
                clearCompanyFormInternal();
            }
        });

        // é‡æ–°åŠ è½½é€‰ä¸­çš„å…¬å¸ä¿¡æ¯
        loadCompanyBtn.addEventListener('click', function() {
            const companyId = companySelect.value;
            if (!companyId) {
                showCompanyMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå…¬å¸', 'error');
                return;
            }
            
            loadCompanyInfo(companyId);
        });

        // åŠ è½½å…¬å¸ä¿¡æ¯
        function loadCompanyInfo(companyId) {
            fetch(`/api/companies/${companyId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.company) {
                    fillCompanyForm(data.company);
                    currentCompanyId = companyId;
                    deleteCompanyBtn.style.display = 'inline-block';
                    
                    // åŠ è½½èµ„è´¨æ–‡ä»¶ä¿¡æ¯
                    loadCompanyQualifications(companyId);
                    
                    showCompanyMessage('å…¬å¸ä¿¡æ¯åŠ è½½æˆåŠŸ', 'success');
                } else {
                    showCompanyMessage('åŠ è½½å…¬å¸ä¿¡æ¯å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                showCompanyMessage('åŠ è½½å…¬å¸ä¿¡æ¯å¤±è´¥: ' + error.message, 'error');
            });
        }

        // åŠ è½½å…¬å¸èµ„è´¨æ–‡ä»¶ä¿¡æ¯
        function loadCompanyQualifications(companyId) {
            fetch(`/api/companies/${companyId}/qualifications`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.qualifications) {
                    // å…ˆæ¸…ç©ºå½“å‰èµ„è´¨ä¿¡æ¯
                    clearAllQualificationsInternal();
                    
                    // åŠ è½½å·²æœ‰çš„èµ„è´¨ä¿¡æ¯
                    Object.keys(data.qualifications).forEach(qualKey => {
                        const qualInfo = data.qualifications[qualKey];
                        displayExistingQualification(qualKey, qualInfo);
                    });
                } else {
                    console.log('No qualifications found or error loading qualifications');
                }
            })
            .catch(error => {
                console.error('Error loading company qualifications:', error);
            });
        }

        // åˆ†æ­¥æ˜¾ç¤ºå‡½æ•°
        function displayBasicInfo(basicInfo) {
            const basicContainer = document.getElementById('basicInfoContainer');
            if (!basicContainer) {
                // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
                const container = document.createElement('div');
                container.id = 'basicInfoContainer';
                container.className = 'card border-primary mb-3';
                container.innerHTML = `
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="bi bi-info-circle"></i> åŸºæœ¬ä¿¡æ¯</h6>
                    </div>
                    <div class="card-body" id="basicInfoContent">
                    </div>
                `;
                tenderResultArea.appendChild(container);
                tenderResultArea.style.display = 'block';
            }
            
            const content = document.getElementById('basicInfoContent');
            let html = '<div class="row">';
            
            const fieldLabels = {
                'project_name': 'é¡¹ç›®åç§°',
                'project_number': 'é¡¹ç›®ç¼–å·', 
                'tenderer': 'æ‹›æ ‡äºº',
                'agency': 'æ‹›æ ‡ä»£ç†',
                'bidding_method': 'æŠ•æ ‡æ–¹å¼',
                'bidding_location': 'æŠ•æ ‡åœ°ç‚¹',
                'bidding_time': 'æŠ•æ ‡æ—¶é—´',
                'winner_count': 'ä¸­æ ‡äººæ•°é‡'
            };
            
            for (const [field, label] of Object.entries(fieldLabels)) {
                const value = basicInfo[field] || 'æœªæä¾›';
                html += `
                    <div class="col-md-6 mb-2">
                        <strong class="text-muted">${label}:</strong>
                        <span class="ms-2">${value}</span>
                    </div>
                `;
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        function displayQualificationRequirements(qualRequirements) {
            const qualContainer = document.getElementById('qualificationContainer');
            if (!qualContainer) {
                const container = document.createElement('div');
                container.id = 'qualificationContainer';
                container.className = 'card border-warning mb-3';
                container.innerHTML = `
                    <div class="card-header bg-warning">
                        <h6 class="mb-0"><i class="bi bi-award"></i> èµ„è´¨è¦æ±‚</h6>
                    </div>
                    <div class="card-body" id="qualificationContent">
                    </div>
                `;
                tenderResultArea.appendChild(container);
            }
            
            const content = document.getElementById('qualificationContent');
            let html = '';
            
            for (const [key, info] of Object.entries(qualRequirements)) {
                const required = info.required ? 'éœ€è¦æä¾›' : 'ä¸éœ€è¦æä¾›';
                const description = info.description || 'æ— å…·ä½“è¯´æ˜';
                const statusClass = info.required ? 'text-success' : 'text-secondary';
                
                html += `
                    <div class="mb-3 p-2 border-start border-3 ${info.required ? 'border-success' : 'border-secondary'}">
                        <div class="d-flex justify-content-between align-items-start">
                            <strong>${getQualificationLabel(key)}</strong>
                            <span class="badge ${info.required ? 'bg-success' : 'bg-secondary'}">${required}</span>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">${description}</small>
                        </div>
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }

        function displayTechnicalScoring(technicalScoring) {
            const techContainer = document.getElementById('technicalContainer');
            if (!techContainer) {
                const container = document.createElement('div');
                container.id = 'technicalContainer';
                container.className = 'card border-info mb-3';
                container.innerHTML = `
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="bi bi-graph-up"></i> æŠ€æœ¯è¯„åˆ†</h6>
                    </div>
                    <div class="card-body" id="technicalContent">
                    </div>
                `;
                tenderResultArea.appendChild(container);
            }
            
            const content = document.getElementById('technicalContent');
            const items = technicalScoring.technical_scoring_items || [];
            
            if (items.length > 0) {
                let html = `
                    <div class="mb-3">
                        <span class="badge bg-info fs-6">æ€»åˆ†: ${technicalScoring.total_technical_score || '30åˆ†'}</span>
                        <span class="badge bg-secondary ms-2">${technicalScoring.extraction_summary}</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>åºå·</th>
                                    <th>è¯„åˆ†é¡¹</th>
                                    <th>åˆ†å€¼</th>
                                    <th>è¯„åˆ†æ ‡å‡†</th>
                                    <th>æ¥æº</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                items.forEach((item, index) => {
                    html += `
                        <tr>
                            <td class="text-center fw-bold">${index + 1}</td>
                            <td class="fw-semibold text-primary">${item.name}</td>
                            <td class="text-center">
                                <span class="badge bg-info">${item.weight}</span>
                            </td>
                            <td>
                                <small class="text-muted">${item.criteria}</small>
                            </td>
                            <td>
                                <small class="text-secondary">${item.source}</small>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            } else {
                html = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        æœªèƒ½æå–åˆ°æŠ€æœ¯è¯„åˆ†ä¿¡æ¯
                    </div>
                `;
            }
            
            content.innerHTML = html;
        }

        function getQualificationLabel(key) {
            const labels = {
                'business_license': 'è¥ä¸šæ‰§ç…§',
                'taxpayer_qualification': 'çº³ç¨äººèµ„æ ¼',
                'performance_requirements': 'ä¸šç»©è¦æ±‚',
                'authorization_requirements': 'æˆæƒè¦æ±‚',
                'credit_china': 'ä¿¡ç”¨ä¸­å›½',
                'commitment_letter': 'æ‰¿è¯ºå‡½',
                'audit_report': 'å®¡è®¡æŠ¥å‘Š',
                'social_security': 'ç¤¾ä¿è¦æ±‚',
                'labor_contract': 'åŠ³åŠ¨åˆåŒ',
                'other_requirements': 'å…¶ä»–è¦æ±‚'
            };
            return labels[key] || key;
        }

        // æ˜¾ç¤ºå·²å­˜åœ¨çš„èµ„è´¨æ–‡ä»¶
        function displayExistingQualification(qualKey, qualInfo) {
            const statusDiv = document.getElementById(`status-${qualKey}`);
            const qualElement = document.querySelector(`[data-qual-key="${qualKey}"]`);
            
            if (statusDiv && qualElement) {
                const viewBtn = qualElement.querySelector('.view-file-btn');
                const deleteBtn = qualElement.querySelector('.delete-file-btn');
                
                // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                statusDiv.innerHTML = `
                    <small class="text-success">
                        <i class="bi bi-cloud-check"></i> å·²ä¸Šä¼ : ${qualInfo.original_filename} 
                        (${(qualInfo.file_size / 1024).toFixed(1)} KB)
                        <span class="badge bg-success">å·²ä¿å­˜</span>
                    </small>
                `;
                statusDiv.style.display = 'block';
                
                // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                if (viewBtn) viewBtn.style.display = 'inline-block';
                if (deleteBtn) deleteBtn.style.display = 'inline-block';
                
                // è®°å½•æ–‡ä»¶ä¿¡æ¯ç”¨äºæ˜¾ç¤ºï¼ˆä½†ä¸æ˜¯æœ¬åœ°æ–‡ä»¶ï¼‰
                qualificationFiles[qualKey] = {
                    original_filename: qualInfo.original_filename,
                    file_size: qualInfo.file_size,
                    uploaded: true,
                    server_file: true // æ ‡è®°è¿™æ˜¯æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
                };
            } else if (qualKey.startsWith('custom_')) {
                // å¦‚æœæ˜¯è‡ªå®šä¹‰èµ„è´¨ï¼Œéœ€è¦é‡æ–°åˆ›å»ºå…ƒç´ 
                const qualName = qualInfo.qualification_name || 'è‡ªå®šä¹‰èµ„è´¨';
                const qualElement = createQualificationElement(qualKey, qualName, 'bi-file-plus', true);
                document.getElementById('customQualifications').appendChild(qualElement);
                
                // ç„¶åæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                setTimeout(() => {
                    displayExistingQualification(qualKey, qualInfo);
                }, 100);
            }
        }

        // å¡«å†™è¡¨å•
        function fillCompanyForm(company) {
            isLoadingCompany = true; // é˜²æ­¢å¡«å……æ—¶è§¦å‘äº‹ä»¶
            Object.keys(companyFields).forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element && company[fieldId]) {
                    element.value = company[fieldId];
                }
            });
            isLoadingCompany = false; // é‡ç½®æ ‡å¿—
        }

        // æ–°å»ºå…¬å¸
        newCompanyBtn.addEventListener('click', function() {
            clearCompanyForm();
            clearAllQualificationsInternal(); // æ¸…ç©ºèµ„è´¨æ–‡ä»¶
            currentCompanyId = null;
            deleteCompanyBtn.style.display = 'none';
            showCompanyMessage('å·²æ¸…ç©ºè¡¨å•ï¼Œå¯ä»¥å¡«å†™æ–°å…¬å¸ä¿¡æ¯', 'success');
        });

        // æ¸…ç©ºè¡¨å•
        clearFormBtn.addEventListener('click', function() {
            clearCompanyForm();
            clearAllQualificationsInternal(); // åŒæ—¶æ¸…ç©ºèµ„è´¨æ–‡ä»¶
        });

        // å†…éƒ¨æ¸…ç©ºè¡¨å•å‡½æ•°ï¼ˆä¸è§¦å‘changeäº‹ä»¶ï¼‰
        function clearCompanyFormInternal() {
            companyInfoForm.reset();
            currentCompanyId = null;
            deleteCompanyBtn.style.display = 'none';
            hideCompanyMessages();
        }

        // å¤–éƒ¨æ¸…ç©ºè¡¨å•å‡½æ•°ï¼ˆåŒ…æ‹¬ä¸‹æ‹‰æ¡†ï¼‰
        function clearCompanyForm() {
            isLoadingCompany = true; // è®¾ç½®æ ‡å¿—é˜²æ­¢å¾ªç¯
            companyInfoForm.reset();
            companySelect.value = '';
            currentCompanyId = null;
            deleteCompanyBtn.style.display = 'none';
            hideCompanyMessages();
            isLoadingCompany = false; // é‡ç½®æ ‡å¿—
        }

        // ä¿å­˜å…¬å¸ä¿¡æ¯
        saveCompanyBtn.addEventListener('click', function() {
            const companyName = document.getElementById('companyName').value.trim();
            if (!companyName) {
                showCompanyMessage('å…¬å¸åç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }

            const companyData = {};
            Object.keys(companyFields).forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    companyData[fieldId] = element.value.trim();
                }
            });

            const btn = saveCompanyBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> ä¿å­˜ä¸­...';
            btn.disabled = true;

            const url = currentCompanyId ? `/api/companies/${currentCompanyId}` : '/api/companies';
            const method = currentCompanyId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(companyData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentCompanyId = data.company_id || currentCompanyId;
                    deleteCompanyBtn.style.display = 'inline-block';
                    showCompanyMessage(data.message || 'å…¬å¸ä¿¡æ¯ä¿å­˜æˆåŠŸ', 'success');
                    loadCompanyList(); // åˆ·æ–°å…¬å¸åˆ—è¡¨
                } else {
                    showCompanyMessage('ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                showCompanyMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        // åˆ é™¤å…¬å¸
        deleteCompanyBtn.addEventListener('click', function() {
            if (!currentCompanyId) {
                showCompanyMessage('æ²¡æœ‰é€‰ä¸­çš„å…¬å¸å¯åˆ é™¤', 'error');
                return;
            }

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…¬å¸ä¿¡æ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            const btn = deleteCompanyBtn;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> åˆ é™¤ä¸­...';
            btn.disabled = true;

            fetch(`/api/companies/${currentCompanyId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    clearCompanyForm();
                    showCompanyMessage(data.message || 'å…¬å¸ä¿¡æ¯åˆ é™¤æˆåŠŸ', 'success');
                    loadCompanyList(); // åˆ·æ–°å…¬å¸åˆ—è¡¨
                } else {
                    showCompanyMessage('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                showCompanyMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showCompanyMessage(message, type) {
            hideCompanyMessages();
            
            if (type === 'success') {
                document.getElementById('companyResultMessage').textContent = message;
                companyResultArea.style.display = 'block';
            } else {
                document.getElementById('companyErrorMessage').textContent = message;
                companyErrorArea.style.display = 'block';
            }

            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(hideCompanyMessages, 3000);
        }

        // éšè—æ¶ˆæ¯
        function hideCompanyMessages() {
            companyResultArea.style.display = 'none';
            companyErrorArea.style.display = 'none';
        }

        console.log('Company management initialized');

        // ====== èµ„è´¨æ–‡ä»¶ç®¡ç†åŠŸèƒ½ ======
        console.log('Initializing qualification management...');

        // é¢„å®šä¹‰èµ„è´¨ç±»å‹
        const standardQualificationTypes = [
            { key: 'business_license', name: 'è¥ä¸šæ‰§ç…§', icon: 'bi-building' },
            { key: 'legal_id_front', name: 'æ³•äººèº«ä»½è¯_æ­£é¢', icon: 'bi-person-badge' },
            { key: 'legal_id_back', name: 'æ³•äººèº«ä»½è¯_åé¢', icon: 'bi-person-badge' },
            { key: 'auth_id_front', name: 'æˆæƒäººèº«ä»½è¯_æ­£é¢', icon: 'bi-person-check' },
            { key: 'auth_id_back', name: 'æˆæƒäººèº«ä»½è¯_åé¢', icon: 'bi-person-check' },
            { key: 'iso9001', name: 'è´¨é‡ç®¡ç†ä½“ç³»è®¤è¯è¯ä¹¦ï¼ˆISO9001ï¼‰', icon: 'bi-award' },
            { key: 'iso20000', name: 'ä¿¡æ¯æŠ€æœ¯ç®¡ç†ä½“ç³»è®¤è¯è¯ä¹¦ï¼ˆISO20000ï¼‰', icon: 'bi-award' },
            { key: 'iso27001', name: 'ä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³»è®¤è¯è¯ä¹¦ï¼ˆISO27001ï¼‰', icon: 'bi-shield-check' },
            { key: 'credit_dishonest', name: 'ä¿¡ç”¨ä¸­å›½_å¤±ä¿¡è¢«æ‰§è¡Œäºº', icon: 'bi-exclamation-triangle' },
            { key: 'credit_corruption', name: 'ä¿¡ç”¨ä¸­å›½_æ— è´ªæ±¡å—è´¿', icon: 'bi-check-circle' },
            { key: 'credit_tax', name: 'ä¿¡ç”¨ä¸­å›½_é‡å¤§ç¨æ”¶å¤±ä¿¡ä¸»ä½“åå•', icon: 'bi-receipt' },
            { key: 'credit_procurement', name: 'ä¿¡ç”¨ä¸­å›½_æ”¿åºœé‡‡è´­ä¸¥é‡è¿æ³•å¤±ä¿¡è®°å½•åå•', icon: 'bi-building' }
        ];

        let customQualificationCounter = 0;
        let qualificationFiles = {}; // å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶

        // åˆå§‹åŒ–æ ‡å‡†èµ„è´¨é¡¹ç›®
        function initializeStandardQualifications() {
            const container = document.getElementById('standardQualifications');
            container.innerHTML = '';

            standardQualificationTypes.forEach(qual => {
                const qualElement = createQualificationElement(qual.key, qual.name, qual.icon, false);
                container.appendChild(qualElement);
            });
        }

        // åˆ›å»ºèµ„è´¨é¡¹ç›®å…ƒç´ 
        function createQualificationElement(key, name, icon, isCustom) {
            const div = document.createElement('div');
            div.className = 'card mb-3 qualification-item';
            div.dataset.qualKey = key;
            
            div.innerHTML = `
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h6 class="mb-0">
                                <i class="${icon} text-primary"></i> ${name}
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <input type="file" class="form-control form-control-sm qual-file-input" 
                                   accept=".pdf,.jpg,.jpeg,.png,.docx,.doc" 
                                   data-qual-key="${key}">
                        </div>
                        <div class="col-md-4">
                            <div class="btn-group w-100">
                                <button type="button" class="btn btn-sm btn-outline-info view-file-btn" 
                                        style="display: none;" data-qual-key="${key}">
                                    <i class="bi bi-eye"></i> æŸ¥çœ‹
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger delete-file-btn" 
                                        style="display: none;" data-qual-key="${key}">
                                    <i class="bi bi-trash"></i> åˆ é™¤
                                </button>
                                ${isCustom ? `
                                <button type="button" class="btn btn-sm btn-outline-secondary remove-qual-btn" 
                                        data-qual-key="${key}">
                                    <i class="bi bi-x"></i> ç§»é™¤
                                </button>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="file-status" id="status-${key}" style="display: none;">
                                <small class="text-muted">æœªä¸Šä¼ æ–‡ä»¶</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç»‘å®šæ–‡ä»¶è¾“å…¥äº‹ä»¶
            const fileInput = div.querySelector('.qual-file-input');
            fileInput.addEventListener('change', function() {
                handleQualificationFileChange(key, this);
            });

            // ç»‘å®šæŸ¥çœ‹æŒ‰é’®äº‹ä»¶
            const viewBtn = div.querySelector('.view-file-btn');
            if (viewBtn) {
                viewBtn.addEventListener('click', function() {
                    viewQualificationFile(key);
                });
            }

            // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
            const deleteBtn = div.querySelector('.delete-file-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    deleteQualificationFile(key);
                });
            }

            // ç»‘å®šç§»é™¤èµ„è´¨é¡¹æŒ‰é’®äº‹ä»¶ï¼ˆä»…è‡ªå®šä¹‰èµ„è´¨ï¼‰
            const removeBtn = div.querySelector('.remove-qual-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    removeCustomQualification(key);
                });
            }

            return div;
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleQualificationFileChange(key, fileInput) {
            const file = fileInput.files[0];
            const statusDiv = document.getElementById(`status-${key}`);
            const qualElement = fileInput.closest('.qualification-item');
            const viewBtn = qualElement.querySelector('.view-file-btn');
            const deleteBtn = qualElement.querySelector('.delete-file-btn');

            if (file) {
                // éªŒè¯æ–‡ä»¶å¤§å° (10MBé™åˆ¶)
                if (file.size > 10 * 1024 * 1024) {
                    showCompanyMessage('æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„æ–‡ä»¶', 'error');
                    fileInput.value = '';
                    return;
                }

                // å­˜å‚¨æ–‡ä»¶ä¿¡æ¯
                qualificationFiles[key] = {
                    file: file,
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploaded: false
                };

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                statusDiv.innerHTML = `
                    <small class="text-info">
                        <i class="bi bi-file-earmark"></i> å·²é€‰æ‹©: ${file.name} 
                        (${(file.size / 1024).toFixed(1)} KB)
                        <span class="badge bg-warning">å¾…ä¸Šä¼ </span>
                    </small>
                `;
                statusDiv.style.display = 'block';

                // æ˜¾ç¤ºæ“ä½œæŒ‰é’®
                viewBtn.style.display = 'inline-block';
                deleteBtn.style.display = 'inline-block';
            } else {
                // æ¸…é™¤æ–‡ä»¶ä¿¡æ¯
                delete qualificationFiles[key];
                statusDiv.style.display = 'none';
                viewBtn.style.display = 'none';
                deleteBtn.style.display = 'none';
            }
        }

        // æŸ¥çœ‹æ–‡ä»¶
        function viewQualificationFile(key) {
            const fileInfo = qualificationFiles[key];
            if (!fileInfo) {
                showCompanyMessage('æ²¡æœ‰é€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }

            if (fileInfo.server_file) {
                // æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ï¼Œé€šè¿‡APIè·å–
                if (currentCompanyId) {
                    const url = `/api/companies/${currentCompanyId}/qualifications/${key}/download`;
                    window.open(url, '_blank');
                } else {
                    showCompanyMessage('æ— æ³•è·å–æ–‡ä»¶ï¼Œå…¬å¸ä¿¡æ¯ç¼ºå¤±', 'error');
                }
            } else if (fileInfo.file) {
                // æœ¬åœ°é€‰æ‹©çš„æ–‡ä»¶ï¼Œåˆ›å»ºä¸´æ—¶URLé¢„è§ˆ
                const url = URL.createObjectURL(fileInfo.file);
                const newWindow = window.open(url, '_blank');
                if (!newWindow) {
                    showCompanyMessage('æ— æ³•æ‰“å¼€æ–‡ä»¶é¢„è§ˆï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
                }
            } else {
                showCompanyMessage('æ–‡ä»¶ä¸å¯ç”¨', 'error');
            }
        }

        // åˆ é™¤æ–‡ä»¶
        function deleteQualificationFile(key) {
            const fileInfo = qualificationFiles[key];
            if (!fileInfo) {
                showCompanyMessage('æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶ä¿¡æ¯', 'error');
                return;
            }

            if (fileInfo.server_file) {
                if (!confirm('ç¡®å®šè¦ä»æœåŠ¡å™¨åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    return;
                }

                // åˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶
                if (currentCompanyId) {
                    fetch(`/api/companies/${currentCompanyId}/qualifications/${key}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // æ¸…é™¤UIçŠ¶æ€
                            clearQualificationFileUI(key);
                            delete qualificationFiles[key];
                            showCompanyMessage('æœåŠ¡å™¨æ–‡ä»¶å·²åˆ é™¤', 'success');
                        } else {
                            showCompanyMessage('åˆ é™¤æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                        }
                    })
                    .catch(error => {
                        showCompanyMessage('åˆ é™¤æœåŠ¡å™¨æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                    });
                } else {
                    showCompanyMessage('æ— æ³•åˆ é™¤æ–‡ä»¶ï¼Œå…¬å¸ä¿¡æ¯ç¼ºå¤±', 'error');
                }
            } else {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    return;
                }

                // åˆ é™¤æœ¬åœ°é€‰æ‹©çš„æ–‡ä»¶
                clearQualificationFileUI(key);
                delete qualificationFiles[key];
                showCompanyMessage('æ–‡ä»¶å·²åˆ é™¤', 'success');
            }
        }

        // æ¸…é™¤èµ„è´¨æ–‡ä»¶çš„UIçŠ¶æ€
        function clearQualificationFileUI(key) {
            const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
            if (qualElement) {
                const fileInput = qualElement.querySelector('.qual-file-input');
                const statusDiv = document.getElementById(`status-${key}`);
                const viewBtn = qualElement.querySelector('.view-file-btn');
                const deleteBtn = qualElement.querySelector('.delete-file-btn');

                // æ¸…é™¤æ–‡ä»¶è¾“å…¥å’ŒUIçŠ¶æ€
                if (fileInput) fileInput.value = '';
                if (statusDiv) statusDiv.style.display = 'none';
                if (viewBtn) viewBtn.style.display = 'none';
                if (deleteBtn) deleteBtn.style.display = 'none';
            }
        }

        // æ·»åŠ è‡ªå®šä¹‰èµ„è´¨é¡¹
        document.getElementById('addCustomQualificationBtn').addEventListener('click', function() {
            const nameInput = document.getElementById('customQualificationName');
            const name = nameInput.value.trim();

            if (!name) {
                showCompanyMessage('è¯·è¾“å…¥èµ„è´¨åç§°', 'error');
                return;
            }

            // ç”Ÿæˆå”¯ä¸€key
            customQualificationCounter++;
            const key = `custom_${customQualificationCounter}_${Date.now()}`;

            // åˆ›å»ºè‡ªå®šä¹‰èµ„è´¨é¡¹ç›®
            const qualElement = createQualificationElement(key, name, 'bi-file-plus', true);
            document.getElementById('customQualifications').appendChild(qualElement);

            // æ¸…ç©ºè¾“å…¥æ¡†
            nameInput.value = '';

            showCompanyMessage(`å·²æ·»åŠ è‡ªå®šä¹‰èµ„è´¨é¡¹: ${name}`, 'success');
        });

        // ç§»é™¤è‡ªå®šä¹‰èµ„è´¨é¡¹
        function removeCustomQualification(key) {
            if (!confirm('ç¡®å®šè¦ç§»é™¤è¿™ä¸ªèµ„è´¨é¡¹å—ï¼Ÿç›¸å…³æ–‡ä»¶ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) {
                return;
            }

            // åˆ é™¤æ–‡ä»¶è®°å½•
            delete qualificationFiles[key];

            // ç§»é™¤DOMå…ƒç´ 
            const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
            if (qualElement) {
                qualElement.remove();
            }

            showCompanyMessage('èµ„è´¨é¡¹å·²ç§»é™¤', 'success');
        }

        // ä¿å­˜æ‰€æœ‰èµ„è´¨æ–‡ä»¶
        document.getElementById('saveAllQualificationsBtn').addEventListener('click', function() {
            if (!currentCompanyId) {
                showCompanyMessage('è¯·å…ˆä¿å­˜å…¬å¸åŸºæœ¬ä¿¡æ¯', 'error');
                return;
            }

            const fileCount = Object.keys(qualificationFiles).length;
            if (fileCount === 0) {
                showCompanyMessage('æ²¡æœ‰é€‰æ‹©ä»»ä½•èµ„è´¨æ–‡ä»¶', 'error');
                return;
            }

            uploadQualificationFiles();
        });

        // å†…éƒ¨æ¸…ç©ºèµ„è´¨å‡½æ•°ï¼ˆä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ï¼‰
        function clearAllQualificationsInternal() {
            // æ¸…ç©ºæ‰€æœ‰æ–‡ä»¶
            qualificationFiles = {};

            // é‡ç½®æ‰€æœ‰æ–‡ä»¶è¾“å…¥
            document.querySelectorAll('.qual-file-input').forEach(input => {
                input.value = '';
            });

            // éšè—æ‰€æœ‰çŠ¶æ€å’ŒæŒ‰é’®
            document.querySelectorAll('.file-status').forEach(status => {
                status.style.display = 'none';
            });
            document.querySelectorAll('.view-file-btn, .delete-file-btn').forEach(btn => {
                btn.style.display = 'none';
            });

            // ç§»é™¤æ‰€æœ‰è‡ªå®šä¹‰èµ„è´¨é¡¹
            document.getElementById('customQualifications').innerHTML = '';
        }

        // æ¸…ç©ºæ‰€æœ‰èµ„è´¨ï¼ˆå¸¦ç¡®è®¤å¯¹è¯æ¡†ï¼‰
        document.getElementById('clearAllQualificationsBtn').addEventListener('click', function() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èµ„è´¨æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                return;
            }

            clearAllQualificationsInternal();
            showCompanyMessage('æ‰€æœ‰èµ„è´¨æ–‡ä»¶å·²æ¸…ç©º', 'success');
        });

        // ä¸Šä¼ èµ„è´¨æ–‡ä»¶
        function uploadQualificationFiles() {
            const formData = new FormData();
            
            // æ·»åŠ å…¬å¸ID
            formData.append('company_id', currentCompanyId);

            // æ·»åŠ æ‰€æœ‰æ–‡ä»¶
            for (const [key, fileInfo] of Object.entries(qualificationFiles)) {
                if (fileInfo.file) {
                    formData.append(`qualifications[${key}]`, fileInfo.file);
                    
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰èµ„è´¨ï¼Œæ·»åŠ åç§°ä¿¡æ¯
                    if (key.startsWith('custom_')) {
                        const qualElement = document.querySelector(`[data-qual-key="${key}"]`);
                        const qualName = qualElement.querySelector('h6').textContent.replace(/.*\s/, '');
                        formData.append(`qualification_names[${key}]`, qualName);
                    }
                }
            }

            const btn = document.getElementById('saveAllQualificationsBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> ä¸Šä¼ ä¸­...';
            btn.disabled = true;

            fetch(`/api/companies/${currentCompanyId}/qualifications`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°æ–‡ä»¶çŠ¶æ€
                    Object.keys(qualificationFiles).forEach(key => {
                        if (qualificationFiles[key]) {
                            qualificationFiles[key].uploaded = true;
                            updateFileStatus(key);
                        }
                    });

                    showCompanyMessage(`æˆåŠŸä¸Šä¼  ${data.uploaded_count} ä¸ªèµ„è´¨æ–‡ä»¶`, 'success');
                } else {
                    showCompanyMessage('ä¸Šä¼ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            })
            .catch(error => {
                showCompanyMessage('ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        // æ›´æ–°æ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
        function updateFileStatus(key) {
            const fileInfo = qualificationFiles[key];
            const statusDiv = document.getElementById(`status-${key}`);

            if (fileInfo && statusDiv) {
                const statusClass = fileInfo.uploaded ? 'text-success' : 'text-info';
                const statusBadge = fileInfo.uploaded ? 
                    '<span class="badge bg-success">å·²ä¸Šä¼ </span>' : 
                    '<span class="badge bg-warning">å¾…ä¸Šä¼ </span>';

                statusDiv.innerHTML = `
                    <small class="${statusClass}">
                        <i class="bi bi-file-earmark"></i> ${fileInfo.name} 
                        (${(fileInfo.size / 1024).toFixed(1)} KB)
                        ${statusBadge}
                    </small>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            initializeStandardQualifications();
        });

        console.log('Qualification management initialized');

        // =========================
        // å•†åŠ¡åº”ç­”åŠŸèƒ½
        // =========================
        
        // å•†åŠ¡åº”ç­”æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('businessTemplateFile').addEventListener('change', function() {
            const fileName = this.files[0]?.name;
            const fileNameDiv = document.getElementById('businessTemplateFileName');
            if (fileName) {
                fileNameDiv.innerHTML = `<div class="alert alert-info py-2"><i class="bi bi-file-earmark-word"></i> ${fileName}</div>`;
            } else {
                fileNameDiv.innerHTML = '';
            }
        });
        
        // å•†åŠ¡åº”ç­”è¡¨å•æäº¤å¤„ç†
        document.getElementById('businessResponseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const templateFile = document.getElementById('businessTemplateFile').files[0];
            const companyId = document.getElementById('businessCompanySelect').value;
            const projectName = document.getElementById('businessProjectName').value;
            const tenderNo = document.getElementById('businessTenderNo').value;
            const dateText = document.getElementById('businessDate').value;
            const useMcp = 'true'; // é»˜è®¤ä½¿ç”¨MCPå¤„ç†å™¨
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!templateFile) {
                alert('è¯·é€‰æ‹©å•†åŠ¡åº”ç­”æ¨¡æ¿');
                return;
            }
            
            if (!companyId) {
                alert('è¯·é€‰æ‹©åº”ç­”å…¬å¸');
                return;
            }
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            const progress = document.getElementById('businessProgress');
            const result = document.getElementById('businessResult');
            const error = document.getElementById('businessError');
            const stats = document.getElementById('businessStats');
            
            progress.style.display = 'block';
            result.style.display = 'none';
            error.style.display = 'none';
            stats.style.display = 'none';
            
            // æ„å»ºFormData
            const formData = new FormData();
            formData.append('template_file', templateFile);
            formData.append('company_id', companyId);
            formData.append('project_name', projectName);
            formData.append('tender_no', tenderNo);
            formData.append('date_text', dateText);
            formData.append('use_mcp', useMcp);
            
            // å‘é€è¯·æ±‚
            fetch('/process-business-response', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                progress.style.display = 'none';
                
                if (data.success) {
                    // æ˜¾ç¤ºæˆåŠŸç»“æœ
                    document.getElementById('businessResultMessage').textContent = data.message;
                    document.getElementById('businessDownloadLink').href = data.download_url;
                    result.style.display = 'block';
                    
                    // æ˜¾ç¤ºå¤„ç†ç»Ÿè®¡
                    if (data.stats) {
                        const statsContent = document.getElementById('businessStatsContent');
                        let statsHtml = '';
                        
                        if (data.stats.bidder_name) {
                            statsHtml += `<p><strong>æŠ•æ ‡äººåç§°å¡«å†™ï¼š</strong> æ®µè½${data.stats.bidder_name.paragraphs_changed}ä¸ªï¼Œè¡¨æ ¼${data.stats.bidder_name.tables_changed}ä¸ª</p>`;
                        }
                        if (data.stats.project_info) {
                            statsHtml += `<p><strong>é¡¹ç›®ä¿¡æ¯å¡«å†™ï¼š</strong> æ›¿æ¢${data.stats.project_info.replacements_made}é¡¹ï¼ŒæŠ•æ ‡äººå­—æ®µ${data.stats.project_info.bidder_fields_filled}ä¸ª</p>`;
                        }
                        if (data.stats.qualification_images) {
                            statsHtml += `<p><strong>èµ„è´¨å›¾ç‰‡æ’å…¥ï¼š</strong> æ‰¾åˆ°å…³é”®è¯${data.stats.qualification_images.keywords_found}ä¸ªï¼Œæ’å…¥å›¾ç‰‡${data.stats.qualification_images.images_inserted}å¼ </p>`;
                        }
                        
                        if (statsHtml) {
                            statsContent.innerHTML = statsHtml;
                            stats.style.display = 'block';
                        }
                    }
                    
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    loadBusinessFilesList();
                } else {
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    document.getElementById('businessErrorMessage').textContent = data.error || 'å¤„ç†å¤±è´¥';
                    error.style.display = 'block';
                }
            })
            .catch(err => {
                progress.style.display = 'none';
                document.getElementById('businessErrorMessage').textContent = 'ç½‘ç»œé”™è¯¯ï¼š' + err.message;
                error.style.display = 'block';
                console.error('å•†åŠ¡åº”ç­”å¤„ç†å¤±è´¥:', err);
            });
        });
        
        // å•†åŠ¡åº”ç­”"ä¸‹ä¸€æ­¥"æŒ‰é’®ç‚¹å‡»å¤„ç†
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'businessNextStepBtn') {
                // åˆ‡æ¢åˆ°ç‚¹å¯¹ç‚¹åº”ç­”é€‰é¡¹å¡
                const pointToPointTab = document.getElementById('point-to-point-tab');
                if (pointToPointTab) {
                    pointToPointTab.click();
                }
            }
        });
        
        // åŠ è½½å•†åŠ¡åº”ç­”å†å²æ–‡ä»¶
        function loadBusinessFilesList() {
            fetch('/api/business-files')
            .then(response => response.json())
            .then(data => {
                const filesList = document.getElementById('businessFilesList');
                if (data.files && data.files.length > 0) {
                    let html = '<div class="table-responsive"><table class="table table-striped"><thead><tr>';
                    html += '<th>æ–‡ä»¶å</th><th>å¤§å°</th><th>åˆ›å»ºæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
                    
                    data.files.forEach(file => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        html += `<tr>
                            <td>${file.name}</td>
                            <td>${size} MB</td>
                            <td>${date}</td>
                            <td><a href="${file.download_url}" class="btn btn-sm btn-outline-primary">ä¸‹è½½</a></td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table></div>';
                    filesList.innerHTML = html;
                } else {
                    filesList.innerHTML = '<p class="text-muted">æš‚æ— å†å²æ–‡ä»¶</p>';
                }
            })
            .catch(error => {
                console.error('åŠ è½½å•†åŠ¡åº”ç­”æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('businessFilesList').innerHTML = '<p class="text-danger">åŠ è½½å¤±è´¥</p>';
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å•†åŠ¡åº”ç­”é¡µé¢
        function initBusinessResponsePage() {
            // ç¡®ä¿æ‰€æœ‰ç»“æœåŒºåŸŸéƒ½è¢«éšè—
            const businessResult = document.getElementById('businessResult');
            const businessError = document.getElementById('businessError');
            const businessStats = document.getElementById('businessStats');
            const businessProgress = document.getElementById('businessProgress');
            
            if (businessResult) businessResult.style.display = 'none';
            if (businessError) businessError.style.display = 'none';
            if (businessStats) businessStats.style.display = 'none';
            if (businessProgress) businessProgress.style.display = 'none';
        }
        
        // ç›‘å¬å•†åŠ¡åº”ç­”é€‰é¡¹å¡çš„æ˜¾ç¤ºäº‹ä»¶
        document.addEventListener('shown.bs.tab', function(e) {
            if (e.target.id === 'business-response-tab') {
                // å½“åˆ‡æ¢åˆ°å•†åŠ¡åº”ç­”é€‰é¡¹å¡æ—¶ï¼Œç¡®ä¿ç»“æœåŒºåŸŸè¢«éšè—
                initBusinessResponsePage();
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½å•†åŠ¡åº”ç­”æ–‡ä»¶åˆ—è¡¨
        window.addEventListener('load', function() {
            initBusinessResponsePage();
            loadBusinessFilesList();
            
            // æ·»åŠ å•†åŠ¡åº”ç­”å…¬å¸é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
            const businessCompanySelect = document.getElementById('businessCompanySelect');
            if (businessCompanySelect) {
                businessCompanySelect.addEventListener('change', function() {
                    if (this.value) {
                        // å½“é€‰æ‹©å…¬å¸æ—¶ï¼Œè‡ªåŠ¨åŠ è½½é¡¹ç›®ä¿¡æ¯
                        console.log('Company selected for business response:', this.value);
                        loadProjectInfo();
                    } else {
                        // æ¸…ç©ºé¡¹ç›®ä¿¡æ¯å­—æ®µ
                        document.getElementById('businessProjectName').value = '';
                        document.getElementById('businessTenderNo').value = '';
                        document.getElementById('businessDate').value = '';
                    }
                });
            }
        });

    </script>
</body>
</html>