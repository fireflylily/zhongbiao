<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼ä¸šçŸ¥è¯†åº“ç®¡ç† - AIæ ‡ä¹¦ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/litera/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/common.css" rel="stylesheet">
    <style>
        /* ä¸“ä¸šå•†åŠ¡é£é…è‰²æ–¹æ¡ˆ - è¦†ç›–Bootstrapé»˜è®¤é¢œè‰² */
        :root {
            --bs-primary: #4a89dc;
            --bs-primary-rgb: 74, 137, 220;
            --bs-success: #48cfad;
            --bs-success-rgb: 72, 207, 173;
            --bs-warning: #eb7d3c;
            --bs-warning-rgb: 235, 125, 60;
            --bs-danger: #da4453;
            --bs-danger-rgb: 218, 68, 83;
            --bs-info: #5dade2;
            --bs-info-rgb: 93, 173, 226;
        }

        /* å¯¼èˆªæ æ ·å¼ç»Ÿä¸€ */
        .sidebar-toggle-btn {
            background: none;
            border: 1px solid #dee2e6;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .sidebar-toggle-btn:hover {
            background-color: #f8f9fa;
            border-color: #4a89dc;
            color: #4a89dc;
        }
        .unicom-logo svg {
            max-height: 40px;
        }
        .brand-text .brand-title {
            color: #333;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 2px;
        }
        .brand-text .brand-subtitle {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .dropdown-menu {
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        .dropdown-item {
            padding: 10px 16px;
            transition: all 0.2s ease;
        }
        .dropdown-item:hover {
            background-color: #f8f9fa;
            color: #4a89dc;
        }
        .dropdown-item.active {
            background-color: #4a89dc;
            color: white;
        }
        .dropdown-item i {
            width: 16px;
            text-align: center;
        }

        .kb-sidebar {
            min-height: calc(100vh - 100px);
        }
        /* ä½¿ç”¨ Bootstrap çš„ list-group ç»„ä»¶ï¼Œä¸éœ€è¦è‡ªå®šä¹‰æ ·å¼ */
        /* ä½¿ç”¨ Bootstrap Card ç»„ä»¶ï¼Œä¸éœ€è¦è‡ªå®šä¹‰æ ·å¼ */
        /* å››çº§éšç§åˆ†ç±»UIæ ‡è¯†æ ·å¼ */
        .privacy-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }
        .privacy-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        /* 1:å…¬å¼€ğŸŒ - æŸ”å’Œé’ç»¿è‰² */
        .privacy-1 {
            background: linear-gradient(135deg, #48cfad, #5dade2);
            color: white;
            border: 1px solid #3ea99f;
        }
        .privacy-1::before { content: "ğŸŒ"; margin-right: 2px; }

        /* 2:å†…éƒ¨ğŸ¢ - ä½é¥±å’Œåº¦è“è‰² */
        .privacy-2 {
            background: linear-gradient(135deg, #4a89dc, #74b9ff);
            color: white;
            border: 1px solid #3d6cb9;
        }
        .privacy-2::before { content: "ğŸ¢"; margin-right: 2px; }

        /* 3:æœºå¯†ğŸ”’ - æ²‰ç¨³æ©˜çº¢è‰² */
        .privacy-3 {
            background: linear-gradient(135deg, #eb7d3c, #f39c12);
            color: white;
            border: 1px solid #d35400;
        }
        .privacy-3::before { content: "ğŸ”’"; margin-right: 2px; }

        /* 4:ç»å¯†ğŸš« - æš—çº¢è‰² */
        .privacy-4 {
            background: linear-gradient(135deg, #da4453, #e74c3c);
            color: white;
            border: 1px solid #c0392b;
        }
        .privacy-4::before { content: "ğŸš«"; margin-right: 2px; }

        /* æ–‡æ¡£åˆ†ç±»æ ‡è¯†æ ·å¼ */
        .doc-category-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
            margin-left: 5px;
        }
        .doc-category-tech::before { content: "ğŸ”§"; margin-right: 2px; }
        .doc-category-impl::before { content: "ğŸ“‹"; margin-right: 2px; }
        .doc-category-service::before { content: "ğŸ› ï¸"; margin-right: 2px; }
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background-color: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .upload-zone:hover {
            border-color: #4a89dc;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(74, 137, 220, 0.1);
        }
        .upload-zone.dragover {
            background-color: #f4f7ff;
            border-color: #4a89dc;
        }

        /* å¢å¼ºçš„äº¤äº’å…ƒç´ æ ·å¼ */
        .btn-primary {
            background: linear-gradient(135deg, #4a89dc, #74b9ff);
            border: none;
            box-shadow: 0 2px 4px rgba(74, 137, 220, 0.2);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #3d6cb9, #4a89dc);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 137, 220, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #48cfad, #5dade2);
            border: none;
            box-shadow: 0 2px 4px rgba(72, 207, 173, 0.2);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #3ea99f, #48cfad);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(72, 207, 173, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #eb7d3c, #f39c12);
            border: none;
            box-shadow: 0 2px 4px rgba(235, 125, 60, 0.2);
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #d35400, #eb7d3c);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(235, 125, 60, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #da4453, #e74c3c);
            border: none;
            box-shadow: 0 2px 4px rgba(218, 68, 83, 0.2);
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b, #da4453);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(218, 68, 83, 0.3);
        }

        /* å¡ç‰‡æ‚¬æµ®æ•ˆæœä¼˜åŒ– */
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* ç»Ÿè®¡å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
        .kb-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        }

        /* æœç´¢ç•Œé¢å¢å¼ºæ ·å¼ */
        .search-modal-header {
            background: linear-gradient(135deg, #4a89dc, #74b9ff);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        /* æœç´¢æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ ·å¼ */
        .btn-check:checked + .btn-outline-primary {
            background: linear-gradient(135deg, #4a89dc, #74b9ff);
            border-color: #4a89dc;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(74, 137, 220, 0.25);
        }

        /* é«˜çº§é€‰é¡¹å±•å¼€åŒºåŸŸ */
        .search-advanced-options {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        /* æœç´¢ç»“æœå¡ç‰‡å¢å¼º */
        .search-result-card {
            border: 1px solid #e9ecef;
            border-radius: 12px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .search-result-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #4a89dc;
        }

        /* ç›¸ä¼¼åº¦è¯„åˆ†é¢œè‰²æ¸å˜ */
        .similarity-score-high {
            background: linear-gradient(135deg, #48cfad, #5dade2);
        }

        .similarity-score-medium {
            background: linear-gradient(135deg, #4a89dc, #74b9ff);
        }

        .similarity-score-low {
            background: linear-gradient(135deg, #eb7d3c, #f39c12);
        }

        /* æœç´¢å†å²æŒ‰é’®æ ·å¼ */
        .search-history-btn {
            border: 1px solid #dee2e6;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            transition: all 0.2s ease;
        }

        .search-history-btn:hover {
            background: linear-gradient(135deg, #4a89dc, #74b9ff);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(74, 137, 220, 0.2);
        }

        /* åŠ è½½åŠ¨ç”»å¢å¼º */
        .search-loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a89dc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æœç´¢ç»Ÿè®¡ä¿¡æ¯æ ·å¼ */
        .search-stats {
            background: linear-gradient(135deg, #48cfad, #5dade2);
            border-radius: 8px;
            color: white;
        }

        /* æ–‡æ¡£ç±»å‹å¾½ç« æ ·å¼ */
        .doc-type-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 8px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top">
        <div class="container-fluid">
            <button class="btn sidebar-toggle-btn me-3" type="button" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>

            <div class="navbar-brand d-flex align-items-center">
                <!-- ä¸­å›½è”é€šå®˜æ–¹Logo -->
                <div class="unicom-logo me-3">
                    <svg width="120" height="40" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="unicomKnotGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#4a89dc;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#3d6cb9;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2c5282;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <!-- ä¸­å›½è”é€šç»“ç»³æ ‡å¿— -->
                        <g transform="translate(5, 5)">
                            <path d="M25 5 C35 5, 45 15, 45 25 C45 35, 35 45, 25 45 C15 45, 5 35, 5 25"
                                  fill="none" stroke="url(#unicomKnotGradient)" stroke-width="3"/>
                            <path d="M25 15 C30 15, 35 20, 35 25 C35 30, 30 35, 25 35"
                                  fill="none" stroke="url(#unicomKnotGradient)" stroke-width="2"/>
                            <circle cx="20" cy="25" r="3" fill="url(#unicomKnotGradient)"/>
                            <circle cx="30" cy="25" r="3" fill="url(#unicomKnotGradient)"/>
                        </g>
                        <!-- ä¸­å›½è”é€šæ–‡å­— -->
                        <g transform="translate(65, 20)">
                            <text x="0" y="0" font-family="'Microsoft YaHei', sans-serif" font-size="16" font-weight="bold" fill="#4a89dc">ä¸­å›½è”é€š</text>
                            <text x="0" y="18" font-family="'Microsoft YaHei', sans-serif" font-size="10" fill="#666">CHINA UNICOM</text>
                        </g>
                    </svg>
                </div>
                <div class="brand-text ms-2">
                    <h6 class="brand-title mb-0">å…ƒæ™¯AIæ™ºèƒ½æ ‡ä¹¦ç”Ÿæˆå¹³å°</h6>
                    <small class="brand-subtitle text-muted">ä¼ä¸šçŸ¥è¯†åº“ç®¡ç†</small>
                </div>
            </div>

            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        åº”ç”¨èœå•
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/"><i class="bi bi-house me-2"></i>æ ‡ä¹¦ç”Ÿæˆ</a></li>
                        <li><a class="dropdown-item active" href="/knowledge_base"><i class="bi bi-collection me-2"></i>çŸ¥è¯†åº“ç®¡ç†</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>ç³»ç»Ÿè®¾ç½®</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="margin-top: 70px; min-height: calc(100vh - 70px);">
        <div class="row g-0">
            <!-- å·¦ä¾§æ ‘å½¢å¯¼èˆª -->
            <div class="col-md-3 p-0">
                <div class="card shadow-sm border-0 h-100" style="border-radius: 0;">
                    <div class="card-header bg-white border-0 p-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="bi bi-diagram-3 text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0 fw-bold">ä¼ä¸šç›®å½•</h6>
                                    <small class="text-muted">Knowledge Base</small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary rounded-pill" onclick="showAddCompanyModal()" title="æ·»åŠ ä¼ä¸š">
                                <i class="bi bi-plus fw-bold"></i>
                            </button>
                        </div>
                    </div>

                    <div class="card-body p-0" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                        <div class="p-3">
                            <div id="companyTree">
                                <!-- ä¼ä¸šæ ‘å½¢ç»“æ„ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ¸²æŸ“ -->
                                <div class="text-center py-5">
                                    <div class="mb-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-0">æ­£åœ¨åŠ è½½ä¼ä¸šæ•°æ®...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¯¼èˆªåº•éƒ¨æ“ä½œåŒºåŸŸ - å·²ç§»è‡³å³ä¾§å†…å®¹åŒº -->
                    <!-- <div class="card-footer bg-light border-0 p-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="showSearchModal()">
                                <i class="bi bi-search me-2"></i>å…¨å±€æœç´¢
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="refreshKnowledgeBase()">
                                <i class="bi bi-arrow-clockwise me-2"></i>åˆ·æ–°æ•°æ®
                            </button>
                        </div>
                    </div> -->
                </div>
            </div>

            <!-- å³ä¾§å†…å®¹åŒº -->
            <div class="col-md-9 p-4 bg-light" style="border-left: 1px solid #dee2e6;">

                <!-- ä¸»å†…å®¹åŒº -->
                <div id="mainContent">
                    <!-- é»˜è®¤æ˜¾ç¤ºæ¬¢è¿é¡µé¢ -->
                    <div class="container-fluid px-0">
                        <!-- é¡µé¢å¤´éƒ¨ -->
                        <div class="row mb-4">
                            <div class="col-lg-8">
                                <div class="card shadow-sm border-0">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                                                <i class="bi bi-collection text-primary fs-3"></i>
                                            </div>
                                            <div>
                                                <h2 class="mb-1 fw-bold">ä¼ä¸šçŸ¥è¯†åº“ç®¡ç†ç³»ç»Ÿ</h2>
                                                <p class="text-muted mb-0 fs-6">æ™ºèƒ½æ–‡æ¡£ç®¡ç†ï¼ŒåŠ©åŠ›ä¼ä¸šæ•°å­—åŒ–è½¬å‹</p>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                                                <i class="bi bi-shield-check me-1"></i>å®‰å…¨å­˜å‚¨
                                            </span>
                                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                                                <i class="bi bi-search me-1"></i>æ™ºèƒ½æ£€ç´¢
                                            </span>
                                            <span class="badge bg-info bg-opacity-10 text-info px-3 py-2 rounded-pill">
                                                <i class="bi bi-people me-1"></i>ååŒç®¡ç†
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body p-4 text-center d-flex flex-column justify-content-center">
                                        <i class="bi bi-arrow-left-circle text-primary fs-1 mb-3"></i>
                                        <h6 class="mb-2">éœ€è¦ç”Ÿæˆæ ‡ä¹¦ï¼Ÿ</h6>
                                        <p class="text-muted small mb-3">å¿«é€Ÿè¿”å›æ ‡ä¹¦ç”Ÿæˆé¡µé¢</p>
                                        <a href="/" class="btn btn-primary btn-sm">
                                            <i class="bi bi-arrow-left me-2"></i>è¿”å›æ ‡ä¹¦ç”Ÿæˆ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- å…³é”®æ•°æ®ç»Ÿè®¡ - å¤§å¡ç‰‡è®¾è®¡ -->
                        <div class="row g-4 mb-5" id="statisticsOverview">
                            <div class="col-xl-3 col-md-6">
                                <div class="card shadow-sm border-0 kb-stat-card h-100">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small fw-medium mb-1">ä¼ä¸šæ€»æ•°</div>
                                                <div class="display-6 fw-bold text-primary" id="totalCompanies">0</div>
                                                <div class="text-success small mt-1">
                                                    <i class="bi bi-arrow-up me-1"></i>
                                                    <span>æ´»è·ƒç®¡ç†</span>
                                                </div>
                                            </div>
                                            <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                                                <i class="bi bi-building text-primary fs-2"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card shadow-sm border-0 kb-stat-card h-100">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small fw-medium mb-1">äº§å“æ€»æ•°</div>
                                                <div class="display-6 fw-bold text-success" id="totalProducts">0</div>
                                                <div class="text-info small mt-1">
                                                    <i class="bi bi-graph-up me-1"></i>
                                                    <span>æŒç»­å¢é•¿</span>
                                                </div>
                                            </div>
                                            <div class="bg-success bg-opacity-10 rounded-3 p-3">
                                                <i class="bi bi-box-seam text-success fs-2"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card shadow-sm border-0 kb-stat-card h-100">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small fw-medium mb-1">æ–‡æ¡£æ€»æ•°</div>
                                                <div class="display-6 fw-bold text-info" id="totalDocuments">0</div>
                                                <div class="text-primary small mt-1">
                                                    <i class="bi bi-cloud-check me-1"></i>
                                                    <span>äº‘ç«¯å­˜å‚¨</span>
                                                </div>
                                            </div>
                                            <div class="bg-info bg-opacity-10 rounded-3 p-3">
                                                <i class="bi bi-file-earmark-text text-info fs-2"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card shadow-sm border-0 kb-stat-card h-100">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small fw-medium mb-1">æœºå¯†æ–‡æ¡£</div>
                                                <div class="display-6 fw-bold text-warning" id="confidentialDocs">0</div>
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-shield-lock me-1"></i>
                                                    <span>å®‰å…¨ä¿æŠ¤</span>
                                                </div>
                                            </div>
                                            <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                                                <i class="bi bi-shield-lock text-warning fs-2"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- åŠŸèƒ½ç‰¹æ€§åŒºåŸŸ -->
                        <div class="row g-4">
                            <div class="col-lg-4">
                                <div class="card shadow-sm border-0 feature-card h-100 overflow-hidden">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="bi bi-building text-primary fs-3"></i>
                                            </div>
                                            <h5 class="mb-0 fw-bold">ä¼ä¸šä¿¡æ¯åº“</h5>
                                        </div>
                                        <p class="text-muted mb-4">é›†ä¸­ç®¡ç†ä¼ä¸šåŸºç¡€ä¿¡æ¯ã€èµ„è´¨è¯ä¹¦ã€äººå‘˜æ¡£æ¡ˆå’Œè´¢åŠ¡æ–‡æ¡£ï¼Œå»ºç«‹å®Œæ•´çš„ä¼ä¸šæ•°å­—åŒ–æ¡£æ¡ˆç³»ç»Ÿ</p>
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <div class="d-flex align-items-center p-2 rounded bg-success bg-opacity-10">
                                                    <i class="bi bi-globe text-success me-2"></i>
                                                    <small class="fw-medium text-success">åŸºç¡€ä¿¡æ¯</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center p-2 rounded bg-primary bg-opacity-10">
                                                    <i class="bi bi-award text-primary me-2"></i>
                                                    <small class="fw-medium text-primary">èµ„è´¨è¯ä¹¦</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center p-2 rounded bg-warning bg-opacity-10">
                                                    <i class="bi bi-people text-warning me-2"></i>
                                                    <small class="fw-medium text-warning">äººå‘˜ä¿¡æ¯</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center p-2 rounded bg-danger bg-opacity-10">
                                                    <i class="bi bi-bank text-danger me-2"></i>
                                                    <small class="fw-medium text-danger">è´¢åŠ¡æ–‡æ¡£</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card shadow-sm border-0 feature-card h-100 overflow-hidden">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="bi bi-box-seam text-success fs-3"></i>
                                            </div>
                                            <h5 class="mb-0 fw-bold">äº§å“çŸ¥è¯†åº“</h5>
                                        </div>
                                        <p class="text-muted mb-4">ç³»ç»ŸåŒ–ç®¡ç†äº§å“æŠ€æœ¯æ–‡æ¡£ã€å®æ–½æ–¹æ¡ˆå’ŒæœåŠ¡æ‰‹å†Œï¼Œæ„å»ºå…¨æ–¹ä½çš„äº§å“çŸ¥è¯†ä½“ç³»</p>
                                        <div class="d-flex flex-column gap-2 mb-3">
                                            <div class="d-flex align-items-center p-2 rounded bg-light">
                                                <i class="bi bi-gear text-primary me-3 fs-5"></i>
                                                <div>
                                                    <div class="fw-medium small">ğŸ”§ æŠ€æœ¯æ–‡æ¡£</div>
                                                    <div class="text-muted" style="font-size: 0.75rem;">æŠ€æœ¯è§„æ ¼ã€æ¶æ„è®¾è®¡</div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center p-2 rounded bg-light">
                                                <i class="bi bi-clipboard-check text-warning me-3 fs-5"></i>
                                                <div>
                                                    <div class="fw-medium small">ğŸ“‹ å®æ–½æ–¹æ¡ˆ</div>
                                                    <div class="text-muted" style="font-size: 0.75rem;">éƒ¨ç½²æŒ‡å—ã€é…ç½®è¯´æ˜</div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center p-2 rounded bg-light">
                                                <i class="bi bi-tools text-info me-3 fs-5"></i>
                                                <div>
                                                    <div class="fw-medium small">ğŸ› ï¸ æœåŠ¡æ–‡æ¡£</div>
                                                    <div class="text-muted" style="font-size: 0.75rem;">å”®åæ”¯æŒã€ç»´æŠ¤æ‰‹å†Œ</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card shadow-sm border-0 feature-card h-100 overflow-hidden">
                                    <div class="card-body p-4 d-flex flex-column">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="bi bi-search text-info fs-3"></i>
                                            </div>
                                            <h5 class="mb-0 fw-bold">æ™ºèƒ½æ£€ç´¢</h5>
                                        </div>
                                        <p class="text-muted mb-4 flex-grow-1">åŸºäºAIçš„è¯­ä¹‰æ£€ç´¢å’ŒçŸ¥è¯†é—®ç­”ç³»ç»Ÿï¼Œå¿«é€Ÿå®šä½æ‰€éœ€æ–‡æ¡£å’Œä¿¡æ¯</p>
                                        <div class="mb-4">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-lightning-charge text-warning me-2"></i>
                                                <small class="fw-medium">è¯­ä¹‰ç†è§£æ£€ç´¢</small>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-chat-dots text-primary me-2"></i>
                                                <small class="fw-medium">æ™ºèƒ½é—®ç­”ç³»ç»Ÿ</small>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-funnel text-success me-2"></i>
                                                <small class="fw-medium">ç²¾å‡†æƒé™è¿‡æ»¤</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-info w-100" onclick="showSearchModal()">
                                            <i class="bi bi-search me-2"></i>å¼€å§‹æ™ºèƒ½æ£€ç´¢
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å…¬å¸æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addCompanyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å¢ä¼ä¸š</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCompanyForm">
                        <div class="mb-3">
                            <label for="companyName" class="form-label">ä¼ä¸šåç§° <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="companyCode" class="form-label">ä¼ä¸šä»£ç </label>
                            <input type="text" class="form-control" id="companyCode">
                        </div>
                        <div class="mb-3">
                            <label for="industryType" class="form-label">è¡Œä¸šç±»å‹</label>
                            <select class="form-control" id="industryType">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="telecommunications">ç”µä¿¡é€šä¿¡</option>
                                <option value="it_software">ä¿¡æ¯æŠ€æœ¯</option>
                                <option value="manufacturing">åˆ¶é€ ä¸š</option>
                                <option value="finance">é‡‘èæœåŠ¡</option>
                                <option value="healthcare">åŒ»ç–—å¥åº·</option>
                                <option value="education">æ•™è‚²åŸ¹è®­</option>
                                <option value="government">æ”¿åºœæœºæ„</option>
                                <option value="other">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="companyDesc" class="form-label">ä¼ä¸šæè¿°</label>
                            <textarea class="form-control" id="companyDesc" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="addCompany()">ç¡®å®šæ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ äº§å“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å¢äº§å“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label for="productName" class="form-label">äº§å“åç§° <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="productCode" class="form-label">äº§å“ä»£ç </label>
                            <input type="text" class="form-control" id="productCode">
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label">äº§å“ç±»åˆ«</label>
                            <select class="form-control" id="productCategory">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="communication">é€šä¿¡äº§å“</option>
                                <option value="cloud">äº‘è®¡ç®—å¹³å°</option>
                                <option value="bigdata">å¤§æ•°æ®å¹³å°</option>
                                <option value="ai">äººå·¥æ™ºèƒ½</option>
                                <option value="iot">ç‰©è”ç½‘</option>
                                <option value="security">ç½‘ç»œå®‰å…¨</option>
                                <option value="software">è½¯ä»¶äº§å“</option>
                                <option value="hardware">ç¡¬ä»¶è®¾å¤‡</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="productDesc" class="form-label">äº§å“æè¿°</label>
                            <textarea class="form-control" id="productDesc" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="addProduct()">ç¡®å®šæ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–‡æ¡£ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="modal fade" id="uploadDocumentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ä¸Šä¼ æ–‡æ¡£</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="kb-upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <i class="bi bi-cloud-upload fs-1 text-primary"></i>
                        <h5 class="mt-3">ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œä¸Šä¼ </h5>
                        <p class="text-muted">æ”¯æŒ PDFã€Word æ–‡æ¡£</p>
                        <input type="file" id="fileInput" class="d-none" accept=".pdf,.doc,.docx" multiple>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">éšç§åˆ†çº§ <span class="text-danger">*</span></label>
                            <select class="form-control" id="privacyLevel">
                                <option value="1">ğŸŒ å…¬å¼€ - æ‰€æœ‰ç”¨æˆ·å¯è®¿é—®</option>
                                <option value="2">ğŸ¢ å†…éƒ¨ - å†…éƒ¨ç”¨æˆ·å¯è®¿é—®</option>
                                <option value="3">ğŸ”’ æœºå¯† - ç®¡ç†å‘˜å¯è®¿é—®</option>
                                <option value="4">ğŸš« ç»å¯† - è¶…çº§ç®¡ç†å‘˜å¯è®¿é—®</option>
                            </select>
                            <small class="form-text text-muted">é€‰æ‹©åˆé€‚çš„éšç§çº§åˆ«ï¼Œå½±å“æ–‡æ¡£è®¿é—®æƒé™</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">æ–‡æ¡£åˆ†ç±» <span class="text-danger">*</span></label>
                            <select class="form-control" id="documentCategory">
                                <option value="tech">ğŸ”§ æŠ€æœ¯æ–‡æ¡£ - æŠ€æœ¯è§„æ ¼ã€æ¶æ„è®¾è®¡</option>
                                <option value="impl">ğŸ“‹ å®æ–½æ–¹æ¡ˆ - éƒ¨ç½²æŒ‡å—ã€é…ç½®è¯´æ˜</option>
                                <option value="service">ğŸ› ï¸ æœåŠ¡æ–‡æ¡£ - å”®åæ”¯æŒã€ç»´æŠ¤æ‰‹å†Œ</option>
                            </select>
                            <small class="form-text text-muted">é€‰æ‹©æ–‡æ¡£ç±»å‹ï¼Œä¾¿äºåˆ†ç±»ç®¡ç†</small>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">æ–‡æ¡£æ ‡ç­¾</label>
                        <input type="text" class="form-control" id="documentTags" placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”">
                    </div>

                    <div id="fileList" class="mt-3"></div>

                    <!-- ä¸Šä¼ è¿›åº¦æ˜¾ç¤º -->
                    <div id="uploadProgress" class="mt-3 d-none">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="progress-text">å‡†å¤‡ä¸Šä¼ ...</span>
                            <span class="progress-percent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="uploadDocuments()">å¼€å§‹ä¸Šä¼ </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let currentCompanyId = null;
        let currentProductId = null;
        let currentLibraryId = null;
        let selectedFiles = [];

        // åˆå§‹åŒ–
        window.onload = function() {
            loadCompanies();
            setupUploadZone();
        };

        // åŠ è½½å…¬å¸åˆ—è¡¨
        async function loadCompanies() {
            try {
                const response = await axios.get('/api/knowledge_base/companies');
                if (response.data.success) {
                    renderCompanyTree(response.data.data);
                }
            } catch (error) {
                console.error('åŠ è½½å…¬å¸åˆ—è¡¨å¤±è´¥:', error);
                showAlert('åŠ è½½å…¬å¸åˆ—è¡¨å¤±è´¥', 'danger');
            }
        }

        // æ¸²æŸ“å…¬å¸æ ‘å½¢ç»“æ„
        function renderCompanyTree(companies) {
            const treeHtml = companies.map(company => {
                return '<div class="list-group mb-3">' +
                    '<!-- ä¼ä¸šèŠ‚ç‚¹ -->' +
                    '<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"' +
                         ' onclick="toggleCompanyNode(' + company.company_id + ', \'' + company.company_name + '\')">' +
                        '<div class="d-flex align-items-center">' +
                            '<i class="bi bi-chevron-right tree-toggle me-2" id="toggle-' + company.company_id + '"></i>' +
                            '<i class="bi bi-building text-primary me-2"></i>' +
                            '<span class="fw-medium">' + company.company_name + '</span>' +
                            '<span class="badge bg-secondary ms-2">' + (company.product_count || 0) + '</span>' +
                        '</div>' +
                        '<div class="btn-group">' +
                            '<button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); showCompanyProfileModal(' + company.company_id + ')" title="ä¼ä¸šä¿¡æ¯åº“">' +
                                '<i class="bi bi-person-workspace"></i>' +
                            '</button>' +
                            '<button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showAddProductModal(' + company.company_id + ')" title="æ·»åŠ äº§å“">' +
                                '<i class="bi bi-plus"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +

                    '<!-- ä¼ä¸šä¿¡æ¯åº“èŠ‚ç‚¹ -->' +
                    '<div class="ms-3 d-none" id="company-profile-' + company.company_id + '">' +
                        '<div class="list-group-item list-group-item-action" onclick="selectCompanyProfile(' + company.company_id + ')">' +
                            '<div class="d-flex align-items-center">' +
                                '<i class="bi bi-person-workspace text-info me-2"></i>' +
                                '<span>ä¼ä¸šä¿¡æ¯åº“</span>' +
                                '<div class="ms-2">' +
                                    '<span class="privacy-badge privacy-1 me-1 small">åŸºç¡€</span>' +
                                    '<span class="privacy-badge privacy-2 me-1 small">èµ„è´¨</span>' +
                                    '<span class="privacy-badge privacy-3 me-1 small">äººå‘˜</span>' +
                                    '<span class="privacy-badge privacy-4 small">è´¢åŠ¡</span>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- äº§å“èŠ‚ç‚¹å®¹å™¨ -->' +
                    '<div class="ms-3 d-none" id="products-' + company.company_id + '"></div>' +
                '</div>';
            }).join('');

            document.getElementById('companyTree').innerHTML = treeHtml || '<p class="text-muted">æš‚æ— ä¼ä¸šæ•°æ®</p>';
        }

        // åˆ‡æ¢å…¬å¸èŠ‚ç‚¹å±•å¼€/æ”¶èµ·
        function toggleCompanyNode(companyId, companyName) {
            const toggleIcon = document.getElementById('toggle-' + companyId);
            const profileContainer = document.getElementById('company-profile-' + companyId);
            const productsContainer = document.getElementById('products-' + companyId);

            const isExpanded = !profileContainer.classList.contains('d-none');

            if (isExpanded) {
                // æ”¶èµ·
                toggleIcon.className = 'bi bi-chevron-right tree-toggle me-2';
                profileContainer.classList.add('d-none');
                productsContainer.classList.add('d-none');
            } else {
                // å±•å¼€
                toggleIcon.className = 'bi bi-chevron-down tree-toggle me-2';
                profileContainer.classList.remove('d-none');
                productsContainer.classList.remove('d-none');

                // åŠ è½½äº§å“åˆ—è¡¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼‰
                loadCompanyProducts(companyId);
            }

            // æ›´æ–°å½“å‰é€‰ä¸­çš„å…¬å¸
            currentCompanyId = companyId;
            selectCompany(companyId, companyName);
        }

        // é€‰æ‹©å…¬å¸
        async function selectCompany(companyId, companyName) {
            currentCompanyId = companyId;
            currentProductId = null;

            // æ›´æ–°æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tree-node').forEach(node => node.classList.remove('active'));
            document.querySelector('[onclick*="toggleCompanyNode(' + companyId + '"]').classList.add('active');


            // åŠ è½½å…¬å¸è¯¦æƒ…
            try {
                const response = await axios.get('/api/knowledge_base/companies/' + companyId);
                if (response.data.success) {
                    const company = response.data.data;
                    renderCompanyDetail(company);
                }
            } catch (error) {
                console.error('åŠ è½½å…¬å¸è¯¦æƒ…å¤±è´¥:', error);
                showAlert('åŠ è½½å…¬å¸è¯¦æƒ…å¤±è´¥', 'danger');
            }
        }

        // åŠ è½½å…¬å¸äº§å“åˆ—è¡¨
        async function loadCompanyProducts(companyId) {
            try {
                const response = await axios.get('/api/knowledge_base/companies/' + companyId + '/products');
                if (response.data.success) {
                    renderProductTree(companyId, response.data.data);
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“äº§å“æ ‘å½¢ç»“æ„
        function renderProductTree(companyId, products) {
            const treeHtml = products.map(product =>
                '<div class="list-group mb-2">' +
                    '<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"' +
                         ' onclick="selectProduct(' + product.product_id + ', \'' + product.product_name + '\')">' +
                        '<div class="d-flex align-items-center">' +
                            '<i class="bi bi-box-seam text-success me-2"></i>' +
                            '<span>' + product.product_name + '</span>' +
                            '<span class="badge bg-info ms-2">' + (product.document_count || 0) + '</span>' +
                        '</div>' +
                        '<div class="d-flex">' +
                            '<span class="badge bg-light text-secondary me-1">ğŸ”§</span>' +
                            '<span class="badge bg-light text-secondary me-1">ğŸ“‹</span>' +
                            '<span class="badge bg-light text-secondary">ğŸ› ï¸</span>' +
                        '</div>' +
                    '</div>' +

                    '<!-- äº§å“æ–‡æ¡£åˆ†ç±» -->' +
                    '<div class="ms-4 d-none" id="product-categories-' + product.product_id + '">' +
                        '<div class="list-group-item list-group-item-action" onclick="selectProductCategory(' + product.product_id + ', \'tech\')">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<div class="d-flex align-items-center">' +
                                    '<i class="bi bi-gear text-primary me-2"></i>' +
                                    '<span>ğŸ”§ æŠ€æœ¯æ–‡æ¡£</span>' +
                                '</div>' +
                                '<span class="badge bg-light text-dark">' + (product.tech_docs_count || 0) + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="list-group-item list-group-item-action" onclick="selectProductCategory(' + product.product_id + ', \'impl\')">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<div class="d-flex align-items-center">' +
                                    '<i class="bi bi-clipboard-check text-warning me-2"></i>' +
                                    '<span>ğŸ“‹ å®æ–½æ–¹æ¡ˆ</span>' +
                                '</div>' +
                                '<span class="badge bg-light text-dark">' + (product.impl_docs_count || 0) + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="list-group-item list-group-item-action" onclick="selectProductCategory(' + product.product_id + ', \'service\')">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<div class="d-flex align-items-center">' +
                                    '<i class="bi bi-tools text-info me-2"></i>' +
                                    '<span>ğŸ› ï¸ æœåŠ¡æ–‡æ¡£</span>' +
                                '</div>' +
                                '<span class="badge bg-light text-dark">' + (product.service_docs_count || 0) + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>'
            ).join('');

            const productsContainer = document.getElementById('products-' + companyId);
            if (productsContainer) {
                productsContainer.innerHTML = treeHtml || '<p class="text-muted text-center py-2">æš‚æ— äº§å“</p>';
            }
        }

        // é€‰æ‹©ä¼ä¸šä¿¡æ¯åº“
        async function selectCompanyProfile(companyId) {
            currentCompanyId = companyId;
            currentProductId = null;

            // æ›´æ–°æ´»åŠ¨çŠ¶æ€
            document.querySelectorAll('.tree-node').forEach(node => node.classList.remove('active'));
            document.querySelector('[onclick*="selectCompanyProfile(' + companyId + '"]').classList.add('active');


            // åŠ è½½ä¼ä¸šä¿¡æ¯åº“
            try {
                // ç›´æ¥è°ƒç”¨æ¸²æŸ“å‡½æ•°ï¼Œä¸ä¾èµ–åç«¯API
                renderCompanyProfiles([]);
            } catch (error) {
                console.error('åŠ è½½ä¼ä¸šä¿¡æ¯åº“å¤±è´¥:', error);
                showAlert('åŠ è½½ä¼ä¸šä¿¡æ¯åº“å¤±è´¥', 'danger');
            }
        }

        // æ¸²æŸ“ä¼ä¸šä¿¡æ¯åº“ï¼ˆå¢å¼ºç‰ˆTabåˆ‡æ¢ï¼‰
        async function renderCompanyProfiles(profiles) {
            // å…ˆè·å–å…¬å¸è¯¦ç»†ä¿¡æ¯
            let companyData = null;
            try {
                const response = await axios.get('/api/knowledge_base/companies/' + currentCompanyId);
                if (response.data.success && response.data.data) {
                    companyData = response.data.data;
                    console.log('å…¬å¸æ•°æ®åŠ è½½æˆåŠŸ:', companyData);
                } else {
                    console.log('å…¬å¸æ•°æ®æ ¼å¼å¼‚å¸¸:', response.data);
                }
            } catch (error) {
                console.error('è·å–å…¬å¸è¯¦æƒ…å¤±è´¥:', error);
                // å¦‚æœAPIå¤±è´¥ï¼Œæä¾›ä¸€ä¸ªåŸºç¡€çš„æ•°æ®ç»“æ„
                companyData = {
                    company_name: 'æ™ºæ…§è¶³åŠ¨æ•°æ®ç§‘æŠ€æœ‰é™å…¬å¸',
                    company_id: currentCompanyId
                };
            }

            const html = renderEnhancedCompanyProfile(companyData);

            document.getElementById('mainContent').innerHTML = html;

            // åˆå§‹åŒ–è¡¨å•äº‹ä»¶
            setTimeout(() => initCompanyProfileEvents(), 100);
        }

        // æ¸²æŸ“å¢å¼ºå‹ä¼ä¸šä¿¡æ¯åº“é¡µé¢
        function renderEnhancedCompanyProfile(companyData) {
            return '<div class="container-fluid px-0">' +


                '<!-- Tabå¯¼èˆª -->' +
                '<ul class="nav nav-tabs mb-3" id="companyProfileTabs">' +
                    '<li class="nav-item">' +
                        '<button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-basic">' +
                            '<i class="bi bi-globe text-success"></i> åŸºç¡€ä¿¡æ¯' +
                        '</button>' +
                    '</li>' +
                    '<li class="nav-item">' +
                        '<button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-qualification">' +
                            '<i class="bi bi-award text-primary"></i> èµ„è´¨ä¿¡æ¯' +
                        '</button>' +
                    '</li>' +
                    '<li class="nav-item">' +
                        '<button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-personnel">' +
                            '<i class="bi bi-people text-warning"></i> äººå‘˜ä¿¡æ¯' +
                        '</button>' +
                    '</li>' +
                    '<li class="nav-item">' +
                        '<button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-financial">' +
                            '<i class="bi bi-bank text-danger"></i> è´¢åŠ¡ä¿¡æ¯' +
                        '</button>' +
                    '</li>' +
                '</ul>' +

                '<!-- Tabå†…å®¹ -->' +
                '<div class="tab-content">' +
                    '<!-- åŸºç¡€ä¿¡æ¯Tab -->' +
                    '<div class="tab-pane fade show active" id="tab-basic">' +
                        '<div class="card">' +
                            '<div class="card-body">' +
                                (companyData ? renderBasicInfoForm(companyData) : '<p class="text-muted">åŠ è½½ä¸­...</p>') +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- èµ„è´¨ä¿¡æ¯Tab -->' +
                    '<div class="tab-pane fade" id="tab-qualification">' +
                        '<div class="card">' +
                            '<div class="card-body">' +
                                renderQualificationSection() +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- äººå‘˜ä¿¡æ¯Tab -->' +
                    '<div class="tab-pane fade" id="tab-personnel">' +
                        '<div class="card">' +
                            '<div class="card-body">' +
                                renderPersonnelSection() +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- è´¢åŠ¡ä¿¡æ¯Tab -->' +
                    '<div class="tab-pane fade" id="tab-financial">' +
                        '<div class="card">' +
                            '<div class="card-body">' +
                                renderFinancialSection() +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // æ¸²æŸ“åˆ†ç±»æ–‡æ¡£
        function renderProfileDocuments(profileType) {
            // è¿™é‡Œåº”è¯¥ä»å®é™…æ•°æ®æ¸²æŸ“ï¼Œæš‚æ—¶ç”¨ç¤ºä¾‹
            return '<div class="text-center py-4">' +
                '<i class="bi bi-folder text-muted fs-1"></i>' +
                '<p class="text-muted mt-2">æš‚æ— æ–‡æ¡£</p>' +
                '<button class="btn btn-outline-primary btn-sm" onclick="showProfileUploadModal(\'' + profileType + '\')">' +
                    '<i class="bi bi-plus me-1"></i>ä¸Šä¼ æ–‡æ¡£' +
                '</button>' +
            '</div>';
        }

        // æ¸²æŸ“åŸºç¡€ä¿¡æ¯è¡¨å•
        function renderBasicInfoForm(companyData) {
            const data = companyData || {};
            return '<form id="companyBasicInfoForm">' +
                '<div class="row mb-3">' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">å…¬å¸åç§° <span class="text-danger">*</span></label>' +
                        '<input type="text" class="form-control" id="prof-companyName" value="' + (data.companyName || data.company_name || '') + '" required>' +
                    '</div>' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">æˆç«‹æ—¥æœŸ</label>' +
                        '<input type="date" class="form-control" id="prof-establishDate" value="' + (data.establishDate || data.establish_date || '') + '">' +
                    '</div>' +
                '</div>' +

                '<div class="row mb-3">' +
                    '<div class="col-md-4">' +
                        '<label class="form-label">æ³•å®šä»£è¡¨äºº</label>' +
                        '<input type="text" class="form-control" id="prof-legalRepresentative" value="' + (data.legalRepresentative || data.legal_representative || '') + '">' +
                    '</div>' +
                    '<div class="col-md-4">' +
                        '<label class="form-label">æ³•å®šä»£è¡¨äººèŒåŠ¡</label>' +
                        '<input type="text" class="form-control" id="prof-legalRepresentativePosition" value="' + (data.legalRepresentativePosition || data.legal_representative_position || '') + '">' +
                    '</div>' +
                    '<div class="col-md-4">' +
                        '<label class="form-label">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </label>' +
                        '<input type="text" class="form-control" id="prof-socialCreditCode" value="' + (data.socialCreditCode || data.social_credit_code || '') + '">' +
                    '</div>' +
                '</div>' +

                '<div class="row mb-3">' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">æ³¨å†Œèµ„æœ¬</label>' +
                        '<input type="text" class="form-control" id="prof-registeredCapital" value="' + (data.registeredCapital || '') + '">' +
                    '</div>' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">å…¬å¸ç±»å‹</label>' +
                        '<select class="form-select" id="prof-companyType">' +
                            '<option value="">è¯·é€‰æ‹©å…¬å¸ç±»å‹</option>' +
                            '<option value="æœ‰é™è´£ä»»å…¬å¸" ' + (data.companyType === 'æœ‰é™è´£ä»»å…¬å¸' ? 'selected' : '') + '>æœ‰é™è´£ä»»å…¬å¸</option>' +
                            '<option value="è‚¡ä»½æœ‰é™å…¬å¸" ' + (data.companyType === 'è‚¡ä»½æœ‰é™å…¬å¸' ? 'selected' : '') + '>è‚¡ä»½æœ‰é™å…¬å¸</option>' +
                            '<option value="åˆä¼™ä¼ä¸š" ' + (data.companyType === 'åˆä¼™ä¼ä¸š' ? 'selected' : '') + '>åˆä¼™ä¼ä¸š</option>' +
                            '<option value="ä¸ªäººç‹¬èµ„ä¼ä¸š" ' + (data.companyType === 'ä¸ªäººç‹¬èµ„ä¼ä¸š' ? 'selected' : '') + '>ä¸ªäººç‹¬èµ„ä¼ä¸š</option>' +
                            '<option value="å¤–å•†æŠ•èµ„ä¼ä¸š" ' + (data.companyType === 'å¤–å•†æŠ•èµ„ä¼ä¸š' ? 'selected' : '') + '>å¤–å•†æŠ•èµ„ä¼ä¸š</option>' +
                            '<option value="å…¶ä»–" ' + (data.companyType === 'å…¶ä»–' ? 'selected' : '') + '>å…¶ä»–</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +

                '<div class="mb-3">' +
                    '<label class="form-label">æ³¨å†Œåœ°å€</label>' +
                    '<textarea class="form-control" id="prof-registeredAddress" rows="2">' + (data.registeredAddress || '') + '</textarea>' +
                '</div>' +

                '<div class="mb-3">' +
                    '<label class="form-label">ç»è¥èŒƒå›´</label>' +
                    '<textarea class="form-control" id="prof-businessScope" rows="3">' + (data.businessScope || '') + '</textarea>' +
                '</div>' +

                '<div class="mb-3">' +
                    '<label class="form-label">å…¬å¸ç®€ä»‹</label>' +
                    '<textarea class="form-control" id="prof-companyDescription" rows="3">' + (data.companyDescription || '') + '</textarea>' +
                '</div>' +

                '<div class="text-center mt-4">' +
                    '<button type="button" class="btn btn-success btn-lg" onclick="saveCompanyBasicInfo()">' +
                        '<i class="bi bi-save"></i> ä¿å­˜åŸºç¡€ä¿¡æ¯' +
                    '</button>' +
                '</div>' +
            '</form>';
        }

        // æ¸²æŸ“èµ„è´¨ä¿¡æ¯éƒ¨åˆ†
        function renderQualificationSection() {
            return '<div class="qualification-section">' +
                '<div class="mb-4">' +
                    '<div id="profileStandardQualifications">' +
                        renderStandardQualifications() +
                    '</div>' +
                '</div>' +

                '<div class="mb-4">' +
                    '<h6 class="text-success mb-3">' +
                        '<i class="bi bi-plus-circle"></i> è‡ªå®šä¹‰èµ„è´¨æ–‡ä»¶' +
                    '</h6>' +

                    '<div class="card bg-light mb-3">' +
                        '<div class="card-body">' +
                            '<div class="row">' +
                                '<div class="col-md-8">' +
                                    '<input type="text" class="form-control" id="profileCustomQualificationName" ' +
                                           'placeholder="è¾“å…¥èµ„è´¨åç§°ï¼Œå¦‚ï¼šè½¯ä»¶è‘—ä½œæƒç™»è®°è¯ä¹¦">' +
                                '</div>' +
                                '<div class="col-md-4">' +
                                    '<button type="button" class="btn btn-success w-100" onclick="addCustomQualificationProfile()">' +
                                        '<i class="bi bi-plus"></i> æ·»åŠ èµ„è´¨é¡¹' +
                                    '</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<div id="profileCustomQualifications">' +
                    '</div>' +
                '</div>' +

                '<div class="text-center">' +
                    '<button type="button" class="btn btn-primary btn-lg me-3" onclick="saveAllQualificationsProfile()">' +
                        '<i class="bi bi-cloud-upload"></i> ä¿å­˜æ‰€æœ‰èµ„è´¨æ–‡ä»¶' +
                    '</button>' +
                    '<button type="button" class="btn btn-outline-secondary btn-lg" onclick="clearAllQualificationsProfile()">' +
                        '<i class="bi bi-x-circle"></i> æ¸…ç©ºæ‰€æœ‰èµ„è´¨' +
                    '</button>' +
                '</div>' +
            '</div>';
        }

        // æ¸²æŸ“æ ‡å‡†èµ„è´¨
        function renderStandardQualifications() {
            const standardQualificationTypes = [
                // åŸºæœ¬è¯ä»¶èµ„è´¨
                { key: 'business_license', name: 'è¥ä¸šæ‰§ç…§', icon: 'bi-building', category: 'basic', required: true },
                { key: 'legal_id_front', name: 'æ³•äººèº«ä»½è¯ï¼ˆæ­£é¢ï¼‰', icon: 'bi-person-badge', category: 'basic', required: true },
                { key: 'legal_id_back', name: 'æ³•äººèº«ä»½è¯ï¼ˆåé¢ï¼‰', icon: 'bi-person-badge', category: 'basic', required: true },
                { key: 'auth_id_front', name: 'æˆæƒäººèº«ä»½è¯ï¼ˆæ­£é¢ï¼‰', icon: 'bi-person-check', category: 'basic' },
                { key: 'auth_id_back', name: 'æˆæƒäººèº«ä»½è¯ï¼ˆåé¢ï¼‰', icon: 'bi-person-check', category: 'basic' },

                // ISOä½“ç³»è®¤è¯
                { key: 'iso9001', name: 'è´¨é‡ç®¡ç†ä½“ç³»è®¤è¯ï¼ˆISO9001ï¼‰', icon: 'bi-award', category: 'iso' },
                { key: 'iso14001', name: 'ç¯å¢ƒç®¡ç†ä½“ç³»è®¤è¯ï¼ˆISO14001ï¼‰', icon: 'bi-tree', category: 'iso' },
                { key: 'iso45001', name: 'èŒä¸šå¥åº·å®‰å…¨ç®¡ç†ä½“ç³»è®¤è¯ï¼ˆISO45001ï¼‰', icon: 'bi-shield-check', category: 'iso' },
                { key: 'iso20000', name: 'ä¿¡æ¯æŠ€æœ¯æœåŠ¡ç®¡ç†ä½“ç³»è®¤è¯ï¼ˆISO20000ï¼‰', icon: 'bi-gear', category: 'iso' },
                { key: 'iso27001', name: 'ä¿¡æ¯å®‰å…¨ç®¡ç†ä½“ç³»è®¤è¯ï¼ˆISO27001ï¼‰', icon: 'bi-shield-lock', category: 'iso' },

                // ç¨åŠ¡å’Œè´¢åŠ¡èµ„è´¨
                { key: 'taxpayer_certificate', name: 'çº³ç¨äººèµ„æ ¼è¯æ˜', icon: 'bi-receipt', category: 'financial' },
                { key: 'audit_report', name: 'è´¢åŠ¡å®¡è®¡æŠ¥å‘Š', icon: 'bi-file-earmark-check', category: 'financial' },
                { key: 'financial_audit', name: 'è¿‘ä¸‰å¹´è´¢åŠ¡å®¡è®¡æŠ¥å‘Š', icon: 'bi-graph-up', category: 'financial' },
                { key: 'bank_account', name: 'é“¶è¡Œå¼€æˆ·è®¸å¯è¯', icon: 'bi-bank', category: 'financial' },

                // ä¿¡ç”¨èµ„è´¨
                { key: 'credit_dishonest', name: 'ä¿¡ç”¨ä¸­å›½-å¤±ä¿¡è¢«æ‰§è¡ŒäººæŸ¥è¯¢', icon: 'bi-shield-x', category: 'credit' },
                { key: 'credit_corruption', name: 'ä¿¡ç”¨ä¸­å›½-é‡å¤§ç¨æ”¶è¿æ³•æ¡ˆä»¶æŸ¥è¯¢', icon: 'bi-exclamation-triangle', category: 'credit' },
                { key: 'credit_tax', name: 'ä¿¡ç”¨ä¸­å›½-æ”¿åºœé‡‡è´­ä¸¥é‡è¿æ³•å¤±ä¿¡æŸ¥è¯¢', icon: 'bi-flag', category: 'credit' },
                { key: 'credit_procurement', name: 'æ”¿åºœé‡‡è´­ä¿¡ç”¨æŸ¥è¯¢ç»“æœ', icon: 'bi-check-circle', category: 'credit' },

                // ç¤¾ä¿å’Œå‘˜å·¥
                { key: 'social_security', name: 'ç¤¾ä¼šä¿é™©å‚ä¿è¯æ˜', icon: 'bi-people', category: 'employee' },
                { key: 'employee_social_security', name: 'å‘˜å·¥ç¤¾ä¿è¯æ˜', icon: 'bi-file-medical', category: 'employee' },

                // çŸ¥è¯†äº§æƒå’Œè¡Œä¸šèµ„è´¨
                { key: 'software_copyright', name: 'è½¯ä»¶è‘—ä½œæƒç™»è®°è¯ä¹¦', icon: 'bi-code-square', category: 'industry' },
                { key: 'patent_certificate', name: 'ä¸“åˆ©è¯ä¹¦', icon: 'bi-lightbulb', category: 'industry' },
                { key: 'high_tech', name: 'é«˜æ–°æŠ€æœ¯ä¼ä¸šè¯ä¹¦', icon: 'bi-rocket', category: 'industry' },
                { key: 'software_enterprise', name: 'è½¯ä»¶ä¼ä¸šè®¤å®šè¯ä¹¦', icon: 'bi-cpu', category: 'industry' },
                { key: 'cmmi', name: 'CMMIæˆç†Ÿåº¦ç­‰çº§è¯ä¹¦', icon: 'bi-diagram-3', category: 'industry' }
            ];

            const categories = {
                'basic': { name: 'åŸºæœ¬è¯ä»¶èµ„è´¨', color: 'primary' },
                'iso': { name: 'ISOä½“ç³»è®¤è¯', color: 'success' },
                'financial': { name: 'è´¢åŠ¡ç¨åŠ¡èµ„è´¨', color: 'warning' },
                'credit': { name: 'ä¿¡ç”¨èµ„è´¨è¯æ˜', color: 'info' },
                'employee': { name: 'å‘˜å·¥ç¤¾ä¿èµ„è´¨', color: 'secondary' },
                'industry': { name: 'è¡Œä¸šä¸“ä¸šèµ„è´¨', color: 'danger' }
            };

            let html = '';

            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                const categoryQuals = standardQualificationTypes.filter(qual => qual.category === categoryKey);

                if (categoryQuals.length > 0) {
                    html += '<div class="mb-4">' +
                        '<h6 class="text-' + category.color + ' mb-3 border-bottom pb-2">' +
                            '<i class="bi bi-folder"></i> ' + category.name +
                        '</h6>' +
                        '<div class="row g-3">';

                    categoryQuals.forEach(qual => {
                        html += '<div class="col-lg-6">' +
                            renderQualificationItem(qual.name, qual.key, qual.icon, qual.required) +
                        '</div>';
                    });

                    html += '</div></div>';
                }
            });

            return html;
        }

        // æ¸²æŸ“èµ„è´¨é¡¹
        function renderQualificationItem(name, id, icon, required) {
            const borderClass = required ? 'border-warning' : '';
            const requiredBadge = required ? '<span class="badge bg-warning text-dark ms-2">å¿…éœ€</span>' : '';

            return '<div class="card mb-3 ' + borderClass + '">' +
                '<div class="card-body">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                        '<div class="flex-grow-1">' +
                            '<i class="bi ' + icon + ' me-2 text-primary"></i>' +
                            '<span>' + name + '</span>' +
                            requiredBadge +
                        '</div>' +
                        '<div class="btn-group">' +
                            '<input type="file" class="d-none" id="profile-qual-' + id + '" accept=".pdf,.jpg,.png,.jpeg">' +
                            '<button class="btn btn-sm btn-outline-primary" onclick="document.getElementById(\'profile-qual-' + id + '\').click()" title="ä¸Šä¼ æ–‡ä»¶">' +
                                '<i class="bi bi-upload"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mt-2 d-none" id="profile-status-' + id + '">' +
                        '<small class="text-muted">æœªä¸Šä¼ æ–‡ä»¶</small>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // æ¸²æŸ“äººå‘˜ä¿¡æ¯éƒ¨åˆ†
        function renderPersonnelSection() {
            return '<div class="personnel-section">' +
                '<div class="mb-4">' +
                    '<h6 class="text-warning mb-3"><i class="bi bi-people"></i> äººå‘˜æ¡£æ¡ˆ</h6>' +
                    '<div class="row g-3">' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('æ³•å®šä»£è¡¨äººèº«ä»½è¯', 'legal_id', 'bi-person-badge') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('è¢«æˆæƒäººèº«ä»½è¯', 'auth_id', 'bi-person-check') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('å‘˜å·¥ç¤¾ä¿è¯æ˜', 'social_security', 'bi-file-medical') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('å›¢é˜Ÿæˆå‘˜ç®€å†', 'team_resume', 'bi-file-person') +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="text-center">' +
                    '<button class="btn btn-warning btn-lg" onclick="uploadPersonnelDocs()">' +
                        '<i class="bi bi-cloud-upload"></i> ä¸Šä¼ äººå‘˜æ¡£æ¡ˆ' +
                    '</button>' +
                '</div>' +
            '</div>';
        }

        // æ¸²æŸ“äººå‘˜é¡¹
        function renderPersonnelItem(name, id, icon) {
            return '<div class="card mb-3 border-warning">' +
                '<div class="card-body">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                        '<div>' +
                            '<i class="bi ' + icon + ' text-warning me-2"></i>' +
                            '<span>' + name + '</span>' +
                        '</div>' +
                        '<div>' +
                            '<input type="file" class="d-none" id="pers-' + id + '" accept=".pdf,.jpg,.png">' +
                            '<button class="btn btn-sm btn-outline-warning" onclick="document.getElementById(\'pers-' + id + '\').click()">' +
                                '<i class="bi bi-upload"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // æ¸²æŸ“è´¢åŠ¡ä¿¡æ¯éƒ¨åˆ†
        function renderFinancialSection() {
            return '<div class="financial-section">' +
                '<div class="mb-4">' +
                    '<h6 class="text-danger mb-3"><i class="bi bi-bank"></i> è´¢åŠ¡æ–‡æ¡£</h6>' +
                    '<div class="row g-3">' +
                        '<div class="col-md-6">' +
                            renderFinancialItem('å®¡è®¡æŠ¥å‘Š', 'audit_report', 'bi-file-earmark-check') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderFinancialItem('è´¢åŠ¡æŠ¥è¡¨', 'financial_statement', 'bi-file-earmark-spreadsheet') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderFinancialItem('é“¶è¡Œæµæ°´', 'bank_statement', 'bi-bank2') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderFinancialItem('çº³ç¨è¯æ˜', 'tax_certificate', 'bi-receipt') +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<h6>é“¶è¡Œè´¦æˆ·ä¿¡æ¯</h6>' +
                    '<div class="row">' +
                        '<div class="col-md-6">' +
                            '<label class="form-label">å¼€æˆ·è¡Œå…¨ç§°</label>' +
                            '<input type="text" class="form-control" id="prof-bankName" placeholder="ä¾‹ï¼šä¸­å›½å·¥å•†é“¶è¡Œè‚¡ä»½æœ‰é™å…¬å¸åŒ—äº¬åˆ†è¡Œ">' +
                        '</div>' +
                        '<div class="col-md-6">' +
                            '<label class="form-label">é“¶è¡Œè´¦å·</label>' +
                            '<input type="text" class="form-control" id="prof-bankAccount" placeholder="è¯·è¾“å…¥é“¶è¡Œè´¦å·">' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="text-center">' +
                    '<button class="btn btn-danger btn-lg" onclick="saveFinancialInfo()">' +
                        '<i class="bi bi-save"></i> ä¿å­˜è´¢åŠ¡ä¿¡æ¯' +
                    '</button>' +
                '</div>' +
            '</div>';
        }

        // æ¸²æŸ“è´¢åŠ¡é¡¹
        function renderFinancialItem(name, id, icon) {
            return '<div class="card mb-3 border-danger">' +
                '<div class="card-body">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                        '<div>' +
                            '<i class="bi ' + icon + ' text-danger me-2"></i>' +
                            '<span>' + name + '</span>' +
                        '</div>' +
                        '<div>' +
                            '<input type="file" class="d-none" id="fin-' + id + '" accept=".pdf,.xls,.xlsx">' +
                            '<button class="btn btn-sm btn-outline-danger" onclick="document.getElementById(\'fin-' + id + '\').click()">' +
                                '<i class="bi bi-upload"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // åˆå§‹åŒ–ä¼ä¸šä¿¡æ¯åº“äº‹ä»¶
        function initCompanyProfileEvents() {
            // æ·»åŠ è¡¨å•éªŒè¯å’Œæäº¤äº‹ä»¶
            console.log('åˆå§‹åŒ–ä¼ä¸šä¿¡æ¯åº“äº‹ä»¶');
        }

        // ä¿å­˜å…¬å¸åŸºç¡€ä¿¡æ¯
        async function saveCompanyBasicInfo() {
            const data = {
                companyName: document.getElementById('prof-companyName').value,
                establishDate: document.getElementById('prof-establishDate').value,
                legalRepresentative: document.getElementById('prof-legalRepresentative').value,
                legalRepresentativePosition: document.getElementById('prof-legalRepresentativePosition').value,
                socialCreditCode: document.getElementById('prof-socialCreditCode').value,
                registeredCapital: document.getElementById('prof-registeredCapital').value,
                companyType: document.getElementById('prof-companyType').value,
                registeredAddress: document.getElementById('prof-registeredAddress').value,
                businessScope: document.getElementById('prof-businessScope').value,
                companyDescription: document.getElementById('prof-companyDescription').value
            };

            try {
                const response = await axios.put('/api/knowledge_base/companies/' + currentCompanyId, data);
                if (response.data.success) {
                    showAlert('åŸºç¡€ä¿¡æ¯ä¿å­˜æˆåŠŸ', 'success');
                }
            } catch (error) {
                showAlert('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'danger');
            }
        }

        // ä¿å­˜è´¢åŠ¡ä¿¡æ¯
        async function saveFinancialInfo() {
            const data = {
                bankName: document.getElementById('prof-bankName').value,
                bankAccount: document.getElementById('prof-bankAccount').value
            };

            try {
                const response = await axios.put('/api/knowledge_base/companies/' + currentCompanyId, data);
                if (response.data.success) {
                    showAlert('è´¢åŠ¡ä¿¡æ¯ä¿å­˜æˆåŠŸ', 'success');
                }
            } catch (error) {
                showAlert('ä¿å­˜å¤±è´¥ï¼š' + error.message, 'danger');
            }
        }

        // æ¸²æŸ“å…¬å¸è¯¦æƒ…
        function renderCompanyDetail(company) {
            const html =

                '<div class="card mb-3">' +
                    '<div class="card-header bg-primary text-white">' +
                        '<h5 class="mb-0">' + company.company_name + '</h5>' +
                    '</div>' +
                    '<div class="card-body">' +
                        '<div class="row">' +
                            '<div class="col-md-6">' +
                                '<p><strong>ä¼ä¸šä»£ç ï¼š</strong>' + (company.company_code || 'æœªè®¾ç½®') + '</p>' +
                                '<p><strong>è¡Œä¸šç±»å‹ï¼š</strong>' + (company.industry_type || 'æœªè®¾ç½®') + '</p>' +
                                '<p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>' + (company.created_at || 'æœªçŸ¥') + '</p>' +
                            '</div>' +
                            '<div class="col-md-6">' +
                                '<p><strong>äº§å“æ•°é‡ï¼š</strong>' + (company.products && company.products.length || 0) + ' ä¸ª</p>' +
                                '<p><strong>æ–‡æ¡£æ€»æ•°ï¼š</strong>' + (company.stats && company.stats.total_documents || 0) + ' ä»½</p>' +
                            '</div>' +
                        '</div>' +
                        (company.description && ('<p class="mt-3">' + company.description + '</p>') || '') +
                    '</div>' +
                '</div>' +

                '<div class="card">' +
                    '<div class="card-header">' +
                        '<div class="d-flex justify-content-between align-items-center">' +
                            '<h6 class="mb-0">äº§å“åˆ—è¡¨</h6>' +
                            '<button class="btn btn-sm btn-success" onclick="showAddProductModal(' + company.company_id + ')">' +
                                '<i class="bi bi-plus-circle"></i> æ·»åŠ äº§å“' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="card-body">' +
                        '<div id="productList"></div>' +
                    '</div>' +
                '</div>';

            document.getElementById('mainContent').innerHTML = html;
        }

        // æ¸²æŸ“äº§å“åˆ—è¡¨
        function renderProductList(companyId, products) {
            const listHtml = products.map(product =>
                '<div class="document-item" onclick="selectProduct(' + product.product_id + ', \'' + product.product_name + '\')">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                        '<div>' +
                            '<h6 class="mb-1">' +
                                '<i class="bi bi-box-seam me-2"></i>' +
                                product.product_name +
                            '</h6>' +
                            '<small class="text-muted">' + (product.product_category || 'æœªåˆ†ç±»') + ' | ' + (product.document_count || 0) + ' ä»½æ–‡æ¡£</small>' +
                        '</div>' +
                        '<div>' +
                            '<button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showUploadModal(' + product.product_id + ')">' +
                                '<i class="bi bi-upload"></i> ä¸Šä¼ ' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>'
            ).join('');

            document.getElementById('productList').innerHTML = listHtml || '<p class="text-muted text-center">æš‚æ— äº§å“</p>';

            // åŒæ—¶æ›´æ–°å·¦ä¾§æ ‘å½¢ç»“æ„
            const productsContainer = document.getElementById('products-' + companyId);
            if (productsContainer) {
                const treeHtml = products.map(product =>
                    '<div class="tree-node ms-3" onclick="selectProduct(' + product.product_id + ', \'' + product.product_name + '\')">' +
                        '<i class="bi bi-box-seam me-2"></i>' +
                        product.product_name +
                        '<span class="badge bg-info ms-2">' + (product.document_count || 0) + '</span>' +
                    '</div>'
                ).join('');
                productsContainer.innerHTML = treeHtml;
                productsContainer.classList.remove('d-none');
            }
        }

        // é€‰æ‹©äº§å“
        async function selectProduct(productId, productName) {
            currentProductId = productId;


            // åŠ è½½äº§å“è¯¦æƒ…å’Œæ–‡æ¡£åˆ—è¡¨
            try {
                const response = await axios.get('/api/knowledge_base/products/' + productId);
                if (response.data.success) {
                    renderProductDetail(response.data.data);
                }
            } catch (error) {
                console.error('åŠ è½½äº§å“è¯¦æƒ…å¤±è´¥:', error);
                showAlert('åŠ è½½äº§å“è¯¦æƒ…å¤±è´¥', 'danger');
            }
        }

        // æ¸²æŸ“äº§å“è¯¦æƒ…
        function renderProductDetail(product) {
            let html =

                '<div class="card mb-3">' +
                    '<div class="card-header bg-success text-white">' +
                        '<h5 class="mb-0">' + product.product_name + '</h5>' +
                    '</div>' +
                    '<div class="card-body">' +
                        '<p><strong>äº§å“ä»£ç ï¼š</strong>' + (product.product_code || 'æœªè®¾ç½®') + '</p>' +
                        '<p><strong>äº§å“ç±»åˆ«ï¼š</strong>' + (product.product_category || 'æœªåˆ†ç±»') + '</p>' +
                        (product.description && '<p>' + product.description + '</p>' || '') +
                    '</div>' +
                '</div>';

            if (product.libraries) {
                html += product.libraries.map(library =>
                    '<div class="card mb-3">' +
                        '<div class="card-header">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<h6 class="mb-0">' + library.library_name + '</h6>' +
                                '<button class="btn btn-sm btn-primary" onclick="showUploadModal(' + product.product_id + ', ' + library.library_id + ')">' +
                                    '<i class="bi bi-upload"></i> ä¸Šä¼ æ–‡æ¡£' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                        '<div class="card-body p-4" style="max-height: 600px; overflow-y: auto;">' +
                            '<div class="kb-document-grid">' +
                                (library.documents && library.documents.length > 0 &&
                                    library.documents.map(doc => renderDocument(doc)).join('') ||
                                    '<div class="col-12"><div class="text-center py-5"><i class="bi bi-folder text-muted fs-1"></i><p class="text-muted mt-3">æš‚æ— æ–‡æ¡£</p><button class="btn btn-primary" onclick="document.getElementById(\'fileInput\').click()"><i class="bi bi-plus me-2"></i>ä¸Šä¼ ç¬¬ä¸€ä¸ªæ–‡æ¡£</button></div></div>'
                                ) +
                            '</div>' +
                        '</div>' +
                    '</div>'
                ).join('');
            }

            document.getElementById('mainContent').innerHTML = html;
        }

        // æ¸²æŸ“æ–‡æ¡£é¡¹ - ä½¿ç”¨ Bootstrap Card ç»„ä»¶
        function renderDocument(doc) {
            const privacyClasses = ['', 'privacy-1', 'privacy-2', 'privacy-3', 'privacy-4'];
            const privacyNames = ['', 'å…¬å¼€', 'å†…éƒ¨', 'æœºå¯†', 'ç»å¯†'];
            const categoryNames = {
                'tech': 'æŠ€æœ¯',
                'impl': 'å®æ–½',
                'service': 'æœåŠ¡'
            };

            const privacyLevel = doc.privacy_classification || 1;
            const category = doc.document_category || 'tech';
            const fileSize = doc.file_size && (doc.file_size / (1024 * 1024)).toFixed(2) || '0';

            return `
                <div class="card shadow-sm border-0 kb-document-card h-100" onclick="viewDocumentDetail(' + doc.doc_id + ')">
                    <div class="card-header bg-light border-0 p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded p-2 me-3">
                                <i class="bi bi-file-earmark-text text-primary fs-5"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0 text-truncate" title="' + doc.original_filename + '">' + (doc.original_filename.length > 20 ? doc.original_filename.substring(0, 20) + '...' : doc.original_filename) + '</h6>
                                <div class="d-flex align-items-center mt-1">
                                    <span class="badge ' + (privacyLevel === 1 ? 'bg-success' : privacyLevel === 2 ? 'bg-primary' : privacyLevel === 3 ? 'bg-warning' : 'bg-danger') + ' me-2 small">
                                        ' + privacyNames[privacyLevel] + '
                                    </span>
                                    <span class="badge bg-secondary small">
                                        ' + categoryNames[category] + '
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">
                                    <i class="bi bi-hdd me-1"></i>
                                    ' + fileSize + ' MB
                                </span>
                                <span class="text-muted small">
                                    <i class="bi bi-calendar me-1"></i>
                                    ' + (doc.upload_time && new Date(doc.upload_time).toLocaleDateString() || 'æœªçŸ¥') + '
                                </span>
                            </div>
                            ' + (doc.tags && '
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-tags me-1"></i>
                                    ' + JSON.parse(doc.tags).slice(0, 2).join(', ') + '
                                </small>
                            </div>' || '') + '
                        </div>

                        <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                        <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="d-flex align-items-center justify-content-center p-2 rounded ' + (doc.parse_status === 'completed' && 'bg-success bg-opacity-10' || 'bg-warning bg-opacity-10') + '">
                                        <i class="bi ' + (doc.parse_status === 'completed' && 'bi-check-circle text-success' || 'bi-clock text-warning') + ' me-1"></i>
                                        <small class="' + (doc.parse_status === 'completed' && 'text-success' || 'text-warning') + '">
                                            ' + (doc.parse_status === 'completed' && 'å·²è§£æ' || 'å¾…å¤„ç†') + '
                                        </small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center justify-content-center p-2 rounded ' + (doc.vector_status === 'completed' && 'bg-info bg-opacity-10' || 'bg-secondary bg-opacity-10') + '">
                                        <i class="bi ' + (doc.vector_status === 'completed' && 'bi-database text-info' || 'bi-hourglass text-secondary') + ' me-1"></i>
                                        <small class="' + (doc.vector_status === 'completed' && 'text-info' || 'text-secondary') + '">
                                            ' + (doc.vector_status === 'completed' && 'å·²ç´¢å¼•' || 'å¾…ç´¢å¼•') + '
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer bg-white border-0 p-3">
                        <div class="d-grid">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); downloadDocument(' + doc.doc_id + ')" title="ä¸‹è½½">
                                    <i class="bi bi-download"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); previewDocument(' + doc.doc_id + ')" title="é¢„è§ˆ">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteDocument(' + doc.doc_id + ')" title="åˆ é™¤">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // æ˜¾ç¤ºæ·»åŠ å…¬å¸æ¨¡æ€æ¡†
        function showAddCompanyModal() {
            new bootstrap.Modal(document.getElementById('addCompanyModal')).show();
        }

        // æ˜¾ç¤ºæ·»åŠ äº§å“æ¨¡æ€æ¡†
        function showAddProductModal(companyId) {
            currentCompanyId = companyId;
            new bootstrap.Modal(document.getElementById('addProductModal')).show();
        }

        // æ˜¾ç¤ºä¸Šä¼ æ–‡æ¡£æ¨¡æ€æ¡†
        function showUploadModal(productId, libraryId) {
            currentProductId = productId;
            currentLibraryId = libraryId;
            selectedFiles = [];
            document.getElementById('fileList').innerHTML = '';
            new bootstrap.Modal(document.getElementById('uploadDocumentModal')).show();
        }

        // æ·»åŠ å…¬å¸
        async function addCompany() {
            const data = {
                company_name: document.getElementById('companyName').value,
                company_code: document.getElementById('companyCode').value,
                industry_type: document.getElementById('industryType').value,
                description: document.getElementById('companyDesc').value
            };

            try {
                const response = await axios.post('/api/knowledge_base/companies', data);
                if (response.data.success) {
                    showAlert('ä¼ä¸šæ·»åŠ æˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addCompanyModal')).hide();
                    loadCompanies();
                    document.getElementById('addCompanyForm').reset();
                }
            } catch (error) {
                console.error('æ·»åŠ ä¼ä¸šå¤±è´¥:', error);
                showAlert('æ·»åŠ ä¼ä¸šå¤±è´¥ï¼š' + (error.response && error.response.data && error.response.data.error ? error.response.data.error : error.message), 'danger');
            }
        }

        // æ·»åŠ äº§å“
        async function addProduct() {
            const data = {
                product_name: document.getElementById('productName').value,
                product_code: document.getElementById('productCode').value,
                product_category: document.getElementById('productCategory').value,
                description: document.getElementById('productDesc').value
            };

            try {
                const response = await axios.post('/api/knowledge_base/companies/' + currentCompanyId + '/products', data);
                if (response.data.success) {
                    showAlert('äº§å“æ·»åŠ æˆåŠŸ', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    selectCompany(currentCompanyId, '');
                    document.getElementById('addProductForm').reset();
                }
            } catch (error) {
                console.error('æ·»åŠ äº§å“å¤±è´¥:', error);
                showAlert('æ·»åŠ äº§å“å¤±è´¥ï¼š' + (error.response && error.response.data && error.response.data.error ? error.response.data.error : error.message), 'danger');
            }
        }

        // è®¾ç½®ä¸Šä¼ åŒºåŸŸ
        function setupUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            // æ‹–æ‹½äº‹ä»¶
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // å¤„ç†é€‰æ‹©çš„æ–‡ä»¶
        function handleFiles(files) {
            selectedFiles = Array.from(files);

            const listHtml = selectedFiles.map((file, index) =>
                '<div class="alert alert-info d-flex justify-content-between align-items-center">' +
                    '<span>' + file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)</span>' +
                    '<button class="btn btn-sm btn-danger" onclick="removeFile(' + index + ')">' +
                        '<i class="bi bi-x"></i>' +
                    '</button>' +
                '</div>'
            ).join('');

            document.getElementById('fileList').innerHTML = listHtml;
        }

        // ç§»é™¤æ–‡ä»¶
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            handleFiles(selectedFiles);
        }

        // ä¸Šä¼ æ–‡æ¡£
        async function uploadDocuments() {
            if (!currentLibraryId || selectedFiles.length === 0) {
                showAlert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'warning');
                return;
            }

            const privacyLevel = document.getElementById('privacyLevel').value;
            const documentCategory = document.getElementById('documentCategory').value;
            const tags = document.getElementById('documentTags').value.split(',').map(t => t.trim()).filter(t => t);

            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            const progressContainer = document.getElementById('uploadProgress');
            if (progressContainer) {
                progressContainer.classList.remove('d-none');
            }

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('privacy_classification', privacyLevel);
                formData.append('document_category', documentCategory);
                formData.append('tags', JSON.stringify(tags));

                try {
                    const response = await axios.post('/api/knowledge_base/libraries/' + currentLibraryId + '/documents', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' },
                        onUploadProgress: (progressEvent) => {
                            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            updateUploadProgress(i + 1, selectedFiles.length, percentCompleted, file.name);
                        }
                    });

                    if (response.data.success) {
                        successCount++;
                        showAlert('æ–‡æ¡£ ' + file.name + ' ä¸Šä¼ æˆåŠŸ', 'success');
                    }
                } catch (error) {
                    failCount++;
                    console.error('æ–‡æ¡£ ' + file.name + ' ä¸Šä¼ å¤±è´¥:', error);
                    showAlert('æ–‡æ¡£ ' + file.name + ' ä¸Šä¼ å¤±è´¥: ' + (error.response && error.response.data && error.response.data.error ? error.response.data.error : error.message), 'danger');
                }
            }

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            if (successCount > 0) {
                showAlert('æˆåŠŸä¸Šä¼  ' + successCount + ' ä¸ªæ–‡æ¡£' + (failCount > 0 && 'ï¼Œå¤±è´¥ ' + failCount + ' ä¸ª' || ''), successCount === selectedFiles.length && 'success' || 'warning');
            }

            // å…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°äº§å“è¯¦æƒ…
            bootstrap.Modal.getInstance(document.getElementById('uploadDocumentModal')).hide();
            if (currentProductId) {
                selectProduct(currentProductId, '');
            }
        }

        // æ›´æ–°ä¸Šä¼ è¿›åº¦
        function updateUploadProgress(current, total, percent, fileName) {
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            const progressText = document.querySelector('#uploadProgress .progress-text');

            if (progressBar && progressText) {
                const overallPercent = Math.round(((current - 1) * 100 + percent) / total);
                progressBar.style.width = overallPercent + '%';
                progressText.textContent = 'æ­£åœ¨ä¸Šä¼  ' + fileName + ' (' + current + '/' + total + ') - ' + percent + '%';
            }
        }

        // æŸ¥çœ‹æ–‡æ¡£è¯¦æƒ…
        async function viewDocumentDetail(docId) {
            try {
                const response = await axios.get('/api/knowledge_base/documents/' + docId);
                if (response.data.success) {
                    const doc = response.data.data;
                    showDocumentDetailModal(doc);
                }
            } catch (error) {
                console.error('è·å–æ–‡æ¡£è¯¦æƒ…å¤±è´¥:', error);
                showAlert('è·å–æ–‡æ¡£è¯¦æƒ…å¤±è´¥', 'danger');
            }
        }

        // æ˜¾ç¤ºæ–‡æ¡£è¯¦æƒ…æ¨¡æ€æ¡†
        function showDocumentDetailModal(doc) {
            const privacyNames = ['', 'ğŸŒ å…¬å¼€', 'ğŸ¢ å†…éƒ¨', 'ğŸ”’ æœºå¯†', 'ğŸš« ç»å¯†'];
            const categoryNames = {
                'tech': 'ğŸ”§ æŠ€æœ¯æ–‡æ¡£',
                'impl': 'ğŸ“‹ å®æ–½æ–¹æ¡ˆ',
                'service': 'ğŸ› ï¸ æœåŠ¡æ–‡æ¡£'
            };

            const modalHtml = `
                <div class="modal fade" id="documentDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">æ–‡æ¡£è¯¦æƒ…</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6>' + doc.original_filename + '</h6>
                                        <p class="text-muted mb-3">' + (doc.description || 'æš‚æ— æè¿°') + '</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="privacy-badge privacy-' + (doc.privacy_classification || 1) + '">
                                            ' + privacyNames[doc.privacy_classification || 1] + '
                                        </span>
                                        <br>
                                        <span class="doc-category-badge doc-category-' + (doc.document_category || 'tech') + ' mt-2">
                                            ' + categoryNames[doc.document_category || 'tech'] + '
                                        </span>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <strong>æ–‡ä»¶å¤§å°ï¼š</strong>' + (doc.file_size && (doc.file_size / (1024 * 1024)).toFixed(2) || '0') + ' MB<br>
                                        <strong>æ–‡ä»¶ç±»å‹ï¼š</strong>' + (doc.file_type || 'æœªçŸ¥') + '<br>
                                        <strong>ä¸Šä¼ æ—¶é—´ï¼š</strong>' + (doc.upload_time && new Date(doc.upload_time).toLocaleString() || 'æœªçŸ¥') + '
                                    </div>
                                    <div class="col-md-6">
                                        <strong>å¤„ç†çŠ¶æ€ï¼š</strong>
                                        <span class="badge bg-' + (doc.parse_status === 'completed' && 'success' || 'warning') + '">' + (doc.parse_status || 'pending') + '</span><br>
                                        <strong>å‘é‡çŠ¶æ€ï¼š</strong>
                                        <span class="badge bg-' + (doc.vector_status === 'completed' && 'success' || 'warning') + '">' + (doc.vector_status || 'pending') + '</span>
                                    </div>
                                </div>

                                ' + (doc.tags && '
                                <div class="mt-3">
                                    <strong>æ ‡ç­¾ï¼š</strong>
                                    ' + JSON.parse(doc.tags).map(tag => '<span class="badge bg-light text-dark me-1">' + tag + '</span>').join('') + '
                                </div>
                                ' || '') + '
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                                <button type="button" class="btn btn-primary" onclick="downloadDocument(' + doc.doc_id + ')">ä¸‹è½½æ–‡æ¡£</button>
                                <button type="button" class="btn btn-info" onclick="previewDocument(' + doc.doc_id + ')">é¢„è§ˆæ–‡æ¡£</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
            const existingModal = document.getElementById('documentDetailModal');
            if (existingModal) {
                existingModal.remove();
            }

            // æ·»åŠ æ–°æ¨¡æ€æ¡†å¹¶æ˜¾ç¤º
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('documentDetailModal')).show();
        }

        // ä¸‹è½½æ–‡æ¡£
        function downloadDocument(docId) {
            window.open('/api/knowledge_base/documents/' + docId + '/download', '_blank');
        }

        // é¢„è§ˆæ–‡æ¡£
        async function previewDocument(docId) {
            try {
                const response = await axios.get('/api/knowledge_base/documents/' + docId + '/preview');
                if (response.data.success) {
                    showDocumentPreview(response.data.content);
                }
            } catch (error) {
                console.error('é¢„è§ˆæ–‡æ¡£å¤±è´¥:', error);
                showAlert('é¢„è§ˆæ–‡æ¡£å¤±è´¥', 'danger');
            }
        }

        // æ˜¾ç¤ºæ–‡æ¡£é¢„è§ˆ
        function showDocumentPreview(content) {
            const previewHtml = `
                <div class="modal fade" id="documentPreviewModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">æ–‡æ¡£é¢„è§ˆ</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="document-preview" style="max-height: 500px; overflow-y: auto;">
                                    ' + content + '
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤å·²å­˜åœ¨çš„é¢„è§ˆæ¨¡æ€æ¡†
            const existingModal = document.getElementById('documentPreviewModal');
            if (existingModal) {
                existingModal.remove();
            }

            // æ·»åŠ æ–°é¢„è§ˆæ¨¡æ€æ¡†å¹¶æ˜¾ç¤º
            document.body.insertAdjacentHTML('beforeend', previewHtml);
            new bootstrap.Modal(document.getElementById('documentPreviewModal')).show();
        }

        // åˆ é™¤æ–‡æ¡£
        async function deleteDocument(docId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡æ¡£å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await axios.delete('/api/knowledge_base/documents/' + docId);
                if (response.data.success) {
                    showAlert('æ–‡æ¡£åˆ é™¤æˆåŠŸ', 'success');
                    // åˆ·æ–°å½“å‰äº§å“è¯¦æƒ…
                    if (currentProductId) {
                        selectProduct(currentProductId, '');
                    }
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡æ¡£å¤±è´¥:', error);
                showAlert('åˆ é™¤æ–‡æ¡£å¤±è´¥', 'danger');
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // åˆ·æ–°çŸ¥è¯†åº“æ•°æ®
        async function refreshKnowledgeBase() {
            try {
                const button = event.target;
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>åˆ·æ–°ä¸­...';
                button.disabled = true;

                await loadCompanies();
                await loadStatistics();

                showAlert('æ•°æ®åˆ·æ–°æˆåŠŸ', 'success');

                setTimeout(() => {
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                }, 1000);
            } catch (error) {
                console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
                showAlert('åˆ·æ–°æ•°æ®å¤±è´¥', 'danger');

                const button = event.target;
                button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>åˆ·æ–°æ•°æ®';
                button.disabled = false;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadCompanies();
            loadStatistics();
        });

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStatistics() {
            try {
                const response = await axios.get('/api/knowledge_base/statistics');
                if (response.data.success) {
                    const stats = response.data.data;
                    updateStatisticsDisplay(stats);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
        function updateStatisticsDisplay(stats) {
            document.getElementById('totalCompanies').textContent = stats.totalCompanies || 0;
            document.getElementById('totalProducts').textContent = stats.totalProducts || 0;
            document.getElementById('totalDocuments').textContent = stats.totalDocuments || 0;
            document.getElementById('confidentialDocs').textContent = stats.confidentialDocs || 0;
        }

        // æ˜¾ç¤ºæ™ºèƒ½æ£€ç´¢æ¨¡æ€æ¡†
        function showSearchModal() {
            const searchHtml = `
                <div class="modal fade" id="searchModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-brain me-2"></i>AIæ™ºèƒ½æ£€ç´¢
                                    <small class="text-muted ms-2">æ”¯æŒè¯­ä¹‰æœç´¢å’Œå…³é”®è¯æœç´¢</small>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- æœç´¢é…ç½®åŒºåŸŸ -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-chat-square-text me-1"></i>æœç´¢é—®é¢˜
                                        </label>
                                        <textarea class="form-control form-control-lg" id="searchQuery" rows="3"
                                                  placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š5Gæ ¸å¿ƒç½‘çš„ä¸»è¦æŠ€æœ¯æ¶æ„æ˜¯ä»€ä¹ˆï¼Ÿ"></textarea>
                                        <div class="form-text">
                                            <i class="bi bi-lightbulb me-1"></i>
                                            æç¤ºï¼šä½¿ç”¨è¯­ä¹‰æœç´¢å¯ä»¥æ›´å¥½åœ°ç†è§£è‡ªç„¶è¯­è¨€é—®é¢˜
                                        </div>
                                    </div>
                                </div>

                                <!-- æœç´¢æ–¹å¼é€‰æ‹© -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-gear me-1"></i>æœç´¢æ–¹å¼
                                        </label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="searchMode" id="semanticSearch" value="semantic" checked>
                                            <label class="btn btn-outline-primary" for="semanticSearch">
                                                <i class="bi bi-brain me-1"></i>è¯­ä¹‰æœç´¢
                                            </label>
                                            <input type="radio" class="btn-check" name="searchMode" id="keywordSearch" value="keyword">
                                            <label class="btn btn-outline-primary" for="keywordSearch">
                                                <i class="bi bi-search me-1"></i>å…³é”®è¯
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            <small id="searchModeHelp">è¯­ä¹‰æœç´¢ï¼šç†è§£è¯­ä¹‰å’Œä¸Šä¸‹æ–‡</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">æ–‡æ¡£ç±»å‹</label>
                                        <select class="form-control" id="searchCategory">
                                            <option value="">å…¨éƒ¨ç±»å‹</option>
                                            <option value="tech">ğŸ”§ æŠ€æœ¯æ–‡æ¡£</option>
                                            <option value="impl">ğŸ“‹ å®æ–½æ–¹æ¡ˆ</option>
                                            <option value="service">ğŸ› ï¸ æœåŠ¡æ–‡æ¡£</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">éšç§çº§åˆ«</label>
                                        <select class="form-control" id="searchPrivacy">
                                            <option value="">å…¨éƒ¨çº§åˆ«</option>
                                            <option value="1">ğŸŒ å…¬å¼€æ–‡æ¡£</option>
                                            <option value="2">ğŸ¢ å†…éƒ¨æ–‡æ¡£</option>
                                            <option value="3">ğŸ”’ æœºå¯†æ–‡æ¡£</option>
                                            <option value="4">ğŸš« ç»å¯†æ–‡æ¡£</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- é«˜çº§æœç´¢é€‰é¡¹ -->
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptions">
                                            <i class="bi bi-sliders me-1"></i>é«˜çº§é€‰é¡¹
                                        </button>
                                    </div>
                                    <div class="collapse" id="advancedOptions">
                                        <div class="card card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">ç»“æœæ•°é‡</label>
                                                    <select class="form-select" id="searchLimit">
                                                        <option value="5">5 ä¸ªç»“æœ</option>
                                                        <option value="10" selected>10 ä¸ªç»“æœ</option>
                                                        <option value="20">20 ä¸ªç»“æœ</option>
                                                        <option value="50">50 ä¸ªç»“æœ</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">ç›¸ä¼¼åº¦é˜ˆå€¼</label>
                                                    <input type="range" class="form-range" id="similarityThreshold" min="0" max="1" step="0.1" value="0.3">
                                                    <div class="form-text">å½“å‰å€¼: <span id="thresholdValue">0.3</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- æœç´¢ç»“æœåŒºåŸŸ -->
                                <div id="searchResults" class="mt-3"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i>å…³é—­
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="clearSearchHistory()">
                                    <i class="bi bi-trash me-1"></i>æ¸…ç©ºå†å²
                                </button>
                                <button type="button" class="btn btn-primary" onclick="performSearch()">
                                    <i class="bi bi-search me-1"></i>å¼€å§‹æœç´¢
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤å·²å­˜åœ¨çš„æœç´¢æ¨¡æ€æ¡†
            const existingModal = document.getElementById('searchModal');
            if (existingModal) {
                existingModal.remove();
            }

            // æ·»åŠ æ–°æœç´¢æ¨¡æ€æ¡†å¹¶æ˜¾ç¤º
            document.body.insertAdjacentHTML('beforeend', searchHtml);

            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initSearchModalEventListeners();

            new bootstrap.Modal(document.getElementById('searchModal')).show();
        }

        // åˆå§‹åŒ–æœç´¢æ¨¡æ€æ¡†äº‹ä»¶ç›‘å¬å™¨
        function initSearchModalEventListeners() {
            // æœç´¢æ–¹å¼åˆ‡æ¢æç¤ºæ–‡æœ¬
            const searchModeInputs = document.querySelectorAll('input[name="searchMode"]');
            const searchModeHelp = document.getElementById('searchModeHelp');

            searchModeInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === 'semantic') {
                        searchModeHelp.textContent = 'è¯­ä¹‰æœç´¢ï¼šç†è§£è¯­ä¹‰å’Œä¸Šä¸‹æ–‡';
                        document.getElementById('advancedOptions').style.display = 'block';
                    } else {
                        searchModeHelp.textContent = 'å…³é”®è¯æœç´¢ï¼šåŒ¹é…ç²¾ç¡®å…³é”®è¯';
                        document.getElementById('advancedOptions').style.display = 'none';
                    }
                });
            });

            // ç›¸ä¼¼åº¦é˜ˆå€¼æ»‘å—
            const thresholdSlider = document.getElementById('similarityThreshold');
            const thresholdValue = document.getElementById('thresholdValue');

            if (thresholdSlider && thresholdValue) {
                thresholdSlider.addEventListener('input', function() {
                    thresholdValue.textContent = this.value;
                });
            }

            // åŠ è½½æœç´¢å†å²
            loadSearchHistory();
        }

        // åŠ è½½æœç´¢å†å²
        function loadSearchHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                if (history.length > 0) {
                    const historyHtml = `
                        <div class="mb-3">
                            <h6 class="text-muted">
                                <i class="bi bi-clock-history me-1"></i>æœ€è¿‘æœç´¢
                            </h6>
                            <div class="d-flex flex-wrap gap-1">
' + history.slice(0, 5).map(query =>
                                    '<button class="btn btn-sm search-history-btn" onclick="fillSearchQuery(\'' + query + '\')">
                                        <i class="bi bi-clock-history me-1"></i>' + query + '
                                    </button>'
                                ).join('') + '
                            </div>
                        </div>
                    `;
                    document.getElementById('searchResults').innerHTML = historyHtml;
                }
            } catch (e) {
                console.warn('æœç´¢å†å²åŠ è½½å¤±è´¥:', e);
            }
        }

        // å¡«å……æœç´¢æŸ¥è¯¢
        function fillSearchQuery(query) {
            document.getElementById('searchQuery').value = query;
        }

        // æ¸…ç©ºæœç´¢å†å²
        function clearSearchHistory() {
            localStorage.removeItem('searchHistory');
            document.getElementById('searchResults').innerHTML = '';
            showAlert('æœç´¢å†å²å·²æ¸…ç©º', 'success');
        }

        // ä¿å­˜æœç´¢å†å²
        function saveSearchHistory(query) {
            try {
                let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                history = history.filter(item => item !== query); // å»é‡
                history.unshift(query); // æ·»åŠ åˆ°å¼€å¤´
                history = history.slice(0, 10); // åªä¿ç•™æœ€è¿‘10æ¬¡
                localStorage.setItem('searchHistory', JSON.stringify(history));
            } catch (e) {
                console.warn('æœç´¢å†å²ä¿å­˜å¤±è´¥:', e);
            }
        }

        // æ‰§è¡Œæ™ºèƒ½æœç´¢
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const category = document.getElementById('searchCategory').value;
            const privacy = document.getElementById('searchPrivacy').value;
            const searchMode = document.querySelector('input[name="searchMode"]:checked').value;
            const limit = document.getElementById('searchLimit').value;
            const threshold = document.getElementById('similarityThreshold').value;

            if (!query) {
                showAlert('è¯·è¾“å…¥æœç´¢é—®é¢˜', 'warning');
                return;
            }

            // ä¿å­˜æœç´¢å†å²
            saveSearchHistory(query);

            const resultsContainer = document.getElementById('searchResults');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const searchModeText = searchMode === 'semantic' && 'è¯­ä¹‰æœç´¢' || 'å…³é”®è¯æœç´¢';
            resultsContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">æœç´¢ä¸­...</span>
                    </div>
                    <div class="mt-3">
                        <h6 class="text-muted">æ­£åœ¨è¿›è¡Œ' + searchModeText + '...</h6>
                        <p class="small text-muted mb-0">
                            <i class="bi bi-search me-1"></i>æŸ¥è¯¢: "' + query.substring(0, 50) + (query.length > 50 ? '...' : '') + '""
                        </p>
                        <p class="small text-muted">
                            <i class="bi bi-gear me-1"></i>æ¨¡å¼: ' + searchModeText + ' |
                            <i class="bi bi-funnel me-1"></i>ç»“æœæ•°: ' + limit + '
                            ' + (searchMode === 'semantic' && ' | <i class="bi bi-speedometer2 me-1"></i>é˜ˆå€¼: ' + threshold || '') + '
                        </p>
                    </div>
                </div>
            `;

            try {
                let response;
                let searchStartTime = Date.now();

                if (searchMode === 'semantic') {
                    // ä½¿ç”¨è¯­ä¹‰æœç´¢API
                    response = await axios.post('/api/vector_search/search', {
                        query: query,
                        top_k: parseInt(limit),
                        threshold: parseFloat(threshold),
                        filters: {
                            category: category || null,
                            privacy_level: privacy || null
                        }
                    });
                } else {
                    // ä½¿ç”¨ä¼ ç»Ÿå…³é”®è¯æœç´¢API
                    response = await axios.post('/api/knowledge_base/search', {
                        query: query,
                        category: category,
                        privacy_level: privacy,
                        limit: parseInt(limit)
                    });
                }

                const searchTime = (Date.now() - searchStartTime) / 1000;

                if (response.data.success) {
                    displaySearchResults(response.data.data, searchMode, searchTime);
                } else {
                    resultsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            æœç´¢å¤±è´¥: ' + (response.data.error || 'æœªçŸ¥é”™è¯¯') + '
                        </div>
                    `;
                }
            } catch (error) {
                console.error('æœç´¢å¤±è´¥:', error);
                const errorMessage = (error.response && error.response.data && error.response.data.error) ? error.response.data.error : (error.message || 'ç½‘ç»œè¿æ¥é”™è¯¯');
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        æœç´¢å¤±è´¥: ' + errorMessage + '
                        <div class="mt-2 small">
                            <button class="btn btn-outline-danger btn-sm" onclick="performSearch()">
                                <i class="bi bi-arrow-clockwise me-1"></i>é‡è¯•
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results, searchMode = 'keyword', searchTime = 0) {
            const resultsContainer = document.getElementById('searchResults');

            if (!results || results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>æœªæ‰¾åˆ°ç›¸å…³æ–‡æ¡£</strong>
                        <div class="mt-2 small">
                            <p class="mb-1">å»ºè®®å°è¯•ï¼š</p>
                            <ul class="mb-0">
                                <li>ä½¿ç”¨ä¸åŒçš„å…³é”®è¯</li>
                                <li>å°è¯•è¯­ä¹‰æœç´¢æ¨¡å¼</li>
                                <li>è°ƒä½ç›¸ä¼¼åº¦é˜ˆå€¼</li>
                                <li>é€‰æ‹©ä¸åŒçš„æ–‡æ¡£ç±»å‹æˆ–éšç§çº§åˆ«</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }

            // æ ¹æ®æœç´¢æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„ç»“æœ
            const resultsHtml = results.map((result, index) => {
                // è¯­ä¹‰æœç´¢å’Œå…³é”®è¯æœç´¢çš„ç»“æœæ ¼å¼å¯èƒ½ä¸åŒ
                const isSemanticResult = searchMode === 'semantic';
                const similarity_score = isSemanticResult &&
                    (result.similarity_score || result.relevance_score) ||
                    (result.relevance_score || 0);

                const title = result.title || result.filename || result.original_filename || ('æ–‡æ¡£ ' + result.doc_id);
                const summary = result.summary || result.content_snippet || result.content || 'æš‚æ— æ‘˜è¦';
                const privacy_level = result.privacy_classification || result.privacy_level || 1;
                const category = result.category || result.document_category || 'unknown';

                // æ ¹æ®ç›¸ä¼¼åº¦è®¾ç½®é¢œè‰²
                let scoreColor = 'secondary';
                if (similarity_score > 0.8) scoreColor = 'success';
                else if (similarity_score > 0.6) scoreColor = 'primary';
                else if (similarity_score > 0.4) scoreColor = 'warning';

                return `
                    <div class="card mb-3 shadow-sm search-result-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">
                                        <span class="badge bg-light text-dark me-2">#' + (index + 1) + '</span>
                                        <i class="bi bi-file-earmark-text me-1"></i>
                                        ' + title + '
                                    </h6>
                                    <div class="small text-muted">
                                        ' + (isSemanticResult &&
                                            '<i class="bi bi-cpu me-1"></i>è¯­ä¹‰åŒ¹é…' ||
                                            '<i class="bi bi-search me-1"></i>å…³é”®è¯åŒ¹é…') + '
                                        <span class="mx-1">â€¢</span>
                                        æ–‡æ¡£ID: ' + result.doc_id + '
                                        ' + (result.chunk_id && '<span class="mx-1">â€¢</span>ç‰‡æ®µID: ' + result.chunk_id || '') + '
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="privacy-badge privacy-' + privacy_level + '">
                                        ' + ['', 'ğŸŒ å…¬å¼€', 'ğŸ¢ å†…éƒ¨', 'ğŸ”’ æœºå¯†', 'ğŸš« ç»å¯†'][privacy_level] + '
                                    </span>
                                </div>
                            </div>

                            <p class="card-text small mb-2" style="line-height: 1.4;">
                                ' + (summary.length > 200 ? summary.substring(0, 200) + '...' : summary) + '
                            </p>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-' + scoreColor + ' me-2">
                                        ' + (isSemanticResult && 'ç›¸ä¼¼åº¦' || 'ç›¸å…³åº¦') + ': ' + (similarity_score * 100).toFixed(1) + '%
                                    </span>
                                    ' + (category && category !== 'unknown' && '
                                        <span class="badge bg-secondary me-2">
                                            ' + ({'tech': 'ğŸ”§ æŠ€æœ¯', 'impl': 'ğŸ“‹ å®æ–½', 'service': 'ğŸ› ï¸ æœåŠ¡'}[category] || category) + '
                                        </span>
                                    ' || ''}
                                    ' + (result.file_type && '
                                        <span class="badge bg-info me-2">' + result.file_type.toUpperCase() + '</span>
                                    ' || '') + '
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewDocumentDetail(' + result.doc_id + ')" title="æŸ¥çœ‹è¯¦æƒ…">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="downloadDocument(' + result.doc_id + ')" title="ä¸‹è½½æ–‡æ¡£">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    ' + (isSemanticResult && result.chunk_id && '
                                        <button class="btn btn-outline-info" onclick="viewChunkDetail(' + result.chunk_id + ')" title="æŸ¥çœ‹ç‰‡æ®µ">
                                            <i class="bi bi-zoom-in"></i>
                                        </button>
                                    ' || '')
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // æœç´¢ç»“æœç»Ÿè®¡
            const avgScore = results.reduce((sum, r) => sum + (r.similarity_score || r.relevance_score || 0), 0) / results.length;
            const modeText = searchMode === 'semantic' && 'è¯­ä¹‰æœç´¢' || 'å…³é”®è¯æœç´¢';

            resultsContainer.innerHTML = `
                <div class="alert search-stats d-flex justify-content-between align-items-center border-0 shadow-sm">
                    <div>
                        <i class="bi bi-check-circle me-2 fs-5"></i>
                        æ‰¾åˆ° <strong>' + results.length + '</strong> ä¸ªç›¸å…³æ–‡æ¡£
                        <div class="mt-1 small opacity-90">
                            <i class="bi bi-gear me-1"></i>æœç´¢æ¨¡å¼: ' + modeText + '
                            <span class="mx-2">â€¢</span>
                            <i class="bi bi-stopwatch me-1"></i>è€—æ—¶: ' + searchTime.toFixed(2) + 's'
                            <span class="mx-2">â€¢</span>
                            <i class="bi bi-speedometer2 me-1"></i>å¹³å‡' + (searchMode === 'semantic' && 'ç›¸ä¼¼åº¦' || 'ç›¸å…³åº¦') + ': ' + (avgScore * 100).toFixed(1) + '%'
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-light" onclick="exportSearchResults()" title="å¯¼å‡ºç»“æœ">
                            <i class="bi bi-download me-1"></i>å¯¼å‡º
                        </button>
                    </div>
                </div>
                ' + resultsHtml + '
            `;
        }

        // æŸ¥çœ‹ç‰‡æ®µè¯¦æƒ…
        function viewChunkDetail(chunkId) {
            // è¿™é‡Œå¯ä»¥å®ç°æŸ¥çœ‹å…·ä½“æ–‡æ¡£ç‰‡æ®µçš„åŠŸèƒ½
            showAlert('ç‰‡æ®µæŸ¥çœ‹åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // å¯¼å‡ºæœç´¢ç»“æœ
        function exportSearchResults() {
            // è¿™é‡Œå¯ä»¥å®ç°æœç´¢ç»“æœå¯¼å‡ºåŠŸèƒ½
            showAlert('æœç´¢ç»“æœå¯¼å‡ºåŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }
    </script>


</body>
</html>