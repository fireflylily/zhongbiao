<!--
════════════════════════════════════════════════════════════════════════════════════════
                    前端架构统一重构计划 (index.html + knowledge_base.html)
════════════════════════════════════════════════════════════════════════════════════════

📊 现状分析：
  index.html:         6103行，275KB，~621行JavaScript代码
  knowledge_base.html: 3073行，157KB，~963行JavaScript代码

🔍 共同问题：
  1. 巨型单文件架构 - HTML+CSS+JS混合
  2. 定时器资源泄漏 - setInterval未正确清理
  3. 内存泄漏风险 - 事件监听器、DOM引用未清理
  4. 代码重复冗余 - 相同组件在多个页面重复实现
  5. 维护困难 - 缺乏模块化和组件化

🎯 统一重构目标：
  - 建立共享组件体系，60%+代码复用率
  - 主HTML文件减少75% (< 1500行)
  - 解决页面"死机"和性能问题
  - 建立可持续的前端架构

📁 共享架构设计：

阶段一：共享基础设施 (🔥最高优先级)
  /static/css/
  ├── base/
  │   ├── variables.css           # CSS变量定义 (配色、间距等)
  │   ├── bootstrap-overrides.css # Bootstrap统一覆盖
  │   └── animations.css          # 共同动画效果
  ├── components/
  │   ├── buttons.css            # 按钮组件样式
  │   ├── cards.css              # 卡片组件样式
  │   ├── modals.css             # 模态框样式
  │   ├── privacy-badges.css     # 隐私标识样式
  │   └── navigation.css         # 导航栏样式
  ├── knowledge_base.css         # 知识库特定样式
  └── index.css                  # 首页特定样式

  /static/js/
  ├── core/
  │   ├── api-client.js          # 统一API调用封装
  │   ├── notification.js        # 通知系统
  │   ├── validation.js          # 表单验证
  │   ├── timer-manager.js       # 定时器管理 (已存在)
  │   └── progress-manager.js    # 进度管理 (已存在)
  ├── components/
  │   ├── file-upload.js         # 文件上传组件
  │   ├── company-selector.js    # 公司选择器
  │   └── modal-manager.js       # 模态框管理

阶段二：页面特定重构 (⚡中优先级)
  /static/js/pages/
  ├── knowledge-base/
  │   ├── category-manager.js    # 分类管理
  │   ├── document-manager.js    # 文档管理
  │   └── search-manager.js      # 搜索功能
  ├── index/
  │   ├── proposal-generator.js  # 标书生成
  │   ├── tender-processor.js    # 招标文件处理
  │   └── dashboard-manager.js   # 仪表板管理

  /templates/components/
  ├── layout/
  │   ├── base.html              # 基础布局模板
  │   └── navbar.html            # 导航栏组件
  ├── shared/
  │   ├── company-selector.html  # 公司选择器
  │   ├── file-upload.html       # 文件上传区域
  │   ├── progress-bars.html     # 进度条组件
  │   └── modal-dialogs.html     # 模态框组件
  ├── knowledge-base/
  │   ├── category-tree.html     # 分类树组件
  │   └── document-list.html     # 文档列表组件
  └── index/
      ├── sidebar.html           # 首页侧边栏
      └── upload-area.html       # 上传区域组件

阶段三：性能优化 (🚀低优先级)
  1. 懒加载策略 - 按需加载组件和数据
  2. 缓存机制 - 前端数据缓存和状态管理
  3. 代码分割 - 按功能模块分割JavaScript包
  4. 资源优化 - 图片压缩、CSS/JS压缩合并

🔧 实施策略：
  1. 共享优先 - 先建立共同组件，再处理页面特定功能
  2. 渐进式重构 - 不影响现有功能的前提下逐步迁移
  3. 组件化开发 - 每个组件独立开发、测试、部署
  4. 统一规范 - 代码风格、命名约定、API设计保持一致

📈 预期收益：
  ✅ 代码复用率提升60%+ - 共享组件和样式
  ✅ 维护成本降低 - 统一的架构和规范
  ✅ 开发效率提升 - 组件化开发模式
  ✅ 性能改善 - 减少重复代码，优化加载
  ✅ 页面稳定性 - 解决定时器泄漏和内存问题

⚠️ 风险控制：
  - 分阶段实施，每个阶段独立测试验证
  - 保持API向后兼容，支持快速回滚
  - 共享组件变更需要回归测试所有页面
  - 建立组件文档和使用规范

📝 实施记录：
  - 2024-09-27: 建立统一重构计划
  - 已完成: timer-manager.js, progress-manager.js
  - 进行中: CSS样式分离和JavaScript模块化
  - 待完成: 组件模板化和性能优化

════════════════════════════════════════════════════════════════════════════════════════
-->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企业知识库管理 - AI标书系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/litera/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/common.css" rel="stylesheet">
    <!-- 新的组件化CSS架构 -->
    <link href="/static/css/main.css" rel="stylesheet">
    <!-- 所有样式已移至组件化CSS架构 - 请查看 /static/css/main.css -->
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top">
        <div class="container-fluid">

            <div class="navbar-brand d-flex align-items-center">
                <!-- 中国联通官方Logo -->
                <div class="unicom-logo me-3">
                    <svg width="120" height="40" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="unicomKnotGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#4a89dc;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#3d6cb9;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2c5282;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <!-- 中国联通结绳标志 -->
                        <g transform="translate(5, 5)">
                            <path d="M25 5 C35 5, 45 15, 45 25 C45 35, 35 45, 25 45 C15 45, 5 35, 5 25"
                                  fill="none" stroke="url(#unicomKnotGradient)" stroke-width="3"/>
                            <path d="M25 15 C30 15, 35 20, 35 25 C35 30, 30 35, 25 35"
                                  fill="none" stroke="url(#unicomKnotGradient)" stroke-width="2"/>
                            <circle cx="20" cy="25" r="3" fill="url(#unicomKnotGradient)"/>
                            <circle cx="30" cy="25" r="3" fill="url(#unicomKnotGradient)"/>
                        </g>
                        <!-- 中国联通文字 -->
                        <g transform="translate(65, 20)">
                            <text x="0" y="0" font-family="'Microsoft YaHei', sans-serif" font-size="16" font-weight="bold" fill="#4a89dc">中国联通</text>
                            <text x="0" y="18" font-family="'Microsoft YaHei', sans-serif" font-size="10" fill="#666">CHINA UNICOM</text>
                        </g>
                    </svg>
                </div>
                <div class="brand-text ms-2">
                    <h6 class="brand-title mb-0">元景AI智能标书生成平台 - 知识库</h6>
                    <small class="brand-subtitle text-muted">企业信息与文档管理</small>
                </div>
            </div>

            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-grid-3x3-gap me-2"></i>
                        应用菜单
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/"><i class="bi bi-house me-2"></i>标书生成</a></li>
                        <li><a class="dropdown-item active" href="/knowledge_base"><i class="bi bi-collection me-2"></i>知识库管理</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>系统设置</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="margin-top: 70px; min-height: calc(100vh - 70px);">
        <div class="row g-0">
            <!-- 左侧树形导航 -->
            <div class="col-md-3 p-0">
                <div class="card shadow-sm border-0 h-100" style="border-radius: 0;">
                    <div class="card-body p-0" style="max-height: calc(100vh - 70px); overflow-y: auto;">
                        <div class="p-3">
                            <div id="companyTree">
                                <!-- 企业树形结构会在这里动态渲染 -->
                                <div class="text-center py-5">
                                    <div class="mb-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-0">正在加载企业数据...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧内容区 -->
            <div class="col-md-9 p-4 bg-light" style="border-left: 1px solid #dee2e6;">

                <!-- 主内容区 -->
                <div id="mainContent">
                    <!-- 默认显示欢迎页面 -->
                    <div class="container-fluid px-0">
                        <!-- 页面头部 -->
                        <div class="row mb-4">
                            <div class="col-lg-8">
                                <div class="card shadow-sm border-0">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                                                <i class="bi bi-collection text-primary fs-3"></i>
                                            </div>
                                            <div>
                                                <h2 class="mb-1 fw-bold">企业知识库管理系统</h2>
                                                <p class="text-muted mb-0 fs-6">智能文档管理，助力企业数字化转型</p>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-wrap gap-2">
                                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
                                                <i class="bi bi-shield-check me-1"></i>安全存储
                                            </span>
                                            <span class="badge bg-success bg-opacity-10 text-success px-3 py-2 rounded-pill">
                                                <i class="bi bi-search me-1"></i>智能检索
                                            </span>
                                            <span class="badge bg-info bg-opacity-10 text-info px-3 py-2 rounded-pill">
                                                <i class="bi bi-people me-1"></i>协同管理
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card shadow-sm border-0 h-100">
                                    <div class="card-body p-4 text-center d-flex flex-column justify-content-center">
                                        <i class="bi bi-arrow-left-circle text-primary fs-1 mb-3"></i>
                                        <h6 class="mb-2">需要生成标书？</h6>
                                        <p class="text-muted small mb-3">快速返回标书生成页面</p>
                                        <a href="/" class="btn btn-primary btn-sm">
                                            <i class="bi bi-arrow-left me-2"></i>返回标书生成
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 关键数据统计 - 大卡片设计 -->
                        <div class="row g-4 mb-5" id="statisticsOverview">
                            <div class="col-xl-3 col-md-6">
                                <div class="card shadow-sm border-0 kb-stat-card h-100">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small fw-medium mb-1">企业总数</div>
                                                <div class="display-6 fw-bold text-primary" id="totalCompanies">0</div>
                                                <div class="text-success small mt-1">
                                                    <i class="bi bi-arrow-up me-1"></i>
                                                    <span>活跃管理</span>
                                                </div>
                                            </div>
                                            <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                                                <i class="bi bi-building text-primary fs-2"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card shadow-sm border-0 kb-stat-card h-100">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small fw-medium mb-1">产品总数</div>
                                                <div class="display-6 fw-bold text-success" id="totalProducts">0</div>
                                                <div class="text-info small mt-1">
                                                    <i class="bi bi-graph-up me-1"></i>
                                                    <span>持续增长</span>
                                                </div>
                                            </div>
                                            <div class="bg-success bg-opacity-10 rounded-3 p-3">
                                                <i class="bi bi-box-seam text-success fs-2"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card shadow-sm border-0 kb-stat-card h-100">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small fw-medium mb-1">文档总数</div>
                                                <div class="display-6 fw-bold text-info" id="totalDocuments">0</div>
                                                <div class="text-primary small mt-1">
                                                    <i class="bi bi-cloud-check me-1"></i>
                                                    <span>云端存储</span>
                                                </div>
                                            </div>
                                            <div class="bg-info bg-opacity-10 rounded-3 p-3">
                                                <i class="bi bi-file-earmark-text text-info fs-2"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-xl-3 col-md-6">
                                <div class="card shadow-sm border-0 kb-stat-card h-100">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <div class="text-muted small fw-medium mb-1">机密文档</div>
                                                <div class="display-6 fw-bold text-warning" id="confidentialDocs">0</div>
                                                <div class="text-danger small mt-1">
                                                    <i class="bi bi-shield-lock me-1"></i>
                                                    <span>安全保护</span>
                                                </div>
                                            </div>
                                            <div class="bg-warning bg-opacity-10 rounded-3 p-3">
                                                <i class="bi bi-shield-lock text-warning fs-2"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 功能特性区域 -->
                        <div class="row g-4">
                            <div class="col-lg-4">
                                <div class="card shadow-sm border-0 feature-card h-100 overflow-hidden">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="bi bi-building text-primary fs-3"></i>
                                            </div>
                                            <h5 class="mb-0 fw-bold">企业信息库</h5>
                                        </div>
                                        <p class="text-muted mb-4">集中管理企业基础信息、资质证书、人员档案和财务文档，建立完整的企业数字化档案系统</p>
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <div class="d-flex align-items-center p-2 rounded bg-success bg-opacity-10">
                                                    <i class="bi bi-globe text-success me-2"></i>
                                                    <small class="fw-medium text-success">基础信息</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center p-2 rounded bg-primary bg-opacity-10">
                                                    <i class="bi bi-award text-primary me-2"></i>
                                                    <small class="fw-medium text-primary">资质证书</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center p-2 rounded bg-warning bg-opacity-10">
                                                    <i class="bi bi-people text-warning me-2"></i>
                                                    <small class="fw-medium text-warning">人员信息</small>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="d-flex align-items-center p-2 rounded bg-danger bg-opacity-10">
                                                    <i class="bi bi-bank text-danger me-2"></i>
                                                    <small class="fw-medium text-danger">财务文档</small>
                                                </div>
                                            </div>
                                        </div>
                                        <button class="btn btn-primary w-100" onclick="showAddCompanyModal()">
                                            <i class="bi bi-plus me-2"></i>添加新企业
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card shadow-sm border-0 feature-card h-100 overflow-hidden">
                                    <div class="card-body p-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-success bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="bi bi-box-seam text-success fs-3"></i>
                                            </div>
                                            <h5 class="mb-0 fw-bold">产品知识库</h5>
                                        </div>
                                        <p class="text-muted mb-4">系统化管理产品技术文档、实施方案和服务手册，构建全方位的产品知识体系</p>
                                        <div class="d-flex flex-column gap-2 mb-3">
                                            <div class="d-flex align-items-center p-2 rounded bg-light">
                                                <i class="bi bi-gear text-primary me-3 fs-5"></i>
                                                <div>
                                                    <div class="fw-medium small">🔧 技术文档</div>
                                                    <div class="text-muted" style="font-size: 0.75rem;">技术规格、架构设计</div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center p-2 rounded bg-light">
                                                <i class="bi bi-clipboard-check text-warning me-3 fs-5"></i>
                                                <div>
                                                    <div class="fw-medium small">📋 实施方案</div>
                                                    <div class="text-muted" style="font-size: 0.75rem;">部署指南、配置说明</div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center p-2 rounded bg-light">
                                                <i class="bi bi-tools text-info me-3 fs-5"></i>
                                                <div>
                                                    <div class="fw-medium small">🛠️ 服务文档</div>
                                                    <div class="text-muted" style="font-size: 0.75rem;">售后支持、维护手册</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="card shadow-sm border-0 feature-card h-100 overflow-hidden">
                                    <div class="card-body p-4 d-flex flex-column">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="bg-info bg-opacity-10 rounded-3 p-3 me-3">
                                                <i class="bi bi-search text-info fs-3"></i>
                                            </div>
                                            <h5 class="mb-0 fw-bold">智能检索</h5>
                                        </div>
                                        <p class="text-muted mb-4 flex-grow-1">基于AI的语义检索和知识问答系统，快速定位所需文档和信息</p>
                                        <div class="mb-4">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-lightning-charge text-warning me-2"></i>
                                                <small class="fw-medium">语义理解检索</small>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-chat-dots text-primary me-2"></i>
                                                <small class="fw-medium">智能问答系统</small>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-funnel text-success me-2"></i>
                                                <small class="fw-medium">精准权限过滤</small>
                                            </div>
                                        </div>
                                        <button class="btn btn-info w-100" onclick="showSearchModal()">
                                            <i class="bi bi-search me-2"></i>开始智能检索
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加公司模态框 -->
    <div class="modal fade" id="addCompanyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增企业</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCompanyForm">
                        <div class="mb-3">
                            <label for="companyName" class="form-label">企业名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="companyCode" class="form-label">企业代码</label>
                            <input type="text" class="form-control" id="companyCode">
                        </div>
                        <div class="mb-3">
                            <label for="industryType" class="form-label">行业类型</label>
                            <select class="form-control" id="industryType">
                                <option value="">请选择</option>
                                <option value="telecommunications">电信通信</option>
                                <option value="it_software">信息技术</option>
                                <option value="manufacturing">制造业</option>
                                <option value="finance">金融服务</option>
                                <option value="healthcare">医疗健康</option>
                                <option value="education">教育培训</option>
                                <option value="government">政府机构</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="companyDesc" class="form-label">企业描述</label>
                            <textarea class="form-control" id="companyDesc" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addCompany()">确定添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加产品模态框 -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新增产品</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label for="productName" class="form-label">产品名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="productCode" class="form-label">产品代码</label>
                            <input type="text" class="form-control" id="productCode">
                        </div>
                        <div class="mb-3">
                            <label for="productCategory" class="form-label">产品类别</label>
                            <select class="form-control" id="productCategory">
                                <option value="">请选择</option>
                                <option value="communication">通信产品</option>
                                <option value="cloud">云计算平台</option>
                                <option value="bigdata">大数据平台</option>
                                <option value="ai">人工智能</option>
                                <option value="iot">物联网</option>
                                <option value="security">网络安全</option>
                                <option value="software">软件产品</option>
                                <option value="hardware">硬件设备</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="productDesc" class="form-label">产品描述</label>
                            <textarea class="form-control" id="productDesc" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addProduct()">确定添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 文档上传模态框 -->
    <div class="modal fade" id="uploadDocumentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">上传文档</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="kb-upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <i class="bi bi-cloud-upload fs-1 text-primary"></i>
                        <h5 class="mt-3">点击或拖拽文件到这里上传</h5>
                        <p class="text-muted">支持 PDF、Word 文档</p>
                        <input type="file" id="fileInput" class="d-none" accept=".pdf,.doc,.docx" multiple>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">隐私分级 <span class="text-danger">*</span></label>
                            <select class="form-control" id="privacyLevel">
                                <option value="1">🌐 公开 - 所有用户可访问</option>
                                <option value="2">🏢 内部 - 内部用户可访问</option>
                                <option value="3">🔒 机密 - 管理员可访问</option>
                                <option value="4">🚫 绝密 - 超级管理员可访问</option>
                            </select>
                            <small class="form-text text-muted">选择合适的隐私级别，影响文档访问权限</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">文档分类 <span class="text-danger">*</span></label>
                            <select class="form-control" id="documentCategory">
                                <option value="tech">🔧 技术文档 - 技术规格、架构设计</option>
                                <option value="impl">📋 实施方案 - 部署指南、配置说明</option>
                                <option value="service">🛠️ 服务文档 - 售后支持、维护手册</option>
                            </select>
                            <small class="form-text text-muted">选择文档类型，便于分类管理</small>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">文档标签</label>
                        <input type="text" class="form-control" id="documentTags" placeholder="输入标签，用逗号分隔">
                    </div>

                    <div id="fileList" class="mt-3"></div>

                    <!-- 上传进度显示 -->
                    <div id="uploadProgress" class="mt-3 d-none">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="progress-text">准备上传...</span>
                            <span class="progress-percent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="uploadDocuments()">开始上传</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let currentCompanyId = null;
        let currentProductId = null;
        let currentLibraryId = null;
        let selectedFiles = [];

        // 初始化
        window.onload = function() {
            loadCompanies();
            setupUploadZone();
        };

        // 加载公司列表
        async function loadCompanies() {
            try {
                const response = await axios.get('/api/companies');
                if (response.data.success) {
                    renderCompanyTree(response.data.data);
                }
            } catch (error) {
                console.error('加载公司列表失败:', error);
                showAlert('加载公司列表失败', 'danger');
            }
        }

        // 渲染公司树形结构
        function renderCompanyTree(companies) {
            const treeHtml = companies.map(company => {
                return '<div class="list-group mb-3">' +
                    '<!-- 企业节点 -->' +
                    '<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"' +
                         ' onclick="toggleCompanyNode(' + company.company_id + ', \'' + company.company_name + '\')">' +
                        '<div class="d-flex align-items-center">' +
                            '<i class="bi bi-chevron-right tree-toggle me-2" id="toggle-' + company.company_id + '"></i>' +
                            '<i class="bi bi-building text-primary me-2"></i>' +
                            '<span class="fw-medium">' + company.company_name + '</span>' +
                            '<span class="badge bg-secondary ms-2">' + (company.product_count || 0) + '</span>' +
                        '</div>' +
                    '</div>' +

                    '<!-- 企业信息库节点 -->' +
                    '<div class="ms-3 d-none" id="company-profile-' + company.company_id + '">' +
                        '<div class="list-group-item list-group-item-action" onclick="selectCompanyProfile(' + company.company_id + ')">' +
                            '<div class="d-flex align-items-center">' +
                                '<i class="bi bi-person-workspace text-info me-2"></i>' +
                                '<span>企业信息库</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- 产品节点容器 -->' +
                    '<div class="ms-3 d-none" id="products-' + company.company_id + '"></div>' +
                '</div>';
            }).join('');

            document.getElementById('companyTree').innerHTML = treeHtml || '<p class="text-muted">暂无企业数据</p>';
        }

        // 切换公司节点展开/收起
        function toggleCompanyNode(companyId, companyName) {
            const toggleIcon = document.getElementById('toggle-' + companyId);
            const profileContainer = document.getElementById('company-profile-' + companyId);
            const productsContainer = document.getElementById('products-' + companyId);

            const isExpanded = !profileContainer.classList.contains('d-none');

            if (isExpanded) {
                // 收起
                toggleIcon.className = 'bi bi-chevron-right tree-toggle me-2';
                profileContainer.classList.add('d-none');
                productsContainer.classList.add('d-none');
            } else {
                // 展开
                toggleIcon.className = 'bi bi-chevron-down tree-toggle me-2';
                profileContainer.classList.remove('d-none');
                productsContainer.classList.remove('d-none');

                // 加载产品列表（如果还没有加载）
                loadCompanyProducts(companyId);
            }

            // 更新当前选中的公司
            currentCompanyId = companyId;
            selectCompany(companyId, companyName);
        }

        // 选择公司
        async function selectCompany(companyId, companyName) {
            currentCompanyId = companyId;
            currentProductId = null;

            // 更新活动状态
            document.querySelectorAll('.list-group-item-action').forEach(node => node.classList.remove('active'));
            document.querySelector('[onclick*="toggleCompanyNode(' + companyId + '"]').classList.add('active');


            // 加载公司详情
            try {
                const response = await axios.get('/api/companies/' + companyId);
                if (response.data.success) {
                    const company = response.data.data;
                    renderCompanyDetail(company);
                }
            } catch (error) {
                console.error('加载公司详情失败:', error);
                showAlert('加载公司详情失败', 'danger');
            }
        }

        // 加载公司产品列表
        async function loadCompanyProducts(companyId) {
            try {
                const response = await axios.get('/api/knowledge_base/companies/' + companyId + '/products');
                if (response.data.success) {
                    renderProductTree(companyId, response.data.data);
                }
            } catch (error) {
                console.error('加载产品列表失败:', error);
            }
        }

        // 渲染产品树形结构
        function renderProductTree(companyId, products) {
            const treeHtml = products.map(product =>
                '<div class="list-group mb-2">' +
                    '<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"' +
                         ' onclick="selectProduct(' + product.product_id + ', \'' + product.product_name + '\')">' +
                        '<div class="d-flex align-items-center">' +
                            '<i class="bi bi-box-seam text-success me-2"></i>' +
                            '<span>' + product.product_name + '</span>' +
                        '</div>' +
                    '</div>' +

                    '<!-- 产品文档分类 -->' +
                    '<div class="ms-4 d-none" id="product-categories-' + product.product_id + '">' +
                        '<div class="list-group-item list-group-item-action" onclick="selectProductCategory(' + product.product_id + ', \'tech\')">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<div class="d-flex align-items-center">' +
                                    '<i class="bi bi-gear text-primary me-2"></i>' +
                                    '<span>🔧 技术文档</span>' +
                                '</div>' +
                                '<span class="badge bg-light text-dark">' + (product.tech_docs_count || 0) + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="list-group-item list-group-item-action" onclick="selectProductCategory(' + product.product_id + ', \'impl\')">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<div class="d-flex align-items-center">' +
                                    '<i class="bi bi-clipboard-check text-warning me-2"></i>' +
                                    '<span>📋 实施方案</span>' +
                                '</div>' +
                                '<span class="badge bg-light text-dark">' + (product.impl_docs_count || 0) + '</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="list-group-item list-group-item-action" onclick="selectProductCategory(' + product.product_id + ', \'service\')">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<div class="d-flex align-items-center">' +
                                    '<i class="bi bi-tools text-info me-2"></i>' +
                                    '<span>🛠️ 服务文档</span>' +
                                '</div>' +
                                '<span class="badge bg-light text-dark">' + (product.service_docs_count || 0) + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>'
            ).join('');

            const productsContainer = document.getElementById('products-' + companyId);
            if (productsContainer) {
                productsContainer.innerHTML = treeHtml || '<p class="text-muted text-center py-2">暂无产品</p>';
            }
        }

        // 统一的选中状态管理函数
        function updateActiveState(targetSelector) {
            document.querySelectorAll('.list-group-item-action').forEach(node =>
                node.classList.remove('active')
            );
            const target = document.querySelector(targetSelector);
            if (target) target.classList.add('active');
        }

        // 选择企业信息库
        async function selectCompanyProfile(companyId) {
            currentCompanyId = companyId;
            currentProductId = null;

            // 更新活动状态
            updateActiveState('[onclick*="selectCompanyProfile(' + companyId + '"]');

            // 加载企业信息库
            try {
                // 直接调用渲染函数，不依赖后端API
                renderCompanyProfiles([]);
                console.log('企业信息库DOM渲染完成，currentCompanyId已设置为:', companyId);

                // 延迟加载所有文件状态，确保DOM渲染完成
                setTimeout(async () => {
                    console.log('开始加载公司', companyId, '的所有文件状态...');
                    await loadExistingQualifications(companyId);
                }, 500);
            } catch (error) {
                console.error('加载企业信息库失败:', error);
                showAlert('加载企业信息库失败', 'danger');
            }
        }

        // 渲染企业信息库（增强版Tab切换）
        async function renderCompanyProfiles(profiles) {
            // 先获取公司详细信息
            let companyData = null;
            try {
                const response = await axios.get('/api/companies/' + currentCompanyId);
                if (response.data.success && response.data.data) {
                    companyData = response.data.data;
                    console.log('公司数据加载成功:', companyData);
                } else {
                    console.log('公司数据格式异常:', response.data);
                }
            } catch (error) {
                console.error('获取公司详情失败:', error);
                // 如果API失败，提供一个基础的数据结构
                companyData = {
                    company_name: '智慧足动数据科技有限公司',
                    company_id: currentCompanyId
                };
            }

            const html = renderEnhancedCompanyProfile(companyData);

            document.getElementById('mainContent').innerHTML = html;

            // 初始化表单事件
            setTimeout(() => initCompanyProfileEvents(companyData), 100);
        }

        // 渲染增强型企业信息库页面
        function renderEnhancedCompanyProfile(companyData) {
            return '<div class="container-fluid px-0">' +


                '<!-- Tab导航 -->' +
                '<ul class="nav nav-tabs mb-3" id="companyProfileTabs">' +
                    '<li class="nav-item">' +
                        '<button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-basic">' +
                            '<i class="bi bi-globe text-success"></i> 基础信息' +
                        '</button>' +
                    '</li>' +
                    '<li class="nav-item">' +
                        '<button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-qualification">' +
                            '<i class="bi bi-award text-primary"></i> 资质信息' +
                        '</button>' +
                    '</li>' +
                    '<li class="nav-item">' +
                        '<button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-personnel">' +
                            '<i class="bi bi-people text-warning"></i> 人员信息' +
                        '</button>' +
                    '</li>' +
                    '<li class="nav-item">' +
                        '<button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-financial">' +
                            '<i class="bi bi-bank text-danger"></i> 财务信息' +
                        '</button>' +
                    '</li>' +
                '</ul>' +

                '<!-- Tab内容 -->' +
                '<div class="tab-content">' +
                    '<!-- 基础信息Tab -->' +
                    '<div class="tab-pane fade show active" id="tab-basic">' +
                        '<div class="card">' +
                            '<div class="card-body">' +
                                (companyData ? renderBasicInfoForm(companyData) : '<p class="text-muted">加载中...</p>') +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- 资质信息Tab -->' +
                    '<div class="tab-pane fade" id="tab-qualification">' +
                        '<div class="card">' +
                            '<div class="card-body">' +
                                renderQualificationSection() +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- 人员信息Tab -->' +
                    '<div class="tab-pane fade" id="tab-personnel">' +
                        '<div class="card">' +
                            '<div class="card-body">' +
                                renderPersonnelSection() +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<!-- 财务信息Tab -->' +
                    '<div class="tab-pane fade" id="tab-financial">' +
                        '<div class="card">' +
                            '<div class="card-body">' +
                                (companyData ? renderFinancialSection(companyData) : '<p class="text-muted">加载中...</p>') +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // 渲染分类文档
        function renderProfileDocuments(profileType) {
            // 这里应该从实际数据渲染，暂时用示例
            return '<div class="text-center py-4">' +
                '<i class="bi bi-folder text-muted fs-1"></i>' +
                '<p class="text-muted mt-2">暂无文档</p>' +
                '<button class="btn btn-outline-primary btn-sm" onclick="showProfileUploadModal(\'' + profileType + '\')">' +
                    '<i class="bi bi-plus me-1"></i>上传文档' +
                '</button>' +
            '</div>';
        }

        // 渲染基础信息表单
        function renderBasicInfoForm(companyData) {
            const data = companyData || {};
            return '<form id="companyBasicInfoForm">' +
                '<div class="row mb-3">' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">公司名称 <span class="text-danger">*</span></label>' +
                        '<input type="text" class="form-control" id="prof-companyName" value="' + (data.companyName || data.company_name || '') + '" required>' +
                    '</div>' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">成立日期</label>' +
                        '<input type="date" class="form-control" id="prof-establishDate" value="' + (data.establishDate || data.establish_date || '') + '">' +
                    '</div>' +
                '</div>' +

                '<div class="row mb-3">' +
                    '<div class="col-md-4">' +
                        '<label class="form-label">法定代表人</label>' +
                        '<input type="text" class="form-control" id="prof-legalRepresentative" value="' + (data.legalRepresentative || data.legal_representative || '') + '">' +
                    '</div>' +
                    '<div class="col-md-4">' +
                        '<label class="form-label">法定代表人职务</label>' +
                        '<input type="text" class="form-control" id="prof-legalRepresentativePosition" value="' + (data.legalRepresentativePosition || data.legal_representative_position || '') + '">' +
                    '</div>' +
                    '<div class="col-md-4">' +
                        '<label class="form-label">统一社会信用代码</label>' +
                        '<input type="text" class="form-control" id="prof-socialCreditCode" value="' + (data.socialCreditCode || data.social_credit_code || '') + '">' +
                    '</div>' +
                '</div>' +

                '<div class="row mb-3">' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">注册资本</label>' +
                        '<input type="text" class="form-control" id="prof-registeredCapital" value="' + (data.registeredCapital || data.registered_capital || '') + '">' +
                    '</div>' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">公司类型</label>' +
                        '<select class="form-select" id="prof-companyType">' +
                            '<option value="">请选择公司类型</option>' +
                            '<option value="有限责任公司" ' + ((data.companyType || data.company_type) === '有限责任公司' ? 'selected' : '') + '>有限责任公司</option>' +
                            '<option value="股份有限公司" ' + ((data.companyType || data.company_type) === '股份有限公司' ? 'selected' : '') + '>股份有限公司</option>' +
                            '<option value="合伙企业" ' + ((data.companyType || data.company_type) === '合伙企业' ? 'selected' : '') + '>合伙企业</option>' +
                            '<option value="个人独资企业" ' + ((data.companyType || data.company_type) === '个人独资企业' ? 'selected' : '') + '>个人独资企业</option>' +
                            '<option value="外商投资企业" ' + ((data.companyType || data.company_type) === '外商投资企业' ? 'selected' : '') + '>外商投资企业</option>' +
                            '<option value="其他" ' + ((data.companyType || data.company_type) === '其他' ? 'selected' : '') + '>其他</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +

                '<div class="mb-3">' +
                    '<label class="form-label">注册地址</label>' +
                    '<textarea class="form-control" id="prof-registeredAddress" rows="2">' + (data.registeredAddress || data.registered_address || '') + '</textarea>' +
                '</div>' +

                '<div class="mb-3">' +
                    '<label class="form-label">经营范围</label>' +
                    '<textarea class="form-control" id="prof-businessScope" rows="3">' + (data.businessScope || data.business_scope || '') + '</textarea>' +
                '</div>' +

                // 联系信息分组
                '<h6 class="text-primary mb-3 mt-4"><i class="bi bi-telephone"></i> 联系信息</h6>' +
                '<div class="row mb-3">' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">固定电话</label>' +
                        '<input type="text" class="form-control" id="prof-fixedPhone" value="' + (data.fixedPhone || data.fixed_phone || '') + '">' +
                    '</div>' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">传真</label>' +
                        '<input type="text" class="form-control" id="prof-fax" value="' + (data.fax || '') + '">' +
                    '</div>' +
                '</div>' +
                '<div class="row mb-3">' +
                    '<div class="col-md-4">' +
                        '<label class="form-label">邮编</label>' +
                        '<input type="text" class="form-control" id="prof-postalCode" value="' + (data.postalCode || data.postal_code || '') + '">' +
                    '</div>' +
                    '<div class="col-md-8">' +
                        '<label class="form-label">电子邮箱</label>' +
                        '<input type="email" class="form-control" id="prof-email" value="' + (data.email || '') + '">' +
                    '</div>' +
                '</div>' +
                '<div class="mb-3">' +
                    '<label class="form-label">办公地址</label>' +
                    '<textarea class="form-control" id="prof-officeAddress" rows="2">' + (data.officeAddress || data.office_address || '') + '</textarea>' +
                '</div>' +
                '<div class="row mb-3">' +
                    '<div class="col-md-6">' +
                        '<label class="form-label">员工人数规模</label>' +
                        '<select class="form-control" id="prof-employeeCount">' +
                            '<option value="">请选择员工人数规模</option>' +
                            '<option value="10人以下">10人以下</option>' +
                            '<option value="10-49人">10-49人</option>' +
                            '<option value="50-99人">50-99人</option>' +
                            '<option value="100-199人">100-199人</option>' +
                            '<option value="200-299人">200-299人</option>' +
                            '<option value="300-499人">300-499人</option>' +
                            '<option value="500-999人">500-999人</option>' +
                            '<option value="1000人以上">1000人以上</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +

                '<div class="mb-3">' +
                    '<label class="form-label">公司简介</label>' +
                    '<textarea class="form-control" id="prof-companyDescription" rows="3">' + (data.companyDescription || data.description || '') + '</textarea>' +
                '</div>' +

                '<div class="text-center mt-4">' +
                    '<button type="button" class="btn btn-success btn-lg" onclick="saveCompanyBasicInfo()">' +
                        '<i class="bi bi-save"></i> 保存基础信息' +
                    '</button>' +
                '</div>' +
            '</form>';
        }

        // 渲染资质信息部分
        function renderQualificationSection() {
            return '<div class="qualification-section">' +
                '<div class="mb-4">' +
                    '<div id="profileStandardQualifications">' +
                        renderStandardQualifications() +
                    '</div>' +
                '</div>' +

                '<div class="mb-4">' +
                    '<h6 class="text-success mb-3">' +
                        '<i class="bi bi-plus-circle"></i> 自定义资质文件' +
                    '</h6>' +

                    '<div class="card bg-light mb-3">' +
                        '<div class="card-body">' +
                            '<div class="row">' +
                                '<div class="col-md-8">' +
                                    '<input type="text" class="form-control" id="profileCustomQualificationName" ' +
                                           'placeholder="输入资质名称，如：软件著作权登记证书">' +
                                '</div>' +
                                '<div class="col-md-4">' +
                                    '<button type="button" class="btn btn-success w-100" onclick="addCustomQualificationProfile()">' +
                                        '<i class="bi bi-plus"></i> 添加资质项' +
                                    '</button>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +

                    '<div id="profileCustomQualifications">' +
                    '</div>' +
                '</div>' +

                '<div class="text-center">' +
                    '<button type="button" class="btn btn-primary btn-lg me-3" onclick="saveAllQualificationsProfile()">' +
                        '<i class="bi bi-cloud-upload"></i> 保存所有资质文件' +
                    '</button>' +
                    '<button type="button" class="btn btn-outline-secondary btn-lg" onclick="clearAllQualificationsProfile()">' +
                        '<i class="bi bi-x-circle"></i> 清空所有资质' +
                    '</button>' +
                '</div>' +
            '</div>';
        }

        // 渲染标准资质
        function renderStandardQualifications() {
            const standardQualificationTypes = [
                // 基本证件资质
                { key: 'business_license', name: '营业执照', icon: 'bi-building', category: 'basic', required: true },
                { key: 'legal_id_front', name: '法人身份证（正面）', icon: 'bi-person-badge', category: 'basic', required: true },
                { key: 'legal_id_back', name: '法人身份证（反面）', icon: 'bi-person-badge', category: 'basic', required: true },
                { key: 'auth_id_front', name: '授权人身份证（正面）', icon: 'bi-person-check', category: 'basic' },
                { key: 'auth_id_back', name: '授权人身份证（反面）', icon: 'bi-person-check', category: 'basic' },

                // ISO体系认证
                { key: 'iso9001', name: '质量管理体系认证（ISO9001）', icon: 'bi-award', category: 'iso' },
                { key: 'iso14001', name: '环境管理体系认证（ISO14001）', icon: 'bi-tree', category: 'iso' },
                { key: 'iso45001', name: '职业健康安全管理体系认证（ISO45001）', icon: 'bi-shield-check', category: 'iso' },
                { key: 'iso20000', name: '信息技术服务管理体系认证（ISO20000）', icon: 'bi-gear', category: 'iso' },
                { key: 'iso27001', name: '信息安全管理体系认证（ISO27001）', icon: 'bi-shield-lock', category: 'iso' },

                // 税务和财务资质（已移至财务信息tab）

                // 信用资质
                { key: 'credit_dishonest', name: '信用中国-失信被执行人查询', icon: 'bi-shield-x', category: 'credit' },
                { key: 'credit_corruption', name: '信用中国-重大税收违法案件查询', icon: 'bi-exclamation-triangle', category: 'credit' },
                { key: 'credit_tax', name: '信用中国-政府采购严重违法失信查询', icon: 'bi-flag', category: 'credit' },
                { key: 'credit_procurement', name: '政府采购信用查询结果', icon: 'bi-check-circle', category: 'credit' },

                // 社保和员工（已移至人员信息tab）

                // 知识产权和行业资质
                { key: 'software_copyright', name: '软件著作权登记证书', icon: 'bi-code-square', category: 'industry' },
                { key: 'patent_certificate', name: '专利证书', icon: 'bi-lightbulb', category: 'industry' },
                { key: 'high_tech', name: '高新技术企业证书', icon: 'bi-rocket', category: 'industry' },
                { key: 'software_enterprise', name: '软件企业认定证书', icon: 'bi-cpu', category: 'industry' },
                { key: 'cmmi', name: 'CMMI成熟度等级证书', icon: 'bi-diagram-3', category: 'industry' }
            ];

            const categories = {
                'basic': { name: '基本证件资质', color: 'primary' },
                'iso': { name: 'ISO体系认证', color: 'success' },
                'financial': { name: '财务税务资质', color: 'warning' },
                'credit': { name: '信用资质证明', color: 'info' },
                'employee': { name: '员工社保资质', color: 'secondary' },
                'industry': { name: '行业专业资质', color: 'danger' }
            };

            let html = '';

            Object.keys(categories).forEach(categoryKey => {
                const category = categories[categoryKey];
                const categoryQuals = standardQualificationTypes.filter(qual => qual.category === categoryKey);

                if (categoryQuals.length > 0) {
                    html += '<div class="mb-4">' +
                        '<h6 class="text-' + category.color + ' mb-3 border-bottom pb-2">' +
                            '<i class="bi bi-folder"></i> ' + category.name +
                        '</h6>' +
                        '<div class="row g-3">';

                    categoryQuals.forEach(qual => {
                        html += '<div class="col-lg-6">' +
                            renderQualificationItem(qual.name, qual.key, qual.icon, qual.required) +
                        '</div>';
                    });

                    html += '</div></div>';
                }
            });

            return html;
        }

        // 渲染资质项
        function renderQualificationItem(name, id, icon, required) {
            const borderClass = required ? 'border-warning' : '';
            const requiredBadge = required ? '<span class="badge bg-warning text-dark ms-2">必需</span>' : '';

            return '<div class="card mb-3 ' + borderClass + '">' +
                '<div class="card-body">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                        '<div class="flex-grow-1">' +
                            '<i class="bi ' + icon + ' me-2 text-primary"></i>' +
                            '<span>' + name + '</span>' +
                            requiredBadge +
                        '</div>' +
                        '<div class="btn-group">' +
                            '<input type="file" class="d-none" id="profile-qual-' + id + '" accept=".pdf,.jpg,.png,.jpeg" onchange="uploadQualificationFile(\'' + id + '\', this)">' +
                            '<button class="btn btn-sm btn-outline-primary" onclick="document.getElementById(\'profile-qual-' + id + '\').click()" title="上传文件">' +
                                '<i class="bi bi-upload"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mt-2 d-none" id="profile-status-' + id + '">' +
                        '<small class="text-muted">未上传文件</small>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // 渲染人员信息部分
        function renderPersonnelSection() {
            return '<div class="personnel-section">' +
                '<div class="mb-4">' +
                    '<h6 class="text-warning mb-3"><i class="bi bi-people"></i> 人员档案</h6>' +
                    '<div class="row g-3">' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('法定代表人身份证', 'legal_id', 'bi-person-badge') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('被授权人身份证', 'auth_id', 'bi-person-check') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('团队成员简历', 'team_resume', 'bi-file-person') +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<h6 class="text-secondary mb-3"><i class="bi bi-shield-check"></i> 社保资质</h6>' +
                    '<div class="row g-3">' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('社会保险参保证明', 'social_security', 'bi-people') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderPersonnelItem('员工社保证明', 'employee_social_security', 'bi-file-medical') +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // 渲染人员项
        function renderPersonnelItem(name, id, icon) {
            return '<div class="card mb-3 border-warning">' +
                '<div class="card-body">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                        '<div>' +
                            '<i class="bi ' + icon + ' text-warning me-2"></i>' +
                            '<span>' + name + '</span>' +
                        '</div>' +
                        '<div>' +
                            '<input type="file" class="d-none" id="pers-' + id + '" accept=".pdf,.jpg,.png" onchange="uploadQualificationFile(\'' + id + '\', this)">' +
                            '<button class="btn btn-sm btn-outline-warning" onclick="document.getElementById(\'pers-' + id + '\').click()">' +
                                '<i class="bi bi-upload"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="mt-2 d-none" id="profile-status-' + id + '">' +
                        '<small class="text-muted">未上传文件</small>' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // 渲染财务信息部分
        function renderFinancialSection(companyData) {
            const data = companyData || {};
            return '<div class="financial-section">' +
                '<div class="mb-4">' +
                    '<h6 class="text-danger mb-3"><i class="bi bi-bank"></i> 财务文档</h6>' +
                    '<div class="row g-3">' +
                        '<div class="col-md-6">' +
                            renderFinancialItem('纳税人资格证明', 'taxpayer_certificate', 'bi-receipt') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderFinancialItem('财务审计报告', 'audit_report', 'bi-file-earmark-check') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderFinancialItem('近三年财务审计报告', 'financial_audit', 'bi-graph-up') +
                        '</div>' +
                        '<div class="col-md-6">' +
                            renderFinancialItem('银行开户许可证', 'bank_account', 'bi-bank') +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="mb-4">' +
                    '<h6>银行账户信息</h6>' +
                    '<div class="row">' +
                        '<div class="col-md-6">' +
                            '<label class="form-label">开户行全称</label>' +
                            '<input type="text" class="form-control" id="prof-bankName" value="' + (data.bankName || data.bank_name || '') + '" placeholder="例：中国工商银行股份有限公司北京分行">' +
                        '</div>' +
                        '<div class="col-md-6">' +
                            '<label class="form-label">银行账号</label>' +
                            '<input type="text" class="form-control" id="prof-bankAccount" value="' + (data.bankAccount || data.bank_account || '') + '" placeholder="请输入银行账号">' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="text-center">' +
                    '<button class="btn btn-danger btn-lg" onclick="saveFinancialInfo()">' +
                        '<i class="bi bi-save"></i> 保存财务信息' +
                    '</button>' +
                '</div>' +
            '</div>';
        }

        // 渲染财务项
        function renderFinancialItem(name, id, icon) {
            return '<div class="card mb-3 border-danger">' +
                '<div class="card-body">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                        '<div>' +
                            '<i class="bi ' + icon + ' text-danger me-2"></i>' +
                            '<span>' + name + '</span>' +
                        '</div>' +
                        '<div>' +
                            '<input type="file" class="d-none" id="fin-' + id + '" accept=".pdf,.xls,.xlsx" onchange="uploadFinancialFile(\'' + id + '\', this)">' +
                            '<button class="btn btn-sm btn-outline-danger" onclick="document.getElementById(\'fin-' + id + '\').click()">' +
                                '<i class="bi bi-upload"></i>' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div id="fin-status-' + id + '" class="mt-2 d-none">' +
                        '<!-- 上传状态将在这里显示 -->' +
                    '</div>' +
                '</div>' +
            '</div>';
        }

        // 初始化企业信息库事件
        function initCompanyProfileEvents(companyData) {
            // 添加表单验证和提交事件
            console.log('初始化企业信息库事件');

            // 设置员工人数规模下拉框的值
            const employeeCountSelect = document.getElementById('prof-employeeCount');
            if (employeeCountSelect && companyData) {
                const employeeCount = companyData.employeeCount || companyData.employee_count || '';
                if (employeeCount) {
                    employeeCountSelect.value = employeeCount;
                }
            }
        }

        // 保存公司基础信息
        async function saveCompanyBasicInfo() {
            const data = {
                companyName: document.getElementById('prof-companyName').value,
                establishDate: document.getElementById('prof-establishDate').value,
                legalRepresentative: document.getElementById('prof-legalRepresentative').value,
                legalRepresentativePosition: document.getElementById('prof-legalRepresentativePosition').value,
                socialCreditCode: document.getElementById('prof-socialCreditCode').value,
                registeredCapital: document.getElementById('prof-registeredCapital').value,
                companyType: document.getElementById('prof-companyType').value,
                registeredAddress: document.getElementById('prof-registeredAddress').value,
                businessScope: document.getElementById('prof-businessScope').value,
                // 联系信息字段
                fixedPhone: document.getElementById('prof-fixedPhone').value,
                fax: document.getElementById('prof-fax').value,
                postalCode: document.getElementById('prof-postalCode').value,
                email: document.getElementById('prof-email').value,
                officeAddress: document.getElementById('prof-officeAddress').value,
                employeeCount: document.getElementById('prof-employeeCount').value,
                companyDescription: document.getElementById('prof-companyDescription').value
            };

            try {
                console.log('发送数据:', data);
                console.log('API地址:', '/api/companies/' + currentCompanyId);

                const response = await axios.put('/api/companies/' + currentCompanyId, data);
                if (response.data.success) {
                    showAlert('基础信息保存成功', 'success');
                    // 保存成功后重新加载企业详情以刷新显示
                    setTimeout(() => {
                        selectCompanyProfile(currentCompanyId);
                    }, 1000);
                } else {
                    console.error('保存失败 - 响应:', response.data);
                    showAlert('保存失败：' + (response.data.error || '未知错误'), 'danger');
                }
            } catch (error) {
                console.error('保存异常:', error);
                console.error('错误详情:', error.response);

                let errorMsg = '保存失败：';
                if (error.response) {
                    errorMsg += `HTTP ${error.response.status} - ${error.response.data?.error || error.message}`;
                } else {
                    errorMsg += error.message;
                }
                showAlert(errorMsg, 'danger');
            }
        }

        // 保存财务信息
        async function saveFinancialInfo() {
            const data = {
                bankName: document.getElementById('prof-bankName').value,
                bankAccount: document.getElementById('prof-bankAccount').value
            };

            try {
                const response = await axios.put('/api/companies/' + currentCompanyId, data);
                if (response.data.success) {
                    showAlert('财务信息保存成功', 'success');
                    // 保存成功后重新加载企业详情以刷新显示
                    setTimeout(() => {
                        selectCompanyProfile(currentCompanyId);
                    }, 1000);
                }
            } catch (error) {
                showAlert('保存失败：' + error.message, 'danger');
            }
        }

        // 渲染公司详情
        function renderCompanyDetail(company) {
            const html =

                '<div class="card mb-3">' +
                    '<div class="card-header bg-primary text-white">' +
                        '<h5 class="mb-0">' + company.company_name + '</h5>' +
                    '</div>' +
                    '<div class="card-body">' +
                        '<div class="row">' +
                            '<div class="col-md-6">' +
                                '<p><strong>企业代码：</strong>' + (company.company_code || '未设置') + '</p>' +
                                '<p><strong>行业类型：</strong>' + (company.industry_type || '未设置') + '</p>' +
                                '<p><strong>创建时间：</strong>' + (company.created_at || '未知') + '</p>' +
                            '</div>' +
                            '<div class="col-md-6">' +
                                '<p><strong>产品数量：</strong>' + (company.products && company.products.length || 0) + ' 个</p>' +
                                '<p><strong>文档总数：</strong>' + (company.stats && company.stats.total_documents || 0) + ' 份</p>' +
                            '</div>' +
                        '</div>' +
                        (company.description && ('<p class="mt-3">' + company.description + '</p>') || '') +
                    '</div>' +
                '</div>' +

                '<div class="card">' +
                    '<div class="card-header">' +
                        '<div class="d-flex justify-content-between align-items-center">' +
                            '<h6 class="mb-0">产品列表</h6>' +
                            '<button class="btn btn-sm btn-success" onclick="showAddProductModal(' + company.company_id + ')">' +
                                '<i class="bi bi-plus-circle"></i> 添加产品' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="card-body">' +
                        '<div id="productList"></div>' +
                    '</div>' +
                '</div>';

            document.getElementById('mainContent').innerHTML = html;
        }

        // 渲染产品列表
        function renderProductList(companyId, products) {
            const listHtml = products.map(product =>
                '<div class="document-item" onclick="selectProduct(' + product.product_id + ', \'' + product.product_name + '\')">' +
                    '<div class="d-flex justify-content-between align-items-center">' +
                        '<div>' +
                            '<h6 class="mb-1">' +
                                '<i class="bi bi-box-seam me-2"></i>' +
                                product.product_name +
                            '</h6>' +
                            '<small class="text-muted">' + (product.product_category || '未分类') + ' | ' + (product.document_count || 0) + ' 份文档</small>' +
                        '</div>' +
                        '<div>' +
                            '<button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); showUploadModal(' + product.product_id + ')">' +
                                '<i class="bi bi-upload"></i> 上传' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>'
            ).join('');

            document.getElementById('productList').innerHTML = listHtml || '<p class="text-muted text-center">暂无产品</p>';

            // 同时更新左侧树形结构
            const productsContainer = document.getElementById('products-' + companyId);
            if (productsContainer) {
                const treeHtml = products.map(product =>
                    '<div class="tree-node ms-3" onclick="selectProduct(' + product.product_id + ', \'' + product.product_name + '\')">' +
                        '<i class="bi bi-box-seam me-2"></i>' +
                        product.product_name +
                        '<span class="badge bg-info ms-2">' + (product.document_count || 0) + '</span>' +
                    '</div>'
                ).join('');
                productsContainer.innerHTML = treeHtml;
                productsContainer.classList.remove('d-none');
            }
        }

        // 选择产品
        async function selectProduct(productId, productName) {
            currentProductId = productId;
            currentCompanyId = null;

            // 更新活动状态
            updateActiveState('[onclick*="selectProduct(' + productId + ',"]');


            // 加载产品详情和文档列表
            try {
                const response = await axios.get('/api/knowledge_base/products/' + productId);
                if (response.data.success) {
                    renderProductDetail(response.data.data);
                }
            } catch (error) {
                console.error('加载产品详情失败:', error);
                showAlert('加载产品详情失败', 'danger');
            }
        }

        // 渲染产品详情
        function renderProductDetail(product) {
            let html =

                '<div class="card mb-3">' +
                    '<div class="card-header bg-success text-white">' +
                        '<h5 class="mb-0">' + product.product_name + '</h5>' +
                    '</div>' +
                    '<div class="card-body">' +
                        '<p><strong>产品代码：</strong>' + (product.product_code || '未设置') + '</p>' +
                        '<p><strong>产品类别：</strong>' + (product.product_category || '未分类') + '</p>' +
                        (product.description && '<p>' + product.description + '</p>' || '') +
                    '</div>' +
                '</div>';

            if (product.libraries) {
                html += product.libraries.map(library =>
                    '<div class="card mb-3">' +
                        '<div class="card-header">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<h6 class="mb-0">' + library.library_name + '</h6>' +
                                '<button class="btn btn-sm btn-primary" onclick="showUploadModal(' + product.product_id + ', ' + library.library_id + ')">' +
                                    '<i class="bi bi-upload"></i> 上传文档' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                        '<div class="card-body p-4" style="max-height: 600px; overflow-y: auto;">' +
                            '<div class="kb-document-grid">' +
                                (library.documents && library.documents.length > 0 &&
                                    library.documents.map(doc => renderDocument(doc)).join('') ||
                                    '<div class="col-12"><div class="text-center py-5"><i class="bi bi-folder text-muted fs-1"></i><p class="text-muted mt-3">暂无文档</p><button class="btn btn-primary" onclick="document.getElementById(\'fileInput\').click()"><i class="bi bi-plus me-2"></i>上传第一个文档</button></div></div>'
                                ) +
                            '</div>' +
                        '</div>' +
                    '</div>'
                ).join('');
            }

            document.getElementById('mainContent').innerHTML = html;
        }

        // 渲染文档项 - 使用 Bootstrap Card 组件
        function renderDocument(doc) {
            const privacyClasses = ['', 'privacy-1', 'privacy-2', 'privacy-3', 'privacy-4'];
            const privacyNames = ['', '公开', '内部', '机密', '绝密'];
            const categoryNames = {
                'tech': '技术',
                'impl': '实施',
                'service': '服务'
            };

            const privacyLevel = doc.privacy_classification || 1;
            const category = doc.document_category || 'tech';
            const fileSize = doc.file_size && (doc.file_size / (1024 * 1024)).toFixed(2) || '0';

            return `
                <div class="card shadow-sm border-0 kb-document-card h-100" onclick="viewDocumentDetail(' + doc.doc_id + ')">
                    <div class="card-header bg-light border-0 p-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary bg-opacity-10 rounded p-2 me-3">
                                <i class="bi bi-file-earmark-text text-primary fs-5"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0 text-truncate" title="' + doc.original_filename + '">' + (doc.original_filename.length > 20 ? doc.original_filename.substring(0, 20) + '...' : doc.original_filename) + '</h6>
                                <div class="d-flex align-items-center mt-1">
                                    <span class="badge ' + (privacyLevel === 1 ? 'bg-success' : privacyLevel === 2 ? 'bg-primary' : privacyLevel === 3 ? 'bg-warning' : 'bg-danger') + ' me-2 small">
                                        ' + privacyNames[privacyLevel] + '
                                    </span>
                                    <span class="badge bg-secondary small">
                                        ' + categoryNames[category] + '
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted small">
                                    <i class="bi bi-hdd me-1"></i>
                                    ' + fileSize + ' MB
                                </span>
                                <span class="text-muted small">
                                    <i class="bi bi-calendar me-1"></i>
                                    ' + (doc.upload_time && new Date(doc.upload_time).toLocaleDateString() || '未知') + '
                                </span>
                            </div>
                            ' + (doc.tags && '
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-tags me-1"></i>
                                    ' + JSON.parse(doc.tags).slice(0, 2).join(', ') + '
                                </small>
                            </div>' || '') + '
                        </div>

                        <!-- 状态指示器 -->
                        <div class="mb-3">
                            <div class="row g-2">
                                <div class="col-6">
                                    <div class="d-flex align-items-center justify-content-center p-2 rounded ' + (doc.parse_status === 'completed' && 'bg-success bg-opacity-10' || 'bg-warning bg-opacity-10') + '">
                                        <i class="bi ' + (doc.parse_status === 'completed' && 'bi-check-circle text-success' || 'bi-clock text-warning') + ' me-1"></i>
                                        <small class="' + (doc.parse_status === 'completed' && 'text-success' || 'text-warning') + '">
                                            ' + (doc.parse_status === 'completed' && '已解析' || '待处理') + '
                                        </small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="d-flex align-items-center justify-content-center p-2 rounded ' + (doc.vector_status === 'completed' && 'bg-info bg-opacity-10' || 'bg-secondary bg-opacity-10') + '">
                                        <i class="bi ' + (doc.vector_status === 'completed' && 'bi-database text-info' || 'bi-hourglass text-secondary') + ' me-1"></i>
                                        <small class="' + (doc.vector_status === 'completed' && 'text-info' || 'text-secondary') + '">
                                            ' + (doc.vector_status === 'completed' && '已索引' || '待索引') + '
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card-footer bg-white border-0 p-3">
                        <div class="d-grid">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); downloadDocument(' + doc.doc_id + ')" title="下载">
                                    <i class="bi bi-download"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); previewDocument(' + doc.doc_id + ')" title="预览">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteDocument(' + doc.doc_id + ')" title="删除">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // 显示添加公司模态框
        function showAddCompanyModal() {
            new bootstrap.Modal(document.getElementById('addCompanyModal')).show();
        }

        // 显示添加产品模态框
        function showAddProductModal(companyId) {
            currentCompanyId = companyId;
            new bootstrap.Modal(document.getElementById('addProductModal')).show();
        }

        // 显示上传文档模态框
        function showUploadModal(productId, libraryId) {
            currentProductId = productId;
            currentLibraryId = libraryId;
            selectedFiles = [];
            document.getElementById('fileList').innerHTML = '';
            new bootstrap.Modal(document.getElementById('uploadDocumentModal')).show();
        }

        // 添加公司
        async function addCompany() {
            const data = {
                company_name: document.getElementById('companyName').value,
                company_code: document.getElementById('companyCode').value,
                industry_type: document.getElementById('industryType').value,
                description: document.getElementById('companyDesc').value
            };

            try {
                const response = await axios.post('/api/companies', data);
                if (response.data.success) {
                    showAlert('企业添加成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addCompanyModal')).hide();
                    loadCompanies();
                    document.getElementById('addCompanyForm').reset();
                }
            } catch (error) {
                console.error('添加企业失败:', error);
                showAlert('添加企业失败：' + (error.response && error.response.data && error.response.data.error ? error.response.data.error : error.message), 'danger');
            }
        }

        // 添加产品
        async function addProduct() {
            const data = {
                product_name: document.getElementById('productName').value,
                product_code: document.getElementById('productCode').value,
                product_category: document.getElementById('productCategory').value,
                description: document.getElementById('productDesc').value
            };

            try {
                const response = await axios.post('/api/knowledge_base/companies/' + currentCompanyId + '/products', data);
                if (response.data.success) {
                    showAlert('产品添加成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    selectCompany(currentCompanyId, '');
                    document.getElementById('addProductForm').reset();
                }
            } catch (error) {
                console.error('添加产品失败:', error);
                showAlert('添加产品失败：' + (error.response && error.response.data && error.response.data.error ? error.response.data.error : error.message), 'danger');
            }
        }

        // 设置上传区域
        function setupUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            // 拖拽事件
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragover');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            // 文件选择事件
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // 处理选择的文件
        function handleFiles(files) {
            selectedFiles = Array.from(files);

            const listHtml = selectedFiles.map((file, index) =>
                '<div class="alert alert-info d-flex justify-content-between align-items-center">' +
                    '<span>' + file.name + ' (' + (file.size / 1024 / 1024).toFixed(2) + ' MB)</span>' +
                    '<button class="btn btn-sm btn-danger" onclick="removeFile(' + index + ')">' +
                        '<i class="bi bi-x"></i>' +
                    '</button>' +
                '</div>'
            ).join('');

            document.getElementById('fileList').innerHTML = listHtml;
        }

        // 移除文件
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            handleFiles(selectedFiles);
        }

        // 上传文档
        async function uploadDocuments() {
            if (!currentLibraryId || selectedFiles.length === 0) {
                showAlert('请选择要上传的文件', 'warning');
                return;
            }

            const privacyLevel = document.getElementById('privacyLevel').value;
            const documentCategory = document.getElementById('documentCategory').value;
            const tags = document.getElementById('documentTags').value.split(',').map(t => t.trim()).filter(t => t);

            // 显示上传进度
            const progressContainer = document.getElementById('uploadProgress');
            if (progressContainer) {
                progressContainer.classList.remove('d-none');
            }

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('privacy_classification', privacyLevel);
                formData.append('document_category', documentCategory);
                formData.append('tags', JSON.stringify(tags));

                try {
                    const response = await axios.post('/api/knowledge_base/libraries/' + currentLibraryId + '/documents', formData, {
                        headers: { 'Content-Type': 'multipart/form-data' },
                        onUploadProgress: (progressEvent) => {
                            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                            updateUploadProgress(i + 1, selectedFiles.length, percentCompleted, file.name);
                        }
                    });

                    if (response.data.success) {
                        successCount++;
                        showAlert('文档 ' + file.name + ' 上传成功', 'success');
                    }
                } catch (error) {
                    failCount++;
                    console.error('文档 ' + file.name + ' 上传失败:', error);
                    showAlert('文档 ' + file.name + ' 上传失败: ' + (error.response && error.response.data && error.response.data.error ? error.response.data.error : error.message), 'danger');
                }
            }

            // 显示最终结果
            if (successCount > 0) {
                showAlert('成功上传 ' + successCount + ' 个文档' + (failCount > 0 && '，失败 ' + failCount + ' 个' || ''), successCount === selectedFiles.length && 'success' || 'warning');
            }

            // 关闭模态框并刷新产品详情
            bootstrap.Modal.getInstance(document.getElementById('uploadDocumentModal')).hide();
            if (currentProductId) {
                selectProduct(currentProductId, '');
            }
        }

        // 更新上传进度
        function updateUploadProgress(current, total, percent, fileName) {
            const progressBar = document.querySelector('#uploadProgress .progress-bar');
            const progressText = document.querySelector('#uploadProgress .progress-text');

            if (progressBar && progressText) {
                const overallPercent = Math.round(((current - 1) * 100 + percent) / total);
                progressBar.style.width = overallPercent + '%';
                progressText.textContent = '正在上传 ' + fileName + ' (' + current + '/' + total + ') - ' + percent + '%';
            }
        }

        // 查看文档详情
        async function viewDocumentDetail(docId) {
            try {
                const response = await axios.get('/api/knowledge_base/documents/' + docId);
                if (response.data.success) {
                    const doc = response.data.data;
                    showDocumentDetailModal(doc);
                }
            } catch (error) {
                console.error('获取文档详情失败:', error);
                showAlert('获取文档详情失败', 'danger');
            }
        }

        // 显示文档详情模态框
        function showDocumentDetailModal(doc) {
            const privacyNames = ['', '🌐 公开', '🏢 内部', '🔒 机密', '🚫 绝密'];
            const categoryNames = {
                'tech': '🔧 技术文档',
                'impl': '📋 实施方案',
                'service': '🛠️ 服务文档'
            };

            const modalHtml = `
                <div class="modal fade" id="documentDetailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">文档详情</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <h6>' + doc.original_filename + '</h6>
                                        <p class="text-muted mb-3">' + (doc.description || '暂无描述') + '</p>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <span class="privacy-badge privacy-' + (doc.privacy_classification || 1) + '">
                                            ' + privacyNames[doc.privacy_classification || 1] + '
                                        </span>
                                        <br>
                                        <span class="doc-category-badge doc-category-' + (doc.document_category || 'tech') + ' mt-2">
                                            ' + categoryNames[doc.document_category || 'tech'] + '
                                        </span>
                                    </div>
                                </div>

                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <strong>文件大小：</strong>' + (doc.file_size && (doc.file_size / (1024 * 1024)).toFixed(2) || '0') + ' MB<br>
                                        <strong>文件类型：</strong>' + (doc.file_type || '未知') + '<br>
                                        <strong>上传时间：</strong>' + (doc.upload_time && new Date(doc.upload_time).toLocaleString() || '未知') + '
                                    </div>
                                    <div class="col-md-6">
                                        <strong>处理状态：</strong>
                                        <span class="badge bg-' + (doc.parse_status === 'completed' && 'success' || 'warning') + '">' + (doc.parse_status || 'pending') + '</span><br>
                                        <strong>向量状态：</strong>
                                        <span class="badge bg-' + (doc.vector_status === 'completed' && 'success' || 'warning') + '">' + (doc.vector_status || 'pending') + '</span>
                                    </div>
                                </div>

                                ' + (doc.tags && '
                                <div class="mt-3">
                                    <strong>标签：</strong>
                                    ' + JSON.parse(doc.tags).map(tag => '<span class="badge bg-light text-dark me-1">' + tag + '</span>').join('') + '
                                </div>
                                ' || '') + '
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                                <button type="button" class="btn btn-primary" onclick="downloadDocument(' + doc.doc_id + ')">下载文档</button>
                                <button type="button" class="btn btn-info" onclick="previewDocument(' + doc.doc_id + ')">预览文档</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除已存在的模态框
            const existingModal = document.getElementById('documentDetailModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 添加新模态框并显示
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById('documentDetailModal')).show();
        }

        // 下载文档
        function downloadDocument(docId) {
            window.open('/api/knowledge_base/documents/' + docId + '/download', '_blank');
        }

        // 预览文档
        async function previewDocument(docId) {
            try {
                const response = await axios.get('/api/knowledge_base/documents/' + docId + '/preview');
                if (response.data.success) {
                    showDocumentPreview(response.data.content);
                }
            } catch (error) {
                console.error('预览文档失败:', error);
                showAlert('预览文档失败', 'danger');
            }
        }

        // 显示文档预览
        function showDocumentPreview(content) {
            const previewHtml = `
                <div class="modal fade" id="documentPreviewModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">文档预览</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="document-preview" style="max-height: 500px; overflow-y: auto;">
                                    ' + content + '
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除已存在的预览模态框
            const existingModal = document.getElementById('documentPreviewModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 添加新预览模态框并显示
            document.body.insertAdjacentHTML('beforeend', previewHtml);
            new bootstrap.Modal(document.getElementById('documentPreviewModal')).show();
        }

        // 删除文档
        async function deleteDocument(docId) {
            if (!confirm('确定要删除这个文档吗？')) {
                return;
            }

            try {
                const response = await axios.delete('/api/knowledge_base/documents/' + docId);
                if (response.data.success) {
                    showAlert('文档删除成功', 'success');
                    // 刷新当前产品详情
                    if (currentProductId) {
                        selectProduct(currentProductId, '');
                    }
                }
            } catch (error) {
                console.error('删除文档失败:', error);
                showAlert('删除文档失败', 'danger');
            }
        }

        // 显示提示信息
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // 刷新知识库数据
        async function refreshKnowledgeBase() {
            try {
                const button = event.target;
                const originalHtml = button.innerHTML;
                button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>刷新中...';
                button.disabled = true;

                await loadCompanies();
                await loadStatistics();

                showAlert('数据刷新成功', 'success');

                setTimeout(() => {
                    button.innerHTML = originalHtml;
                    button.disabled = false;
                }, 1000);
            } catch (error) {
                console.error('刷新数据失败:', error);
                showAlert('刷新数据失败', 'danger');

                const button = event.target;
                button.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>刷新数据';
                button.disabled = false;
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCompanies();
            loadStatistics();
            handleUrlParameters();

            // 标签事件监听器已移除，现在在选择公司时统一加载所有文件状态

            // 自动选择智慧足迹公司（ID=8）以显示资质文件
            setTimeout(() => {
                selectCompanyProfile(8);
            }, 1000); // 等待公司列表加载完成
        });

        // 处理URL参数
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            const companyId = urlParams.get('company');

            if (action === 'company_management') {
                // 如果指定了公司ID，直接打开该公司的企业信息库
                if (companyId) {
                    setTimeout(() => {
                        selectCompanyProfile(companyId);
                    }, 1000);
                } else {
                    // 没有指定公司，展开第一个公司的企业信息库
                    setTimeout(() => {
                        const firstCompany = document.querySelector('[id^="toggle-"]');
                        if (firstCompany) {
                            const companyId = firstCompany.id.replace('toggle-', '');
                            toggleCompanyNode(companyId, '');
                            setTimeout(() => {
                                selectCompanyProfile(companyId);
                            }, 500);
                        }
                    }, 1000);
                }
            }
        }

        // 加载统计数据
        async function loadStatistics() {
            try {
                const response = await axios.get('/api/knowledge_base/statistics');
                if (response.data.success) {
                    const stats = response.data.data;
                    updateStatisticsDisplay(stats);
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 更新统计数据显示
        function updateStatisticsDisplay(stats) {
            document.getElementById('totalCompanies').textContent = stats.totalCompanies || 0;
            document.getElementById('totalProducts').textContent = stats.totalProducts || 0;
            document.getElementById('totalDocuments').textContent = stats.totalDocuments || 0;
            document.getElementById('confidentialDocs').textContent = stats.confidentialDocs || 0;
        }

        // 显示智能检索模态框
        function showSearchModal() {
            const searchHtml = `
                <div class="modal fade" id="searchModal" tabindex="-1">
                    <div class="modal-dialog modal-xl">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-brain me-2"></i>AI智能检索
                                    <small class="text-muted ms-2">支持语义搜索和关键词搜索</small>
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <!-- 搜索配置区域 -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-chat-square-text me-1"></i>搜索问题
                                        </label>
                                        <textarea class="form-control form-control-lg" id="searchQuery" rows="3"
                                                  placeholder="请输入您的问题，例如：5G核心网的主要技术架构是什么？"></textarea>
                                        <div class="form-text">
                                            <i class="bi bi-lightbulb me-1"></i>
                                            提示：使用语义搜索可以更好地理解自然语言问题
                                        </div>
                                    </div>
                                </div>

                                <!-- 搜索方式选择 -->
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">
                                            <i class="bi bi-gear me-1"></i>搜索方式
                                        </label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="searchMode" id="semanticSearch" value="semantic" checked>
                                            <label class="btn btn-outline-primary" for="semanticSearch">
                                                <i class="bi bi-brain me-1"></i>语义搜索
                                            </label>
                                            <input type="radio" class="btn-check" name="searchMode" id="keywordSearch" value="keyword">
                                            <label class="btn btn-outline-primary" for="keywordSearch">
                                                <i class="bi bi-search me-1"></i>关键词
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            <small id="searchModeHelp">语义搜索：理解语义和上下文</small>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">文档类型</label>
                                        <select class="form-control" id="searchCategory">
                                            <option value="">全部类型</option>
                                            <option value="tech">🔧 技术文档</option>
                                            <option value="impl">📋 实施方案</option>
                                            <option value="service">🛠️ 服务文档</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label fw-bold">隐私级别</label>
                                        <select class="form-control" id="searchPrivacy">
                                            <option value="">全部级别</option>
                                            <option value="1">🌐 公开文档</option>
                                            <option value="2">🏢 内部文档</option>
                                            <option value="3">🔒 机密文档</option>
                                            <option value="4">🚫 绝密文档</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- 高级搜索选项 -->
                                <div class="mb-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#advancedOptions">
                                            <i class="bi bi-sliders me-1"></i>高级选项
                                        </button>
                                    </div>
                                    <div class="collapse" id="advancedOptions">
                                        <div class="card card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label class="form-label">结果数量</label>
                                                    <select class="form-select" id="searchLimit">
                                                        <option value="5">5 个结果</option>
                                                        <option value="10" selected>10 个结果</option>
                                                        <option value="20">20 个结果</option>
                                                        <option value="50">50 个结果</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">相似度阈值</label>
                                                    <input type="range" class="form-range" id="similarityThreshold" min="0" max="1" step="0.1" value="0.3">
                                                    <div class="form-text">当前值: <span id="thresholdValue">0.3</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 搜索结果区域 -->
                                <div id="searchResults" class="mt-3"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i>关闭
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="clearSearchHistory()">
                                    <i class="bi bi-trash me-1"></i>清空历史
                                </button>
                                <button type="button" class="btn btn-primary" onclick="performSearch()">
                                    <i class="bi bi-search me-1"></i>开始搜索
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除已存在的搜索模态框
            const existingModal = document.getElementById('searchModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 添加新搜索模态框并显示
            document.body.insertAdjacentHTML('beforeend', searchHtml);

            // 初始化事件监听器
            initSearchModalEventListeners();

            new bootstrap.Modal(document.getElementById('searchModal')).show();
        }

        // 初始化搜索模态框事件监听器
        function initSearchModalEventListeners() {
            // 搜索方式切换提示文本
            const searchModeInputs = document.querySelectorAll('input[name="searchMode"]');
            const searchModeHelp = document.getElementById('searchModeHelp');

            searchModeInputs.forEach(input => {
                input.addEventListener('change', function() {
                    if (this.value === 'semantic') {
                        searchModeHelp.textContent = '语义搜索：理解语义和上下文';
                        document.getElementById('advancedOptions').style.display = 'block';
                    } else {
                        searchModeHelp.textContent = '关键词搜索：匹配精确关键词';
                        document.getElementById('advancedOptions').style.display = 'none';
                    }
                });
            });

            // 相似度阈值滑块
            const thresholdSlider = document.getElementById('similarityThreshold');
            const thresholdValue = document.getElementById('thresholdValue');

            if (thresholdSlider && thresholdValue) {
                thresholdSlider.addEventListener('input', function() {
                    thresholdValue.textContent = this.value;
                });
            }

            // 加载搜索历史
            loadSearchHistory();
        }

        // 加载搜索历史
        function loadSearchHistory() {
            try {
                const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                if (history.length > 0) {
                    const historyHtml = `
                        <div class="mb-3">
                            <h6 class="text-muted">
                                <i class="bi bi-clock-history me-1"></i>最近搜索
                            </h6>
                            <div class="d-flex flex-wrap gap-1">
' + history.slice(0, 5).map(query =>
                                    '<button class="btn btn-sm search-history-btn" onclick="fillSearchQuery(\'' + query + '\')">
                                        <i class="bi bi-clock-history me-1"></i>' + query + '
                                    </button>'
                                ).join('') + '
                            </div>
                        </div>
                    `;
                    document.getElementById('searchResults').innerHTML = historyHtml;
                }
            } catch (e) {
                console.warn('搜索历史加载失败:', e);
            }
        }

        // 填充搜索查询
        function fillSearchQuery(query) {
            document.getElementById('searchQuery').value = query;
        }

        // 清空搜索历史
        function clearSearchHistory() {
            localStorage.removeItem('searchHistory');
            document.getElementById('searchResults').innerHTML = '';
            showAlert('搜索历史已清空', 'success');
        }

        // 保存搜索历史
        function saveSearchHistory(query) {
            try {
                let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                history = history.filter(item => item !== query); // 去重
                history.unshift(query); // 添加到开头
                history = history.slice(0, 10); // 只保留最近10次
                localStorage.setItem('searchHistory', JSON.stringify(history));
            } catch (e) {
                console.warn('搜索历史保存失败:', e);
            }
        }

        // 执行智能搜索
        async function performSearch() {
            const query = document.getElementById('searchQuery').value.trim();
            const category = document.getElementById('searchCategory').value;
            const privacy = document.getElementById('searchPrivacy').value;
            const searchMode = document.querySelector('input[name="searchMode"]:checked').value;
            const limit = document.getElementById('searchLimit').value;
            const threshold = document.getElementById('similarityThreshold').value;

            if (!query) {
                showAlert('请输入搜索问题', 'warning');
                return;
            }

            // 保存搜索历史
            saveSearchHistory(query);

            const resultsContainer = document.getElementById('searchResults');

            // 显示加载状态
            const searchModeText = searchMode === 'semantic' && '语义搜索' || '关键词搜索';
            resultsContainer.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">搜索中...</span>
                    </div>
                    <div class="mt-3">
                        <h6 class="text-muted">正在进行' + searchModeText + '...</h6>
                        <p class="small text-muted mb-0">
                            <i class="bi bi-search me-1"></i>查询: "' + query.substring(0, 50) + (query.length > 50 ? '...' : '') + '""
                        </p>
                        <p class="small text-muted">
                            <i class="bi bi-gear me-1"></i>模式: ' + searchModeText + ' |
                            <i class="bi bi-funnel me-1"></i>结果数: ' + limit + '
                            ' + (searchMode === 'semantic' && ' | <i class="bi bi-speedometer2 me-1"></i>阈值: ' + threshold || '') + '
                        </p>
                    </div>
                </div>
            `;

            try {
                let response;
                let searchStartTime = Date.now();

                if (searchMode === 'semantic') {
                    // 使用语义搜索API
                    response = await axios.post('/api/vector_search/search', {
                        query: query,
                        top_k: parseInt(limit),
                        threshold: parseFloat(threshold),
                        filters: {
                            category: category || null,
                            privacy_level: privacy || null
                        }
                    });
                } else {
                    // 使用传统关键词搜索API
                    response = await axios.post('/api/knowledge_base/search', {
                        query: query,
                        category: category,
                        privacy_level: privacy,
                        limit: parseInt(limit)
                    });
                }

                const searchTime = (Date.now() - searchStartTime) / 1000;

                if (response.data.success) {
                    displaySearchResults(response.data.data, searchMode, searchTime);
                } else {
                    resultsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            搜索失败: ' + (response.data.error || '未知错误') + '
                        </div>
                    `;
                }
            } catch (error) {
                console.error('搜索失败:', error);
                const errorMessage = (error.response && error.response.data && error.response.data.error) ? error.response.data.error : (error.message || '网络连接错误');
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        搜索失败: ' + errorMessage + '
                        <div class="mt-2 small">
                            <button class="btn btn-outline-danger btn-sm" onclick="performSearch()">
                                <i class="bi bi-arrow-clockwise me-1"></i>重试
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // 显示搜索结果
        function displaySearchResults(results, searchMode = 'keyword', searchTime = 0) {
            const resultsContainer = document.getElementById('searchResults');

            if (!results || results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>未找到相关文档</strong>
                        <div class="mt-2 small">
                            <p class="mb-1">建议尝试：</p>
                            <ul class="mb-0">
                                <li>使用不同的关键词</li>
                                <li>尝试语义搜索模式</li>
                                <li>调低相似度阈值</li>
                                <li>选择不同的文档类型或隐私级别</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }

            // 根据搜索模式显示不同的结果
            const resultsHtml = results.map((result, index) => {
                // 语义搜索和关键词搜索的结果格式可能不同
                const isSemanticResult = searchMode === 'semantic';
                const similarity_score = isSemanticResult &&
                    (result.similarity_score || result.relevance_score) ||
                    (result.relevance_score || 0);

                const title = result.title || result.filename || result.original_filename || ('文档 ' + result.doc_id);
                const summary = result.summary || result.content_snippet || result.content || '暂无摘要';
                const privacy_level = result.privacy_classification || result.privacy_level || 1;
                const category = result.category || result.document_category || 'unknown';

                // 根据相似度设置颜色
                let scoreColor = 'secondary';
                if (similarity_score > 0.8) scoreColor = 'success';
                else if (similarity_score > 0.6) scoreColor = 'primary';
                else if (similarity_score > 0.4) scoreColor = 'warning';

                return `
                    <div class="card mb-3 shadow-sm search-result-card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1">
                                        <span class="badge bg-light text-dark me-2">#' + (index + 1) + '</span>
                                        <i class="bi bi-file-earmark-text me-1"></i>
                                        ' + title + '
                                    </h6>
                                    <div class="small text-muted">
                                        ' + (isSemanticResult &&
                                            '<i class="bi bi-cpu me-1"></i>语义匹配' ||
                                            '<i class="bi bi-search me-1"></i>关键词匹配') + '
                                        <span class="mx-1">•</span>
                                        文档ID: ' + result.doc_id + '
                                        ' + (result.chunk_id && '<span class="mx-1">•</span>片段ID: ' + result.chunk_id || '') + '
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="privacy-badge privacy-' + privacy_level + '">
                                        ' + ['', '🌐 公开', '🏢 内部', '🔒 机密', '🚫 绝密'][privacy_level] + '
                                    </span>
                                </div>
                            </div>

                            <p class="card-text small mb-2" style="line-height: 1.4;">
                                ' + (summary.length > 200 ? summary.substring(0, 200) + '...' : summary) + '
                            </p>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-' + scoreColor + ' me-2">
                                        ' + (isSemanticResult && '相似度' || '相关度') + ': ' + (similarity_score * 100).toFixed(1) + '%
                                    </span>
                                    ' + (category && category !== 'unknown' && '
                                        <span class="badge bg-secondary me-2">
                                            ' + ({'tech': '🔧 技术', 'impl': '📋 实施', 'service': '🛠️ 服务'}[category] || category) + '
                                        </span>
                                    ' || ''}
                                    ' + (result.file_type && '
                                        <span class="badge bg-info me-2">' + result.file_type.toUpperCase() + '</span>
                                    ' || '') + '
                                </div>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewDocumentDetail(' + result.doc_id + ')" title="查看详情">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="downloadDocument(' + result.doc_id + ')" title="下载文档">
                                        <i class="bi bi-download"></i>
                                    </button>
                                    ' + (isSemanticResult && result.chunk_id && '
                                        <button class="btn btn-outline-info" onclick="viewChunkDetail(' + result.chunk_id + ')" title="查看片段">
                                            <i class="bi bi-zoom-in"></i>
                                        </button>
                                    ' || '')
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // 搜索结果统计
            const avgScore = results.reduce((sum, r) => sum + (r.similarity_score || r.relevance_score || 0), 0) / results.length;
            const modeText = searchMode === 'semantic' && '语义搜索' || '关键词搜索';

            resultsContainer.innerHTML = `
                <div class="alert search-stats d-flex justify-content-between align-items-center border-0 shadow-sm">
                    <div>
                        <i class="bi bi-check-circle me-2 fs-5"></i>
                        找到 <strong>' + results.length + '</strong> 个相关文档
                        <div class="mt-1 small opacity-90">
                            <i class="bi bi-gear me-1"></i>搜索模式: ' + modeText + '
                            <span class="mx-2">•</span>
                            <i class="bi bi-stopwatch me-1"></i>耗时: ' + searchTime.toFixed(2) + 's'
                            <span class="mx-2">•</span>
                            <i class="bi bi-speedometer2 me-1"></i>平均' + (searchMode === 'semantic' && '相似度' || '相关度') + ': ' + (avgScore * 100).toFixed(1) + '%'
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-light" onclick="exportSearchResults()" title="导出结果">
                            <i class="bi bi-download me-1"></i>导出
                        </button>
                    </div>
                </div>
                ' + resultsHtml + '
            `;
        }

        // 查看片段详情
        function viewChunkDetail(chunkId) {
            // 这里可以实现查看具体文档片段的功能
            showAlert('片段查看功能开发中...', 'info');
        }

        // 导出搜索结果
        function exportSearchResults() {
            // 这里可以实现搜索结果导出功能
            showAlert('搜索结果导出功能开发中...', 'info');
        }

        // 资质文件上传功能
        async function uploadQualificationFile(qualKey, inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const companyId = currentCompanyId;
            if (!companyId) {
                showAlert('请先选择企业', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append(`qualifications[${qualKey}]`, file);

            try {
                showAlert('正在上传资质文件...', 'info');

                const response = await axios.post(`/api/companies/${companyId}/qualifications/upload`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                if (response.data.success) {
                    showAlert(`资质文件 "${file.name}" 上传成功`, 'success');
                    // 刷新资质文件显示
                    console.log('上传成功后调用refreshQualificationDisplay，qualKey:', qualKey);
                    console.log('API返回的uploaded_files:', response.data.uploaded_files);
                    console.log('当前qualKey对应的文件信息:', response.data.uploaded_files[qualKey]);
                    refreshQualificationDisplay(qualKey, response.data.uploaded_files[qualKey]);
                } else {
                    showAlert('资质文件上传失败: ' + response.data.error, 'danger');
                }
            } catch (error) {
                console.error('资质文件上传失败:', error);
                showAlert('资质文件上传失败', 'danger');
            }
        }

        // 财务文件上传功能
        async function uploadFinancialFile(finKey, inputElement) {
            const file = inputElement.files[0];
            if (!file) return;

            const companyId = currentCompanyId;
            if (!companyId) {
                showAlert('请先选择企业', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append(`qualifications[${finKey}]`, file);

            try {
                showAlert('正在上传财务文件...', 'info');

                const response = await axios.post(`/api/companies/${companyId}/qualifications/upload`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                if (response.data.success) {
                    showAlert(`财务文件 "${file.name}" 上传成功`, 'success');
                    // 刷新财务文件显示
                    console.log('上传成功后调用refreshFinancialDisplay，finKey:', finKey);
                    console.log('API返回的uploaded_files:', response.data.uploaded_files);
                    console.log('当前finKey对应的文件信息:', response.data.uploaded_files[finKey]);
                    refreshFinancialDisplay(finKey, response.data.uploaded_files[finKey]);
                } else {
                    showAlert('财务文件上传失败: ' + response.data.error, 'danger');
                }
            } catch (error) {
                console.error('财务文件上传失败:', error);
                showAlert('财务文件上传失败', 'danger');
            }
        }

        // 刷新财务文件显示
        function refreshFinancialDisplay(finKey, fileInfo) {
            console.log('refreshFinancialDisplay 被调用:', finKey, fileInfo);
            const statusElement = document.getElementById(`fin-status-${finKey}`);
            console.log('找到DOM元素:', statusElement ? 'YES' : 'NO', `fin-status-${finKey}`);

            if (statusElement && fileInfo) {
                statusElement.classList.remove('d-none');
                const formattedTime = formatDateTime(fileInfo.upload_time);
                const formattedSize = formatFileSize(fileInfo.file_size);

                statusElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-success">✓ ${fileInfo.original_filename}</small>
                            <br><small class="text-muted">${formattedSize} | ${formattedTime}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-danger btn-sm" onclick="downloadFinancialFile('${currentCompanyId}', '${finKey}')" title="下载">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteFinancialFile('${finKey}')" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                console.log('财务文件显示已更新:', finKey);
            } else {
                console.error('无法更新财务文件显示 - statusElement:', statusElement, 'fileInfo:', fileInfo);
            }
        }

        // 下载财务文件
        async function downloadFinancialFile(companyId, finKey) {
            try {
                window.open(`/api/companies/${companyId}/qualifications/${finKey}/download`);
            } catch (error) {
                console.error('下载财务文件失败:', error);
                showAlert('下载财务文件失败', 'danger');
            }
        }

        // 删除财务文件
        async function deleteFinancialFile(finKey) {
            if (!confirm('确定要删除这个财务文件吗？')) return;

            const companyId = currentCompanyId;
            try {
                const response = await axios.delete(`/api/companies/${companyId}/qualifications/${finKey}`);

                if (response.data.success) {
                    showAlert('财务文件删除成功', 'success');
                    // 隐藏状态显示
                    const statusElement = document.getElementById(`fin-status-${finKey}`);
                    if (statusElement) {
                        statusElement.classList.add('d-none');
                    }
                } else {
                    showAlert('财务文件删除失败: ' + response.data.error, 'danger');
                }
            } catch (error) {
                console.error('删除财务文件失败:', error);
                showAlert('删除财务文件失败', 'danger');
            }
        }

        // 刷新资质文件显示
        function refreshQualificationDisplay(qualKey, fileInfo) {
            console.log('refreshQualificationDisplay 被调用:', qualKey, fileInfo);
            const statusElement = document.getElementById(`profile-status-${qualKey}`);
            console.log('找到DOM元素:', statusElement ? 'YES' : 'NO', `profile-status-${qualKey}`);

            if (statusElement && fileInfo) {
                statusElement.classList.remove('d-none');
                const formattedTime = formatDateTime(fileInfo.upload_time);
                const formattedSize = formatFileSize(fileInfo.file_size);

                statusElement.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-success">✓ ${fileInfo.original_filename}</small>
                            <br><small class="text-muted">${formattedSize} | ${formattedTime}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="downloadQualificationFile('${currentCompanyId}', '${qualKey}')" title="下载">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteQualificationFile('${qualKey}')" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                console.log('资质文件显示已更新:', qualKey);
            } else {
                console.error('无法更新资质文件显示 - statusElement:', statusElement, 'fileInfo:', fileInfo);
            }
        }

        // 下载资质文件
        async function downloadQualificationFile(companyId, qualKey) {
            try {
                window.open(`/api/companies/${companyId}/qualifications/${qualKey}/download`);
            } catch (error) {
                console.error('下载资质文件失败:', error);
                showAlert('下载资质文件失败', 'danger');
            }
        }

        // 删除资质文件
        async function deleteQualificationFile(qualKey) {
            if (!confirm('确定要删除这个资质文件吗？')) return;

            const companyId = currentCompanyId;
            try {
                const response = await axios.delete(`/api/companies/${companyId}/qualifications/${qualKey}`);

                if (response.data.success) {
                    showAlert('资质文件删除成功', 'success');
                    // 清空显示
                    const statusElement = document.getElementById(`profile-status-${qualKey}`);
                    if (statusElement) {
                        statusElement.classList.add('d-none');
                        statusElement.innerHTML = '<small class="text-muted">未上传文件</small>';
                    }
                } else {
                    showAlert('删除失败: ' + response.data.error, 'danger');
                }
            } catch (error) {
                console.error('删除资质文件失败:', error);
                showAlert('删除资质文件失败', 'danger');
            }
        }

        // 获取当前选择的企业ID

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 格式化时间
        function formatDateTime(timestamp) {
            try {
                // 如果是字符串格式的时间戳（如"2025-09-26 13:24:24"）
                if (typeof timestamp === 'string') {
                    return new Date(timestamp).toLocaleString('zh-CN');
                }
                // 如果是Unix时间戳数字
                else if (typeof timestamp === 'number') {
                    return new Date(timestamp * 1000).toLocaleString('zh-CN');
                }
                // 其他情况直接转换
                return new Date(timestamp).toLocaleString('zh-CN');
            } catch (error) {
                console.error('时间格式化错误:', error, '原始时间戳:', timestamp);
                return timestamp || '未知时间';
            }
        }

        // 加载现有资质文件信息
        async function loadExistingQualifications(companyId) {
            try {
                console.log('正在加载公司', companyId, '的资质文件信息...');
                const response = await axios.get(`/api/companies/${companyId}/qualifications`);
                console.log('API响应:', response.data);

                if (response.data.success) {
                    const qualifications = response.data.qualifications;
                    console.log('找到资质文件数量:', Object.keys(qualifications).length);
                    console.log('API返回的所有qualification keys:', Object.keys(qualifications));

                    // 先检查所有DOM元素的存在性
                    Object.keys(qualifications).forEach(key => {
                        console.log(`检查key: ${key}, 对应DOM ID: profile-status-${key}`);
                        const element = document.getElementById(`profile-status-${key}`);
                        console.log(`DOM元素存在: ${element ? 'YES' : 'NO'}`);
                        if (!element) {
                            console.warn(`警告: 找不到DOM元素 profile-status-${key}`);
                        }
                    });

                    // 更新每个资质文件的显示状态
                    Object.keys(qualifications).forEach(qualKey => {
                        const fileInfo = qualifications[qualKey];
                        console.log('处理资质文件:', qualKey, fileInfo);
                        refreshQualificationDisplay(qualKey, fileInfo);
                    });
                } else {
                    console.error('API返回失败:', response.data);
                }
            } catch (error) {
                console.error('加载资质文件信息失败:', error);
            }
        }

        // 处理资质信息标签显示，带有延迟重试机制
        async function handleQualificationTabDisplay() {
            console.log('handleQualificationTabDisplay 被调用，currentCompanyId:', currentCompanyId);

            if (!currentCompanyId) {
                console.log('currentCompanyId 未设置，无法加载资质文件');
                return;
            }

            // 检查资质DOM元素是否存在，如果不存在则延迟重试
            const checkAndLoad = async (retries = 3) => {
                const testElement = document.getElementById('profile-status-business_license');
                if (testElement) {
                    console.log('资质DOM元素已就绪，开始加载资质文件...');
                    await loadExistingQualifications(currentCompanyId);
                } else if (retries > 0) {
                    console.log('资质DOM元素尚未就绪，', retries, '次重试后再次尝试...');
                    setTimeout(() => checkAndLoad(retries - 1), 200);
                } else {
                    console.error('资质DOM元素加载超时，无法显示资质文件');
                }
            };

            await checkAndLoad();
        }

        // 人员档案上传功能（之前缺失的函数）
        async function uploadPersonnelDocs() {
            const companyId = currentCompanyId;
            if (!companyId) {
                showAlert('请先选择企业', 'warning');
                return;
            }

            // 收集所有人员相关的文件输入
            const personnelInputs = [
                'pers-legal_id',
                'pers-auth_id',
                'pers-social_security',
                'pers-team_resume'
            ];

            const formData = new FormData();
            let hasFiles = false;

            personnelInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input && input.files[0]) {
                    const qualKey = inputId.replace('pers-', '');
                    formData.append(`qualifications[${qualKey}]`, input.files[0]);
                    hasFiles = true;
                }
            });

            if (!hasFiles) {
                showAlert('请选择要上传的人员档案文件', 'warning');
                return;
            }

            try {
                showAlert('正在上传人员档案...', 'info');

                const response = await axios.post(`/api/companies/${companyId}/qualifications/upload`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                if (response.data.success) {
                    showAlert(`成功上传 ${Object.keys(response.data.uploaded_files).length} 个人员档案文件`, 'success');
                    // 刷新页面或更新显示
                    location.reload();
                } else {
                    showAlert('人员档案上传失败: ' + response.data.error, 'danger');
                }
            } catch (error) {
                console.error('人员档案上传失败:', error);
                showAlert('人员档案上传失败', 'danger');
            }
        }
    </script>


</body>
</html>