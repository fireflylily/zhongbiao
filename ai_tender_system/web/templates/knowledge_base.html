<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企业知识库管理 - AI标书系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/litera/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- 新的组件化CSS架构 -->
    <link href="/static/css/main.css" rel="stylesheet">
    <link href="/static/css/components/buttons.css" rel="stylesheet">
    <link href="/static/css/components/cards.css" rel="stylesheet">
    <link href="/static/css/components/modals.css" rel="stylesheet">
    <link href="/static/css/components/navigation.css" rel="stylesheet">
    <link href="/static/css/components/privacy-badges.css" rel="stylesheet">
    <link href="/static/css/components/universal-uploader.css" rel="stylesheet">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top">
        <div class="container-fluid">
            <div class="navbar-brand d-flex align-items-center">
                <!-- 中国联通官方Logo -->
                <div class="unicom-logo me-3">
                    <svg width="120" height="40" viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="unicomKnotGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#4a89dc;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#3d6cb9;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2c5282;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <!-- 中国联通结绳标志 -->
                        <g transform="translate(5, 5)">
                            <path d="M25 5 C35 5, 45 15, 45 25 C45 35, 35 45, 25 45 C15 45, 5 35, 5 25"
                                  fill="none" stroke="url(#unicomKnotGradient)" stroke-width="3"/>
                            <path d="M25 15 C30 15, 35 20, 35 25 C35 30, 30 35, 25 35"
                                  fill="none" stroke="url(#unicomKnotGradient)" stroke-width="2"/>
                            <circle cx="20" cy="25" r="3" fill="url(#unicomKnotGradient)"/>
                            <circle cx="30" cy="25" r="3" fill="url(#unicomKnotGradient)"/>
                        </g>
                        <!-- 中国联通文字 -->
                        <g transform="translate(65, 20)">
                            <text x="0" y="0" font-family="'Microsoft YaHei', sans-serif" font-size="16" font-weight="bold" fill="#4a89dc">中国联通</text>
                            <text x="0" y="18" font-family="'Microsoft YaHei', sans-serif" font-size="10" fill="#666">CHINA UNICOM</text>
                        </g>
                    </svg>
                </div>
                <div class="brand-text ms-2">
                    <h6 class="brand-title mb-0">元景AI智能标书生成平台 - 知识库</h6>
                    <small class="brand-subtitle text-muted">企业信息与文档管理</small>
                </div>
            </div>

            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-grid-3x3-gap me-2"></i>应用菜单
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/"><i class="bi bi-house me-2"></i>标书生成</a></li>
                        <li><a class="dropdown-item active" href="/knowledge_base"><i class="bi bi-collection me-2"></i>知识库管理</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>系统设置</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <div class="container-fluid" style="margin-top: 70px; min-height: calc(100vh - 70px);">
        <div class="row g-0">
            <!-- 左侧分类树 -->
            <div class="col-md-3 p-0">
                <div class="card shadow-sm border-0 h-100" style="border-radius: 0;">
                    <div class="card-body p-0" style="max-height: calc(100vh - 70px); overflow-y: auto;">
                        <div class="p-3">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-primary">
                                    <i class="bi bi-collection me-2"></i>企业知识库
                                </h6>
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary btn-sm" onclick="window.categoryManager.showAddCompanyModal()" title="添加企业">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                    <button class="btn btn-outline-success btn-sm" onclick="window.searchManager.showSearchModal()" title="搜索文档">
                                        <i class="bi bi-search"></i>
                                    </button>
                                </div>
                            </div>

                            <div id="companyTree">
                                <!-- 企业树形结构会在这里动态渲染 -->
                                <div class="text-center py-5">
                                    <div class="mb-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </div>
                                    <p class="text-muted small mb-0">正在加载企业数据...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧主内容 -->
            <div class="col-md-9 p-0">
                <div class="card shadow-sm border-0 h-100" style="border-radius: 0;">
                    <div class="card-body p-4" style="max-height: calc(100vh - 70px); overflow-y: auto;">
                        <div id="mainContent">
                            <!-- 欢迎页面 -->
                            <div class="welcome-content text-center py-5">
                                <div class="mb-4">
                                    <div class="bg-primary bg-opacity-10 rounded-circle mx-auto d-flex align-items-center justify-content-center" style="width: 120px; height: 120px;">
                                        <i class="bi bi-collection text-primary" style="font-size: 3rem;"></i>
                                    </div>
                                </div>

                                <h3 class="text-primary mb-3">企业知识库管理</h3>
                                <p class="text-muted mb-4 lead">
                                    管理企业信息、产品文档和资质文件，构建智能化的企业知识体系
                                </p>

                                <div class="row g-4 mt-4">
                                    <div class="col-md-4">
                                        <div class="feature-card h-100">
                                            <div class="card border-0 shadow-sm h-100">
                                                <div class="card-body text-center p-4">
                                                    <div class="mb-3">
                                                        <div class="bg-success bg-opacity-10 rounded-3 p-3">
                                                            <i class="bi bi-building text-success fs-2"></i>
                                                        </div>
                                                    </div>
                                                    <h5 class="card-title text-success">企业信息</h5>
                                                    <p class="card-text text-muted small">
                                                        管理企业基本信息、资质证书和财务文档
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="feature-card h-100">
                                            <div class="card border-0 shadow-sm h-100">
                                                <div class="card-body text-center p-4">
                                                    <div class="mb-3">
                                                        <div class="bg-primary bg-opacity-10 rounded-3 p-3">
                                                            <i class="bi bi-box text-primary fs-2"></i>
                                                        </div>
                                                    </div>
                                                    <h5 class="card-title text-primary">产品文档</h5>
                                                    <p class="card-text text-muted small">
                                                        上传和管理产品技术文档、使用手册等
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="feature-card h-100">
                                            <div class="card border-0 shadow-sm h-100">
                                                <div class="card-body text-center p-4">
                                                    <div class="mb-3">
                                                        <div class="bg-info bg-opacity-10 rounded-3 p-3">
                                                            <i class="bi bi-file-earmark-text text-info fs-2"></i>
                                                        </div>
                                                    </div>
                                                    <h5 class="card-title text-info">智能搜索</h5>
                                                    <p class="card-text text-muted small">
                                                        基于AI的语义搜索，快速找到相关文档
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-5">
                                    <div class="alert alert-info border-0">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-lightbulb text-info fs-4 me-3"></i>
                                            <div class="text-start">
                                                <h6 class="alert-heading mb-1">使用提示</h6>
                                                <small class="mb-0">
                                                    从左侧企业列表开始，选择企业后可以管理企业信息或产品文档。
                                                    使用搜索功能可以快速定位特定文档。
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 文档上传模态框 -->
    <div class="modal fade" id="uploadDocumentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-cloud-upload me-2"></i>上传文档
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="kb-upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <i class="bi bi-cloud-upload fs-1 text-primary"></i>
                        <h5 class="mt-3">点击或拖拽文件到这里上传</h5>
                        <p class="text-muted">支持 PDF、Word 文档</p>
                        <input type="file" id="fileInput" class="d-none" accept=".pdf,.doc,.docx" multiple>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">文档分类</label>
                            <select class="form-select" id="documentCategory">
                                <option value="tech">技术文档</option>
                                <option value="product">产品文档</option>
                                <option value="manual">使用手册</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">隐私级别</label>
                            <select class="form-select" id="privacyLevel">
                                <option value="1">公开</option>
                                <option value="2">内部</option>
                                <option value="3">机密</option>
                                <option value="4">绝密</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-3">
                        <label class="form-label">标签 <small class="text-muted">(可选，用逗号分隔)</small></label>
                        <input type="text" class="form-control" id="documentTags"
                               placeholder="例如：技术规格, 用户指南, 安装说明">
                    </div>

                    <div id="fileList" class="mt-3"></div>

                    <!-- 上传进度显示 -->
                    <div id="uploadProgress" class="mt-3 d-none">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="progress-text">准备上传...</span>
                            <span class="progress-percent">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="window.documentManager.uploadDocuments()">开始上传</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加企业模态框 -->
    <div class="modal fade" id="addCompanyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-building-add me-2"></i>添加企业
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addCompanyForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">企业名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">企业代码</label>
                            <input type="text" class="form-control" id="companyCode"
                                   placeholder="企业统一社会信用代码">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">行业类型</label>
                            <select class="form-select" id="industryType">
                                <option value="">请选择行业类型</option>
                                <option value="technology">科技</option>
                                <option value="manufacturing">制造业</option>
                                <option value="finance">金融</option>
                                <option value="education">教育</option>
                                <option value="healthcare">医疗</option>
                                <option value="retail">零售</option>
                                <option value="construction">建筑</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">企业描述</label>
                            <textarea class="form-control" id="companyDesc" rows="3"
                                      placeholder="简要描述企业业务范围和特点"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="window.categoryManager.addCompany()">添加企业</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 添加产品模态框 -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-box-seam me-2"></i>添加产品
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addProductForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">产品名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">产品代码</label>
                            <input type="text" class="form-control" id="productCode"
                                   placeholder="产品型号或编码">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">产品分类</label>
                            <select class="form-select" id="productCategory">
                                <option value="">请选择产品分类</option>
                                <option value="software">软件产品</option>
                                <option value="hardware">硬件产品</option>
                                <option value="service">服务产品</option>
                                <option value="solution">解决方案</option>
                                <option value="other">其他</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">产品描述</label>
                            <textarea class="form-control" id="productDesc" rows="3"
                                      placeholder="描述产品功能、特点和应用场景"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="button" class="btn btn-primary" onclick="window.categoryManager.addProduct()">添加产品</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 通知容器 -->
    <div id="alertContainer" style="position: fixed; top: 80px; right: 20px; z-index: 1050; width: 350px;"></div>

    <!-- JavaScript 库 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.24.0/dist/axios.min.js"></script>

    <!-- 核心JS模块 -->
    <script src="/static/js/core/api-client.js"></script>
    <script src="/static/js/core/notification.js"></script>
    <script src="/static/js/core/validation.js"></script>

    <!-- 知识库页面特定模块 -->
    <script src="/static/js/pages/knowledge-base/category-manager.js"></script>
    <script src="/static/js/pages/knowledge-base/document-manager.js"></script>
    <script src="/static/js/pages/knowledge-base/search-manager.js"></script>
    <script src="/static/js/pages/knowledge-base/company-profile-manager.js"></script>

    <!-- 页面初始化脚本 -->
    <script>
        // 全局变量
        let currentCompanyId = null;
        let currentProductId = null;

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('知识库页面初始化开始...');

            // 初始化各个管理器
            if (window.categoryManager) {
                window.categoryManager.onCompanySelected = function(companyData) {
                    currentCompanyId = companyData.company_id;
                    if (window.documentManager) {
                        window.documentManager.setCurrentCompanyId(currentCompanyId);
                    }
                    // 渲染企业信息库
                    renderCompanyProfiles(companyData);
                };

                window.categoryManager.onProductSelected = function(productId, productName) {
                    currentProductId = productId;
                    // 加载产品详情
                    loadProductDetail(productId);
                };

                window.categoryManager.onCompanyProfileSelected = async function(companyId) {
                    currentCompanyId = companyId;
                    // 简化处理：只加载企业基本信息并显示简单界面
                    try {
                        const response = await axios.get('/api/companies/' + companyId);
                        if (response.data.success && response.data.data) {
                            renderCompanyProfiles(response.data.data);
                        }
                    } catch (error) {
                        console.error('加载企业详情失败:', error);
                        showAlert('加载企业详情失败：' + error.message, 'danger');
                    }
                };
            }

            if (window.documentManager) {
                window.documentManager.init();
            }

            if (window.searchManager) {
                window.searchManager.init();
            }

            if (window.companyProfileManager) {
                window.companyProfileManager.init();
            }

            // 加载企业列表
            loadCompanies();

            // 处理URL参数
            handleUrlParameters();

            console.log('知识库页面初始化完成');
        });

        // 加载企业列表
        async function loadCompanies() {
            try {
                const response = await axios.get('/api/companies');
                if (response.data.success && window.categoryManager) {
                    window.categoryManager.renderCompanyTree(response.data.data);
                }
            } catch (error) {
                console.error('加载企业列表失败:', error);
                showAlert('加载企业列表失败：' + error.message, 'danger');
            }
        }

        // 加载产品详情
        async function loadProductDetail(productId) {
            try {
                const response = await axios.get('/api/knowledge_base/products/' + productId + '/documents');
                if (response.data.success && window.documentManager) {
                    window.documentManager.renderProductDetail(response.data.data);
                }
            } catch (error) {
                console.error('加载产品详情失败:', error);
                showAlert('加载产品详情失败：' + error.message, 'danger');
            }
        }

        // 渲染企业信息库
        async function renderCompanyProfiles(companyData) {
            try {
                // 跳转到知识库页面并传递企业ID参数
                if (companyData && companyData.company_id) {
                    window.location.href = `/knowledge_base?company_id=${companyData.company_id}`;
                }
            } catch (error) {
                console.error('跳转企业信息库失败:', error);
                showAlert('跳转企业信息库失败：' + error.message, 'danger');
            }
        }




        // 处理URL参数
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const companyId = urlParams.get('company_id');

            if (companyId) {
                setTimeout(() => {
                    if (window.categoryManager) {
                        window.categoryManager.selectCompanyProfile(parseInt(companyId));
                    }
                }, 1000);
            }
        }

        // 显示通知函数
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert_' + Date.now();

            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            alertContainer.insertAdjacentHTML('beforeend', alertHtml);

            // 自动关闭
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    const bsAlert = new bootstrap.Alert(alertElement);
                    bsAlert.close();
                }
            }, 5000);
        }

        // 暴露到全局作用域供模块使用
        window.showAlert = showAlert;
        window.loadCompanies = loadCompanies;
    </script>
</body>
</html>