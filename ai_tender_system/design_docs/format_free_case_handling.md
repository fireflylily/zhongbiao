# "格式自拟"业绩案例自动处理方案

## 概述

本方案旨在解决招标文件中"格式自拟"的业绩案例要求处理问题。当招标文件要求提供业绩案例但未提供具体表格格式时，系统将自动生成标准案例表格，并复用现有的数据填充逻辑。

---

## 问题背景

### 当前系统处理流程

招标文件中的业绩案例要求通常有两种形式：

**形式1：提供了表格（当前系统可处理）**
```
八、资格案例（加盖公章）
请按照以下格式填写：

┌────┬──────────┬──────┬──────┬──────┐
│序号│项目名称  │客户名│金额  │时间  │
├────┼──────────┼──────┼──────┼──────┤
│    │          │      │      │      │
└────┴──────────┴──────┴──────┴──────┘
```
✅ 处理方式：`CaseTableFiller` 识别表格 → 填充数据 → 插入附件图片

**形式2：格式自拟（当前系统无法处理）**
```
八、资格案例（加盖公章）
格式自拟。
```
❌ 问题：没有表格，`CaseTableFiller` 无法识别，导致该要求被忽略

---

## 解决方案

### 核心思路

**在案例表格填充步骤之前，自动生成标准案例表格**

这样可以：
1. 复用现有的 `CaseTableFiller` 逻辑（无需修改）
2. 自动填充数据和插入附件图片
3. 保持系统一致性

---

## 系统集成设计

### 现有商务应答处理流程

```
BusinessResponseProcessor.process_business_response()
│
├─ 第1步：智能信息填写 (SmartDocumentFiller)
│   └─ 填充 {{公司名称}}、{{法人}} 等文字占位符
│
├─ 第2步：表格处理 (TableProcessor)
│   └─ 填充特定的表格单元格
│
├─ 第3步：图片插入 (ImageHandler)
│   └─ 插入营业执照、资质证书等图片
│
├─ 第4步：案例表格填充 (CaseTableFiller)
│   ├─ _is_case_table() - 识别已存在的案例表格
│   ├─ _query_cases() - 从案例库查询数据
│   └─ _fill_table() - 填充表格并插入附件图片
│
└─ 第5步：简历表格填充 (ResumeTableFiller)
```

### 新增处理流程（第3.5步）

```
BusinessResponseProcessor.process_business_response()
│
├─ 第1步：智能信息填写
├─ 第2步：表格处理
├─ 第3步：图片插入（资质证书）
│
├─ 🆕 第3.5步：处理格式自拟的案例要求 ⭐ 新增
│   │
│   ├─ DocumentScanner.scan_case_requirements()
│   │   ├─ 扫描文档，识别"格式自拟"关键词
│   │   ├─ 智能去重：检查附近是否已有案例表格
│   │   └─ 返回需要生成表格的位置列表
│   │
│   └─ CaseTableGenerator.generate_case_table()
│       ├─ 在指定位置插入分页符
│       ├─ 插入表格标题："业绩案例一览表"
│       ├─ 生成标准表格（表头+数据行）
│       └─ 设置表格样式（边框、对齐、列宽）
│
├─ 第4步：案例表格填充（无需修改）✅
│   └─ 自动识别所有案例表格（包括新生成的）
│   └─ 填充数据并插入附件图片
│
└─ 第5步：简历表格填充
```

**关键设计点**：
- ✅ 第3.5步生成表格 → 第4步填充表格（顺序不能颠倒）
- ✅ 生成的表格符合 `CaseTableFiller` 的识别规则
- ✅ 完全复用现有填充逻辑，零侵入

---

## 智能去重机制

### 问题场景

模板中可能已经有表格，但同时包含"格式自拟"文字：

```
八、资格案例（加盖公章）
请按照以下格式填写，格式自拟。

┌────┬──────────┬──────┬──────┬──────┐
│序号│项目名称  │客户名│金额  │时间  │  ← 已有表格
├────┼──────────┼──────┼──────┼──────┤
│    │          │      │      │      │
└────┴──────────┴──────┴──────┴──────┘
```

如果不做检测，会重复生成表格！

### 解决方案：智能检测

```
检测流程：
1. 识别"格式自拟"关键词 ✅
2. 检查附近10个段落是否有案例表格
3. 如果有表格 → 跳过生成 ⏭️
4. 如果无表格 → 添加到生成列表 ✅
```

**检测逻辑**：

```python
def _check_nearby_case_table(doc, para_idx, search_range=10):
    """
    检查指定段落附近是否已有案例表格

    检测范围：
    - 向后搜索10个段落
    - 如果遇到新的章节标题，停止搜索

    检测方法：
    - 遍历文档中的所有表格
    - 检查表格位置是否在搜索范围内
    - 使用 CaseTableFiller._is_case_table() 判断是否为案例表格
    """
```

---

## 完整流程示意图

```
招标文件：
┌────────────────────────────────┐
│ 八、资格案例（加盖公章）        │
│ 格式自拟。                      │
└────────────────────────────────┘
           ↓
【第3.5步：DocumentScanner.scan_case_requirements()】
           ↓
    识别为"格式自拟"的案例要求
           ↓
    检查附近是否已有案例表格
           ↓
    无表格 → 添加到生成列表
           ↓
【第3.5步：CaseTableGenerator.generate_case_table()】
           ↓
    在要求位置插入标准表格：
┌────────────────────────────────────────┐
│              业绩案例一览表             │
├────┬──────────┬──────────┬──────┬──────┤
│序号│项目名称  │客户名称  │金额  │时间  │
├────┼──────────┼──────────┼──────┼──────┤
│    │          │          │      │      │ ← 空表格
├────┼──────────┼──────────┼──────┼──────┤
│    │          │          │      │      │
└────┴──────────┴──────────┴──────┴──────┘
           ↓
【第4步：CaseTableFiller.fill_case_tables()】
           ↓
    识别表格（包含"项目名称"、"客户名称"等关键字段）✅
           ↓
    从案例库查询数据
           ↓
    填充表格单元格
           ↓
    在表格后插入案例附件图片
           ↓
    最终效果：
┌────────────────────────────────────────┐
│              业绩案例一览表             │
├────┬──────────────┬──────┬──────┬──────┤
│ 1  │XX平台建设    │XX公司│500万 │2023年│
├────┼──────────────┼──────┼──────┼──────┤
│ 2  │YY系统集成    │YY单位│800万 │2024年│
└────┴──────────────┴──────┴──────┴──────┘
│                                        │
│ 附件：XX平台建设项目合同                │
│ [合同图片]                              │
│                                        │
│ 附件：YY系统集成项目验收证明            │
│ [验收证明图片]                          │
└────────────────────────────────────────┘
```

---

## 技术实现细节

### 1. 案例要求识别

**关键词匹配**：
- 案例关键词：`业绩案例`、`资格案例`、`项目案例`、`类似案例`、`项目经验`等
- 格式自拟关键词：`格式自拟`、`自拟格式`、`自行编制`、`格式不限`等

**识别规则**：
```python
has_case_keyword = any(kw in text for kw in case_keywords)
has_format_free = any(kw in text for kw in format_free_keywords)

if has_case_keyword and has_format_free:
    # 可能需要生成表格
```

### 2. 表格生成

**标准表格结构**：
```python
default_table_structure = [
    {'header': '序号', 'width': 0.8},
    {'header': '项目名称', 'width': 2.5},
    {'header': '客户名称', 'width': 2.0},
    {'header': '合同金额（万元）', 'width': 1.5},
    {'header': '实施时间', 'width': 1.8},
    {'header': '联系人及联系方式', 'width': 1.8}
]
```

**生成步骤**：
1. 插入分页符（将案例表格单独成页）
2. 插入表格标题（居中、加粗）
3. 创建表格（表头行 + N行数据行）
4. 设置表头样式（加粗、背景色）
5. 设置表格边框和对齐

### 3. 与现有系统的兼容性

**表头关键字匹配**：

生成的表格表头必须包含 `CaseTableFiller.case_table_headers` 中的关键字：
```python
case_table_headers = {
    '项目名称', '案例名称', '客户名称', '合同金额',
    '实施时间', '联系人', '联系方式', ...
}
```

**识别规则**（2025-11-27更新）：

采用**四步验证法**，避免误识别报价表、诉讼表等非案例表格：

1. **排除检查**：如果表头包含"单价"、"税率"、"诉讼"等关键字 → 排除
2. **上下文检查**：表格前3-10个段落必须包含"案例"、"业绩"等关键字
3. **表头匹配**：匹配≥3个案例关键字（从≥2提高到≥3）
4. **核心字段验证**：必须包含"合同名称"或"项目名称"

✅ 我们生成的表格包含：`项目名称`、`客户名称`、`合同金额`、`实施时间`、`联系人`
→ 符合识别规则，会被自动填充

**唯一性约束**：整个文档只识别并填充**第一个**符合条件的案例表格，找到后停止遍历。

---

## 边缘情况处理

### 情况1：有表格 + "格式自拟"

```
八、资格案例（加盖公章）
格式自拟。

┌────┬──────┬──────┐
│序号│项目  │客户  │ ← 已有表格
└────┴──────┴──────┘
```

**处理**：检测到附近有案例表格 → 跳过生成 ⏭️

### 情况2：纯"格式自拟"

```
八、资格案例（加盖公章）
格式自拟。
```

**处理**：未检测到附近有案例表格 → 生成表格 ✅

### 情况3：有其他表格（非案例表格）

```
八、资格案例（加盖公章）
格式自拟。

九、财务信息
┌────────┬────────┐
│项目    │金额    │ ← 非案例表格
└────────┴────────┘
```

**处理**：检测到的是财务表格，不是案例表格 → 生成表格 ✅

---

## 代码组织

### 新增文件

1. **`case_table_generator.py`** - 案例表格生成器
   - `CaseTableGenerator` 类
   - `generate_case_table()` 方法
   - 表格样式设置工具方法

### 修改文件

1. **`document_scanner.py`** - 文档扫描器（扩展）
   - 新增：`scan_case_requirements()` - 识别"格式自拟"
   - 新增：`_check_nearby_case_table()` - 检查附近是否有表格
   - 新增：`_is_table_in_range()` - 判断表格位置
   - 新增：`_is_chapter_title()` - 识别章节标题

2. **`processor.py`** - 主处理器（扩展）
   - 修改：`__init__()` - 初始化 `CaseTableGenerator`
   - 修改：`process_business_response()` - 添加第3.5步
   - 新增：`_process_format_free_cases()` - 处理格式自拟案例

---

## 配置项

### 表格结构配置

可以通过配置文件自定义表格结构：

```json
{
  "case_table_structure": [
    {"header": "序号", "width": 0.8},
    {"header": "项目名称", "width": 2.5},
    {"header": "客户名称", "width": 2.0},
    {"header": "合同金额（万元）", "width": 1.5},
    {"header": "实施时间", "width": 1.8},
    {"header": "联系人及联系方式", "width": 1.8}
  ],
  "default_row_count": 5
}
```

### 识别关键词配置

可以扩展识别关键词列表：

```python
case_keywords = [
    '业绩案例', '资格案例', '项目案例', '类似案例',
    '业绩', '项目经验', '同类项目', '以往项目'
]

format_free_keywords = [
    '格式自拟', '自拟格式', '自行编制',
    '自行设计', '格式不限', '自定义格式'
]
```

---

## 优势总结

### 1. 完全复用现有逻辑
- ✅ 不修改 `CaseTableFiller`
- ✅ 不修改数据填充逻辑
- ✅ 不修改图片插入逻辑

### 2. 智能去重
- ✅ 避免重复生成表格
- ✅ 兼容多种模板格式
- ✅ 边缘情况处理完善

### 3. 易于维护
- ✅ 模块化设计
- ✅ 代码组织清晰
- ✅ 注释详细

### 4. 用户友好
- ✅ 自动处理，无需人工干预
- ✅ 生成标准格式
- ✅ 可配置定制

---

## 后续优化方向

### 阶段一：基础功能（当前实现）
- ✅ 识别"格式自拟"
- ✅ 智能去重检测
- ✅ 生成标准表格
- ✅ 复用填充逻辑

### 阶段二：增强功能（未来）
- 🔲 支持多种表格模板（简约版、详细版）
- 🔲 AI识别项目要求的具体字段
- 🔲 根据要求动态调整表格列
- 🔲 支持表格样式自定义

### 阶段三：智能化（未来）
- 🔲 AI分析招标要求，智能选择表格模板
- 🔲 自动推断需要的案例数量
- 🔲 根据历史数据优化表格结构

---

## 总结

本方案通过在案例表格填充步骤之前插入表格生成步骤，完美解决了"格式自拟"的业绩案例处理问题，同时保持了与现有系统的完全兼容性。

**核心原则**：
1. **生成在前，填充在后** - 确保新表格被自动填充
2. **智能去重检测** - 避免重复生成
3. **零侵入设计** - 不修改现有逻辑
4. **完全复用** - 最大化代码重用

---

*文档版本：v1.0*
*最后更新：2025-01-26*
*作者：AI助手*
