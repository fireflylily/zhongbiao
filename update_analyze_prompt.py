#!/usr/bin/env python3
"""更新 analyze_requirements 提示词以支持表格内容提取"""

import json

# 读取原文件
with open('ai_tender_system/prompts/outline_generation.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

# 获取原提示词
old_prompt = data['prompts']['analyze_requirements']

# 在"✅ 3. 关键词提取"之前插入表格处理说明
table_extraction_section = """✅ 3. 表格内容提取（重要！）
⚠️ 文档中包含表格时的特殊处理：
- 表格以 [表格 N] 标记识别，后续为表格内容的文本表示
- 表格通常包含重要的数据指标、功能清单、技术参数等关键信息
- **必须仔细提取表格中列出的每一项具体指标、数据字段、功能名称**
- 不要仅仅概括为"数据分析需求"，要列出具体的数据维度（如：居住人口数量、工作人口数量、性别分布、年龄分布等）
- 不要仅仅概括为"地理信息数据"，要列出具体的指标名称（如：商业广场分布量、夜店分布量、景点分布量等）

📊 表格内容处理示例：

示例1 - 人口大数据API需求表格：
文档中有表格列出：居住人口数量、工作人口数量、到访人口数量、性别分布、年龄分布、职业分布、月均花费消耗情况分布、富裕指数、有车预测、有房预测...

✅ 正确做法（提取具体指标）：
"key_points": [
  "人口统计数据：居住人口数量、工作人口数量、到访人口数量",
  "人群画像分析：性别分布、年龄分布、职业分布",
  "消费能力分析：月均花费、富裕指数、有车预测、有房预测、网购消费能力",
  "客流统计：典型工作日客流、典型休息日客流、月度客流按天统计",
  "驻留分析：到访频次分布、驻留时长分布"
]

❌ 错误做法（过度概括）：
"key_points": [
  "满足各种人口统计和经济分析的需求"
]

示例2 - 地理信息数据指标库表格：
文档中有表格列出17项指标：商业广场分布量、周末人流量、夜店分布量、夜间人流量、饭店分布量、饭市人流量...

✅ 正确做法（分组列出）：
"key_points": [
  "商业业态分布：商业广场分布量、夜店分布量、饭店分布量、景点分布量、公交站点分布量",
  "人流量统计：周末人流量、夜间人流量、饭市人流量、假期人流量",
  "消费者画像：居民消费者拥有量、办公消费者拥有量、前卫消费者拥有量、高档消费者拥有量、中产消费者拥有量",
  "区域属性：文旅村、示范村、惠民服务点分布量"
]

❌ 错误做法（忽略细节）：
"key_points": [
  "地理信息数据服务"
]

✅ 4. 关键词提取
为每个需求类别提取5-15个核心关键词，用于后续匹配产品文档。
- 如果需求来自表格，关键词应包含表格中的具体字段名、指标名
- 示例：["居住人口", "工作人口", "性别分布", "年龄分布", "富裕指数", "商业广场", "夜店分布", "客流统计"]

✅ 5. 章节结构建议"""

# 替换原有的"✅ 3. 关键词提取" 和 "✅ 4. 章节结构建议"
new_prompt = old_prompt.replace(
    "✅ 3. 关键词提取\n为每个需求类别提取5-10个核心关键词，用于后续匹配产品文档。\n\n✅ 4. 章节结构建议",
    table_extraction_section
)

# 更新数据
data['prompts']['analyze_requirements'] = new_prompt
data['version'] = '2.1.0'
data['updated_at'] = '2025-12-18'

# 保存文件
with open('ai_tender_system/prompts/outline_generation.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print("✅ 提示词更新完成！")
print(f"版本更新: 2.0.0 -> 2.1.0")
print("\n主要变更：")
print("1. 新增「✅ 3. 表格内容提取」章节")
print("2. 明确要求提取表格中的具体指标、数据字段、功能名称")
print("3. 提供正确和错误示例对比")
print("4. 关键词数量从5-10个扩展到5-15个")
print("5. 要求表格关键词包含具体字段名")
