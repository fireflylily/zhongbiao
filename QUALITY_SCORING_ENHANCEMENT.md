# 文档扫描器质量评分系统 - 增强方案实施报告

## 📋 项目概述

为文档扫描器引入质量评分系统，使包含专业术语、插入指示词、操作指引的段落获得更高分数，从而更准确地选择最佳插入位置。

## 🎯 问题背景

### 原始问题
在法人身份证插入点的智能选择中：
- **段落#165**："附：法定代表人/负责人的合法有效身份证明扫描件(如提供中华人民共和国居民身份证的，需同时提供国徽面及人像面)"
- 明显是最佳插入位置，但系统却错误地将其分类为`neutral`(50分)
- 导致选择了更短的段落#155(13字符)

### 根本原因
- 长度限制`len(text) < 50`阻止了54字符的"附："文本被正确分类
- 所有`strong_attach`都是100分，无法区分质量差异
- 丢失了文本的丰富特征信息（专业术语、格式说明等）

## 🔧 解决方案

### 核心设计：返回元组 (category, bonus_score)

```python
def _classify_paragraph(self, text, ...) -> tuple[str, int]:
    """
    Returns:
        (category: str, bonus_score: int)
        - category: 分类字符串
        - bonus_score: 质量奖励分（0-50分）
    """
```

### 质量评分规则

| 特征类型 | 检测内容 | 加分 | 示例 |
|---------|---------|------|------|
| **强位置信号** | 粘贴处、张贴处、贴在此处、贴于此处 | +15分 | "身份证明扫描件粘贴处" |
| **身份证专业术语** | 国徽面、人像面、正反面、头像面 | +20分 | "需同时提供国徽面及人像面" |
| **插入指示词** | 扫描件、复印件、影印件、照片 | +10分 | "身份证明扫描件" |
| **操作指引** | 需同时提供、需提供、应提供、须提供 | +5分 | "需同时提供" |
| **格式说明** | (如提供...、（如提供... | +5分 | "(如提供中华人民共和国居民身份证的..." |

**最高可获得**: 50分奖励分（强位置信号15 + 专业术语20 + 插入指示词10 + 操作指引5）

## 📊 实施效果

### 评分对比

| 段落 | 修复前 | 修复后 | 提升 |
|------|--------|--------|------|
| #153 | neutral (50分) | neutral (50分) | 无变化 |
| #155 | neutral (50分) | neutral (50分) | 无变化 |
| #165 | neutral (50分) ❌ | **strong_attach+40 (140分)** ✅ | **+90分 (+180%)** |

### 选择结果

**修复前**: 段落#155 (13字符, 50分) ❌
**修复后**: 段落#165 (54字符, 140分) ✅

### 质量加分详情（段落#165）
- ⭐ 身份证专业术语（国徽面、人像面）: **+20分**
- ⭐ 插入指示词（扫描件）: **+10分**
- ⭐ 操作指引（需同时提供）: **+5分**
- ⭐ 格式说明（如提供...）: **+5分**

## 🛠️ 技术实现

### 1. 修改返回值类型
```python
# 修改前
def _classify_paragraph(...) -> str:
    return 'strong_attach'

# 修改后
def _classify_paragraph(...) -> tuple[str, int]:
    return ('strong_attach', bonus_score)
```

### 2. 质量评分逻辑

#### 2.1 "附："开头文本的质量评分
```python
if text.startswith("附："):
    bonus_score = 0

    # 身份证专业术语 +20
    if any(term in text for term in ['国徽面', '人像面', '正反面']):
        bonus_score += 20

    # 插入指示词 +10
    if any(word in text for word in ['扫描件', '复印件']):
        bonus_score += 10

    # 操作指引 +5
    if any(pattern in text for pattern in ['需同时提供', '需提供']):
        bonus_score += 5

    # 格式说明 +5
    if '(如提供' in text:
        bonus_score += 5

    return ('strong_attach', bonus_score)
```

#### 2.2 通用强位置信号检测（关键补充！）
```python
# 检测"粘贴处"等最强插入信号
strong_insert_markers = ['粘贴处', '粘贴页', '贴在此处', '贴于此处', '张贴处']
has_strong_marker = any(marker in text for marker in strong_insert_markers)

# 检测插入指示词
insert_indicators = ['扫描件', '复印件', '影印件', '照片', '彩色扫描件']
has_insert_indicator = any(indicator in text for indicator in insert_indicators)

# 检测资质关键词
qual_keywords = ['身份证', '营业执照', '资质', '证书', '许可证', '授权书', '合同', '报告']
has_qual_keyword = any(kw in text for kw in qual_keywords)

# 如果包含强插入信号，提升为strong_attach并计算奖励分
if has_strong_marker and has_qual_keyword:
    bonus_score = 0

    # "粘贴处"是最强信号 +15分
    if has_strong_marker:
        bonus_score += 15

    # 插入指示词 +10分
    if has_insert_indicator:
        bonus_score += 10

    # 身份证专业术语 +20分
    id_card_terms = ['国徽面', '人像面', '正、反面', '正反面', '头像面']
    if any(term in text for term in id_card_terms):
        bonus_score += 20

    return ('strong_attach', bonus_score)
```

### 3. 选择逻辑增强
```python
# 修改前
best = max(candidates, key=lambda x: (
    category_priority[x['category']],  # 只看基础分
    -len(x['text']),
    x['index']
))

# 修改后
best = max(candidates, key=lambda x: (
    category_priority[x['category']] + x.get('bonus_score', 0),  # 基础分+奖励分
    -len(x['text']),
    x['index']
))
```

### 4. 日志输出增强
```python
# 显示格式: [category+bonus] 总分=xxx
score_display = f"[strong_attach+40] 总分=140"

self.logger.info(
    f"✅ legal_id: 找到优质位置 [strong_attach+40] 总分=140 "
    f"'附：法定代表人/负责人的合法有效身份证明扫描件...' (共3个候选)"
)
```

## ✅ 测试验证

### 测试文件
- `test_quality_scoring.py` - 原始问题场景测试（段落#165）
- `test_quality_scoring_complete.py` - 完整测试（7个场景，包含粘贴处案例）

### 测试结果
```
✅ 完整质量评分系统测试全部通过！
   ✓ 测试用例: 7个
   ✓ 附件文本识别: ✅
   ✓ 粘贴处信号识别: ✅ （关键修复）
   ✓ 质量特征评分: ✅
   ✓ 多维度组合: ✅
   ✓ 普通文本不受影响: ✅

关键测试用例：
1. 段落#165（附件文本）: 140分 (100+40) ✅
2. 委托代理人粘贴处: 125分 (100+25) ✅
3. 粘贴处+专业术语组合: 145分 (100+45) ✅ 最高分
```

## 📈 影响范围

### 受益场景
1. **身份证插入** - 识别专业术语（国徽面、人像面）和强位置信号（粘贴处）
2. **营业执照插入** - 识别"复印件"等指示词
3. **资质证书插入** - 识别"加盖公章"等格式要求
4. **审计报告插入** - 识别"经审计的财务报告"等专业表述
5. **通用场景** - 识别"粘贴处"、"张贴处"等明确的位置指示

### 关键改进
- ✅ **补充通用质量检测** - 不仅检测"附："开头，还检测所有包含"粘贴处"等强信号的文本
- ✅ **案例修复** - "委托代理人的合法有效身份证明扫描件粘贴处"现在能正确识别并获得125分

### 向后兼容性
- ✅ 不包含质量特征的段落评分不变
- ✅ 现有的分类逻辑完全保留
- ✅ 日志输出向后兼容（无bonus时不显示）

## 🎓 核心优势

1. **精准识别** - 通过多维度评分准确识别优质插入点
2. **灵活扩展** - 易于添加新的质量评分规则
3. **向后兼容** - 不破坏现有代码逻辑
4. **日志友好** - 清晰显示评分依据，便于调试
5. **性能友好** - 计算开销小，不影响性能

## 📝 修改文件清单

| 文件 | 修改内容 | 行数 | 状态 |
|------|---------|------|------|
| `document_scanner.py` | 核心增强逻辑（包含通用质量检测） | ~150行 | ✅ 完成 |
| `test_quality_scoring.py` | 原始场景测试 | 新增 | ✅ 完成 |
| `test_quality_scoring_complete.py` | 完整测试（7个场景） | 新增 | ✅ 完成 |
| `QUALITY_SCORING_ENHANCEMENT.md` | 技术文档 | 更新 | ✅ 完成 |

## 🚀 未来扩展

可以考虑的进一步优化：
1. 支持更多资质类型的专业术语识别
2. 根据实际使用情况调整评分权重
3. 增加机器学习模型辅助评分
4. 支持自定义评分规则配置

## 📌 总结

本次增强方案成功解决了文档扫描器在插入点选择上的准确性问题，通过引入质量评分系统：
- ✅ 评分从50分提升到140分（+180%）
- ✅ 正确识别优质插入位置（附件文本）
- ✅ **新增通用强位置信号检测** - 解决"粘贴处"等案例
- ✅ 最高可达145分（粘贴处+专业术语+指示词组合）
- ✅ 保持向后兼容性
- ✅ 测试全部通过（7个场景）

### 关键成果
1. **原始问题解决**: 段落#165从50分提升到140分 ✅
2. **缺失案例修复**: "委托代理人粘贴处"从neutral提升到125分 ✅
3. **最佳实践**: 粘贴处+专业术语组合可达145分（最高质量）✅

---

**实施日期**: 2025-12-02
**实施人员**: Claude Code
**测试状态**: ✅ 通过（7/7场景）
**部署状态**: ✅ 就绪
**版本**: v2.0 (增补通用质量检测)
