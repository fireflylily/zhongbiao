# 阿里云部署常见问题排查指南

> 本文档记录实际部署过程中遇到的所有问题和解决方案

## 📋 部署环境

- **服务器**: 阿里云ECS
- **操作系统**: 阿里云 Linux (Alinux)
- **包管理器**: yum (不是apt)
- **Web服务器**: Nginx
- **应用服务器**: Flask + Python 3.11虚拟环境
- **标准端口**: 8110

---

## 🚨 问题1：Docker镜像拉取失败

### 现象
```
failed to solve: python:3.11-slim: failed to resolve source metadata
pull access denied, repository does not exist
```

### 原因
- 中国大陆访问Docker Hub受限
- 配置的镜像加速器DNS解析失败

### 解决方案
**放弃Docker部署，改用传统Python虚拟环境部署**

```bash
# 使用虚拟环境
cd /var/www/ai-tender-system
source venv/bin/activate
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
python -m ai_tender_system.web.app
```

### 经验教训
- ✅ 传统部署在网络受限环境更稳定
- ✅ Docker适合网络环境好的场景
- ✅ 保留两种部署方式作为备选

---

## 🚨 问题2：端口配置不一致（502错误）

### 现象
- 浏览器访问显示 502 Bad Gateway
- Flask应用正常运行但无法访问

### 原因
**配置分散导致端口不一致**：
- 代码默认端口：8082 (`config.py:253`)
- Nginx代理端口：8110
- Docker配置端口：8110
- `.env`文件：未明确配置

### 解决方案

#### 1. 统一代码默认端口
修改 `ai_tender_system/common/config.py:254`：
```python
'port': int(os.getenv('WEB_PORT', '8110'))  # 从8082改为8110
```

#### 2. 配置验证脚本
创建 `scripts/check-config.sh` 自动检查配置一致性

#### 3. 明确配置.env
```bash
WEB_PORT=8110
```

### 经验教训
- ✅ 所有配置必须统一标准端口
- ✅ 使用自动化脚本验证配置
- ✅ 代码默认值应该与部署配置一致

---

## 🚨 问题3：Nginx静态资源301重定向

### 现象
```
GET /static/dist/js/vendor-vue.js → 301 → /static/dist/js/vendor-vue.js/
GET /static/dist/css/index.css → 301 → /static/dist/css/index.css/
```
URL自动添加尾部斜杠，导致404错误。

### 原因
**Nginx配置问题**：
```nginx
# 错误配置
location /static/dist/ {  # ❌ 末尾斜杠
    alias /path/to/dist/;
}
```

当访问 `/static/dist/js/vendor.js` 时：
1. Nginx匹配到 `location /static/dist/`
2. 使用 `alias` 查找文件
3. 因为 `alias` 以斜杠结尾，Nginx认为是目录
4. 自动301重定向到 `/static/dist/js/vendor.js/`
5. 导致404

### 解决方案

#### 正确配置
```nginx
# ✅ 去掉末尾斜杠，使用 ^~ 优先匹配
location ^~ /static/dist {
    alias /var/www/ai-tender-system/ai_tender_system/web/static/dist;
    try_files $uri $uri/ =404;
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

**关键点**：
- ✅ `location /static/dist` 不要末尾斜杠
- ✅ `alias` 路径也不要末尾斜杠
- ✅ 使用 `^~` 前缀优先匹配
- ✅ 添加 `try_files $uri $uri/ =404`

### 经验教训
- ✅ Nginx的 `alias` 指令对斜杠非常敏感
- ✅ 使用 `^~` 避免location优先级冲突
- ✅ 避免嵌套location，容易出问题

---

## 🚨 问题4：浏览器缓存旧版本

### 现象
- 服务器已更新代码
- 浏览器仍然请求旧的文件名
- HTML正确但JS/CSS文件404

### 原因
- 浏览器缓存了旧版本的HTML文件
- Vite构建时文件名包含hash，每次不同
- 旧HTML引用旧文件名，新服务器没有旧文件

### 解决方案

#### 1. 用户端：强制清除缓存
- **Windows**: `Ctrl + Shift + R`
- **Mac**: `Cmd + Shift + R`
- **或**: `Ctrl/Cmd + Shift + Delete` 清除浏览器数据

#### 2. 服务器端：禁止缓存HTML
```nginx
location / {
    # ...
    expires -1;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}
```

#### 3. 使用无痕模式测试
避免缓存干扰，快速验证部署

### 经验教训
- ✅ HTML文件永远不要缓存
- ✅ JS/CSS文件使用hash命名可以长期缓存
- ✅ 部署后用无痕模式测试
- ✅ 提醒用户清除缓存

---

## 🚨 问题5：JavaScript循环依赖错误

### 现象
```
Uncaught ReferenceError: Cannot access 'ae' before initialization
at vendor-vue.js
at vendor-other.js
```

### 原因
**Vite手动代码分割配置不当**：
```javascript
// ❌ 过度分割导致循环依赖
manualChunks: (id) => {
  if (id.includes('vue')) return 'vendor-vue'
  if (id.includes('element-plus')) return 'vendor-element-plus'
  if (id.includes('editor')) return 'vendor-editor'
  // ...
}
```

Vue和其他库之间有依赖关系，分离后导致初始化顺序错误。

### 解决方案

#### 简化代码分割
```javascript
// ✅ 所有第三方库打包成一个vendor
manualChunks: (id) => {
  if (id.includes('node_modules')) {
    return 'vendor'
  }
}
```

### 经验教训
- ✅ 不要过度优化代码分割
- ✅ 单一vendor文件更稳定（虽然大一点）
- ✅ 只在真正需要时才手动分割

---

## 🚨 问题6：macOS资源分叉文件干扰

### 现象
- Git status显示大量 `._` 开头的文件
- 可能影响文件访问

### 原因
macOS在非Mac文件系统创建的资源分叉文件（metadata）

### 解决方案
```bash
# 定期清理
find ai_tender_system/web/static/dist -name "._*" -type f -delete

# .gitignore添加
echo "._*" >> .gitignore
```

### 经验教训
- ✅ 部署前清理macOS垃圾文件
- ✅ 在.gitignore中排除
- ✅ 使用zip/tar打包传输避免产生

---

## 🚨 问题7：阿里云Linux系统差异

### 现象
```bash
sudo apt install docker-compose
# 错误: apt：找不到命令
```

### 原因
阿里云Linux基于CentOS/RHEL，不是Ubuntu/Debian

### 解决方案

| 操作 | Ubuntu/Debian | 阿里云 Linux |
|------|--------------|-------------|
| 安装软件 | `apt install` | `yum install` |
| 更新索引 | `apt update` | `yum check-update` |
| 删除软件 | `apt remove` | `yum remove` |

### 经验教训
- ✅ 文档需要明确标注系统类型
- ✅ 提供不同系统的对照命令
- ✅ 优先使用系统自带工具

---

## ✅ 成功部署检查清单

部署完成后验证：

- [x] Flask应用运行在8110端口
- [x] Nginx监听80端口
- [x] `curl http://localhost:8110/api/health` 返回JSON
- [x] `curl http://localhost/` 返回HTML
- [x] `curl http://localhost/static/dist/js/vendor-xxx.js` 返回200
- [x] 浏览器访问 `http://8.140.21.235` 显示Vue应用
- [x] 所有静态资源加载成功（无404/301）
- [x] 控制台无JavaScript错误
- [x] 配置验证脚本通过：`./scripts/check-config.sh`

---

## 📚 快速参考

### 完整部署流程（传统方式）

```bash
# 服务器端
cd /var/www/ai-tender-system
git pull origin master
source venv/bin/activate
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 停止旧进程
sudo lsof -ti:8110 | xargs sudo kill -9 2>/dev/null || true

# 更新Nginx配置
sudo cp nginx/ai-tender-system.conf /etc/nginx/conf.d/
sudo nginx -t
sudo systemctl reload nginx

# 启动应用
nohup python -m ai_tender_system.web.app > logs/app.log 2>&1 &

# 验证
sleep 3
curl http://localhost:8110/api/health
curl http://localhost/
```

### 日常运维命令

```bash
# 查看应用日志
tail -f logs/app.log

# 查看Nginx日志
sudo tail -f /var/log/nginx/ai-tender-system-error.log

# 查看应用进程
ps aux | grep "ai_tender_system.web.app"

# 查看端口占用
sudo lsof -i:8110

# 重启应用
sudo lsof -ti:8110 | xargs sudo kill
nohup python -m ai_tender_system.web.app > logs/app.log 2>&1 &
```

---

## 🎯 核心经验总结

### 1. 配置管理
- ✅ 所有端口配置统一为8110
- ✅ 使用 `scripts/check-config.sh` 自动验证
- ✅ .env文件明确配置，不依赖默认值

### 2. Nginx配置
- ✅ 使用 `^~` 前缀避免匹配冲突
- ✅ `location /static/dist` 不要末尾斜杠
- ✅ HTML文件禁止缓存，静态资源长期缓存

### 3. 前端构建
- ✅ 不要过度分割代码（避免循环依赖）
- ✅ 构建后清理macOS资源文件
- ✅ 部署前测试构建产物

### 4. 问题排查
- ✅ 先查服务器日志（Nginx + 应用）
- ✅ 用curl测试验证服务器端正常
- ✅ 分离服务器问题和浏览器缓存问题
- ✅ 使用无痕模式排除缓存干扰

---

## 📊 本次部署时间线

| 时间 | 问题 | 解决方案 | 状态 |
|------|------|----------|------|
| 开始 | Docker镜像拉取失败 | 改用传统部署 | ✅ |
| +10min | 端口8082 vs 8110不一致 | 统一配置为8110 | ✅ |
| +20min | Nginx静态资源301重定向 | 移除末尾斜杠，添加^~ | ✅ |
| +30min | 浏览器缓存旧HTML | 强制刷新 | ✅ |
| +35min | JS循环依赖错误 | 简化代码分割 | ✅ |
| 完成 | ✅ 应用正常运行 | - | ✅ |

---

## 🔗 相关文档

- [阿里云Docker部署步骤](../../阿里云Docker部署步骤.md)
- [端口配置说明](端口配置说明.md)
- [阿里云Linux特别说明](阿里云Linux特别说明.md)
- [Nginx配置说明](../../nginx/README.md)

---

**创建日期**: 2025-11-20
**最后验证**: 2025-11-20 ✅ 部署成功
**维护者**: lvhe
