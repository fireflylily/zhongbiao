<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI标书点对点应答系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #007bff;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #0056b3;
            background: #e9ecef;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background: #d4edda;
        }
        .feature-card {
            transition: transform 0.2s ease;
            height: 100%;
        }
        .feature-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .progress {
            display: none;
        }
        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        .api-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .api-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .footer {
            margin-top: 60px;
            padding: 20px 0;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- 页面标题 -->
        <div class="row">
            <div class="col-12">
                <div class="text-center mb-5">
                    <h1 class="display-4 text-primary">
                        <i class="bi bi-robot"></i> AI标书智能生成系统
                    </h1>
                    <p class="lead text-muted">智能识别采购需求，自动生成专业应答和技术方案</p>
                </div>
            </div>
        </div>

        <!-- 功能选项卡 -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-pills nav-justified mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="point-to-point-tab" data-bs-toggle="pill" 
                                data-bs-target="#point-to-point" type="button" role="tab">
                            <i class="bi bi-chat-dots"></i> 点对点应答
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tech-proposal-tab" data-bs-toggle="pill" 
                                data-bs-target="#tech-proposal" type="button" role="tab">
                            <i class="bi bi-file-earmark-code"></i> 技术方案生成
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tender-info-tab" data-bs-toggle="pill" 
                                data-bs-target="#tender-info" type="button" role="tab">
                            <i class="bi bi-search"></i> 招标信息提取
                        </button>
                    </li>
                </ul>
            </div>
        </div>

        <div class="tab-content" id="mainTabContent">
            <!-- 点对点应答选项卡 -->
            <div class="tab-pane fade show active" id="point-to-point" role="tabpanel">
                <!-- 功能特点 -->
        <div class="row mb-5">
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-lightning-charge text-warning" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">智能识别</h5>
                        <p class="card-text text-muted">自动识别文档中的需求条目，减少遗漏</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-cpu text-primary" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">AI生成</h5>
                        <p class="card-text text-muted">使用先进AI模型生成专业技术应答</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card feature-card">
                    <div class="card-body text-center">
                        <i class="bi bi-palette text-success" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-3">格式美化</h5>
                        <p class="card-text text-muted">自动设置字体、颜色、底纹和行距</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- API配置区域 -->
        <div class="row">
            <div class="col-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="bi bi-gear"></i> API配置</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="apiKey" class="form-label">始皇API密钥</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="apiKey" 
                                           placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxx" 
                                           value="sk-4sYV1WXMcdGcLz9XEKWyntV58pSnhb4GXM6aMBfzWUic3pLfnwob">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    API密钥用于生成专业的技术应答，留空将使用默认模板
                                </small>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">密钥管理</label>
                                <div class="btn-group d-flex">
                                    <button type="button" class="btn btn-outline-success btn-sm" id="saveApiBtn">
                                        <i class="bi bi-save"></i> 保存
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="loadApiBtn">
                                        <i class="bi bi-upload"></i> 加载
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" id="manageApiBtn">
                                        <i class="bi bi-gear"></i> 管理
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="button" class="btn btn-outline-primary flex-fill" id="testApiBtn">
                                    <i class="bi bi-wifi"></i> 测试连接
                                </button>
                            </div>
                        </div>
                        <div id="apiStatus" class="api-status"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 文件上传区域 -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-upload"></i> 文档上传处理</h5>
                    </div>
                    <div class="card-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="upload-area" id="uploadArea">
                                <i class="bi bi-cloud-upload text-primary" style="font-size: 3rem;"></i>
                                <h4 class="mt-3">拖拽文档到这里或点击选择</h4>
                                <p class="text-muted">支持 .docx 和 .doc 格式，最大 50MB</p>
                                <input type="file" class="d-none" id="fileInput" name="file" accept=".docx,.doc">
                                <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click();">
                                    <i class="bi bi-folder2-open"></i> 选择文件
                                </button>
                            </div>
                            
                            <div id="fileInfo" class="mt-3" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    <span id="fileName"></span>
                                    <span id="fileSize" class="text-muted ms-2"></span>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button type="submit" class="btn btn-success btn-lg" id="processBtn" disabled>
                                    <i class="bi bi-play-circle"></i> 开始处理
                                </button>
                            </div>
                        </form>
                        
                        <!-- 进度条 -->
                        <div class="progress mt-3" id="progressBar">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        
                        <!-- 结果区域 -->
                        <div id="resultArea" class="mt-4" style="display: none;">
                            <div class="alert alert-success">
                                <h5><i class="bi bi-check-circle"></i> 处理完成！</h5>
                                <p id="resultMessage"></p>
                                <div class="mt-3">
                                    <button id="downloadBtn" class="btn btn-primary me-2">
                                        <i class="bi bi-download"></i> 下载处理后的文档
                                    </button>
                                    <button id="viewFilesBtn" class="btn btn-outline-info">
                                        <i class="bi bi-file-earmark-text"></i> 查看所有文件
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 错误区域 -->
                        <div id="errorArea" class="mt-4" style="display: none;">
                            <div class="alert alert-danger">
                                <h5><i class="bi bi-exclamation-triangle"></i> 处理失败</h5>
                                <p id="errorMessage"></p>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-outline-primary" id="retryBtn">
                                        <i class="bi bi-arrow-clockwise"></i> 重试
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                                        <i class="bi bi-arrow-counterclockwise"></i> 重新选择文件
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="bi bi-question-circle"></i> 使用说明</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>📋 支持的文档格式</h6>
                                <ul>
                                    <li>Microsoft Word 文档 (.docx)</li>
                                    <li>Microsoft Word 97-2003 文档 (.doc)</li>
                                    <li>文档大小限制：50MB</li>
                                </ul>
                                
                                <h6>🎯 处理功能</h6>
                                <ul>
                                    <li>自动识别采购需求条目</li>
                                    <li>生成"应答：满足。"格式的专业应答</li>
                                    <li>保持原文档格式和字体</li>
                                    <li>应答内容：黑色字体，灰色底纹，1.5倍行距</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>🔧 API配置</h6>
                                <ul>
                                    <li>配置始皇API密钥以获得更专业的AI应答</li>
                                    <li>不配置API密钥将使用内置应答模板</li>
                                    <li>建议使用GPT-4o-mini模型获得最佳效果</li>
                                </ul>
                                
                                <h6>⚠️ 注意事项</h6>
                                <ul>
                                    <li>处理时间视文档大小和复杂度而定</li>
                                    <li>请确保网络连接稳定</li>
                                    <li>建议备份原始文档</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        <!-- 结束点对点应答选项卡 -->

        <!-- 技术方案生成选项卡 -->
        <div class="tab-pane fade" id="tech-proposal" role="tabpanel">
            <!-- 技术方案功能特点 -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-file-earmark-text text-info" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">智能解析</h5>
                            <p class="card-text text-muted">自动解析招标文件和产品文档，提取关键信息</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-gear-wide-connected text-warning" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">智能匹配</h5>
                            <p class="card-text text-muted">精确匹配产品功能与招标需求</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-journal-text text-success" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">方案生成</h5>
                            <p class="card-text text-muted">自动生成完整的技术方案文档</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件上传区域 -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-upload"></i> 技术方案生成</h5>
                        </div>
                        <div class="card-body">
                            <form id="techProposalForm" enctype="multipart/form-data">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="upload-area tech-upload" data-type="tender">
                                            <i class="bi bi-file-earmark-check text-primary" style="font-size: 2rem;"></i>
                                            <h5 class="mt-2">招标文件</h5>
                                            <p class="text-muted mb-3">上传招标文件或需求文档</p>
                                            <input type="file" class="d-none" id="techTenderFileInput" name="tender_file" accept=".docx,.doc,.pdf">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('techTenderFileInput').click();">
                                                <i class="bi bi-folder2-open"></i> 选择招标文件
                                            </button>
                                            <div id="tenderFileInfo" class="mt-2" style="display: none;">
                                                <small class="text-success"><i class="bi bi-check-circle"></i> <span id="tenderFileName"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="upload-area tech-upload" data-type="product">
                                            <i class="bi bi-file-earmark-code text-info" style="font-size: 2rem;"></i>
                                            <h5 class="mt-2">产品文档</h5>
                                            <p class="text-muted mb-3">上传产品功能说明文档</p>
                                            <input type="file" class="d-none" id="productFileInput" name="product_file" accept=".docx,.doc,.pdf">
                                            <button type="button" class="btn btn-info btn-sm" onclick="document.getElementById('productFileInput').click();">
                                                <i class="bi bi-folder2-open"></i> 选择产品文档
                                            </button>
                                            <div id="productFileInfo" class="mt-2" style="display: none;">
                                                <small class="text-success"><i class="bi bi-check-circle"></i> <span id="productFileName"></span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="outputPrefix" class="form-label">输出文件前缀</label>
                                        <input type="text" class="form-control" id="outputPrefix" name="output_prefix" value="技术方案" placeholder="输入文件名前缀">
                                    </div>
                                    <div class="col-md-6 d-flex align-items-end">
                                        <button type="submit" class="btn btn-success btn-lg flex-fill" id="generateProposalBtn" disabled>
                                            <i class="bi bi-play-circle"></i> 生成技术方案
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- 进度条 -->
                            <div class="progress mt-3" id="techProgressBar" style="display: none;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            
                            <!-- 结果区域 -->
                            <div id="techResultArea" class="mt-4" style="display: none;">
                                <div class="alert alert-success">
                                    <h5><i class="bi bi-check-circle"></i> 技术方案生成完成！</h5>
                                    <p id="techResultMessage"></p>
                                    <div id="techDownloadArea" class="mt-3">
                                        <!-- 下载按钮将动态生成 -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 错误区域 -->
                            <div id="techErrorArea" class="mt-4" style="display: none;">
                                <div class="alert alert-danger">
                                    <h5><i class="bi bi-exclamation-triangle"></i> 生成失败</h5>
                                    <p id="techErrorMessage"></p>
                                    <div class="mt-3">
                                        <button type="button" class="btn btn-outline-primary" id="techRetryBtn">
                                            <i class="bi bi-arrow-clockwise"></i> 重试
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" id="techResetBtn">
                                            <i class="bi bi-arrow-counterclockwise"></i> 重新选择文件
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 技术方案使用说明 -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="bi bi-question-circle"></i> 技术方案生成说明</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>📋 支持的文档格式</h6>
                                    <ul>
                                        <li>Word文档 (.docx, .doc)</li>
                                        <li>PDF文档 (.pdf)</li>
                                        <li>文档大小限制：50MB</li>
                                    </ul>
                                    
                                    <h6>🎯 生成功能</h6>
                                    <ul>
                                        <li>自动解析招标需求和产品功能</li>
                                        <li>智能匹配需求与功能特性</li>
                                        <li>生成完整的技术方案大纲</li>
                                        <li>输出专业的Word格式方案文档</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>📊 输出文件</h6>
                                    <ul>
                                        <li>技术方案文档 (.docx)</li>
                                        <li>方案大纲 (.json)</li>
                                        <li>匹配度报告 (.json)</li>
                                        <li>完整数据 (.json)</li>
                                    </ul>
                                    
                                    <h6>⚠️ 注意事项</h6>
                                    <ul>
                                        <li>需要上传招标文件和产品文档</li>
                                        <li>生成时间较长，请耐心等待</li>
                                        <li>建议使用格式规范的文档</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 结束技术方案选项卡 -->

        <!-- 招标信息提取选项卡 -->
        <div class="tab-pane fade" id="tender-info" role="tabpanel">
            <!-- 功能特点 -->
            <div class="row mb-5">
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-search text-info" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">智能提取</h5>
                            <p class="card-text text-muted">AI自动识别招标文件中的关键信息</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-list-check text-success" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">完整字段</h5>
                            <p class="card-text text-muted">提取招标人、代理、时间等8个关键字段</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card feature-card">
                        <div class="card-body text-center">
                            <i class="bi bi-gear text-warning" style="font-size: 2rem;"></i>
                            <h5 class="card-title mt-3">配置保存</h5>
                            <p class="card-text text-muted">自动保存提取结果到配置文件</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API密钥配置 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-key"></i> API密钥配置
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8 mb-2">
                                    <input type="password" class="form-control" id="tenderApiKey" 
                                           placeholder="请输入始皇API密钥 (sk-...)" 
                                           value="sk-4sYV1WXMcdGcLz9XEKWyntV58pSnhb4GXM6aMBfzWUic3pLfnwob">
                                </div>
                                <div class="col-md-4 mb-2">
                                    <button class="btn btn-outline-primary" type="button" id="testTenderApiBtn">
                                        <i class="bi bi-wifi"></i> 测试连接
                                    </button>
                                </div>
                            </div>
                            <div id="tenderApiStatus" class="api-status"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 文件上传区域 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="bi bi-cloud-upload"></i> 招标文档上传
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="tenderUploadArea">
                                <i class="bi bi-cloud-upload-fill text-primary" style="font-size: 3rem;"></i>
                                <h5 class="mt-3">拖放招标文档到此处</h5>
                                <p class="text-muted mb-3">或点击选择文件</p>
                                <p class="text-muted small">
                                    支持格式：Word文档 (.docx, .doc)、文本文件 (.txt)、PDF文件 (.pdf)
                                </p>
                                <input type="file" class="d-none" id="tenderFileInput" 
                                       accept=".docx,.doc,.txt,.pdf">
                            </div>
                            
                            <!-- 文件信息显示 -->
                            <div class="mt-3" id="tenderFileInfo" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-file-earmark-text"></i>
                                    已选择文件：<strong id="tenderFileName"></strong>
                                    <span class="text-muted" id="tenderFileSize"></span>
                                </div>
                            </div>

                            <!-- 提取按钮 -->
                            <div class="text-center mt-4">
                                <button class="btn btn-primary btn-lg" type="button" id="extractInfoBtn" disabled>
                                    <i class="bi bi-play-circle"></i> 开始提取信息
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 进度条 -->
            <div class="progress mb-4" id="tenderProgressBar" style="display: none;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>

            <!-- 提取结果显示 -->
            <div class="row" id="tenderResultArea" style="display: none;">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-check-circle"></i> 招标信息提取完成
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row" id="tenderInfoDisplay">
                                <!-- 提取结果将在这里显示 -->
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-outline-success me-2" id="tenderRetryBtn">
                                    <i class="bi bi-arrow-clockwise"></i> 重新提取
                                </button>
                                <button class="btn btn-outline-secondary" id="tenderResetBtn">
                                    <i class="bi bi-x-circle"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 错误信息显示 -->
            <div class="row" id="tenderErrorArea" style="display: none;">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">
                                <i class="bi bi-exclamation-triangle"></i> 提取失败
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-danger mb-3">
                                <p id="tenderErrorMessage"></p>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-outline-danger me-2" id="tenderRetryBtn2">
                                    <i class="bi bi-arrow-clockwise"></i> 重试
                                </button>
                                <button class="btn btn-outline-secondary" id="tenderResetBtn2">
                                    <i class="bi bi-x-circle"></i> 重置
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 功能说明 -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="bi bi-info-circle"></i> 功能说明
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>📄 提取字段</h6>
                                    <ul>
                                        <li>招标人（采购人/甲方）</li>
                                        <li>招标代理（代理机构）</li>
                                        <li>投标方式（公开招标等）</li>
                                        <li>投标地点（递交地点）</li>
                                        <li>投标时间（截止时间）</li>
                                        <li>中标人数量（预计数量）</li>
                                        <li>项目名称</li>
                                        <li>项目编号（招标编号）</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>🔧 技术特点</h6>
                                    <ul>
                                        <li>AI智能识别关键信息</li>
                                        <li>支持多种文档格式</li>
                                        <li>正则表达式备用方案</li>
                                        <li>自动保存到配置文件</li>
                                    </ul>
                                    
                                    <h6>⚠️ 注意事项</h6>
                                    <ul>
                                        <li>确保文档内容清晰可读</li>
                                        <li>建议使用标准招标文件格式</li>
                                        <li>提取结果会自动保存到配置文件</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- 结束招标信息提取选项卡 -->

        </div>
        <!-- 结束选项卡内容 -->

        <!-- 页脚 -->
        <div class="footer text-center">
            <p>&copy; 2025 智慧足迹AI标书生成系统 | 专业 · 高效 · 智能</p>
        </div>
    </div>

    <!-- API密钥备份管理模态框 -->
    <div class="modal fade" id="apiBackupModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-lock"></i> API密钥备份管理
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <h6>当前密钥</h6>
                            <div class="input-group">
                                <input type="password" class="form-control" id="currentApiKey" readonly>
                                <button class="btn btn-outline-primary" type="button" id="backupCurrentBtn">
                                    <i class="bi bi-cloud-upload"></i> 备份到服务器
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <h6>已保存的备份</h6>
                    <div id="backupList" class="mt-3">
                        <div class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i> 正在加载备份列表...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DOM元素引用
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const processBtn = document.getElementById('processBtn');
        const progressBar = document.getElementById('progressBar');
        const resultArea = document.getElementById('resultArea');
        const errorArea = document.getElementById('errorArea');
        const uploadForm = document.getElementById('uploadForm');
        const apiKeyInput = document.getElementById('apiKey');
        const toggleApiBtn = document.getElementById('toggleApiKey');
        const saveApiBtn = document.getElementById('saveApiBtn');
        const loadApiBtn = document.getElementById('loadApiBtn');

        // API密钥安全管理
        const API_STORAGE_KEY = 'ai_tender_api_key_encrypted';
        
        // 简单的加密/解密函数（基于Base64和简单混淆）
        function encryptApiKey(key) {
            if (!key) return '';
            const encoded = btoa(unescape(encodeURIComponent(key)));
            return encoded.split('').reverse().join('');
        }
        
        function decryptApiKey(encrypted) {
            if (!encrypted) return '';
            try {
                const reversed = encrypted.split('').reverse().join('');
                return decodeURIComponent(escape(atob(reversed)));
            } catch (e) {
                console.error('解密失败:', e);
                return '';
            }
        }

        // 页面加载时尝试加载保存的API密钥或使用默认密钥
        window.addEventListener('load', function() {
            const defaultKey = '{{ default_api_key }}';
            const saved = localStorage.getItem(API_STORAGE_KEY);
            
            if (saved) {
                const decrypted = decryptApiKey(saved);
                if (decrypted) {
                    apiKeyInput.value = decrypted;
                    document.getElementById('tenderApiKey').value = decrypted;
                    showNotification('已加载保存的API密钥', 'success');
                    return;
                }
            }
            
            // 如果没有保存的密钥，使用默认密钥
            if (defaultKey && defaultKey !== 'None') {
                apiKeyInput.value = defaultKey;
                document.getElementById('tenderApiKey').value = defaultKey;
                showNotification('已加载默认API密钥', 'info');
            }
        });

        // 显示/隐藏API密钥
        toggleApiBtn.addEventListener('click', function() {
            const isPassword = apiKeyInput.type === 'password';
            apiKeyInput.type = isPassword ? 'text' : 'password';
            this.innerHTML = isPassword ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
        });

        // 保存API密钥
        saveApiBtn.addEventListener('click', function() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showNotification('请先输入API密钥', 'error');
                return;
            }
            
            const encrypted = encryptApiKey(apiKey);
            localStorage.setItem(API_STORAGE_KEY, encrypted);
            showNotification('API密钥已安全保存到本地', 'success');
        });

        // 加载API密钥
        loadApiBtn.addEventListener('click', function() {
            const saved = localStorage.getItem(API_STORAGE_KEY);
            if (saved) {
                const decrypted = decryptApiKey(saved);
                if (decrypted) {
                    apiKeyInput.value = decrypted;
                    showNotification('API密钥加载成功', 'success');
                } else {
                    showNotification('API密钥解密失败', 'error');
                }
            } else {
                showNotification('未找到保存的API密钥', 'error');
            }
        });

        // 管理API密钥备份
        document.getElementById('manageApiBtn').addEventListener('click', function() {
            document.getElementById('currentApiKey').value = apiKeyInput.value;
            loadBackupList();
            new bootstrap.Modal(document.getElementById('apiBackupModal')).show();
        });

        // 备份当前密钥到服务器
        document.getElementById('backupCurrentBtn').addEventListener('click', function() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                showNotification('请先输入API密钥', 'error');
                return;
            }
            
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 备份中...';
            btn.disabled = true;
            
            fetch('/api/save-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadBackupList(); // 刷新备份列表
                } else {
                    showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('备份失败: ' + error.message, 'error');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        // 加载备份列表
        function loadBackupList() {
            const backupList = document.getElementById('backupList');
            backupList.innerHTML = '<div class="text-center text-muted"><i class="bi bi-hourglass-split"></i> 正在加载备份列表...</div>';
            
            fetch('/api/load-backups')
            .then(response => response.json())
            .then(data => {
                if (data.backups && data.backups.length > 0) {
                    let html = '';
                    data.backups.forEach(backup => {
                        const date = new Date(backup.created_at).toLocaleString('zh-CN');
                        html += `
                            <div class="card mb-2">
                                <div class="card-body py-2">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <strong>${backup.prefix}</strong>
                                            <small class="text-muted d-block">${backup.description}</small>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">${date}</small>
                                        </div>
                                        <div class="col-md-2 text-end">
                                            <button class="btn btn-sm btn-outline-primary restore-backup-btn" 
                                                    data-backup-id="${backup.id}">
                                                <i class="bi bi-download"></i> 恢复
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    backupList.innerHTML = html;
                    
                    // 绑定恢复按钮事件
                    document.querySelectorAll('.restore-backup-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const backupId = this.dataset.backupId;
                            restoreApiKey(backupId);
                        });
                    });
                } else {
                    backupList.innerHTML = '<div class="text-center text-muted"><i class="bi bi-inbox"></i> 暂无备份记录</div>';
                }
            })
            .catch(error => {
                backupList.innerHTML = '<div class="text-center text-danger">加载失败: ' + error.message + '</div>';
            });
        }

        // 恢复API密钥
        function restoreApiKey(backupId) {
            fetch(`/api/restore-key/${backupId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    apiKeyInput.value = data.api_key;
                    document.getElementById('currentApiKey').value = data.api_key;
                    showNotification(data.message, 'success');
                } else {
                    showNotification(data.error, 'error');
                }
            })
            .catch(error => {
                showNotification('恢复失败: ' + error.message, 'error');
            });
        }

        // 下载文件函数
        function downloadFile(url, filename) {
            try {
                showNotification('开始下载...', 'info');
                
                // 创建隐藏的下载链接
                const link = document.createElement('a');
                link.href = url;
                link.download = filename || '';
                link.style.display = 'none';
                
                // 添加到DOM并触发下载
                document.body.appendChild(link);
                link.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(link);
                    showNotification('下载已开始', 'success');
                }, 100);
                
            } catch (error) {
                console.error('下载失败:', error);
                showNotification('下载失败: ' + error.message, 'error');
            }
        }

        // 查看所有文件
        document.getElementById('viewFilesBtn').addEventListener('click', function() {
            fetch('/api/files')
            .then(response => response.json())
            .then(data => {
                if (data.files && data.files.length > 0) {
                    let fileList = '可下载的文件：\n\n';
                    data.files.forEach((file, index) => {
                        const size = (file.size / 1024 / 1024).toFixed(2);
                        const date = new Date(file.created).toLocaleString('zh-CN');
                        fileList += `${index + 1}. ${file.name}\n   大小: ${size} MB\n   创建时间: ${date}\n\n`;
                    });
                    alert(fileList);
                } else {
                    alert('暂无可下载的文件');
                }
            })
            .catch(error => {
                console.error('获取文件列表失败:', error);
                alert('获取文件列表失败: ' + error.message);
            });
        });

        // 通知功能
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // 3秒后自动消失
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // 拖拽上传
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                fileInput.files = files;
                handleFileSelect();
            }
        }

        fileInput.addEventListener('change', handleFileSelect);

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                fileName.textContent = file.name;
                fileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                fileInfo.style.display = 'block';
                processBtn.disabled = false;
            }
        }

        // API测试
        document.getElementById('testApiBtn').addEventListener('click', function() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const btn = this;
            const originalText = btn.innerHTML;
            const statusDiv = document.getElementById('apiStatus');
            
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';
            btn.disabled = true;
            
            fetch('/api/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.style.display = 'block';
                if (data.success) {
                    statusDiv.className = 'api-status success';
                    statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message} (模型: ${data.model})`;
                } else {
                    statusDiv.className = 'api-status error';
                    statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.message}`;
                }
            })
            .catch(error => {
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> 连接失败: ${error.message}`;
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        // 重试和重置功能
        document.getElementById('retryBtn').addEventListener('click', function() {
            uploadForm.dispatchEvent(new Event('submit'));
        });

        document.getElementById('resetBtn').addEventListener('click', function() {
            fileInput.value = '';
            fileInfo.style.display = 'none';
            resultArea.style.display = 'none';
            errorArea.style.display = 'none';
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始处理';
        });

        // 表单提交处理函数
        function submitUpload() {
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('api_key', document.getElementById('apiKey').value.trim());
        
            // 显示进度条
            progressBar.style.display = 'block';
            processBtn.disabled = true;
            processBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 处理中...';
            
            // 隐藏之前的结果
            resultArea.style.display = 'none';
            errorArea.style.display = 'none';
            
            // 模拟进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                document.querySelector('.progress-bar').style.width = progress + '%';
            }, 500);
            
            // 创建超时控制器
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 300000); // 5分钟超时

            fetch('/upload', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                document.querySelector('.progress-bar').style.width = '100%';
                
                if (data.success) {
                    document.getElementById('resultMessage').textContent = data.message;
                    
                    // 设置下载按钮事件
                    const downloadBtn = document.getElementById('downloadBtn');
                    downloadBtn.onclick = function(e) {
                        e.preventDefault();
                        downloadFile(data.download_url, data.filename);
                    };
                    
                    resultArea.style.display = 'block';
                } else {
                    document.getElementById('errorMessage').textContent = data.error || '处理失败';
                    errorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = '上传失败: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += '请求超时，文档过大或网络不稳定。建议：1) 检查网络连接 2) 尝试更小的文档 3) 点击重试';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += '网络连接失败，请检查网络状态后重试';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('errorMessage').textContent = errorMsg;
                errorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                    document.querySelector('.progress-bar').style.width = '0%';
                    processBtn.disabled = false;
                    processBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始处理';
                }, 1000);
            });
        }

        // 表单提交事件
        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitUpload();
        });

        // ================================
        // 技术方案相关功能
        // ================================
        
        // 技术方案表单元素
        const techProposalForm = document.getElementById('techProposalForm');
        const techTenderFileInput = document.getElementById('techTenderFileInput');
        const productFileInput = document.getElementById('productFileInput');
        const generateProposalBtn = document.getElementById('generateProposalBtn');
        const techProgressBar = document.getElementById('techProgressBar');
        const techResultArea = document.getElementById('techResultArea');
        const techErrorArea = document.getElementById('techErrorArea');

        // 技术方案文件选择处理
        techTenderFileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('tenderFileName').textContent = file.name;
                document.getElementById('tenderFileInfo').style.display = 'block';
                checkTechFormReady();
            }
        });

        productFileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('productFileName').textContent = file.name;
                document.getElementById('productFileInfo').style.display = 'block';
                checkTechFormReady();
            }
        });

        function checkTechFormReady() {
            const hasTenderFile = techTenderFileInput.files.length > 0;
            const hasProductFile = productFileInput.files.length > 0;
            generateProposalBtn.disabled = !(hasTenderFile && hasProductFile);
        }

        // 技术方案表单提交
        techProposalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitTechProposal();
        });

        function submitTechProposal() {
            const formData = new FormData();
            formData.append('tender_file', techTenderFileInput.files[0]);
            formData.append('product_file', productFileInput.files[0]);
            formData.append('output_prefix', document.getElementById('outputPrefix').value.trim() || '技术方案');
            formData.append('api_key', apiKeyInput.value.trim());

            // 显示进度条
            techProgressBar.style.display = 'block';
            generateProposalBtn.disabled = true;
            generateProposalBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 生成中...';
            
            // 隐藏之前的结果
            techResultArea.style.display = 'none';
            techErrorArea.style.display = 'none';
            
            // 模拟进度
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90;
                document.querySelector('#techProgressBar .progress-bar').style.width = progress + '%';
            }, 1000);
            
            // 创建超时控制器
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 600000); // 10分钟超时

            fetch('/generate-proposal', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                clearInterval(progressInterval);
                document.querySelector('#techProgressBar .progress-bar').style.width = '100%';
                
                if (data.success) {
                    document.getElementById('techResultMessage').innerHTML = `
                        <strong>生成统计：</strong><br>
                        • 需求数量：${data.requirements_count || 0}<br>
                        • 功能数量：${data.features_count || 0}<br>
                        • 匹配数量：${data.matches_count || 0}<br>
                        • 章节数量：${data.sections_count || 0}<br>
                        • 匹配成功率：${data.match_stats ? Math.round((data.match_stats.matched_requirements / data.requirements_count * 100) || 0) : 0}%
                    `;
                    
                    // 生成下载按钮
                    const downloadArea = document.getElementById('techDownloadArea');
                    downloadArea.innerHTML = '';
                    
                    if (data.output_files) {
                        Object.keys(data.output_files).forEach(fileType => {
                            const filePath = data.output_files[fileType];
                            const fileName = filePath.split('/').pop();
                            
                            let buttonClass = 'btn-primary';
                            let iconClass = 'bi-download';
                            let buttonText = '下载';
                            
                            switch (fileType) {
                                case 'proposal':
                                    buttonClass = 'btn-success';
                                    iconClass = 'bi-file-earmark-word';
                                    buttonText = '下载技术方案';
                                    break;
                                case 'outline':
                                    buttonClass = 'btn-info';
                                    iconClass = 'bi-list-ol';
                                    buttonText = '下载方案大纲';
                                    break;
                                case 'match_report':
                                    buttonClass = 'btn-warning';
                                    iconClass = 'bi-graph-up';
                                    buttonText = '下载匹配报告';
                                    break;
                                case 'full_data':
                                    buttonClass = 'btn-secondary';
                                    iconClass = 'bi-database';
                                    buttonText = '下载完整数据';
                                    break;
                            }
                            
                            const downloadBtn = document.createElement('button');
                            downloadBtn.className = `btn ${buttonClass} me-2 mb-2`;
                            downloadBtn.innerHTML = `<i class="${iconClass}"></i> ${buttonText}`;
                            downloadBtn.onclick = function() {
                                downloadFile(`/download-tech/${fileName}`, fileName);
                            };
                            downloadArea.appendChild(downloadBtn);
                        });
                    }
                    
                    techResultArea.style.display = 'block';
                } else {
                    document.getElementById('techErrorMessage').textContent = data.error || '生成失败';
                    techErrorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = '生成失败: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += '请求超时，文档过大或处理时间过长。建议：1) 检查网络连接 2) 尝试更小的文档 3) 点击重试';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += '网络连接失败，请检查网络状态后重试';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('techErrorMessage').textContent = errorMsg;
                techErrorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    techProgressBar.style.display = 'none';
                    document.querySelector('#techProgressBar .progress-bar').style.width = '0%';
                    generateProposalBtn.disabled = false;
                    generateProposalBtn.innerHTML = '<i class="bi bi-play-circle"></i> 生成技术方案';
                }, 1000);
            });
        }

        // 技术方案重试和重置功能
        document.getElementById('techRetryBtn').addEventListener('click', function() {
            submitTechProposal();
        });

        document.getElementById('techResetBtn').addEventListener('click', function() {
            techTenderFileInput.value = '';
            productFileInput.value = '';
            document.getElementById('tenderFileInfo').style.display = 'none';
            document.getElementById('productFileInfo').style.display = 'none';
            techResultArea.style.display = 'none';
            techErrorArea.style.display = 'none';
            generateProposalBtn.disabled = true;
            generateProposalBtn.innerHTML = '<i class="bi bi-play-circle"></i> 生成技术方案';
        });

        // ====== 招标信息提取功能 ======
        console.log('Initializing tender info extraction...');
        const tenderUploadArea = document.getElementById('tenderUploadArea');
        const tenderFileInput = document.getElementById('tenderFileInput');
        const tenderFileInfo = document.getElementById('tenderFileInfo');
        const tenderFileName = document.getElementById('tenderFileName');
        const tenderFileSize = document.getElementById('tenderFileSize');
        const extractInfoBtn = document.getElementById('extractInfoBtn');
        const tenderProgressBar = document.getElementById('tenderProgressBar');
        const tenderResultArea = document.getElementById('tenderResultArea');
        const tenderErrorArea = document.getElementById('tenderErrorArea');
        const tenderInfoDisplay = document.getElementById('tenderInfoDisplay');
        
        console.log('Tender elements:', {
            tenderUploadArea,
            tenderFileInput,
            tenderFileInfo,
            tenderFileName,
            tenderFileSize,
            extractInfoBtn
        });

        // 上传区域点击事件
        tenderUploadArea.addEventListener('click', () => {
            console.log('Tender upload area clicked');
            tenderFileInput.click();
        });

        // 拖拽上传
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            tenderUploadArea.addEventListener(eventName, preventDefaults, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            tenderUploadArea.addEventListener(eventName, () => tenderUploadArea.classList.remove('dragover'), false);
        });

        tenderUploadArea.addEventListener('drop', handleTenderDrop, false);

        function handleTenderDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                tenderFileInput.files = files;
                handleTenderFileSelect();
            }
        }

        tenderFileInput.addEventListener('change', handleTenderFileSelect);

        function handleTenderFileSelect() {
            console.log('handleTenderFileSelect called');
            const file = tenderFileInput.files[0];
            console.log('Selected file:', file);
            if (file) {
                console.log('File details:', file.name, file.size);
                tenderFileName.textContent = file.name;
                tenderFileSize.textContent = `(${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                tenderFileInfo.style.display = 'block';
                extractInfoBtn.disabled = false;
                console.log('File info updated, extract button enabled');
            } else {
                console.log('No file selected');
            }
        }

        // API测试
        document.getElementById('testTenderApiBtn').addEventListener('click', function() {
            const apiKey = document.getElementById('tenderApiKey').value.trim();
            const btn = this;
            const originalText = btn.innerHTML;
            const statusDiv = document.getElementById('tenderApiStatus');
            
            btn.innerHTML = '<i class="bi bi-hourglass-split"></i> 测试中...';
            btn.disabled = true;
            
            fetch('/api/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                statusDiv.style.display = 'block';
                if (data.success) {
                    statusDiv.className = 'api-status success';
                    statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> ${data.message} (模型: ${data.model})`;
                } else {
                    statusDiv.className = 'api-status error';
                    statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> ${data.message}`;
                }
            })
            .catch(error => {
                statusDiv.style.display = 'block';
                statusDiv.className = 'api-status error';
                statusDiv.innerHTML = `<i class="bi bi-x-circle"></i> 连接失败: ${error.message}`;
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        // 提取信息按钮事件
        extractInfoBtn.addEventListener('click', function() {
            submitTenderExtraction();
        });

        function submitTenderExtraction() {
            const formData = new FormData();
            formData.append('file', tenderFileInput.files[0]);
            formData.append('api_key', document.getElementById('tenderApiKey').value);

            // 重置显示区域
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            
            // 显示进度条
            tenderProgressBar.style.display = 'block';
            const progressBar = tenderProgressBar.querySelector('.progress-bar');
            
            // 设置按钮状态
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 提取中...';

            // 模拟进度更新
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
            }, 200);

            // 超时控制
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000); // 2分钟超时

            fetch('/extract-tender-info', {
                method: 'POST',
                body: formData,
                signal: controller.signal
            })
            .then(response => response.json())
            .then(data => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                progressBar.style.width = '100%';

                if (data.success) {
                    displayTenderInfo(data.tender_info);
                    tenderResultArea.style.display = 'block';
                } else {
                    document.getElementById('tenderErrorMessage').textContent = data.error || '提取失败';
                    tenderErrorArea.style.display = 'block';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
                let errorMsg = '提取失败: ';
                
                if (error.name === 'AbortError') {
                    errorMsg += '请求超时，文档过大或处理时间过长。建议：1) 检查网络连接 2) 尝试更小的文档 3) 点击重试';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += '网络连接失败，请检查网络状态后重试';
                } else {
                    errorMsg += error.message;
                }
                
                document.getElementById('tenderErrorMessage').textContent = errorMsg;
                tenderErrorArea.style.display = 'block';
            })
            .finally(() => {
                setTimeout(() => {
                    tenderProgressBar.style.display = 'none';
                    tenderProgressBar.querySelector('.progress-bar').style.width = '0%';
                    extractInfoBtn.disabled = false;
                    extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始提取信息';
                }, 1000);
            });
        }

        function displayTenderInfo(tenderInfo) {
            const fieldLabels = {
                'tenderer': '招标人',
                'agency': '招标代理',
                'bidding_method': '投标方式',
                'bidding_location': '投标地点',
                'bidding_time': '投标时间',
                'winner_count': '中标人数量',
                'project_name': '项目名称',
                'project_number': '项目编号'
            };

            // 基本信息部分
            let html = '<h5 class="text-primary mb-3"><i class="bi bi-info-circle"></i> 基本信息</h5>';
            let basicInfoHtml = '';
            
            for (const [key, value] of Object.entries(tenderInfo)) {
                if (fieldLabels[key]) {
                    const label = fieldLabels[key];
                    const displayValue = value || '未提取到';
                    const textColor = value ? 'text-success' : 'text-muted';
                    
                    basicInfoHtml += `
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title text-primary">
                                        <i class="bi bi-info-circle"></i> ${label}
                                    </h6>
                                    <p class="card-text ${textColor}">${displayValue}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            html += `<div class="row">${basicInfoHtml}</div>`;
            
            // 资质要求部分
            if (tenderInfo.qualification_requirements) {
                html += '<hr><h5 class="text-warning mb-3 mt-4"><i class="bi bi-list-check"></i> 资质要求</h5>';
                
                const qualificationLabels = {
                    'business_license': '营业执照',
                    'taxpayer_qualification': '纳税人资格（增值税纳税人）',
                    'performance_requirements': '业绩要求',
                    'authorization_requirements': '授权要求',
                    'credit_china': '信用中国',
                    'commitment_letter': '承诺函（默认满足）',
                    'audit_report': '审计报告（财务要求）',
                    'social_security': '社保要求',
                    'labor_contract': '劳动合同要求',
                    'other_requirements': '其他要求'
                };
                
                let qualHtml = '';
                for (const [key, qualData] of Object.entries(tenderInfo.qualification_requirements)) {
                    if (qualificationLabels[key]) {
                        const label = qualificationLabels[key];
                        const required = qualData.required;
                        const description = qualData.description || '';
                        const statusText = required ? '需要提供' : '不需要提供';
                        const statusColor = required ? 'text-danger' : 'text-success';
                        const iconClass = required ? 'bi-exclamation-triangle' : 'bi-check-circle';
                        
                        qualHtml += `
                            <div class="col-md-6 mb-3">
                                <div class="card ${required ? 'border-warning' : 'border-success'}">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi ${iconClass} ${statusColor}"></i> ${label}
                                        </h6>
                                        <p class="card-text ${statusColor} fw-bold">${statusText}</p>
                                        ${description ? `<p class="card-text text-muted small">${description}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `<div class="row">${qualHtml}</div>`;
            }
            
            // 技术评分部分
            if (tenderInfo.technical_scoring) {
                html += '<hr><h5 class="text-info mb-3 mt-4"><i class="bi bi-graph-up-arrow"></i> 技术评分标准</h5>';
                
                const techScoring = tenderInfo.technical_scoring;
                
                // 技术总分显示
                if (techScoring.total_score) {
                    html += `
                        <div class="alert alert-info">
                            <h6 class="mb-2">
                                <i class="bi bi-trophy"></i> 技术评分总分：
                                <span class="text-primary fw-bold">${techScoring.total_score}</span>
                            </h6>
                            ${techScoring.extraction_summary ? 
                                `<small class="text-muted">${techScoring.extraction_summary}</small>` : ''}
                        </div>
                    `;
                }
                
                // 技术评分项表格
                if (techScoring.items && techScoring.items.length > 0) {
                    html += `
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-info">
                                    <tr>
                                        <th style="width: 5%;">序号</th>
                                        <th style="width: 20%;">评分项名称</th>
                                        <th style="width: 10%;">分值</th>
                                        <th style="width: 50%;">评分标准</th>
                                        <th style="width: 15%;">数据来源</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    techScoring.items.forEach((item, index) => {
                        const weightDisplay = item.weight || '未提及';
                        const criteriaDisplay = item.criteria || '未提及';
                        const sourceDisplay = item.source || '未提及';
                        
                        html += `
                            <tr>
                                <td class="text-center fw-bold">${index + 1}</td>
                                <td class="fw-semibold text-primary">${item.name}</td>
                                <td class="text-center">
                                    <span class="badge bg-info">${weightDisplay}</span>
                                </td>
                                <td>
                                    <small class="text-muted">${criteriaDisplay}</small>
                                </td>
                                <td>
                                    <small class="text-secondary">${sourceDisplay}</small>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> 
                            未能提取到具体的技术评分项信息
                        </div>
                    `;
                }
            }
            
            tenderInfoDisplay.innerHTML = html;
        }

        // 招标信息提取重试和重置功能
        document.getElementById('tenderRetryBtn').addEventListener('click', function() {
            submitTenderExtraction();
        });

        document.getElementById('tenderRetryBtn2').addEventListener('click', function() {
            submitTenderExtraction();
        });

        document.getElementById('tenderResetBtn').addEventListener('click', function() {
            tenderFileInput.value = '';
            tenderFileInfo.style.display = 'none';
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始提取信息';
        });

        document.getElementById('tenderResetBtn2').addEventListener('click', function() {
            tenderFileInput.value = '';
            tenderFileInfo.style.display = 'none';
            tenderResultArea.style.display = 'none';
            tenderErrorArea.style.display = 'none';
            extractInfoBtn.disabled = true;
            extractInfoBtn.innerHTML = '<i class="bi bi-play-circle"></i> 开始提取信息';
        });
    </script>
</body>
</html>