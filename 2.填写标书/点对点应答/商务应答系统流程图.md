# 商务应答系统流程图

## 系统概述

商务应答系统是一个智能文档处理平台，支持自动填充公司信息、项目信息匹配和文档生成功能。系统采用MCP (Model Context Protocol) 处理架构，支持10种优化格式规则和跨run处理技术，具备完善的盖章格式识别能力。

## 系统流程图

```mermaid
flowchart TD
    A[用户访问系统] --> B[上传商务应答模板]
    B --> C{文件验证}
    C -->|文件格式错误| D[显示错误信息]
    C -->|验证通过| E[选择公司信息]
    
    E --> F[输入项目信息]
    F --> G[项目名称输入]
    F --> H[招标编号输入]
    F --> I[日期输入]
    
    G --> J{信息完整性检查}
    H --> J
    I --> J
    
    J -->|信息不完整| K[提示补充信息]
    J -->|信息完整| L[提交处理请求]
    
    L --> M[Flask后端接收请求]
    M --> N[创建处理任务]
    N --> O[调用MCP处理器]
    
    O --> P[MCP处理器启动]
    P --> Q[文档结构分析]
    Q --> R[识别文档中的占位符]
    
    R --> S[格式模式识别]
    S --> T{10种优化格式规则匹配}
    
    T --> U[规则1: 括号内容替换]
    T --> V[规则2: 盖章格式处理]
    T --> W[规则3: 编号类填写]
    T --> X[规则4-10: 其他优化规则...]
    
    U --> Y[跨Run处理分析]
    V --> Y1[盖章格式专项处理]
    W --> Y
    X --> Y
    
    Y1 --> Y1A[检测前导空格和数字编号]
    Y1A --> Y1B[识别中英文括号格式]
    Y1B --> Y1C[支持多种盖章标识]
    Y1C --> Y
    
    Y --> Z[检测跨run文本分割]
    Z --> AA[计算替换边界]
    AA --> BB[执行精确替换]
    
    BB --> CC{替换结果验证}
    CC -->|替换失败| DD[记录错误日志]
    CC -->|替换成功| EE[应用格式保持]
    
    EE --> FF[生成处理后文档]
    FF --> GG[文档质量检查]
    
    GG --> HH{质量检查结果}
    HH -->|存在问题| II[问题修复]
    HH -->|检查通过| JJ[保存到输出目录]
    
    II --> GG
    
    JJ --> KK[生成下载链接]
    KK --> LL[返回处理结果]
    
    LL --> MM[前端接收响应]
    MM --> NN{处理状态检查}
    
    NN -->|处理失败| OO[显示错误信息]
    NN -->|处理成功| PP[显示成功消息]
    
    PP --> QQ[提供下载按钮]
    QQ --> RR[用户点击下载]
    RR --> SS[文档下载完成]
    
    D --> TT[返回上传页面]
    K --> TT
    OO --> TT
    
    DD --> UU[错误处理流程]
    UU --> VV[记录详细错误信息]
    VV --> WW[生成错误报告]
    WW --> XX[通知用户处理失败]
    XX --> TT
    
    style A fill:#e1f5fe
    style SS fill:#c8e6c9
    style DD fill:#ffcdd2
    style UU fill:#ffcdd2
    style P fill:#fff3e0
    style S fill:#fff3e0
    style Y fill:#fff3e0
    style Y1 fill:#e8f5e8
    style Y1A fill:#e8f5e8
    style Y1B fill:#e8f5e8
    style Y1C fill:#e8f5e8
```

## 流程模块说明

### 1. 用户界面操作模块
- **文件上传验证**：检查上传文件的格式和完整性
- **公司信息选择**：从预设的公司配置中选择
- **项目信息输入**：包括项目名称、招标编号、日期等关键信息
- **信息完整性检查**：确保所有必填字段都已填写

### 2. 后端处理逻辑模块
- **Flask接收处理请求**：Web框架接收前端提交的处理任务
- **创建处理任务**：初始化文档处理流程
- **调用MCP处理器**：启动核心处理引擎

### 3. MCP处理器核心功能
- **文档结构分析**：解析Word文档的内部结构
- **占位符识别**：自动识别需要填写的位置
- **10种优化格式规则**：经过合并优化的高效处理规则
  - 规则1: 通用括号内容替换（公司名称类）
  - 规则2: **盖章格式专项处理**（支持前导空格、数字编号、中英文括号）
  - 规则3: 编号类统一填写（采购编号、项目编号等）
  - 规则4-10: 其他优化处理规则
- **盖章格式专项处理**：
  - 支持前导空格和制表符（如"    公司名称（全称、盖章）："）
  - 支持数字编号前缀（如"1. 公司名称（盖章）："）
  - 支持中英文括号混用（如"供应商名称（盖章）"和"供应商名称(盖章)"）
  - 识别多种盖章标识（盖章、公章、全称盖章等）
- **跨run处理分析**：处理Word文档中跨run的文本分割问题
- **精确替换**：通过边界计算确保替换的准确性
- **格式保持**：维持原文档的格式和样式

### 4. 错误处理机制
- **文件验证错误**：处理文件格式不正确的情况
- **信息不完整提示**：引导用户补充必要信息
- **处理失败记录**：详细记录错误信息用于调试
- **错误报告生成**：为用户和开发者提供错误详情

### 5. 结果输出模块
- **文档生成和保存**：创建填写完成的文档文件
- **质量检查**：验证处理结果的正确性
- **下载链接提供**：为用户提供安全的下载通道
- **用户下载完成**：完成整个处理流程

## 技术特点

1. **高精度处理**：通过MCP处理器实现高精度的文档内容识别和替换
2. **优化格式支持**：从27规则优化至10规则，提高处理效率同时保持完整功能
3. **盖章格式专项优化**：
   - 完美支持"公司名称（全称、盖章）"等复杂格式
   - 自适应前导空格、数字编号、制表符等各种缩进格式
   - 兼容中英文括号和多种盖章标识
4. **跨run处理**：解决Word文档技术难题，确保处理的完整性
5. **错误恢复**：完善的错误处理和恢复机制
6. **用户友好**：简洁的界面操作和清晰的状态反馈

## 系统优势

- **自动化程度高**：减少手工填写工作量
- **处理准确性好**：通过先进算法确保填写正确性
- **适应性强**：支持多种文档格式和模板
- **易于维护**：模块化设计便于功能扩展和维护
- **盖章格式专业**：专门优化中国商务文档常见的盖章格式处理

## 最新更新记录

### v2.0 - 2025年9月7日
- **规则优化**：将处理规则从27个优化至10个，提高处理效率
- **盖章格式专项修复**：完美解决"公司名称（全称、盖章）"等格式问题
- **前导空格支持**：支持各种前导空格、制表符和数字编号格式
- **括号兼容性**：同时支持中文括号（）和英文括号()
- **流程图更新**：更新系统流程图反映最新的处理架构

### 技术改进亮点
- 修复正则表达式：`^(?:\s*\d+\.\s*|\s+)?` 支持前导空格
- 增强格式识别：支持"供应商名称（盖章）"、"投标人名称（盖章）"等
- 保持格式一致：处理后保持原文档的缩进和格式
- 测试验证完善：通过多重测试确保修复效果